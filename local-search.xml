<?xml version="1.0" encoding="utf-8"?>
<search>
  
  
  
  <entry>
    <title>【LeetCode】637. 二叉树的层平均值</title>
    <link href="/posts/3513331422.html"/>
    <url>/posts/3513331422.html</url>
    
    <content type="html"><![CDATA[<h1 id="1-问题"><a href="#1-问题" class="headerlink" title="1.问题"></a>1.问题</h1><p>给定一个非空二叉树的根节点 root , 以数组的形式返回每一层节点的平均值。与实际答案相差 10-5 以内的答案可以被接受。</p><h2 id="示例-1"><a href="#示例-1" class="headerlink" title="示例 1"></a>示例 1</h2><p><img src="https://img-blog.csdnimg.cn/572cf85465494ddaad64571044fcaa83.png" alt="在这里插入图片描述"></p><blockquote><p>输入：root &#x3D; [3,9,20,null,null,15,7]<br>输出：[3.00000,14.50000,11.00000]<br>解释：第 0 层的平均值为 3,第 1 层的平均值为 14.5,第 2 层的平均值为 11 。因此返回 [3, 14.5, 11] 。</p></blockquote><h2 id="示例-2"><a href="#示例-2" class="headerlink" title="示例 2"></a>示例 2</h2><p><img src="https://img-blog.csdnimg.cn/af4eaf4f503149238b33e223bc4b999e.png" alt="在这里插入图片描述"></p><blockquote><p>输入：root &#x3D; [3,9,20,15,7]<br>输出：[3.00000,14.50000,11.00000]</p></blockquote><p><strong>提示</strong>：</p><ul><li>树中节点数量在 [1, 104] 范围内</li><li>-231 &lt;&#x3D; Node.val &lt;&#x3D; 231 - 1</li></ul><h1 id="2-解题思路"><a href="#2-解题思路" class="headerlink" title="2.解题思路"></a>2.解题思路</h1><p>层序遍历方法参见<a href="https://zyxelva.github.io/posts/2462725929.html">102.二叉树的层序遍历</a> 一文，本章不用层标识，对于利用广度优先算法，不采用层标识，遍历到新的一层，循环出队，计算该层的总和。</p><h1 id="3-代码"><a href="#3-代码" class="headerlink" title="3.代码"></a>3.代码</h1><figure class="highlight java"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-o6udpwlhkez7dw"></i><span>java</span><div class="collapse show" id="collapse-o6udpwlhkez7dw"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Definition for a binary tree node.</span><br><span class="hljs-comment"> * public class TreeNode &#123;</span><br><span class="hljs-comment"> *     int val;</span><br><span class="hljs-comment"> *     TreeNode left;</span><br><span class="hljs-comment"> *     TreeNode right;</span><br><span class="hljs-comment"> *     TreeNode() &#123;&#125;</span><br><span class="hljs-comment"> *     TreeNode(int val) &#123; this.val = val; &#125;</span><br><span class="hljs-comment"> *     TreeNode(int val, TreeNode left, TreeNode right) &#123;</span><br><span class="hljs-comment"> *         this.val = val;</span><br><span class="hljs-comment"> *         this.left = left;</span><br><span class="hljs-comment"> *         this.right = right;</span><br><span class="hljs-comment"> *     &#125;</span><br><span class="hljs-comment"> * &#125;</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Solution</span> &#123;<br>    <span class="hljs-keyword">public</span> List&lt;Double&gt; <span class="hljs-title function_">averageOfLevels</span><span class="hljs-params">(TreeNode root)</span> &#123;<br>        <span class="hljs-comment">//层次遍历 队列</span><br>        List&lt;Double&gt; res=<span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>        <span class="hljs-comment">//队列</span><br>        Queue&lt;TreeNode&gt; q=<span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedList</span>&lt;&gt;();<br>        <span class="hljs-comment">//临时节点</span><br>        TreeNode tmp;<br>        <span class="hljs-comment">//和</span><br>        <span class="hljs-type">double</span> sum=<span class="hljs-number">0</span>;<br>        <span class="hljs-comment">//个数</span><br>        <span class="hljs-type">int</span> cnt;<br>        <span class="hljs-comment">//入队</span><br>        q.offer(root);<br>        <span class="hljs-keyword">while</span>(!q.isEmpty())&#123;<br>            <span class="hljs-type">int</span> size=q.size();<br>            cnt=size;<br>            <span class="hljs-comment">//循环出队，遍历完该层所有的节点</span><br>            <span class="hljs-keyword">while</span>(size--&gt;<span class="hljs-number">0</span>)&#123;<br>                <span class="hljs-comment">//出队</span><br>                tmp=q.poll();<br>                sum+=tmp.val;<br>                <span class="hljs-comment">//左右子树入队</span><br>                <span class="hljs-keyword">if</span>(<span class="hljs-literal">null</span>!=tmp.left)&#123;<br>                    q.offer(tmp.left);<br>                &#125;<br>                <span class="hljs-keyword">if</span>(<span class="hljs-literal">null</span>!=tmp.right)&#123;<br>                    q.offer(tmp.right);<br>                &#125;<br>            &#125;<br>            <span class="hljs-comment">//该层遍历、计算完毕</span><br>            res.add(sum*<span class="hljs-number">1.0</span>/cnt);<br>            sum=<span class="hljs-number">0</span>;<br>        &#125;<br>        <span class="hljs-keyword">return</span> res;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></div></figure>]]></content>
    
    
    <categories>
      
      <category>算法</category>
      
      <category>二叉树</category>
      
      <category>DFS</category>
      
      <category>LeetCode</category>
      
      <category>BFS</category>
      
    </categories>
    
    
    <tags>
      
      <tag>二叉树</tag>
      
      <tag>数据结构</tag>
      
      <tag>LeetCode</tag>
      
      <tag>算法</tag>
      
      <tag>Java</tag>
      
      <tag>DFS</tag>
      
      <tag>BFS</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>【LeetCode】297. 二叉树的序列化与反序列化</title>
    <link href="/posts/1059315458.html"/>
    <url>/posts/1059315458.html</url>
    
    <content type="html"><![CDATA[<h1 id="1-问题"><a href="#1-问题" class="headerlink" title="1.问题"></a>1.问题</h1><p><strong>序列化</strong>是将一个数据结构或者对象转换为连续的比特位的操作，进而可以将转换后的数据存储在一个文件或者内存中，同时也可以通过网络传输到另一个计算机环境，采取相反方式重构得到原数据。</p><p>请设计一个算法来实现二叉树的序列化与反序列化。这里不限定你的序列 &#x2F; 反序列化算法执行逻辑，你只需要保证一个二叉树可以被序列化为一个字符串并且将这个字符串反序列化为原始的树结构。</p><p>提示: 输入输出格式与 LeetCode 目前使用的方式一致，详情请参阅 LeetCode 序列化二叉树的格式。你并非必须采取这种方式，你也可以采用其他的方法解决这个问题。</p><h2 id="示例-1"><a href="#示例-1" class="headerlink" title="示例 1"></a>示例 1</h2><p><img src="https://img-blog.csdnimg.cn/c5186c114299495ebabab7a28745e79f.png"></p><blockquote><p>输入：root &#x3D; [1,2,3,null,null,4,5]<br>输出：[1,2,3,null,null,4,5]</p></blockquote><h2 id="示例-2"><a href="#示例-2" class="headerlink" title="示例 2"></a>示例 2</h2><blockquote><p>输入：root &#x3D; []<br>输出：[]</p></blockquote><h2 id="示例-3"><a href="#示例-3" class="headerlink" title="示例 3"></a>示例 3</h2><blockquote><p>输入：root &#x3D; [1]<br>输出：[1]</p></blockquote><h2 id="示例-4"><a href="#示例-4" class="headerlink" title="示例 4"></a>示例 4</h2><blockquote><p>输入：root &#x3D; [1,2]<br>输出：[1,2]</p></blockquote><p><strong>提示</strong>：</p><ul><li>树中结点数在范围 [0, 104] 内</li><li>-1000 &lt;&#x3D; Node.val &lt;&#x3D; 1000</li></ul><h1 id="2-解题思路"><a href="#2-解题思路" class="headerlink" title="2.解题思路"></a>2.解题思路</h1><p>二叉树有很多种遍历思路，如要解决本题，可以参考以下二叉树的遍历算法，序列化不用多说，反序列化就是逆向思考之前是怎么序列化的。本章主要讲解怎么利用层序遍历的思想解决反序列化问题。</p><h2 id="二叉树遍历系列"><a href="#二叉树遍历系列" class="headerlink" title="二叉树遍历系列"></a>二叉树遍历系列</h2><ul><li><a href="https://zyxelva.github.io/posts/2952228873.html">144.二叉树的前序遍历</a></li><li><a href="https://zyxelva.github.io/posts/240635441.html">94.二叉树的中序遍历</a></li><li><a href="https://zyxelva.github.io/posts/3424163710.html">145.二叉树的后续遍历</a></li><li><a href="https://zyxelva.github.io/posts/2462725929.html">102.二叉树的层序遍历</a></li><li><a href="https://zyxelva.github.io/posts/2499526336.html">107.二叉树的层序遍历II</a></li><li><a href="https://zyxelva.github.io/posts/371555309.html">103.二叉树的锯齿形层序遍历（之字形遍历）</a></li><li><a href="https://zyxelva.github.io/posts/2520912758.html">199.二叉树的右视图</a></li></ul><hr><h2 id="2-1-BFS"><a href="#2-1-BFS" class="headerlink" title="2.1 BFS"></a>2.1 BFS</h2><p>在<a href="https://zyxelva.github.io/posts/2462725929.html">102.二叉树的层序遍历</a>一文中，我们利用队列的性质对二叉树进行了层序遍历，本章，在序列化时我们也可以用队列，只是不需要分层标识，比如我们可以把它看成是这样：<br><img src="https://img-blog.csdnimg.cn/2d1b08b2f4e749fbbd5283931f47847a.png"><br>我们定义一个空节点，用以标识某个节点无左或右子节点。用下划线分割各个节点的值。</p><figure class="highlight java"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-fkhjp8lhkez7dw"></i><span>java</span><div class="collapse show" id="collapse-fkhjp8lhkez7dw"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">int</span> <span class="hljs-variable">INF</span> <span class="hljs-operator">=</span> -<span class="hljs-number">2000</span>;<br><span class="hljs-type">TreeNode</span> <span class="hljs-variable">emptyNode</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TreeNode</span>(INF);<br></code></pre></td></tr></table></div></figure><p>则序列化后的结果为：1_2_3_-2000_-2000_4_5_-2000_-2000_-2000_-2000;<br>反序列化时，利用队列，弹出头结点，包装成二叉树节点，对于序列化的序列，取出两个节点，只要值不是-2000，就可以将父子节点进行关联，再入队，依次循环。</p><h2 id="2-2-递归"><a href="#2-2-递归" class="headerlink" title="2.2 递归"></a>2.2 递归</h2><p>这里以前序遍历思想为例，其他中序、后序遍历类似。<br>同样，利用上述2.1节中的自定义空节点标识二叉树的空子节点。序列化伪代码大致如下：</p><figure class="highlight java"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-b31s13lhkez7dw"></i><span>java</span><div class="collapse show" id="collapse-b31s13lhkez7dw"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java">String <span class="hljs-title function_">serialize</span><span class="hljs-params">(TreeNode root)</span>&#123;<br><span class="hljs-keyword">if</span> (root == <span class="hljs-literal">null</span>) &#123;<br><span class="hljs-keyword">return</span> INF;<br>&#125;<br><span class="hljs-comment">//左节点</span><br>String left=serialize(root.left);<br><span class="hljs-comment">//右节点</span><br>String right=serialize(root.right);<br><span class="hljs-keyword">return</span> root.val+<span class="hljs-string">&quot;_&quot;</span>+left.val+<span class="hljs-string">&quot;_&quot;</span>+right.val;<br>&#125;<br></code></pre></td></tr></table></div></figure><p>反序列化</p><figure class="highlight java"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-1boaiplhkez7dw"></i><span>java</span><div class="collapse show" id="collapse-1boaiplhkez7dw"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs java">TreeNode <span class="hljs-title function_">deserialize</span><span class="hljs-params">(String str)</span>&#123;<br><span class="hljs-comment">//分离节点值</span><br>ss=str.split(<span class="hljs-string">&quot;_&quot;</span>);<br><span class="hljs-comment">//递归反序列化</span><br><span class="hljs-keyword">return</span> buildTree(ss);<br>&#125;<br><br>TreeNode <span class="hljs-title function_">buildTree</span><span class="hljs-params">(ss)</span>&#123;<br><span class="hljs-comment">//弹出第一个value</span><br>value=ss.poll();<br><span class="hljs-comment">//非自定义空节点 递归</span><br><span class="hljs-keyword">if</span>(value==INF)&#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>&#125;<br><span class="hljs-comment">//构造节点</span><br>TreeNode root=<span class="hljs-keyword">new</span> <span class="hljs-title class_">TreeNode</span>(value);<br>root.left=buildTree(ss);<br>root.right=buildTree(ss);<br><span class="hljs-keyword">return</span> root;<br>&#125;<br><br><br></code></pre></td></tr></table></div></figure><h1 id="3-代码"><a href="#3-代码" class="headerlink" title="3.代码"></a>3.代码</h1><figure class="highlight java"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-aoxnh9lhkez7dw"></i><span>java</span><div class="collapse show" id="collapse-aoxnh9lhkez7dw"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> java.util.ArrayDeque;<br><span class="hljs-keyword">import</span> java.util.Deque;<br><span class="hljs-comment">/*</span><br><span class="hljs-comment">public class TreeNode &#123;</span><br><span class="hljs-comment">    int val = 0;</span><br><span class="hljs-comment">    TreeNode left = null;</span><br><span class="hljs-comment">    TreeNode right = null;</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">    public TreeNode(int val) &#123;</span><br><span class="hljs-comment">        this.val = val;</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">    &#125;</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">&#125;</span><br><span class="hljs-comment">*/</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Solution</span> &#123;<br><span class="hljs-comment">//定义空节点的值</span><br>    <span class="hljs-type">int</span> <span class="hljs-variable">INF</span> <span class="hljs-operator">=</span> -<span class="hljs-number">2000</span>;<br>    <span class="hljs-type">TreeNode</span> <span class="hljs-variable">emptyNode</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TreeNode</span>(INF);<br><br><span class="hljs-comment">//BFS</span><br>    String <span class="hljs-title function_">Serialize</span><span class="hljs-params">(TreeNode root)</span> &#123;<br>        <span class="hljs-keyword">if</span> (root == <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;&quot;</span>;<br>        &#125;<br><span class="hljs-comment">//序列化的临时结果</span><br>        <span class="hljs-type">StringBuilder</span> <span class="hljs-variable">sb</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>();<br>        Deque&lt;TreeNode&gt; d = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayDeque</span>&lt;&gt;();<br>        d.addLast(root);<br>        <span class="hljs-keyword">while</span> (!d.isEmpty()) &#123;<br>        <span class="hljs-comment">//弹出一个节点，第一个是root</span><br>            <span class="hljs-type">TreeNode</span> <span class="hljs-variable">poll</span> <span class="hljs-operator">=</span> d.pollFirst();<br>            <span class="hljs-comment">//序列化的值以下划线分割</span><br>            sb.append(poll.val + <span class="hljs-string">&quot;_&quot;</span>);<br>            <span class="hljs-comment">//非自定义的空节点关联父节点</span><br>            <span class="hljs-keyword">if</span> (!poll.equals(emptyNode)) &#123;<br>                d.addLast(poll.left != <span class="hljs-literal">null</span> ? poll.left : emptyNode);<br>                d.addLast(poll.right != <span class="hljs-literal">null</span> ? poll.right : emptyNode);<br>            &#125;<br>        &#125;<br>        System.out.println(sb.toString());<br>        <span class="hljs-keyword">return</span> sb.toString();<br>    &#125;<br><br>    <span class="hljs-comment">//BFS</span><br>    TreeNode <span class="hljs-title function_">Deserialize</span><span class="hljs-params">(String data)</span> &#123;<br>        <span class="hljs-keyword">if</span> (data.equals(<span class="hljs-string">&quot;&quot;</span>)) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>        &#125;<br><br>        String[] ss = data.split(<span class="hljs-string">&quot;_&quot;</span>);<br>        <span class="hljs-type">int</span> <span class="hljs-variable">n</span> <span class="hljs-operator">=</span> ss.length;<br>        <span class="hljs-comment">//根节点</span><br>        <span class="hljs-type">TreeNode</span> <span class="hljs-variable">root</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TreeNode</span>(Integer.parseInt(ss[<span class="hljs-number">0</span>]));<br>        Deque&lt;TreeNode&gt; d = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayDeque</span>&lt;&gt;();<br>        d.addLast(root);<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>; i &lt; n - <span class="hljs-number">1</span>; i += <span class="hljs-number">2</span>) &#123;<br>            <span class="hljs-type">TreeNode</span> <span class="hljs-variable">poll</span> <span class="hljs-operator">=</span> d.pollFirst();<br>            <span class="hljs-type">int</span> <span class="hljs-variable">a</span> <span class="hljs-operator">=</span> Integer.parseInt(ss[i]);<br>            <span class="hljs-type">int</span> <span class="hljs-variable">b</span> <span class="hljs-operator">=</span> Integer.parseInt(ss[i + <span class="hljs-number">1</span>]);<br>            <span class="hljs-comment">//非自定义空节点的值，包装成二叉树的节点，关联上父节点</span><br>            <span class="hljs-keyword">if</span> (a != INF) &#123;<br>                poll.left = <span class="hljs-keyword">new</span> <span class="hljs-title class_">TreeNode</span>(a);<br>                d.addLast(poll.left);<br>            &#125;<br>            <span class="hljs-keyword">if</span> (b != INF) &#123;<br>                poll.right = <span class="hljs-keyword">new</span> <span class="hljs-title class_">TreeNode</span>(b);<br>                d.addLast(poll.right);<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">return</span> root;<br>    &#125;<br><br><span class="hljs-comment">//递归序列化和反序列化</span><br><span class="hljs-comment">//前序遍历</span><br>    String <span class="hljs-title function_">Serialize2</span><span class="hljs-params">(TreeNode root)</span> &#123;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-literal">null</span> == root) &#123;<br>            <span class="hljs-keyword">return</span> String.valueOf(INF);<br>        &#125;<br>        <span class="hljs-type">StringBuilder</span> <span class="hljs-variable">sb</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>();<br>        sb.append(root.val)<br>        .append(<span class="hljs-string">&quot;_&quot;</span>)<br>        .append(Serialize(root.left))<br>        .append(<span class="hljs-string">&quot;_&quot;</span>)<br>        .append(Serialize(root.right));<br>        <br>        <span class="hljs-keyword">return</span> sb.toString();<br>    &#125;<br><br>    TreeNode <span class="hljs-title function_">Deserialize2</span><span class="hljs-params">(String str)</span> &#123;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-literal">null</span> == str || <span class="hljs-string">&quot;&quot;</span>.equals(str)) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>        &#125;<br>        <span class="hljs-comment">//将节点元素值分离</span><br>        String[] s = str.split(<span class="hljs-string">&quot;_&quot;</span>);<br>        List&lt;String&gt; list = Arrays.stream(s).collect(Collectors.toList());<br>        <span class="hljs-type">TreeNode</span> <span class="hljs-variable">root</span> <span class="hljs-operator">=</span> buildTree(list);<br>        <span class="hljs-keyword">return</span> root;<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> TreeNode <span class="hljs-title function_">buildTree</span><span class="hljs-params">(List&lt;String&gt; list)</span> &#123;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">rootValue</span> <span class="hljs-operator">=</span> Integer.parseInt(list.remove(<span class="hljs-number">0</span>));<br>        <span class="hljs-keyword">if</span> ( rootValue == INF) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>        &#125;<br>        <span class="hljs-type">TreeNode</span> <span class="hljs-variable">root</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TreeNode</span>(rootValue);<br>        root.left = buildTree(list);<br>        root.right = buildTree(list);<br>        <span class="hljs-keyword">return</span> root;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></div></figure>]]></content>
    
    
    <categories>
      
      <category>算法</category>
      
      <category>二叉树</category>
      
      <category>DFS</category>
      
      <category>LeetCode</category>
      
      <category>BFS</category>
      
    </categories>
    
    
    <tags>
      
      <tag>二叉树</tag>
      
      <tag>数据结构</tag>
      
      <tag>LeetCode</tag>
      
      <tag>算法</tag>
      
      <tag>Java</tag>
      
      <tag>DFS</tag>
      
      <tag>BFS</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>【LeetCode】106. 从中序与后序遍历序列构造二叉树</title>
    <link href="/posts/1264206122.html"/>
    <url>/posts/1264206122.html</url>
    
    <content type="html"><![CDATA[<h1 id="1-问题"><a href="#1-问题" class="headerlink" title="1.问题"></a>1.问题</h1><p>给定两个整数数组 inorder 和 postorder ，其中 inorder 是二叉树的中序遍历， postorder 是同一棵树的后序遍历，请你构造并返回这颗 二叉树 。</p><h2 id="示例-1"><a href="#示例-1" class="headerlink" title="示例 1"></a>示例 1</h2><p><img src="https://img-blog.csdnimg.cn/img_convert/6684f6a9297c3ddb9a65007d5a25bd0d.jpeg#pic_center"></p><blockquote><p>输入：inorder &#x3D; [9,3,15,20,7], postorder &#x3D; [9,15,7,20,3]<br>输出：[3,9,20,null,null,15,7]</p></blockquote><h2 id="示例-2"><a href="#示例-2" class="headerlink" title="示例 2"></a>示例 2</h2><blockquote><p>输入：inorder &#x3D; [-1], postorder &#x3D; [-1]<br>输出：[-1]</p></blockquote><p><strong>提示</strong>:</p><ul><li>1 &lt;&#x3D; inorder.length &lt;&#x3D; 3000</li><li>postorder.length &#x3D;&#x3D; inorder.length</li><li>-3000 &lt;&#x3D; inorder[i], postorder[i] &lt;&#x3D; 3000</li><li>inorder 和 postorder 都由 不同 的值组成</li><li>postorder 中每一个值都在 inorder 中</li><li>inorder 保证是树的中序遍历</li><li>postorder 保证是树的后序遍历</li></ul><h1 id="2-解题思路"><a href="#2-解题思路" class="headerlink" title="2.解题思路"></a>2.解题思路</h1><p>可以借鉴<a href="https://zyxelva.github.io/posts/1660581363.html">从前序与中序遍历序列构造二叉树</a> 的思想。<br>同样需要将中序的值-索引先存储。<br>第一个节点（根节点）在后序序列中为postorder[postorder.length-1]，令其二叉树节点为root，index为其值在中序序列的索引，则root.left在中序序列的范围：[inStart, index-1]，在后序序列的范围：[postStart, postStart+index-inStart-1]；而root.right在中序序列的范围：[index+1, inEnd]，在后序序列的范围：[postStart+index-inStart, postEnd-1]. 如图所示：<br><img src="https://img-blog.csdnimg.cn/a691e7e51145423980b265de5ddb4b20.png"><br>其中leftSize为 index-inStart.</p><p><img src="https://img-blog.csdnimg.cn/f28c407641fd4c4cb5f48511ecce78bd.png"></p><h1 id="3-代码"><a href="#3-代码" class="headerlink" title="3.代码"></a>3.代码</h1><figure class="highlight java"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-in8lgplhkez7dw"></i><span>java</span><div class="collapse show" id="collapse-in8lgplhkez7dw"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Definition for a binary tree node.</span><br><span class="hljs-comment"> * public class TreeNode &#123;</span><br><span class="hljs-comment"> *     int val;</span><br><span class="hljs-comment"> *     TreeNode left;</span><br><span class="hljs-comment"> *     TreeNode right;</span><br><span class="hljs-comment"> *     TreeNode() &#123;&#125;</span><br><span class="hljs-comment"> *     TreeNode(int val) &#123; this.val = val; &#125;</span><br><span class="hljs-comment"> *     TreeNode(int val, TreeNode left, TreeNode right) &#123;</span><br><span class="hljs-comment"> *         this.val = val;</span><br><span class="hljs-comment"> *         this.left = left;</span><br><span class="hljs-comment"> *         this.right = right;</span><br><span class="hljs-comment"> *     &#125;</span><br><span class="hljs-comment"> * &#125;</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Solution</span> &#123;<br>    <span class="hljs-keyword">private</span> HashMap&lt;Integer, Integer&gt; elementIndexMap=<span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>    <span class="hljs-keyword">public</span> TreeNode <span class="hljs-title function_">buildTree</span><span class="hljs-params">(<span class="hljs-type">int</span>[] inorder, <span class="hljs-type">int</span>[] postorder)</span> &#123;<br>        <span class="hljs-keyword">if</span>(<span class="hljs-number">0</span>==inorder.length)&#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>        &#125;<br>        <span class="hljs-comment">//首次先遍历下中序，记录各个元素的位置，方便定位后序数组中的元素在中序数据中的位置，区分左右子树</span><br>        <span class="hljs-keyword">if</span>(elementIndexMap.size()==<span class="hljs-number">0</span>)&#123;<br>            <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>;i&lt;inorder.length;i++)&#123;<br>                elementIndexMap.put(inorder[i],i);<br>            &#125;<br>        &#125;<br>        <span class="hljs-comment">//以中序序列为主，将根节点从后序序列最后一个节点取出，确定其在中序中的定位，然后分为前后两节点树，根节点前为左子树，其后为右子树</span><br>        <span class="hljs-keyword">return</span> buildTree2(inorder,<span class="hljs-number">0</span>,inorder.length-<span class="hljs-number">1</span>,postorder,<span class="hljs-number">0</span>,postorder.length-<span class="hljs-number">1</span>);<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">        inStart 中序开始下标</span><br><span class="hljs-comment">        inEnd 中序结束下标</span><br><span class="hljs-comment">        postEnd 后序结束下标（根节点）</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> TreeNode <span class="hljs-title function_">buildTree2</span><span class="hljs-params">(<span class="hljs-type">int</span>[] inorder,<span class="hljs-type">int</span> inStart,<span class="hljs-type">int</span> inEnd,<span class="hljs-type">int</span>[] postorder,<span class="hljs-type">int</span> postStart, <span class="hljs-type">int</span> postEnd)</span>&#123;<br>        <span class="hljs-keyword">if</span>(inStart&gt;inEnd)&#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>        &#125;<br>        <span class="hljs-type">int</span> rootValue=postorder[postEnd];<br>        TreeNode root=<span class="hljs-keyword">new</span> <span class="hljs-title class_">TreeNode</span>(rootValue);<br>        <span class="hljs-type">int</span> index=elementIndexMap.get(rootValue);<br>        <span class="hljs-type">int</span> offset=index-inStart;<br>        <span class="hljs-comment">//左子树-中序数组 is = inStart, ie = index - 1</span><br>        <span class="hljs-comment">//左子树-后序数组 ps = postStart, pe = postStart + offset - 1</span><br>        root.left=buildTree2(inorder,inStart, index-<span class="hljs-number">1</span>, postorder, postStart, postStart+offset-<span class="hljs-number">1</span>);<br>        <span class="hljs-comment">//右子树-中序数组 is = index+1, ie = inEnd</span><br>        <span class="hljs-comment">//右子树-后序数组 ps = postStart+offset, pe = postEnd - 1</span><br>        root.right=buildTree2(inorder,index+<span class="hljs-number">1</span>,inEnd,postorder, postStart+offset,postEnd-<span class="hljs-number">1</span>);<br>        <span class="hljs-keyword">return</span> root;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></div></figure>]]></content>
    
    
    <categories>
      
      <category>算法</category>
      
      <category>二叉树</category>
      
      <category>DFS</category>
      
      <category>LeetCode</category>
      
    </categories>
    
    
    <tags>
      
      <tag>二叉树</tag>
      
      <tag>数据结构</tag>
      
      <tag>LeetCode</tag>
      
      <tag>算法</tag>
      
      <tag>Java</tag>
      
      <tag>DFS</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>【LeetCode】105. 从前序与中序遍历序列构造二叉树</title>
    <link href="/posts/1660581363.html"/>
    <url>/posts/1660581363.html</url>
    
    <content type="html"><![CDATA[<h1 id="1-问题"><a href="#1-问题" class="headerlink" title="1.问题"></a>1.问题</h1><p>给定两个整数数组 preorder 和 inorder ，其中 preorder 是二叉树的先序遍历， inorder 是同一棵树的中序遍历，请构造二叉树并返回其根节点。</p><h2 id="示例-1"><a href="#示例-1" class="headerlink" title="示例 1"></a>示例 1</h2><p><img src="https://img-blog.csdnimg.cn/img_convert/27dd53a0ee432768036d5aa0547dc126.jpeg#pic_center"></p><blockquote><p>输入: preorder &#x3D; [3,9,20,15,7], inorder &#x3D; [9,3,15,20,7]<br>输出: [3,9,20,null,null,15,7]</p></blockquote><p>示例 2:</p><blockquote><p>输入: preorder &#x3D; [-1], inorder &#x3D; [-1]<br>输出: [-1]</p></blockquote><p><strong>提示</strong>:</p><ul><li>1 &lt;&#x3D; preorder.length &lt;&#x3D; 3000</li><li>inorder.length &#x3D;&#x3D; preorder.length</li><li>-3000 &lt;&#x3D; preorder[i], inorder[i] &lt;&#x3D; 3000</li><li>preorder 和 inorder 均 无重复 元素</li><li>inorder 均出现在 preorder</li><li>preorder 保证 为二叉树的前序遍历序列</li><li>inorder 保证 为二叉树的中序遍历序列</li></ul><h1 id="2-解题思路"><a href="#2-解题思路" class="headerlink" title="2.解题思路"></a>2.解题思路</h1><p>以前序序列[1,2,5,4,6,7,3,8,9]，中序序列[5,2,6,4,7,4,3,8,9]为例，先观察各自序列的特征，如下图所示：<br><img src="https://img-blog.csdnimg.cn/img_convert/18c55fed555c47d2f76dbbed87d615bc.png#pic_center"><br>令index为根节点root在中序序列中的索引位置，则root.left在前序序列的范围为：[preStart+1, preStart+index-inStart]，在中序序列的范围为：[inStart, index-1]；而root.right在前序中的范围为：[preStart+index-inStart+1, preEnd] ，在中序序列的范围为：[index+1, inEnd].<br><img src="https://img-blog.csdnimg.cn/img_convert/4dbe56291c5c4e7cc2a12cb042025497.png#pic_center"><br>而在算法开始前，需要遍历中序序列，存储各个节点在中序序列的索引，方便后续根节点定位以及偏移量的计算。<br>因而，利用递归思想，就可以构造出所需的二叉树。</p><p><strong>复杂度分析</strong></p><ul><li><p>时间复杂度：O(n)，其中 n 是树中的节点个数。</p></li><li><p>空间复杂度：O(n)，除去返回的答案需要的 O(n) 空间之外，还需要使用 O(n) 的空间存储哈希映射，以及 O(h)（其中 h 是树的高度）的空间表示递归时栈空间。这里 h&lt;n，所以总空间复杂度为 O(n)。</p></li></ul><h1 id="3-代码"><a href="#3-代码" class="headerlink" title="3.代码"></a>3.代码</h1><figure class="highlight java"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-ze7f2flhkez7dw"></i><span>java</span><div class="collapse show" id="collapse-ze7f2flhkez7dw"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Definition for a binary tree node.</span><br><span class="hljs-comment"> * public class TreeNode &#123;</span><br><span class="hljs-comment"> *     int val;</span><br><span class="hljs-comment"> *     TreeNode left;</span><br><span class="hljs-comment"> *     TreeNode right;</span><br><span class="hljs-comment"> *     TreeNode() &#123;&#125;</span><br><span class="hljs-comment"> *     TreeNode(int val) &#123; this.val = val; &#125;</span><br><span class="hljs-comment"> *     TreeNode(int val, TreeNode left, TreeNode right) &#123;</span><br><span class="hljs-comment"> *         this.val = val;</span><br><span class="hljs-comment"> *         this.left = left;</span><br><span class="hljs-comment"> *         this.right = right;</span><br><span class="hljs-comment"> *     &#125;</span><br><span class="hljs-comment"> * &#125;</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Solution</span> &#123;<br>    Map&lt;Integer, Integer&gt; valueIndexMap=<span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>    <span class="hljs-keyword">public</span> TreeNode <span class="hljs-title function_">buildTree</span><span class="hljs-params">(<span class="hljs-type">int</span>[] preorder, <span class="hljs-type">int</span>[] inorder)</span> &#123;<br><br>        <span class="hljs-comment">//记录中序中 各元素值与索引的映射关系</span><br>        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>;i&lt;inorder.length;i++)&#123;<br>            valueIndexMap.put(inorder[i], i);<br>        &#125;<br>        <span class="hljs-keyword">return</span> build(preorder, <span class="hljs-number">0</span>, preorder.length-<span class="hljs-number">1</span>, inorder, <span class="hljs-number">0</span>, inorder.length-<span class="hljs-number">1</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> TreeNode <span class="hljs-title function_">build</span><span class="hljs-params">(<span class="hljs-type">int</span>[] preorder, <span class="hljs-type">int</span> preStart, <span class="hljs-type">int</span> preEnd, <span class="hljs-type">int</span>[] inorder, <span class="hljs-type">int</span> inStart, <span class="hljs-type">int</span> inEnd)</span>&#123;<br>        <span class="hljs-keyword">if</span>(inStart&gt;inEnd || preStart&gt;preEnd)&#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>        &#125;<br>        <span class="hljs-comment">//根节点</span><br>        TreeNode root=<span class="hljs-keyword">new</span> <span class="hljs-title class_">TreeNode</span>(preorder[preStart]);<br>        <span class="hljs-comment">//根节点在中序中的位置</span><br>        <span class="hljs-type">int</span> rootIndex=valueIndexMap.get(root.val);<br><br>        <span class="hljs-comment">//偏移量</span><br>        <span class="hljs-type">int</span> offset=rootIndex-inStart;<br>        <span class="hljs-comment">//左子树</span><br>        root.left=build(preorder, preStart+<span class="hljs-number">1</span>, preStart+offset, inorder, inStart, rootIndex-<span class="hljs-number">1</span>);<br>        <span class="hljs-comment">//右子树</span><br>        root.right=build(preorder, preStart+offset+<span class="hljs-number">1</span>, preEnd, inorder, rootIndex+<span class="hljs-number">1</span>, inEnd);<br>        <span class="hljs-keyword">return</span> root;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></div></figure>]]></content>
    
    
    <categories>
      
      <category>算法</category>
      
      <category>二叉树</category>
      
      <category>DFS</category>
      
      <category>LeetCode</category>
      
    </categories>
    
    
    <tags>
      
      <tag>二叉树</tag>
      
      <tag>数据结构</tag>
      
      <tag>LeetCode</tag>
      
      <tag>算法</tag>
      
      <tag>Java</tag>
      
      <tag>DFS</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>【Hexo】基于Fluid主题的Hexo增加相册功能实践</title>
    <link href="/posts/3854217120.html"/>
    <url>/posts/3854217120.html</url>
    
    <content type="html"><![CDATA[<p>本文是基于Hexo 6.3.0, Fluid 1.9.4进行开发，主要借鉴于<a href="https://gishai.top/blog/posts/798ba833.html">hexo的fluid主题添加瀑布流懒加载相册功能</a>，其中基于<a href="https://zhuanlan.zhihu.com/p/346643522">jsDelivr+Github 实现免费CDN加速</a>可以参考这篇文章搭建自己的CDN。</p><h1 id="1-创建相册页面"><a href="#1-创建相册页面" class="headerlink" title="1.创建相册页面"></a>1.创建相册页面</h1><ul><li>在自己的博客项目下，新建相册页<figure class="highlight shell"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-azoq6dlhkez7dx"></i><span>shell</span><div class="collapse show" id="collapse-azoq6dlhkez7dx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">hexo new page photos<br></code></pre></td></tr></table></div></figure></li><li>编辑 &#x2F;source&#x2F;photos&#x2F;index.md，输入以下内容<figure class="highlight md"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-gcddrolhkez7dx"></i><span>md</span><div class="collapse show" id="collapse-gcddrolhkez7dx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs md">---<br>title: photos<br>date: 2020-12-30 19:04:03<br><span class="hljs-section">layout: photo</span><br><span class="hljs-section">---</span><br><br><span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span></span><br>.ImageGrid &#123;<br>  width: 100%;<br>  max-width: 1040px;<br>  margin: 0 auto;<br>  text-align: center;<br>&#125;<br>.card &#123;<br>  overflow: hidden;<br>  transition: .3s ease-in-out;<br>  border-radius: 8px;<br>  background-color: #efefef;<br>  padding: 1.4px;<br>&#125;<br>.ImageInCard img &#123;<br>  padding: 0;<br>  border-radius: 8px;<br>  width:100%;<br>  height:100%;<br>&#125;<br>@media (prefers-color-scheme: dark) &#123;<br>  .card &#123;background-color: #333;&#125;<br>&#125;<br><span class="language-xml"><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span></span><br><br><span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;imageTab&quot;</span>&gt;</span></span><span class="language-xml"><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br><span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;ImageGrid&quot;</span>&gt;</span></span><span class="language-xml"><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br><br></code></pre></td></tr></table></div></figure></li></ul><h1 id="2-处理图片信息"><a href="#2-处理图片信息" class="headerlink" title="2.处理图片信息"></a>2.处理图片信息</h1><p>这里需要创建自己的github相册，可参考这篇文章<a href="https://zhuanlan.zhihu.com/p/346643522">jsDelivr+Github 实现免费CDN加速</a>。</p><p>这里主要是为了加快图片的加载速度, 利用GitHub +jsDelivr的方式，此处不再演示。文件夹结构如图:</p><p><img src="https://gishai.top/blog/posts/798ba833/image-20210110205814315.png"></p><p>这里没有安装 image-size，需要npm安装下</p><figure class="highlight shell"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-eb0ow5lhkez7dx"></i><span>shell</span><div class="collapse show" id="collapse-eb0ow5lhkez7dx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">npm i -S image-size<br></code></pre></td></tr></table></div></figure><p>在github相册目录下，执行createjs，脚本如下：</p><figure class="highlight js"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-lc90oflhkez7dx"></i><span>js</span><div class="collapse show" id="collapse-lc90oflhkez7dx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">const</span> fs = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;fs-extra&#x27;</span>);<br><span class="hljs-keyword">const</span> path = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;path&#x27;</span>);<br><span class="hljs-keyword">const</span> imageSize = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;image-size&#x27;</span>);<br><br><span class="hljs-keyword">const</span> rootPath=<span class="hljs-string">&quot;gallery/&quot;</span>   <span class="hljs-comment">//相册相对路径，也可填绝对路径，指向相册的目录，目的为了生成json</span><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">PhotoExtension</span> &#123;<br>    <span class="hljs-title function_">constructor</span>(<span class="hljs-params"></span>) &#123;<br>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">size</span> = <span class="hljs-number">64</span>;<br>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">offset</span> = [<span class="hljs-number">0</span>, <span class="hljs-number">0</span>];<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Photo</span> &#123;<br>    <span class="hljs-title function_">constructor</span>(<span class="hljs-params"></span>) &#123;<br>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">dirName</span> = <span class="hljs-string">&#x27;&#x27;</span>;<br>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">fileName</span> = <span class="hljs-string">&#x27;&#x27;</span>;<br>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">iconID</span> = <span class="hljs-string">&#x27;&#x27;</span>;<br>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">extension</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">PhotoExtension</span>();<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">PhotoGroup</span> &#123;<br>    <span class="hljs-title function_">constructor</span>(<span class="hljs-params"></span>) &#123;<br>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = <span class="hljs-string">&#x27;&#x27;</span>;<br>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">children</span> = [];<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">createPlotIconsData</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-keyword">let</span> allPlots = [];<br>    <span class="hljs-keyword">let</span> allPlotGroups = [];<br><br>    <span class="hljs-keyword">const</span> plotJsonFile = path.<span class="hljs-title function_">join</span>(__dirname, <span class="hljs-string">&#x27;./photosInfo.json&#x27;</span>);<br>    <span class="hljs-keyword">const</span> plotGroupJsonFile = path.<span class="hljs-title function_">join</span>(__dirname, <span class="hljs-string">&#x27;./photos.json&#x27;</span>);<br><br>    <span class="hljs-keyword">if</span> (fs.<span class="hljs-title function_">existsSync</span>(plotJsonFile)) &#123;<br>        allPlots = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(fs.<span class="hljs-title function_">readFileSync</span>(plotJsonFile));<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (fs.<span class="hljs-title function_">existsSync</span>(plotGroupJsonFile)) &#123;<br>        allPlotGroups = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(fs.<span class="hljs-title function_">readFileSync</span>(plotGroupJsonFile));<br>    &#125;<br><br>    fs.<span class="hljs-title function_">readdirSync</span>(__dirname).<span class="hljs-title function_">forEach</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params">dirName</span>) &#123;<br>        <span class="hljs-keyword">const</span> stats = fs.<span class="hljs-title function_">statSync</span>(path.<span class="hljs-title function_">join</span>(__dirname, dirName));<br>        <span class="hljs-keyword">const</span> isDir = stats.<span class="hljs-title function_">isDirectory</span>();<br>        <span class="hljs-keyword">if</span> (isDir) &#123;<br>            <span class="hljs-keyword">const</span> subfiles = fs.<span class="hljs-title function_">readdirSync</span>(path.<span class="hljs-title function_">join</span>(__dirname, dirName));<br>            subfiles.<span class="hljs-title function_">forEach</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params">subfileName</span>) &#123;<br>                <span class="hljs-comment">// 如果已经存在 则不再处理</span><br>                <span class="hljs-comment">// if (allPlots.find(o =&gt; o.fileName === subfileName &amp;&amp; o.dirName === dirName)) &#123;</span><br>                <span class="hljs-comment">//     return;</span><br>                <span class="hljs-comment">// &#125;</span><br><br>                <span class="hljs-comment">// 新增标</span><br>                <span class="hljs-keyword">const</span> plot = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Photo</span>();<br>                plot.<span class="hljs-property">dirName</span> = dirName;<br>                plot.<span class="hljs-property">fileName</span> = subfileName;<br>                <span class="hljs-keyword">const</span> imageInfo = <span class="hljs-title function_">imageSize</span>(rootPath+dirName + <span class="hljs-string">&quot;/&quot;</span> + subfileName);<br>                plot.<span class="hljs-property">iconID</span> = imageInfo.<span class="hljs-property">width</span> + <span class="hljs-string">&#x27;.&#x27;</span> + imageInfo.<span class="hljs-property">height</span> + <span class="hljs-string">&#x27; &#x27;</span> + subfileName;<br>                allPlots.<span class="hljs-title function_">push</span>(plot);<br>                <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`RD: createPlotIconsData -&gt; new plot`</span>, plot);<br><br>                <span class="hljs-comment">// 为新增标添加分组 暂时以它所处的文件夹为分组</span><br>                <span class="hljs-keyword">let</span> group = allPlotGroups.<span class="hljs-title function_">find</span>(<span class="hljs-function"><span class="hljs-params">o</span> =&gt;</span> o.<span class="hljs-property">name</span> === dirName);<br>                <span class="hljs-keyword">if</span> (!group) &#123;<br>                    group = <span class="hljs-keyword">new</span> <span class="hljs-title class_">PhotoGroup</span>();<br>                    group.<span class="hljs-property">name</span> = dirName;<br>                    allPlotGroups.<span class="hljs-title function_">push</span>(group);<br>                    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`RD: createPlotIconsData -&gt; new group`</span>, group);<br>                &#125;<br>                group.<span class="hljs-property">children</span>.<span class="hljs-title function_">push</span>(plot.<span class="hljs-property">iconID</span>);<br>            &#125;);<br>        &#125;<br>    &#125;);<br><br>    fs.<span class="hljs-title function_">writeJSONSync</span>(plotJsonFile, allPlots);<br>    fs.<span class="hljs-title function_">writeJSONSync</span>(plotGroupJsonFile, allPlotGroups);<br>&#125;<br><br><span class="hljs-title function_">createPlotIconsData</span>();<br></code></pre></td></tr></table></div></figure><p>将photos.json拷贝到博客目录下的photos<br><img src="https://gishai.top/blog/posts/798ba833/image-20210110210639345.png"></p><h1 id="3-加载-js和css文件"><a href="#3-加载-js和css文件" class="headerlink" title="3.加载 js和css文件"></a>3.加载 js和css文件</h1><p>在 &#x2F;source&#x2F;js&#x2F; 目录下创建 photoWall.js</p><figure class="highlight js"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-d5196olhkez7dx"></i><span>js</span><div class="collapse show" id="collapse-d5196olhkez7dx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">var</span> imgDataPath = <span class="hljs-string">&quot;/blog/photos/photos.json&quot;</span>; <span class="hljs-comment">//图片名称高宽信息json文件路径</span><br><span class="hljs-keyword">var</span> imgPath = <span class="hljs-string">&quot;https://cdn.jsdelivr.net/gh/Cenergy/images/gallery/&quot;</span>; <span class="hljs-comment">//图片访问路径, 这里参考文章开头提到的CDN加速</span><br><span class="hljs-keyword">var</span> imgMaxNum = <span class="hljs-number">50</span>; <span class="hljs-comment">//图片显示数量</span><br><br><span class="hljs-keyword">var</span> windowWidth =<br>  <span class="hljs-variable language_">window</span>.<span class="hljs-property">innerWidth</span> ||<br>  <span class="hljs-variable language_">document</span>.<span class="hljs-property">documentElement</span>.<span class="hljs-property">clientWidth</span> ||<br>  <span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>.<span class="hljs-property">clientWidth</span>;<br><span class="hljs-keyword">if</span> (windowWidth &lt; <span class="hljs-number">768</span>) &#123;<br>  <span class="hljs-keyword">var</span> imageWidth = <span class="hljs-number">145</span>; <span class="hljs-comment">//图片显示宽度(手机端)</span><br>&#125; <span class="hljs-keyword">else</span> &#123;<br>  <span class="hljs-keyword">var</span> imageWidth = <span class="hljs-number">250</span>; <span class="hljs-comment">//图片显示宽度</span><br>&#125;<br><br><span class="hljs-keyword">const</span> photo = &#123;<br>  <span class="hljs-attr">page</span>: <span class="hljs-number">1</span>,<br>  <span class="hljs-attr">offset</span>: imgMaxNum,<br>  <span class="hljs-attr">init</span>: <span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-keyword">var</span> that = <span class="hljs-variable language_">this</span>;<br>    $.<span class="hljs-title function_">getJSON</span>(imgDataPath, <span class="hljs-keyword">function</span> (<span class="hljs-params">data</span>) &#123;<br>      that.<span class="hljs-title function_">render</span>(that.<span class="hljs-property">page</span>, data);<br>      <span class="hljs-comment">//that.scroll(data);</span><br>      that.<span class="hljs-title function_">eventListen</span>(data);<br>    &#125;);<br>  &#125;,<br>  <span class="hljs-title function_">constructHtml</span>(<span class="hljs-params">options</span>) &#123;<br>    <span class="hljs-keyword">const</span> &#123;<br>      imageWidth,<br>      imageX,<br>      imageY,<br>      name,<br>      imgPath,<br>      imgName,<br>      imgNameWithPattern,<br>    &#125; = options;<br>    <span class="hljs-keyword">const</span> htmlEle = <span class="hljs-string">`&lt;div class=&quot;card lozad&quot; style=&quot;width:<span class="hljs-subst">$&#123;imageWidth&#125;</span>px&quot;&gt;</span><br><span class="hljs-string">                  &lt;div class=&quot;ImageInCard&quot; style=&quot;height:<span class="hljs-subst">$&#123;</span></span><br><span class="hljs-subst"><span class="hljs-string">                    (imageWidth * imageY) / imageX</span></span><br><span class="hljs-subst"><span class="hljs-string">                  &#125;</span>px&quot;&gt;</span><br><span class="hljs-string">                    &lt;a data-fancybox=&quot;gallery&quot; href=&quot;<span class="hljs-subst">$&#123;imgPath&#125;</span><span class="hljs-subst">$&#123;name&#125;</span>/<span class="hljs-subst">$&#123;imgNameWithPattern&#125;</span>&quot;</span><br><span class="hljs-string">                          data-caption=&quot;<span class="hljs-subst">$&#123;imgName&#125;</span>&quot; title=&quot;<span class="hljs-subst">$&#123;imgName&#125;</span>&quot;&gt;</span><br><span class="hljs-string">                            &lt;img  class=&quot;lazyload&quot; data-src=&quot;<span class="hljs-subst">$&#123;imgPath&#125;</span><span class="hljs-subst">$&#123;name&#125;</span>/<span class="hljs-subst">$&#123;imgNameWithPattern&#125;</span>&quot;</span><br><span class="hljs-string">                            src=&quot;data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==&quot;</span><br><span class="hljs-string">                            onload=&quot;lzld(this)&quot;</span><br><span class="hljs-string">                            lazyload=&quot;auto&quot;&gt;</span><br><span class="hljs-string">                        &lt;/a&gt;</span><br><span class="hljs-string">                  &lt;/div&gt;</span><br><span class="hljs-string">                &lt;/div&gt;`</span>;<br>    <span class="hljs-keyword">return</span> htmlEle;<br>  &#125;,<br>  <span class="hljs-attr">render</span>: <span class="hljs-keyword">function</span> (<span class="hljs-params">page, data = []</span>) &#123;<br>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">data</span> = data;<br>    <span class="hljs-keyword">if</span> (!data.<span class="hljs-property">length</span>) <span class="hljs-keyword">return</span>;<br>    <span class="hljs-keyword">var</span> html,<br>      imgNameWithPattern,<br>      imgName,<br>      imageSize,<br>      imageX,<br>      imageY,<br>      li = <span class="hljs-string">&quot;&quot;</span>;<br><br>    <span class="hljs-keyword">let</span> liHtml = <span class="hljs-string">&quot;&quot;</span>;<br>    <span class="hljs-keyword">let</span> contentHtml = <span class="hljs-string">&quot;&quot;</span>;<br><br>    data.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">item, index</span>) =&gt;</span> &#123;<br>      <span class="hljs-keyword">const</span> activeClass = index === <span class="hljs-number">0</span> ? <span class="hljs-string">&quot;active&quot;</span> : <span class="hljs-string">&quot;&quot;</span>;<br>      liHtml += <span class="hljs-string">`&lt;li class=&quot;nav-item&quot; role=&quot;presentation&quot;&gt;</span><br><span class="hljs-string">          &lt;a class=&quot;nav-link <span class="hljs-subst">$&#123;activeClass&#125;</span> photo-tab&quot; id=&quot;home-tab&quot; photo-uuid=&quot;<span class="hljs-subst">$&#123;item.name&#125;</span>&quot; data-toggle=&quot;tab&quot; href=&quot;#<span class="hljs-subst">$&#123;item.name&#125;</span>&quot;  role=&quot;tab&quot; aria-controls=&quot;<span class="hljs-subst">$&#123;item.name&#125;</span>&quot; aria-selected=&quot;true&quot;&gt;<span class="hljs-subst">$&#123;item.name&#125;</span>&lt;/a&gt;</span><br><span class="hljs-string">        &lt;/li&gt;`</span>;<br>    &#125;);<br>    <span class="hljs-keyword">const</span> [initData = &#123;&#125;] = data;<br>    <span class="hljs-keyword">const</span> &#123; children = [],name &#125; = initData;<br>    children.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">item, index</span>) =&gt;</span> &#123;<br>      imgNameWithPattern = item.<span class="hljs-title function_">split</span>(<span class="hljs-string">&quot; &quot;</span>)[<span class="hljs-number">1</span>];<br>      imgName = imgNameWithPattern.<span class="hljs-title function_">split</span>(<span class="hljs-string">&quot;.&quot;</span>)[<span class="hljs-number">0</span>];<br>      imageSize = item.<span class="hljs-title function_">split</span>(<span class="hljs-string">&quot; &quot;</span>)[<span class="hljs-number">0</span>];<br>      imageX = imageSize.<span class="hljs-title function_">split</span>(<span class="hljs-string">&quot;.&quot;</span>)[<span class="hljs-number">0</span>];<br>      imageY = imageSize.<span class="hljs-title function_">split</span>(<span class="hljs-string">&quot;.&quot;</span>)[<span class="hljs-number">1</span>];<br>      <span class="hljs-keyword">let</span> imgOptions = &#123;<br>        imageWidth,<br>        imageX,<br>        imageY,<br>        name,<br>        imgName,<br>        imgPath,<br>        imgNameWithPattern,<br>      &#125;;<br>      li += <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">constructHtml</span>(imgOptions);<br>    &#125;);<br>    contentHtml += <span class="hljs-string">` &lt;div class=&quot;tab-pane fade show active&quot;  role=&quot;tabpanel&quot; aria-labelledby=&quot;home-tab&quot;&gt;<span class="hljs-subst">$&#123;li&#125;</span>&lt;/div&gt;`</span>;<br><br>    <span class="hljs-keyword">const</span> ulHtml = <span class="hljs-string">`&lt;ul class=&quot;nav nav-tabs&quot; id=&quot;myTab&quot; role=&quot;tablist&quot;&gt;<span class="hljs-subst">$&#123;liHtml&#125;</span>&lt;/ul&gt;`</span>;<br>    <span class="hljs-keyword">const</span> tabContent = <span class="hljs-string">`&lt;div class=&quot;tab-content&quot; id=&quot;myTabContent&quot;&gt;<span class="hljs-subst">$&#123;contentHtml&#125;</span>&lt;/div&gt;`</span>;<br><br>    $(<span class="hljs-string">&quot;#imageTab&quot;</span>).<span class="hljs-title function_">append</span>(ulHtml);<br>    $(<span class="hljs-string">&quot;.ImageGrid&quot;</span>).<span class="hljs-title function_">append</span>(tabContent);<br>    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">minigrid</span>();<br>  &#125;,<br>  <span class="hljs-attr">eventListen</span>: <span class="hljs-keyword">function</span> (<span class="hljs-params">data</span>) &#123;<br>    <span class="hljs-keyword">let</span> self = <span class="hljs-variable language_">this</span>;<br>    <span class="hljs-keyword">var</span> html,<br>      imgNameWithPattern,<br>      imgName,<br>      imageSize,<br>      imageX,<br>      imageY,<br>      li = <span class="hljs-string">&quot;&quot;</span>;<br>    $(<span class="hljs-string">&#x27;a[data-toggle=&quot;tab&quot;]&#x27;</span>).<span class="hljs-title function_">on</span>(<span class="hljs-string">&quot;shown.bs.tab&quot;</span>, <span class="hljs-keyword">function</span> (<span class="hljs-params">e</span>) &#123;<br>      $(<span class="hljs-string">&quot;.ImageGrid&quot;</span>).<span class="hljs-title function_">empty</span>();<br>      <span class="hljs-keyword">const</span> selectId = $(e.<span class="hljs-property">target</span>).<span class="hljs-title function_">attr</span>(<span class="hljs-string">&quot;photo-uuid&quot;</span>);<br>      <span class="hljs-keyword">const</span> selectedData = data.<span class="hljs-title function_">find</span>(<span class="hljs-function">(<span class="hljs-params">data</span>) =&gt;</span> data.<span class="hljs-property">name</span> === selectId) || &#123;&#125;;<br>      <span class="hljs-keyword">const</span> &#123; children,name &#125; = selectedData;<br>      <span class="hljs-keyword">let</span> li = <span class="hljs-string">&quot;&quot;</span>;<br>      children.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">item, index</span>) =&gt;</span> &#123;<br>        imgNameWithPattern = item.<span class="hljs-title function_">split</span>(<span class="hljs-string">&quot; &quot;</span>)[<span class="hljs-number">1</span>];<br>        imgName = imgNameWithPattern.<span class="hljs-title function_">split</span>(<span class="hljs-string">&quot;.&quot;</span>)[<span class="hljs-number">0</span>];<br>        imageSize = item.<span class="hljs-title function_">split</span>(<span class="hljs-string">&quot; &quot;</span>)[<span class="hljs-number">0</span>];<br>        imageX = imageSize.<span class="hljs-title function_">split</span>(<span class="hljs-string">&quot;.&quot;</span>)[<span class="hljs-number">0</span>];<br>        imageY = imageSize.<span class="hljs-title function_">split</span>(<span class="hljs-string">&quot;.&quot;</span>)[<span class="hljs-number">1</span>];<br>        <span class="hljs-keyword">let</span> imgOptions = &#123;<br>          imageWidth,<br>          imageX,<br>          imageY,<br>          name,<br>          imgName,<br>          imgPath,<br>          imgNameWithPattern,<br>        &#125;;<br>        li += self.<span class="hljs-title function_">constructHtml</span>(imgOptions);<br>      &#125;);<br>      $(<span class="hljs-string">&quot;.ImageGrid&quot;</span>).<span class="hljs-title function_">append</span>(li);<br>      self.<span class="hljs-title function_">minigrid</span>();<br>    &#125;);<br>  &#125;,<br>  <span class="hljs-attr">minigrid</span>: <span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-keyword">var</span> grid = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Minigrid</span>(&#123;<br>      <span class="hljs-attr">container</span>: <span class="hljs-string">&quot;.ImageGrid&quot;</span>,<br>      <span class="hljs-attr">item</span>: <span class="hljs-string">&quot;.card&quot;</span>,<br>      <span class="hljs-attr">gutter</span>: <span class="hljs-number">12</span>,<br>    &#125;);<br>    grid.<span class="hljs-title function_">mount</span>();<br>    $(<span class="hljs-variable language_">window</span>).<span class="hljs-title function_">resize</span>(<span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) &#123;<br>      grid.<span class="hljs-title function_">mount</span>();<br>    &#125;);<br>  &#125;,<br>&#125;;<br>photo.<span class="hljs-title function_">init</span>();<br><br></code></pre></td></tr></table></div></figure><p>然后使用注册器将需要的js,css注入,在scripts&#x2F;injector.js(如没有,则创建)中输入以下内容</p><figure class="highlight js"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-24zzpglhkez7dx"></i><span>js</span><div class="collapse show" id="collapse-24zzpglhkez7dx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">const</span> &#123; <span class="hljs-attr">root</span>: siteRoot = <span class="hljs-string">&quot;/&quot;</span> &#125; = hexo.<span class="hljs-property">config</span>;<br><span class="hljs-comment">// layout为photo的时候导入这些js与css</span><br>hexo.<span class="hljs-property">extend</span>.<span class="hljs-property">injector</span>.<span class="hljs-title function_">register</span>(<br>  <span class="hljs-string">&quot;body_end&quot;</span>,<br>  <span class="hljs-string">`</span><br><span class="hljs-string">  &lt;link rel=&quot;stylesheet&quot; href=&quot;https://cdn.staticfile.org/fancybox/3.5.7/jquery.fancybox.min.css&quot;&gt;</span><br><span class="hljs-string">  &lt;script src=&quot;//cdn.jsdelivr.net/npm/minigrid@3.1.1/dist/minigrid.min.js&quot;&gt;&lt;/script&gt;</span><br><span class="hljs-string">  &lt;script src=&quot;https://cdn.staticfile.org/fancybox/3.5.7/jquery.fancybox.min.js&quot;&gt;&lt;/script&gt;</span><br><span class="hljs-string">&lt;script src=&quot;https://cdn.bootcdn.net/ajax/libs/lazyloadjs/3.2.2/lazyload.js&quot;&gt;&lt;/script&gt;</span><br><span class="hljs-string">    &lt;script defer src=&quot;<span class="hljs-subst">$&#123;siteRoot&#125;</span>js/photoWall.js&quot;&gt;&lt;/script&gt;`</span>,<br>  <span class="hljs-string">&quot;photo&quot;</span><br>);<br></code></pre></td></tr></table></div></figure><p>最后 hexo clean &amp;&amp; hexo g &amp;&amp; hexo s，本地部署看看效果。</p><p><strong>提示</strong>：<br>GitHub +jsDelivr 期初加载有点慢，要等好几分钟，所有图才有加速，不要误以为是其他问题。</p>]]></content>
    
    
    <categories>
      
      <category>Hexo主题</category>
      
      <category>Fluid</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Hexo</tag>
      
      <tag>Fluid</tag>
      
      <tag>相册</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>【Hexo】Hexo基于Fluid主题固定背景图片</title>
    <link href="/posts/545836814.html"/>
    <url>/posts/545836814.html</url>
    
    <content type="html"><![CDATA[<p>本文基于Fluid主题，设置固定背景。</p><p>博客的根目录为 ~&#x2F;blog，主题解压位置为 ~&#x2F;blog&#x2F;themes&#x2F;fluid</p><p>接下来创建三个文件</p><h1 id="一、创建-injector-js-文件"><a href="#一、创建-injector-js-文件" class="headerlink" title="一、创建 injector.js 文件"></a>一、创建 injector.js 文件</h1><p>进入 ~&#x2F;blog&#x2F;themes&#x2F;fluid&#x2F;scripts 创建 injector.js 文件<br>1</p><figure class="highlight js"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-i7276jlhkez7dw"></i><span>js</span><div class="collapse show" id="collapse-i7276jlhkez7dw"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-comment">// 全屏背景的需要导入这些js</span><br><span class="hljs-keyword">const</span> &#123; <span class="hljs-attr">root</span>: siteRoot = <span class="hljs-string">&quot;/themes/fluid/source/&quot;</span> &#125; = hexo.<span class="hljs-property">config</span>;<br>hexo.<span class="hljs-property">extend</span>.<span class="hljs-property">injector</span>.<span class="hljs-title function_">register</span>(<span class="hljs-string">&quot;body_begin&quot;</span>, <span class="hljs-string">`&lt;div id=&quot;web_bg&quot;&gt;&lt;/div&gt;`</span>);<br>hexo.<span class="hljs-property">extend</span>.<span class="hljs-property">injector</span>.<span class="hljs-title function_">register</span>(<br>  <span class="hljs-string">&quot;body_end&quot;</span>,<br>  <span class="hljs-string">`&lt;script src=&quot;<span class="hljs-subst">$&#123;siteRoot&#125;</span>js/backgroundize.js&quot;&gt;&lt;/script&gt;</span><br><span class="hljs-string">  &lt;link defer rel=&quot;stylesheet&quot; href=&quot;<span class="hljs-subst">$&#123;siteRoot&#125;</span>css/backgroundize.css&quot; /&gt;</span><br><span class="hljs-string">  `</span><br>);<br></code></pre></td></tr></table></div></figure><h1 id="二、创建-backgroundize-js-文件"><a href="#二、创建-backgroundize-js-文件" class="headerlink" title="二、创建 backgroundize.js 文件"></a>二、创建 backgroundize.js 文件</h1><p>进入 ~&#x2F;blog&#x2F;themes&#x2F;fluid&#x2F;source&#x2F;js 创建 backgroundize.js 文件</p><figure class="highlight js"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-20twcllhkez7dw"></i><span>js</span><div class="collapse show" id="collapse-20twcllhkez7dw"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">const</span> bannerContainer = $(<span class="hljs-string">&quot;#banner&quot;</span>);<br><span class="hljs-keyword">const</span> viewBg = $(<span class="hljs-string">&quot;#web_bg&quot;</span>);<br><span class="hljs-keyword">const</span> bannerMask = $(<span class="hljs-string">&quot;#banner .mask&quot;</span>);<br><span class="hljs-keyword">const</span> bg = $(bannerContainer).<span class="hljs-title function_">css</span>(<span class="hljs-string">&quot;background-image&quot;</span>);<br>$(viewBg).<span class="hljs-title function_">css</span>(<span class="hljs-string">&quot;background-image&quot;</span>, bg);<br>$(bannerContainer).<span class="hljs-title function_">css</span>(<span class="hljs-string">&quot;background-image&quot;</span>, <span class="hljs-string">&quot;url()&quot;</span>);<br><span class="hljs-keyword">const</span> color = $(bannerMask).<span class="hljs-title function_">css</span>(<span class="hljs-string">&quot;background-color&quot;</span>);<br>$(bannerMask).<span class="hljs-title function_">css</span>(<span class="hljs-string">&quot;background-color&quot;</span>, <span class="hljs-string">`rgba(0,0,0,0)`</span>);<br>$(viewBg).<span class="hljs-title function_">css</span>(<span class="hljs-string">&quot;background-color&quot;</span>, color);<br></code></pre></td></tr></table></div></figure><h1 id="三、创建-backgroundize-css-文件"><a href="#三、创建-backgroundize-css-文件" class="headerlink" title="三、创建 backgroundize.css 文件"></a>三、创建 backgroundize.css 文件</h1><p>进入 ~&#x2F;blog&#x2F;themes&#x2F;fluid&#x2F;source&#x2F;css 创建 backgroundize.css 文件</p><figure class="highlight css"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-xua2aklhkez7dw"></i><span>css</span><div class="collapse show" id="collapse-xua2aklhkez7dw"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs css"><span class="hljs-selector-id">#web_bg</span> &#123;<br>    <span class="hljs-attribute">position</span>: fixed;<br>    <span class="hljs-attribute">z-index</span>: -<span class="hljs-number">999</span>;<br>    <span class="hljs-attribute">width</span>: <span class="hljs-number">100%</span>;<br>    <span class="hljs-attribute">height</span>: <span class="hljs-number">100%</span>;<br>    <span class="hljs-attribute">background-attachment</span>: local;<br>    <span class="hljs-attribute">background-position</span>: center;<br>    -webkit-<span class="hljs-attribute">background-size</span>: cover;<br>    -moz-<span class="hljs-attribute">background-size</span>: cover;<br>    <span class="hljs-attribute">background-size</span>: cover;<br>    <span class="hljs-attribute">background-repeat</span>: repeat;<br>  &#125;<br></code></pre></td></tr></table></div></figure><h1 id="四、清理缓存、部署"><a href="#四、清理缓存、部署" class="headerlink" title="四、清理缓存、部署"></a>四、清理缓存、部署</h1><p>之后执行 hexo clean 和 hexo server查看效果吧。满足预期，即可推送至服务器部署。</p>]]></content>
    
    
    <categories>
      
      <category>Hexo主题</category>
      
      <category>Fluid</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Hexo</tag>
      
      <tag>Fluid</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>【多线程】ThreadPoolExcutor线程池</title>
    <link href="/posts/2142099506.html"/>
    <url>/posts/2142099506.html</url>
    
    <content type="html"><![CDATA[<h1 id="一、Executors创建线程池"><a href="#一、Executors创建线程池" class="headerlink" title="一、Executors创建线程池"></a>一、Executors创建线程池</h1><h2 id="1-newFixedThreadPool"><a href="#1-newFixedThreadPool" class="headerlink" title="1.newFixedThreadPool"></a>1.newFixedThreadPool</h2><p>先来看看源码中是怎么构造的：</p><figure class="highlight java"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-74uunglhkez7dx"></i><span>java</span><div class="collapse show" id="collapse-74uunglhkez7dx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> ExecutorService <span class="hljs-title function_">newFixedThreadPool</span><span class="hljs-params">(<span class="hljs-type">int</span> nThreads)</span> &#123;<br>  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadPoolExecutor</span>(nThreads, <br>  nThreads,<br>                                <span class="hljs-number">0L</span>, <br>                                TimeUnit.MILLISECONDS,<br>                                <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedBlockingQueue</span>&lt;Runnable&gt;());<br>&#125;<br></code></pre></td></tr></table></div></figure><p>核心线程数和最大线程数是一样的，且阻塞队列为LinkedBlockingQueue，最大长度为$2^{31}-1&#x3D;2147483647$，可以看看它的构造方法：</p><figure class="highlight java"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-ci9ftelhkez7dx"></i><span>java</span><div class="collapse show" id="collapse-ci9ftelhkez7dx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-title function_">LinkedBlockingQueue</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-built_in">this</span>(Integer.MAX_VALUE);<br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-title function_">LinkedBlockingQueue</span><span class="hljs-params">(<span class="hljs-type">int</span> capacity)</span> &#123;<br>    <span class="hljs-keyword">if</span> (capacity &lt;= <span class="hljs-number">0</span>) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>();<br>    <span class="hljs-built_in">this</span>.capacity = capacity;<br>    last = head = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Node</span>&lt;E&gt;(<span class="hljs-literal">null</span>);<br>&#125;<br></code></pre></td></tr></table></div></figure><h2 id="2-newSingleThreadExecutor"><a href="#2-newSingleThreadExecutor" class="headerlink" title="2.newSingleThreadExecutor"></a>2.newSingleThreadExecutor</h2><figure class="highlight java"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-x0x5xulhkez7dx"></i><span>java</span><div class="collapse show" id="collapse-x0x5xulhkez7dx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> ExecutorService <span class="hljs-title function_">newSingleThreadExecutor</span><span class="hljs-params">()</span> &#123;<br>     <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FinalizableDelegatedExecutorService</span><br>         (<span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadPoolExecutor</span>(<span class="hljs-number">1</span>, <span class="hljs-number">1</span>,<br>                                 <span class="hljs-number">0L</span>, TimeUnit.MILLISECONDS,<br>                                 <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedBlockingQueue</span>&lt;Runnable&gt;()));<br> &#125;<br></code></pre></td></tr></table></div></figure><p>可以看出，与newFixedThreadPool类似，这里核心线程数和最大线程数均为1.<br>也很明显，如果用newFixedThreadPool、newSingleThreadExecutor，<strong>主要问题会出现在阻塞队列过长，堆积的请求处理队列可能会耗费非常大的内存，甚至OOM</strong>。</p><h2 id="3-newCachedThreadPool"><a href="#3-newCachedThreadPool" class="headerlink" title="3.newCachedThreadPool"></a>3.newCachedThreadPool</h2><figure class="highlight java"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-vdt2r9lhkez7dx"></i><span>java</span><div class="collapse show" id="collapse-vdt2r9lhkez7dx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> ExecutorService <span class="hljs-title function_">newCachedThreadPool</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadPoolExecutor</span>(<span class="hljs-number">0</span>, Integer.MAX_VALUE,<br>                                  <span class="hljs-number">60L</span>, TimeUnit.SECONDS,<br>                                  <span class="hljs-keyword">new</span> <span class="hljs-title class_">SynchronousQueue</span>&lt;Runnable&gt;());<br>&#125;<br></code></pre></td></tr></table></div></figure><h2 id="4-newScheduledThreadPool"><a href="#4-newScheduledThreadPool" class="headerlink" title="4.newScheduledThreadPool"></a>4.newScheduledThreadPool</h2><figure class="highlight java"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-tk5oovlhkez7dx"></i><span>java</span><div class="collapse show" id="collapse-tk5oovlhkez7dx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> ScheduledExecutorService <span class="hljs-title function_">newScheduledThreadPool</span><span class="hljs-params">(<span class="hljs-type">int</span> corePoolSize)</span> &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ScheduledThreadPoolExecutor</span>(corePoolSize);<br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-title function_">ScheduledThreadPoolExecutor</span><span class="hljs-params">(<span class="hljs-type">int</span> corePoolSize)</span> &#123;<br>    <span class="hljs-built_in">super</span>(corePoolSize, Integer.MAX_VALUE, <span class="hljs-number">0</span>, NANOSECONDS,<br>          <span class="hljs-keyword">new</span> <span class="hljs-title class_">DelayedWorkQueue</span>());<br>&#125;<br></code></pre></td></tr></table></div></figure><p>newCachedThreadPool、newScheduledThreadPool会出问题体现在<strong>最大核心线程数都是Integer.MAX_VALUE，可能会创建数量非常多的线程，甚至OOM</strong>。</p><h1 id="二、ThreadPoolExcutor显示创建线程池"><a href="#二、ThreadPoolExcutor显示创建线程池" class="headerlink" title="二、ThreadPoolExcutor显示创建线程池"></a>二、ThreadPoolExcutor显示创建线程池</h1><h2 id="1-入参说明"><a href="#1-入参说明" class="headerlink" title="1.入参说明"></a>1.入参说明</h2><p>先看看构造方法：</p><figure class="highlight java"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-l0d9q3lhkez7dx"></i><span>java</span><div class="collapse show" id="collapse-l0d9q3lhkez7dx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-title function_">ThreadPoolExecutor</span><span class="hljs-params">(<span class="hljs-type">int</span> corePoolSize,</span><br><span class="hljs-params">                              <span class="hljs-type">int</span> maximumPoolSize,</span><br><span class="hljs-params">                              <span class="hljs-type">long</span> keepAliveTime,</span><br><span class="hljs-params">                              TimeUnit unit,</span><br><span class="hljs-params">                              BlockingQueue&lt;Runnable&gt; workQueue,</span><br><span class="hljs-params">                              ThreadFactory threadFactory,</span><br><span class="hljs-params">                              RejectedExecutionHandler handler)</span> &#123;...&#125;<br></code></pre></td></tr></table></div></figure><ul><li><p>corePoolSize：核心线程数。线程池维护线程的最少数量。在没有任务执行时线程池的大小。（ps: 在创建ThreadPoolExecutor初期，线程并不会立即启动，而是等到有任务提交时才会启动，除非调用prestartAllCoreThreads）</p></li><li><p>maximumPoolSize：线程池维护线程的最大数量。</p></li><li><p>keepAliveTime：线程池维护线程所允许的空闲时间。只有当<strong>线程池的线程数 &gt; corePoolSize</strong> 时，keepAliveTime 才会起作用。但当 ThreadPoolExecutor 的 allowCoreThreadTimeOut 变量设置为 true 时，核心线程超时后会被回收。</p></li><li><p>unit：线程池维护线程所允许的空闲时间的<strong>单位</strong>。</p></li><li><p>workQueue：阻塞队列。当<strong>当前线程数&gt;corePoolSize</strong>，新进来的任务会放置在此。常见的有以下几种：</p><ul><li>ArrayBlockingQueue是一个有边界的阻塞队列，它的内部实现是一个数组。它的容量在初始化时就确定不变。</li><li>LinkedBlockingQueue：阻塞队列大小的配置是可选的，其内部实现是一个链表。</li><li>PriorityBlockingQueue：是一个没有边界的队列，所有插入到PriorityBlockingQueue的对象必须实现java.lang.Comparable接口，队列优先级的排序就是按照我们对这个接口的实现来定义的。</li><li>SynchronousQueue队列内部仅允许容纳一个元素。当一个线程插入一个元素后会被阻塞，除非这个元素被另一个线程消费。</li></ul></li><li><p>threadFactory：线程工厂，主要用来创建线程。</p></li><li><p>handler：当线程数达到最大时，新的任务的拒绝策略，包括: </p><ul><li>ThreadPoolExecutor.AbortPolicy:丢弃任务并抛出RejectedExecutionException异常。</li><li>ThreadPoolExecutor.DiscardPolicy：也是丢弃任务，但是不抛出异常。</li><li>ThreadPoolExecutor.DiscardOldestPolicy：丢弃队列最前面的任务，然后重新尝试执行任务（重复此过程）</li><li>ThreadPoolExecutor.CallerRunsPolicy：只要线程池不关闭，该策略直接在调用者线程中，运行当前被丢弃的任务；</li></ul><p>  可以自定义实现RejectedExecutionHandler。</p></li></ul><h2 id="2-内部执行流程"><a href="#2-内部执行流程" class="headerlink" title="2.内部执行流程"></a>2.内部执行流程</h2><p><img src="https://img-blog.csdnimg.cn/2021040121195681.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2tlemFkZQ==,size_16,color_FFFFFF,t_70"></p><p>1). 线程池刚创建时，里面没有一个线程。任务队列是作为参数传进来的。不过，就算队列里面有任务，线程池也不会马上执行它们。</p><p>2). 当调用execute()方法添加一个任务时，线程池会做如下判断：</p><ul><li>如果<strong>正在运行的线程数小于corePoolSize</strong>，那么马上创建线程运行这个任务。</li><li>如果<strong>正在运行的线程数大于或者等于corePoolSize</strong>,那么将这个任务放入队列。</li><li>如果这个时候<strong>队列满了</strong>，而且<strong>正在运行的线程数量小于maximumPoolSize</strong>,那么还是要创建线程运行这个任务。</li><li>如果<strong>队列满了</strong>，而且<strong>正在运行的线程数量大于或等于 maximumPoolSize</strong>，通过 handler所指定的策略来处理此任务。</li></ul><p>3). 当一个线程完成任务时，它会从队列中取下一个任务来执行。</p><p>4). 当一个线程无事可做，超过一定的时间（keepAliveTime）时，线程池会判断，如果<strong>当前运行的线程数大于corePoolSize</strong>时，那么这个线程会被停用掉，所以线程池的所有任务完成后，它最终会收缩到corePoolSize的大小。</p>]]></content>
    
    
    <categories>
      
      <category>并发编程</category>
      
    </categories>
    
    
    <tags>
      
      <tag>多线程</tag>
      
      <tag>线程池</tag>
      
      <tag>ThreadPoolExcutor</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>【Spring源码学习】FactoryBean 类型的接口</title>
    <link href="/posts/4184190066.html"/>
    <url>/posts/4184190066.html</url>
    
    <content type="html"><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>在<a href="https://zyxelva.github.io/2023/05/01/%E3%80%90Spring%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0%E3%80%91Spring-Bean%E5%AE%9E%E4%BE%8B%E5%8C%96%E8%BF%87%E7%A8%8B-%E5%88%9B%E5%BB%BABean%E5%AE%9E%E4%BE%8B/">【Spring源码学习】Spring Bean实例化过程-创建Bean实例</a>一文中，实例在真正创建完成(完成了创建、依赖属性注入、初始化)后，会有FactoryBean的接口调用，我们先定位到这段代码来看看，本章也主要跟一下这个调用的流程。</p><figure class="highlight java"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-dcrh0elhkez7dx"></i><span>java</span><div class="collapse show" id="collapse-dcrh0elhkez7dx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//AbstractBeanFactory</span><br><span class="hljs-keyword">protected</span> &lt;T&gt; T <span class="hljs-title function_">doGetBean</span><span class="hljs-params">(</span><br><span class="hljs-params">String name, <span class="hljs-meta">@Nullable</span> Class&lt;T&gt; requiredType, <span class="hljs-meta">@Nullable</span> Object[] args, <span class="hljs-type">boolean</span> typeCheckOnly)</span> <span class="hljs-keyword">throws</span> BeansException &#123;<br><span class="hljs-comment">// 获取一个beanName，处理两种情况，一个是前面说的 FactoryBean (前面带 &#x27;&amp;&#x27;)，</span><br><span class="hljs-comment">// 一个是别名问题，因为这个方法是 getBean，获取 Bean 用的，你要是传一个别名进来，是完全可以的</span><br><span class="hljs-type">String</span> <span class="hljs-variable">beanName</span> <span class="hljs-operator">=</span> transformedBeanName(name);<br>Object bean;<br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * Description : 检查缓存中或者实例工厂中是否有对应的实例</span><br><span class="hljs-comment"> * 因为在创建单例 bean的时候会存在依赖注入，而在创建依赖的时候为了避免循环依赖，</span><br><span class="hljs-comment"> * spring创建bean的原则是：不等 bean 创建完成就将创建bean的 ObjectFactory 提早曝光，</span><br><span class="hljs-comment"> *  换句话说，也就是将 ObjectFactory 加入到缓存中，一旦下一个bean创建的时候需要依赖上</span><br><span class="hljs-comment"> *  一个bean则直接使用 ObjectFactory</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> *  第一次getSingleton(beanName)</span><br><span class="hljs-comment"> */</span><br><span class="hljs-comment">// Eagerly check singleton cache for manually registered singletons.</span><br><span class="hljs-type">Object</span> <span class="hljs-variable">sharedInstance</span> <span class="hljs-operator">=</span> getSingleton(beanName);<br><span class="hljs-comment">//如果缓存里面能拿到实例,但第一次缓存中是没有的，所以第一次不会进入这个if</span><br><span class="hljs-keyword">if</span> (sharedInstance != <span class="hljs-literal">null</span> &amp;&amp; args == <span class="hljs-literal">null</span>) &#123;<br><span class="hljs-keyword">if</span> (logger.isTraceEnabled()) &#123;<br><span class="hljs-keyword">if</span> (isSingletonCurrentlyInCreation(beanName)) &#123;<br>logger.trace(<span class="hljs-string">&quot;Returning eagerly cached instance of singleton bean &#x27;&quot;</span> + beanName +<br><span class="hljs-string">&quot;&#x27; that is not fully initialized yet - a consequence of a circular reference&quot;</span>);<br>&#125;<br><span class="hljs-keyword">else</span> &#123;<br>logger.trace(<span class="hljs-string">&quot;Returning cached instance of singleton bean &#x27;&quot;</span> + beanName + <span class="hljs-string">&quot;&#x27;&quot;</span>);<br>&#125;<br>&#125;<br><span class="hljs-comment">// 该方法是 FactoryBean 接口的调用入口</span><br><span class="hljs-comment">// 如果是普通 Bean 的话，直接返回 sharedInstance（直接返回对象本身）</span><br><span class="hljs-comment">// 如果是 FactoryBean 的话，返回它创建的那个实例对象(返回指定方法返回的实例)</span><br>bean = getObjectForBeanInstance(sharedInstance, name, beanName, <span class="hljs-literal">null</span>);<br>&#125;<br><span class="hljs-comment">//如果singletonObjects缓存里面没有，则走下来</span><br><span class="hljs-keyword">else</span> &#123;<br><span class="hljs-comment">//如果是scope 是Prototype的，校验是否有出现循环依赖，如果有则直接报错</span><br><span class="hljs-keyword">if</span> (isPrototypeCurrentlyInCreation(beanName)) &#123;<br><span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BeanCurrentlyInCreationException</span>(beanName);<br>&#125;<br><span class="hljs-comment">// Check if bean definition exists in this factory.</span><br><span class="hljs-comment">//检查一下这个 BeanDefinition 在容器中是否存在</span><br><span class="hljs-type">BeanFactory</span> <span class="hljs-variable">parentBeanFactory</span> <span class="hljs-operator">=</span> getParentBeanFactory();<br><br><span class="hljs-comment">//......省略部分代码</span><br><br><span class="hljs-comment">//要开始创建bean了，分两种情况：一种是针对单例的（singleton），一种是针对多例的（prototype），一种是自定义scope的</span><br><span class="hljs-keyword">try</span> &#123;<br><span class="hljs-comment">//父子BeanDefinition合并</span><br><span class="hljs-type">RootBeanDefinition</span> <span class="hljs-variable">mbd</span> <span class="hljs-operator">=</span> getMergedLocalBeanDefinition(beanName);<br>checkMergedBeanDefinition(mbd, beanName, args);<br><span class="hljs-comment">//获取依赖对象属性，依赖对象要先实例化</span><br><span class="hljs-comment">// Guarantee initialization of beans that the current bean depends on.</span><br>String[] dependsOn = mbd.getDependsOn();<br><br><span class="hljs-comment">//......省略部分代码</span><br><br><span class="hljs-comment">//单例情况singleton，着重看，大部分是单例的情况</span><br><span class="hljs-comment">// Create bean instance.</span><br><span class="hljs-keyword">if</span> (mbd.isSingleton()) &#123;<br>sharedInstance = getSingleton(beanName, () -&gt; &#123;<br><span class="hljs-keyword">try</span> &#123;<br><span class="hljs-keyword">return</span> createBean(beanName, mbd, args);<br>&#125;<br><span class="hljs-keyword">catch</span> (BeansException ex) &#123;<br>destroySingleton(beanName);<br><span class="hljs-keyword">throw</span> ex;<br>&#125;<br>&#125;);<br><span class="hljs-comment">//该方法是FactoryBean接口的调用入口</span><br>bean = getObjectForBeanInstance(sharedInstance, name, beanName, mbd);<br>&#125;<br><span class="hljs-comment">//多例情况prototype</span><br><span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (mbd.isPrototype()) &#123;<br><span class="hljs-comment">// It&#x27;s a prototype -&gt; create a new instance.</span><br><span class="hljs-type">Object</span> <span class="hljs-variable">prototypeInstance</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br><span class="hljs-keyword">try</span> &#123;<br>beforePrototypeCreation(beanName);<br>prototypeInstance = createBean(beanName, mbd, args);<br>&#125;<br><span class="hljs-keyword">finally</span> &#123;<br>afterPrototypeCreation(beanName);<br>&#125;<br><span class="hljs-comment">//该方法是FactoryBean接口的调用入口</span><br>bean = getObjectForBeanInstance(prototypeInstance, name, beanName, mbd);<br>&#125;<br><span class="hljs-comment">// 如果不是 singleton 和 prototype 的话，需要委托给相应的实现类来处理</span><br><span class="hljs-keyword">else</span> &#123;<br><span class="hljs-type">String</span> <span class="hljs-variable">scopeName</span> <span class="hljs-operator">=</span> mbd.getScope();<br><span class="hljs-keyword">if</span> (!StringUtils.hasLength(scopeName)) &#123;<br><span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalStateException</span>(<span class="hljs-string">&quot;No scope name defined for bean ´&quot;</span> + beanName + <span class="hljs-string">&quot;&#x27;&quot;</span>);<br>&#125;<br><span class="hljs-type">Scope</span> <span class="hljs-variable">scope</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.scopes.get(scopeName);<br><span class="hljs-keyword">if</span> (scope == <span class="hljs-literal">null</span>) &#123;<br><span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalStateException</span>(<span class="hljs-string">&quot;No Scope registered for scope name &#x27;&quot;</span> + scopeName + <span class="hljs-string">&quot;&#x27;&quot;</span>);<br>&#125;<br><span class="hljs-keyword">try</span> &#123;<br><span class="hljs-type">Object</span> <span class="hljs-variable">scopedInstance</span> <span class="hljs-operator">=</span> scope.get(beanName, () -&gt; &#123;<br>beforePrototypeCreation(beanName);<br><span class="hljs-keyword">try</span> &#123;<br><span class="hljs-keyword">return</span> createBean(beanName, mbd, args);<br>&#125;<br><span class="hljs-keyword">finally</span> &#123;<br>afterPrototypeCreation(beanName);<br>&#125;<br>&#125;);<br>bean = getObjectForBeanInstance(scopedInstance, name, beanName, mbd);<br>&#125;<br><span class="hljs-keyword">catch</span> (IllegalStateException ex) &#123;<br><span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BeanCreationException</span>(beanName,<br><span class="hljs-string">&quot;Scope &#x27;&quot;</span> + scopeName + <span class="hljs-string">&quot;&#x27; is not active for the current thread; consider &quot;</span> +<br><span class="hljs-string">&quot;defining a scoped proxy for this bean if you intend to refer to it from a singleton&quot;</span>,<br>ex);<br>&#125;<br>&#125;<br>&#125;<br><span class="hljs-keyword">catch</span> (BeansException ex) &#123;<br>cleanupAfterBeanCreationFailure(beanName);<br><span class="hljs-keyword">throw</span> ex;<br>&#125;<br>&#125;<br><br><span class="hljs-comment">//......省略部分代码</span><br><br><span class="hljs-keyword">return</span> (T) bean;<br>&#125;<br></code></pre></td></tr></table></div></figure><p>bean &#x3D; getObjectForBeanInstance()方法就是FactoryBean接口的调用入口了。而这个接口首次调用则是在创建完成一个可用的bean之后，也就是在下面这个代码里首次调用的(<strong>本章主要针对单例，其他多例、自定义scope类似</strong>)</p><figure class="highlight java"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-yd0so7lhkez7dx"></i><span>java</span><div class="collapse show" id="collapse-yd0so7lhkez7dx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">if</span> (mbd.isSingleton()) &#123;<br>sharedInstance = getSingleton(beanName, () -&gt; &#123;<br><span class="hljs-keyword">try</span> &#123;<br><span class="hljs-keyword">return</span> createBean(beanName, mbd, args);<br>&#125;<br><span class="hljs-keyword">catch</span> (BeansException ex) &#123;<br><span class="hljs-comment">// Explicitly remove instance from singleton cache: It might have been put there</span><br><span class="hljs-comment">// eagerly by the creation process, to allow for circular reference resolution.</span><br><span class="hljs-comment">// Also remove any beans that received a temporary reference to the bean.</span><br>destroySingleton(beanName);<br><span class="hljs-keyword">throw</span> ex;<br>&#125;<br>&#125;);<br><span class="hljs-comment">//该方法是FactoryBean接口的调用入口</span><br>bean = getObjectForBeanInstance(sharedInstance, name, beanName, mbd);<br>&#125;<br></code></pre></td></tr></table></div></figure><h1 id="一、FactoryBean接口的调用"><a href="#一、FactoryBean接口的调用" class="headerlink" title="一、FactoryBean接口的调用"></a>一、FactoryBean接口的调用</h1><h2 id="1-getObjectForBeanInstance"><a href="#1-getObjectForBeanInstance" class="headerlink" title="1.getObjectForBeanInstance()"></a>1.getObjectForBeanInstance()</h2><figure class="highlight java"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-74kw63lhkez7dx"></i><span>java</span><div class="collapse show" id="collapse-74kw63lhkez7dx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">protected</span> Object <span class="hljs-title function_">getObjectForBeanInstance</span><span class="hljs-params">(Object beanInstance, String name, String beanName, <span class="hljs-meta">@Nullable</span> RootBeanDefinition mbd)</span> &#123;<br><span class="hljs-comment">// Don&#x27;t let calling code try to dereference the factory if the bean isn&#x27;t a factory.</span><br><span class="hljs-comment">//以&amp;开头，针对本身就是FactoryBean的判断</span><br><span class="hljs-comment">//如果要获取到FactoryBean 类本身，就必须加上”&amp;”符号，比如beanFactory.getBean(“&amp;beanName”),</span><br><span class="hljs-keyword">if</span> (BeanFactoryUtils.isFactoryDereference(name)) &#123;<br><span class="hljs-keyword">if</span> (beanInstance <span class="hljs-keyword">instanceof</span> NullBean) &#123;<br><span class="hljs-keyword">return</span> beanInstance;<br>&#125;<br><span class="hljs-keyword">if</span> (!(beanInstance <span class="hljs-keyword">instanceof</span> FactoryBean)) &#123;<br><span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BeanIsNotAFactoryException</span>(beanName, beanInstance.getClass());<br>&#125;<br><span class="hljs-keyword">if</span> (mbd != <span class="hljs-literal">null</span>) &#123;<br>mbd.isFactoryBean = <span class="hljs-literal">true</span>;<br>&#125;<br><span class="hljs-keyword">return</span> beanInstance;<br>&#125;<br><br><span class="hljs-comment">// Now we have the bean instance, which may be a normal bean or a FactoryBean.</span><br><span class="hljs-comment">// If it&#x27;s a FactoryBean, we use it to create a bean instance, unless the</span><br><span class="hljs-comment">// caller actually wants a reference to the factory.</span><br><span class="hljs-comment">//如果实例不是FactoryBean类型的</span><br><span class="hljs-keyword">if</span> (!(beanInstance <span class="hljs-keyword">instanceof</span> FactoryBean)) &#123;<br><span class="hljs-keyword">return</span> beanInstance;<br>&#125;<br><br><span class="hljs-comment">//如果代码能走下来，则说明 beanName不是以&amp;开头，并且beanInstance是FactoryBean类型的</span><br><span class="hljs-type">Object</span> <span class="hljs-variable">object</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br><span class="hljs-keyword">if</span> (mbd != <span class="hljs-literal">null</span>) &#123;<br>mbd.isFactoryBean = <span class="hljs-literal">true</span>;<br>&#125;<br><span class="hljs-keyword">else</span> &#123;<br><span class="hljs-comment">//从缓存里面拿FactoryBean类型的实例</span><br>object = getCachedObjectForFactoryBean(beanName);<br>&#125;<br><span class="hljs-keyword">if</span> (object == <span class="hljs-literal">null</span>) &#123;<br><span class="hljs-comment">// Return bean instance from factory.</span><br>FactoryBean&lt;?&gt; factory = (FactoryBean&lt;?&gt;) beanInstance;<br><span class="hljs-comment">// Caches object obtained from FactoryBean if it is a singleton.</span><br><span class="hljs-keyword">if</span> (mbd == <span class="hljs-literal">null</span> &amp;&amp; containsBeanDefinition(beanName)) &#123;<br>mbd = getMergedLocalBeanDefinition(beanName);<br>&#125;<br><span class="hljs-type">boolean</span> <span class="hljs-variable">synthetic</span> <span class="hljs-operator">=</span> (mbd != <span class="hljs-literal">null</span> &amp;&amp; mbd.isSynthetic());<br><span class="hljs-comment">//重点看</span><br>object = getObjectFromFactoryBean(factory, beanName, !synthetic);<br>&#125;<br><span class="hljs-keyword">return</span> object;<br>&#125;<br></code></pre></td></tr></table></div></figure><p>这里有两种情况下的返回</p><ul><li>直接返回原对象：针对bean实例本身就是FactoryBean类型或者beanName是以&amp;开头的情况</li><li>返回factoryBean：beanName不是以&amp;开头，并且beanInstance是FactoryBean类型的，这里又分情况：<ul><li>从factoryBeanObjectCache缓存中获取</li><li>缓存中不存在该bean，则调用factory的getObject()方法，并且判断一级缓存中如果存在该bean 实例把实例缓存到factoryBeanObjectCache 对应的map 中，这个是单独缓存FactoryBean 类型实例的map</li></ul></li></ul><h2 id="2-getObjectFromFactoryBean-doGetObjectFromFactoryBean"><a href="#2-getObjectFromFactoryBean-doGetObjectFromFactoryBean" class="headerlink" title="2.getObjectFromFactoryBean(), doGetObjectFromFactoryBean()"></a>2.getObjectFromFactoryBean(), doGetObjectFromFactoryBean()</h2><figure class="highlight java"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-bjujknlhkez7dx"></i><span>java</span><div class="collapse show" id="collapse-bjujknlhkez7dx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//FactoryBeanRegistrySupport</span><br><span class="hljs-keyword">protected</span> Object <span class="hljs-title function_">getObjectFromFactoryBean</span><span class="hljs-params">(FactoryBean&lt;?&gt; factory, String beanName, <span class="hljs-type">boolean</span> shouldPostProcess)</span> &#123;<br><span class="hljs-comment">//factory是单例且一级缓存中存在</span><br><span class="hljs-keyword">if</span> (factory.isSingleton() &amp;&amp; containsSingleton(beanName)) &#123;<br><span class="hljs-keyword">synchronized</span> (getSingletonMutex()) &#123;<br><span class="hljs-type">Object</span> <span class="hljs-variable">object</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.factoryBeanObjectCache.get(beanName);<br><span class="hljs-keyword">if</span> (object == <span class="hljs-literal">null</span>) &#123;<br><span class="hljs-comment">//调用getObject方法</span><br>object = doGetObjectFromFactoryBean(factory, beanName);<br><span class="hljs-comment">// Only post-process and store if not put there already during getObject() call above</span><br><span class="hljs-comment">// (e.g. because of circular reference processing triggered by custom getBean calls)</span><br><span class="hljs-type">Object</span> <span class="hljs-variable">alreadyThere</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.factoryBeanObjectCache.get(beanName);<br><span class="hljs-keyword">if</span> (alreadyThere != <span class="hljs-literal">null</span>) &#123;<br>object = alreadyThere;<br>&#125;<br><span class="hljs-keyword">else</span> &#123;<br><span class="hljs-comment">//后置处理</span><br><span class="hljs-keyword">if</span> (shouldPostProcess) &#123;<br><span class="hljs-keyword">if</span> (isSingletonCurrentlyInCreation(beanName)) &#123;<br><span class="hljs-comment">// Temporarily return non-post-processed object, not storing it yet..</span><br><span class="hljs-keyword">return</span> object;<br>&#125;<br>beforeSingletonCreation(beanName);<br><span class="hljs-keyword">try</span> &#123;<br>object = postProcessObjectFromFactoryBean(object, beanName);<br>&#125;<br><span class="hljs-keyword">catch</span> (Throwable ex) &#123;<br><span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BeanCreationException</span>(beanName,<br><span class="hljs-string">&quot;Post-processing of FactoryBean&#x27;s singleton object failed&quot;</span>, ex);<br>&#125;<br><span class="hljs-keyword">finally</span> &#123;<br>afterSingletonCreation(beanName);<br>&#125;<br>&#125;<br><span class="hljs-keyword">if</span> (containsSingleton(beanName)) &#123;<br><span class="hljs-comment">//把实例缓存到factoryBeanObjectCache map中，这个是单独缓存FactoryBean类型实例的map</span><br><span class="hljs-built_in">this</span>.factoryBeanObjectCache.put(beanName, object);<br>&#125;<br>&#125;<br>&#125;<br><span class="hljs-keyword">return</span> object;<br>&#125;<br>&#125;<br><span class="hljs-keyword">else</span> &#123;<br><span class="hljs-type">Object</span> <span class="hljs-variable">object</span> <span class="hljs-operator">=</span> doGetObjectFromFactoryBean(factory, beanName);<br><span class="hljs-keyword">if</span> (shouldPostProcess) &#123;<br><span class="hljs-keyword">try</span> &#123;<br>object = postProcessObjectFromFactoryBean(object, beanName);<br>&#125;<br><span class="hljs-keyword">catch</span> (Throwable ex) &#123;<br><span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BeanCreationException</span>(beanName, <span class="hljs-string">&quot;Post-processing of FactoryBean&#x27;s object failed&quot;</span>, ex);<br>&#125;<br>&#125;<br><span class="hljs-keyword">return</span> object;<br>&#125;<br>&#125;<br><br><span class="hljs-keyword">private</span> Object <span class="hljs-title function_">doGetObjectFromFactoryBean</span><span class="hljs-params">(FactoryBean&lt;?&gt; factory, String beanName)</span> <span class="hljs-keyword">throws</span> BeanCreationException &#123;<br>Object object;<br><span class="hljs-keyword">try</span> &#123;<br><span class="hljs-keyword">if</span> (System.getSecurityManager() != <span class="hljs-literal">null</span>) &#123;<br><span class="hljs-type">AccessControlContext</span> <span class="hljs-variable">acc</span> <span class="hljs-operator">=</span> getAccessControlContext();<br><span class="hljs-keyword">try</span> &#123;<br>object = AccessController.doPrivileged((PrivilegedExceptionAction&lt;Object&gt;) factory::getObject, acc);<br>&#125;<br><span class="hljs-keyword">catch</span> (PrivilegedActionException pae) &#123;<br><span class="hljs-keyword">throw</span> pae.getException();<br>&#125;<br>&#125;<br><span class="hljs-keyword">else</span> &#123;<br><span class="hljs-comment">//调用getObject方法</span><br>object = factory.getObject();<br>&#125;<br>&#125;<br><span class="hljs-keyword">catch</span> (FactoryBeanNotInitializedException ex) &#123;<br><span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BeanCurrentlyInCreationException</span>(beanName, ex.toString());<br>&#125;<br><span class="hljs-keyword">catch</span> (Throwable ex) &#123;<br><span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BeanCreationException</span>(beanName, <span class="hljs-string">&quot;FactoryBean threw exception on object creation&quot;</span>, ex);<br>&#125;<br><br><span class="hljs-comment">// Do not accept a null value for a FactoryBean that&#x27;s not fully</span><br><span class="hljs-comment">// initialized yet: Many FactoryBeans just return null then.</span><br><span class="hljs-keyword">if</span> (object == <span class="hljs-literal">null</span>) &#123;<br><span class="hljs-keyword">if</span> (isSingletonCurrentlyInCreation(beanName)) &#123;<br><span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BeanCurrentlyInCreationException</span>(<br>beanName, <span class="hljs-string">&quot;FactoryBean which is currently in creation returned null from getObject&quot;</span>);<br>&#125;<br>object = <span class="hljs-keyword">new</span> <span class="hljs-title class_">NullBean</span>();<br>&#125;<br><span class="hljs-keyword">return</span> object;<br>&#125;<br></code></pre></td></tr></table></div></figure><p>BeanFactory.getBean(“beanName”)只能获取到getObject()方法返回的实例。getObject 方法返回的实例会有单独的缓存存储，跟其他实例不是同一个缓存，对应的缓存是：factoryBeanObjectCache。</p><h1 id="二、总结"><a href="#二、总结" class="headerlink" title="二、总结"></a>二、总结</h1><ul><li>FactoryBean 接口的首次调用入口在实例化、IOC&#x2F;DI 以及初始化做完后，就会调用FactoryBean 类型的接口</li><li>如果要获取到FactoryBean 类本身，就必须加上”&amp;”符号，比如beanFactory.getBean(“&amp;beanName”)</li><li>factoryBean有单独的缓存factoryBeanObjectCache，跟其他实例不是同一个</li></ul><p>有关FactoryBean的作用和例子可以参考这位大佬写的例子-<a href="https://bestcxx.blog.csdn.net/article/details/103242240?utm_medium=distribute.pc_relevant.none-task-blog-2~default~BlogCommendFromMachineLearnPai2~default-4.vipsorttest&depth_1-utm_source=distribute.pc_relevant.none-task-blog-2~default~BlogCommendFromMachineLearnPai2~default-4.vipsorttest">Spring 源码学习 FactoryBean</a></p>]]></content>
    
    
    <categories>
      
      <category>Spring源码学习</category>
      
    </categories>
    
    
    <tags>
      
      <tag>源码</tag>
      
      <tag>Spring</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>【Spring源码学习】BeanPostProccessor的理解</title>
    <link href="/posts/1657025153.html"/>
    <url>/posts/1657025153.html</url>
    
    <content type="html"><![CDATA[<p>BeanPostProcessor 接口类型实例是针对某种特定功能的埋点，在这个点会根据接口类型来过滤掉不关注这个点的其他类，只有真正关注的类才会在这个点进行相应的功能实现。</p><h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><h2 id="Spring-初始化核心流程"><a href="#Spring-初始化核心流程" class="headerlink" title="Spring 初始化核心流程"></a>Spring 初始化核心流程</h2><p>spring容器初始化的核心方法AbstractApplicationContext#refresh，</p><ul><li>refresh Spring 初始化核心流程入口<ul><li>prepareRefresh ① 准备此上下文用于刷新，设置启动时间和active标志，初始化属性</li><li>obtainFreshBeanFactory ② 创建 BeanFactory 已经跟踪过的源码流程</li><li>prepareBeanFactory ③ 设置 BeanFactory 的基本属性</li><li>postProcessBeanFactory ④ 子类处理自定义的BeanFactoryPostProcess</li><li>invokeBeanFactoryPostProcessors ⑤ 调用所有的BeanFactoryPostProcessor <strong>本节主要跟踪的源码流程</strong></li><li>registerBeanPostProcessors ⑥ 注册，把实现了BeanPostProcessor接口的类实例化，加到BeanFactory <strong>本节主要跟踪的源码流程</strong></li><li>initMessageSource ⑦ 初始化上下文中的资源文件，如国际化文件的处理等</li><li>initApplicationEventMulticaster ⑧ 初始化上下文的事件传播器</li><li>onRefresh ⑨ 给子类扩展初始化其他Bean，springboot 中用来做内嵌 tomcat 启动</li><li>registerListeners ⑩ 在所有bean中查找监听 bean，然后注册到广播器中</li><li>finishBeanFactoryInitialization ⑪ 初始化所有的单例Bean、ioc、BeanPostProcessor的执行、Aop入口</li><li>finishRefresh ⑫ 完成刷新过程，发布相应的事件</li></ul></li></ul><h1 id="一、invokeBeanFactoryPostProcessors"><a href="#一、invokeBeanFactoryPostProcessors" class="headerlink" title="一、invokeBeanFactoryPostProcessors()"></a>一、invokeBeanFactoryPostProcessors()</h1><h2 id="1-作用"><a href="#1-作用" class="headerlink" title="1.作用"></a>1.作用</h2><p>invokeBeanFactoryPostProcessors方法，负责激活各种 BeanFactory 处理器，以及两个核心接口的调用：</p><ul><li><p>BeanDefinitionRegistryPostProcessor<br>实际完成了对其实现类中postProcessBeanDefinitionRegistry方法的调用，完成对BeanDefinition的新增、修改</p></li><li><p>BeanFactoryPostProcessor<br>实际完成了对其实现类中postProcessBeanFactory方法的调用；</p></li></ul><h2 id="2-源码跟踪"><a href="#2-源码跟踪" class="headerlink" title="2.源码跟踪"></a>2.源码跟踪</h2><h3 id="2-1-AbstractApplicationContext-invokeBeanFactoryPostProcessors"><a href="#2-1-AbstractApplicationContext-invokeBeanFactoryPostProcessors" class="headerlink" title="2.1.AbstractApplicationContext.invokeBeanFactoryPostProcessors()"></a>2.1.AbstractApplicationContext.invokeBeanFactoryPostProcessors()</h3><figure class="highlight java"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-v0p9w5lhkez7dw"></i><span>java</span><div class="collapse show" id="collapse-v0p9w5lhkez7dw"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//AbstractApplicationContext</span><br><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">invokeBeanFactoryPostProcessors</span><span class="hljs-params">(ConfigurableListableBeanFactory beanFactory)</span> &#123;<br><span class="hljs-comment">//委派给PostProcessorRegistrationDelegate去处理</span><br>PostProcessorRegistrationDelegate.invokeBeanFactoryPostProcessors(beanFactory, getBeanFactoryPostProcessors());<br><br><span class="hljs-comment">// Detect a LoadTimeWeaver and prepare for weaving, if found in the meantime</span><br><span class="hljs-comment">// (e.g. through an @Bean method registered by ConfigurationClassPostProcessor)</span><br><span class="hljs-keyword">if</span> (beanFactory.getTempClassLoader() == <span class="hljs-literal">null</span> &amp;&amp; beanFactory.containsBean(LOAD_TIME_WEAVER_BEAN_NAME)) &#123;<br>beanFactory.addBeanPostProcessor(<span class="hljs-keyword">new</span> <span class="hljs-title class_">LoadTimeWeaverAwareProcessor</span>(beanFactory));<br>beanFactory.setTempClassLoader(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ContextTypeMatchClassLoader</span>(beanFactory.getBeanClassLoader()));<br>&#125;<br>&#125;<br></code></pre></td></tr></table></div></figure><h3 id="2-2-PostProcessorRegistrationDelegate-invokeBeanFactoryPostProcessors"><a href="#2-2-PostProcessorRegistrationDelegate-invokeBeanFactoryPostProcessors" class="headerlink" title="2.2.PostProcessorRegistrationDelegate.invokeBeanFactoryPostProcessors()"></a>2.2.PostProcessorRegistrationDelegate.invokeBeanFactoryPostProcessors()</h3><figure class="highlight java"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-4hdmmslhkez7dw"></i><span>java</span><div class="collapse show" id="collapse-4hdmmslhkez7dw"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">invokeBeanFactoryPostProcessors</span><span class="hljs-params">(ConfigurableListableBeanFactory beanFactory, List&lt;BeanFactoryPostProcessor&gt; beanFactoryPostProcessors)</span> &#123;<br><span class="hljs-comment">// Invoke BeanDefinitionRegistryPostProcessors first, if any.</span><br>Set&lt;String&gt; processedBeans = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashSet</span>&lt;&gt;();<br><span class="hljs-keyword">if</span> (beanFactory <span class="hljs-keyword">instanceof</span> BeanDefinitionRegistry) &#123;<br><span class="hljs-type">BeanDefinitionRegistry</span> <span class="hljs-variable">registry</span> <span class="hljs-operator">=</span> (BeanDefinitionRegistry) beanFactory;<br>List&lt;BeanFactoryPostProcessor&gt; regularPostProcessors = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>List&lt;BeanDefinitionRegistryPostProcessor&gt; registryProcessors = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br><span class="hljs-keyword">for</span> (BeanFactoryPostProcessor postProcessor : beanFactoryPostProcessors) &#123;<br><span class="hljs-keyword">if</span> (postProcessor <span class="hljs-keyword">instanceof</span> BeanDefinitionRegistryPostProcessor) &#123;<br><span class="hljs-type">BeanDefinitionRegistryPostProcessor</span> <span class="hljs-variable">registryProcessor</span> <span class="hljs-operator">=</span><br>(BeanDefinitionRegistryPostProcessor) postProcessor;<br>registryProcessor.postProcessBeanDefinitionRegistry(registry);<br>registryProcessors.add(registryProcessor);<br>&#125;<br><span class="hljs-keyword">else</span> &#123;<br>regularPostProcessors.add(postProcessor);<br>&#125;<br>&#125;<br><br><span class="hljs-comment">// Do not initialize FactoryBeans here: We need to leave all regular beans</span><br><span class="hljs-comment">// uninitialized to let the bean factory post-processors apply to them!</span><br><span class="hljs-comment">// Separate between BeanDefinitionRegistryPostProcessors that implement</span><br><span class="hljs-comment">// PriorityOrdered, Ordered, and the rest.</span><br>List&lt;BeanDefinitionRegistryPostProcessor&gt; currentRegistryProcessors = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br><br><span class="hljs-comment">//获取实现了BeanDefinitionRegistryPostProcessor接口的所有类的BeanDefinition对象的beanName</span><br><span class="hljs-comment">// 1、最先调用的是实现了 PriorityOrdered 接口的所有BeanDefinitionRegistryPostProcessor</span><br><span class="hljs-comment">// 中的 postProcessBeanDefinitionRegistry的方法</span><br><span class="hljs-comment">// First, invoke the BeanDefinitionRegistryPostProcessors that implement PriorityOrdered.</span><br>String[] postProcessorNames =<br>beanFactory.getBeanNamesForType(BeanDefinitionRegistryPostProcessor.class, <span class="hljs-literal">true</span>, <span class="hljs-literal">false</span>);<br><span class="hljs-keyword">for</span> (String ppName : postProcessorNames) &#123;<br><span class="hljs-comment">// 判断是否实现了排序接口 PriorityOrdered</span><br><span class="hljs-keyword">if</span> (beanFactory.isTypeMatch(ppName, PriorityOrdered.class)) &#123;<br>currentRegistryProcessors.add(beanFactory.getBean(ppName, BeanDefinitionRegistryPostProcessor.class));<br>processedBeans.add(ppName);<br>&#125;<br>&#125;<br><span class="hljs-comment">//排序</span><br>sortPostProcessors(currentRegistryProcessors, beanFactory);<br>registryProcessors.addAll(currentRegistryProcessors);<br><span class="hljs-comment">//调用过程</span><br>invokeBeanDefinitionRegistryPostProcessors(currentRegistryProcessors, registry);<br>currentRegistryProcessors.clear();<br><span class="hljs-comment">// 2、其次调用的是实现了 Ordered 接口的所有BeanDefinitionRegistryPostProcessor</span><br><span class="hljs-comment">// 中的 postProcessBeanDefinitionRegistry的方法</span><br><span class="hljs-comment">// Next, invoke the BeanDefinitionRegistryPostProcessors that implement Ordered.</span><br>postProcessorNames = beanFactory.getBeanNamesForType(BeanDefinitionRegistryPostProcessor.class, <span class="hljs-literal">true</span>, <span class="hljs-literal">false</span>);<br><span class="hljs-keyword">for</span> (String ppName : postProcessorNames) &#123;<br><span class="hljs-comment">//判断是否是实现的Ordered接口</span><br><span class="hljs-keyword">if</span> (!processedBeans.contains(ppName) &amp;&amp; beanFactory.isTypeMatch(ppName, Ordered.class)) &#123;<br>currentRegistryProcessors.add(beanFactory.getBean(ppName, BeanDefinitionRegistryPostProcessor.class));<br>processedBeans.add(ppName);<br>&#125;<br>&#125;<br>sortPostProcessors(currentRegistryProcessors, beanFactory);<br>registryProcessors.addAll(currentRegistryProcessors);<br>invokeBeanDefinitionRegistryPostProcessors(currentRegistryProcessors, registry);<br>currentRegistryProcessors.clear();<br><br><span class="hljs-comment">// 3、最后调用的是没实现排序接口的所有实现BeanDefinitionRegistryPostProcessor接口</span><br><span class="hljs-comment">// 中的 postProcessBeanDefinitionRegistry的方法</span><br><span class="hljs-comment">// Finally, invoke all other BeanDefinitionRegistryPostProcessors until no further ones appear.</span><br><span class="hljs-type">boolean</span> <span class="hljs-variable">reiterate</span> <span class="hljs-operator">=</span> <span class="hljs-literal">true</span>;<br><span class="hljs-keyword">while</span> (reiterate) &#123;<br>reiterate = <span class="hljs-literal">false</span>;<br>postProcessorNames = beanFactory.getBeanNamesForType(BeanDefinitionRegistryPostProcessor.class, <span class="hljs-literal">true</span>, <span class="hljs-literal">false</span>);<br><span class="hljs-keyword">for</span> (String ppName : postProcessorNames) &#123;<br><span class="hljs-keyword">if</span> (!processedBeans.contains(ppName)) &#123;<br>currentRegistryProcessors.add(beanFactory.getBean(ppName, BeanDefinitionRegistryPostProcessor.class));<br>processedBeans.add(ppName);<br>reiterate = <span class="hljs-literal">true</span>;<br>&#125;<br>&#125;<br>sortPostProcessors(currentRegistryProcessors, beanFactory);<br>registryProcessors.addAll(currentRegistryProcessors);<br>invokeBeanDefinitionRegistryPostProcessors(currentRegistryProcessors, registry);<br>currentRegistryProcessors.clear();<br>&#125;<br><br><span class="hljs-comment">//调用postProcessBeanFactory方法</span><br><span class="hljs-comment">// Now, invoke the postProcessBeanFactory callback of all processors handled so far.</span><br>invokeBeanFactoryPostProcessors(registryProcessors, beanFactory);<br>invokeBeanFactoryPostProcessors(regularPostProcessors, beanFactory);<br>&#125;<br><br><span class="hljs-keyword">else</span> &#123;<br><span class="hljs-comment">// Invoke factory processors registered with the context instance.</span><br>invokeBeanFactoryPostProcessors(beanFactoryPostProcessors, beanFactory);<br>&#125;<br><span class="hljs-comment">//获取实现了BeanFactoryPostProcessor接口的类，获取beanDefinition的名称</span><br><span class="hljs-comment">// Do not initialize FactoryBeans here: We need to leave all regular beans</span><br><span class="hljs-comment">// uninitialized to let the bean factory post-processors apply to them!</span><br>String[] postProcessorNames =<br>beanFactory.getBeanNamesForType(BeanFactoryPostProcessor.class, <span class="hljs-literal">true</span>, <span class="hljs-literal">false</span>);<br><br><span class="hljs-comment">// Separate between BeanFactoryPostProcessors that implement PriorityOrdered,</span><br><span class="hljs-comment">// Ordered, and the rest.</span><br>List&lt;BeanFactoryPostProcessor&gt; priorityOrderedPostProcessors = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>List&lt;String&gt; orderedPostProcessorNames = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>List&lt;String&gt; nonOrderedPostProcessorNames = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br><span class="hljs-keyword">for</span> (String ppName : postProcessorNames) &#123;<br><span class="hljs-keyword">if</span> (processedBeans.contains(ppName)) &#123;<br><span class="hljs-comment">// skip - already processed in first phase above</span><br>&#125;<br><span class="hljs-comment">//实现了PriorityOrdered接口的</span><br><span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (beanFactory.isTypeMatch(ppName, PriorityOrdered.class)) &#123;<br>priorityOrderedPostProcessors.add(beanFactory.getBean(ppName, BeanFactoryPostProcessor.class));<br>&#125;<br><span class="hljs-comment">//实现了Ordered接口的</span><br><span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (beanFactory.isTypeMatch(ppName, Ordered.class)) &#123;<br>orderedPostProcessorNames.add(ppName);<br>&#125;<br><span class="hljs-keyword">else</span> &#123;<br><span class="hljs-comment">//没实现接口的</span><br>nonOrderedPostProcessorNames.add(ppName);<br>&#125;<br>&#125;<br><br><span class="hljs-comment">//排序</span><br><span class="hljs-comment">// First, invoke the BeanFactoryPostProcessors that implement PriorityOrdered.</span><br>sortPostProcessors(priorityOrderedPostProcessors, beanFactory);<br><span class="hljs-comment">//调用</span><br>invokeBeanFactoryPostProcessors(priorityOrderedPostProcessors, beanFactory);<br><br><span class="hljs-comment">// Next, invoke the BeanFactoryPostProcessors that implement Ordered.</span><br>List&lt;BeanFactoryPostProcessor&gt; orderedPostProcessors = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;(orderedPostProcessorNames.size());<br><span class="hljs-keyword">for</span> (String postProcessorName : orderedPostProcessorNames) &#123;<br>orderedPostProcessors.add(beanFactory.getBean(postProcessorName, BeanFactoryPostProcessor.class));<br>&#125;<br>sortPostProcessors(orderedPostProcessors, beanFactory);<br>invokeBeanFactoryPostProcessors(orderedPostProcessors, beanFactory);<br><br><span class="hljs-comment">// Finally, invoke all other BeanFactoryPostProcessors.</span><br>List&lt;BeanFactoryPostProcessor&gt; nonOrderedPostProcessors = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;(nonOrderedPostProcessorNames.size());<br><span class="hljs-keyword">for</span> (String postProcessorName : nonOrderedPostProcessorNames) &#123;<br>nonOrderedPostProcessors.add(beanFactory.getBean(postProcessorName, BeanFactoryPostProcessor.class));<br>&#125;<br>invokeBeanFactoryPostProcessors(nonOrderedPostProcessors, beanFactory);<br><br><span class="hljs-comment">// Clear cached merged bean definitions since the post-processors might have</span><br><span class="hljs-comment">// modified the original metadata, e.g. replacing placeholders in values...</span><br>beanFactory.clearMetadataCache();<br>&#125;<br></code></pre></td></tr></table></div></figure><h3 id="2-3-invokeBeanDefinitionRegistryPostProcessors"><a href="#2-3-invokeBeanDefinitionRegistryPostProcessors" class="headerlink" title="2.3.invokeBeanDefinitionRegistryPostProcessors()"></a>2.3.invokeBeanDefinitionRegistryPostProcessors()</h3><p>调用BeanDefinitionRegistryPostProcessor的postProcessBeanDefinitionRegistry()方法，完成对BeanDefinition的新增、修改</p><figure class="highlight java"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-984n6nlhkez7dw"></i><span>java</span><div class="collapse show" id="collapse-984n6nlhkez7dw"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">invokeBeanDefinitionRegistryPostProcessors</span><span class="hljs-params">(</span><br><span class="hljs-params">Collection&lt;? extends BeanDefinitionRegistryPostProcessor&gt; postProcessors, BeanDefinitionRegistry registry)</span> &#123;<br><br><span class="hljs-keyword">for</span> (BeanDefinitionRegistryPostProcessor postProcessor : postProcessors) &#123;<br>postProcessor.postProcessBeanDefinitionRegistry(registry);<br>&#125;<br>&#125;<br></code></pre></td></tr></table></div></figure><h3 id="2-4-invokeBeanFactoryPostProcessors"><a href="#2-4-invokeBeanFactoryPostProcessors" class="headerlink" title="2.4.invokeBeanFactoryPostProcessors()"></a>2.4.invokeBeanFactoryPostProcessors()</h3><p>调用BeanFactoryPostProcessor的postProcessBeanFactory()方法，完成对BeanFactory的修改</p><figure class="highlight java"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-1zmsrrlhkez7dw"></i><span>java</span><div class="collapse show" id="collapse-1zmsrrlhkez7dw"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">invokeBeanFactoryPostProcessors</span><span class="hljs-params">(</span><br><span class="hljs-params">Collection&lt;? extends BeanFactoryPostProcessor&gt; postProcessors, ConfigurableListableBeanFactory beanFactory)</span> &#123;<br><br><span class="hljs-keyword">for</span> (BeanFactoryPostProcessor postProcessor : postProcessors) &#123;<br>postProcessor.postProcessBeanFactory(beanFactory);<br>&#125;<br>&#125;<br></code></pre></td></tr></table></div></figure><h1 id="二、registerBeanPostProcessors"><a href="#二、registerBeanPostProcessors" class="headerlink" title="二、registerBeanPostProcessors()"></a>二、registerBeanPostProcessors()</h1><p>registerBeanPostProcessors方法主要把实现了BeanPostProcessor接口的类实例化，并且加入到BeanFactory中</p><figure class="highlight java"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-1aa6b2lhkez7dw"></i><span>java</span><div class="collapse show" id="collapse-1aa6b2lhkez7dw"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">registerBeanPostProcessors</span><span class="hljs-params">(</span><br><span class="hljs-params">ConfigurableListableBeanFactory beanFactory, AbstractApplicationContext applicationContext)</span> &#123;<br><span class="hljs-comment">//拿到工程里面所有实现了BeanPostProcessor接口的类，获取到BeanDefinition的名称</span><br>String[] postProcessorNames = beanFactory.getBeanNamesForType(BeanPostProcessor.class, <span class="hljs-literal">true</span>, <span class="hljs-literal">false</span>);<br><br><span class="hljs-comment">// Register BeanPostProcessorChecker that logs an info message when</span><br><span class="hljs-comment">// a bean is created during BeanPostProcessor instantiation, i.e. when</span><br><span class="hljs-comment">// a bean is not eligible for getting processed by all BeanPostProcessors.</span><br><span class="hljs-comment">//beanFactory.getBeanPostProcessorCount()会得到默认容器中注册的 BeanPostProcessor 个数，实际就是调用 List&lt;BeanPostProcessor&gt; beanPostProcessors = new CopyOnWriteArrayList&lt;&gt;()的size()方法，默认的容器注册的 BeanPostProcessor 有：</span><br><span class="hljs-comment">//ApplicationContextAwarePostProcessor</span><br><span class="hljs-comment">//ApplicationListenerDetector</span><br><span class="hljs-comment">//ConfigurationClassPostProcessor</span><br><span class="hljs-comment">//PostProcessorRegistrationDelegate</span><br><span class="hljs-type">int</span> <span class="hljs-variable">beanProcessorTargetCount</span> <span class="hljs-operator">=</span> beanFactory.getBeanPostProcessorCount() + <span class="hljs-number">1</span> + postProcessorNames.length;<br>beanFactory.addBeanPostProcessor(<span class="hljs-keyword">new</span> <span class="hljs-title class_">BeanPostProcessorChecker</span>(beanFactory, beanProcessorTargetCount));<br><br><span class="hljs-comment">// Separate between BeanPostProcessors that implement PriorityOrdered,</span><br><span class="hljs-comment">// Ordered, and the rest.</span><br>List&lt;BeanPostProcessor&gt; priorityOrderedPostProcessors = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>List&lt;BeanPostProcessor&gt; internalPostProcessors = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>List&lt;String&gt; orderedPostProcessorNames = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>List&lt;String&gt; nonOrderedPostProcessorNames = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br><span class="hljs-comment">//提前实例化BeanPostProcessor类型的bean，然后bean进行排序</span><br><span class="hljs-keyword">for</span> (String ppName : postProcessorNames) &#123;<br><span class="hljs-keyword">if</span> (beanFactory.isTypeMatch(ppName, PriorityOrdered.class)) &#123;<br><span class="hljs-comment">//getBean是实例化方法，后面我们在讲bean实例化过程是会着重讲到</span><br><span class="hljs-type">BeanPostProcessor</span> <span class="hljs-variable">pp</span> <span class="hljs-operator">=</span> beanFactory.getBean(ppName, BeanPostProcessor.class);<br>priorityOrderedPostProcessors.add(pp);<br><span class="hljs-comment">//判断类型是否是MergedBeanDefinitionPostProcessor，如果是则代码是内部使用的</span><br><span class="hljs-keyword">if</span> (pp <span class="hljs-keyword">instanceof</span> MergedBeanDefinitionPostProcessor) &#123;<br>internalPostProcessors.add(pp);<br>&#125;<br>&#125;<br><span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (beanFactory.isTypeMatch(ppName, Ordered.class)) &#123;<br>orderedPostProcessorNames.add(ppName);<br>&#125;<br><span class="hljs-keyword">else</span> &#123;<br>nonOrderedPostProcessorNames.add(ppName);<br>&#125;<br>&#125;<br><br><span class="hljs-comment">// First, register the BeanPostProcessors that implement PriorityOrdered.</span><br>sortPostProcessors(priorityOrderedPostProcessors, beanFactory);<br><span class="hljs-comment">//注册到BeanFactory中</span><br>registerBeanPostProcessors(beanFactory, priorityOrderedPostProcessors);<br><br><span class="hljs-comment">// Next, register the BeanPostProcessors that implement Ordered.</span><br>List&lt;BeanPostProcessor&gt; orderedPostProcessors = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;(orderedPostProcessorNames.size());<br><span class="hljs-keyword">for</span> (String ppName : orderedPostProcessorNames) &#123;<br><span class="hljs-type">BeanPostProcessor</span> <span class="hljs-variable">pp</span> <span class="hljs-operator">=</span> beanFactory.getBean(ppName, BeanPostProcessor.class);<br>orderedPostProcessors.add(pp);<br><span class="hljs-keyword">if</span> (pp <span class="hljs-keyword">instanceof</span> MergedBeanDefinitionPostProcessor) &#123;<br>internalPostProcessors.add(pp);<br>&#125;<br>&#125;<br>sortPostProcessors(orderedPostProcessors, beanFactory);<br>registerBeanPostProcessors(beanFactory, orderedPostProcessors);<br><br><span class="hljs-comment">// Now, register all regular BeanPostProcessors.</span><br>List&lt;BeanPostProcessor&gt; nonOrderedPostProcessors = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;(nonOrderedPostProcessorNames.size());<br><span class="hljs-keyword">for</span> (String ppName : nonOrderedPostProcessorNames) &#123;<br><span class="hljs-type">BeanPostProcessor</span> <span class="hljs-variable">pp</span> <span class="hljs-operator">=</span> beanFactory.getBean(ppName, BeanPostProcessor.class);<br>nonOrderedPostProcessors.add(pp);<br><span class="hljs-keyword">if</span> (pp <span class="hljs-keyword">instanceof</span> MergedBeanDefinitionPostProcessor) &#123;<br>internalPostProcessors.add(pp);<br>&#125;<br>&#125;<br>registerBeanPostProcessors(beanFactory, nonOrderedPostProcessors);<br><br><span class="hljs-comment">// Finally, re-register all internal BeanPostProcessors.</span><br>sortPostProcessors(internalPostProcessors, beanFactory);<br>registerBeanPostProcessors(beanFactory, internalPostProcessors);<br><br><span class="hljs-comment">// Re-register post-processor for detecting inner beans as ApplicationListeners,</span><br><span class="hljs-comment">// moving it to the end of the processor chain (for picking up proxies etc).</span><br>beanFactory.addBeanPostProcessor(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ApplicationListenerDetector</span>(applicationContext));<br>&#125;<br></code></pre></td></tr></table></div></figure><p>进入registerBeanPostProcessors()方法，注册过程</p><figure class="highlight java"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-5mxrodlhkez7dw"></i><span>java</span><div class="collapse show" id="collapse-5mxrodlhkez7dw"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 注册当前的 BeanPostProcessor</span><br><span class="hljs-comment">*/</span><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">registerBeanPostProcessors</span><span class="hljs-params">(</span><br><span class="hljs-params">ConfigurableListableBeanFactory beanFactory, List&lt;BeanPostProcessor&gt; postProcessors)</span> &#123;<br><br><span class="hljs-keyword">for</span> (BeanPostProcessor postProcessor : postProcessors) &#123;<br><span class="hljs-comment">// 添加到List&lt;BeanPostProcessor&gt; beanPostProcessors</span><br>beanFactory.addBeanPostProcessor(postProcessor);<br>&#125;<br>&#125;<br></code></pre></td></tr></table></div></figure><h1 id="三、总结"><a href="#三、总结" class="headerlink" title="三、总结"></a>三、总结</h1><p>invokeBeanFactoryPostProcessors和registerBeanPostProcessors两个方法的处理流程基本一致，都分别对实现接口的类实例化调用：</p><ul><li>首先对实现 PriorityOrdered 接口的 beanPostProcessors 排序调用</li><li>其次对实现 Ordered 接口的 beanPostProcessors 排序调用</li><li>最后对没有实现排序接口的 beanPostProcessors 调用</li></ul><h2 id="1-BeanPostProcessor"><a href="#1-BeanPostProcessor" class="headerlink" title="1.BeanPostProcessor"></a>1.BeanPostProcessor</h2><p>BeanPostProcessor有两个方法，</p><ul><li>postProcessBeforeInitialization</li><li>postProcessAfterInitialization。</li></ul><p>它们分别在任何bean初始化回调之前或之后执行（例如InitializingBean的afterPropertiesSet方法或自定义init-method方法之前或者之后）， 在这个时候该bean的属性值已经填充完成了，并且我们返回的bean实例可能已经是原始实例的包装类型了。例如返回一个FactoryBean。</p><p>在本章开头，我们也说过，BeanPostProcessor 接口类型的实例是针对某种特定功能的埋点，在这个点会根据接口类型来过滤掉不关注这个点的其他类，只有真正关注的类才会在这个点进行相应的功能实现。现在来总结下这些埋点。</p><h3 id="1-1-获取有-Autowired-注解的构造函数埋点"><a href="#1-1-获取有-Autowired-注解的构造函数埋点" class="headerlink" title="1.1.获取有@Autowired 注解的构造函数埋点"></a>1.1.获取有@Autowired 注解的构造函数埋点</h3><ul><li>过滤的接口类型是：SmartInstantiationAwareBeanPostProcessor</li><li>调用的方法是：determineCandidateConstructors</li></ul><figure class="highlight java"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-vj1moflhkez7dw"></i><span>java</span><div class="collapse show" id="collapse-vj1moflhkez7dw"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//AbstractAutowireCapableBeanFactory</span><br><span class="hljs-keyword">protected</span> BeanWrapper <span class="hljs-title function_">createBeanInstance</span><span class="hljs-params">(String beanName, RootBeanDefinition mbd, <span class="hljs-meta">@Nullable</span> Object[] args)</span> &#123;<br><span class="hljs-comment">//......省略部分代码</span><br><span class="hljs-comment">//寻找当前正在实例化的bean中有@Autowired注解的构造函数</span><br>Constructor&lt;?&gt;[] ctors = determineConstructorsFromBeanPostProcessors(beanClass, beanName);<br><span class="hljs-keyword">if</span> (ctors != <span class="hljs-literal">null</span> || mbd.getResolvedAutowireMode() == AUTOWIRE_CONSTRUCTOR ||<br>mbd.hasConstructorArgumentValues() || !ObjectUtils.isEmpty(args)) &#123;<br><span class="hljs-comment">//如果ctors不为空，就说明构造函数上有@Autowired注解</span><br><span class="hljs-keyword">return</span> autowireConstructor(beanName, mbd, ctors, args);<br>&#125;<br><span class="hljs-comment">//......省略部分代码</span><br>&#125;<br><br><span class="hljs-keyword">protected</span> Constructor&lt;?&gt;[] determineConstructorsFromBeanPostProcessors(<span class="hljs-meta">@Nullable</span> Class&lt;?&gt; beanClass, String beanName)<br><span class="hljs-keyword">throws</span> BeansException &#123;<br><span class="hljs-keyword">if</span> (beanClass != <span class="hljs-literal">null</span> &amp;&amp; hasInstantiationAwareBeanPostProcessors()) &#123;<br><span class="hljs-comment">// 拿到 BeanPostProcessor 的所有接口，遍历</span><br><span class="hljs-keyword">for</span> (BeanPostProcessor bp : getBeanPostProcessors()) &#123;<br><span class="hljs-keyword">if</span> (bp <span class="hljs-keyword">instanceof</span> SmartInstantiationAwareBeanPostProcessor) &#123;<br><span class="hljs-type">SmartInstantiationAwareBeanPostProcessor</span> <span class="hljs-variable">ibp</span> <span class="hljs-operator">=</span> (SmartInstantiationAwareBeanPostProcessor) bp;<br><span class="hljs-comment">// 获取到有@Autowired注解信息的构造函数</span><br>Constructor&lt;?&gt;[] ctors = ibp.determineCandidateConstructors(beanClass, beanName);<br><span class="hljs-keyword">if</span> (ctors != <span class="hljs-literal">null</span>) &#123;<br><span class="hljs-keyword">return</span> ctors;<br>&#125;<br>&#125;<br>&#125;<br>&#125;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>&#125;<br></code></pre></td></tr></table></div></figure><p>而这个SmartInstantiationAwareBeanPostProcessor智能实例化Bean的后处理器，主要提供了三个方法：</p><ul><li>predictBeanType：预测从此处理器的postProcessBeforeInstantiation回调最终返回的bean的类型。</li><li>determineCandidateConstructors：确定合适的实例化Bean的构造函数。</li><li>getEarlyBeanReference：获取提早暴露的Bean的引用，提早暴露的Bean就是只完成了实例化，还未完成属性赋值和初始化的Bean。</li></ul><h3 id="1-2-收集-Resource-Autowired-Value-PostConstruct，-PreDestroy-注解的方法和属性埋点"><a href="#1-2-收集-Resource-Autowired-Value-PostConstruct，-PreDestroy-注解的方法和属性埋点" class="headerlink" title="1.2.收集@Resource@Autowired@Value@PostConstruct，@PreDestroy 注解的方法和属性埋点"></a>1.2.收集@Resource@Autowired@Value@PostConstruct，@PreDestroy 注解的方法和属性埋点</h3><ul><li>过滤的接口类型是：MergedBeanDefinitionPostProcessor</li><li>调用的方法是：postProcessMergedBeanDefinition</li></ul><figure class="highlight java"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-8wft6slhkez7dw"></i><span>java</span><div class="collapse show" id="collapse-8wft6slhkez7dw"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//AbstractAutowireCapableBeanFactory</span><br><span class="hljs-keyword">protected</span> Object <span class="hljs-title function_">doCreateBean</span><span class="hljs-params">(String beanName, RootBeanDefinition mbd, <span class="hljs-meta">@Nullable</span> Object[] args)</span> <span class="hljs-keyword">throws</span> BeanCreationException &#123;<br><span class="hljs-comment">//......省略部分代码</span><br><span class="hljs-keyword">synchronized</span> (mbd.postProcessingLock) &#123;<br><span class="hljs-keyword">if</span> (!mbd.postProcessed) &#123;<br><span class="hljs-keyword">try</span> &#123;<br><span class="hljs-comment">//CommonAnnotationBeanPostProcessor  支持了@PostConstruct，@PreDestroy,@Resource注解</span><br><span class="hljs-comment">//AutowiredAnnotationBeanPostProcessor 支持 @Autowired,@Value注解</span><br><span class="hljs-comment">//BeanPostProcessor接口的典型运用，这里要理解这个接口</span><br><span class="hljs-comment">//对类中注解的装配过程</span><br><span class="hljs-comment">//重要程度5，必须看</span><br>applyMergedBeanDefinitionPostProcessors(mbd, beanType, beanName);<br>&#125;<br><span class="hljs-keyword">catch</span> (Throwable ex) &#123;<br><span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BeanCreationException</span>(mbd.getResourceDescription(), beanName,<br><span class="hljs-string">&quot;Post-processing of merged bean definition failed&quot;</span>, ex);<br>&#125;<br>mbd.postProcessed = <span class="hljs-literal">true</span>;<br>&#125;<br>&#125;<br><br><span class="hljs-comment">//......省略部分代码</span><br>&#125;<br><br><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">applyMergedBeanDefinitionPostProcessors</span><span class="hljs-params">(RootBeanDefinition mbd, Class&lt;?&gt; beanType, String beanName)</span> &#123;<br><span class="hljs-keyword">for</span> (BeanPostProcessor bp : getBeanPostProcessors()) &#123;<br><span class="hljs-keyword">if</span> (bp <span class="hljs-keyword">instanceof</span> MergedBeanDefinitionPostProcessor) &#123;<br><span class="hljs-type">MergedBeanDefinitionPostProcessor</span> <span class="hljs-variable">bdp</span> <span class="hljs-operator">=</span> (MergedBeanDefinitionPostProcessor) bp;<br>bdp.postProcessMergedBeanDefinition(mbd, beanType, beanName);<br>&#125;<br>&#125;<br>&#125;<br></code></pre></td></tr></table></div></figure><h3 id="1-3-循环依赖解决中bean-的提前暴露埋点"><a href="#1-3-循环依赖解决中bean-的提前暴露埋点" class="headerlink" title="1.3.循环依赖解决中bean 的提前暴露埋点"></a>1.3.循环依赖解决中bean 的提前暴露埋点</h3><ul><li>过滤的接口类型是：SmartInstantiationAwareBeanPostProcessor</li><li>调用的方法是：getEarlyBeanReference</li></ul><figure class="highlight java"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-pqxztllhkez7dw"></i><span>java</span><div class="collapse show" id="collapse-pqxztllhkez7dw"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">protected</span> Object <span class="hljs-title function_">getEarlyBeanReference</span><span class="hljs-params">(String beanName, RootBeanDefinition mbd, Object bean)</span> &#123;<br><span class="hljs-type">Object</span> <span class="hljs-variable">exposedObject</span> <span class="hljs-operator">=</span> bean;<br><span class="hljs-keyword">if</span> (!mbd.isSynthetic() &amp;&amp; hasInstantiationAwareBeanPostProcessors()) &#123;<br><span class="hljs-keyword">for</span> (BeanPostProcessor bp : getBeanPostProcessors()) &#123;<br><span class="hljs-keyword">if</span> (bp <span class="hljs-keyword">instanceof</span> SmartInstantiationAwareBeanPostProcessor) &#123;<br><span class="hljs-type">SmartInstantiationAwareBeanPostProcessor</span> <span class="hljs-variable">ibp</span> <span class="hljs-operator">=</span> (SmartInstantiationAwareBeanPostProcessor) bp;<br>exposedObject = ibp.getEarlyBeanReference(exposedObject, beanName);<br>&#125;<br>&#125;<br>&#125;<br><span class="hljs-keyword">return</span> exposedObject;<br>&#125;<br></code></pre></td></tr></table></div></figure><h3 id="1-4-阻止依赖注入埋点"><a href="#1-4-阻止依赖注入埋点" class="headerlink" title="1.4.阻止依赖注入埋点"></a>1.4.阻止依赖注入埋点</h3><ul><li>过滤的接口类型是：InstantiationAwareBeanPostProcessor</li><li>调用的方法是：postProcessAfterInstantiation</li></ul><figure class="highlight java"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-s5s9j1lhkez7dw"></i><span>java</span><div class="collapse show" id="collapse-s5s9j1lhkez7dw"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//AbstractAutowireCapableBeanFactory</span><br><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">populateBean</span><span class="hljs-params">(String beanName, RootBeanDefinition mbd, <span class="hljs-meta">@Nullable</span> BeanWrapper bw)</span> &#123;<br><span class="hljs-comment">//......省略部分代码</span><br><span class="hljs-comment">//这里很有意思，写接口可以让所有类都不能依赖注入</span><br><span class="hljs-keyword">if</span> (!mbd.isSynthetic() &amp;&amp; hasInstantiationAwareBeanPostProcessors()) &#123;<br><span class="hljs-keyword">for</span> (BeanPostProcessor bp : getBeanPostProcessors()) &#123;<br><span class="hljs-keyword">if</span> (bp <span class="hljs-keyword">instanceof</span> InstantiationAwareBeanPostProcessor) &#123;<br><span class="hljs-type">InstantiationAwareBeanPostProcessor</span> <span class="hljs-variable">ibp</span> <span class="hljs-operator">=</span> (InstantiationAwareBeanPostProcessor) bp;<br><span class="hljs-keyword">if</span> (!ibp.postProcessAfterInstantiation(bw.getWrappedInstance(), beanName)) &#123;<br><span class="hljs-keyword">return</span>;<br>&#125;<br>&#125;<br>&#125;<br>&#125;<br><span class="hljs-comment">//......省略部分代码</span><br>&#125;<br></code></pre></td></tr></table></div></figure><h3 id="1-5-IOC-x2F-DI-依赖注入埋点"><a href="#1-5-IOC-x2F-DI-依赖注入埋点" class="headerlink" title="1.5.IOC&#x2F;DI 依赖注入埋点"></a>1.5.IOC&#x2F;DI 依赖注入埋点</h3><ul><li>过滤的接口类型是：InstantiationAwareBeanPostProcessor</li><li>调用的方法是：postProcessProperties(新版本)</li></ul><figure class="highlight java"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-raeaqulhkez7dw"></i><span>java</span><div class="collapse show" id="collapse-raeaqulhkez7dw"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//AbstractAutowireCapableBeanFactory</span><br><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">populateBean</span><span class="hljs-params">(String beanName, RootBeanDefinition mbd, <span class="hljs-meta">@Nullable</span> BeanWrapper bw)</span> &#123;<br><span class="hljs-comment">//......省略部分代码</span><br><span class="hljs-comment">//重点看这个if代码块，重要程度 5</span><br><span class="hljs-keyword">if</span> (hasInstAwareBpps) &#123;<br><span class="hljs-keyword">if</span> (pvs == <span class="hljs-literal">null</span>) &#123;<br>pvs = mbd.getPropertyValues();<br>&#125;<br><span class="hljs-keyword">for</span> (BeanPostProcessor bp : getBeanPostProcessors()) &#123;<br><span class="hljs-keyword">if</span> (bp <span class="hljs-keyword">instanceof</span> InstantiationAwareBeanPostProcessor) &#123;<br><span class="hljs-type">InstantiationAwareBeanPostProcessor</span> <span class="hljs-variable">ibp</span> <span class="hljs-operator">=</span> (InstantiationAwareBeanPostProcessor) bp;<br><span class="hljs-comment">//依赖注入过程，@Resource @Autowired的支持</span><br><span class="hljs-type">PropertyValues</span> <span class="hljs-variable">pvsToUse</span> <span class="hljs-operator">=</span> ibp.postProcessProperties(pvs, bw.getWrappedInstance(), beanName);<br><span class="hljs-keyword">if</span> (pvsToUse == <span class="hljs-literal">null</span>) &#123;<br><span class="hljs-keyword">if</span> (filteredPds == <span class="hljs-literal">null</span>) &#123;<br>filteredPds = filterPropertyDescriptorsForDependencyCheck(bw, mbd.allowCaching);<br>&#125;<br><span class="hljs-comment">//老版本用这个完成依赖注入过程，@Autowired的支持</span><br>pvsToUse = ibp.postProcessPropertyValues(pvs, filteredPds, bw.getWrappedInstance(), beanName);<br><span class="hljs-keyword">if</span> (pvsToUse == <span class="hljs-literal">null</span>) &#123;<br><span class="hljs-keyword">return</span>;<br>&#125;<br>&#125;<br>pvs = pvsToUse;<br>&#125;<br>&#125;<br>&#125;<br><span class="hljs-comment">//......省略部分代码</span><br>&#125;<br></code></pre></td></tr></table></div></figure>]]></content>
    
    
    <categories>
      
      <category>Spring源码学习</category>
      
    </categories>
    
    
    <tags>
      
      <tag>源码</tag>
      
      <tag>Spring</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>【Spring源码学习】Spring Bean的销毁</title>
    <link href="/posts/376761911.html"/>
    <url>/posts/376761911.html</url>
    
    <content type="html"><![CDATA[<p>上一章节中，我们跟完了bean的创建流程，而在创建完成以后，bean还会注册销毁相关的类，以便于像tomcat等容器关闭时相关的调用，本章我就聊这个。</p><h1 id="一、注册bean销毁的类"><a href="#一、注册bean销毁的类" class="headerlink" title="一、注册bean销毁的类"></a>一、注册bean销毁的类</h1><p>先定位到类AbstractAutowireCapableBeanFactory的doCreateBean()方法</p><figure class="highlight java"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-7r7x7olhkez7dx"></i><span>java</span><div class="collapse show" id="collapse-7r7x7olhkez7dx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// Register bean as disposable.</span><br><span class="hljs-keyword">try</span> &#123;<br><span class="hljs-comment">//注册bean销毁时的类DisposableBeanAdapter</span><br>registerDisposableBeanIfNecessary(beanName, bean, mbd);<br>&#125;<br><span class="hljs-keyword">catch</span> (BeanDefinitionValidationException ex) &#123;<br><span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BeanCreationException</span>(<br>mbd.getResourceDescription(), beanName, <span class="hljs-string">&quot;Invalid destruction signature&quot;</span>, ex);<br>&#125;<br></code></pre></td></tr></table></div></figure><h2 id="1-registerDisposableBeanIfNecessary"><a href="#1-registerDisposableBeanIfNecessary" class="headerlink" title="1.registerDisposableBeanIfNecessary()"></a>1.registerDisposableBeanIfNecessary()</h2><figure class="highlight java"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-3e3sdjlhkez7dx"></i><span>java</span><div class="collapse show" id="collapse-3e3sdjlhkez7dx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">registerDisposableBeanIfNecessary</span><span class="hljs-params">(String beanName, Object bean, RootBeanDefinition mbd)</span> &#123;<br><span class="hljs-type">AccessControlContext</span> <span class="hljs-variable">acc</span> <span class="hljs-operator">=</span> (System.getSecurityManager() != <span class="hljs-literal">null</span> ? getAccessControlContext() : <span class="hljs-literal">null</span>);<br><span class="hljs-comment">//非多例作用域并且要么有配置destroy-method或者要么有可用的DestructionAwareBeanPostProcessors后置处理器才会注册</span><br><span class="hljs-keyword">if</span> (!mbd.isPrototype() &amp;&amp; requiresDestruction(bean, mbd)) &#123;<br><span class="hljs-keyword">if</span> (mbd.isSingleton()) &#123;<br><span class="hljs-comment">// Register a DisposableBean implementation that performs all destruction</span><br><span class="hljs-comment">// work for the given bean: DestructionAwareBeanPostProcessors,</span><br><span class="hljs-comment">// DisposableBean interface, custom destroy method.</span><br><span class="hljs-comment">//DisposableBeanAdapter 对象就是负责bean 销毁的类。</span><br><span class="hljs-comment">// 这个类中收集bean 是否实现了DisposableBean 接口</span><br>registerDisposableBean(beanName,<br><span class="hljs-keyword">new</span> <span class="hljs-title class_">DisposableBeanAdapter</span>(bean, beanName, mbd, getBeanPostProcessors(), acc));<br>&#125;<br><span class="hljs-keyword">else</span> &#123;<br><span class="hljs-comment">// A bean with a custom scope...</span><br><span class="hljs-type">Scope</span> <span class="hljs-variable">scope</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.scopes.get(mbd.getScope());<br><span class="hljs-keyword">if</span> (scope == <span class="hljs-literal">null</span>) &#123;<br><span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalStateException</span>(<span class="hljs-string">&quot;No Scope registered for scope name &#x27;&quot;</span> + mbd.getScope() + <span class="hljs-string">&quot;&#x27;&quot;</span>);<br>&#125;<br>scope.registerDestructionCallback(beanName,<br><span class="hljs-keyword">new</span> <span class="hljs-title class_">DisposableBeanAdapter</span>(bean, beanName, mbd, getBeanPostProcessors(), acc));<br>&#125;<br>&#125;<br>&#125;<br></code></pre></td></tr></table></div></figure><h2 id="2-DisposableBeanAdapter"><a href="#2-DisposableBeanAdapter" class="headerlink" title="2.DisposableBeanAdapter"></a>2.DisposableBeanAdapter</h2><p>该类就是负责销毁bean的类，看下它的构造方法</p><figure class="highlight java"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-ayx95alhkez7dx"></i><span>java</span><div class="collapse show" id="collapse-ayx95alhkez7dx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-title function_">DisposableBeanAdapter</span><span class="hljs-params">(Object bean, String beanName, RootBeanDefinition beanDefinition,</span><br><span class="hljs-params">List&lt;BeanPostProcessor&gt; postProcessors, <span class="hljs-meta">@Nullable</span> AccessControlContext acc)</span> &#123;<br>Assert.notNull(bean, <span class="hljs-string">&quot;Disposable bean must not be null&quot;</span>);<br><span class="hljs-built_in">this</span>.bean = bean;<br><span class="hljs-built_in">this</span>.beanName = beanName;<br><span class="hljs-built_in">this</span>.invokeDisposableBean =<br>(<span class="hljs-built_in">this</span>.bean <span class="hljs-keyword">instanceof</span> DisposableBean &amp;&amp; !beanDefinition.isExternallyManagedDestroyMethod(<span class="hljs-string">&quot;destroy&quot;</span>));<br><span class="hljs-built_in">this</span>.nonPublicAccessAllowed = beanDefinition.isNonPublicAccessAllowed();<br><span class="hljs-built_in">this</span>.acc = acc;<br><span class="hljs-type">String</span> <span class="hljs-variable">destroyMethodName</span> <span class="hljs-operator">=</span> inferDestroyMethodIfNecessary(bean, beanDefinition);<br><span class="hljs-keyword">if</span> (destroyMethodName != <span class="hljs-literal">null</span> &amp;&amp; !(<span class="hljs-built_in">this</span>.invokeDisposableBean &amp;&amp; <span class="hljs-string">&quot;destroy&quot;</span>.equals(destroyMethodName)) &amp;&amp;<br>!beanDefinition.isExternallyManagedDestroyMethod(destroyMethodName)) &#123;<br><span class="hljs-built_in">this</span>.destroyMethodName = destroyMethodName;<br><span class="hljs-type">Method</span> <span class="hljs-variable">destroyMethod</span> <span class="hljs-operator">=</span> determineDestroyMethod(destroyMethodName);<br><span class="hljs-keyword">if</span> (destroyMethod == <span class="hljs-literal">null</span>) &#123;<br><span class="hljs-keyword">if</span> (beanDefinition.isEnforceDestroyMethod()) &#123;<br><span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BeanDefinitionValidationException</span>(<span class="hljs-string">&quot;Could not find a destroy method named &#x27;&quot;</span> +<br>destroyMethodName + <span class="hljs-string">&quot;&#x27; on bean with name &#x27;&quot;</span> + beanName + <span class="hljs-string">&quot;&#x27;&quot;</span>);<br>&#125;<br>&#125;<br><span class="hljs-keyword">else</span> &#123;<br>Class&lt;?&gt;[] paramTypes = destroyMethod.getParameterTypes();<br><span class="hljs-keyword">if</span> (paramTypes.length &gt; <span class="hljs-number">1</span>) &#123;<br><span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BeanDefinitionValidationException</span>(<span class="hljs-string">&quot;Method &#x27;&quot;</span> + destroyMethodName + <span class="hljs-string">&quot;&#x27; of bean &#x27;&quot;</span> +<br>beanName + <span class="hljs-string">&quot;&#x27; has more than one parameter - not supported as destroy method&quot;</span>);<br>&#125;<br><span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (paramTypes.length == <span class="hljs-number">1</span> &amp;&amp; <span class="hljs-type">boolean</span>.class != paramTypes[<span class="hljs-number">0</span>]) &#123;<br><span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BeanDefinitionValidationException</span>(<span class="hljs-string">&quot;Method &#x27;&quot;</span> + destroyMethodName + <span class="hljs-string">&quot;&#x27; of bean &#x27;&quot;</span> +<br>beanName + <span class="hljs-string">&quot;&#x27; has a non-boolean parameter - not supported as destroy method&quot;</span>);<br>&#125;<br>destroyMethod = ClassUtils.getInterfaceMethodIfPossible(destroyMethod);<br>&#125;<br><span class="hljs-built_in">this</span>.destroyMethod = destroyMethod;<br>&#125;<br><span class="hljs-comment">//过滤了DestructionAwareBeanPostProcessor 类型的接口</span><br><span class="hljs-built_in">this</span>.beanPostProcessors = filterPostProcessors(postProcessors, bean);<br>&#125;<br></code></pre></td></tr></table></div></figure><p>最主要干的事儿就是最后一步，收集DestructionAwareBeanPostProcessor 类型，放入列表当中</p><figure class="highlight java"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-sjrd11lhkez7dx"></i><span>java</span><div class="collapse show" id="collapse-sjrd11lhkez7dx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> List&lt;DestructionAwareBeanPostProcessor&gt; <span class="hljs-title function_">filterPostProcessors</span><span class="hljs-params">(List&lt;BeanPostProcessor&gt; processors, Object bean)</span> &#123;<br>List&lt;DestructionAwareBeanPostProcessor&gt; filteredPostProcessors = <span class="hljs-literal">null</span>;<br><span class="hljs-keyword">if</span> (!CollectionUtils.isEmpty(processors)) &#123;<br>filteredPostProcessors = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;(processors.size());<br><span class="hljs-keyword">for</span> (BeanPostProcessor processor : processors) &#123;<br><span class="hljs-comment">//过滤了DestructionAwareBeanPostProcessor 类型的接口</span><br><span class="hljs-keyword">if</span> (processor <span class="hljs-keyword">instanceof</span> DestructionAwareBeanPostProcessor) &#123;<br><span class="hljs-type">DestructionAwareBeanPostProcessor</span> <span class="hljs-variable">dabpp</span> <span class="hljs-operator">=</span> (DestructionAwareBeanPostProcessor) processor;<br><span class="hljs-keyword">if</span> (dabpp.requiresDestruction(bean)) &#123;<br>filteredPostProcessors.add(dabpp);<br>&#125;<br>&#125;<br>&#125;<br>&#125;<br><span class="hljs-keyword">return</span> filteredPostProcessors;<br>&#125;<br></code></pre></td></tr></table></div></figure><h1 id="二、调用过程"><a href="#二、调用过程" class="headerlink" title="二、调用过程"></a>二、调用过程</h1><p>目前主流服务端运行的java程序均为Servlet，并且通常都是在tomcat中，那bean的销毁通常与tomcat的关闭有关。我们知道servlet的生命周期有三大步骤：</p><ul><li>init(): 初始化阶段</li><li>service(): 处理客户端请求阶段</li><li>destroy(): 终止阶段</li></ul><p>destroy()阶段，相关监听监测到销毁事件，然后发起析构。定位到ContextLoaderListener类中的contextDestroyed()方法，看看是怎么一个过程。</p><h2 id="1-contextDestroyed"><a href="#1-contextDestroyed" class="headerlink" title="1.contextDestroyed()"></a>1.contextDestroyed()</h2><figure class="highlight java"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-d257sllhkez7dx"></i><span>java</span><div class="collapse show" id="collapse-d257sllhkez7dx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">contextDestroyed</span><span class="hljs-params">(ServletContextEvent event)</span> &#123;<br><span class="hljs-comment">//开始准备关闭WebApplicationContext</span><br>closeWebApplicationContext(event.getServletContext());<br>ContextCleanupListener.cleanupAttributes(event.getServletContext());<br>&#125;<br></code></pre></td></tr></table></div></figure><h2 id="2-closeWebApplicationContext"><a href="#2-closeWebApplicationContext" class="headerlink" title="2.closeWebApplicationContext()"></a>2.closeWebApplicationContext()</h2><figure class="highlight java"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-inb6w0lhkez7dx"></i><span>java</span><div class="collapse show" id="collapse-inb6w0lhkez7dx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//ContextLoader</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">closeWebApplicationContext</span><span class="hljs-params">(ServletContext servletContext)</span> &#123;<br>servletContext.log(<span class="hljs-string">&quot;Closing Spring root WebApplicationContext&quot;</span>);<br><span class="hljs-keyword">try</span> &#123;<br><span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.context <span class="hljs-keyword">instanceof</span> ConfigurableWebApplicationContext) &#123;<br><span class="hljs-comment">//开始准备关闭WebApplicationContext</span><br>((ConfigurableWebApplicationContext) <span class="hljs-built_in">this</span>.context).close();<br>&#125;<br>&#125;<br><span class="hljs-keyword">finally</span> &#123;<br><span class="hljs-type">ClassLoader</span> <span class="hljs-variable">ccl</span> <span class="hljs-operator">=</span> Thread.currentThread().getContextClassLoader();<br><span class="hljs-keyword">if</span> (ccl == ContextLoader.class.getClassLoader()) &#123;<br>currentContext = <span class="hljs-literal">null</span>;<br>&#125;<br><span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (ccl != <span class="hljs-literal">null</span>) &#123;<br>currentContextPerThread.remove(ccl);<br>&#125;<br>servletContext.removeAttribute(WebApplicationContext.ROOT_WEB_APPLICATION_CONTEXT_ATTRIBUTE);<br>&#125;<br>&#125;<br></code></pre></td></tr></table></div></figure><p>点进去看看close()方法，调用的是AbstractApplicationContext的close()方法。</p><h2 id="3-close-doClose"><a href="#3-close-doClose" class="headerlink" title="3.close(), doClose()"></a>3.close(), doClose()</h2><figure class="highlight java"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-jyn6q9lhkez7dx"></i><span>java</span><div class="collapse show" id="collapse-jyn6q9lhkez7dx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">close</span><span class="hljs-params">()</span> &#123;<br><span class="hljs-keyword">synchronized</span> (<span class="hljs-built_in">this</span>.startupShutdownMonitor) &#123;<br>doClose();<br><span class="hljs-comment">// If we registered a JVM shutdown hook, we don&#x27;t need it anymore now:</span><br><span class="hljs-comment">// We&#x27;ve already explicitly closed the context.</span><br><span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.shutdownHook != <span class="hljs-literal">null</span>) &#123;<br><span class="hljs-keyword">try</span> &#123;<br>Runtime.getRuntime().removeShutdownHook(<span class="hljs-built_in">this</span>.shutdownHook);<br>&#125;<br><span class="hljs-keyword">catch</span> (IllegalStateException ex) &#123;<br><span class="hljs-comment">// ignore - VM is already shutting down</span><br>&#125;<br>&#125;<br>&#125;<br>&#125;<br><br><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doClose</span><span class="hljs-params">()</span> &#123;<br><span class="hljs-comment">// Check whether an actual close attempt is necessary...</span><br><span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.active.get() &amp;&amp; <span class="hljs-built_in">this</span>.closed.compareAndSet(<span class="hljs-literal">false</span>, <span class="hljs-literal">true</span>)) &#123;<br><span class="hljs-keyword">if</span> (logger.isDebugEnabled()) &#123;<br>logger.debug(<span class="hljs-string">&quot;Closing &quot;</span> + <span class="hljs-built_in">this</span>);<br>&#125;<br><br>LiveBeansView.unregisterApplicationContext(<span class="hljs-built_in">this</span>);<br><br><span class="hljs-keyword">try</span> &#123;<br><span class="hljs-comment">// Publish shutdown event.</span><br>publishEvent(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ContextClosedEvent</span>(<span class="hljs-built_in">this</span>));<br>&#125;<br><span class="hljs-keyword">catch</span> (Throwable ex) &#123;<br>logger.warn(<span class="hljs-string">&quot;Exception thrown from ApplicationListener handling ContextClosedEvent&quot;</span>, ex);<br>&#125;<br><br><span class="hljs-comment">// Stop all Lifecycle beans, to avoid delays during individual destruction.</span><br><span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.lifecycleProcessor != <span class="hljs-literal">null</span>) &#123;<br><span class="hljs-keyword">try</span> &#123;<br><span class="hljs-built_in">this</span>.lifecycleProcessor.onClose();<br>&#125;<br><span class="hljs-keyword">catch</span> (Throwable ex) &#123;<br>logger.warn(<span class="hljs-string">&quot;Exception thrown from LifecycleProcessor on context close&quot;</span>, ex);<br>&#125;<br>&#125;<br><br><span class="hljs-comment">// Destroy all cached singletons in the context&#x27;s BeanFactory.</span><br><span class="hljs-comment">//开始发起调用销毁流程了</span><br>destroyBeans();<br><br><span class="hljs-comment">// Close the state of this context itself.</span><br>closeBeanFactory();<br><br><span class="hljs-comment">// Let subclasses do some final clean-up if they wish...</span><br>onClose();<br><br><span class="hljs-comment">// Reset local application listeners to pre-refresh state.</span><br><span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.earlyApplicationListeners != <span class="hljs-literal">null</span>) &#123;<br><span class="hljs-built_in">this</span>.applicationListeners.clear();<br><span class="hljs-built_in">this</span>.applicationListeners.addAll(<span class="hljs-built_in">this</span>.earlyApplicationListeners);<br>&#125;<br><br><span class="hljs-comment">// Switch to inactive.</span><br><span class="hljs-built_in">this</span>.active.set(<span class="hljs-literal">false</span>);<br>&#125;<br>&#125;<br><br><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">destroyBeans</span><span class="hljs-params">()</span> &#123;<br>getBeanFactory().destroySingletons();<br>&#125;<br></code></pre></td></tr></table></div></figure><p>而destroySingletons()实现类为DefaultSingletonBeanRegistry，点进去看看</p><h2 id="4-destroySingletons"><a href="#4-destroySingletons" class="headerlink" title="4.destroySingletons()"></a>4.destroySingletons()</h2><figure class="highlight java"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-4pdeeolhkez7dx"></i><span>java</span><div class="collapse show" id="collapse-4pdeeolhkez7dx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">destroySingletons</span><span class="hljs-params">()</span> &#123;<br><span class="hljs-keyword">if</span> (logger.isTraceEnabled()) &#123;<br>logger.trace(<span class="hljs-string">&quot;Destroying singletons in &quot;</span> + <span class="hljs-built_in">this</span>);<br>&#125;<br><span class="hljs-keyword">synchronized</span> (<span class="hljs-built_in">this</span>.singletonObjects) &#123;<br><span class="hljs-built_in">this</span>.singletonsCurrentlyInDestruction = <span class="hljs-literal">true</span>;<br>&#125;<br><br>String[] disposableBeanNames;<br><span class="hljs-keyword">synchronized</span> (<span class="hljs-built_in">this</span>.disposableBeans) &#123;<br>disposableBeanNames = StringUtils.toStringArray(<span class="hljs-built_in">this</span>.disposableBeans.keySet());<br>&#125;<br><span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> disposableBeanNames.length - <span class="hljs-number">1</span>; i &gt;= <span class="hljs-number">0</span>; i--) &#123;<br><span class="hljs-comment">//就是这里了</span><br>destroySingleton(disposableBeanNames[i]);<br>&#125;<br><br><span class="hljs-built_in">this</span>.containedBeanMap.clear();<br><span class="hljs-built_in">this</span>.dependentBeanMap.clear();<br><span class="hljs-built_in">this</span>.dependenciesForBeanMap.clear();<br><br>clearSingletonCache();<br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">destroySingleton</span><span class="hljs-params">(String beanName)</span> &#123;<br><span class="hljs-comment">// Remove a registered singleton of the given name, if any.</span><br>removeSingleton(beanName);<br><br><span class="hljs-comment">// Destroy the corresponding DisposableBean instance.</span><br>DisposableBean disposableBean;<br><span class="hljs-keyword">synchronized</span> (<span class="hljs-built_in">this</span>.disposableBeans) &#123;<br>disposableBean = (DisposableBean) <span class="hljs-built_in">this</span>.disposableBeans.remove(beanName);<br>&#125;<br>destroyBean(beanName, disposableBean);<br>&#125;<br><br></code></pre></td></tr></table></div></figure><h2 id="5-destroyBean"><a href="#5-destroyBean" class="headerlink" title="5.destroyBean()"></a>5.destroyBean()</h2><figure class="highlight java"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-wlp3a9lhkez7dx"></i><span>java</span><div class="collapse show" id="collapse-wlp3a9lhkez7dx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">destroyBean</span><span class="hljs-params">(String beanName, <span class="hljs-meta">@Nullable</span> DisposableBean bean)</span> &#123;<br><span class="hljs-comment">// Trigger destruction of dependent beans first...</span><br>Set&lt;String&gt; dependencies;<br><span class="hljs-keyword">synchronized</span> (<span class="hljs-built_in">this</span>.dependentBeanMap) &#123;<br><span class="hljs-comment">// Within full synchronization in order to guarantee a disconnected Set</span><br>dependencies = <span class="hljs-built_in">this</span>.dependentBeanMap.remove(beanName);<br>&#125;<br><span class="hljs-keyword">if</span> (dependencies != <span class="hljs-literal">null</span>) &#123;<br><span class="hljs-keyword">if</span> (logger.isTraceEnabled()) &#123;<br>logger.trace(<span class="hljs-string">&quot;Retrieved dependent beans for bean &#x27;&quot;</span> + beanName + <span class="hljs-string">&quot;&#x27;: &quot;</span> + dependencies);<br>&#125;<br><span class="hljs-keyword">for</span> (String dependentBeanName : dependencies) &#123;<br>destroySingleton(dependentBeanName);<br>&#125;<br>&#125;<br><br><span class="hljs-comment">// Actually destroy the bean now...</span><br><span class="hljs-keyword">if</span> (bean != <span class="hljs-literal">null</span>) &#123;<br><span class="hljs-keyword">try</span> &#123;<br><span class="hljs-comment">//真正销毁的地方，会调用到DisposableBeanAdapter中的destroy()方法</span><br>bean.destroy();<br>&#125;<br><span class="hljs-keyword">catch</span> (Throwable ex) &#123;<br><span class="hljs-keyword">if</span> (logger.isWarnEnabled()) &#123;<br>logger.warn(<span class="hljs-string">&quot;Destruction of bean with name &#x27;&quot;</span> + beanName + <span class="hljs-string">&quot;&#x27; threw an exception&quot;</span>, ex);<br>&#125;<br>&#125;<br>&#125;<br><br><span class="hljs-comment">// Trigger destruction of contained beans...</span><br>Set&lt;String&gt; containedBeans;<br><span class="hljs-keyword">synchronized</span> (<span class="hljs-built_in">this</span>.containedBeanMap) &#123;<br><span class="hljs-comment">// Within full synchronization in order to guarantee a disconnected Set</span><br>containedBeans = <span class="hljs-built_in">this</span>.containedBeanMap.remove(beanName);<br>&#125;<br><span class="hljs-keyword">if</span> (containedBeans != <span class="hljs-literal">null</span>) &#123;<br><span class="hljs-keyword">for</span> (String containedBeanName : containedBeans) &#123;<br>destroySingleton(containedBeanName);<br>&#125;<br>&#125;<br><br><span class="hljs-comment">// Remove destroyed bean from other beans&#x27; dependencies.</span><br><span class="hljs-keyword">synchronized</span> (<span class="hljs-built_in">this</span>.dependentBeanMap) &#123;<br><span class="hljs-keyword">for</span> (Iterator&lt;Map.Entry&lt;String, Set&lt;String&gt;&gt;&gt; it = <span class="hljs-built_in">this</span>.dependentBeanMap.entrySet().iterator(); it.hasNext();) &#123;<br>Map.Entry&lt;String, Set&lt;String&gt;&gt; entry = it.next();<br>Set&lt;String&gt; dependenciesToClean = entry.getValue();<br>dependenciesToClean.remove(beanName);<br><span class="hljs-keyword">if</span> (dependenciesToClean.isEmpty()) &#123;<br>it.remove();<br>&#125;<br>&#125;<br>&#125;<br><br><span class="hljs-comment">// Remove destroyed bean&#x27;s prepared dependency information.</span><br><span class="hljs-built_in">this</span>.dependenciesForBeanMap.remove(beanName);<br>&#125;<br></code></pre></td></tr></table></div></figure><h2 id="6-destroy"><a href="#6-destroy" class="headerlink" title="6.destroy()"></a>6.destroy()</h2><figure class="highlight java"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-qzip6xlhkez7dx"></i><span>java</span><div class="collapse show" id="collapse-qzip6xlhkez7dx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">destroy</span><span class="hljs-params">()</span> &#123;<br><span class="hljs-keyword">if</span> (!CollectionUtils.isEmpty(<span class="hljs-built_in">this</span>.beanPostProcessors)) &#123;<br><span class="hljs-keyword">for</span> (DestructionAwareBeanPostProcessor processor : <span class="hljs-built_in">this</span>.beanPostProcessors) &#123;<br>processor.postProcessBeforeDestruction(<span class="hljs-built_in">this</span>.bean, <span class="hljs-built_in">this</span>.beanName);<br>&#125;<br>&#125;<br><br><span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.invokeDisposableBean) &#123;<br><span class="hljs-keyword">if</span> (logger.isTraceEnabled()) &#123;<br>logger.trace(<span class="hljs-string">&quot;Invoking destroy() on bean with name &#x27;&quot;</span> + <span class="hljs-built_in">this</span>.beanName + <span class="hljs-string">&quot;&#x27;&quot;</span>);<br>&#125;<br><span class="hljs-keyword">try</span> &#123;<br><span class="hljs-keyword">if</span> (System.getSecurityManager() != <span class="hljs-literal">null</span>) &#123;<br>AccessController.doPrivileged((PrivilegedExceptionAction&lt;Object&gt;) () -&gt; &#123;<br>((DisposableBean) <span class="hljs-built_in">this</span>.bean).destroy();<br><span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>&#125;, <span class="hljs-built_in">this</span>.acc);<br>&#125;<br><span class="hljs-keyword">else</span> &#123;<br><span class="hljs-comment">//开始销毁了</span><br>((DisposableBean) <span class="hljs-built_in">this</span>.bean).destroy();<br>&#125;<br>&#125;<br><span class="hljs-keyword">catch</span> (Throwable ex) &#123;<br><span class="hljs-type">String</span> <span class="hljs-variable">msg</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;Invocation of destroy method failed on bean with name &#x27;&quot;</span> + <span class="hljs-built_in">this</span>.beanName + <span class="hljs-string">&quot;&#x27;&quot;</span>;<br><span class="hljs-keyword">if</span> (logger.isDebugEnabled()) &#123;<br>logger.warn(msg, ex);<br>&#125;<br><span class="hljs-keyword">else</span> &#123;<br>logger.warn(msg + <span class="hljs-string">&quot;: &quot;</span> + ex);<br>&#125;<br>&#125;<br>&#125;<br><br><span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.destroyMethod != <span class="hljs-literal">null</span>) &#123;<br>invokeCustomDestroyMethod(<span class="hljs-built_in">this</span>.destroyMethod);<br>&#125;<br><span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.destroyMethodName != <span class="hljs-literal">null</span>) &#123;<br><span class="hljs-type">Method</span> <span class="hljs-variable">methodToInvoke</span> <span class="hljs-operator">=</span> determineDestroyMethod(<span class="hljs-built_in">this</span>.destroyMethodName);<br><span class="hljs-keyword">if</span> (methodToInvoke != <span class="hljs-literal">null</span>) &#123;<br>invokeCustomDestroyMethod(ClassUtils.getInterfaceMethodIfPossible(methodToInvoke));<br>&#125;<br>&#125;<br>&#125;<br></code></pre></td></tr></table></div></figure>]]></content>
    
    
    <categories>
      
      <category>Spring源码学习</category>
      
    </categories>
    
    
    <tags>
      
      <tag>源码</tag>
      
      <tag>Spring</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>【Spring源码学习】Spring Bean实例化-循环依赖</title>
    <link href="/posts/3983253573.html"/>
    <url>/posts/3983253573.html</url>
    
    <content type="html"><![CDATA[<h1 id="一、什么是循环依赖"><a href="#一、什么是循环依赖" class="headerlink" title="一、什么是循环依赖"></a>一、什么是循环依赖</h1><p>如果类A存在属性类B，而类B也有属性类A，那么当进行属性的依赖注入时，就会出现A还未完成创建，又由于在创建B的过程中又发生创建A的过程，造成了死循环，最终导致<strong>循环依赖</strong>。类似代码如下：</p><figure class="highlight java"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-v2qmu9lhkez7dx"></i><span>java</span><div class="collapse show" id="collapse-v2qmu9lhkez7dx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">A</span> &#123;<br>    <span class="hljs-keyword">private</span> B b;<br>&#125;<br> <br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">B</span> &#123;<br>    <span class="hljs-keyword">private</span> A a;<br>&#125;<br></code></pre></td></tr></table></div></figure><p><strong>循环依赖只会出现在单例实例无参构造函数实例化情况下</strong>。有参构造函数的加@Autowired 的方式循环依赖是直接报错的，多例的循环依赖也是直接报错的。接下来我会通过源代码一一说明。</p><h1 id="二、循环依赖的步骤"><a href="#二、循环依赖的步骤" class="headerlink" title="二、循环依赖的步骤"></a>二、循环依赖的步骤</h1><p>前面几章中，我重点跟了Spring Bean的实例化源码过程，总结一下就是：</p><ul><li><a href="https://zyxelva.github.io/2023/05/01/%E3%80%90Spring%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0%E3%80%91Spring-Bean%E5%AE%9E%E4%BE%8B%E5%8C%96%E8%BF%87%E7%A8%8B-%E5%88%9B%E5%BB%BABean%E5%AE%9E%E4%BE%8B/">创建Bean实例</a></li><li><a href="https://zyxelva.github.io/2023/05/01/%E3%80%90Spring%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0%E3%80%91Spring-Bean%E5%AE%9E%E4%BE%8B%E5%8C%96%E8%BF%87%E7%A8%8B-%E4%BE%9D%E8%B5%96%E5%B1%9E%E6%80%A7%E6%B3%A8%E5%85%A5/">依赖属性注入</a></li><li><a href="https://zyxelva.github.io/2023/05/01/%E3%80%90Spring%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0%E3%80%91Spring-Bean%E5%AE%9E%E4%BE%8B%E5%8C%96%E8%BF%87%E7%A8%8B-%E5%88%9D%E5%A7%8B%E5%8C%96/">初始化</a></li></ul><p>循环依赖步骤：</p><ul><li>A 类无参构造函数实例化后，设置三级缓存</li><li>A 类populateBean 进行依赖注入，这里触发了B 类属性的getBean 操作</li><li>B 类无参构造函数实例化后，设置三级缓存</li><li>B 类populateBean 进行依赖注入，这里触发了A 类属性的getBean 操作</li><li>A 类之前正在实例化，singletonsCurrentlyInCreation 集合中有已经有这个A 类了，三级缓存里面也有了，所以这时候是从三级缓存中拿到的提前暴露的A 实例，该实例还没有进行B 类属性的依赖注入的，B 类属性为空，具体通过  <figure class="highlight java"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-18y3yvlhkez7dx"></i><span>java</span><div class="collapse show" id="collapse-18y3yvlhkez7dx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">Object</span> <span class="hljs-variable">sharedInstance</span> <span class="hljs-operator">=</span> getSingleton(beanName);<br></code></pre></td></tr></table></div></figure>这个方法(先从一级缓存中拿，再从二级缓存中拿，如果还拿不到，并且允许bean提前暴露则从三级缓存中拿到对象工厂，从工厂中拿到对象成功后，升级到二级缓存，并删除三级缓存。再有别的类引用的话，就从二级缓存中进行取)</li><li>B 类拿到了A 的提前暴露实例注入到A 类属性中了</li><li>B 类实例化已经完成，B 类的实例化是由A 类实例化中B 属性的依赖注入触发的getBean 操作进行的，现在B已经实例化，所以A 类中B 属性就可以完成依赖注入了，这时候A 类B 属性已经有值了。</li><li>B 类A 属性指向的就是A 类实例堆空间，所以这时候B 类A 属性也会有值了。</li></ul><h1 id="三、为什么有参构造函数的加-Autowired-的方式循环依赖是直接报错的？"><a href="#三、为什么有参构造函数的加-Autowired-的方式循环依赖是直接报错的？" class="headerlink" title="三、为什么有参构造函数的加@Autowired 的方式循环依赖是直接报错的？"></a>三、为什么有参构造函数的加@Autowired 的方式循环依赖是直接报错的？</h1><p>首先说明一点，构造方法的执行顺序是在依赖注入属性之前的。</p><ol><li><p>创建bean 的实例是在方法createBeanInstance(beanName, mbd, args)中通过无参或注解@Autowired 有参构造函数实例化进行的。</p><figure class="highlight java"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-gxkya8lhkez7dx"></i><span>java</span><div class="collapse show" id="collapse-gxkya8lhkez7dx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//AbstractAutowireCapableBeanFactory</span><br><span class="hljs-keyword">protected</span> Object <span class="hljs-title function_">doCreateBean</span><span class="hljs-params">(String beanName, RootBeanDefinition mbd, <span class="hljs-meta">@Nullable</span> Object[] args)</span><br><span class="hljs-keyword">throws</span> BeanCreationException &#123;<br><span class="hljs-comment">// Instantiate the bean.</span><br><span class="hljs-type">BeanWrapper</span> <span class="hljs-variable">instanceWrapper</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br><span class="hljs-keyword">if</span> (mbd.isSingleton()) &#123;<br>instanceWrapper = <span class="hljs-built_in">this</span>.factoryBeanInstanceCache.remove(beanName);<br>&#125;<br><span class="hljs-keyword">if</span> (instanceWrapper == <span class="hljs-literal">null</span>) &#123;<br><span class="hljs-comment">//创建实例,,重点看，重要程度：5</span><br>instanceWrapper = createBeanInstance(beanName, mbd, args);<br>&#125;<br><span class="hljs-type">Object</span> <span class="hljs-variable">bean</span> <span class="hljs-operator">=</span> instanceWrapper.getWrappedInstance();<br>Class&lt;?&gt; beanType = instanceWrapper.getWrappedClass();<br><span class="hljs-keyword">if</span> (beanType != NullBean.class) &#123;<br>mbd.resolvedTargetType = beanType;<br>&#125;<br><br><span class="hljs-comment">// Allow post-processors to modify the merged bean definition.</span><br><br><span class="hljs-comment">//......省略部分代码</span><br><br><span class="hljs-comment">// Eagerly cache singletons to be able to resolve circular references</span><br><span class="hljs-comment">// even when triggered by lifecycle interfaces like BeanFactoryAware.</span><br><span class="hljs-comment">//是否单例bean提前暴露</span><br><span class="hljs-type">boolean</span> <span class="hljs-variable">earlySingletonExposure</span> <span class="hljs-operator">=</span> (mbd.isSingleton() &amp;&amp; <span class="hljs-built_in">this</span>.allowCircularReferences &amp;&amp;<br>isSingletonCurrentlyInCreation(beanName));<br><span class="hljs-keyword">if</span> (earlySingletonExposure) &#123;<br><span class="hljs-keyword">if</span> (logger.isTraceEnabled()) &#123;<br>logger.trace(<span class="hljs-string">&quot;Eagerly caching bean &#x27;&quot;</span> + beanName +<br><span class="hljs-string">&quot;&#x27; to allow for resolving potential circular references&quot;</span>);<br>&#125;<br><span class="hljs-comment">//这里着重理解，对理解循环依赖帮助非常大，重要程度 5   添加三级缓存</span><br>addSingletonFactory(beanName, () -&gt; getEarlyBeanReference(beanName, mbd, bean));<br>&#125;<br><br><span class="hljs-comment">// Initialize the bean instance.</span><br><span class="hljs-type">Object</span> <span class="hljs-variable">exposedObject</span> <span class="hljs-operator">=</span> bean;<br><span class="hljs-keyword">try</span> &#123;<br><span class="hljs-comment">//ioc di，依赖注入的核心方法，该方法必须看，重要程度：5</span><br>populateBean(beanName, mbd, instanceWrapper);<br><span class="hljs-comment">//bean 实例化+ioc依赖注入完以后的调用，非常重要，重要程度：5</span><br>exposedObject = initializeBean(beanName, exposedObject, mbd);<br>&#125;<br><br><span class="hljs-comment">//......省略部分代码</span><br><br><span class="hljs-comment">// Register bean as disposable.</span><br><span class="hljs-keyword">try</span> &#123;<br><span class="hljs-comment">//注册bean销毁时的类DisposableBeanAdapter</span><br>registerDisposableBeanIfNecessary(beanName, bean, mbd);<br>&#125;<br><span class="hljs-keyword">catch</span> (BeanDefinitionValidationException ex) &#123;<br><span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BeanCreationException</span>(<br>mbd.getResourceDescription(), beanName, <span class="hljs-string">&quot;Invalid destruction signature&quot;</span>, ex);<br>&#125;<br><span class="hljs-keyword">return</span> exposedObject;<br>&#125;<br></code></pre></td></tr></table></div></figure></li><li><p>createBeanInstance 方法执行完毕之后才会判断是否是单例bean 提前暴漏从而为实例化的bean 添加三级缓存singletonFactories</p></li></ol><figure class="highlight java"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-v4lxrglhkez7dx"></i><span>java</span><div class="collapse show" id="collapse-v4lxrglhkez7dx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//是否单例bean提前暴露:单例、支持循环依赖、是正在创建的实例</span><br><span class="hljs-type">boolean</span> <span class="hljs-variable">earlySingletonExposure</span> <span class="hljs-operator">=</span> (mbd.isSingleton() &amp;&amp; <span class="hljs-built_in">this</span>.allowCircularReferences &amp;&amp;<br>isSingletonCurrentlyInCreation(beanName));<br><span class="hljs-keyword">if</span> (earlySingletonExposure) &#123;<br><span class="hljs-keyword">if</span> (logger.isTraceEnabled()) &#123;<br>logger.trace(<span class="hljs-string">&quot;Eagerly caching bean &#x27;&quot;</span> + beanName +<br><span class="hljs-string">&quot;&#x27; to allow for resolving potential circular references&quot;</span>);<br>&#125;<br><span class="hljs-comment">//这里着重理解，对理解循环依赖帮助非常大，重要程度 5   添加三级缓存</span><br>addSingletonFactory(beanName, () -&gt; getEarlyBeanReference(beanName, mbd, bean));<br>&#125;<br></code></pre></td></tr></table></div></figure><p>默认情况下，支持循环依赖，默认都是单例，而正在创建的实例条件是在AbstractAutowireCapableBeanFactory.doCreateBean()的调用方，AbstractBeanFactory.deGetBean()发起的</p><figure class="highlight java"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-y6iljqlhkez7dx"></i><span>java</span><div class="collapse show" id="collapse-y6iljqlhkez7dx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">if</span> (mbd.isSingleton()) &#123;<br>sharedInstance = getSingleton(beanName, () -&gt; &#123;<br><span class="hljs-keyword">try</span> &#123;<br><span class="hljs-keyword">return</span> createBean(beanName, mbd, args);<br>&#125;<br><span class="hljs-keyword">catch</span> (BeansException ex) &#123;<br><span class="hljs-comment">// Explicitly remove instance from singleton cache: It might have been put there</span><br><span class="hljs-comment">// eagerly by the creation process, to allow for circular reference resolution.</span><br><span class="hljs-comment">// Also remove any beans that received a temporary reference to the bean.</span><br>destroySingleton(beanName);<br><span class="hljs-keyword">throw</span> ex;<br>&#125;<br>&#125;);<br><span class="hljs-comment">//该方法是FactoryBean接口的调用入口</span><br>bean = getObjectForBeanInstance(sharedInstance, name, beanName, mbd);<br>&#125;<br></code></pre></td></tr></table></div></figure><p>点进去看看getSingleton().<br><img src="https://img-blog.csdnimg.cn/20210420120240865.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2tlemFkZQ==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p><figure class="highlight java"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-o41ejhlhkez7dx"></i><span>java</span><div class="collapse show" id="collapse-o41ejhlhkez7dx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">beforeSingletonCreation</span><span class="hljs-params">(String beanName)</span> &#123;<br><span class="hljs-comment">//把beanName添加到singletonsCurrentlyInCreation Set容器中，在这个集合里面的bean都是正在实例化的bean</span><br><span class="hljs-keyword">if</span> (!<span class="hljs-built_in">this</span>.inCreationCheckExclusions.contains(beanName) &amp;&amp; !<span class="hljs-built_in">this</span>.singletonsCurrentlyInCreation.add(beanName)) &#123;<br><span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BeanCurrentlyInCreationException</span>(beanName);<br>&#125;<br>&#125;<br></code></pre></td></tr></table></div></figure><p>创建完毕后，会把提前暴露的实例存放至三级缓存中</p><figure class="highlight java"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-j1mxe0lhkez7dx"></i><span>java</span><div class="collapse show" id="collapse-j1mxe0lhkez7dx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//DefaultSingletonBeanRegistry</span><br><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addSingletonFactory</span><span class="hljs-params">(String beanName, ObjectFactory&lt;?&gt; singletonFactory)</span> &#123;<br>Assert.notNull(singletonFactory, <span class="hljs-string">&quot;Singleton factory must not be null&quot;</span>);<br><span class="hljs-keyword">synchronized</span> (<span class="hljs-built_in">this</span>.singletonObjects) &#123;<br><span class="hljs-comment">//如果一级缓存不存在</span><br><span class="hljs-keyword">if</span> (!<span class="hljs-built_in">this</span>.singletonObjects.containsKey(beanName)) &#123;<br><span class="hljs-comment">//设置三级缓存</span><br><span class="hljs-built_in">this</span>.singletonFactories.put(beanName, singletonFactory);<br><span class="hljs-comment">//删除二级缓存</span><br><span class="hljs-built_in">this</span>.earlySingletonObjects.remove(beanName);<br><span class="hljs-built_in">this</span>.registeredSingletons.add(beanName);<br>&#125;<br>&#125;<br>&#125;<br></code></pre></td></tr></table></div></figure><p>如果有参构造函数的有@Autowired ，那么在执行createBeanInstance 方法时，参数为引用类型会再次触发getBean操作。由于之前的bean 的实例化尚未完成，三级缓存中也没法获取到，所以就继续走之前第一次实例化进入的getSingleton 方法，此方法中的beforeSingletonCreation 会校验该bean 是否正在实例化。如果是有参构造函数的有@Autowired的循环依赖的话，则这里的第二个判断为false，因为第一次类A已经在里面了，就会抛异常。</p><figure class="highlight java"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-rf9baglhkez7dx"></i><span>java</span><div class="collapse show" id="collapse-rf9baglhkez7dx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">beforeSingletonCreation</span><span class="hljs-params">(String beanName)</span> &#123;<br><span class="hljs-comment">//把beanName添加到singletonsCurrentlyInCreation Set容器中，在这个集合里面的bean都是正在实例化的bean</span><br><span class="hljs-keyword">if</span> (!<span class="hljs-built_in">this</span>.inCreationCheckExclusions.contains(beanName) &amp;&amp; !<span class="hljs-built_in">this</span>.singletonsCurrentlyInCreation.add(beanName)) &#123;<br><span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BeanCurrentlyInCreationException</span>(beanName);<br>&#125;<br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-title function_">BeanCurrentlyInCreationException</span><span class="hljs-params">(String beanName)</span> &#123;<br><span class="hljs-built_in">super</span>(beanName,<br><span class="hljs-string">&quot;Requested bean is currently in creation: Is there an unresolvable circular reference?&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></div></figure><p>而对于多例的循环依赖问题，在这里就会抛异常了</p><figure class="highlight java"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-m5r29llhkez7dx"></i><span>java</span><div class="collapse show" id="collapse-m5r29llhkez7dx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//AbstractBeanFactory</span><br><span class="hljs-comment">//如果是scope 是Prototype的，校验是否有出现循环依赖，如果有则直接报错</span><br><span class="hljs-keyword">if</span> (isPrototypeCurrentlyInCreation(beanName)) &#123;<br><span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BeanCurrentlyInCreationException</span>(beanName);<br>&#125;<br></code></pre></td></tr></table></div></figure><p>如果是通过属性加@Autowired 方式进行循环依赖，在进行populateBean 属性依赖注入之前就会把bean 放入三级缓存中，从而进行populateBean 操作时触发getBean 时就可以直接从三级缓存中取就可以了。</p><p>总结下三级缓存各自的功能：</p><table><thead><tr><th align="left">缓存</th><th align="left">说明</th></tr></thead><tbody><tr><td align="left">singletonObjects</td><td align="left">第一级缓存，存放可用的成品Bean。</td></tr><tr><td align="left">earlySingletonObjects</td><td align="left">第二级缓存，存放半成品的Bean，半成品的Bean是已创建对象，但是未注入属性和初始化。用以解决循环依赖。</td></tr><tr><td align="left">singletonFactories</td><td align="left">第三级缓存，存的是Bean工厂对象，用来生成半成品的Bean并放入到二级缓存中。用以解决循环依赖。</td></tr></tbody></table><h1 id="四、二级缓存能否解决循环依赖"><a href="#四、二级缓存能否解决循环依赖" class="headerlink" title="四、二级缓存能否解决循环依赖"></a>四、二级缓存能否解决循环依赖</h1><ol><li>若没有第二级缓存，若有多次依赖某一对象，则每次都需要从三级缓存中创建该对象，失去了单例的意义。（我要的就是单例，你给我来多例，逗我呢？）</li><li>若没有第三级缓存，对于一般的对象循环依赖问题可以得到解决。那么就得去改写 AbstractAutowireCapableBeanFactory 的 doCreateBean 的方法了。</li></ol><figure class="highlight java"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-ntrg7jlhkez7dx"></i><span>java</span><div class="collapse show" id="collapse-ntrg7jlhkez7dx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//添加到三级缓存</span><br>  <span class="hljs-keyword">if</span> (earlySingletonExposure) &#123;<br>   <span class="hljs-keyword">if</span> (logger.isTraceEnabled()) &#123;<br>    logger.trace(<span class="hljs-string">&quot;Eagerly caching bean &#x27;&quot;</span> + beanName +<br>      <span class="hljs-string">&quot;&#x27; to allow for resolving potential circular references&quot;</span>);<br>   &#125;<br>   addSingletonFactory(beanName, () -&gt; getEarlyBeanReference(beanName, mbd, bean));<br>   <span class="hljs-comment">//从三级缓存中取出立刻放入二级缓存</span><br>   getSingleton(beanName, <span class="hljs-literal">true</span>);<br>  &#125;<br></code></pre></td></tr></table></div></figure><p>但是，对于AOP代理对象的生成，会违背Spring总体实例化对象的流程，因为代理对象是在初始化bean完全之后，进行该bean的代理。即：<br>Spring结合AOP跟Bean的生命周期，是在Bean创建完全之后通过AnnotationAwareAspectJAutoProxyCreator这个后置处理器来完成的，在这个后置处理的postProcessAfterInitialization方法中对初始化后的Bean完成AOP代理。</p><p>若没有第三级缓存，则创建完bean，就得立马创建代理对象，违背了Spring设计原则。</p>]]></content>
    
    
    <categories>
      
      <category>Spring源码学习</category>
      
    </categories>
    
    
    <tags>
      
      <tag>源码</tag>
      
      <tag>Spring</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>【Spring源码学习】Spring Bean实例化过程-初始化</title>
    <link href="/posts/1127038901.html"/>
    <url>/posts/1127038901.html</url>
    
    <content type="html"><![CDATA[<p>上一章讲完了populateBean的过程，这一章，我们来跟一下bean初始化的流程，主要分为这么几个步骤：</p><ul><li>调用Aware方法</li><li>InitializingBean接口，afterPropertiesSet，init-method属性调用</li></ul><h1 id="一、调用Aware方法"><a href="#一、调用Aware方法" class="headerlink" title="一、调用Aware方法"></a>一、调用Aware方法</h1><h2 id="1-InitializeBean"><a href="#1-InitializeBean" class="headerlink" title="1.InitializeBean()"></a>1.InitializeBean()</h2><figure class="highlight java"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-dyha02lhkez7dx"></i><span>java</span><div class="collapse show" id="collapse-dyha02lhkez7dx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">protected</span> Object <span class="hljs-title function_">initializeBean</span><span class="hljs-params">(String beanName, Object bean, <span class="hljs-meta">@Nullable</span> RootBeanDefinition mbd)</span> &#123;<br><span class="hljs-keyword">if</span> (System.getSecurityManager() != <span class="hljs-literal">null</span>) &#123;<br>AccessController.doPrivileged((PrivilegedAction&lt;Object&gt;) () -&gt; &#123;<br>invokeAwareMethods(beanName, bean);<br><span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>&#125;, getAccessControlContext());<br>&#125;<br><span class="hljs-keyword">else</span> &#123;<br><span class="hljs-comment">//1.调用Aware方法</span><br>invokeAwareMethods(beanName, bean);<br>&#125;<br><br><span class="hljs-type">Object</span> <span class="hljs-variable">wrappedBean</span> <span class="hljs-operator">=</span> bean;<br><span class="hljs-keyword">if</span> (mbd == <span class="hljs-literal">null</span> || !mbd.isSynthetic()) &#123;<br><span class="hljs-comment">//前置处理</span><br><span class="hljs-comment">//对类中某些特殊方法的调用，比如@PostConstruct，Aware接口，非常重要 重要程度 ：5</span><br><span class="hljs-comment">//ApplicationContextAwareProcessor 对Aware接口的调用如：</span><br><span class="hljs-comment">//EnvironmentAware EmbeddedValueResolverAware  ResourceLoaderAware ApplicationEventPublisherAware MessageSourceAware  ApplicationContextAware</span><br><span class="hljs-comment">//ImportAwareBeanPostProcessor 对ImportAware的支持</span><br>wrappedBean = applyBeanPostProcessorsBeforeInitialization(wrappedBean, beanName);<br>&#125;<br><br><span class="hljs-keyword">try</span> &#123;<br><span class="hljs-comment">//2.InitializingBean接口，afterPropertiesSet，init-method属性调用,非常重要，重要程度：5</span><br>invokeInitMethods(beanName, wrappedBean, mbd);<br>&#125;<br><span class="hljs-keyword">catch</span> (Throwable ex) &#123;<br><span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BeanCreationException</span>(<br>(mbd != <span class="hljs-literal">null</span> ? mbd.getResourceDescription() : <span class="hljs-literal">null</span>),<br>beanName, <span class="hljs-string">&quot;Invocation of init method failed&quot;</span>, ex);<br>&#125;<br><span class="hljs-keyword">if</span> (mbd == <span class="hljs-literal">null</span> || !mbd.isSynthetic()) &#123;<br><span class="hljs-comment">//3.后置处理，这个地方可能生出代理实例，是aop的入口</span><br>wrappedBean = applyBeanPostProcessorsAfterInitialization(wrappedBean, beanName);<br>&#125;<br><br><span class="hljs-keyword">return</span> wrappedBean;<br>&#125;<br></code></pre></td></tr></table></div></figure><h2 id="2-invokeAwareMethods"><a href="#2-invokeAwareMethods" class="headerlink" title="2.invokeAwareMethods()"></a>2.invokeAwareMethods()</h2><p>这个方法主要是设置beanName，beanClassLoader，beanFactory，但前提是这个bean实现了对应Aware的接口</p><figure class="highlight java"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-st5q8elhkez7dx"></i><span>java</span><div class="collapse show" id="collapse-st5q8elhkez7dx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">invokeAwareMethods</span><span class="hljs-params">(String beanName, Object bean)</span> &#123;<br><span class="hljs-keyword">if</span> (bean <span class="hljs-keyword">instanceof</span> Aware) &#123;<br><span class="hljs-keyword">if</span> (bean <span class="hljs-keyword">instanceof</span> BeanNameAware) &#123;<br>((BeanNameAware) bean).setBeanName(beanName);<br>&#125;<br><span class="hljs-keyword">if</span> (bean <span class="hljs-keyword">instanceof</span> BeanClassLoaderAware) &#123;<br><span class="hljs-type">ClassLoader</span> <span class="hljs-variable">bcl</span> <span class="hljs-operator">=</span> getBeanClassLoader();<br><span class="hljs-keyword">if</span> (bcl != <span class="hljs-literal">null</span>) &#123;<br>((BeanClassLoaderAware) bean).setBeanClassLoader(bcl);<br>&#125;<br>&#125;<br><span class="hljs-keyword">if</span> (bean <span class="hljs-keyword">instanceof</span> BeanFactoryAware) &#123;<br>((BeanFactoryAware) bean).setBeanFactory(AbstractAutowireCapableBeanFactory.<span class="hljs-built_in">this</span>);<br>&#125;<br>&#125;<br>&#125;<br></code></pre></td></tr></table></div></figure><h1 id="二、InitializingBean接口，afterPropertiesSet，init-method属性调用"><a href="#二、InitializingBean接口，afterPropertiesSet，init-method属性调用" class="headerlink" title="二、InitializingBean接口，afterPropertiesSet，init-method属性调用"></a>二、InitializingBean接口，afterPropertiesSet，init-method属性调用</h1><p>初始化的调用又可分为三个步骤：</p><ul><li>初始化前置处理：applyBeanPostProcessorsBeforeInitialization()</li><li>初始化：afterPropertiesSet，init-method属性调用</li><li>初始化后置处理：applyBeanPostProcessorsAfterInitialization()</li></ul><h2 id="1-初始化前置处理"><a href="#1-初始化前置处理" class="headerlink" title="1.初始化前置处理"></a>1.初始化前置处理</h2><p>在<a href="https://zyxelva.github.io/2023/05/01/%E3%80%90Spring%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0%E3%80%91Spring-Bean%E5%AE%9E%E4%BE%8B%E5%8C%96%E8%BF%87%E7%A8%8B-%E5%88%9B%E5%BB%BABean%E5%AE%9E%E4%BE%8B/">【Spring源码学习】Spring Bean实例化过程-创建Bean实例</a>6.2.1节，我们已经完成了@PostConstruct注解扫描，这一步就是调用相关的过程了，依然采用beanPostProcessor调用的方式。当然不止这些注解，还包括Aware接口的调用，ImportAware的支持处理等。</p><figure class="highlight java"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-18f29alhkez7dx"></i><span>java</span><div class="collapse show" id="collapse-18f29alhkez7dx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> Object <span class="hljs-title function_">applyBeanPostProcessorsBeforeInitialization</span><span class="hljs-params">(Object existingBean, String beanName)</span><br><span class="hljs-keyword">throws</span> BeansException &#123;<br><span class="hljs-type">Object</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> existingBean;<br><span class="hljs-comment">//循环处理</span><br><span class="hljs-comment">/*</span><br><span class="hljs-comment">*着重看这几个：</span><br><span class="hljs-comment">* 1.ApplicationContextAwareProcessor 对某个Aware接口方法的调用</span><br><span class="hljs-comment">* 2.InitDestroyAnnotationBeanPostProcessor @PostConstruct注解方法的调用</span><br><span class="hljs-comment">* 3.ImportAwareBeanPostProcessor 对ImportAware类型实例setImportMetadata 调用（SpringBoot）</span><br><span class="hljs-comment">*/</span><br><span class="hljs-keyword">for</span> (BeanPostProcessor processor : getBeanPostProcessors()) &#123;<br><span class="hljs-type">Object</span> <span class="hljs-variable">current</span> <span class="hljs-operator">=</span> processor.postProcessBeforeInitialization(result, beanName);<br><span class="hljs-keyword">if</span> (current == <span class="hljs-literal">null</span>) &#123;<br><span class="hljs-keyword">return</span> result;<br>&#125;<br>result = current;<br>&#125;<br><span class="hljs-keyword">return</span> result;<br>&#125;<br></code></pre></td></tr></table></div></figure><h3 id="1-1-Aware接口方法的调用"><a href="#1-1-Aware接口方法的调用" class="headerlink" title="1.1.Aware接口方法的调用"></a>1.1.Aware接口方法的调用</h3><figure class="highlight java"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-njhqojlhkez7dx"></i><span>java</span><div class="collapse show" id="collapse-njhqojlhkez7dx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> Object <span class="hljs-title function_">postProcessBeforeInitialization</span><span class="hljs-params">(Object bean, String beanName)</span> <span class="hljs-keyword">throws</span> BeansException &#123;<br><span class="hljs-keyword">if</span> (!(bean <span class="hljs-keyword">instanceof</span> EnvironmentAware || bean <span class="hljs-keyword">instanceof</span> EmbeddedValueResolverAware ||<br>bean <span class="hljs-keyword">instanceof</span> ResourceLoaderAware || bean <span class="hljs-keyword">instanceof</span> ApplicationEventPublisherAware ||<br>bean <span class="hljs-keyword">instanceof</span> MessageSourceAware || bean <span class="hljs-keyword">instanceof</span> ApplicationContextAware))&#123;<br><span class="hljs-keyword">return</span> bean;<br>&#125;<br><span class="hljs-type">AccessControlContext</span> <span class="hljs-variable">acc</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br><span class="hljs-keyword">if</span> (System.getSecurityManager() != <span class="hljs-literal">null</span>) &#123;<br>acc = <span class="hljs-built_in">this</span>.applicationContext.getBeanFactory().getAccessControlContext();<br>&#125;<br><span class="hljs-keyword">if</span> (acc != <span class="hljs-literal">null</span>) &#123;<br>AccessController.doPrivileged((PrivilegedAction&lt;Object&gt;) () -&gt; &#123;<br>invokeAwareInterfaces(bean);<br><span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>&#125;, acc);<br>&#125;<br><span class="hljs-keyword">else</span> &#123;<br>invokeAwareInterfaces(bean);<br>&#125;<br><br><span class="hljs-keyword">return</span> bean;<br>&#125;<br></code></pre></td></tr></table></div></figure><h3 id="1-2-PostConstruct注解方法调用"><a href="#1-2-PostConstruct注解方法调用" class="headerlink" title="1.2.@PostConstruct注解方法调用"></a>1.2.@PostConstruct注解方法调用</h3><figure class="highlight java"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-cobl7klhkez7dx"></i><span>java</span><div class="collapse show" id="collapse-cobl7klhkez7dx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//InitDestroyAnnotationBeanPostProcessor</span><br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> Object <span class="hljs-title function_">postProcessBeforeInitialization</span><span class="hljs-params">(Object bean, String beanName)</span> <span class="hljs-keyword">throws</span> BeansException &#123;<br><span class="hljs-type">LifecycleMetadata</span> <span class="hljs-variable">metadata</span> <span class="hljs-operator">=</span> findLifecycleMetadata(bean.getClass());<br><span class="hljs-keyword">try</span> &#123;<br><span class="hljs-comment">//调用@PostConstruct注解的方法</span><br>metadata.invokeInitMethods(bean, beanName);<br>&#125;<br><span class="hljs-keyword">catch</span> (InvocationTargetException ex) &#123;<br><span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BeanCreationException</span>(beanName, <span class="hljs-string">&quot;Invocation of init method failed&quot;</span>, ex.getTargetException());<br>&#125;<br><span class="hljs-keyword">catch</span> (Throwable ex) &#123;<br><span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BeanCreationException</span>(beanName, <span class="hljs-string">&quot;Failed to invoke init method&quot;</span>, ex);<br>&#125;<br><span class="hljs-keyword">return</span> bean;<br>&#125;<br></code></pre></td></tr></table></div></figure><h2 id="2-初始化"><a href="#2-初始化" class="headerlink" title="2.初始化"></a>2.初始化</h2><p>前置处理完毕，接下来就是InitializingBean 接口和init-method 属性调用过程，实现了InitializingBean 接口的类就必然会调用到afterPropertiesSet 方法，而Init-method 属性调用是在afterPropertiesSet 之后，对应的方法为invokeCustomInitMethod。</p><figure class="highlight java"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-7dg8z3lhkez7dx"></i><span>java</span><div class="collapse show" id="collapse-7dg8z3lhkez7dx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">invokeInitMethods</span><span class="hljs-params">(String beanName, Object bean, <span class="hljs-meta">@Nullable</span> RootBeanDefinition mbd)</span><br><span class="hljs-keyword">throws</span> Throwable &#123;<br><span class="hljs-comment">//是否是实现了InitializingBean的类</span><br><span class="hljs-type">boolean</span> <span class="hljs-variable">isInitializingBean</span> <span class="hljs-operator">=</span> (bean <span class="hljs-keyword">instanceof</span> InitializingBean);<br><span class="hljs-keyword">if</span> (isInitializingBean &amp;&amp; (mbd == <span class="hljs-literal">null</span> || !mbd.isExternallyManagedInitMethod(<span class="hljs-string">&quot;afterPropertiesSet&quot;</span>))) &#123;<br><span class="hljs-keyword">if</span> (logger.isTraceEnabled()) &#123;<br>logger.trace(<span class="hljs-string">&quot;Invoking afterPropertiesSet() on bean with name &#x27;&quot;</span> + beanName + <span class="hljs-string">&quot;&#x27;&quot;</span>);<br>&#125;<br><span class="hljs-keyword">if</span> (System.getSecurityManager() != <span class="hljs-literal">null</span>) &#123;<br><span class="hljs-keyword">try</span> &#123;<br>AccessController.doPrivileged((PrivilegedExceptionAction&lt;Object&gt;) () -&gt; &#123;<br>((InitializingBean) bean).afterPropertiesSet();<br><span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>&#125;, getAccessControlContext());<br>&#125;<br><span class="hljs-keyword">catch</span> (PrivilegedActionException pae) &#123;<br><span class="hljs-keyword">throw</span> pae.getException();<br>&#125;<br>&#125;<br><span class="hljs-keyword">else</span> &#123;<br><span class="hljs-comment">//调用实现了InitializingBean接口的方法</span><br>((InitializingBean) bean).afterPropertiesSet();<br>&#125;<br>&#125;<br><span class="hljs-comment">//init-method反射调用</span><br><span class="hljs-keyword">if</span> (mbd != <span class="hljs-literal">null</span> &amp;&amp; bean.getClass() != NullBean.class) &#123;<br><span class="hljs-type">String</span> <span class="hljs-variable">initMethodName</span> <span class="hljs-operator">=</span> mbd.getInitMethodName();<br><span class="hljs-keyword">if</span> (StringUtils.hasLength(initMethodName) &amp;&amp;<br>!(isInitializingBean &amp;&amp; <span class="hljs-string">&quot;afterPropertiesSet&quot;</span>.equals(initMethodName)) &amp;&amp;<br>!mbd.isExternallyManagedInitMethod(initMethodName)) &#123;<br><span class="hljs-comment">//调用init-method配置的方法</span><br>invokeCustomInitMethod(beanName, bean, mbd);<br>&#125;<br>&#125;<br>&#125;<br></code></pre></td></tr></table></div></figure><p>afterPropertiesSet 和Init-method 和有@PostConstruct 注解的方法其实核心功能都是一样的，只是调用<br>时序不一样而已，都是在该类实例化和IOC 做完后调用的，我们可以在这些方法中做一些在spring 或者servlet 容器启动的时候的初始化工作。比如缓存预热，比如缓存数据加载到内存，比如配置解析，等等初始化工作调用顺序为先调用@PostConstruct(注解使用)、然后是afterPropertiesSet、InitMethod(xml 配置)方法。</p><h2 id="3-初始化后置处理"><a href="#3-初始化后置处理" class="headerlink" title="3.初始化后置处理"></a>3.初始化后置处理</h2><p>bean对象初始化后，还会进行一些后置处理，比如后续我们将要重点跟踪的AOP动态代理，这里做个预热。我们先看看动态代理的初始化后置处理是怎样的，看个大概，不做深入讨论。</p><h3 id="3-1-代理实例注入"><a href="#3-1-代理实例注入" class="headerlink" title="3.1.代理实例注入"></a>3.1.代理实例注入</h3><figure class="highlight java"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-cpbcielhkez7dx"></i><span>java</span><div class="collapse show" id="collapse-cpbcielhkez7dx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//AbstractAutoProxyCreator</span><br><span class="hljs-keyword">public</span> Object <span class="hljs-title function_">postProcessAfterInitialization</span><span class="hljs-params">(<span class="hljs-meta">@Nullable</span> Object bean, String beanName)</span> &#123;<br><span class="hljs-keyword">if</span> (bean != <span class="hljs-literal">null</span>) &#123;<br><span class="hljs-type">Object</span> <span class="hljs-variable">cacheKey</span> <span class="hljs-operator">=</span> getCacheKey(bean.getClass(), beanName);<br><span class="hljs-comment">//上一章节，提到过这个缓存容器，还有印象咩?</span><br><span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.earlyProxyReferences.remove(cacheKey) != bean) &#123;<br><span class="hljs-keyword">return</span> wrapIfNecessary(bean, beanName, cacheKey);<br>&#125;<br>&#125;<br><span class="hljs-keyword">return</span> bean;<br>&#125;<br><br><span class="hljs-keyword">protected</span> Object <span class="hljs-title function_">wrapIfNecessary</span><span class="hljs-params">(Object bean, String beanName, Object cacheKey)</span> &#123;<br><span class="hljs-keyword">if</span> (StringUtils.hasLength(beanName) &amp;&amp; <span class="hljs-built_in">this</span>.targetSourcedBeans.contains(beanName)) &#123;<br><span class="hljs-keyword">return</span> bean;<br>&#125;<br><span class="hljs-keyword">if</span> (Boolean.FALSE.equals(<span class="hljs-built_in">this</span>.advisedBeans.get(cacheKey))) &#123;<br><span class="hljs-keyword">return</span> bean;<br>&#125;<br><span class="hljs-keyword">if</span> (isInfrastructureClass(bean.getClass()) || shouldSkip(bean.getClass(), beanName)) &#123;<br><span class="hljs-built_in">this</span>.advisedBeans.put(cacheKey, Boolean.FALSE);<br><span class="hljs-keyword">return</span> bean;<br>&#125;<br><br><span class="hljs-comment">//创建当前bean的代理，如果这个bean有advice的话，重点看，重要程度5</span><br><span class="hljs-comment">// Create proxy if we have advice.</span><br>Object[] specificInterceptors = getAdvicesAndAdvisorsForBean(bean.getClass(), beanName, <span class="hljs-literal">null</span>);<br><span class="hljs-comment">//如果有切面，则生成该bean的代理</span><br><span class="hljs-keyword">if</span> (specificInterceptors != DO_NOT_PROXY) &#123;<br><span class="hljs-built_in">this</span>.advisedBeans.put(cacheKey, Boolean.TRUE);<br><span class="hljs-comment">//把被代理对象bean实例封装到SingletonTargetSource对象中</span><br><span class="hljs-type">Object</span> <span class="hljs-variable">proxy</span> <span class="hljs-operator">=</span> createProxy(<br>bean.getClass(), beanName, specificInterceptors, <span class="hljs-keyword">new</span> <span class="hljs-title class_">SingletonTargetSource</span>(bean));<br><span class="hljs-built_in">this</span>.proxyTypes.put(cacheKey, proxy.getClass());<br><span class="hljs-keyword">return</span> proxy;<br>&#125;<br><span class="hljs-built_in">this</span>.advisedBeans.put(cacheKey, Boolean.FALSE);<br><span class="hljs-keyword">return</span> bean;<br>&#125;<br></code></pre></td></tr></table></div></figure><p>bean的创建过程跟玩咯，休息一下，后面简单跟下bean销毁的注册过程。^_^</p>]]></content>
    
    
    <categories>
      
      <category>Spring源码学习</category>
      
    </categories>
    
    
    <tags>
      
      <tag>源码</tag>
      
      <tag>Spring</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>【Spring源码学习】Spring Bean实例化过程-依赖属性注入</title>
    <link href="/posts/1579831827.html"/>
    <url>/posts/1579831827.html</url>
    
    <content type="html"><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>前面一章<a href="https://zyxelva.github.io/2023/05/01/%E3%80%90Spring%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0%E3%80%91Spring-Bean%E5%AE%9E%E4%BE%8B%E5%8C%96%E8%BF%87%E7%A8%8B-%E5%88%9B%E5%BB%BABean%E5%AE%9E%E4%BE%8B/">【Spring源码学习】Spring Bean实例化过程-创建Bean实例</a>，我们着重跟踪了bean实例的创建过程，本章，我们主要跟一下bean实例化后的依赖属性注入的过程。先把代码定位到类AbstractAutowireCapableBeanFactory中的doCreateBean()方法</p><figure class="highlight java"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-4o42yblhkez7dx"></i><span>java</span><div class="collapse show" id="collapse-4o42yblhkez7dx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">protected</span> Object <span class="hljs-title function_">doCreateBean</span><span class="hljs-params">(String beanName, RootBeanDefinition mbd, <span class="hljs-meta">@Nullable</span> Object[] args)</span><br><span class="hljs-keyword">throws</span> BeanCreationException &#123;<br><span class="hljs-comment">// Instantiate the bean.</span><br><span class="hljs-type">BeanWrapper</span> <span class="hljs-variable">instanceWrapper</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br><span class="hljs-keyword">if</span> (mbd.isSingleton()) &#123;<br>instanceWrapper = <span class="hljs-built_in">this</span>.factoryBeanInstanceCache.remove(beanName);<br>&#125;<br><span class="hljs-keyword">if</span> (instanceWrapper == <span class="hljs-literal">null</span>) &#123;<br><span class="hljs-comment">//创建实例,,重点看，重要程度：5</span><br>instanceWrapper = createBeanInstance(beanName, mbd, args);<br>&#125;<br><span class="hljs-type">Object</span> <span class="hljs-variable">bean</span> <span class="hljs-operator">=</span> instanceWrapper.getWrappedInstance();<br>Class&lt;?&gt; beanType = instanceWrapper.getWrappedClass();<br><span class="hljs-keyword">if</span> (beanType != NullBean.class) &#123;<br>mbd.resolvedTargetType = beanType;<br>&#125;<br><br><span class="hljs-comment">// Allow post-processors to modify the merged bean definition.</span><br><span class="hljs-keyword">synchronized</span> (mbd.postProcessingLock) &#123;<br><span class="hljs-keyword">if</span> (!mbd.postProcessed) &#123;<br><span class="hljs-keyword">try</span> &#123;<br><span class="hljs-comment">//CommonAnnotationBeanPostProcessor  支持了@PostConstruct，@PreDestroy,@Resource注解</span><br><span class="hljs-comment">//AutowiredAnnotationBeanPostProcessor 支持 @Autowired,@Value注解</span><br><span class="hljs-comment">//BeanPostProcessor接口的典型运用，这里要理解这个接口</span><br><span class="hljs-comment">//对类中注解的装配过程</span><br><span class="hljs-comment">//重要程度5，必须看</span><br>applyMergedBeanDefinitionPostProcessors(mbd, beanType, beanName);<br>&#125;<br><span class="hljs-keyword">catch</span> (Throwable ex) &#123;<br><span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BeanCreationException</span>(mbd.getResourceDescription(), beanName,<br><span class="hljs-string">&quot;Post-processing of merged bean definition failed&quot;</span>, ex);<br>&#125;<br>mbd.postProcessed = <span class="hljs-literal">true</span>;<br>&#125;<br>&#125;<br><br><span class="hljs-comment">// Eagerly cache singletons to be able to resolve circular references</span><br><span class="hljs-comment">// even when triggered by lifecycle interfaces like BeanFactoryAware.</span><br><span class="hljs-comment">//是否单例bean提前暴露</span><br><span class="hljs-type">boolean</span> <span class="hljs-variable">earlySingletonExposure</span> <span class="hljs-operator">=</span> (mbd.isSingleton() &amp;&amp; <span class="hljs-built_in">this</span>.allowCircularReferences &amp;&amp;<br>isSingletonCurrentlyInCreation(beanName));<br><span class="hljs-keyword">if</span> (earlySingletonExposure) &#123;<br><span class="hljs-keyword">if</span> (logger.isTraceEnabled()) &#123;<br>logger.trace(<span class="hljs-string">&quot;Eagerly caching bean &#x27;&quot;</span> + beanName +<br><span class="hljs-string">&quot;&#x27; to allow for resolving potential circular references&quot;</span>);<br>&#125;<br><span class="hljs-comment">//这里着重理解，对理解循环依赖帮助非常大，重要程度 5   添加三级缓存</span><br>addSingletonFactory(beanName, () -&gt; getEarlyBeanReference(beanName, mbd, bean));<br>&#125;<br><br><span class="hljs-comment">// Initialize the bean instance.</span><br><span class="hljs-type">Object</span> <span class="hljs-variable">exposedObject</span> <span class="hljs-operator">=</span> bean;<br><span class="hljs-keyword">try</span> &#123;<br><span class="hljs-comment">//ioc di，依赖注入的核心方法，该方法必须看，重要程度：5</span><br>populateBean(beanName, mbd, instanceWrapper);<br><span class="hljs-comment">//bean 实例化+ioc依赖注入完以后的调用，非常重要，重要程度：5</span><br>exposedObject = initializeBean(beanName, exposedObject, mbd);<br>&#125;<br><span class="hljs-keyword">catch</span> (Throwable ex) &#123;<br><span class="hljs-keyword">if</span> (ex <span class="hljs-keyword">instanceof</span> BeanCreationException &amp;&amp; beanName.equals(((BeanCreationException) ex).getBeanName())) &#123;<br><span class="hljs-keyword">throw</span> (BeanCreationException) ex;<br>&#125;<br><span class="hljs-keyword">else</span> &#123;<br><span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BeanCreationException</span>(<br>mbd.getResourceDescription(), beanName, <span class="hljs-string">&quot;Initialization of bean failed&quot;</span>, ex);<br>&#125;<br>&#125;<br>......<br><span class="hljs-comment">//省略一些代码</span><br><span class="hljs-comment">// Register bean as disposable.</span><br><span class="hljs-keyword">try</span> &#123;<br><span class="hljs-comment">//注册bean销毁时的类DisposableBeanAdapter</span><br>registerDisposableBeanIfNecessary(beanName, bean, mbd);<br>&#125;<br><span class="hljs-keyword">catch</span> (BeanDefinitionValidationException ex) &#123;<br><span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BeanCreationException</span>(<br>mbd.getResourceDescription(), beanName, <span class="hljs-string">&quot;Invalid destruction signature&quot;</span>, ex);<br>&#125;<br><br><span class="hljs-keyword">return</span> exposedObject;<br>&#125;<br></code></pre></td></tr></table></div></figure><h2 id="1-addSingletonFactory"><a href="#1-addSingletonFactory" class="headerlink" title="1.addSingletonFactory()"></a>1.addSingletonFactory()</h2><p>先看看addSingletonFactory()方法。这个方法主要作用就是针对单例的、支持提前暴露引用的且是正在创建的对象的工厂方法放入三级缓存中，这里对于理解<strong>循环依赖</strong>帮助非常大，尤其是<strong>AOP代理</strong>。</p><figure class="highlight java"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-hkruxnlhkez7dx"></i><span>java</span><div class="collapse show" id="collapse-hkruxnlhkez7dx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//DefaultSingletonBeanRegistry</span><br><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addSingletonFactory</span><span class="hljs-params">(String beanName, ObjectFactory&lt;?&gt; singletonFactory)</span> &#123;<br>Assert.notNull(singletonFactory, <span class="hljs-string">&quot;Singleton factory must not be null&quot;</span>);<br><span class="hljs-keyword">synchronized</span> (<span class="hljs-built_in">this</span>.singletonObjects) &#123;<br><span class="hljs-comment">//如果一级缓存不存在</span><br><span class="hljs-keyword">if</span> (!<span class="hljs-built_in">this</span>.singletonObjects.containsKey(beanName)) &#123;<br><span class="hljs-comment">//设置三级缓存</span><br><span class="hljs-built_in">this</span>.singletonFactories.put(beanName, singletonFactory);<br><span class="hljs-comment">//删除二级缓存</span><br><span class="hljs-built_in">this</span>.earlySingletonObjects.remove(beanName);<br><span class="hljs-built_in">this</span>.registeredSingletons.add(beanName);<br>&#125;<br>&#125;<br>&#125;<br></code></pre></td></tr></table></div></figure><p>其中，() -&gt; getEarlyBeanReference(beanName, mbd, bean)返回的是一个ObjectFactory匿名对象，ObjectFactory中getObject()的方法是getEarlyBeanReference(beanName, mbd, bean)方法的调用，提前暴露了对象的引用。</p><h2 id="2-getEarlyBeanReference"><a href="#2-getEarlyBeanReference" class="headerlink" title="2.getEarlyBeanReference()"></a>2.getEarlyBeanReference()</h2><figure class="highlight java"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-ect5a5lhkez7dx"></i><span>java</span><div class="collapse show" id="collapse-ect5a5lhkez7dx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Obtain a reference for early access to the specified bean,</span><br><span class="hljs-comment"> * typically for the purpose of resolving a circular reference.</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> beanName the name of the bean (for error handling purposes)</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> mbd the merged bean definition for the bean</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> bean the raw bean instance</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span> the object to expose as bean reference</span><br><span class="hljs-comment"> * 三级缓存对象工厂 ObjectFactory.getObject()调用到这个方法</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">protected</span> Object <span class="hljs-title function_">getEarlyBeanReference</span><span class="hljs-params">(String beanName, RootBeanDefinition mbd, Object bean)</span> &#123;<br><span class="hljs-type">Object</span> <span class="hljs-variable">exposedObject</span> <span class="hljs-operator">=</span> bean;<br><span class="hljs-keyword">if</span> (!mbd.isSynthetic() &amp;&amp; hasInstantiationAwareBeanPostProcessors()) &#123;<br><span class="hljs-keyword">for</span> (BeanPostProcessor bp : getBeanPostProcessors()) &#123;<br><span class="hljs-keyword">if</span> (bp <span class="hljs-keyword">instanceof</span> SmartInstantiationAwareBeanPostProcessor) &#123;<br><span class="hljs-type">SmartInstantiationAwareBeanPostProcessor</span> <span class="hljs-variable">ibp</span> <span class="hljs-operator">=</span> (SmartInstantiationAwareBeanPostProcessor) bp;<br>exposedObject = ibp.getEarlyBeanReference(exposedObject, beanName);<br>&#125;<br>&#125;<br>&#125;<br><span class="hljs-keyword">return</span> exposedObject;<br>&#125;<br></code></pre></td></tr></table></div></figure><p>主要看AbstractAutoProxyCreator的getEarlyBeanReference方法</p><h2 id="3-getEarlyBeanReference"><a href="#3-getEarlyBeanReference" class="headerlink" title="3.getEarlyBeanReference()"></a>3.getEarlyBeanReference()</h2><figure class="highlight java"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-7pkgyqlhkez7dx"></i><span>java</span><div class="collapse show" id="collapse-7pkgyqlhkez7dx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> Object <span class="hljs-title function_">getEarlyBeanReference</span><span class="hljs-params">(Object bean, String beanName)</span> &#123;<br><span class="hljs-comment">//缓存的key</span><br><span class="hljs-type">Object</span> <span class="hljs-variable">cacheKey</span> <span class="hljs-operator">=</span> getCacheKey(bean.getClass(), beanName);<br><span class="hljs-comment">//这个缓存会在后面初始化的后置处理中用到，主要是AOP代理类生成的时候用到</span><br><span class="hljs-built_in">this</span>.earlyProxyReferences.put(cacheKey, bean);<br><span class="hljs-keyword">return</span> wrapIfNecessary(bean, beanName, cacheKey);<br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Wrap the given bean if necessary, i.e. if it is eligible for being proxied.</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> bean the raw bean instance</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> beanName the name of the bean</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> cacheKey the cache key for metadata access</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span> a proxy wrapping the bean, or the raw bean instance as-is</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">protected</span> Object <span class="hljs-title function_">wrapIfNecessary</span><span class="hljs-params">(Object bean, String beanName, Object cacheKey)</span> &#123;<br><span class="hljs-keyword">if</span> (StringUtils.hasLength(beanName) &amp;&amp; <span class="hljs-built_in">this</span>.targetSourcedBeans.contains(beanName)) &#123;<br><span class="hljs-keyword">return</span> bean;<br>&#125;<br><span class="hljs-keyword">if</span> (Boolean.FALSE.equals(<span class="hljs-built_in">this</span>.advisedBeans.get(cacheKey))) &#123;<br><span class="hljs-keyword">return</span> bean;<br>&#125;<br><span class="hljs-keyword">if</span> (isInfrastructureClass(bean.getClass()) || shouldSkip(bean.getClass(), beanName)) &#123;<br><span class="hljs-built_in">this</span>.advisedBeans.put(cacheKey, Boolean.FALSE);<br><span class="hljs-keyword">return</span> bean;<br>&#125;<br><span class="hljs-comment">//创建当前bean的代理，如果这个bean有advice的话，重点看，重要程度5</span><br><span class="hljs-comment">// Create proxy if we have advice.</span><br>Object[] specificInterceptors = getAdvicesAndAdvisorsForBean(bean.getClass(), beanName, <span class="hljs-literal">null</span>);<br><span class="hljs-comment">//如果有切面，则生成该bean的代理</span><br><span class="hljs-keyword">if</span> (specificInterceptors != DO_NOT_PROXY) &#123;<br><span class="hljs-built_in">this</span>.advisedBeans.put(cacheKey, Boolean.TRUE);<br><span class="hljs-comment">//把被代理对象bean实例封装到SingletonTargetSource对象中</span><br><span class="hljs-type">Object</span> <span class="hljs-variable">proxy</span> <span class="hljs-operator">=</span> createProxy(<br>bean.getClass(), beanName, specificInterceptors, <span class="hljs-keyword">new</span> <span class="hljs-title class_">SingletonTargetSource</span>(bean));<br><span class="hljs-built_in">this</span>.proxyTypes.put(cacheKey, proxy.getClass());<br><span class="hljs-keyword">return</span> proxy;<br>&#125;<br><br><span class="hljs-built_in">this</span>.advisedBeans.put(cacheKey, Boolean.FALSE);<br><span class="hljs-keyword">return</span> bean;<br>&#125;<br></code></pre></td></tr></table></div></figure><p>这里不继续展开了，后面将动态代理的时候会详细跟一下这里的逻辑</p><h1 id="一、依赖属性注入"><a href="#一、依赖属性注入" class="headerlink" title="一、依赖属性注入"></a>一、依赖属性注入</h1><p>定位到AbstractAutowireCapableBeanFactory中的doCreateBean()的populateBean(beanName, mbd, instanceWrapper)方法</p><figure class="highlight java"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-tv4ng7lhkez7dx"></i><span>java</span><div class="collapse show" id="collapse-tv4ng7lhkez7dx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">try</span> &#123;<br><span class="hljs-comment">//ioc di，依赖注入的核心方法，该方法必须看，重要程度：5</span><br>populateBean(beanName, mbd, instanceWrapper);<br><span class="hljs-comment">//bean 实例化+ioc依赖注入完以后的调用，非常重要，重要程度：5</span><br>exposedObject = initializeBean(beanName, exposedObject, mbd);<br>&#125;<br></code></pre></td></tr></table></div></figure><h2 id="1-populateBean"><a href="#1-populateBean" class="headerlink" title="1.populateBean()"></a>1.populateBean()</h2><figure class="highlight java"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-b1ur37lhkez7dx"></i><span>java</span><div class="collapse show" id="collapse-b1ur37lhkez7dx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">populateBean</span><span class="hljs-params">(String beanName, RootBeanDefinition mbd, <span class="hljs-meta">@Nullable</span> BeanWrapper bw)</span> &#123;<br><span class="hljs-keyword">if</span> (bw == <span class="hljs-literal">null</span>) &#123;<br><span class="hljs-keyword">if</span> (mbd.hasPropertyValues()) &#123;<br><span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BeanCreationException</span>(<br>mbd.getResourceDescription(), beanName, <span class="hljs-string">&quot;Cannot apply property values to null instance&quot;</span>);<br>&#125;<br><span class="hljs-keyword">else</span> &#123;<br><span class="hljs-comment">// Skip property population phase for null instance.</span><br><span class="hljs-keyword">return</span>;<br>&#125;<br>&#125;<br><br><span class="hljs-comment">// Give any InstantiationAwareBeanPostProcessors the opportunity to modify the</span><br><span class="hljs-comment">// state of the bean before properties are set. This can be used, for example,</span><br><span class="hljs-comment">// to support styles of field injection.</span><br><span class="hljs-comment">//这里很有意思，写接口可以让所有类都不能依赖注入</span><br><span class="hljs-keyword">if</span> (!mbd.isSynthetic() &amp;&amp; hasInstantiationAwareBeanPostProcessors()) &#123;<br><span class="hljs-keyword">for</span> (BeanPostProcessor bp : getBeanPostProcessors()) &#123;<br><span class="hljs-keyword">if</span> (bp <span class="hljs-keyword">instanceof</span> InstantiationAwareBeanPostProcessor) &#123;<br><span class="hljs-type">InstantiationAwareBeanPostProcessor</span> <span class="hljs-variable">ibp</span> <span class="hljs-operator">=</span> (InstantiationAwareBeanPostProcessor) bp;<br><span class="hljs-keyword">if</span> (!ibp.postProcessAfterInstantiation(bw.getWrappedInstance(), beanName)) &#123;<br><span class="hljs-keyword">return</span>;<br>&#125;<br>&#125;<br>&#125;<br>&#125;<br><br><span class="hljs-type">PropertyValues</span> <span class="hljs-variable">pvs</span> <span class="hljs-operator">=</span> (mbd.hasPropertyValues() ? mbd.getPropertyValues() : <span class="hljs-literal">null</span>);<br><br><span class="hljs-comment">//......省略一些代码</span><br><br><span class="hljs-type">boolean</span> <span class="hljs-variable">hasInstAwareBpps</span> <span class="hljs-operator">=</span> hasInstantiationAwareBeanPostProcessors();<br><span class="hljs-type">boolean</span> <span class="hljs-variable">needsDepCheck</span> <span class="hljs-operator">=</span> (mbd.getDependencyCheck() != AbstractBeanDefinition.DEPENDENCY_CHECK_NONE);<br><br>PropertyDescriptor[] filteredPds = <span class="hljs-literal">null</span>;<br><span class="hljs-comment">//重点看这个if代码块，重要程度 5</span><br><span class="hljs-keyword">if</span> (hasInstAwareBpps) &#123;<br><span class="hljs-keyword">if</span> (pvs == <span class="hljs-literal">null</span>) &#123;<br>pvs = mbd.getPropertyValues();<br>&#125;<br><span class="hljs-keyword">for</span> (BeanPostProcessor bp : getBeanPostProcessors()) &#123;<br><span class="hljs-keyword">if</span> (bp <span class="hljs-keyword">instanceof</span> InstantiationAwareBeanPostProcessor) &#123;<br><span class="hljs-type">InstantiationAwareBeanPostProcessor</span> <span class="hljs-variable">ibp</span> <span class="hljs-operator">=</span> (InstantiationAwareBeanPostProcessor) bp;<br><span class="hljs-comment">//依赖注入过程，@Autowired的支持</span><br><span class="hljs-type">PropertyValues</span> <span class="hljs-variable">pvsToUse</span> <span class="hljs-operator">=</span> ibp.postProcessProperties(pvs, bw.getWrappedInstance(), beanName);<br><span class="hljs-keyword">if</span> (pvsToUse == <span class="hljs-literal">null</span>) &#123;<br><span class="hljs-keyword">if</span> (filteredPds == <span class="hljs-literal">null</span>) &#123;<br>filteredPds = filterPropertyDescriptorsForDependencyCheck(bw, mbd.allowCaching);<br>&#125;<br><span class="hljs-comment">//老版本用这个完成依赖注入过程，@Autowired的支持</span><br>pvsToUse = ibp.postProcessPropertyValues(pvs, filteredPds, bw.getWrappedInstance(), beanName);<br><span class="hljs-keyword">if</span> (pvsToUse == <span class="hljs-literal">null</span>) &#123;<br><span class="hljs-keyword">return</span>;<br>&#125;<br>&#125;<br>pvs = pvsToUse;<br>&#125;<br>&#125;<br>&#125;<br><span class="hljs-keyword">if</span> (needsDepCheck) &#123;<br><span class="hljs-keyword">if</span> (filteredPds == <span class="hljs-literal">null</span>) &#123;<br>filteredPds = filterPropertyDescriptorsForDependencyCheck(bw, mbd.allowCaching);<br>&#125;<br>checkDependencies(beanName, mbd, filteredPds, pvs);<br>&#125;<br><br><span class="hljs-comment">//这个方法很鸡肋了，建议不看，是老版本用&lt;property name=&quot;username&quot; value=&quot;Jack&quot;/&gt;</span><br><span class="hljs-comment">//标签做依赖注入的代码实现，复杂且无用</span><br><span class="hljs-keyword">if</span> (pvs != <span class="hljs-literal">null</span>) &#123;<br>applyPropertyValues(beanName, mbd, bw, pvs);<br>&#125;<br>&#125;<br></code></pre></td></tr></table></div></figure><p>依赖注入核心的地方就在这里了</p><figure class="highlight java"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-oqyjkylhkez7dx"></i><span>java</span><div class="collapse show" id="collapse-oqyjkylhkez7dx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//依赖注入过程，@Autowired的支持</span><br><span class="hljs-type">PropertyValues</span> <span class="hljs-variable">pvsToUse</span> <span class="hljs-operator">=</span> ibp.postProcessProperties(pvs, bw.getWrappedInstance(), beanName);<br></code></pre></td></tr></table></div></figure><p>上一章节中，我们已经说到了@Resource@Autowired 注解的收集，那么这个方法就是<br>根据收集到的注解进行<strong>反射调用</strong>，这里以@Autowired 注解的属性为例，注解的方法类似。</p><h3 id="1-1-postProcessProperties"><a href="#1-1-postProcessProperties" class="headerlink" title="1.1.postProcessProperties()"></a>1.1.postProcessProperties()</h3><figure class="highlight java"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-x9afiulhkez7dx"></i><span>java</span><div class="collapse show" id="collapse-x9afiulhkez7dx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//AutowiredAnnotationBeanPostProcessor</span><br><span class="hljs-keyword">public</span> PropertyValues <span class="hljs-title function_">postProcessProperties</span><span class="hljs-params">(PropertyValues pvs, Object bean, String beanName)</span> &#123;<br><span class="hljs-type">InjectionMetadata</span> <span class="hljs-variable">metadata</span> <span class="hljs-operator">=</span> findAutowiringMetadata(beanName, bean.getClass(), pvs);<br><span class="hljs-keyword">try</span> &#123;<br>metadata.inject(bean, beanName, pvs);<br>&#125;<br><span class="hljs-keyword">catch</span> (BeanCreationException ex) &#123;<br><span class="hljs-keyword">throw</span> ex;<br>&#125;<br><span class="hljs-keyword">catch</span> (Throwable ex) &#123;<br><span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BeanCreationException</span>(beanName, <span class="hljs-string">&quot;Injection of autowired dependencies failed&quot;</span>, ex);<br>&#125;<br><span class="hljs-keyword">return</span> pvs;<br>&#125;<br></code></pre></td></tr></table></div></figure><p>核心方法metadata.inject 循环收集到的metaData 中的list 对象，然后挨个调用里面的InjectedElement 的<br>inject 方法完成依赖注入。</p><h3 id="1-2-inject"><a href="#1-2-inject" class="headerlink" title="1.2.inject()"></a>1.2.inject()</h3><figure class="highlight java"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-odrtg8lhkez7dx"></i><span>java</span><div class="collapse show" id="collapse-odrtg8lhkez7dx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//InjectionMetadata</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">inject</span><span class="hljs-params">(Object target, <span class="hljs-meta">@Nullable</span> String beanName, <span class="hljs-meta">@Nullable</span> PropertyValues pvs)</span> <span class="hljs-keyword">throws</span> Throwable &#123;<br>Collection&lt;InjectedElement&gt; checkedElements = <span class="hljs-built_in">this</span>.checkedElements;<br>Collection&lt;InjectedElement&gt; elementsToIterate =<br>(checkedElements != <span class="hljs-literal">null</span> ? checkedElements : <span class="hljs-built_in">this</span>.injectedElements);<br><span class="hljs-keyword">if</span> (!elementsToIterate.isEmpty()) &#123;<br><span class="hljs-keyword">for</span> (InjectedElement element : elementsToIterate) &#123;<br><span class="hljs-keyword">if</span> (logger.isTraceEnabled()) &#123;<br>logger.trace(<span class="hljs-string">&quot;Processing injected element of bean &#x27;&quot;</span> + beanName + <span class="hljs-string">&quot;&#x27;: &quot;</span> + element);<br>&#125;<br><span class="hljs-comment">//通过反射来完成依赖注入调用</span><br>element.inject(target, beanName, pvs);<br>&#125;<br>&#125;<br>&#125;<br><br><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">inject</span><span class="hljs-params">(Object target, <span class="hljs-meta">@Nullable</span> String requestingBeanName, <span class="hljs-meta">@Nullable</span> PropertyValues pvs)</span> <span class="hljs-keyword">throws</span> Throwable &#123;<br><span class="hljs-comment">//属性注入</span><br><span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.isField) &#123;<br><span class="hljs-type">Field</span> <span class="hljs-variable">field</span> <span class="hljs-operator">=</span> (Field) <span class="hljs-built_in">this</span>.member;<br>ReflectionUtils.makeAccessible(field);<br>field.set(target, getResourceToInject(target, requestingBeanName));<br>&#125;<br><span class="hljs-comment">//方法反射调用</span><br><span class="hljs-keyword">else</span> &#123;<br><span class="hljs-keyword">if</span> (checkPropertySkipping(pvs)) &#123;<br><span class="hljs-keyword">return</span>;<br>&#125;<br><span class="hljs-keyword">try</span> &#123;<br><span class="hljs-type">Method</span> <span class="hljs-variable">method</span> <span class="hljs-operator">=</span> (Method) <span class="hljs-built_in">this</span>.member;<br>ReflectionUtils.makeAccessible(method);<br>method.invoke(target, getResourceToInject(target, requestingBeanName));<br>&#125;<br><span class="hljs-keyword">catch</span> (InvocationTargetException ex) &#123;<br><span class="hljs-keyword">throw</span> ex.getTargetException();<br>&#125;<br>&#125;<br>&#125;<br></code></pre></td></tr></table></div></figure><p>通过上述过程对@Autowired 和@Resource 以及@Value 注解修饰的Field 和方法等完成依赖注入。其中value 值的获取，如果依赖的属性是一个引用类型必定会触发该属性的BeanFactory.getBean 操作，从而从spring 容器中获取到对应的实例。方法的依赖注入类似这里就不再赘述，接着上面继续看下getResourceToInject()方法。</p><h3 id="1-3-getResourceToInject-autowireResource"><a href="#1-3-getResourceToInject-autowireResource" class="headerlink" title="1.3.getResourceToInject(), autowireResource()"></a>1.3.getResourceToInject(), autowireResource()</h3><figure class="highlight java"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-d8acmllhkez7dx"></i><span>java</span><div class="collapse show" id="collapse-d8acmllhkez7dx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">protected</span> Object <span class="hljs-title function_">getResourceToInject</span><span class="hljs-params">(Object target, <span class="hljs-meta">@Nullable</span> String requestingBeanName)</span> &#123;<br><span class="hljs-keyword">return</span> (<span class="hljs-built_in">this</span>.lazyLookup ? buildLazyResourceProxy(<span class="hljs-built_in">this</span>, requestingBeanName) :<br>getResource(<span class="hljs-built_in">this</span>, requestingBeanName));<br>&#125;<br><br><span class="hljs-keyword">protected</span> Object <span class="hljs-title function_">getResource</span><span class="hljs-params">(LookupElement element, <span class="hljs-meta">@Nullable</span> String requestingBeanName)</span><br><span class="hljs-keyword">throws</span> NoSuchBeanDefinitionException &#123;<br><br><span class="hljs-keyword">if</span> (StringUtils.hasLength(element.mappedName)) &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.jndiFactory.getBean(element.mappedName, element.lookupType);<br>&#125;<br><span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.alwaysUseJndiLookup) &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.jndiFactory.getBean(element.name, element.lookupType);<br>&#125;<br><span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.resourceFactory == <span class="hljs-literal">null</span>) &#123;<br><span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NoSuchBeanDefinitionException</span>(element.lookupType,<br><span class="hljs-string">&quot;No resource factory configured - specify the &#x27;resourceFactory&#x27; property&quot;</span>);<br>&#125;<br><span class="hljs-comment">//关注这个方法</span><br><span class="hljs-keyword">return</span> autowireResource(<span class="hljs-built_in">this</span>.resourceFactory, element, requestingBeanName);<br>&#125;<br><br><span class="hljs-keyword">protected</span> Object <span class="hljs-title function_">autowireResource</span><span class="hljs-params">(BeanFactory factory, LookupElement element, <span class="hljs-meta">@Nullable</span> String requestingBeanName)</span> <span class="hljs-keyword">throws</span> NoSuchBeanDefinitionException &#123;<br>Object resource;<br>Set&lt;String&gt; autowiredBeanNames;<br><span class="hljs-type">String</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> element.name;<br><span class="hljs-keyword">if</span> (factory <span class="hljs-keyword">instanceof</span> AutowireCapableBeanFactory) &#123;<br><span class="hljs-type">AutowireCapableBeanFactory</span> <span class="hljs-variable">beanFactory</span> <span class="hljs-operator">=</span> (AutowireCapableBeanFactory) factory;<br><span class="hljs-type">DependencyDescriptor</span> <span class="hljs-variable">descriptor</span> <span class="hljs-operator">=</span> element.getDependencyDescriptor();<br><span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.fallbackToDefaultTypeMatch &amp;&amp; element.isDefaultName &amp;&amp; !factory.containsBean(name)) &#123;<br>autowiredBeanNames = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedHashSet</span>&lt;&gt;();<br>resource = beanFactory.resolveDependency(descriptor, requestingBeanName, autowiredBeanNames, <span class="hljs-literal">null</span>);<br><span class="hljs-keyword">if</span> (resource == <span class="hljs-literal">null</span>) &#123;<br><span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NoSuchBeanDefinitionException</span>(element.getLookupType(), <span class="hljs-string">&quot;No resolvable resource object&quot;</span>);<br>&#125;<br>&#125;<br><span class="hljs-keyword">else</span> &#123;<br>resource = beanFactory.resolveBeanByName(name, descriptor);<br>autowiredBeanNames = Collections.singleton(name);<br>&#125;<br>&#125;<br><span class="hljs-keyword">else</span> &#123;<br><span class="hljs-comment">//重点在这里，通过getBean()方式获取依赖所需要的bean</span><br>resource = factory.getBean(name, element.lookupType);<br>autowiredBeanNames = Collections.singleton(name);<br>&#125;<br><br><span class="hljs-keyword">if</span> (factory <span class="hljs-keyword">instanceof</span> ConfigurableBeanFactory) &#123;<br><span class="hljs-type">ConfigurableBeanFactory</span> <span class="hljs-variable">beanFactory</span> <span class="hljs-operator">=</span> (ConfigurableBeanFactory) factory;<br><span class="hljs-keyword">for</span> (String autowiredBeanName : autowiredBeanNames) &#123;<br><span class="hljs-keyword">if</span> (requestingBeanName != <span class="hljs-literal">null</span> &amp;&amp; beanFactory.containsBean(autowiredBeanName)) &#123;<br>beanFactory.registerDependentBean(autowiredBeanName, requestingBeanName);<br>&#125;<br>&#125;<br>&#125;<br><br><span class="hljs-keyword">return</span> resource;<br>&#125;<br></code></pre></td></tr></table></div></figure><p>到此，populateBean()关于bean的依赖属性注入流程跟踪完毕，下一章，我们去跟一下bean的初始化流程，敬请期待哦！^_^</p>]]></content>
    
    
    <categories>
      
      <category>Spring源码学习</category>
      
    </categories>
    
    
    <tags>
      
      <tag>源码</tag>
      
      <tag>Spring</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>【Spring源码学习】Spring Bean实例化过程-创建Bean实例</title>
    <link href="/posts/993655088.html"/>
    <url>/posts/993655088.html</url>
    
    <content type="html"><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><h2 id="Spring-初始化核心流程"><a href="#Spring-初始化核心流程" class="headerlink" title="Spring 初始化核心流程"></a>Spring 初始化核心流程</h2><p>spring容器初始化的核心方法AbstractApplicationContext#refresh，</p><ul><li>refresh Spring 初始化核心流程入口<ul><li>prepareRefresh ① 准备此上下文用于刷新，设置启动时间和active标志，初始化属性</li><li>obtainFreshBeanFactory ② 创建 BeanFactory 已经跟踪过的源码流程</li><li>prepareBeanFactory ③ 设置 BeanFactory 的基本属性</li><li>postProcessBeanFactory ④ 子类处理自定义的BeanFactoryPostProcess</li><li>invokeBeanFactoryPostProcessors ⑤ 调用所有的BeanFactoryPostProcessor</li><li>registerBeanPostProcessors ⑥ 注册，把实现了BeanPostProcessor接口的类实例化，加到BeanFactory</li><li>initMessageSource ⑦ 初始化上下文中的资源文件，如国际化文件的处理等</li><li>initApplicationEventMulticaster ⑧ 初始化上下文的事件传播器</li><li>onRefresh ⑨ 给子类扩展初始化其他Bean，springboot 中用来做内嵌 tomcat 启动</li><li>registerListeners ⑩ 在所有bean中查找监听 bean，然后注册到广播器中</li><li>finishBeanFactoryInitialization <strong>⑪ 本节主要跟踪的源码流程</strong></li><li>finishRefresh ⑫ 完成刷新过程，发布相应的事件</li></ul></li></ul><h1 id="一、Bean实例化流程"><a href="#一、Bean实例化流程" class="headerlink" title="一、Bean实例化流程"></a>一、Bean实例化流程</h1><p>总体上，Bean实例化流程主要有三个步骤：</p><ul><li>创建Bean实例</li><li>属性注入</li><li>Bean初始化</li></ul><p>本章主要是讲创建Bean实例的过程，我分为两个部分：一是构造函数的选取，二是依赖注入相关的注解扫描.</p><h1 id="二、时序图"><a href="#二、时序图" class="headerlink" title="二、时序图"></a>二、时序图</h1><p><img src="https://img-blog.csdnimg.cn/20210411112559829.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2tlemFkZQ==,size_16,color_FFFFFF,t_70#pic_center"></p><h1 id="三、源码跟踪"><a href="#三、源码跟踪" class="headerlink" title="三、源码跟踪"></a>三、源码跟踪</h1><h2 id="1-finishBeanFactoryInitialization"><a href="#1-finishBeanFactoryInitialization" class="headerlink" title="1.finishBeanFactoryInitialization()"></a>1.finishBeanFactoryInitialization()</h2><p>点进去看看finishBeanFactoryInitialization()方法</p><figure class="highlight java"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-l4py4mlhkez7dx"></i><span>java</span><div class="collapse show" id="collapse-l4py4mlhkez7dx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 这个方法是spring中最重要的方法，没有之一</span><br><span class="hljs-comment"> * 所以这个方法一定要理解要具体看</span><br><span class="hljs-comment"> * 1、bean实例化过程</span><br><span class="hljs-comment"> * 2、ioc</span><br><span class="hljs-comment"> * 3、注解支持</span><br><span class="hljs-comment"> * 4、BeanPostProcessor的执行</span><br><span class="hljs-comment"> * 5、Aop的入口</span><br><span class="hljs-comment"> * */</span><br><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">finishBeanFactoryInitialization</span><span class="hljs-params">(ConfigurableListableBeanFactory beanFactory)</span> &#123;<br><span class="hljs-comment">// Initialize conversion service for this context.</span><br><span class="hljs-comment">//设置类型转换器</span><br><span class="hljs-keyword">if</span> (beanFactory.containsBean(CONVERSION_SERVICE_BEAN_NAME) &amp;&amp;<br>beanFactory.isTypeMatch(CONVERSION_SERVICE_BEAN_NAME, ConversionService.class)) &#123;<br>beanFactory.setConversionService(<br>beanFactory.getBean(CONVERSION_SERVICE_BEAN_NAME, ConversionService.class));<br>&#125;<br><br><span class="hljs-comment">// Register a default embedded value resolver if no bean post-processor</span><br><span class="hljs-comment">// (such as a PropertyPlaceholderConfigurer bean) registered any before:</span><br><span class="hljs-comment">// at this point, primarily for resolution in annotation attribute values.</span><br><span class="hljs-comment">//暂时不要看</span><br><span class="hljs-keyword">if</span> (!beanFactory.hasEmbeddedValueResolver()) &#123;<br>beanFactory.addEmbeddedValueResolver(strVal -&gt; getEnvironment().resolvePlaceholders(strVal));<br>&#125;<br><br><span class="hljs-comment">// Initialize LoadTimeWeaverAware beans early to allow for registering their transformers early.</span><br><span class="hljs-comment">//暂时不看</span><br>String[] weaverAwareNames = beanFactory.getBeanNamesForType(LoadTimeWeaverAware.class, <span class="hljs-literal">false</span>, <span class="hljs-literal">false</span>);<br><span class="hljs-keyword">for</span> (String weaverAwareName : weaverAwareNames) &#123;<br>getBean(weaverAwareName);<br>&#125;<br><br><span class="hljs-comment">// Stop using the temporary ClassLoader for type matching.</span><br>beanFactory.setTempClassLoader(<span class="hljs-literal">null</span>);<br><br><span class="hljs-comment">// Allow for caching all bean definition metadata, not expecting further changes.</span><br>beanFactory.freezeConfiguration();<br><br><span class="hljs-comment">//重点看这个方法，重要程度：5</span><br><span class="hljs-comment">// Instantiate all remaining (non-lazy-init) singletons.</span><br>beanFactory.preInstantiateSingletons();<br>&#125;<br></code></pre></td></tr></table></div></figure><p>重点关注这个方法的处理beanFactory.preInstantiateSingletons()</p><h2 id="2-preInstantiateSingletons"><a href="#2-preInstantiateSingletons" class="headerlink" title="2.preInstantiateSingletons()"></a>2.preInstantiateSingletons()</h2><figure class="highlight java"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-6sx8mqlhkez7dx"></i><span>java</span><div class="collapse show" id="collapse-6sx8mqlhkez7dx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * 具体实例化过程</span><br><span class="hljs-comment"> * */</span><br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">preInstantiateSingletons</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> BeansException &#123;<br><span class="hljs-keyword">if</span> (logger.isTraceEnabled()) &#123;<br>logger.trace(<span class="hljs-string">&quot;Pre-instantiating singletons in &quot;</span> + <span class="hljs-built_in">this</span>);<br>&#125;<br><span class="hljs-comment">// Iterate over a copy to allow for init methods which in turn register new bean definitions.</span><br><span class="hljs-comment">// While this may not be part of the regular factory bootstrap, it does otherwise work fine.</span><br><span class="hljs-comment">//xml解析时，讲过，把所有beanName都缓存到beanDefinitionNames了</span><br>List&lt;String&gt; beanNames = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;(<span class="hljs-built_in">this</span>.beanDefinitionNames);<br><span class="hljs-comment">// Trigger initialization of all non-lazy singleton beans...</span><br><span class="hljs-keyword">for</span> (String beanName : beanNames) &#123;<br><span class="hljs-comment">//把父BeanDefinition里面的属性拿到子BeanDefinition中</span><br><span class="hljs-type">RootBeanDefinition</span> <span class="hljs-variable">bd</span> <span class="hljs-operator">=</span> getMergedLocalBeanDefinition(beanName);<br><span class="hljs-comment">//如果不是抽象的，单例的，非懒加载的就实例化</span><br><span class="hljs-keyword">if</span> (!bd.isAbstract() &amp;&amp; bd.isSingleton() &amp;&amp; !bd.isLazyInit()) &#123;<br><span class="hljs-comment">//判断bean是否实现了FactoryBean接口，这里可以不看  &amp;factoryBeanDemo</span><br><span class="hljs-keyword">if</span> (isFactoryBean(beanName)) &#123;<br><span class="hljs-type">Object</span> <span class="hljs-variable">bean</span> <span class="hljs-operator">=</span> getBean(FACTORY_BEAN_PREFIX + beanName);<br><span class="hljs-keyword">if</span> (bean <span class="hljs-keyword">instanceof</span> FactoryBean) &#123;<br>FactoryBean&lt;?&gt; factory = (FactoryBean&lt;?&gt;) bean;<br><span class="hljs-type">boolean</span> isEagerInit;<br><span class="hljs-keyword">if</span> (System.getSecurityManager() != <span class="hljs-literal">null</span> &amp;&amp; factory <span class="hljs-keyword">instanceof</span> SmartFactoryBean) &#123;<br>isEagerInit = AccessController.doPrivileged(<br>(PrivilegedAction&lt;Boolean&gt;) ((SmartFactoryBean&lt;?&gt;) factory)::isEagerInit,<br>getAccessControlContext());<br>&#125;<br><span class="hljs-keyword">else</span> &#123;<br>isEagerInit = (factory <span class="hljs-keyword">instanceof</span> SmartFactoryBean &amp;&amp;<br>((SmartFactoryBean&lt;?&gt;) factory).isEagerInit());<br>&#125;<br><span class="hljs-keyword">if</span> (isEagerInit) &#123;<br>getBean(beanName);<br>&#125;<br>&#125;<br>&#125;<br><span class="hljs-keyword">else</span> &#123;<br><span class="hljs-comment">//主要从这里进入，看看实例化过程</span><br>getBean(beanName);<br>&#125;<br>&#125;<br>&#125;<br><br><span class="hljs-comment">// Trigger post-initialization callback for all applicable beans...</span><br><span class="hljs-keyword">for</span> (String beanName : beanNames) &#123;<br><span class="hljs-type">Object</span> <span class="hljs-variable">singletonInstance</span> <span class="hljs-operator">=</span> getSingleton(beanName);<br><span class="hljs-keyword">if</span> (singletonInstance <span class="hljs-keyword">instanceof</span> SmartInitializingSingleton) &#123;<br><span class="hljs-type">SmartInitializingSingleton</span> <span class="hljs-variable">smartSingleton</span> <span class="hljs-operator">=</span> (SmartInitializingSingleton) singletonInstance;<br><span class="hljs-keyword">if</span> (System.getSecurityManager() != <span class="hljs-literal">null</span>) &#123;<br>AccessController.doPrivileged((PrivilegedAction&lt;Object&gt;) () -&gt; &#123;<br>smartSingleton.afterSingletonsInstantiated();<br><span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>&#125;, getAccessControlContext());<br>&#125;<br><span class="hljs-keyword">else</span> &#123;<br>smartSingleton.afterSingletonsInstantiated();<br>&#125;<br>&#125;<br>&#125;<br>&#125;<br></code></pre></td></tr></table></div></figure><h2 id="3-getBean-doGetBean"><a href="#3-getBean-doGetBean" class="headerlink" title="3.getBean(),doGetBean()"></a>3.getBean(),doGetBean()</h2><p>这里不看factoryBean的实例化，我这里关注getBean(beanname)方法，另外先注意一下bean实例化的条件</p><ul><li>不是抽象的</li><li>单例的</li><li>非懒加载的</li></ul><figure class="highlight java"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-ti8u7hlhkez7dx"></i><span>java</span><div class="collapse show" id="collapse-ti8u7hlhkez7dx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//AbstractBeanFactory</span><br><span class="hljs-keyword">public</span> Object <span class="hljs-title function_">getBean</span><span class="hljs-params">(String name)</span> <span class="hljs-keyword">throws</span> BeansException &#123;<br><span class="hljs-keyword">return</span> doGetBean(name, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>, <span class="hljs-literal">false</span>);<br>&#125;<br><br><span class="hljs-keyword">protected</span> &lt;T&gt; T <span class="hljs-title function_">doGetBean</span><span class="hljs-params">(</span><br><span class="hljs-params">String name, <span class="hljs-meta">@Nullable</span> Class&lt;T&gt; requiredType, <span class="hljs-meta">@Nullable</span> Object[] args, <span class="hljs-type">boolean</span> typeCheckOnly)</span><br><span class="hljs-keyword">throws</span> BeansException &#123;<br><span class="hljs-comment">// 获取一个beanName，处理两种情况，一个是前面说的 FactoryBean (前面带 &#x27;&amp;&#x27;)，</span><br><span class="hljs-comment">// 一个是别名问题，因为这个方法是 getBean，获取 Bean 用的，你要是传一个别名进来，是完全可以的</span><br><span class="hljs-type">String</span> <span class="hljs-variable">beanName</span> <span class="hljs-operator">=</span> transformedBeanName(name);<br>Object bean;<br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * Description : 检查缓存中或者实例工厂中是否有对应的实例</span><br><span class="hljs-comment"> * 因为在创建单例 bean的时候会存在依赖注入，而在创建依赖的时候为了避免循环依赖，</span><br><span class="hljs-comment"> * spring创建bean的原则是：不等 bean 创建完成就将创建bean的 ObjectFactory 提早曝光，</span><br><span class="hljs-comment"> *  换句话说，也就是将 ObjectFactory 加入到缓存中，一旦下一个bean创建的时候需要依赖上</span><br><span class="hljs-comment"> *  一个bean则直接使用 ObjectFactory</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> *  第一次getSingleton(beanName)</span><br><span class="hljs-comment"> */</span><br><span class="hljs-comment">// Eagerly check singleton cache for manually registered singletons.</span><br><span class="hljs-type">Object</span> <span class="hljs-variable">sharedInstance</span> <span class="hljs-operator">=</span> getSingleton(beanName);<br><span class="hljs-comment">//如果缓存里面能拿到实例</span><br><span class="hljs-keyword">if</span> (sharedInstance != <span class="hljs-literal">null</span> &amp;&amp; args == <span class="hljs-literal">null</span>) &#123;<br><span class="hljs-keyword">if</span> (logger.isTraceEnabled()) &#123;<br><span class="hljs-keyword">if</span> (isSingletonCurrentlyInCreation(beanName)) &#123;<br>logger.trace(<span class="hljs-string">&quot;Returning eagerly cached instance of singleton bean &#x27;&quot;</span> + beanName +<br><span class="hljs-string">&quot;&#x27; that is not fully initialized yet - a consequence of a circular reference&quot;</span>);<br>&#125;<br><span class="hljs-keyword">else</span> &#123;<br>logger.trace(<span class="hljs-string">&quot;Returning cached instance of singleton bean &#x27;&quot;</span> + beanName + <span class="hljs-string">&quot;&#x27;&quot;</span>);<br>&#125;<br>&#125;<br><span class="hljs-comment">// 该方法是 FactoryBean 接口的调用入口</span><br><span class="hljs-comment">// 如果是普通 Bean 的话，直接返回 sharedInstance（直接返回对象本身）</span><br><span class="hljs-comment">// 如果是 FactoryBean 的话，返回它创建的那个实例对象(返回指定方法返回的实例)</span><br>bean = getObjectForBeanInstance(sharedInstance, name, beanName, <span class="hljs-literal">null</span>);<br>&#125;<br><br><span class="hljs-keyword">else</span> &#123;<br><span class="hljs-comment">//如果singletonObjects缓存里面没有，则走下来</span><br><span class="hljs-comment">// Fail if we&#x27;re already creating this bean instance:</span><br><span class="hljs-comment">// We&#x27;re assembly within a circular reference.</span><br><span class="hljs-comment">//如果是scope 是Prototype的，校验是否有出现循环依赖，如果有则直接报错</span><br><span class="hljs-keyword">if</span> (isPrototypeCurrentlyInCreation(beanName)) &#123;<br><span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BeanCurrentlyInCreationException</span>(beanName);<br>&#125;<br><br><span class="hljs-comment">// Check if bean definition exists in this factory.</span><br><span class="hljs-comment">//检查一下这个 BeanDefinition 在容器中是否存在</span><br><span class="hljs-type">BeanFactory</span> <span class="hljs-variable">parentBeanFactory</span> <span class="hljs-operator">=</span> getParentBeanFactory();<br><span class="hljs-keyword">if</span> (parentBeanFactory != <span class="hljs-literal">null</span> &amp;&amp; !containsBeanDefinition(beanName)) &#123;<br><span class="hljs-comment">// Not found -&gt; check parent.</span><br><span class="hljs-comment">// 如果当前容器不存在这个 BeanDefinition，试试父容器中有没有</span><br><span class="hljs-type">String</span> <span class="hljs-variable">nameToLookup</span> <span class="hljs-operator">=</span> originalBeanName(name);<br><span class="hljs-keyword">if</span> (parentBeanFactory <span class="hljs-keyword">instanceof</span> AbstractBeanFactory) &#123;<br><span class="hljs-keyword">return</span> ((AbstractBeanFactory) parentBeanFactory).doGetBean(<br>nameToLookup, requiredType, args, typeCheckOnly);<br>&#125;<br><span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (args != <span class="hljs-literal">null</span>) &#123;<br><span class="hljs-comment">// Delegation to parent with explicit args.</span><br><span class="hljs-keyword">return</span> (T) parentBeanFactory.getBean(nameToLookup, args);<br>&#125;<br><span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (requiredType != <span class="hljs-literal">null</span>) &#123;<br><span class="hljs-comment">// No args -&gt; delegate to standard getBean method.</span><br><span class="hljs-keyword">return</span> parentBeanFactory.getBean(nameToLookup, requiredType);<br>&#125;<br><span class="hljs-keyword">else</span> &#123;<br><span class="hljs-keyword">return</span> (T) parentBeanFactory.getBean(nameToLookup);<br>&#125;<br>&#125;<br><span class="hljs-comment">// typeCheckOnly 为 false，将当前 beanName 放入一个 alreadyCreated 的 Set 集合中。</span><br><span class="hljs-comment">// 如果不是仅仅做类型检查而是创建bean，则进行记录</span><br><span class="hljs-keyword">if</span> (!typeCheckOnly) &#123;<br>markBeanAsCreated(beanName);<br>&#125;<br><span class="hljs-comment">//要开始创建bean了，分两种情况：一种是针对单例的（singleton），一种是针对多例的（prototype），一种是自定义scope的</span><br><span class="hljs-keyword">try</span> &#123;<br><span class="hljs-comment">//父子BeanDefinition合并</span><br><span class="hljs-type">RootBeanDefinition</span> <span class="hljs-variable">mbd</span> <span class="hljs-operator">=</span> getMergedLocalBeanDefinition(beanName);<br>checkMergedBeanDefinition(mbd, beanName, args);<br><span class="hljs-comment">//获取依赖对象属性，依赖对象要先实例化</span><br><span class="hljs-comment">// Guarantee initialization of beans that the current bean depends on.</span><br>String[] dependsOn = mbd.getDependsOn();<br><span class="hljs-keyword">if</span> (dependsOn != <span class="hljs-literal">null</span>) &#123;<br><span class="hljs-keyword">for</span> (String dep : dependsOn) &#123;<br><span class="hljs-keyword">if</span> (isDependent(beanName, dep)) &#123;<br><span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BeanCreationException</span>(mbd.getResourceDescription(), beanName,<br><span class="hljs-string">&quot;Circular depends-on relationship between &#x27;&quot;</span> + beanName + <span class="hljs-string">&quot;&#x27; and &#x27;&quot;</span> + dep + <span class="hljs-string">&quot;&#x27;&quot;</span>);<br>&#125;<br>registerDependentBean(dep, beanName);<br><span class="hljs-keyword">try</span> &#123;<br><span class="hljs-comment">//实例化</span><br>getBean(dep);<br>&#125;<br><span class="hljs-keyword">catch</span> (NoSuchBeanDefinitionException ex) &#123;<br><span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BeanCreationException</span>(mbd.getResourceDescription(), beanName,<br><span class="hljs-string">&quot;&#x27;&quot;</span> + beanName + <span class="hljs-string">&quot;&#x27; depends on missing bean &#x27;&quot;</span> + dep + <span class="hljs-string">&quot;&#x27;&quot;</span>, ex);<br>&#125;<br>&#125;<br>&#125;<br><span class="hljs-comment">//单例情况singleton，着重看，大部分是单例的情况</span><br><span class="hljs-comment">// Create bean instance.</span><br><span class="hljs-keyword">if</span> (mbd.isSingleton()) &#123;<br><span class="hljs-comment">//第二次getSingleton(beanName, singletonFactory)</span><br>sharedInstance = getSingleton(beanName, () -&gt; &#123;<br><span class="hljs-keyword">try</span> &#123;<br><span class="hljs-keyword">return</span> createBean(beanName, mbd, args);<br>&#125;<br><span class="hljs-keyword">catch</span> (BeansException ex) &#123;<br><span class="hljs-comment">// Explicitly remove instance from singleton cache: It might have been put there</span><br><span class="hljs-comment">// eagerly by the creation process, to allow for circular reference resolution.</span><br><span class="hljs-comment">// Also remove any beans that received a temporary reference to the bean.</span><br>destroySingleton(beanName);<br><span class="hljs-keyword">throw</span> ex;<br>&#125;<br>&#125;);<br><span class="hljs-comment">//该方法是FactoryBean接口的调用入口</span><br>bean = getObjectForBeanInstance(sharedInstance, name, beanName, mbd);<br>&#125;<br><span class="hljs-comment">//多例情况prototype</span><br><span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (mbd.isPrototype()) &#123;<br><span class="hljs-comment">// It&#x27;s a prototype -&gt; create a new instance.</span><br><span class="hljs-type">Object</span> <span class="hljs-variable">prototypeInstance</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br><span class="hljs-keyword">try</span> &#123;<br>beforePrototypeCreation(beanName);<br>prototypeInstance = createBean(beanName, mbd, args);<br>&#125;<br><span class="hljs-keyword">finally</span> &#123;<br>afterPrototypeCreation(beanName);<br>&#125;<br><span class="hljs-comment">//该方法是FactoryBean接口的调用入口</span><br>bean = getObjectForBeanInstance(prototypeInstance, name, beanName, mbd);<br>&#125;<br><span class="hljs-comment">// 如果不是 singleton 和 prototype 的话，需要委托给相应的实现类来处理</span><br><span class="hljs-keyword">else</span> &#123;<br><span class="hljs-type">String</span> <span class="hljs-variable">scopeName</span> <span class="hljs-operator">=</span> mbd.getScope();<br><span class="hljs-keyword">if</span> (!StringUtils.hasLength(scopeName)) &#123;<br><span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalStateException</span>(<span class="hljs-string">&quot;No scope name defined for bean ´&quot;</span> + beanName + <span class="hljs-string">&quot;&#x27;&quot;</span>);<br>&#125;<br><span class="hljs-type">Scope</span> <span class="hljs-variable">scope</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.scopes.get(scopeName);<br><span class="hljs-keyword">if</span> (scope == <span class="hljs-literal">null</span>) &#123;<br><span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalStateException</span>(<span class="hljs-string">&quot;No Scope registered for scope name &#x27;&quot;</span> + scopeName + <span class="hljs-string">&quot;&#x27;&quot;</span>);<br>&#125;<br><span class="hljs-keyword">try</span> &#123;<br><span class="hljs-type">Object</span> <span class="hljs-variable">scopedInstance</span> <span class="hljs-operator">=</span> scope.get(beanName, () -&gt; &#123;<br>beforePrototypeCreation(beanName);<br><span class="hljs-keyword">try</span> &#123;<br><span class="hljs-keyword">return</span> createBean(beanName, mbd, args);<br>&#125;<br><span class="hljs-keyword">finally</span> &#123;<br>afterPrototypeCreation(beanName);<br>&#125;<br>&#125;);<br>bean = getObjectForBeanInstance(scopedInstance, name, beanName, mbd);<br>&#125;<br><span class="hljs-keyword">catch</span> (IllegalStateException ex) &#123;<br><span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BeanCreationException</span>(beanName,<br><span class="hljs-string">&quot;Scope &#x27;&quot;</span> + scopeName + <span class="hljs-string">&quot;&#x27; is not active for the current thread; consider &quot;</span> +<br><span class="hljs-string">&quot;defining a scoped proxy for this bean if you intend to refer to it from a singleton&quot;</span>,<br>ex);<br>&#125;<br>&#125;<br>&#125;<br><span class="hljs-keyword">catch</span> (BeansException ex) &#123;<br>cleanupAfterBeanCreationFailure(beanName);<br><span class="hljs-keyword">throw</span> ex;<br>&#125;<br>&#125;<br><br><span class="hljs-comment">// Check if required type matches the type of the actual bean instance.</span><br><span class="hljs-comment">// 最后，检查一下类型对不对，不对的话就抛异常，对的话就返回</span><br><span class="hljs-keyword">if</span> (requiredType != <span class="hljs-literal">null</span> &amp;&amp; !requiredType.isInstance(bean)) &#123;<br><span class="hljs-keyword">try</span> &#123;<br><span class="hljs-type">T</span> <span class="hljs-variable">convertedBean</span> <span class="hljs-operator">=</span> getTypeConverter().convertIfNecessary(bean, requiredType);<br><span class="hljs-keyword">if</span> (convertedBean == <span class="hljs-literal">null</span>) &#123;<br><span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BeanNotOfRequiredTypeException</span>(name, requiredType, bean.getClass());<br>&#125;<br><span class="hljs-keyword">return</span> convertedBean;<br>&#125;<br><span class="hljs-keyword">catch</span> (TypeMismatchException ex) &#123;<br><span class="hljs-keyword">if</span> (logger.isTraceEnabled()) &#123;<br>logger.trace(<span class="hljs-string">&quot;Failed to convert bean &#x27;&quot;</span> + name + <span class="hljs-string">&quot;&#x27; to required type &#x27;&quot;</span> +<br>ClassUtils.getQualifiedName(requiredType) + <span class="hljs-string">&quot;&#x27;&quot;</span>, ex);<br>&#125;<br><span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BeanNotOfRequiredTypeException</span>(name, requiredType, bean.getClass());<br>&#125;<br>&#125;<br><span class="hljs-keyword">return</span> (T) bean;<br>&#125;<br></code></pre></td></tr></table></div></figure><h2 id="4-getSingleton"><a href="#4-getSingleton" class="headerlink" title="4.getSingleton()"></a>4.getSingleton()</h2><p>我们先看看两次调用getSingleton()的两个重载方法<br>第一次调用</p><figure class="highlight java"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-9p509xlhkez7dx"></i><span>java</span><div class="collapse show" id="collapse-9p509xlhkez7dx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> Object <span class="hljs-title function_">getSingleton</span><span class="hljs-params">(String beanName)</span> &#123;<br><span class="hljs-keyword">return</span> getSingleton(beanName, <span class="hljs-literal">true</span>);<br>&#125;<br><br><span class="hljs-keyword">protected</span> Object <span class="hljs-title function_">getSingleton</span><span class="hljs-params">(String beanName, <span class="hljs-type">boolean</span> allowEarlyReference)</span> &#123;<br><span class="hljs-comment">//根据beanName从缓存中拿实例</span><br><span class="hljs-comment">//先从一级缓存拿</span><br><span class="hljs-type">Object</span> <span class="hljs-variable">singletonObject</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.singletonObjects.get(beanName);<br><span class="hljs-comment">//如果bean还正在创建，还没创建完成，其实就是堆内存有了，属性还没有DI依赖注入</span><br><span class="hljs-keyword">if</span> (singletonObject == <span class="hljs-literal">null</span> &amp;&amp; isSingletonCurrentlyInCreation(beanName)) &#123;<br><span class="hljs-keyword">synchronized</span> (<span class="hljs-built_in">this</span>.singletonObjects) &#123;<br><span class="hljs-comment">//从二级缓存中拿</span><br>singletonObject = <span class="hljs-built_in">this</span>.earlySingletonObjects.get(beanName);<br><span class="hljs-comment">//如果还拿不到，并且允许bean提前暴露</span><br><span class="hljs-keyword">if</span> (singletonObject == <span class="hljs-literal">null</span> &amp;&amp; allowEarlyReference) &#123;<br><span class="hljs-comment">//从三级缓存中拿到对象工厂</span><br>ObjectFactory&lt;?&gt; singletonFactory = <span class="hljs-built_in">this</span>.singletonFactories.get(beanName);<br><span class="hljs-keyword">if</span> (singletonFactory != <span class="hljs-literal">null</span>) &#123;<br><span class="hljs-comment">//从工厂中拿到对象</span><br>singletonObject = singletonFactory.getObject();<br><span class="hljs-comment">//升级到二级缓存</span><br><span class="hljs-built_in">this</span>.earlySingletonObjects.put(beanName, singletonObject);<br><span class="hljs-comment">//删除三级缓存</span><br><span class="hljs-built_in">this</span>.singletonFactories.remove(beanName);<br>&#125;<br>&#125;<br>&#125;<br>&#125;<br><span class="hljs-keyword">return</span> singletonObject;<br>&#125;<br></code></pre></td></tr></table></div></figure><p>这次的调用缓存里都是没有的，三级缓存的设计是为了解决循环依赖和AOP代理的问题，这个在后面详说。<br>第二次调用</p><figure class="highlight java"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-w4rsz4lhkez7dx"></i><span>java</span><div class="collapse show" id="collapse-w4rsz4lhkez7dx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> Object <span class="hljs-title function_">getSingleton</span><span class="hljs-params">(String beanName, ObjectFactory&lt;?&gt; singletonFactory)</span> &#123;<br>Assert.notNull(beanName, <span class="hljs-string">&quot;Bean name must not be null&quot;</span>);<br><span class="hljs-keyword">synchronized</span> (<span class="hljs-built_in">this</span>.singletonObjects) &#123;<br><span class="hljs-comment">//如果缓存中有，则直接返回</span><br><span class="hljs-type">Object</span> <span class="hljs-variable">singletonObject</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.singletonObjects.get(beanName);<br><span class="hljs-keyword">if</span> (singletonObject == <span class="hljs-literal">null</span>) &#123;<br><span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.singletonsCurrentlyInDestruction) &#123;<br><span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BeanCreationNotAllowedException</span>(beanName,<br><span class="hljs-string">&quot;Singleton bean creation not allowed while singletons of this factory are in destruction &quot;</span> +<br><span class="hljs-string">&quot;(Do not request a bean from a BeanFactory in a destroy method implementation!)&quot;</span>);<br>&#125;<br><span class="hljs-keyword">if</span> (logger.isDebugEnabled()) &#123;<br>logger.debug(<span class="hljs-string">&quot;Creating shared instance of singleton bean &#x27;&quot;</span> + beanName + <span class="hljs-string">&quot;&#x27;&quot;</span>);<br>&#125;<br><span class="hljs-comment">//把beanName添加到singletonsCurrentlyInCreation Set容器中，在这个集合里面的bean都是正在实例化的bean</span><br>beforeSingletonCreation(beanName);<br><span class="hljs-type">boolean</span> <span class="hljs-variable">newSingleton</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;<br><span class="hljs-type">boolean</span> <span class="hljs-variable">recordSuppressedExceptions</span> <span class="hljs-operator">=</span> (<span class="hljs-built_in">this</span>.suppressedExceptions == <span class="hljs-literal">null</span>);<br><span class="hljs-keyword">if</span> (recordSuppressedExceptions) &#123;<br><span class="hljs-built_in">this</span>.suppressedExceptions = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedHashSet</span>&lt;&gt;();<br>&#125;<br><span class="hljs-keyword">try</span> &#123;<br><span class="hljs-comment">//如果这里有返回值，就代表这个bean已经结束创建了，已经完全创建成功</span><br>singletonObject = singletonFactory.getObject();<br>newSingleton = <span class="hljs-literal">true</span>;<br>&#125;<br><span class="hljs-keyword">catch</span> (IllegalStateException ex) &#123;<br><span class="hljs-comment">// Has the singleton object implicitly appeared in the meantime -&gt;</span><br><span class="hljs-comment">// if yes, proceed with it since the exception indicates that state.</span><br>singletonObject = <span class="hljs-built_in">this</span>.singletonObjects.get(beanName);<br><span class="hljs-keyword">if</span> (singletonObject == <span class="hljs-literal">null</span>) &#123;<br><span class="hljs-keyword">throw</span> ex;<br>&#125;<br>&#125;<br><span class="hljs-keyword">catch</span> (BeanCreationException ex) &#123;<br><span class="hljs-keyword">if</span> (recordSuppressedExceptions) &#123;<br><span class="hljs-keyword">for</span> (Exception suppressedException : <span class="hljs-built_in">this</span>.suppressedExceptions) &#123;<br>ex.addRelatedCause(suppressedException);<br>&#125;<br>&#125;<br><span class="hljs-keyword">throw</span> ex;<br>&#125;<br><span class="hljs-keyword">finally</span> &#123;<br><span class="hljs-keyword">if</span> (recordSuppressedExceptions) &#123;<br><span class="hljs-built_in">this</span>.suppressedExceptions = <span class="hljs-literal">null</span>;<br>&#125;<br><span class="hljs-comment">//bean创建完成后singletonsCurrentlyInCreation要删除该bean</span><br>afterSingletonCreation(beanName);<br>&#125;<br><span class="hljs-keyword">if</span> (newSingleton) &#123;<br><span class="hljs-comment">//创建对象成功时，把对象缓存到singletonObjects缓存中,bean创建完成时放入一级缓存</span><br>addSingleton(beanName, singletonObject);<br>&#125;<br>&#125;<br><span class="hljs-keyword">return</span> singletonObject;<br>&#125;<br>&#125;<br></code></pre></td></tr></table></div></figure><p>这里总结一下流程</p><ul><li>把beanName添加到singletonsCurrentlyInCreation Set容器中（其中这个在循环依赖时三级缓存会用到）</li><li>singletonFactory.getObject()：这个就会调用到外层Lambda表达式中实现getObject()的业务方法，即createBean()方法，就是这个<figure class="highlight java"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-fz4b15lhkez7dx"></i><span>java</span><div class="collapse show" id="collapse-fz4b15lhkez7dx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java">() -&gt; &#123;<br><span class="hljs-keyword">try</span> &#123;<br><span class="hljs-keyword">return</span> createBean(beanName, mbd, args);<br>&#125;<br>......此处省略一万字的代码。^_^<br></code></pre></td></tr></table></div></figure></li><li>bean创建成功（完整的bean），从singletonsCurrentlyInCreation删除</li><li>将bean添加至一级缓存中</li></ul><h2 id="5-createBean"><a href="#5-createBean" class="headerlink" title="5.createBean()"></a>5.createBean()</h2><p>好，进去看看createBean方法</p><figure class="highlight java"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-5zk51elhkez7dx"></i><span>java</span><div class="collapse show" id="collapse-5zk51elhkez7dx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">protected</span> Object <span class="hljs-title function_">createBean</span><span class="hljs-params">(String beanName, RootBeanDefinition mbd, <span class="hljs-meta">@Nullable</span> Object[] args)</span><br><span class="hljs-keyword">throws</span> BeanCreationException &#123;<br><span class="hljs-keyword">if</span> (logger.isTraceEnabled()) &#123;<br>logger.trace(<span class="hljs-string">&quot;Creating instance of bean &#x27;&quot;</span> + beanName + <span class="hljs-string">&quot;&#x27;&quot;</span>);<br>&#125;<br><span class="hljs-type">RootBeanDefinition</span> <span class="hljs-variable">mbdToUse</span> <span class="hljs-operator">=</span> mbd;<br><span class="hljs-comment">// Make sure bean class is actually resolved at this point, and</span><br><span class="hljs-comment">// clone the bean definition in case of a dynamically resolved Class</span><br><span class="hljs-comment">// which cannot be stored in the shared merged bean definition.</span><br>Class&lt;?&gt; resolvedClass = resolveBeanClass(mbd, beanName);<br><span class="hljs-keyword">if</span> (resolvedClass != <span class="hljs-literal">null</span> &amp;&amp; !mbd.hasBeanClass() &amp;&amp; mbd.getBeanClassName() != <span class="hljs-literal">null</span>) &#123;<br>mbdToUse = <span class="hljs-keyword">new</span> <span class="hljs-title class_">RootBeanDefinition</span>(mbd);<br>mbdToUse.setBeanClass(resolvedClass);<br>&#125;<br><span class="hljs-comment">// Prepare method overrides.</span><br><span class="hljs-keyword">try</span> &#123;<br>mbdToUse.prepareMethodOverrides();<br>&#125;<br><span class="hljs-keyword">catch</span> (BeanDefinitionValidationException ex) &#123;<br><span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BeanDefinitionStoreException</span>(mbdToUse.getResourceDescription(),<br>beanName, <span class="hljs-string">&quot;Validation of method overrides failed&quot;</span>, ex);<br>&#125;<br><br><span class="hljs-keyword">try</span> &#123;<br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * TargetSource接口的运用，可以在用改一个类实现该接口，然后在里面定义实例化对象的方式，然后返回</span><br><span class="hljs-comment"> * 也就是说不需要spring帮助我们实例化对象</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * 这里可以直接返回实例本身</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * 这个代码不用看，实际开发过程中用不到，我会做为一个甜点分享</span><br><span class="hljs-comment"> * */</span><br><span class="hljs-comment">// Give BeanPostProcessors a chance to return a proxy instead of the target bean instance.</span><br><span class="hljs-type">Object</span> <span class="hljs-variable">bean</span> <span class="hljs-operator">=</span> resolveBeforeInstantiation(beanName, mbdToUse);<br><span class="hljs-keyword">if</span> (bean != <span class="hljs-literal">null</span>) &#123;<br><span class="hljs-keyword">return</span> bean;<br>&#125;<br>&#125;<br><span class="hljs-keyword">catch</span> (Throwable ex) &#123;<br><span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BeanCreationException</span>(mbdToUse.getResourceDescription(), beanName,<br><span class="hljs-string">&quot;BeanPostProcessor before instantiation of bean failed&quot;</span>, ex);<br>&#125;<br><br><span class="hljs-keyword">try</span> &#123;<br><span class="hljs-comment">//主要看这个方法，重要程度 5</span><br><span class="hljs-type">Object</span> <span class="hljs-variable">beanInstance</span> <span class="hljs-operator">=</span> doCreateBean(beanName, mbdToUse, args);<br><span class="hljs-keyword">if</span> (logger.isTraceEnabled()) &#123;<br>logger.trace(<span class="hljs-string">&quot;Finished creating instance of bean &#x27;&quot;</span> + beanName + <span class="hljs-string">&quot;&#x27;&quot;</span>);<br>&#125;<br><span class="hljs-keyword">return</span> beanInstance;<br>&#125;<br><span class="hljs-keyword">catch</span> (BeanCreationException | ImplicitlyAppearedSingletonException ex) &#123;<br><span class="hljs-comment">// A previously detected exception with proper bean creation context already,</span><br><span class="hljs-comment">// or illegal singleton state to be communicated up to DefaultSingletonBeanRegistry.</span><br><span class="hljs-keyword">throw</span> ex;<br>&#125;<br><span class="hljs-keyword">catch</span> (Throwable ex) &#123;<br><span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BeanCreationException</span>(<br>mbdToUse.getResourceDescription(), beanName, <span class="hljs-string">&quot;Unexpected exception during bean creation&quot;</span>, ex);<br>&#125;<br>&#125;<br></code></pre></td></tr></table></div></figure><p>关键看doCreateBean()</p><h2 id="6-doCreateBean"><a href="#6-doCreateBean" class="headerlink" title="6.doCreateBean()"></a>6.doCreateBean()</h2><figure class="highlight java"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-pncvomlhkez7dx"></i><span>java</span><div class="collapse show" id="collapse-pncvomlhkez7dx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Description: 创建bean实例的核心方法</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">protected</span> Object <span class="hljs-title function_">doCreateBean</span><span class="hljs-params">(String beanName, RootBeanDefinition mbd, <span class="hljs-meta">@Nullable</span> Object[] args)</span><br><span class="hljs-keyword">throws</span> BeanCreationException &#123;<br><span class="hljs-comment">// Instantiate the bean.</span><br><span class="hljs-type">BeanWrapper</span> <span class="hljs-variable">instanceWrapper</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br><span class="hljs-keyword">if</span> (mbd.isSingleton()) &#123;<br>instanceWrapper = <span class="hljs-built_in">this</span>.factoryBeanInstanceCache.remove(beanName);<br>&#125;<br><span class="hljs-keyword">if</span> (instanceWrapper == <span class="hljs-literal">null</span>) &#123;<br><span class="hljs-comment">//创建实例,,重点看，重要程度：5</span><br>instanceWrapper = createBeanInstance(beanName, mbd, args);<br>&#125;<br><span class="hljs-type">Object</span> <span class="hljs-variable">bean</span> <span class="hljs-operator">=</span> instanceWrapper.getWrappedInstance();<br>Class&lt;?&gt; beanType = instanceWrapper.getWrappedClass();<br><span class="hljs-keyword">if</span> (beanType != NullBean.class) &#123;<br>mbd.resolvedTargetType = beanType;<br>&#125;<br><br><span class="hljs-comment">// Allow post-processors to modify the merged bean definition.</span><br><span class="hljs-keyword">synchronized</span> (mbd.postProcessingLock) &#123;<br><span class="hljs-keyword">if</span> (!mbd.postProcessed) &#123;<br><span class="hljs-keyword">try</span> &#123;<br><span class="hljs-comment">//CommonAnnotationBeanPostProcessor  支持了@PostConstruct，@PreDestroy,@Resource注解</span><br><span class="hljs-comment">//AutowiredAnnotationBeanPostProcessor 支持 @Autowired,@Value注解</span><br><span class="hljs-comment">//BeanPostProcessor接口的典型运用，这里要理解这个接口</span><br><span class="hljs-comment">//对类中注解的装配过程</span><br><span class="hljs-comment">//重要程度5，必须看</span><br>applyMergedBeanDefinitionPostProcessors(mbd, beanType, beanName);<br>&#125;<br><span class="hljs-keyword">catch</span> (Throwable ex) &#123;<br><span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BeanCreationException</span>(mbd.getResourceDescription(), beanName,<br><span class="hljs-string">&quot;Post-processing of merged bean definition failed&quot;</span>, ex);<br>&#125;<br>mbd.postProcessed = <span class="hljs-literal">true</span>;<br>&#125;<br>&#125;<br><br><span class="hljs-comment">// Eagerly cache singletons to be able to resolve circular references</span><br><span class="hljs-comment">// even when triggered by lifecycle interfaces like BeanFactoryAware.</span><br><span class="hljs-comment">//是否单例bean提前暴露</span><br><span class="hljs-type">boolean</span> <span class="hljs-variable">earlySingletonExposure</span> <span class="hljs-operator">=</span> (mbd.isSingleton() &amp;&amp; <span class="hljs-built_in">this</span>.allowCircularReferences &amp;&amp;<br>isSingletonCurrentlyInCreation(beanName));<br><span class="hljs-keyword">if</span> (earlySingletonExposure) &#123;<br><span class="hljs-keyword">if</span> (logger.isTraceEnabled()) &#123;<br>logger.trace(<span class="hljs-string">&quot;Eagerly caching bean &#x27;&quot;</span> + beanName +<br><span class="hljs-string">&quot;&#x27; to allow for resolving potential circular references&quot;</span>);<br>&#125;<br><span class="hljs-comment">//这里着重理解，对理解循环依赖帮助非常大，重要程度 5   添加三级缓存</span><br>addSingletonFactory(beanName, () -&gt; getEarlyBeanReference(beanName, mbd, bean));<br>&#125;<br><br><span class="hljs-comment">// Initialize the bean instance.</span><br><span class="hljs-type">Object</span> <span class="hljs-variable">exposedObject</span> <span class="hljs-operator">=</span> bean;<br><span class="hljs-keyword">try</span> &#123;<br><span class="hljs-comment">//ioc di，依赖注入的核心方法，该方法必须看，重要程度：5</span><br>populateBean(beanName, mbd, instanceWrapper);<br><span class="hljs-comment">//bean 实例化+ioc依赖注入完以后的调用，非常重要，重要程度：5</span><br>exposedObject = initializeBean(beanName, exposedObject, mbd);<br>&#125;<br><span class="hljs-keyword">catch</span> (Throwable ex) &#123;<br><span class="hljs-keyword">if</span> (ex <span class="hljs-keyword">instanceof</span> BeanCreationException &amp;&amp; beanName.equals(((BeanCreationException) ex).getBeanName())) &#123;<br><span class="hljs-keyword">throw</span> (BeanCreationException) ex;<br>&#125;<br><span class="hljs-keyword">else</span> &#123;<br><span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BeanCreationException</span>(<br>mbd.getResourceDescription(), beanName, <span class="hljs-string">&quot;Initialization of bean failed&quot;</span>, ex);<br>&#125;<br>&#125;<br><br><span class="hljs-keyword">if</span> (earlySingletonExposure) &#123;<br><span class="hljs-type">Object</span> <span class="hljs-variable">earlySingletonReference</span> <span class="hljs-operator">=</span> getSingleton(beanName, <span class="hljs-literal">false</span>);<br><span class="hljs-keyword">if</span> (earlySingletonReference != <span class="hljs-literal">null</span>) &#123;<br><span class="hljs-keyword">if</span> (exposedObject == bean) &#123;<br>exposedObject = earlySingletonReference;<br>&#125;<br><span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">this</span>.allowRawInjectionDespiteWrapping &amp;&amp; hasDependentBean(beanName)) &#123;<br>String[] dependentBeans = getDependentBeans(beanName);<br>Set&lt;String&gt; actualDependentBeans = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedHashSet</span>&lt;&gt;(dependentBeans.length);<br><span class="hljs-keyword">for</span> (String dependentBean : dependentBeans) &#123;<br><span class="hljs-keyword">if</span> (!removeSingletonIfCreatedForTypeCheckOnly(dependentBean)) &#123;<br>actualDependentBeans.add(dependentBean);<br>&#125;<br>&#125;<br><span class="hljs-keyword">if</span> (!actualDependentBeans.isEmpty()) &#123;<br><span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BeanCurrentlyInCreationException</span>(beanName,<br><span class="hljs-string">&quot;Bean with name &#x27;&quot;</span> + beanName + <span class="hljs-string">&quot;&#x27; has been injected into other beans [&quot;</span> +<br>StringUtils.collectionToCommaDelimitedString(actualDependentBeans) +<br><span class="hljs-string">&quot;] in its raw version as part of a circular reference, but has eventually been &quot;</span> +<br><span class="hljs-string">&quot;wrapped. This means that said other beans do not use the final version of the &quot;</span> +<br><span class="hljs-string">&quot;bean. This is often the result of over-eager type matching - consider using &quot;</span> +<br><span class="hljs-string">&quot;&#x27;getBeanNamesForType&#x27; with the &#x27;allowEagerInit&#x27; flag turned off, for example.&quot;</span>);<br>&#125;<br>&#125;<br>&#125;<br>&#125;<br><span class="hljs-comment">// Register bean as disposable.</span><br><span class="hljs-keyword">try</span> &#123;<br><span class="hljs-comment">//注册bean销毁时的类DisposableBeanAdapter</span><br>registerDisposableBeanIfNecessary(beanName, bean, mbd);<br>&#125;<br><span class="hljs-keyword">catch</span> (BeanDefinitionValidationException ex) &#123;<br><span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BeanCreationException</span>(<br>mbd.getResourceDescription(), beanName, <span class="hljs-string">&quot;Invalid destruction signature&quot;</span>, ex);<br>&#125;<br><br><span class="hljs-keyword">return</span> exposedObject;<br>&#125;<br></code></pre></td></tr></table></div></figure><p>这个方法就是核心创建bean的。<br>一个个来，先看创建一个原始的实例方法createBeanInstance()</p><h3 id="6-1-createBeanInstance"><a href="#6-1-createBeanInstance" class="headerlink" title="6.1.createBeanInstance()"></a>6.1.createBeanInstance()</h3><figure class="highlight java"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-rzj3eolhkez7dx"></i><span>java</span><div class="collapse show" id="collapse-rzj3eolhkez7dx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">protected</span> BeanWrapper <span class="hljs-title function_">createBeanInstance</span><span class="hljs-params">(String beanName, RootBeanDefinition mbd, <span class="hljs-meta">@Nullable</span> Object[] args)</span> &#123;<br><span class="hljs-comment">// Make sure bean class is actually resolved at this point.</span><br><span class="hljs-comment">// 1. 得到bean的class，并验证class的访问权限是不是public</span><br>Class&lt;?&gt; beanClass = resolveBeanClass(mbd, beanName);<br><span class="hljs-keyword">if</span> (beanClass != <span class="hljs-literal">null</span> &amp;&amp; !Modifier.isPublic(beanClass.getModifiers()) &amp;&amp; !mbd.isNonPublicAccessAllowed()) &#123;<br><span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BeanCreationException</span>(mbd.getResourceDescription(), beanName,<br><span class="hljs-string">&quot;Bean class isn&#x27;t public, and non-public access not allowed: &quot;</span> + beanClass.getName());<br>&#125;<br><br>Supplier&lt;?&gt; instanceSupplier = mbd.getInstanceSupplier();<br><span class="hljs-keyword">if</span> (instanceSupplier != <span class="hljs-literal">null</span>) &#123;<br><span class="hljs-keyword">return</span> obtainFromSupplier(instanceSupplier, beanName);<br>&#125;<br><br><span class="hljs-comment">//如果有FactoryMethodName属性 @Bean</span><br><span class="hljs-keyword">if</span> (mbd.getFactoryMethodName() != <span class="hljs-literal">null</span>) &#123;<br><span class="hljs-comment">// 反射的方式调用FactoryMethod</span><br><span class="hljs-keyword">return</span> instantiateUsingFactoryMethod(beanName, mbd, args);<br>&#125;<br><br><span class="hljs-comment">// Shortcut when re-creating the same bean...</span><br><span class="hljs-type">boolean</span> <span class="hljs-variable">resolved</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;<br><span class="hljs-type">boolean</span> <span class="hljs-variable">autowireNecessary</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;<br><span class="hljs-keyword">if</span> (args == <span class="hljs-literal">null</span>) &#123;<br><span class="hljs-keyword">synchronized</span> (mbd.constructorArgumentLock) &#123;<br><span class="hljs-keyword">if</span> (mbd.resolvedConstructorOrFactoryMethod != <span class="hljs-literal">null</span>) &#123;<br>resolved = <span class="hljs-literal">true</span>;<br>autowireNecessary = mbd.constructorArgumentsResolved;<br>&#125;<br>&#125;<br>&#125;<br><span class="hljs-keyword">if</span> (resolved) &#123;<br><span class="hljs-keyword">if</span> (autowireNecessary) &#123;<br><span class="hljs-keyword">return</span> autowireConstructor(beanName, mbd, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>);<br>&#125;<br><span class="hljs-keyword">else</span> &#123;<br><span class="hljs-keyword">return</span> instantiateBean(beanName, mbd);<br>&#125;<br>&#125;<br><br><span class="hljs-comment">// Candidate constructors for autowiring?</span><br><span class="hljs-comment">//寻找当前正在实例化的bean中有@Autowired注解的构造函数</span><br>Constructor&lt;?&gt;[] ctors = determineConstructorsFromBeanPostProcessors(beanClass, beanName);<br><span class="hljs-comment">//第一次推断构造函数</span><br><span class="hljs-keyword">if</span> (ctors != <span class="hljs-literal">null</span> || mbd.getResolvedAutowireMode() == AUTOWIRE_CONSTRUCTOR ||<br>mbd.hasConstructorArgumentValues() || !ObjectUtils.isEmpty(args)) &#123;<br><span class="hljs-comment">//如果ctors不为空，就说明构造函数上有@Autowired注解</span><br><span class="hljs-comment">//第二次推断构造函数</span><br><span class="hljs-keyword">return</span> autowireConstructor(beanName, mbd, ctors, args);<br>&#125;<br><span class="hljs-comment">// Preferred constructors for default construction?</span><br><span class="hljs-comment">//如果首选的构造器不为空， 则使用首选的构造器进行实例化，以及进行以来注入</span><br>ctors = mbd.getPreferredConstructors();<br><span class="hljs-keyword">if</span> (ctors != <span class="hljs-literal">null</span>) &#123;<br><span class="hljs-keyword">return</span> autowireConstructor(beanName, mbd, ctors, <span class="hljs-literal">null</span>);<br>&#125;<br><br><span class="hljs-comment">//无参构造函数的实例化,大部分的实例是采用的无参构造函数的方式实例化</span><br><span class="hljs-comment">// No special handling: simply use no-arg constructor.</span><br><span class="hljs-keyword">return</span> instantiateBean(beanName, mbd);<br>&#125;<br></code></pre></td></tr></table></div></figure><p>就是干一件事，用哪种构造函数来创建实例</p><ul><li>如果bean配置了factory-method，则反射实例化一个对象</li><li>如果没有配置factory-method，并且曾经创建过，那就按照原来的方式再创建</li><li>上述两种情况都不是，则先去当前正在实例化的bean中查出有@Autowired注解的构造函数，而这个动作是交给AutowiredAnnotationBeanPostProcessor中的determineCandidateConstructors方法来完成的</li><li>如果上述扫描出来的有@Autowired注解的构造函数不为空，则选择autowireConstructor来进行</li><li>如果首选的构造器不为空， 则使用首选的构造器进行实例化，以及进行依赖注入</li><li>否则，无参构造函数实例化</li></ul><p>点进去看看determineConstructorsFromBeanPostProcessors()</p><h4 id="6-1-1-构造函数的选取之determineConstructorsFromBeanPostProcessors"><a href="#6-1-1-构造函数的选取之determineConstructorsFromBeanPostProcessors" class="headerlink" title="6.1.1.构造函数的选取之determineConstructorsFromBeanPostProcessors()"></a>6.1.1.构造函数的选取之determineConstructorsFromBeanPostProcessors()</h4><figure class="highlight java"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-clzon6lhkez7dx"></i><span>java</span><div class="collapse show" id="collapse-clzon6lhkez7dx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">protected</span> Constructor&lt;?&gt;[] determineConstructorsFromBeanPostProcessors(<span class="hljs-meta">@Nullable</span> Class&lt;?&gt; beanClass, String beanName)<br><span class="hljs-keyword">throws</span> BeansException &#123;<br><span class="hljs-keyword">if</span> (beanClass != <span class="hljs-literal">null</span> &amp;&amp; hasInstantiationAwareBeanPostProcessors()) &#123;<br><span class="hljs-comment">// 拿到 BeanPostProcessor 的所有接口，遍历</span><br><span class="hljs-keyword">for</span> (BeanPostProcessor bp : getBeanPostProcessors()) &#123;<br><span class="hljs-keyword">if</span> (bp <span class="hljs-keyword">instanceof</span> SmartInstantiationAwareBeanPostProcessor) &#123;<br><span class="hljs-type">SmartInstantiationAwareBeanPostProcessor</span> <span class="hljs-variable">ibp</span> <span class="hljs-operator">=</span> (SmartInstantiationAwareBeanPostProcessor) bp;<br><span class="hljs-comment">// 获取到有@Autowired注解信息的构造函数</span><br>Constructor&lt;?&gt;[] ctors = ibp.determineCandidateConstructors(beanClass, beanName);<br><span class="hljs-keyword">if</span> (ctors != <span class="hljs-literal">null</span>) &#123;<br><span class="hljs-keyword">return</span> ctors;<br>&#125;<br>&#125;<br>&#125;<br>&#125;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>&#125;<br></code></pre></td></tr></table></div></figure><p>其中，</p><ul><li>getBeanPostProcessors()方法，获取所有BeanPostProcessor接口，是AbstractBeanFactory类中的一个List&lt;BeanPostProcessor&gt; beanPostProcessors &#x3D; new CopyOnWriteArrayList&lt;&gt;()容器，装载了上下文中所有的BeanPostProcessor类的实例。</li><li>SmartInstantiationAwareBeanPostProcessor类中的determineCandidateConstructors方法，会调用其子类 AutowiredAnnotationBeanPostProcessor 中的determineCandidateConstructors方法，来获取到有@Autowired注解信息的构造函数。AutowiredAnnotationBeanPostProcessor类会完成@Autowired和@value两个注解的扫描。</li><li>AutowiredAnnotationBeanPostProcessor 中的determineCandidateConstructors方法返回构造方法数组，以下两种情况返回值不为null:<ul><li>有且仅有一个带参构造方法，返回那个构造方法</li><li>有多个@Autowired(required &#x3D; false)注解的构造方法，返回这些构造方法</li></ul></li></ul><p>去看看AutowiredAnnotationBeanPostProcessor 中的determineCandidateConstructors方法</p><figure class="highlight java"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-22c163lhkez7dx"></i><span>java</span><div class="collapse show" id="collapse-22c163lhkez7dx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> Constructor&lt;?&gt;[] determineCandidateConstructors(Class&lt;?&gt; beanClass, <span class="hljs-keyword">final</span> String beanName)<br><span class="hljs-keyword">throws</span> BeanCreationException &#123;<br><span class="hljs-comment">// 在实例化某个对象的过程中会调用这个方法，得到候选构造方法</span><br><span class="hljs-comment">// Let&#x27;s check for lookup methods here...</span><br><span class="hljs-keyword">if</span> (!<span class="hljs-built_in">this</span>.lookupMethodsChecked.contains(beanName)) &#123;<br><span class="hljs-keyword">if</span> (AnnotationUtils.isCandidateClass(beanClass, Lookup.class)) &#123;<br><span class="hljs-keyword">try</span> &#123;<br>Class&lt;?&gt; targetClass = beanClass;<br><span class="hljs-keyword">do</span> &#123;<br><span class="hljs-comment">// 遍历当前beanClass中所有加了Lookup注解的方法，并且把这些方法的信息封装为LookupOverride对象加载mbd中</span><br>ReflectionUtils.doWithLocalMethods(targetClass, method -&gt; &#123;<br><span class="hljs-comment">//对注解Lookup的支持</span><br><span class="hljs-type">Lookup</span> <span class="hljs-variable">lookup</span> <span class="hljs-operator">=</span> method.getAnnotation(Lookup.class);<br><span class="hljs-keyword">if</span> (lookup != <span class="hljs-literal">null</span>) &#123;<br>Assert.state(<span class="hljs-built_in">this</span>.beanFactory != <span class="hljs-literal">null</span>, <span class="hljs-string">&quot;No BeanFactory available&quot;</span>);<br><span class="hljs-type">LookupOverride</span> <span class="hljs-variable">override</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">LookupOverride</span>(method, lookup.value());<br><span class="hljs-keyword">try</span> &#123;<br><span class="hljs-type">RootBeanDefinition</span> <span class="hljs-variable">mbd</span> <span class="hljs-operator">=</span> (RootBeanDefinition)<br><span class="hljs-built_in">this</span>.beanFactory.getMergedBeanDefinition(beanName);<br>mbd.getMethodOverrides().addOverride(override);<br>&#125;<br><span class="hljs-keyword">catch</span> (NoSuchBeanDefinitionException ex) &#123;<br><span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BeanCreationException</span>(beanName,<br><span class="hljs-string">&quot;Cannot apply @Lookup to beans without corresponding bean definition&quot;</span>);<br>&#125;<br>&#125;<br>&#125;);<br>targetClass = targetClass.getSuperclass();<br>&#125;<br><span class="hljs-keyword">while</span> (targetClass != <span class="hljs-literal">null</span> &amp;&amp; targetClass != Object.class);<br><br>&#125;<br><span class="hljs-keyword">catch</span> (IllegalStateException ex) &#123;<br><span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BeanCreationException</span>(beanName, <span class="hljs-string">&quot;Lookup method resolution failed&quot;</span>, ex);<br>&#125;<br>&#125;<br><span class="hljs-comment">// lookupMethodsChecked是一个set，用来记录哪些bean的@lookup注解被解析了，下一次就不用解析了</span><br><span class="hljs-built_in">this</span>.lookupMethodsChecked.add(beanName);<br>&#125;<br><span class="hljs-comment">// 先检查candidateConstructorsCache中是否缓存了当前bean中可用的构造方法</span><br><span class="hljs-comment">// Quick check on the concurrent map first, with minimal locking.</span><br>Constructor&lt;?&gt;[] candidateConstructors = <span class="hljs-built_in">this</span>.candidateConstructorsCache.get(beanClass);<br><span class="hljs-keyword">if</span> (candidateConstructors == <span class="hljs-literal">null</span>) &#123;<br><span class="hljs-comment">// Fully synchronized resolution now...</span><br><span class="hljs-keyword">synchronized</span> (<span class="hljs-built_in">this</span>.candidateConstructorsCache) &#123;<br>candidateConstructors = <span class="hljs-built_in">this</span>.candidateConstructorsCache.get(beanClass);<br><span class="hljs-comment">// 如果没有筛选过构造方法，就开始筛选</span><br><span class="hljs-keyword">if</span> (candidateConstructors == <span class="hljs-literal">null</span>) &#123;<br>Constructor&lt;?&gt;[] rawCandidates;<br><span class="hljs-keyword">try</span> &#123;<br><span class="hljs-comment">// 拿到当前类所有的构造方法，如果没有写任何构造方法，这里会返回一个无参的构造方法</span><br>rawCandidates = beanClass.getDeclaredConstructors();<br>&#125;<br><span class="hljs-keyword">catch</span> (Throwable ex) &#123;<br><span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BeanCreationException</span>(beanName,<br><span class="hljs-string">&quot;Resolution of declared constructors on bean Class [&quot;</span> + beanClass.getName() +<br><span class="hljs-string">&quot;] from ClassLoader [&quot;</span> + beanClass.getClassLoader() + <span class="hljs-string">&quot;] failed&quot;</span>, ex);<br>&#125;<br><span class="hljs-comment">// candidates 就是用来存储所有被筛选出来的构造方法,其实可以认为, 就是把所有@Autowired注解标注的方法放到里面,</span><br><span class="hljs-comment">// 但是还多放了一个默认构造方法</span><br>List&lt;Constructor&lt;?&gt;&gt; candidates = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;(rawCandidates.length);<br><span class="hljs-comment">// requiredConstructor表示@Autowired标注并且required为true的构造方法, 因为只允许出现一个这样的构造方法,</span><br><span class="hljs-comment">//所以当这个变量存在值后, 又出现了一个相同情况的构造方法的话, Spring就会抛出一个错误</span><br>Constructor&lt;?&gt; requiredConstructor = <span class="hljs-literal">null</span>;<br><span class="hljs-comment">// defaultConstructor用来保存默认构造方法</span><br>Constructor&lt;?&gt; defaultConstructor = <span class="hljs-literal">null</span>;<br><span class="hljs-comment">// 如果是kotlin的类才起效，如果是java中的类则直接返回null</span><br>Constructor&lt;?&gt; primaryConstructor = BeanUtils.findPrimaryConstructor(beanClass);<br><span class="hljs-type">int</span> <span class="hljs-variable">nonSyntheticConstructors</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br><span class="hljs-comment">// 遍历所有的构造方法</span><br><span class="hljs-keyword">for</span> (Constructor&lt;?&gt; candidate : rawCandidates) &#123;<br><span class="hljs-keyword">if</span> (!candidate.isSynthetic()) &#123;<br>nonSyntheticConstructors++;<br>&#125;<br><span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (primaryConstructor != <span class="hljs-literal">null</span>) &#123;<br><span class="hljs-keyword">continue</span>;<br>&#125;<br><span class="hljs-comment">// 查看该构造方法上是否存在@Autowired注解，或者看代理类的父类中对应的构造方法上是否存在@Autowired注解</span><br><span class="hljs-comment">//获取到构造函数上的@Autowired注解信息,这个方法可以不看</span><br>MergedAnnotation&lt;?&gt; ann = findAutowiredAnnotation(candidate);<br><span class="hljs-keyword">if</span> (ann == <span class="hljs-literal">null</span>) &#123;<br><span class="hljs-comment">// 如果当前类是cglib生成的代理类，则获取其父类</span><br>Class&lt;?&gt; userClass = ClassUtils.getUserClass(beanClass);<br><span class="hljs-keyword">if</span> (userClass != beanClass) &#123;<br><span class="hljs-keyword">try</span> &#123;<br>Constructor&lt;?&gt; superCtor =<br>userClass.getDeclaredConstructor(candidate.getParameterTypes());<br>ann = findAutowiredAnnotation(superCtor);<br>&#125;<br><span class="hljs-keyword">catch</span> (NoSuchMethodException ex) &#123;<br><span class="hljs-comment">// Simply proceed, no equivalent superclass constructor found...</span><br>&#125;<br>&#125;<br>&#125;<br><span class="hljs-comment">// 如果构造方法上存在@Autowired注解</span><br><span class="hljs-keyword">if</span> (ann != <span class="hljs-literal">null</span>) &#123;<br><span class="hljs-comment">// requiredConstructor表示程序员手动指明的要使用的哪个构造方法</span><br><span class="hljs-comment">// 所以如果有多个构造方法上都写了@Autowired注解就会报错，required位true的情况下</span><br><span class="hljs-comment">// 因为作为程序员你如果告诉Spring多个构造方法，那Spring也就不知道到底要使用哪一个了</span><br><span class="hljs-keyword">if</span> (requiredConstructor != <span class="hljs-literal">null</span>) &#123;<br><span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BeanCreationException</span>(beanName,<br><span class="hljs-string">&quot;Invalid autowire-marked constructor: &quot;</span> + candidate +<br><span class="hljs-string">&quot;. Found constructor with &#x27;required&#x27; Autowired annotation already: &quot;</span> +<br>requiredConstructor);<br>&#125;<br><span class="hljs-comment">//获取到@Autowired里面的required的值，默认 true</span><br><span class="hljs-type">boolean</span> <span class="hljs-variable">required</span> <span class="hljs-operator">=</span> determineRequiredStatus(ann);<br><span class="hljs-keyword">if</span> (required) &#123;<br><span class="hljs-keyword">if</span> (!candidates.isEmpty()) &#123;<br><span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BeanCreationException</span>(beanName,<br><span class="hljs-string">&quot;Invalid autowire-marked constructors: &quot;</span> + candidates +<br><span class="hljs-string">&quot;. Found constructor with &#x27;required&#x27; Autowired annotation: &quot;</span> +<br>candidate);<br>&#125;<br>requiredConstructor = candidate;<br>&#125;<br><span class="hljs-comment">// candidates中存的是加了@Autowired注解的构造方法</span><br>candidates.add(candidate);<br>&#125;<br><span class="hljs-comment">// 如果当前构造方法上不存在@Autowired，并且是无参构造方法，则记录一下该无参构造方法</span><br><span class="hljs-comment">// 所以我们可以在遍历构造方法时，只关心无参构造方法和加了@Autowired注解的构造方法</span><br><span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (candidate.getParameterCount() == <span class="hljs-number">0</span>) &#123;<br>defaultConstructor = candidate;<br>&#125;<br>&#125;<br><span class="hljs-comment">// 如果存在添加了@Autowired的构造方法</span><br><span class="hljs-keyword">if</span> (!candidates.isEmpty()) &#123;<br><span class="hljs-comment">// Add default constructor to list of optional constructors, as fallback.</span><br><span class="hljs-comment">// 分为两种请求，要么candidates中包含一个required等于true的构造方法</span><br><span class="hljs-comment">// 要么candidates中包含一个或多个required等于false的构造方法</span><br><span class="hljs-comment">// 如果没有指定required为true的构造方法，那么就把构造方法添加到candidates中去，后续一起进行推断</span><br><span class="hljs-keyword">if</span> (requiredConstructor == <span class="hljs-literal">null</span>) &#123;<br><span class="hljs-keyword">if</span> (defaultConstructor != <span class="hljs-literal">null</span>) &#123;<br><span class="hljs-comment">// 把无参的构造方法也添加进去</span><br>candidates.add(defaultConstructor);<br>&#125;<br><span class="hljs-comment">// 如果没有指定required为true的构造方法，并且也没有无参的构造方法，并且只有一个构造方法</span><br><span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (candidates.size() == <span class="hljs-number">1</span> &amp;&amp; logger.isInfoEnabled()) &#123;<br><span class="hljs-comment">// 给一个提示，没有无参的构造方法，然后又只有一个@Autowired(required=false)的构造方法</span><br><span class="hljs-comment">// 所以其实一定会用这个构造方法，所以打印一个日志，告诉程序员，你其实可以把required改为true</span><br>logger.info(<span class="hljs-string">&quot;Inconsistent constructor declaration on bean with name &#x27;&quot;</span> + beanName +<br><span class="hljs-string">&quot;&#x27;: single autowire-marked constructor flagged as optional - &quot;</span> +<br><span class="hljs-string">&quot;this constructor is effectively required since there is no &quot;</span> +<br><span class="hljs-string">&quot;default constructor to fall back to: &quot;</span> + candidates.get(<span class="hljs-number">0</span>));<br>&#125;<br>&#125;<br><span class="hljs-comment">// candidateConstructors就是当前方法的返回值</span><br><span class="hljs-comment">// 把candidates方法，两种情况，要么只有一个@Autowired(required=true)的构造方法，要么多个@Autowired(required=false)+一个无参构造方法</span><br>candidateConstructors = candidates.toArray(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Constructor</span>&lt;?&gt;[<span class="hljs-number">0</span>]);<br>&#125;<br><span class="hljs-comment">// 没有加了@Autowired注解的构造方法，那么则判断是不是只有一个有参的构造方法，如果是则返回</span><br><span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (rawCandidates.length == <span class="hljs-number">1</span> &amp;&amp; rawCandidates[<span class="hljs-number">0</span>].getParameterCount() &gt; <span class="hljs-number">0</span>) &#123;<br>candidateConstructors = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Constructor</span>&lt;?&gt;[] &#123;rawCandidates[<span class="hljs-number">0</span>]&#125;;<br>&#125;<br><span class="hljs-comment">// primaryConstructor != null 不管</span><br><span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (nonSyntheticConstructors == <span class="hljs-number">2</span> &amp;&amp; primaryConstructor != <span class="hljs-literal">null</span> &amp;&amp;<br>defaultConstructor != <span class="hljs-literal">null</span> &amp;&amp; !primaryConstructor.equals(defaultConstructor)) &#123;<br>candidateConstructors = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Constructor</span>&lt;?&gt;[] &#123;primaryConstructor, defaultConstructor&#125;;<br>&#125;<br><span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (nonSyntheticConstructors == <span class="hljs-number">1</span> &amp;&amp; primaryConstructor != <span class="hljs-literal">null</span>) &#123;<br>candidateConstructors = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Constructor</span>&lt;?&gt;[] &#123;primaryConstructor&#125;;<br>&#125;<br><span class="hljs-comment">// 如果没有构造方法上添加了@Autowired注解，并且有多个构造方法，并且没有primaryConstructor</span><br><span class="hljs-keyword">else</span> &#123;<br><span class="hljs-comment">// 返回一个空的Constructor数组，表示没有推断出来构造方法</span><br>candidateConstructors = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Constructor</span>&lt;?&gt;[<span class="hljs-number">0</span>];<br>&#125;<br><span class="hljs-built_in">this</span>.candidateConstructorsCache.put(beanClass, candidateConstructors);<br>&#125;<br>&#125;<br>&#125;<br><span class="hljs-comment">// 要么返回一个required=true的构造方法</span><br><span class="hljs-comment">// 要么返回多个required=false+无参的构造方法</span><br><span class="hljs-comment">// 要么返回唯一的一个有参的构造方法</span><br><span class="hljs-comment">// 如果只有一个无参的构造方法，这里会返回null，外层逻辑会默认使用无参构造方法进行实例化</span><br><span class="hljs-keyword">return</span> (candidateConstructors.length &gt; <span class="hljs-number">0</span> ? candidateConstructors : <span class="hljs-literal">null</span>);<br>&#125;<br></code></pre></td></tr></table></div></figure><p>这个方法执行完毕后，我们就可以进行第一次推断构造函数了，回到6.1.createBeanInstance()中的determineConstructorsFromBeanPostProcessors。我们再看看第二次推断构造函数的过程</p><h4 id="6-1-2-构造函数的选取之autowireConstructor"><a href="#6-1-2-构造函数的选取之autowireConstructor" class="headerlink" title="6.1.2.构造函数的选取之autowireConstructor()"></a>6.1.2.构造函数的选取之autowireConstructor()</h4><p>调用的为ConstructorResolver的autowireConstructor()</p><figure class="highlight java"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-45s473lhkez7dx"></i><span>java</span><div class="collapse show" id="collapse-45s473lhkez7dx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">protected</span> BeanWrapper <span class="hljs-title function_">autowireConstructor</span><span class="hljs-params">(</span><br><span class="hljs-params">String beanName, RootBeanDefinition mbd, <span class="hljs-meta">@Nullable</span> Constructor&lt;?&gt;[] ctors, <span class="hljs-meta">@Nullable</span> Object[] explicitArgs)</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstructorResolver</span>(<span class="hljs-built_in">this</span>).autowireConstructor(beanName, mbd, ctors, explicitArgs);<br>&#125;<br></code></pre></td></tr></table></div></figure><p>点进去autowireConstructor，参考这位大神画的流程<a href="https://blog.csdn.net/qq_39404258/article/details/109769278">spring源码解析（四） 推断构造方法</a></p><figure class="highlight java"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-hfnlqslhkez7dx"></i><span>java</span><div class="collapse show" id="collapse-hfnlqslhkez7dx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> BeanWrapper <span class="hljs-title function_">autowireConstructor</span><span class="hljs-params">(String beanName, RootBeanDefinition mbd,</span><br><span class="hljs-params"><span class="hljs-meta">@Nullable</span> Constructor&lt;?&gt;[] chosenCtors, <span class="hljs-meta">@Nullable</span> Object[] explicitArgs)</span> &#123;<br><br><span class="hljs-type">BeanWrapperImpl</span> <span class="hljs-variable">bw</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BeanWrapperImpl</span>();<br><span class="hljs-built_in">this</span>.beanFactory.initBeanWrapper(bw);<br><br>Constructor&lt;?&gt; constructorToUse = <span class="hljs-literal">null</span>;<br><span class="hljs-type">ArgumentsHolder</span> <span class="hljs-variable">argsHolderToUse</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>Object[] argsToUse = <span class="hljs-literal">null</span>;<br><span class="hljs-comment">// 是否通过getBean()方法指定了构造方法参数值</span><br><span class="hljs-keyword">if</span> (explicitArgs != <span class="hljs-literal">null</span>) &#123;<br>argsToUse = explicitArgs;<br>&#125;<br><span class="hljs-keyword">else</span> &#123;<br><span class="hljs-comment">// 从缓存中获取构造方法和构造方法参数值</span><br>Object[] argsToResolve = <span class="hljs-literal">null</span>;<br><span class="hljs-keyword">synchronized</span> (mbd.constructorArgumentLock) &#123;<br>constructorToUse = (Constructor&lt;?&gt;) mbd.resolvedConstructorOrFactoryMethod;<br><span class="hljs-comment">// 找到了mbd中缓存的构造方法</span><br><span class="hljs-keyword">if</span> (constructorToUse != <span class="hljs-literal">null</span> &amp;&amp; mbd.constructorArgumentsResolved) &#123;<br><span class="hljs-comment">// Found a cached constructor...</span><br>argsToUse = mbd.resolvedConstructorArguments;<br><span class="hljs-keyword">if</span> (argsToUse == <span class="hljs-literal">null</span>) &#123;<br>argsToResolve = mbd.preparedConstructorArguments;<br>&#125;<br>&#125;<br>&#125;<br><span class="hljs-comment">// 如果存在构造方法参数值，那么则对参数值进行类型转化</span><br><span class="hljs-keyword">if</span> (argsToResolve != <span class="hljs-literal">null</span>) &#123;<br>argsToUse = resolvePreparedArguments(beanName, mbd, bw, constructorToUse, argsToResolve, <span class="hljs-literal">true</span>);<br>&#125;<br>&#125;<br><span class="hljs-comment">// 如果待使用的构造方法为null，或待使用的构造方法参数为null</span><br><span class="hljs-keyword">if</span> (constructorToUse == <span class="hljs-literal">null</span> || argsToUse == <span class="hljs-literal">null</span>) &#123;<br><span class="hljs-comment">// Take specified constructors, if any.</span><br><span class="hljs-comment">// chosenCtors表示所指定的构造方法，没有指定则获取beanClass中的所有的构造方法作为候选者，从这些构造方法中选择一个构造方法</span><br>Constructor&lt;?&gt;[] candidates = chosenCtors;<br><span class="hljs-keyword">if</span> (candidates == <span class="hljs-literal">null</span>) &#123;<br>Class&lt;?&gt; beanClass = mbd.getBeanClass();<br><span class="hljs-keyword">try</span> &#123;<br>candidates = (mbd.isNonPublicAccessAllowed() ?<br>beanClass.getDeclaredConstructors() : beanClass.getConstructors());<br>&#125;<br><span class="hljs-keyword">catch</span> (Throwable ex) &#123;<br><span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BeanCreationException</span>(mbd.getResourceDescription(), beanName,<br><span class="hljs-string">&quot;Resolution of declared constructors on bean Class [&quot;</span> + beanClass.getName() +<br><span class="hljs-string">&quot;] from ClassLoader [&quot;</span> + beanClass.getClassLoader() + <span class="hljs-string">&quot;] failed&quot;</span>, ex);<br>&#125;<br>&#125;<br><span class="hljs-comment">// 有了构造方法之后，则进行自动推断</span><br><span class="hljs-comment">// 如果只有一个构造方法，并且没有指定构造方法参数值，则需要判断是不是无参构造方法，如果是则可以使用无参构造方法进行实例化</span><br><span class="hljs-keyword">if</span> (candidates.length == <span class="hljs-number">1</span> &amp;&amp; explicitArgs == <span class="hljs-literal">null</span> &amp;&amp; !mbd.hasConstructorArgumentValues()) &#123;<br>Constructor&lt;?&gt; uniqueCandidate = candidates[<span class="hljs-number">0</span>];<br><span class="hljs-keyword">if</span> (uniqueCandidate.getParameterCount() == <span class="hljs-number">0</span>) &#123;<br><span class="hljs-keyword">synchronized</span> (mbd.constructorArgumentLock) &#123;<br><span class="hljs-comment">// 确定了构造方法之后进行缓存</span><br>mbd.resolvedConstructorOrFactoryMethod = uniqueCandidate;<br>mbd.constructorArgumentsResolved = <span class="hljs-literal">true</span>;<br>mbd.resolvedConstructorArguments = EMPTY_ARGS;<br>&#125;<br>bw.setBeanInstance(instantiate(beanName, mbd, uniqueCandidate, EMPTY_ARGS));<br><span class="hljs-keyword">return</span> bw;<br>&#125;<br>&#125;<br><span class="hljs-comment">// 如果指定了多个构造方法，或者autowireMode是构造方法自动注入，则要自动选择构造方法</span><br><span class="hljs-comment">// Need to resolve the constructor.</span><br><span class="hljs-type">boolean</span> <span class="hljs-variable">autowiring</span> <span class="hljs-operator">=</span> (chosenCtors != <span class="hljs-literal">null</span> ||<br>mbd.getResolvedAutowireMode() == AutowireCapableBeanFactory.AUTOWIRE_CONSTRUCTOR);<br><span class="hljs-type">ConstructorArgumentValues</span> <span class="hljs-variable">resolvedValues</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br><span class="hljs-comment">// 表示所有构造方法中，参数个数最少的构造方法的参数个数是多少</span><br><span class="hljs-type">int</span> minNrOfArgs;<br><span class="hljs-keyword">if</span> (explicitArgs != <span class="hljs-literal">null</span>) &#123;<br>minNrOfArgs = explicitArgs.length;<br>&#125;<br><span class="hljs-keyword">else</span> &#123;<br><span class="hljs-comment">// 从BeanDefinition中获取所设置的构造方法参数值</span><br><span class="hljs-type">ConstructorArgumentValues</span> <span class="hljs-variable">cargs</span> <span class="hljs-operator">=</span> mbd.getConstructorArgumentValues();<br><span class="hljs-comment">// 记录解析后的构造方法参数值</span><br>resolvedValues = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstructorArgumentValues</span>();<br><span class="hljs-comment">// 解析BeanDefinition中所设置的构造方法参数值（index跳跃）</span><br>minNrOfArgs = resolveConstructorArguments(beanName, mbd, bw, cargs, resolvedValues);<br>&#125;<br><span class="hljs-comment">// 按构造方法的参数个数降序排序，参数个数多的在前</span><br>AutowireUtils.sortConstructors(candidates);<br><span class="hljs-type">int</span> <span class="hljs-variable">minTypeDiffWeight</span> <span class="hljs-operator">=</span> Integer.MAX_VALUE;<br>Set&lt;Constructor&lt;?&gt;&gt; ambiguousConstructors = <span class="hljs-literal">null</span>;<br>LinkedList&lt;UnsatisfiedDependencyException&gt; causes = <span class="hljs-literal">null</span>;<br><span class="hljs-comment">// 遍历构造方法，找到一个最合适的(贪婪)</span><br><span class="hljs-comment">// 先看参数列表最长的构造方法，根据每个参数的参数类型和参数名去找bean</span><br><span class="hljs-keyword">for</span> (Constructor&lt;?&gt; candidate : candidates) &#123;<br><span class="hljs-comment">// 当前构造方法的参数个数</span><br><span class="hljs-type">int</span> <span class="hljs-variable">parameterCount</span> <span class="hljs-operator">=</span> candidate.getParameterCount();<br><span class="hljs-comment">//如果之前的构造器已经有一个被处理过且该参数个数大于当前遍历的，则后面的构造器就不用处理了</span><br><span class="hljs-keyword">if</span> (constructorToUse != <span class="hljs-literal">null</span> &amp;&amp; argsToUse != <span class="hljs-literal">null</span> &amp;&amp; argsToUse.length &gt; parameterCount) &#123;<br><span class="hljs-comment">// Already found greedy constructor that can be satisfied -&gt;</span><br><span class="hljs-comment">// do not look any further, there are only less greedy constructors left.</span><br><span class="hljs-keyword">break</span>;<br>&#125;<br><span class="hljs-comment">// 在遍历某个构造方法时，如果参数个数小于用于所指定的参数个数，则忽略该构造方法</span><br><span class="hljs-keyword">if</span> (parameterCount &lt; minNrOfArgs) &#123;<br><span class="hljs-keyword">continue</span>;<br>&#125;<br><br>ArgumentsHolder argsHolder;<br><span class="hljs-comment">// 当前遍历到的某个构造方法的参数类型</span><br>Class&lt;?&gt;[] paramTypes = candidate.getParameterTypes();<br><span class="hljs-comment">// 没有通过getBean()方法指定构造方法参数值</span><br><span class="hljs-keyword">if</span> (resolvedValues != <span class="hljs-literal">null</span>) &#123;<br><span class="hljs-keyword">try</span> &#123;<br><span class="hljs-comment">// 获取参数名</span><br><span class="hljs-comment">// 查看是否在构造方法上使用@ConstructorProperties注解来定义构造方法参数的名字</span><br>String[] paramNames = ConstructorPropertiesChecker.evaluate(candidate, parameterCount);<br><span class="hljs-keyword">if</span> (paramNames == <span class="hljs-literal">null</span>) &#123;<br><span class="hljs-type">ParameterNameDiscoverer</span> <span class="hljs-variable">pnd</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.beanFactory.getParameterNameDiscoverer();<br><span class="hljs-keyword">if</span> (pnd != <span class="hljs-literal">null</span>) &#123;<br>paramNames = pnd.getParameterNames(candidate);<br>&#125;<br>&#125;<br><span class="hljs-comment">//这里会触发构造函数中参数的getBean操作，会实例化参数的值</span><br><span class="hljs-comment">// 根据当前构造方法的参数类型和参数名从beanFactory中得到bean作为参数值</span><br><span class="hljs-comment">// resolvedValues, 表示所指定的构造方法参数值</span><br><span class="hljs-comment">// paramTypes，当前构造方法的参数类型列表</span><br><span class="hljs-comment">// paramNames，当前构造方法的参数值列表</span><br><span class="hljs-comment">// getUserDeclaredConstructor(candidate)获取父类中被重写的构造方法</span><br>argsHolder = createArgumentArray(beanName, mbd, resolvedValues, bw, paramTypes, paramNames,<br>getUserDeclaredConstructor(candidate), autowiring, candidates.length == <span class="hljs-number">1</span>);<br>&#125;<br><span class="hljs-keyword">catch</span> (UnsatisfiedDependencyException ex) &#123;<br><span class="hljs-comment">// 如果找不到对应的bean，也不会直接报错，只能证明当前遍历到的构造方法不能用</span><br><span class="hljs-keyword">if</span> (logger.isTraceEnabled()) &#123;<br>logger.trace(<span class="hljs-string">&quot;Ignoring constructor [&quot;</span> + candidate + <span class="hljs-string">&quot;] of bean &#x27;&quot;</span> + beanName + <span class="hljs-string">&quot;&#x27;: &quot;</span> + ex);<br>&#125;<br><span class="hljs-comment">// Swallow and try next constructor.</span><br><span class="hljs-keyword">if</span> (causes == <span class="hljs-literal">null</span>) &#123;<br>causes = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedList</span>&lt;&gt;();<br>&#125;<br>causes.add(ex);<br><span class="hljs-keyword">continue</span>;<br>&#125;<br>&#125;<br><span class="hljs-keyword">else</span> &#123;<br><span class="hljs-comment">// 通过getBean()方法指定了构造方法参数值</span><br><span class="hljs-comment">// Explicit arguments given -&gt; arguments length must match exactly.</span><br><span class="hljs-keyword">if</span> (parameterCount != explicitArgs.length) &#123;<br><span class="hljs-keyword">continue</span>;<br>&#125;<br><span class="hljs-comment">// 如果参数个数匹配，则把所有参数值封装为一个ArgumentsHolder对象</span><br>argsHolder = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArgumentsHolder</span>(explicitArgs);<br>&#125;<br><span class="hljs-comment">// 执行到这里，表示当前构造方法可用，并且也找到了对应的构造方法参数值</span><br><span class="hljs-comment">// 但是还需要判断，当前构造方法是不是最合适的，也许还有另外的构造方法更合适</span><br><br><span class="hljs-comment">// 根据参数类型和参数值计算权重</span><br><span class="hljs-comment">// Lenient宽松，默认宽松模式是开启的</span><br><span class="hljs-comment">// 在宽松模式下，会判断每个参数值的类型和当前构造方法的参数类型的距离</span><br><span class="hljs-comment">// 在非宽松模式下，会忽略每个参数值的类型和当前构造方法的参数类型的距离，只要是父子关系距离是一样的</span><br><span class="hljs-type">int</span> <span class="hljs-variable">typeDiffWeight</span> <span class="hljs-operator">=</span> (mbd.isLenientConstructorResolution() ?<br>argsHolder.getTypeDifferenceWeight(paramTypes) : argsHolder.getAssignabilityWeight(paramTypes));<br><span class="hljs-comment">// Choose this constructor if it represents the closest match.</span><br><span class="hljs-comment">// 如果当前构造方法的权重比较小，则表示当前构造方法更合适，将当前构造方法和所找到参数值作为待使用的，遍历下一个构造方法</span><br><span class="hljs-keyword">if</span> (typeDiffWeight &lt; minTypeDiffWeight) &#123;<br>constructorToUse = candidate;<br>argsHolderToUse = argsHolder;<br>argsToUse = argsHolder.arguments;<br>minTypeDiffWeight = typeDiffWeight;<br>ambiguousConstructors = <span class="hljs-literal">null</span>;<br>&#125;<br><span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (constructorToUse != <span class="hljs-literal">null</span> &amp;&amp; typeDiffWeight == minTypeDiffWeight) &#123;<br><span class="hljs-comment">// 如果权重一样，则记录在ambiguousConstructors中，继续遍历下一个构造方法</span><br><span class="hljs-keyword">if</span> (ambiguousConstructors == <span class="hljs-literal">null</span>) &#123;<br>ambiguousConstructors = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedHashSet</span>&lt;&gt;();<br>ambiguousConstructors.add(constructorToUse);<br>&#125;<br>ambiguousConstructors.add(candidate);<br>&#125;<br>&#125;<span class="hljs-comment">//end of for</span><br><span class="hljs-comment">// 遍历完所有构造方法后，没有找到合适的构造方法，则报错</span><br><span class="hljs-keyword">if</span> (constructorToUse == <span class="hljs-literal">null</span>) &#123;<br><span class="hljs-keyword">if</span> (causes != <span class="hljs-literal">null</span>) &#123;<br><span class="hljs-type">UnsatisfiedDependencyException</span> <span class="hljs-variable">ex</span> <span class="hljs-operator">=</span> causes.removeLast();<br><span class="hljs-keyword">for</span> (Exception cause : causes) &#123;<br><span class="hljs-built_in">this</span>.beanFactory.onSuppressedException(cause);<br>&#125;<br><span class="hljs-keyword">throw</span> ex;<br>&#125;<br><span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BeanCreationException</span>(mbd.getResourceDescription(), beanName,<br><span class="hljs-string">&quot;Could not resolve matching constructor &quot;</span> +<br><span class="hljs-string">&quot;(hint: specify index/type/name arguments for simple parameters to avoid type ambiguities)&quot;</span>);<br>&#125;<br><span class="hljs-comment">// 如果存在权重一样的构造方法并且不是宽松模式，也报错，因为权重一样，Spring不知道该用哪个</span><br><span class="hljs-comment">// 如果是宽松模式则不会报错，Spring会用找到的第一个</span><br><span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (ambiguousConstructors != <span class="hljs-literal">null</span> &amp;&amp; !mbd.isLenientConstructorResolution()) &#123;<br><span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BeanCreationException</span>(mbd.getResourceDescription(), beanName,<br><span class="hljs-string">&quot;Ambiguous constructor matches found in bean &#x27;&quot;</span> + beanName + <span class="hljs-string">&quot;&#x27; &quot;</span> +<br><span class="hljs-string">&quot;(hint: specify index/type/name arguments for simple parameters to avoid type ambiguities): &quot;</span> +<br>ambiguousConstructors);<br>&#125;<br><span class="hljs-comment">// 如果不是通过getBean()方法指定的参数，那么就把找到的构造方法参数进行缓存</span><br><span class="hljs-keyword">if</span> (explicitArgs == <span class="hljs-literal">null</span> &amp;&amp; argsHolderToUse != <span class="hljs-literal">null</span>) &#123;<br>argsHolderToUse.storeCache(mbd, constructorToUse);<br>&#125;<br>&#125;<br><span class="hljs-comment">// 得到了构造方法和构造方法的参数值之后，就可以进行实例化了</span><br>Assert.state(argsToUse != <span class="hljs-literal">null</span>, <span class="hljs-string">&quot;Unresolved constructor arguments&quot;</span>);<br>bw.setBeanInstance(instantiate(beanName, mbd, constructorToUse, argsToUse));<br><span class="hljs-keyword">return</span> bw;<br>&#125;<br></code></pre></td></tr></table></div></figure><p>总结下：</p><ul><li><p>手动装配</p><ul><li>没有显式提供构造方法：使用默认构造方法</li><li>提供一个构造方法：使用该构造方法</li><li>提供多个构造方法，包含默认构造方法：使用默认构造方法</li><li>提供多个构造方法，不包含默认构造方法：报错</li><li>提供多个构造方法，有一个@Autowired(required &#x3D; true)的构造方法：使用有@Autowired(required &#x3D; true)的构造方法</li><li>提供多个构造方法，有多个@Autowired(required &#x3D; true)的构造方法：报错</li><li>提供多个构造方法，有一个@Autowired(required &#x3D; true)的构造方法和多个@Autowired(required &#x3D; false)的构造方法：报错</li><li>提供多个构造方法，有多个@Autowired(required &#x3D; false)的构造方法：使用符合条件的&amp;参数最多的构造方法</li></ul></li><li><p>使用构造方法自动装配：使用符合条件的&amp;参数最多的构造方法</p></li></ul><p>如果两次推断构造函数均未果，则使用无参构造函数的实例化,大部分的实例是采用的无参构造函数的方式实例化，这里不继续跟了。回到6.doCreateBean()，再去看看applyMergedBeanDefinitionPostProcessors</p><h3 id="6-2-注解扫描applyMergedBeanDefinitionPostProcessors"><a href="#6-2-注解扫描applyMergedBeanDefinitionPostProcessors" class="headerlink" title="6.2.注解扫描applyMergedBeanDefinitionPostProcessors()"></a>6.2.注解扫描applyMergedBeanDefinitionPostProcessors()</h3><p>这个方法主要功能为：<strong>收集@Resource、@PostConstruct、@PreDestory、@Autowired 和@Value注解的方法或属性，封装成对应的对象，方便后续依赖注入时使用</strong>。其中</p><ul><li>CommonAnnotationBeanPostProcessor  支持@PostConstruct，@PreDestroy和@Resource注解</li><li>AutowiredAnnotationBeanPostProcessor 支持@Autowired和@Value注解</li></ul><p>这两个类都是MergedBeanDefinitionPostProcessor的实现类。我们先点进去看看applyMergedBeanDefinitionPostProcessors()方法</p><figure class="highlight java"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-o08nn7lhkez7dx"></i><span>java</span><div class="collapse show" id="collapse-o08nn7lhkez7dx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">applyMergedBeanDefinitionPostProcessors</span><span class="hljs-params">(RootBeanDefinition mbd, Class&lt;?&gt; beanType, String beanName)</span> &#123;<br><span class="hljs-comment">//从所有BeanPostProcessor中过滤出MergedBeanDefinitionPostProcessor的类，循环扫描</span><br><span class="hljs-keyword">for</span> (BeanPostProcessor bp : getBeanPostProcessors()) &#123;<br><span class="hljs-keyword">if</span> (bp <span class="hljs-keyword">instanceof</span> MergedBeanDefinitionPostProcessor) &#123;<br><span class="hljs-type">MergedBeanDefinitionPostProcessor</span> <span class="hljs-variable">bdp</span> <span class="hljs-operator">=</span> (MergedBeanDefinitionPostProcessor) bp;<br>bdp.postProcessMergedBeanDefinition(mbd, beanType, beanName);<br>&#125;<br>&#125;<br>&#125;<br></code></pre></td></tr></table></div></figure><p>我们先看看CommonAnnotationBeanPostProcessor的postProcessMergedBeanDefinition()方法</p><h4 id="6-2-1-PostConstruct，-PreDestroy和-Resource注解扫描"><a href="#6-2-1-PostConstruct，-PreDestroy和-Resource注解扫描" class="headerlink" title="6.2.1.@PostConstruct，@PreDestroy和@Resource注解扫描"></a>6.2.1.@PostConstruct，@PreDestroy和@Resource注解扫描</h4><p>CommonAnnotationBeanPostProcessor的postProcessMergedBeanDefinition()</p><figure class="highlight java"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-ile8qolhkez7dx"></i><span>java</span><div class="collapse show" id="collapse-ile8qolhkez7dx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">postProcessMergedBeanDefinition</span><span class="hljs-params">(RootBeanDefinition beanDefinition, Class&lt;?&gt; beanType, String beanName)</span> &#123;<br><span class="hljs-comment">//1.扫描@PostConstruct，@PreDestroy</span><br><span class="hljs-built_in">super</span>.postProcessMergedBeanDefinition(beanDefinition, beanType, beanName);<br><span class="hljs-comment">//2.@Resource注解的属性或者方法的收集</span><br><span class="hljs-type">InjectionMetadata</span> <span class="hljs-variable">metadata</span> <span class="hljs-operator">=</span> findResourceMetadata(beanName, beanType, <span class="hljs-literal">null</span>);<br>metadata.checkConfigMembers(beanDefinition);<br>&#125;<br></code></pre></td></tr></table></div></figure><p>分成两步完成相应注解的扫描：</p><ol><li><p>收集被@PostConstruct 和@PreDestroy 注解标注的方法<br> 1）CommonAnnotationBeanPostProcessor的构造函数先设置需要扫描的注解类型，再去父类InitDestroyAnnotationBeanPostProcessor中去扫描</p> <figure class="highlight java"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-lw53l9lhkez7dx"></i><span>java</span><div class="collapse show" id="collapse-lw53l9lhkez7dx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-title function_">CommonAnnotationBeanPostProcessor</span><span class="hljs-params">()</span> &#123;<br>setOrder(Ordered.LOWEST_PRECEDENCE - <span class="hljs-number">3</span>);<br><span class="hljs-comment">//在此处进行设置，到父类中去获取标记了这些注解的类</span><br>setInitAnnotationType(PostConstruct.class);<br>setDestroyAnnotationType(PreDestroy.class);<br>ignoreResourceType(<span class="hljs-string">&quot;javax.xml.ws.WebServiceContext&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></div></figure><p> 2）先看缓存中是否有，没有则重新去扫描</p> <figure class="highlight java"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-66iz45lhkez7dx"></i><span>java</span><div class="collapse show" id="collapse-66iz45lhkez7dx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">postProcessMergedBeanDefinition</span><span class="hljs-params">(RootBeanDefinition beanDefinition, Class&lt;?&gt; beanType, String beanName)</span> &#123;<br><span class="hljs-type">LifecycleMetadata</span> <span class="hljs-variable">metadata</span> <span class="hljs-operator">=</span> findLifecycleMetadata(beanType);<br>metadata.checkConfigMembers(beanDefinition);<br>&#125;<br><br><span class="hljs-keyword">private</span> LifecycleMetadata <span class="hljs-title function_">findLifecycleMetadata</span><span class="hljs-params">(Class&lt;?&gt; clazz)</span> &#123;<br><span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.lifecycleMetadataCache == <span class="hljs-literal">null</span>) &#123;<br><span class="hljs-comment">// 缓存没有</span><br><span class="hljs-keyword">return</span> buildLifecycleMetadata(clazz);<br>&#125;<br><span class="hljs-comment">// Quick check on the concurrent map first, with minimal locking.</span><br><span class="hljs-type">LifecycleMetadata</span> <span class="hljs-variable">metadata</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.lifecycleMetadataCache.get(clazz);<br><span class="hljs-keyword">if</span> (metadata == <span class="hljs-literal">null</span>) &#123;<br><span class="hljs-keyword">synchronized</span> (<span class="hljs-built_in">this</span>.lifecycleMetadataCache) &#123;<br>metadata = <span class="hljs-built_in">this</span>.lifecycleMetadataCache.get(clazz);<br><span class="hljs-keyword">if</span> (metadata == <span class="hljs-literal">null</span>) &#123;<br>metadata = buildLifecycleMetadata(clazz);<br><span class="hljs-built_in">this</span>.lifecycleMetadataCache.put(clazz, metadata);<br>&#125;<br><span class="hljs-keyword">return</span> metadata;<br>&#125;<br>&#125;<br><span class="hljs-keyword">return</span> metadata;<br>&#125;<br><br><span class="hljs-keyword">private</span> LifecycleMetadata <span class="hljs-title function_">buildLifecycleMetadata</span><span class="hljs-params">(<span class="hljs-keyword">final</span> Class&lt;?&gt; clazz)</span> &#123;<br><span class="hljs-keyword">if</span> (!AnnotationUtils.isCandidateClass(clazz, Arrays.asList(<span class="hljs-built_in">this</span>.initAnnotationType, <span class="hljs-built_in">this</span>.destroyAnnotationType))) &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.emptyLifecycleMetadata;<br>&#125;<br><span class="hljs-comment">//@PostConstruct 标记的方法</span><br>List&lt;LifecycleElement&gt; initMethods = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br><span class="hljs-comment">//@PreDestroy 标记的方法</span><br>List&lt;LifecycleElement&gt; destroyMethods = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>Class&lt;?&gt; targetClass = clazz;<br><br><span class="hljs-keyword">do</span> &#123;<br><span class="hljs-keyword">final</span> List&lt;LifecycleElement&gt; currInitMethods = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br><span class="hljs-keyword">final</span> List&lt;LifecycleElement&gt; currDestroyMethods = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br><span class="hljs-comment">//循环遍历类中所有的初始化和销毁的方法</span><br>ReflectionUtils.doWithLocalMethods(targetClass, method -&gt; &#123;<br><span class="hljs-comment">//收集@PostConstruct 标记的方法</span><br><span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.initAnnotationType != <span class="hljs-literal">null</span> &amp;&amp; method.isAnnotationPresent(<span class="hljs-built_in">this</span>.initAnnotationType)) &#123;<br><span class="hljs-type">LifecycleElement</span> <span class="hljs-variable">element</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">LifecycleElement</span>(method);<br>currInitMethods.add(element);<br><span class="hljs-keyword">if</span> (logger.isTraceEnabled()) &#123;<br>logger.trace(<span class="hljs-string">&quot;Found init method on class [&quot;</span> + clazz.getName() + <span class="hljs-string">&quot;]: &quot;</span> + method);<br>&#125;<br>&#125;<br><span class="hljs-comment">//收集@PreDestroy 标记的方法</span><br><span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.destroyAnnotationType != <span class="hljs-literal">null</span> &amp;&amp; method.isAnnotationPresent(<span class="hljs-built_in">this</span>.destroyAnnotationType)) &#123;<br>currDestroyMethods.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">LifecycleElement</span>(method));<br><span class="hljs-keyword">if</span> (logger.isTraceEnabled()) &#123;<br>logger.trace(<span class="hljs-string">&quot;Found destroy method on class [&quot;</span> + clazz.getName() + <span class="hljs-string">&quot;]: &quot;</span> + method);<br>&#125;<br>&#125;<br>&#125;);<br><br>initMethods.addAll(<span class="hljs-number">0</span>, currInitMethods);<br>destroyMethods.addAll(currDestroyMethods);<br>targetClass = targetClass.getSuperclass();<br>&#125;<br><span class="hljs-keyword">while</span> (targetClass != <span class="hljs-literal">null</span> &amp;&amp; targetClass != Object.class);<br><span class="hljs-keyword">return</span> (initMethods.isEmpty() &amp;&amp; destroyMethods.isEmpty() ? <span class="hljs-built_in">this</span>.emptyLifecycleMetadata :<br><span class="hljs-keyword">new</span> <span class="hljs-title class_">LifecycleMetadata</span>(clazz, initMethods, destroyMethods));<br>&#125;<br></code></pre></td></tr></table></div></figure></li><li><p>收集被@Resource 注解的标注的方法和属性<br> 1）先看缓存中是否有InjectionMetadata </p> <figure class="highlight java"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-klosrwlhkez7dx"></i><span>java</span><div class="collapse show" id="collapse-klosrwlhkez7dx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> InjectionMetadata <span class="hljs-title function_">findResourceMetadata</span><span class="hljs-params">(String beanName, <span class="hljs-keyword">final</span> Class&lt;?&gt; clazz, <span class="hljs-meta">@Nullable</span> PropertyValues pvs)</span> &#123;<br><span class="hljs-comment">// Fall back to class name as cache key, for backwards compatibility with custom callers.</span><br><span class="hljs-type">String</span> <span class="hljs-variable">cacheKey</span> <span class="hljs-operator">=</span> (StringUtils.hasLength(beanName) ? beanName : clazz.getName());<br><span class="hljs-comment">// Quick check on the concurrent map first, with minimal locking.</span><br><span class="hljs-type">InjectionMetadata</span> <span class="hljs-variable">metadata</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.injectionMetadataCache.get(cacheKey);<br><span class="hljs-comment">//缓存中不存在</span><br><span class="hljs-keyword">if</span> (InjectionMetadata.needsRefresh(metadata, clazz)) &#123;<br><span class="hljs-keyword">synchronized</span> (<span class="hljs-built_in">this</span>.injectionMetadataCache) &#123;<br>metadata = <span class="hljs-built_in">this</span>.injectionMetadataCache.get(cacheKey);<br><span class="hljs-keyword">if</span> (InjectionMetadata.needsRefresh(metadata, clazz)) &#123;<br><span class="hljs-keyword">if</span> (metadata != <span class="hljs-literal">null</span>) &#123;<br>metadata.clear(pvs);<br>&#125;<br>metadata = buildResourceMetadata(clazz);<br><span class="hljs-built_in">this</span>.injectionMetadataCache.put(cacheKey, metadata);<br>&#125;<br>&#125;<br>&#125;<br><span class="hljs-keyword">return</span> metadata;<br>&#125;<br></code></pre></td></tr></table></div></figure><p> 2）分别获取被@Resource注解的属性和方法(这里我们只关注@Resource注解的属性和方法)</p></li></ol><p> <img src="https://img-blog.csdnimg.cn/20210413105919770.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2tlemFkZQ==,size_16,color_FFFFFF,t_70"></p><pre><code class="hljs">3）最终把两个field 和Method 封装的对象集合封装到InjectionMetadata 对象中</code></pre><h4 id="6-2-2-Autowired和-Value注解扫描"><a href="#6-2-2-Autowired和-Value注解扫描" class="headerlink" title="6.2.2.@Autowired和@Value注解扫描"></a>6.2.2.@Autowired和@Value注解扫描</h4><p>AutowiredAnnotationBeanPostProcessor的postProcessMergedBeanDefinition()<br>AutowiredAnnotationBeanPostProcessor 类是对@Autowired 和@Value 注解的属性和方法的收集，收集<br>支持的注解类型可以在构造函数或者Static 静态块中找。收集过程基本上跟@Resource 注解的收集差不多。</p><figure class="highlight java"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-gxsfaplhkez7dx"></i><span>java</span><div class="collapse show" id="collapse-gxsfaplhkez7dx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-title function_">AutowiredAnnotationBeanPostProcessor</span><span class="hljs-params">()</span> &#123;<br><span class="hljs-built_in">this</span>.autowiredAnnotationTypes.add(Autowired.class);<br><span class="hljs-built_in">this</span>.autowiredAnnotationTypes.add(Value.class);<br><span class="hljs-keyword">try</span> &#123;<br><span class="hljs-built_in">this</span>.autowiredAnnotationTypes.add((Class&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Annotation</span>&gt;)<br>ClassUtils.forName(<span class="hljs-string">&quot;javax.inject.Inject&quot;</span>, AutowiredAnnotationBeanPostProcessor.class.getClassLoader()));<br>logger.trace(<span class="hljs-string">&quot;JSR-330 &#x27;javax.inject.Inject&#x27; annotation found and supported for autowiring&quot;</span>);<br>&#125;<br><span class="hljs-keyword">catch</span> (ClassNotFoundException ex) &#123;<br><span class="hljs-comment">// JSR-330 API not available - simply skip.</span><br>&#125;<br>&#125;<br></code></pre></td></tr></table></div></figure><p>收集过程跟上述@Resource 收集，调用的都是ReflectionUtils工具类中的方法，也是收集Field 和Method 上面的注解，然后放到InjectionMetadata对象中。</p><p>收集@Resource、@PostConstruct、@PreDestory、@Autowired 和@Value注解的方法或属性的过程结束。<br>下一章，我们讲讲依赖注入的过程，敬请期待。^_^</p>]]></content>
    
    
    <categories>
      
      <category>Spring源码学习</category>
      
    </categories>
    
    
    <tags>
      
      <tag>源码</tag>
      
      <tag>Spring</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>【Spring源码学习】Spring初始化机制(xml形式)</title>
    <link href="/posts/509140964.html"/>
    <url>/posts/509140964.html</url>
    
    <content type="html"><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><h2 id="Spring-容器加载方式"><a href="#Spring-容器加载方式" class="headerlink" title="Spring 容器加载方式"></a>Spring 容器加载方式</h2><ul><li><p>类路径获取配置文件</p><figure class="highlight java"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-o6ayi5lhkez7dx"></i><span>java</span><div class="collapse show" id="collapse-o6ayi5lhkez7dx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">ApplicationContext applicationContext= <span class="hljs-keyword">new</span> <span class="hljs-title class_">ClassPathXmlApplicationContext</span>(<span class="hljs-string">&quot;spring.xml&quot;</span>);<br></code></pre></td></tr></table></div></figure></li><li><p>文件系统路径获取配置文件[绝对路径]</p><figure class="highlight java"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-a2m425lhkez7dx"></i><span>java</span><div class="collapse show" id="collapse-a2m425lhkez7dx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">ApplicationContext</span> <span class="hljs-variable">applicationContext</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span><br><span class="hljs-title class_">FileSystemXmlApplicationContext</span>(<span class="hljs-string">&quot;E:\\idea\\springdemo\\spring.xml&quot;</span>);<br></code></pre></td></tr></table></div></figure></li><li><p>无 配 置 文 件 加 载 容 器</p><figure class="highlight java"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-by4woqlhkez7dx"></i><span>java</span><div class="collapse show" id="collapse-by4woqlhkez7dx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">ApplicationContext</span> <span class="hljs-variable">applicationContext</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span><br><span class="hljs-title class_">AnnotationConfigApplicationContext</span>(<span class="hljs-string">&quot;com.xx.jack&quot;</span>);<br></code></pre></td></tr></table></div></figure></li><li><p>Spring Boot 加载容器</p><figure class="highlight java"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-0m0ee4lhkez7dx"></i><span>java</span><div class="collapse show" id="collapse-0m0ee4lhkez7dx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">ApplicationContext</span> <span class="hljs-variable">applicationContext</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">EmbeddedWebApplicationContext</span>();<br></code></pre></td></tr></table></div></figure></li></ul><h2 id="Spring-初始化核心流程"><a href="#Spring-初始化核心流程" class="headerlink" title="Spring 初始化核心流程"></a>Spring 初始化核心流程</h2><p><strong>AbstractApplicationContext.refresh()</strong> 方法是 spring 容器启动过程中的核心方法，spring 容器要加载必须执行该方法。</p><figure class="highlight java"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-206weclhkez7dx"></i><span>java</span><div class="collapse show" id="collapse-206weclhkez7dx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">refresh</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> BeansException, IllegalStateException &#123;<br><span class="hljs-keyword">synchronized</span> (<span class="hljs-built_in">this</span>.startupShutdownMonitor) &#123;<br><span class="hljs-comment">//为容器初始化做准备，重要程度：0</span><br><span class="hljs-comment">// Prepare this context for refreshing.</span><br>prepareRefresh();<br><span class="hljs-comment">// 本章主要跟踪的内容</span><br><span class="hljs-type">ConfigurableListableBeanFactory</span> <span class="hljs-variable">beanFactory</span> <span class="hljs-operator">=</span> obtainFreshBeanFactory();<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * 给beanFactory设置一些属性值，可以不看</span><br><span class="hljs-comment"> * */</span><br><span class="hljs-comment">// Prepare the bean factory for use in this context.</span><br>prepareBeanFactory(beanFactory);<br><br><span class="hljs-keyword">try</span> &#123;<br><span class="hljs-comment">// Allows post-processing of the bean factory in context subclasses.</span><br>postProcessBeanFactory(beanFactory);<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * BeanDefinitionRegistryPostProcessor</span><br><span class="hljs-comment"> * BeanFactoryPostProcessor</span><br><span class="hljs-comment"> * 完成对这两个接口的调用</span><br><span class="hljs-comment"> * */</span><br><span class="hljs-comment">// Invoke factory processors registered as beans in the context.</span><br>invokeBeanFactoryPostProcessors(beanFactory);<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * 把实现了BeanPostProcessor接口的类实例化，并且加入到BeanFactory中</span><br><span class="hljs-comment"> * */</span><br><span class="hljs-comment">// Register bean processors that intercept bean creation.</span><br>registerBeanPostProcessors(beanFactory);<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * 国际化,重要程度2</span><br><span class="hljs-comment"> * */</span><br><span class="hljs-comment">// Initialize message source for this context.</span><br>initMessageSource();<br><br><span class="hljs-comment">//初始化事件管理类</span><br><span class="hljs-comment">// Initialize event multicaster for this context.</span><br>initApplicationEventMulticaster();<br><br><span class="hljs-comment">//这个方法着重理解模板设计模式，因为在springboot中，这个方法是用来做内嵌tomcat启动的</span><br><span class="hljs-comment">// Initialize other special beans in specific context subclasses.</span><br>onRefresh();<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * 往事件管理类中注册事件类</span><br><span class="hljs-comment"> * */</span><br><span class="hljs-comment">// Check for listener beans and register them.</span><br>registerListeners();<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * 这个方法是spring中最重要的方法，没有之一</span><br><span class="hljs-comment"> * 所以这个方法一定要理解要具体看</span><br><span class="hljs-comment"> * 1、bean实例化过程</span><br><span class="hljs-comment"> * 2、ioc</span><br><span class="hljs-comment"> * 3、注解支持</span><br><span class="hljs-comment"> * 4、BeanPostProcessor的执行</span><br><span class="hljs-comment"> * 5、Aop的入口</span><br><span class="hljs-comment"> * */</span><br><span class="hljs-comment">// Instantiate all remaining (non-lazy-init) singletons.</span><br>finishBeanFactoryInitialization(beanFactory);<br><br><span class="hljs-comment">// Last step: publish corresponding event.</span><br>finishRefresh();<br>&#125;<br><br><span class="hljs-keyword">catch</span> (BeansException ex) &#123;<br><span class="hljs-keyword">if</span> (logger.isWarnEnabled()) &#123;<br>logger.warn(<span class="hljs-string">&quot;Exception encountered during context initialization - &quot;</span> +<br><span class="hljs-string">&quot;cancelling refresh attempt: &quot;</span> + ex);<br>&#125;<br><br><span class="hljs-comment">// Destroy already created singletons to avoid dangling resources.</span><br>destroyBeans();<br><br><span class="hljs-comment">// Reset &#x27;active&#x27; flag.</span><br>cancelRefresh(ex);<br><br><span class="hljs-comment">// Propagate exception to caller.</span><br><span class="hljs-keyword">throw</span> ex;<br>&#125;<br><br><span class="hljs-keyword">finally</span> &#123;<br><span class="hljs-comment">// Reset common introspection caches in Spring&#x27;s core, since we</span><br><span class="hljs-comment">// might not ever need metadata for singleton beans anymore...</span><br>resetCommonCaches();<br>&#125;<br>&#125;<br>&#125;<br></code></pre></td></tr></table></div></figure><p>本节主要跟进spring.xml核心配置类的解析过程，该流程主要包括：</p><ul><li>创建BeanFactory对象</li><li>xml解析</li><li>封装成BeanDefinition对象</li></ul><h1 id="一、自定义标签解析"><a href="#一、自定义标签解析" class="headerlink" title="一、自定义标签解析"></a>一、自定义标签解析</h1><p>总结一下xml解析的主要流程：</p><ul><li>根据当前解析的标签头信息，找到对应的namespaceUri</li><li>加载Spring所有jar中的META-INF&#x2F;spring.handlers文件，并建立映射关系</li><li>根据namespaceUri从映射关系中找到对应的实现了NamespaceHandler接口的类</li><li>调用该类的init()方法，注册各种标签包括自定义标签的解析类</li><li>根据namespaceUri找到的对应的解析类，调用parse()方法完成标签的解析</li></ul><h1 id="二、Spring标签解析流程"><a href="#二、Spring标签解析流程" class="headerlink" title="二、Spring标签解析流程"></a>二、Spring标签解析流程</h1><p>先给出一个我自己画的时序图<br><img src="https://img-blog.csdnimg.cn/20210409181752149.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2tlemFkZQ==,size_16,color_FFFFFF,t_70#pic_center" alt="图1"></p><h1 id="三、源码跟踪"><a href="#三、源码跟踪" class="headerlink" title="三、源码跟踪"></a>三、源码跟踪</h1><p>入口</p><figure class="highlight java"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-iiyj7ylhkez7dx"></i><span>java</span><div class="collapse show" id="collapse-iiyj7ylhkez7dx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">ConfigurableListableBeanFactory</span> <span class="hljs-variable">beanFactory</span> <span class="hljs-operator">=</span> obtainFreshBeanFactory();<br></code></pre></td></tr></table></div></figure><h2 id="1-obtainFreshBeanFactory"><a href="#1-obtainFreshBeanFactory" class="headerlink" title="1.obtainFreshBeanFactory()"></a>1.obtainFreshBeanFactory()</h2><figure class="highlight java"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-2ddfijlhkez7dx"></i><span>java</span><div class="collapse show" id="collapse-2ddfijlhkez7dx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">protected</span> ConfigurableListableBeanFactory <span class="hljs-title function_">obtainFreshBeanFactory</span><span class="hljs-params">()</span> &#123;<br><span class="hljs-comment">//核心方法，必须读，重要程度：5</span><br><span class="hljs-comment">//模板模式，子类实现钩子方法</span><br>refreshBeanFactory();<br><span class="hljs-keyword">return</span> getBeanFactory();<br>&#125;<br><br><span class="hljs-keyword">protected</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">refreshBeanFactory</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> BeansException, IllegalStateException;<br></code></pre></td></tr></table></div></figure><h2 id="2-refreshBeanFactory"><a href="#2-refreshBeanFactory" class="headerlink" title="2.refreshBeanFactory()"></a>2.refreshBeanFactory()</h2><p>refreshBeanFactory()实现类为AbstractRefreshableApplicationContext</p><figure class="highlight java"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-l483nalhkez7dx"></i><span>java</span><div class="collapse show" id="collapse-l483nalhkez7dx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">refreshBeanFactory</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> BeansException &#123;<br><span class="hljs-comment">//1.如果BeanFactory不为空，则清除BeanFactory和里面的实例</span><br><span class="hljs-keyword">if</span> (hasBeanFactory()) &#123;<br>destroyBeans();<br>closeBeanFactory();<br>&#125;<br><span class="hljs-keyword">try</span> &#123;<br><span class="hljs-comment">//2.创建BeanFactory实例工厂</span><br><span class="hljs-type">DefaultListableBeanFactory</span> <span class="hljs-variable">beanFactory</span> <span class="hljs-operator">=</span> createBeanFactory();<br>beanFactory.setSerializationId(getId());<br><span class="hljs-comment">//3.1设置是否可以循环依赖 allowCircularReferences，默认允许</span><br><span class="hljs-comment">//3.2是否允许使用相同名称重新注册不同的bean实现.</span><br>customizeBeanFactory(beanFactory);<br><span class="hljs-comment">//4.解析xml，并把xml中的标签封装成BeanDefinition对象</span><br>loadBeanDefinitions(beanFactory);<br><span class="hljs-built_in">this</span>.beanFactory = beanFactory;<br>&#125;<br><span class="hljs-keyword">catch</span> (IOException ex) &#123;<br><span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ApplicationContextException</span>(<span class="hljs-string">&quot;I/O error parsing bean definition source for &quot;</span> + getDisplayName(), ex);<br>&#125;<br>&#125;<br></code></pre></td></tr></table></div></figure><p><strong>注意</strong><br>customizeBeanFactory(beanFactory)中关于设置是否循环依赖和是否可以覆盖bean定义名称，可以通过applicationContext上下文来修改，修改后必须要refresh()重新加载。建议不修改，没有意义。</p><figure class="highlight java"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-axiwsalhkez7dx"></i><span>java</span><div class="collapse show" id="collapse-axiwsalhkez7dx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java">applicationContext.setAllowBeanDefinitionOverriding(<span class="hljs-literal">false</span>);<br>applicationContext.setAllowCircularReferences(<span class="hljs-literal">true</span>);<br>applicationContext.refresh();<br></code></pre></td></tr></table></div></figure><p>进入loadBeanDefinitions()方法</p><h2 id="3-loadBeanDefinitions"><a href="#3-loadBeanDefinitions" class="headerlink" title="3.loadBeanDefinitions()"></a>3.loadBeanDefinitions()</h2><figure class="highlight java"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-s6e6l0lhkez7dx"></i><span>java</span><div class="collapse show" id="collapse-s6e6l0lhkez7dx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//AbstractXmlApplicationContext</span><br><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">loadBeanDefinitions</span><span class="hljs-params">(DefaultListableBeanFactory beanFactory)</span> <span class="hljs-keyword">throws</span> BeansException, IOException &#123;<br><span class="hljs-comment">// Create a new XmlBeanDefinitionReader for the given BeanFactory.</span><br><span class="hljs-comment">//创建xml的解析器，这里是一个委托模式</span><br><span class="hljs-type">XmlBeanDefinitionReader</span> <span class="hljs-variable">beanDefinitionReader</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">XmlBeanDefinitionReader</span>(beanFactory);<br><br><span class="hljs-comment">// Configure the bean definition reader with this context&#x27;s</span><br><span class="hljs-comment">// resource loading environment.</span><br>beanDefinitionReader.setEnvironment(<span class="hljs-built_in">this</span>.getEnvironment());<br><span class="hljs-comment">//这里传一个this进去，因为ApplicationContext是实现了ResourceLoader接口的</span><br>beanDefinitionReader.setResourceLoader(<span class="hljs-built_in">this</span>);<br>beanDefinitionReader.setEntityResolver(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ResourceEntityResolver</span>(<span class="hljs-built_in">this</span>));<br><br><span class="hljs-comment">// Allow a subclass to provide custom initialization of the reader,</span><br><span class="hljs-comment">// then proceed with actually loading the bean definitions.</span><br>initBeanDefinitionReader(beanDefinitionReader);<br><span class="hljs-comment">//主要看这个方法  重要程度 5</span><br>loadBeanDefinitions(beanDefinitionReader);<br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment">* 委托给XmlBeanDefinitionReader解析xml文件</span><br><span class="hljs-comment">*/</span><br><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">loadBeanDefinitions</span><span class="hljs-params">(XmlBeanDefinitionReader reader)</span> <span class="hljs-keyword">throws</span> BeansException, IOException &#123;<br>Resource[] configResources = getConfigResources();<br><span class="hljs-keyword">if</span> (configResources != <span class="hljs-literal">null</span>) &#123;<br>reader.loadBeanDefinitions(configResources);<br>&#125;<br><span class="hljs-comment">//获取需要加载的xml配置文件</span><br>String[] configLocations = getConfigLocations();<br><span class="hljs-keyword">if</span> (configLocations != <span class="hljs-literal">null</span>) &#123;<br>reader.loadBeanDefinitions(configLocations);<br>&#125;<br>&#125;<br></code></pre></td></tr></table></div></figure><p>进入AbstractBeanDefinitionReader.loadBeanDefinitions的重载方法</p><figure class="highlight java"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-p5962vlhkez7dx"></i><span>java</span><div class="collapse show" id="collapse-p5962vlhkez7dx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">loadBeanDefinitions</span><span class="hljs-params">(String location, <span class="hljs-meta">@Nullable</span> Set&lt;Resource&gt; actualResources)</span> <span class="hljs-keyword">throws</span> BeanDefinitionStoreException &#123;<br><span class="hljs-type">ResourceLoader</span> <span class="hljs-variable">resourceLoader</span> <span class="hljs-operator">=</span> getResourceLoader();<br><span class="hljs-keyword">if</span> (resourceLoader == <span class="hljs-literal">null</span>) &#123;<br><span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BeanDefinitionStoreException</span>(<br><span class="hljs-string">&quot;Cannot load bean definitions from location [&quot;</span> + location + <span class="hljs-string">&quot;]: no ResourceLoader available&quot;</span>);<br>&#125;<br><br><span class="hljs-keyword">if</span> (resourceLoader <span class="hljs-keyword">instanceof</span> ResourcePatternResolver) &#123;<br><span class="hljs-comment">// Resource pattern matching available.</span><br><span class="hljs-keyword">try</span> &#123;<br><span class="hljs-comment">//把字符串类型的xml文件路径，形如：classpath*:user/**/*-context.xml,转换成Resource对象类型，其实就是用流</span><br><span class="hljs-comment">//的方式加载配置文件，然后封装成Resource对象，不重要，可以不看</span><br>Resource[] resources = ((ResourcePatternResolver) resourceLoader).getResources(location);<br><span class="hljs-comment">//主要看这个方法 ** 重要程度 5</span><br><span class="hljs-type">int</span> <span class="hljs-variable">count</span> <span class="hljs-operator">=</span> loadBeanDefinitions(resources);<br><span class="hljs-keyword">if</span> (actualResources != <span class="hljs-literal">null</span>) &#123;<br>Collections.addAll(actualResources, resources);<br>&#125;<br><span class="hljs-keyword">if</span> (logger.isTraceEnabled()) &#123;<br>logger.trace(<span class="hljs-string">&quot;Loaded &quot;</span> + count + <span class="hljs-string">&quot; bean definitions from location pattern [&quot;</span> + location + <span class="hljs-string">&quot;]&quot;</span>);<br>&#125;<br><span class="hljs-keyword">return</span> count;<br>&#125;<br><span class="hljs-keyword">catch</span> (IOException ex) &#123;<br><span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BeanDefinitionStoreException</span>(<br><span class="hljs-string">&quot;Could not resolve bean definition resource pattern [&quot;</span> + location + <span class="hljs-string">&quot;]&quot;</span>, ex);<br>&#125;<br>&#125;<br><span class="hljs-keyword">else</span> &#123;<br><span class="hljs-comment">// Can only load single resources by absolute URL.</span><br><span class="hljs-type">Resource</span> <span class="hljs-variable">resource</span> <span class="hljs-operator">=</span> resourceLoader.getResource(location);<br><span class="hljs-type">int</span> <span class="hljs-variable">count</span> <span class="hljs-operator">=</span> loadBeanDefinitions(resource);<br><span class="hljs-keyword">if</span> (actualResources != <span class="hljs-literal">null</span>) &#123;<br>actualResources.add(resource);<br>&#125;<br><span class="hljs-keyword">if</span> (logger.isTraceEnabled()) &#123;<br>logger.trace(<span class="hljs-string">&quot;Loaded &quot;</span> + count + <span class="hljs-string">&quot; bean definitions from location [&quot;</span> + location + <span class="hljs-string">&quot;]&quot;</span>);<br>&#125;<br><span class="hljs-keyword">return</span> count;<br>&#125;<br>&#125;<br></code></pre></td></tr></table></div></figure><p>然后进入</p><figure class="highlight java"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-a6s165lhkez7dx"></i><span>java</span><div class="collapse show" id="collapse-a6s165lhkez7dx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">loadBeanDefinitions</span><span class="hljs-params">(Resource... resources)</span> <span class="hljs-keyword">throws</span> BeanDefinitionStoreException &#123;<br>Assert.notNull(resources, <span class="hljs-string">&quot;Resource array must not be null&quot;</span>);<br><span class="hljs-type">int</span> <span class="hljs-variable">count</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br><span class="hljs-keyword">for</span> (Resource resource : resources) &#123;<br><span class="hljs-comment">//模板设计模式，调用到子类中的方法</span><br>count += loadBeanDefinitions(resource);<br>&#125;<br><span class="hljs-keyword">return</span> count;<br>&#125;<br></code></pre></td></tr></table></div></figure><p>调用的是子类XmlBeanDefinitionReader的实现方法</p><figure class="highlight java"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-uzu09xlhkez7dx"></i><span>java</span><div class="collapse show" id="collapse-uzu09xlhkez7dx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">loadBeanDefinitions</span><span class="hljs-params">(Resource resource)</span> <span class="hljs-keyword">throws</span> BeanDefinitionStoreException &#123;<br><span class="hljs-comment">//EncodedResource带编码的对Resource对象的封装</span><br><span class="hljs-keyword">return</span> loadBeanDefinitions(<span class="hljs-keyword">new</span> <span class="hljs-title class_">EncodedResource</span>(resource));<br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">loadBeanDefinitions</span><span class="hljs-params">(EncodedResource encodedResource)</span> <span class="hljs-keyword">throws</span> BeanDefinitionStoreException &#123;<br>Assert.notNull(encodedResource, <span class="hljs-string">&quot;EncodedResource must not be null&quot;</span>);<br><span class="hljs-keyword">if</span> (logger.isTraceEnabled()) &#123;<br>logger.trace(<span class="hljs-string">&quot;Loading XML bean definitions from &quot;</span> + encodedResource);<br>&#125;<br><br>Set&lt;EncodedResource&gt; currentResources = <span class="hljs-built_in">this</span>.resourcesCurrentlyBeingLoaded.get();<br><br><span class="hljs-keyword">if</span> (!currentResources.add(encodedResource)) &#123;<br><span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BeanDefinitionStoreException</span>(<br><span class="hljs-string">&quot;Detected cyclic loading of &quot;</span> + encodedResource + <span class="hljs-string">&quot; - check your import definitions!&quot;</span>);<br>&#125;<br><br><span class="hljs-comment">//获取Resource对象中的xml文件流对象</span><br><span class="hljs-keyword">try</span> (<span class="hljs-type">InputStream</span> <span class="hljs-variable">inputStream</span> <span class="hljs-operator">=</span> encodedResource.getResource().getInputStream()) &#123;<br><br><span class="hljs-comment">//InputSource是jdk中的sax xml文件解析对象</span><br><span class="hljs-type">InputSource</span> <span class="hljs-variable">inputSource</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InputSource</span>(inputStream);<br><span class="hljs-keyword">if</span> (encodedResource.getEncoding() != <span class="hljs-literal">null</span>) &#123;<br>inputSource.setEncoding(encodedResource.getEncoding());<br>&#125;<br><span class="hljs-comment">//主要看这个方法 **  重要程度 5</span><br><span class="hljs-keyword">return</span> doLoadBeanDefinitions(inputSource, encodedResource.getResource());<br>&#125;<br><span class="hljs-keyword">catch</span> (IOException ex) &#123;<br><span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BeanDefinitionStoreException</span>(<br><span class="hljs-string">&quot;IOException parsing XML document from &quot;</span> + encodedResource.getResource(), ex);<br>&#125;<br><span class="hljs-keyword">finally</span> &#123;<br>currentResources.remove(encodedResource);<br><span class="hljs-keyword">if</span> (currentResources.isEmpty()) &#123;<br><span class="hljs-built_in">this</span>.resourcesCurrentlyBeingLoaded.remove();<br>&#125;<br>&#125;<br>&#125;<br></code></pre></td></tr></table></div></figure><h2 id="4-doLoadBeanDefinitions"><a href="#4-doLoadBeanDefinitions" class="headerlink" title="4.doLoadBeanDefinitions()"></a>4.doLoadBeanDefinitions()</h2><p>完成两个动作</p><ul><li>把inputSource封装成Document文件对象</li><li>根据解析出来的document对象，拿到里面的标签元素封装成BeanDefinition<figure class="highlight java"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-7erfnqlhkez7dx"></i><span>java</span><div class="collapse show" id="collapse-7erfnqlhkez7dx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">protected</span> <span class="hljs-type">int</span> <span class="hljs-title function_">doLoadBeanDefinitions</span><span class="hljs-params">(InputSource inputSource, Resource resource)</span><br><span class="hljs-keyword">throws</span> BeanDefinitionStoreException &#123;<br><br><span class="hljs-keyword">try</span> &#123;<br><span class="hljs-comment">//把inputSource 封装成Document文件对象，这是jdk的API</span><br><span class="hljs-type">Document</span> <span class="hljs-variable">doc</span> <span class="hljs-operator">=</span> doLoadDocument(inputSource, resource);<br><br><span class="hljs-comment">//主要看这个方法，根据解析出来的document对象，拿到里面的标签元素封装成BeanDefinition</span><br><span class="hljs-type">int</span> <span class="hljs-variable">count</span> <span class="hljs-operator">=</span> registerBeanDefinitions(doc, resource);<br><span class="hljs-keyword">if</span> (logger.isDebugEnabled()) &#123;<br>logger.debug(<span class="hljs-string">&quot;Loaded &quot;</span> + count + <span class="hljs-string">&quot; bean definitions from &quot;</span> + resource);<br>&#125;<br><span class="hljs-keyword">return</span> count;<br>&#125;<br><span class="hljs-keyword">catch</span> (BeanDefinitionStoreException ex) &#123;<br><span class="hljs-keyword">throw</span> ex;<br>&#125;<br><span class="hljs-keyword">catch</span> (SAXParseException ex) &#123;<br><span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">XmlBeanDefinitionStoreException</span>(resource.getDescription(),<br><span class="hljs-string">&quot;Line &quot;</span> + ex.getLineNumber() + <span class="hljs-string">&quot; in XML document from &quot;</span> + resource + <span class="hljs-string">&quot; is invalid&quot;</span>, ex);<br>&#125;<br><span class="hljs-keyword">catch</span> (SAXException ex) &#123;<br><span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">XmlBeanDefinitionStoreException</span>(resource.getDescription(),<br><span class="hljs-string">&quot;XML document from &quot;</span> + resource + <span class="hljs-string">&quot; is invalid&quot;</span>, ex);<br>&#125;<br><span class="hljs-keyword">catch</span> (ParserConfigurationException ex) &#123;<br><span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BeanDefinitionStoreException</span>(resource.getDescription(),<br><span class="hljs-string">&quot;Parser configuration exception parsing XML from &quot;</span> + resource, ex);<br>&#125;<br><span class="hljs-keyword">catch</span> (IOException ex) &#123;<br><span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BeanDefinitionStoreException</span>(resource.getDescription(),<br><span class="hljs-string">&quot;IOException parsing XML document from &quot;</span> + resource, ex);<br>&#125;<br><span class="hljs-keyword">catch</span> (Throwable ex) &#123;<br><span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BeanDefinitionStoreException</span>(resource.getDescription(),<br><span class="hljs-string">&quot;Unexpected exception parsing XML document from &quot;</span> + resource, ex);<br>&#125;<br>&#125;<br></code></pre></td></tr></table></div></figure></li></ul><h2 id="5-registerBeanDefinitions"><a href="#5-registerBeanDefinitions" class="headerlink" title="5.registerBeanDefinitions()"></a>5.registerBeanDefinitions()</h2><figure class="highlight java"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-cbmtmelhkez7dx"></i><span>java</span><div class="collapse show" id="collapse-cbmtmelhkez7dx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">registerBeanDefinitions</span><span class="hljs-params">(Document doc, Resource resource)</span> <span class="hljs-keyword">throws</span> BeanDefinitionStoreException &#123;<br><span class="hljs-comment">//又来一记委托模式，BeanDefinitionDocumentReader委托这个类进行document的解析</span><br><span class="hljs-type">BeanDefinitionDocumentReader</span> <span class="hljs-variable">documentReader</span> <span class="hljs-operator">=</span> createBeanDefinitionDocumentReader();<br><span class="hljs-type">int</span> <span class="hljs-variable">countBefore</span> <span class="hljs-operator">=</span> getRegistry().getBeanDefinitionCount();<br><br><span class="hljs-comment">//主要看这个方法，createReaderContext(resource) XmlReaderContext上下文，封装了XmlBeanDefinitionReader对象</span><br>documentReader.registerBeanDefinitions(doc, createReaderContext(resource));<br><span class="hljs-keyword">return</span> getRegistry().getBeanDefinitionCount() - countBefore;<br>&#125;<br></code></pre></td></tr></table></div></figure><p>交由DefaultBeanDefinitionDocumentReader.registerBeanDefinitions()处理</p><figure class="highlight java"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-fbr2ivlhkez7dx"></i><span>java</span><div class="collapse show" id="collapse-fbr2ivlhkez7dx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">registerBeanDefinitions</span><span class="hljs-params">(Document doc, XmlReaderContext readerContext)</span> &#123;<br><span class="hljs-built_in">this</span>.readerContext = readerContext;<br><span class="hljs-comment">//主要看这个方法，把root节点传进去</span><br>doRegisterBeanDefinitions(doc.getDocumentElement());<br>&#125;<br><br><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doRegisterBeanDefinitions</span><span class="hljs-params">(Element root)</span> &#123;<br><span class="hljs-type">BeanDefinitionParserDelegate</span> <span class="hljs-variable">parent</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.delegate;<br><span class="hljs-built_in">this</span>.delegate = createDelegate(getReaderContext(), root, parent);<br><span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.delegate.isDefaultNamespace(root)) &#123;<br><span class="hljs-type">String</span> <span class="hljs-variable">profileSpec</span> <span class="hljs-operator">=</span> root.getAttribute(PROFILE_ATTRIBUTE);<br><span class="hljs-keyword">if</span> (StringUtils.hasText(profileSpec)) &#123;<br>String[] specifiedProfiles = StringUtils.tokenizeToStringArray(<br>profileSpec, BeanDefinitionParserDelegate.MULTI_VALUE_ATTRIBUTE_DELIMITERS);<br><span class="hljs-comment">// We cannot use Profiles.of(...) since profile expressions are not supported</span><br><span class="hljs-comment">// in XML config. See SPR-12458 for details.</span><br><span class="hljs-keyword">if</span> (!getReaderContext().getEnvironment().acceptsProfiles(specifiedProfiles)) &#123;<br><span class="hljs-keyword">if</span> (logger.isDebugEnabled()) &#123;<br>logger.debug(<span class="hljs-string">&quot;Skipped XML bean definition file due to specified profiles [&quot;</span> + profileSpec +<br><span class="hljs-string">&quot;] not matching: &quot;</span> + getReaderContext().getResource());<br>&#125;<br><span class="hljs-keyword">return</span>;<br>&#125;<br>&#125;<br>&#125;<br>preProcessXml(root);<br><span class="hljs-comment">//主要看这个方法，标签具体解析过程</span><br>parseBeanDefinitions(root, <span class="hljs-built_in">this</span>.delegate);<br>postProcessXml(root);<br><span class="hljs-built_in">this</span>.delegate = parent;<br>&#125;<br><br><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">parseBeanDefinitions</span><span class="hljs-params">(Element root, BeanDefinitionParserDelegate delegate)</span> &#123;<br><span class="hljs-keyword">if</span> (delegate.isDefaultNamespace(root)) &#123;<br><span class="hljs-type">NodeList</span> <span class="hljs-variable">nl</span> <span class="hljs-operator">=</span> root.getChildNodes();<br><span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; nl.getLength(); i++) &#123;<br><span class="hljs-type">Node</span> <span class="hljs-variable">node</span> <span class="hljs-operator">=</span> nl.item(i);<br><span class="hljs-keyword">if</span> (node <span class="hljs-keyword">instanceof</span> Element) &#123;<br><span class="hljs-type">Element</span> <span class="hljs-variable">ele</span> <span class="hljs-operator">=</span> (Element) node;<br><span class="hljs-keyword">if</span> (delegate.isDefaultNamespace(ele)) &#123;<br><span class="hljs-comment">//默认标签解析</span><br>parseDefaultElement(ele, delegate);<br>&#125;<br><span class="hljs-keyword">else</span> &#123;<br><span class="hljs-comment">//自定义标签解析</span><br>delegate.parseCustomElement(ele);<br>&#125;<br>&#125;<br>&#125;<br>&#125;<br><span class="hljs-keyword">else</span> &#123;<br>delegate.parseCustomElement(root);<br>&#125;<br>&#125;<br></code></pre></td></tr></table></div></figure><p>可以看出有两种解析的类型：</p><ul><li>Spring默认标签</li><li>自定义标签</li></ul><p>我们先看默认标签是怎么解析的。</p><h2 id="6-parseDefaultElement"><a href="#6-parseDefaultElement" class="headerlink" title="6.parseDefaultElement()"></a>6.parseDefaultElement()</h2><figure class="highlight java"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-2ijvzvlhkez7dx"></i><span>java</span><div class="collapse show" id="collapse-2ijvzvlhkez7dx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">parseDefaultElement</span><span class="hljs-params">(Element ele, BeanDefinitionParserDelegate delegate)</span> &#123;<br><span class="hljs-comment">//import标签解析  重要程度 1 ，可看可不看</span><br><span class="hljs-keyword">if</span> (delegate.nodeNameEquals(ele, IMPORT_ELEMENT)) &#123;<br>importBeanDefinitionResource(ele);<br>&#125;<br><span class="hljs-comment">//alias标签解析 别名标签  重要程度 1 ，可看可不看</span><br><span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (delegate.nodeNameEquals(ele, ALIAS_ELEMENT)) &#123;<br>processAliasRegistration(ele);<br>&#125;<br><span class="hljs-comment">//bean标签，重要程度  5，必须看</span><br><span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (delegate.nodeNameEquals(ele, BEAN_ELEMENT)) &#123;<br>processBeanDefinition(ele, delegate);<br>&#125;<br><span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (delegate.nodeNameEquals(ele, NESTED_BEANS_ELEMENT)) &#123;<br><span class="hljs-comment">// recurse</span><br>doRegisterBeanDefinitions(ele);<br>&#125;<br>&#125;<br></code></pre></td></tr></table></div></figure><p>默认标签主要解析</p><ul><li>import</li><li>alias</li><li>bean</li><li>beans</li></ul><p>这里我主要跟踪bean标签的解析过程：</p><figure class="highlight java"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-dp10w9lhkez7dx"></i><span>java</span><div class="collapse show" id="collapse-dp10w9lhkez7dx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">processBeanDefinition</span><span class="hljs-params">(Element ele, BeanDefinitionParserDelegate delegate)</span> &#123;<br><span class="hljs-comment">//重点看这个方法，重要程度 5 ，解析document，封装成BeanDefinition</span><br><span class="hljs-type">BeanDefinitionHolder</span> <span class="hljs-variable">bdHolder</span> <span class="hljs-operator">=</span> delegate.parseBeanDefinitionElement(ele);<br><span class="hljs-keyword">if</span> (bdHolder != <span class="hljs-literal">null</span>) &#123;<br><span class="hljs-comment">//该方法功能不重要，设计模式重点看一下，装饰者设计模式，加上SPI设计思想</span><br>bdHolder = delegate.decorateBeanDefinitionIfRequired(ele, bdHolder);<br><span class="hljs-keyword">try</span> &#123;<br><span class="hljs-comment">//完成document到BeanDefinition对象转换后，对BeanDefinition对象进行缓存注册</span><br><span class="hljs-comment">// Register the final decorated instance.</span><br>BeanDefinitionReaderUtils.registerBeanDefinition(bdHolder, getReaderContext().getRegistry());<br>&#125;<br><span class="hljs-keyword">catch</span> (BeanDefinitionStoreException ex) &#123;<br>getReaderContext().error(<span class="hljs-string">&quot;Failed to register bean definition with name &#x27;&quot;</span> +<br>bdHolder.getBeanName() + <span class="hljs-string">&quot;&#x27;&quot;</span>, ele, ex);<br>&#125;<br><span class="hljs-comment">// Send registration event.</span><br>getReaderContext().fireComponentRegistered(<span class="hljs-keyword">new</span> <span class="hljs-title class_">BeanComponentDefinition</span>(bdHolder));<br>&#125;<br>&#125;<br></code></pre></td></tr></table></div></figure><p>BeanDefinitionHolder这个类有两个很重要的属性：beanDefinition和beanName</p><figure class="highlight java"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-an6td4lhkez7dx"></i><span>java</span><div class="collapse show" id="collapse-an6td4lhkez7dx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BeanDefinitionHolder</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">BeanMetadataElement</span> &#123;<br><span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> BeanDefinition beanDefinition;<br><span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String beanName;<br><span class="hljs-comment">//aliases作用：通过aliases找到beanName，根据beanName拿到beanDefinition对象。</span><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String[] aliases;<br>......<br>&#125;<br></code></pre></td></tr></table></div></figure><figure class="highlight java"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-0cl8mulhkez7dx"></i><span>java</span><div class="collapse show" id="collapse-0cl8mulhkez7dx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment">* BeanDefinitionParserDelegate</span><br><span class="hljs-comment">* Description: 解析Element并返回 BeanDefinitionHolder</span><br><span class="hljs-comment">*/</span><br><span class="hljs-keyword">public</span> BeanDefinitionHolder <span class="hljs-title function_">parseBeanDefinitionElement</span><span class="hljs-params">(Element ele, <span class="hljs-meta">@Nullable</span> BeanDefinition containingBean)</span> &#123;<br><span class="hljs-type">String</span> <span class="hljs-variable">id</span> <span class="hljs-operator">=</span> ele.getAttribute(ID_ATTRIBUTE);<br><span class="hljs-type">String</span> <span class="hljs-variable">nameAttr</span> <span class="hljs-operator">=</span> ele.getAttribute(NAME_ATTRIBUTE);<br>List&lt;String&gt; aliases = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br><span class="hljs-keyword">if</span> (StringUtils.hasLength(nameAttr)) &#123;<br>String[] nameArr = StringUtils.tokenizeToStringArray(nameAttr, MULTI_VALUE_ATTRIBUTE_DELIMITERS);<br>aliases.addAll(Arrays.asList(nameArr));<br>&#125;<br><span class="hljs-type">String</span> <span class="hljs-variable">beanName</span> <span class="hljs-operator">=</span> id;<br><span class="hljs-keyword">if</span> (!StringUtils.hasText(beanName) &amp;&amp; !aliases.isEmpty()) &#123;<br>beanName = aliases.remove(<span class="hljs-number">0</span>);<br><span class="hljs-keyword">if</span> (logger.isTraceEnabled()) &#123;<br>logger.trace(<span class="hljs-string">&quot;No XML &#x27;id&#x27; specified - using &#x27;&quot;</span> + beanName +<br><span class="hljs-string">&quot;&#x27; as bean name and &quot;</span> + aliases + <span class="hljs-string">&quot; as aliases&quot;</span>);<br>&#125;<br>&#125;<br><span class="hljs-comment">// 检查 beanName 是否重复</span><br><span class="hljs-keyword">if</span> (containingBean == <span class="hljs-literal">null</span>) &#123;<br>checkNameUniqueness(beanName, aliases, ele);<br>&#125;<br><span class="hljs-comment">// 重点，解析BeanDefinitionElement</span><br><span class="hljs-type">AbstractBeanDefinition</span> <span class="hljs-variable">beanDefinition</span> <span class="hljs-operator">=</span> parseBeanDefinitionElement(ele, beanName, containingBean);<br><span class="hljs-comment">// 此处省略没用的代码</span><br>......<br>String[] aliasesArray = StringUtils.toStringArray(aliases);<br><span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BeanDefinitionHolder</span>(beanDefinition, beanName, aliasesArray);<br>&#125;<br></code></pre></td></tr></table></div></figure><p>进入BeanDefinitionParserDelegate.parseBeanDefinitionElement()方法</p><figure class="highlight java"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-y4z46alhkez7dx"></i><span>java</span><div class="collapse show" id="collapse-y4z46alhkez7dx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> AbstractBeanDefinition <span class="hljs-title function_">parseBeanDefinitionElement</span><span class="hljs-params">(</span><br><span class="hljs-params">Element ele, String beanName, <span class="hljs-meta">@Nullable</span> BeanDefinition containingBean)</span> &#123;<br><span class="hljs-built_in">this</span>.parseState.push(<span class="hljs-keyword">new</span> <span class="hljs-title class_">BeanEntry</span>(beanName));<br><span class="hljs-type">String</span> <span class="hljs-variable">className</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br><span class="hljs-keyword">if</span> (ele.hasAttribute(CLASS_ATTRIBUTE)) &#123;<br>className = ele.getAttribute(CLASS_ATTRIBUTE).trim();<br>&#125;<br><span class="hljs-type">String</span> <span class="hljs-variable">parent</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br><span class="hljs-keyword">if</span> (ele.hasAttribute(PARENT_ATTRIBUTE)) &#123;<br>parent = ele.getAttribute(PARENT_ATTRIBUTE);<br>&#125;<br><span class="hljs-keyword">try</span> &#123;<br><span class="hljs-comment">//创建GenericBeanDefinition对象</span><br><span class="hljs-type">AbstractBeanDefinition</span> <span class="hljs-variable">bd</span> <span class="hljs-operator">=</span> createBeanDefinition(className, parent);<br><span class="hljs-comment">//解析bean标签的属性，并把解析出来的属性设置到BeanDefinition对象中</span><br>parseBeanDefinitionAttributes(ele, beanName, containingBean, bd);<br>bd.setDescription(DomUtils.getChildElementValueByTagName(ele, DESCRIPTION_ELEMENT));<br><span class="hljs-comment">//解析bean中的meta标签</span><br>parseMetaElements(ele, bd);<br><span class="hljs-comment">//解析bean中的lookup-method标签  重要程度：2，可看可不看</span><br>parseLookupOverrideSubElements(ele, bd.getMethodOverrides());<br><span class="hljs-comment">//解析bean中的replaced-method标签  重要程度：2，可看可不看</span><br>parseReplacedMethodSubElements(ele, bd.getMethodOverrides());<br><span class="hljs-comment">//解析bean中的constructor-arg标签  重要程度：2，可看可不看</span><br>parseConstructorArgElements(ele, bd);<br><span class="hljs-comment">//解析bean中的property标签  重要程度：2，可看可不看</span><br>parsePropertyElements(ele, bd);<br><span class="hljs-comment">//可以不看，用不到</span><br>parseQualifierElements(ele, bd);<br>bd.setResource(<span class="hljs-built_in">this</span>.readerContext.getResource());<br>bd.setSource(extractSource(ele));<br><span class="hljs-keyword">return</span> bd;<br>&#125;<br><span class="hljs-keyword">catch</span> (ClassNotFoundException ex) &#123;<br>error(<span class="hljs-string">&quot;Bean class [&quot;</span> + className + <span class="hljs-string">&quot;] not found&quot;</span>, ele, ex);<br>&#125;<br><span class="hljs-keyword">catch</span> (NoClassDefFoundError err) &#123;<br>error(<span class="hljs-string">&quot;Class that bean class [&quot;</span> + className + <span class="hljs-string">&quot;] depends on not found&quot;</span>, ele, err);<br>&#125;<br><span class="hljs-keyword">catch</span> (Throwable ex) &#123;<br>error(<span class="hljs-string">&quot;Unexpected failure during bean definition parsing&quot;</span>, ele, ex);<br>&#125;<br><span class="hljs-keyword">finally</span> &#123;<br><span class="hljs-built_in">this</span>.parseState.pop();<br>&#125;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>&#125;<br></code></pre></td></tr></table></div></figure><p>其中，</p><ul><li>parseBeanDefinitionAttributes：负责解析&lt;bean&gt;属性，形如：<figure class="highlight xml"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-yffr4hlhkez7dx"></i><span>xml</span><div class="collapse show" id="collapse-yffr4hlhkez7dx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;com.enjoy.jack.bean.Student&quot;</span> </span><br><span class="hljs-tag"><span class="hljs-attr">id</span>=<span class="hljs-string">&quot;student2&quot;</span> </span><br><span class="hljs-tag"><span class="hljs-attr">p:username</span>=<span class="hljs-string">&quot;1234&quot;</span> </span><br><span class="hljs-tag"><span class="hljs-attr">factory-bean</span>=<span class="hljs-string">&quot;&quot;</span> </span><br><span class="hljs-tag"><span class="hljs-attr">factory-method</span>=<span class="hljs-string">&quot;&quot;</span> </span><br><span class="hljs-tag"><span class="hljs-attr">init-method</span>=<span class="hljs-string">&quot;&quot;</span> </span><br><span class="hljs-tag"><span class="hljs-attr">abstract</span>=<span class="hljs-string">&quot;true&quot;</span> </span><br><span class="hljs-tag"><span class="hljs-attr">parent</span>=<span class="hljs-string">&quot;&quot;</span> </span><br><span class="hljs-tag"><span class="hljs-attr">lazy-init</span>=<span class="hljs-string">&quot;true&quot;</span> </span><br><span class="hljs-tag"><span class="hljs-attr">primary</span>=<span class="hljs-string">&quot;true&quot;</span></span><br><span class="hljs-tag">/&gt;</span><br></code></pre></td></tr></table></div></figure></li><li>parseMetaElements：负责解析bean标签下的&lt;meta&gt;标签，形如：<figure class="highlight xml"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-3daei7lhkez7dx"></i><span>xml</span><div class="collapse show" id="collapse-3daei7lhkez7dx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;com.enjoy.jack.bean.Student&quot;</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;student2&quot;</span> <span class="hljs-attr">p:username</span>=<span class="hljs-string">&quot;1234&quot;</span> <span class="hljs-attr">factory-bean</span>=<span class="hljs-string">&quot;&quot;</span> <span class="hljs-attr">factory-method</span>=<span class="hljs-string">&quot;&quot;</span> <span class="hljs-attr">init-method</span>=<span class="hljs-string">&quot;&quot;</span> <span class="hljs-attr">abstract</span>=<span class="hljs-string">&quot;true&quot;</span> <span class="hljs-attr">parent</span>=<span class="hljs-string">&quot;&quot;</span> <span class="hljs-attr">lazy-init</span>=<span class="hljs-string">&quot;true&quot;</span> <span class="hljs-attr">primary</span>=<span class="hljs-string">&quot;true&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">description</span>&gt;</span>这个是student<span class="hljs-tag">&lt;/<span class="hljs-name">description</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">key</span>=<span class="hljs-string">&quot;name1&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;Jack&quot;</span>/&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">key</span>=<span class="hljs-string">&quot;name2&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;Dafei&quot;</span>/&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span><br></code></pre></td></tr></table></div></figure></li><li>parseLookupOverrideSubElements：负责解析&lt;lookup-method&gt;，形如：<figure class="highlight xml"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-d8ogbnlhkez7dx"></i><span>xml</span><div class="collapse show" id="collapse-d8ogbnlhkez7dx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;people&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;com.enjoy.jack.bean.ShowSixClass&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">lookup-method</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;getPeople&quot;</span> <span class="hljs-attr">bean</span>=<span class="hljs-string">&quot;woman&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">lookup-method</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span><br></code></pre></td></tr></table></div></figure></li><li>parseReplacedMethodSubElements：负责解析&lt;replaced-method&gt;，形如：<figure class="highlight xml"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-fpqtlflhkez7dx"></i><span>xml</span><div class="collapse show" id="collapse-fpqtlflhkez7dx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;originClass&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;com.enjoy.jack.bean.OriginClass&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">replaced-method</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;method&quot;</span> <span class="hljs-attr">replacer</span>=<span class="hljs-string">&quot;repalceClass&quot;</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">arg-type</span> <span class="hljs-attr">match</span>=<span class="hljs-string">&quot;java.lang.String&quot;</span>/&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">replaced-method</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span><br></code></pre></td></tr></table></div></figure></li><li>parseConstructorArgElements：负责解析&lt;constructor-arg&gt;，形如：<figure class="highlight xml"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-typhyglhkez7dx"></i><span>xml</span><div class="collapse show" id="collapse-typhyglhkez7dx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;com.enjoy.jack.bean.ConstructorArgBean&quot;</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;constructorArgBean&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">constructor-arg</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;username&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;Jack&quot;</span> <span class="hljs-attr">index</span>=<span class="hljs-string">&quot;0&quot;</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;java.lang.String&quot;</span>/&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">constructor-arg</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;password&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;123&quot;</span> <span class="hljs-attr">index</span>=<span class="hljs-string">&quot;1&quot;</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;java.lang.String&quot;</span>/&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span><br></code></pre></td></tr></table></div></figure></li><li>parsePropertyElements：负责解析&lt;property&gt;，形如：<figure class="highlight xml"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-a8r9m1lhkez7dx"></i><span>xml</span><div class="collapse show" id="collapse-a8r9m1lhkez7dx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;com.enjoy.jack.bean.PropertyBean&quot;</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;propertyBean&quot;</span>&gt;</span><br>   <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;username&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;Jack&quot;</span>/&gt;</span><br>   <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;password&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;123&quot;</span>/&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span><br></code></pre></td></tr></table></div></figure>另外，注意这几点：</li><li>&lt;bean&gt;标签解析完成，会统一放到BeanDefinition中。</li><li>&lt;lookup-method&gt;、&lt;replaced-method&gt;、&lt;property&gt;这种子标签会放到MutablePropertyValues 类中。</li><li>&lt;constructor-arg&gt;子标签会放到 ConstructorArgumentValues 类中。<br>后面两点可以在processBeanDefinition()方法中，在完成bean标签解析完后的装饰方法<figure class="highlight java"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-75chialhkez7dx"></i><span>java</span><div class="collapse show" id="collapse-75chialhkez7dx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">bdHolder = delegate.decorateBeanDefinitionIfRequired(ele, bdHolder);<br></code></pre></td></tr></table></div></figure>可以追溯到。这里不做跟踪。我这里重点看看&lt;bean&gt;标签的解析方法parseBeanDefinitionAttributes():<figure class="highlight java"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-ue71qrlhkez7dx"></i><span>java</span><div class="collapse show" id="collapse-ue71qrlhkez7dx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> AbstractBeanDefinition <span class="hljs-title function_">parseBeanDefinitionAttributes</span><span class="hljs-params">(Element ele, String beanName,</span><br><span class="hljs-params"><span class="hljs-meta">@Nullable</span> BeanDefinition containingBean, AbstractBeanDefinition bd)</span> &#123;<br><br><span class="hljs-keyword">if</span> (ele.hasAttribute(SINGLETON_ATTRIBUTE)) &#123;<br>error(<span class="hljs-string">&quot;Old 1.x &#x27;singleton&#x27; attribute in use - upgrade to &#x27;scope&#x27; declaration&quot;</span>, ele);<br>&#125;<br><span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (ele.hasAttribute(SCOPE_ATTRIBUTE)) &#123;<br>bd.setScope(ele.getAttribute(SCOPE_ATTRIBUTE));<br>&#125;<br><span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (containingBean != <span class="hljs-literal">null</span>) &#123;<br><span class="hljs-comment">// Take default from containing bean in case of an inner bean definition.</span><br>bd.setScope(containingBean.getScope());<br>&#125;<br><br><span class="hljs-keyword">if</span> (ele.hasAttribute(ABSTRACT_ATTRIBUTE)) &#123;<br>bd.setAbstract(TRUE_VALUE.equals(ele.getAttribute(ABSTRACT_ATTRIBUTE)));<br>&#125;<br><br><span class="hljs-type">String</span> <span class="hljs-variable">lazyInit</span> <span class="hljs-operator">=</span> ele.getAttribute(LAZY_INIT_ATTRIBUTE);<br><span class="hljs-keyword">if</span> (isDefaultValue(lazyInit)) &#123;<br>lazyInit = <span class="hljs-built_in">this</span>.defaults.getLazyInit();<br>&#125;<br>bd.setLazyInit(TRUE_VALUE.equals(lazyInit));<br><br><span class="hljs-type">String</span> <span class="hljs-variable">autowire</span> <span class="hljs-operator">=</span> ele.getAttribute(AUTOWIRE_ATTRIBUTE);<br>bd.setAutowireMode(getAutowireMode(autowire));<br><br><span class="hljs-keyword">if</span> (ele.hasAttribute(DEPENDS_ON_ATTRIBUTE)) &#123;<br><span class="hljs-type">String</span> <span class="hljs-variable">dependsOn</span> <span class="hljs-operator">=</span> ele.getAttribute(DEPENDS_ON_ATTRIBUTE);<br>bd.setDependsOn(StringUtils.tokenizeToStringArray(dependsOn, MULTI_VALUE_ATTRIBUTE_DELIMITERS));<br>&#125;<br><br><span class="hljs-type">String</span> <span class="hljs-variable">autowireCandidate</span> <span class="hljs-operator">=</span> ele.getAttribute(AUTOWIRE_CANDIDATE_ATTRIBUTE);<br><span class="hljs-keyword">if</span> (isDefaultValue(autowireCandidate)) &#123;<br><span class="hljs-type">String</span> <span class="hljs-variable">candidatePattern</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.defaults.getAutowireCandidates();<br><span class="hljs-keyword">if</span> (candidatePattern != <span class="hljs-literal">null</span>) &#123;<br>String[] patterns = StringUtils.commaDelimitedListToStringArray(candidatePattern);<br>bd.setAutowireCandidate(PatternMatchUtils.simpleMatch(patterns, beanName));<br>&#125;<br>&#125;<br><span class="hljs-keyword">else</span> &#123;<br>bd.setAutowireCandidate(TRUE_VALUE.equals(autowireCandidate));<br>&#125;<br><br><span class="hljs-keyword">if</span> (ele.hasAttribute(PRIMARY_ATTRIBUTE)) &#123;<br>bd.setPrimary(TRUE_VALUE.equals(ele.getAttribute(PRIMARY_ATTRIBUTE)));<br>&#125;<br><br><span class="hljs-keyword">if</span> (ele.hasAttribute(INIT_METHOD_ATTRIBUTE)) &#123;<br><span class="hljs-type">String</span> <span class="hljs-variable">initMethodName</span> <span class="hljs-operator">=</span> ele.getAttribute(INIT_METHOD_ATTRIBUTE);<br>bd.setInitMethodName(initMethodName);<br>&#125;<br><span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.defaults.getInitMethod() != <span class="hljs-literal">null</span>) &#123;<br>bd.setInitMethodName(<span class="hljs-built_in">this</span>.defaults.getInitMethod());<br>bd.setEnforceInitMethod(<span class="hljs-literal">false</span>);<br>&#125;<br><br><span class="hljs-keyword">if</span> (ele.hasAttribute(DESTROY_METHOD_ATTRIBUTE)) &#123;<br><span class="hljs-type">String</span> <span class="hljs-variable">destroyMethodName</span> <span class="hljs-operator">=</span> ele.getAttribute(DESTROY_METHOD_ATTRIBUTE);<br>bd.setDestroyMethodName(destroyMethodName);<br>&#125;<br><span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.defaults.getDestroyMethod() != <span class="hljs-literal">null</span>) &#123;<br>bd.setDestroyMethodName(<span class="hljs-built_in">this</span>.defaults.getDestroyMethod());<br>bd.setEnforceDestroyMethod(<span class="hljs-literal">false</span>);<br>&#125;<br><br><span class="hljs-keyword">if</span> (ele.hasAttribute(FACTORY_METHOD_ATTRIBUTE)) &#123;<br>bd.setFactoryMethodName(ele.getAttribute(FACTORY_METHOD_ATTRIBUTE));<br>&#125;<br><span class="hljs-keyword">if</span> (ele.hasAttribute(FACTORY_BEAN_ATTRIBUTE)) &#123;<br>bd.setFactoryBeanName(ele.getAttribute(FACTORY_BEAN_ATTRIBUTE));<br>&#125;<br><br><span class="hljs-keyword">return</span> bd;<br>&#125;<br></code></pre></td></tr></table></div></figure>可以对应上xml:<figure class="highlight xml"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-vua4cwlhkez7dx"></i><span>xml</span><div class="collapse show" id="collapse-vua4cwlhkez7dx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;com.enjoy.jack.bean.Student&quot;</span> </span><br><span class="hljs-tag"><span class="hljs-attr">id</span>=<span class="hljs-string">&quot;student2&quot;</span> </span><br><span class="hljs-tag"><span class="hljs-attr">p:username</span>=<span class="hljs-string">&quot;1234&quot;</span> </span><br><span class="hljs-tag"><span class="hljs-attr">factory-bean</span>=<span class="hljs-string">&quot;&quot;</span> </span><br><span class="hljs-tag"><span class="hljs-attr">factory-method</span>=<span class="hljs-string">&quot;&quot;</span> </span><br><span class="hljs-tag"><span class="hljs-attr">init-method</span>=<span class="hljs-string">&quot;&quot;</span> </span><br><span class="hljs-tag"><span class="hljs-attr">abstract</span>=<span class="hljs-string">&quot;true&quot;</span> </span><br><span class="hljs-tag"><span class="hljs-attr">parent</span>=<span class="hljs-string">&quot;&quot;</span> </span><br><span class="hljs-tag"><span class="hljs-attr">lazy-init</span>=<span class="hljs-string">&quot;true&quot;</span> </span><br><span class="hljs-tag"><span class="hljs-attr">primary</span>=<span class="hljs-string">&quot;true&quot;</span></span><br><span class="hljs-tag">/&gt;</span><br></code></pre></td></tr></table></div></figure>&lt;bean&gt;标签解析过程的代码跟踪到这里，回到DefaultBeanDefinitionDocumentReader的 processBeanDefinition() 方法继续往下走，第一步已经对BeanDefinition属性解析完成，返回 BeanDefinitionHolder 对象。第二步装饰的过程这里不跟了。接下来跟下注册 registerBeanDefinition的过程（第三步）。<figure class="highlight java"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-3qxe1wlhkez7dx"></i><span>java</span><div class="collapse show" id="collapse-3qxe1wlhkez7dx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">processBeanDefinition</span><span class="hljs-params">(Element ele, BeanDefinitionParserDelegate delegate)</span> &#123;<br><span class="hljs-comment">//1.重点看这个方法，重要程度 5 ，解析document，封装成BeanDefinition</span><br><span class="hljs-type">BeanDefinitionHolder</span> <span class="hljs-variable">bdHolder</span> <span class="hljs-operator">=</span> delegate.parseBeanDefinitionElement(ele);<br><span class="hljs-keyword">if</span> (bdHolder != <span class="hljs-literal">null</span>) &#123;<br><span class="hljs-comment">//2.该方法功能不重要，设计模式重点看一下，装饰者设计模式，加上SPI设计思想</span><br>bdHolder = delegate.decorateBeanDefinitionIfRequired(ele, bdHolder);<br><span class="hljs-keyword">try</span> &#123;<br><span class="hljs-comment">//3.完成document到BeanDefinition对象转换后，对BeanDefinition对象进行缓存注册</span><br><span class="hljs-comment">// Register the final decorated instance.</span><br>BeanDefinitionReaderUtils.registerBeanDefinition(bdHolder, getReaderContext().getRegistry());<br>&#125;<br><span class="hljs-keyword">catch</span> (BeanDefinitionStoreException ex) &#123;<br>getReaderContext().error(<span class="hljs-string">&quot;Failed to register bean definition with name &#x27;&quot;</span> +<br>bdHolder.getBeanName() + <span class="hljs-string">&quot;&#x27;&quot;</span>, ele, ex);<br>&#125;<br><span class="hljs-comment">// 4.Send registration event.</span><br>getReaderContext().fireComponentRegistered(<span class="hljs-keyword">new</span> <span class="hljs-title class_">BeanComponentDefinition</span>(bdHolder));<br>&#125;<br>&#125;<br></code></pre></td></tr></table></div></figure>调用的是工具类BeanDefinitionReaderUtils的方法registerBeanDefinition()：<figure class="highlight java"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-6ci7dolhkez7dx"></i><span>java</span><div class="collapse show" id="collapse-6ci7dolhkez7dx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">registerBeanDefinition</span><span class="hljs-params">(</span><br><span class="hljs-params">BeanDefinitionHolder definitionHolder, BeanDefinitionRegistry registry)</span><br><span class="hljs-keyword">throws</span> BeanDefinitionStoreException &#123;<br><span class="hljs-comment">// Register bean definition under primary name.</span><br><span class="hljs-type">String</span> <span class="hljs-variable">beanName</span> <span class="hljs-operator">=</span> definitionHolder.getBeanName();<br><span class="hljs-comment">//完成BeanDefinition的注册，重点看，重要程度 5</span><br>registry.registerBeanDefinition(beanName, definitionHolder.getBeanDefinition());<br><span class="hljs-comment">//建立别名和 id的映射，这样就可以根据别名获取到id</span><br><span class="hljs-comment">// Register aliases for bean name, if any.</span><br>String[] aliases = definitionHolder.getAliases();<br><span class="hljs-keyword">if</span> (aliases != <span class="hljs-literal">null</span>) &#123;<br><span class="hljs-keyword">for</span> (String alias : aliases) &#123;<br>registry.registerAlias(beanName, alias);<br>&#125;<br>&#125;<br>&#125;<br></code></pre></td></tr></table></div></figure>DefaultListableBeanFactory.registerBeanDefinition()方法，最终完成默认标签的注册。<figure class="highlight java"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-d3ry3blhkez7dx"></i><span>java</span><div class="collapse show" id="collapse-d3ry3blhkez7dx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">registerBeanDefinition</span><span class="hljs-params">(String beanName, BeanDefinition beanDefinition)</span><br><span class="hljs-keyword">throws</span> BeanDefinitionStoreException &#123;<br>Assert.hasText(beanName, <span class="hljs-string">&quot;Bean name must not be empty&quot;</span>);<br>Assert.notNull(beanDefinition, <span class="hljs-string">&quot;BeanDefinition must not be null&quot;</span>);<br><span class="hljs-keyword">if</span> (beanDefinition <span class="hljs-keyword">instanceof</span> AbstractBeanDefinition) &#123;<br><span class="hljs-keyword">try</span> &#123;<br>((AbstractBeanDefinition) beanDefinition).validate();<br>&#125;<br><span class="hljs-keyword">catch</span> (BeanDefinitionValidationException ex) &#123;<br><span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BeanDefinitionStoreException</span>(beanDefinition.getResourceDescription(), beanName,<br><span class="hljs-string">&quot;Validation of bean definition failed&quot;</span>, ex);<br>&#125;<br>&#125;<br><span class="hljs-comment">//先判断BeanDefinition是否已经注册</span><br><span class="hljs-type">BeanDefinition</span> <span class="hljs-variable">existingDefinition</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.beanDefinitionMap.get(beanName);<br><span class="hljs-keyword">if</span> (existingDefinition != <span class="hljs-literal">null</span>) &#123;<br><span class="hljs-keyword">if</span> (!isAllowBeanDefinitionOverriding()) &#123;<br><span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BeanDefinitionOverrideException</span>(beanName, beanDefinition, existingDefinition);<br>&#125;<br><span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (existingDefinition.getRole() &lt; beanDefinition.getRole()) &#123;<br><span class="hljs-comment">// e.g. was ROLE_APPLICATION, now overriding with ROLE_SUPPORT or ROLE_INFRASTRUCTURE</span><br><span class="hljs-keyword">if</span> (logger.isInfoEnabled()) &#123;<br>logger.info(<span class="hljs-string">&quot;Overriding user-defined bean definition for bean &#x27;&quot;</span> + beanName +<br><span class="hljs-string">&quot;&#x27; with a framework-generated bean definition: replacing [&quot;</span> +<br>existingDefinition + <span class="hljs-string">&quot;] with [&quot;</span> + beanDefinition + <span class="hljs-string">&quot;]&quot;</span>);<br>&#125;<br>&#125;<br><span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!beanDefinition.equals(existingDefinition)) &#123;<br><span class="hljs-keyword">if</span> (logger.isDebugEnabled()) &#123;<br>logger.debug(<span class="hljs-string">&quot;Overriding bean definition for bean &#x27;&quot;</span> + beanName +<br><span class="hljs-string">&quot;&#x27; with a different definition: replacing [&quot;</span> + existingDefinition +<br><span class="hljs-string">&quot;] with [&quot;</span> + beanDefinition + <span class="hljs-string">&quot;]&quot;</span>);<br>&#125;<br>&#125;<br><span class="hljs-keyword">else</span> &#123;<br><span class="hljs-keyword">if</span> (logger.isTraceEnabled()) &#123;<br>logger.trace(<span class="hljs-string">&quot;Overriding bean definition for bean &#x27;&quot;</span> + beanName +<br><span class="hljs-string">&quot;&#x27; with an equivalent definition: replacing [&quot;</span> + existingDefinition +<br><span class="hljs-string">&quot;] with [&quot;</span> + beanDefinition + <span class="hljs-string">&quot;]&quot;</span>);<br>&#125;<br>&#125;<br><span class="hljs-built_in">this</span>.beanDefinitionMap.put(beanName, beanDefinition);<br>&#125;<br><span class="hljs-keyword">else</span> &#123;<br><span class="hljs-keyword">if</span> (hasBeanCreationStarted()) &#123;<br><span class="hljs-comment">// Cannot modify startup-time collection elements anymore (for stable iteration)</span><br><span class="hljs-keyword">synchronized</span> (<span class="hljs-built_in">this</span>.beanDefinitionMap) &#123;<br><span class="hljs-built_in">this</span>.beanDefinitionMap.put(beanName, beanDefinition);<br>List&lt;String&gt; updatedDefinitions = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;(<span class="hljs-built_in">this</span>.beanDefinitionNames.size() + <span class="hljs-number">1</span>);<br>updatedDefinitions.addAll(<span class="hljs-built_in">this</span>.beanDefinitionNames);<br>updatedDefinitions.add(beanName);<br><span class="hljs-built_in">this</span>.beanDefinitionNames = updatedDefinitions;<br>removeManualSingletonName(beanName);<br>&#125;<br>&#125;<br><span class="hljs-keyword">else</span> &#123;<br><span class="hljs-comment">//把beanDefinition缓存到map中</span><br><span class="hljs-comment">// Still in startup registration phase</span><br><span class="hljs-built_in">this</span>.beanDefinitionMap.put(beanName, beanDefinition);<br><span class="hljs-comment">//把beanName放到beanDefinitionNames list中，这个list着重记住，bean实例化的时候需要用到</span><br><span class="hljs-built_in">this</span>.beanDefinitionNames.add(beanName);<br>removeManualSingletonName(beanName);<br>&#125;<br><span class="hljs-built_in">this</span>.frozenBeanDefinitionNames = <span class="hljs-literal">null</span>;<br>&#125;<br><br><span class="hljs-keyword">if</span> (existingDefinition != <span class="hljs-literal">null</span> || containsSingleton(beanName)) &#123;<br>resetBeanDefinition(beanName);<br>&#125;<br><span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (isConfigurationFrozen()) &#123;<br>clearByTypeCache();<br>&#125;<br>&#125;<br></code></pre></td></tr></table></div></figure>总结下DefaultListableBeanFactory.registerBeanDefinition()方法的功能：</li><li>把bean名称和beanDefinition放到 Map&lt;String, BeanDefinition&gt; beanDefinitionMap &#x3D; new ConcurrentHashMap&lt;&gt;(256)的 容器中</li><li>把bean名称放到List<String> beanDefinitionNames &#x3D; new ArrayList&lt;&gt;(256) 的 list容器中缓存起来</String></li></ul><p>bean的实例化过程中会用到这两个东东。<br>到这儿，Spring默认标签解析完成代码追踪了，接下来跟跟自定义标签的解析过程。</p><h2 id="7-parseCustomElement"><a href="#7-parseCustomElement" class="headerlink" title="7.parseCustomElement()"></a>7.parseCustomElement()</h2><p>调用流程还是和目录一中描述的一样。Talk is cheap, show me the code.</p><figure class="highlight java"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-qi7c59lhkez7dx"></i><span>java</span><div class="collapse show" id="collapse-qi7c59lhkez7dx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment">* BeanDefinitionParserDelegate</span><br><span class="hljs-comment">* Description: 自定义标签交给BeanDefinitionParserDelegate 委托类来解析</span><br><span class="hljs-comment">*/</span><br><span class="hljs-keyword">public</span> BeanDefinition <span class="hljs-title function_">parseCustomElement</span><span class="hljs-params">(Element ele, <span class="hljs-meta">@Nullable</span> BeanDefinition containingBd)</span> &#123;<br><span class="hljs-comment">// 获取命名空间的URI</span><br><span class="hljs-type">String</span> <span class="hljs-variable">namespaceUri</span> <span class="hljs-operator">=</span> getNamespaceURI(ele);<br><span class="hljs-keyword">if</span> (namespaceUri == <span class="hljs-literal">null</span>) &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>&#125;<br><span class="hljs-comment">// SPI设计，获取/META-INF/spring.handers中URI对应的Hander处理类</span><br><span class="hljs-comment">//具体解析内容如下：</span><br><span class="hljs-comment">//获取spring中所有jar包里面的META-INF/spring.handlers文件，并且建立映射关系。</span><br><span class="hljs-comment">//根据namespaceUri获取到这个命名空间的处理类。</span><br><span class="hljs-comment">//调用处理类的init()方法，在init()方法中完成标签元素解析类的注册。</span><br><span class="hljs-type">NamespaceHandler</span> <span class="hljs-variable">handler</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.readerContext.getNamespaceHandlerResolver().resolve(namespaceUri);<br><span class="hljs-keyword">if</span> (handler == <span class="hljs-literal">null</span>) &#123;<br>error(<span class="hljs-string">&quot;Unable to locate Spring NamespaceHandler for XML schema namespace [&quot;</span> + namespaceUri + <span class="hljs-string">&quot;]&quot;</span>, ele);<br><span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>&#125;<br><span class="hljs-comment">// 执行 实现类NamespaceHandlerSupport 中的parse 方法</span><br><span class="hljs-keyword">return</span> handler.parse(ele, <span class="hljs-keyword">new</span> <span class="hljs-title class_">ParserContext</span>(<span class="hljs-built_in">this</span>.readerContext, <span class="hljs-built_in">this</span>, containingBd));<br>&#125;<br></code></pre></td></tr></table></div></figure><p>先看看resolve方法</p><figure class="highlight java"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-rrk4pnlhkez7dx"></i><span>java</span><div class="collapse show" id="collapse-rrk4pnlhkez7dx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> NamespaceHandler <span class="hljs-title function_">resolve</span><span class="hljs-params">(String namespaceUri)</span> &#123;<br><span class="hljs-comment">//获取spring中所有jar包里面的 &quot;META-INF/spring.handlers&quot;文件，并且建立映射关系</span><br>Map&lt;String, Object&gt; handlerMappings = getHandlerMappings();<br><span class="hljs-comment">//根据namespaceUri：http://www.springframework.org/schema/context，获取到这个命名空间的处理类</span><br><span class="hljs-type">Object</span> <span class="hljs-variable">handlerOrClassName</span> <span class="hljs-operator">=</span> handlerMappings.get(namespaceUri);<br><span class="hljs-keyword">if</span> (handlerOrClassName == <span class="hljs-literal">null</span>) &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>&#125;<br><span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (handlerOrClassName <span class="hljs-keyword">instanceof</span> NamespaceHandler) &#123;<br><span class="hljs-keyword">return</span> (NamespaceHandler) handlerOrClassName;<br>&#125;<br><span class="hljs-keyword">else</span> &#123;<br><span class="hljs-type">String</span> <span class="hljs-variable">className</span> <span class="hljs-operator">=</span> (String) handlerOrClassName;<br><span class="hljs-keyword">try</span> &#123;<br>Class&lt;?&gt; handlerClass = ClassUtils.forName(className, <span class="hljs-built_in">this</span>.classLoader);<br><span class="hljs-keyword">if</span> (!NamespaceHandler.class.isAssignableFrom(handlerClass)) &#123;<br><span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FatalBeanException</span>(<span class="hljs-string">&quot;Class [&quot;</span> + className + <span class="hljs-string">&quot;] for namespace [&quot;</span> + namespaceUri +<br><span class="hljs-string">&quot;] does not implement the [&quot;</span> + NamespaceHandler.class.getName() + <span class="hljs-string">&quot;] interface&quot;</span>);<br>&#125;<br><span class="hljs-type">NamespaceHandler</span> <span class="hljs-variable">namespaceHandler</span> <span class="hljs-operator">=</span> (NamespaceHandler) BeanUtils.instantiateClass(handlerClass);<br><br><span class="hljs-comment">//调用处理类的init方法，在init方法中完成标签元素解析类的注册</span><br>namespaceHandler.init();<br>handlerMappings.put(namespaceUri, namespaceHandler);<br><span class="hljs-keyword">return</span> namespaceHandler;<br>&#125;<br><span class="hljs-keyword">catch</span> (ClassNotFoundException ex) &#123;<br><span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FatalBeanException</span>(<span class="hljs-string">&quot;Could not find NamespaceHandler class [&quot;</span> + className +<br><span class="hljs-string">&quot;] for namespace [&quot;</span> + namespaceUri + <span class="hljs-string">&quot;]&quot;</span>, ex);<br>&#125;<br><span class="hljs-keyword">catch</span> (LinkageError err) &#123;<br><span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FatalBeanException</span>(<span class="hljs-string">&quot;Unresolvable class definition for NamespaceHandler class [&quot;</span> +<br>className + <span class="hljs-string">&quot;] for namespace [&quot;</span> + namespaceUri + <span class="hljs-string">&quot;]&quot;</span>, err);<br>&#125;<br>&#125;<br>&#125;<br></code></pre></td></tr></table></div></figure><p><strong>这个方法很重要，总结下它的功能：</strong></p><ul><li>获取spring中所有jar包里面的 “META-INF&#x2F;spring.handlers”文件，并且建立映射关系至handlerMappings </li><li>根据namespaceUri：<a href="http://www.springframework.org/schema/context%EF%BC%8C%E8%8E%B7%E5%8F%96%E5%88%B0%E8%BF%99%E4%B8%AA%E5%91%BD%E5%90%8D%E7%A9%BA%E9%97%B4%E7%9A%84%E5%A4%84%E7%90%86%E7%B1%BB">http://www.springframework.org/schema/context，获取到这个命名空间的处理类</a></li><li>反射实例化它对应的NamespaceHandler</li><li>调用处理类NamespaceHandler的init方法，在init方法中完成标签元素解析类的注册</li><li>注册这个NamespaceHandler至handlerMappings</li></ul><p>进入parse方法</p><figure class="highlight java"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-bavgyzlhkez7dx"></i><span>java</span><div class="collapse show" id="collapse-bavgyzlhkez7dx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment">* NamespaceHandlerSupport</span><br><span class="hljs-comment">* Description: 委托BeanDefinitionParser类解析元素</span><br><span class="hljs-comment">*/</span><br><span class="hljs-keyword">public</span> BeanDefinition <span class="hljs-title function_">parse</span><span class="hljs-params">(Element element, ParserContext parserContext)</span> &#123;<br><span class="hljs-comment">// 获取自定义组件名 对应的解析方法</span><br><span class="hljs-type">BeanDefinitionParser</span> <span class="hljs-variable">parser</span> <span class="hljs-operator">=</span> findParserForElement(element, parserContext);<br><span class="hljs-comment">// 调用ComponentScanBeanDefinitionParser实现类中的 parse方法</span><br><span class="hljs-keyword">return</span> (parser != <span class="hljs-literal">null</span> ? parser.parse(element, parserContext) : <span class="hljs-literal">null</span>);<br>&#125;<br></code></pre></td></tr></table></div></figure><p>进入findParserForElement()方法</p><figure class="highlight java"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-s5zzv5lhkez7dx"></i><span>java</span><div class="collapse show" id="collapse-s5zzv5lhkez7dx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment">* NamespaceHandlerSupport</span><br><span class="hljs-comment">* Description: 从map中根据组件名称获取绑定的解析方法</span><br><span class="hljs-comment">*/</span><br><span class="hljs-keyword">private</span> BeanDefinitionParser <span class="hljs-title function_">findParserForElement</span><span class="hljs-params">(Element element, ParserContext parserContext)</span> &#123;<br><span class="hljs-comment">// 获取组件名称</span><br><span class="hljs-type">String</span> <span class="hljs-variable">localName</span> <span class="hljs-operator">=</span> parserContext.getDelegate().getLocalName(element);<br><span class="hljs-comment">// Map&lt;String, BeanDefinitionParser&gt; parsers = new HashMap&lt;&gt;()</span><br><span class="hljs-comment">//此处this.parsers.get()之所以有值，是因为在/META-INF/spring.handers中URI对应的Hander处理类初始化的时候，通过init()方法中,执行registerBeanDefinitionParser()，来调用this.parsers.set(&#x27;标签元素&#x27;,&#x27;解析类&#x27;)设置的。</span><br><span class="hljs-type">BeanDefinitionParser</span> <span class="hljs-variable">parser</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.parsers.get(localName);<br><span class="hljs-keyword">if</span> (parser == <span class="hljs-literal">null</span>) &#123;<br>parserContext.getReaderContext().fatal(<br><span class="hljs-string">&quot;Cannot locate BeanDefinitionParser for element [&quot;</span> + localName + <span class="hljs-string">&quot;]&quot;</span>, element);<br>&#125;<br><span class="hljs-keyword">return</span> parser;<br>&#125;<br></code></pre></td></tr></table></div></figure><p>这里我们以&lt;component-scan&gt;标签为例<br>先看看它所在的NamespaceHandler配置在哪儿</p><figure class="highlight xml"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-wy2r7llhkez7dx"></i><span>xml</span><div class="collapse show" id="collapse-wy2r7llhkez7dx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs xml">http\://www.springframework.org/schema/context=org.springframework.context.config.ContextNamespaceHandler<br></code></pre></td></tr></table></div></figure><p>对应的java文件</p><figure class="highlight java"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-9jnr0hlhkez7dx"></i><span>java</span><div class="collapse show" id="collapse-9jnr0hlhkez7dx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ContextNamespaceHandler</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">NamespaceHandlerSupport</span> &#123;<br><br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">init</span><span class="hljs-params">()</span> &#123;<br>registerBeanDefinitionParser(<span class="hljs-string">&quot;property-placeholder&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">PropertyPlaceholderBeanDefinitionParser</span>());<br>registerBeanDefinitionParser(<span class="hljs-string">&quot;property-override&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">PropertyOverrideBeanDefinitionParser</span>());<br>registerBeanDefinitionParser(<span class="hljs-string">&quot;annotation-config&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">AnnotationConfigBeanDefinitionParser</span>());<br>registerBeanDefinitionParser(<span class="hljs-string">&quot;component-scan&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">ComponentScanBeanDefinitionParser</span>());<br>registerBeanDefinitionParser(<span class="hljs-string">&quot;load-time-weaver&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">LoadTimeWeaverBeanDefinitionParser</span>());<br>registerBeanDefinitionParser(<span class="hljs-string">&quot;spring-configured&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">SpringConfiguredBeanDefinitionParser</span>());<br>registerBeanDefinitionParser(<span class="hljs-string">&quot;mbean-export&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">MBeanExportBeanDefinitionParser</span>());<br>registerBeanDefinitionParser(<span class="hljs-string">&quot;mbean-server&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">MBeanServerBeanDefinitionParser</span>());<br>&#125;<br><br>&#125;<br></code></pre></td></tr></table></div></figure><p>完成这些标签解析类的注册后，返回到方法中</p><figure class="highlight java"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-8kgo7elhkez7dx"></i><span>java</span><div class="collapse show" id="collapse-8kgo7elhkez7dx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment">* BeanDefinitionParserDelegate</span><br><span class="hljs-comment">* Description: 自定义标签交给BeanDefinitionParserDelegate 委托类来解析</span><br><span class="hljs-comment">*/</span><br><span class="hljs-keyword">public</span> BeanDefinition <span class="hljs-title function_">parseCustomElement</span><span class="hljs-params">(Element ele, <span class="hljs-meta">@Nullable</span> BeanDefinition containingBd)</span> &#123;<br><span class="hljs-comment">// 获取命名空间的URI</span><br><span class="hljs-type">String</span> <span class="hljs-variable">namespaceUri</span> <span class="hljs-operator">=</span> getNamespaceURI(ele);<br><span class="hljs-keyword">if</span> (namespaceUri == <span class="hljs-literal">null</span>) &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>&#125;<br><span class="hljs-comment">// SPI设计，获取/META-INF/spring.handers中URI对应的Hander处理类</span><br><span class="hljs-comment">//具体解析内容如下：</span><br><span class="hljs-comment">//获取spring中所有jar包里面的META-INF/spring.handlers文件，并且建立映射关系。</span><br><span class="hljs-comment">//根据namespaceUri获取到这个命名空间的处理类。</span><br><span class="hljs-comment">//调用处理类的init()方法，在init()方法中完成标签元素解析类的注册。</span><br><span class="hljs-type">NamespaceHandler</span> <span class="hljs-variable">handler</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.readerContext.getNamespaceHandlerResolver().resolve(namespaceUri);<br><span class="hljs-keyword">if</span> (handler == <span class="hljs-literal">null</span>) &#123;<br>error(<span class="hljs-string">&quot;Unable to locate Spring NamespaceHandler for XML schema namespace [&quot;</span> + namespaceUri + <span class="hljs-string">&quot;]&quot;</span>, ele);<br><span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>&#125;<br><span class="hljs-comment">// 执行 实现类NamespaceHandlerSupport 中的parse 方法</span><br><span class="hljs-keyword">return</span> handler.parse(ele, <span class="hljs-keyword">new</span> <span class="hljs-title class_">ParserContext</span>(<span class="hljs-built_in">this</span>.readerContext, <span class="hljs-built_in">this</span>, containingBd));<br>&#125;<br></code></pre></td></tr></table></div></figure><p>看看ComponentScanBeanDefinitionParser.parse解析过程</p><figure class="highlight java"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-4j0jralhkez7dx"></i><span>java</span><div class="collapse show" id="collapse-4j0jralhkez7dx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/** Description: 核心解析</span><br><span class="hljs-comment"> * 1、扫描路径.class后缀的文件</span><br><span class="hljs-comment"> * 2、要判断类上是否有注解</span><br><span class="hljs-comment"> * 3、GenericBeanDefinition genericBeanDefinition = new GenericBeanDefinition();</span><br><span class="hljs-comment"> *    genericBeanDefinition.setBeanClass(BeanClass.class);</span><br><span class="hljs-comment"> * 4、完成beanDefinition注册</span><br><span class="hljs-comment"> * */</span><br><span class="hljs-keyword">public</span> BeanDefinition <span class="hljs-title function_">parse</span><span class="hljs-params">(Element element, ParserContext parserContext)</span> &#123;<br><span class="hljs-comment">//获取basePackage属性</span><br><span class="hljs-type">String</span> <span class="hljs-variable">basePackage</span> <span class="hljs-operator">=</span> element.getAttribute(BASE_PACKAGE_ATTRIBUTE);<br>basePackage = parserContext.getReaderContext().getEnvironment().resolvePlaceholders(basePackage);<br><span class="hljs-comment">//可以用逗号分开</span><br>String[] basePackages = StringUtils.tokenizeToStringArray(basePackage,<br>ConfigurableApplicationContext.CONFIG_LOCATION_DELIMITERS);<br><span class="hljs-comment">//创建注解扫描器</span><br><span class="hljs-comment">// Actually scan for bean definitions and register them.</span><br><span class="hljs-type">ClassPathBeanDefinitionScanner</span> <span class="hljs-variable">scanner</span> <span class="hljs-operator">=</span> configureScanner(parserContext, element);<br><span class="hljs-comment">//扫描并把扫描的类封装成beanDefinition对象  核心方法，重要程度 5</span><br>Set&lt;BeanDefinitionHolder&gt; beanDefinitions = scanner.doScan(basePackages);<br>registerComponents(parserContext.getReaderContext(), beanDefinitions, element);<br><span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>&#125;<br></code></pre></td></tr></table></div></figure><p>获取basePackage这里不做跟踪了，先看看创建扫描器的过程</p><figure class="highlight java"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-ah788dlhkez7dx"></i><span>java</span><div class="collapse show" id="collapse-ah788dlhkez7dx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//创建注解扫描器</span><br><span class="hljs-comment">// Actually scan for bean definitions and register them.</span><br><span class="hljs-type">ClassPathBeanDefinitionScanner</span> <span class="hljs-variable">scanner</span> <span class="hljs-operator">=</span> configureScanner(parserContext, element);<br></code></pre></td></tr></table></div></figure><p>点进去看看</p><figure class="highlight java"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-2kh7gzlhkez7dx"></i><span>java</span><div class="collapse show" id="collapse-2kh7gzlhkez7dx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">protected</span> ClassPathBeanDefinitionScanner <span class="hljs-title function_">configureScanner</span><span class="hljs-params">(ParserContext parserContext, Element element)</span> &#123;<br><span class="hljs-comment">//使用默认的过滤器</span><br><span class="hljs-type">boolean</span> <span class="hljs-variable">useDefaultFilters</span> <span class="hljs-operator">=</span> <span class="hljs-literal">true</span>;<br><span class="hljs-keyword">if</span> (element.hasAttribute(USE_DEFAULT_FILTERS_ATTRIBUTE)) &#123;<br>useDefaultFilters = Boolean.parseBoolean(element.getAttribute(USE_DEFAULT_FILTERS_ATTRIBUTE));<br>&#125;<br><span class="hljs-comment">//重点看看这里的创建</span><br><span class="hljs-comment">// Delegate bean definition registration to scanner class.</span><br><span class="hljs-type">ClassPathBeanDefinitionScanner</span> <span class="hljs-variable">scanner</span> <span class="hljs-operator">=</span> createScanner(parserContext.getReaderContext(), useDefaultFilters);<br>scanner.setBeanDefinitionDefaults(parserContext.getDelegate().getBeanDefinitionDefaults());<br>scanner.setAutowireCandidatePatterns(parserContext.getDelegate().getAutowireCandidatePatterns());<br><span class="hljs-keyword">if</span> (element.hasAttribute(RESOURCE_PATTERN_ATTRIBUTE)) &#123;<br>scanner.setResourcePattern(element.getAttribute(RESOURCE_PATTERN_ATTRIBUTE));<br>&#125;<br><span class="hljs-keyword">try</span> &#123;<br><span class="hljs-comment">// 解析子标签，不用看</span><br>parseBeanNameGenerator(element, scanner);<br>&#125;<br><span class="hljs-keyword">catch</span> (Exception ex) &#123;<br>parserContext.getReaderContext().error(ex.getMessage(), parserContext.extractSource(element), ex.getCause());<br>&#125;<br><span class="hljs-keyword">try</span> &#123;<br><span class="hljs-comment">// 解析子标签，不用看</span><br>parseScope(element, scanner);<br>&#125;<br><span class="hljs-keyword">catch</span> (Exception ex) &#123;<br>parserContext.getReaderContext().error(ex.getMessage(), parserContext.extractSource(element), ex.getCause());<br>&#125;<br><span class="hljs-comment">// 会扫描含有&quot;include-filter&quot;和&quot;exclude-filter&quot;属性进行解析</span><br>parseTypeFilters(element, scanner, parserContext);<br><span class="hljs-keyword">return</span> scanner;<br>&#125;<br></code></pre></td></tr></table></div></figure><p>再点进去看看createScanner()方法</p><figure class="highlight java"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-sckaatlhkez7dx"></i><span>java</span><div class="collapse show" id="collapse-sckaatlhkez7dx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">protected</span> ClassPathBeanDefinitionScanner <span class="hljs-title function_">createScanner</span><span class="hljs-params">(XmlReaderContext readerContext, <span class="hljs-type">boolean</span> useDefaultFilters)</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ClassPathBeanDefinitionScanner</span>(readerContext.getRegistry(), useDefaultFilters,<br>readerContext.getEnvironment(), readerContext.getResourceLoader());<br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-title function_">ClassPathBeanDefinitionScanner</span><span class="hljs-params">(BeanDefinitionRegistry registry, <span class="hljs-type">boolean</span> useDefaultFilters,</span><br><span class="hljs-params">Environment environment, <span class="hljs-meta">@Nullable</span> ResourceLoader resourceLoader)</span> &#123;<br>Assert.notNull(registry, <span class="hljs-string">&quot;BeanDefinitionRegistry must not be null&quot;</span>);<br><span class="hljs-built_in">this</span>.registry = registry;<br><span class="hljs-comment">//使用默认的过滤器，扫描带有@Component注解的类</span><br><span class="hljs-keyword">if</span> (useDefaultFilters) &#123;<br>registerDefaultFilters();<br>&#125;<br>setEnvironment(environment);<br>setResourceLoader(resourceLoader);<br>&#125;<br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> *  Description: 使用默认过滤规则 处理指定的注解类，然后注册</span><br><span class="hljs-comment"> * 扫描对象为带有以下注解的类：</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Component</span></span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Controller</span></span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Service</span></span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Repository</span></span><br><span class="hljs-comment"> * 以及Java EE 6的javax.annotation.ManagedBean,JSR-330的javax.inject.Named的注解</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">registerDefaultFilters</span><span class="hljs-params">()</span> &#123;<br><span class="hljs-comment">// 过滤器中添加需要扫描的注解类型</span><br><span class="hljs-comment">// 将注解添加到 AnnotationTypeFilter包装类</span><br><span class="hljs-built_in">this</span>.includeFilters.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">AnnotationTypeFilter</span>(Component.class));<br><span class="hljs-comment">// 确保类注解是 ClassPathScanningCandidateComponentProvider的类加载器</span><br><span class="hljs-type">ClassLoader</span> <span class="hljs-variable">cl</span> <span class="hljs-operator">=</span> ClassPathScanningCandidateComponentProvider.class.getClassLoader();<br><span class="hljs-keyword">try</span> &#123;<br><span class="hljs-built_in">this</span>.includeFilters.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">AnnotationTypeFilter</span>(<br>((Class&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Annotation</span>&gt;) ClassUtils.forName(<span class="hljs-string">&quot;javax.annotation.ManagedBean&quot;</span>, cl)), <span class="hljs-literal">false</span>));<br>logger.trace(<span class="hljs-string">&quot;JSR-250 &#x27;javax.annotation.ManagedBean&#x27; found and supported for component scanning&quot;</span>);<br>&#125;<br><span class="hljs-keyword">catch</span> (ClassNotFoundException ex) &#123;<br><span class="hljs-comment">// JSR-250 1.1 API (as included in Java EE 6) not available - simply skip.</span><br>&#125;<br><span class="hljs-keyword">try</span> &#123;<br><span class="hljs-built_in">this</span>.includeFilters.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">AnnotationTypeFilter</span>(<br>((Class&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Annotation</span>&gt;) ClassUtils.forName(<span class="hljs-string">&quot;javax.inject.Named&quot;</span>, cl)), <span class="hljs-literal">false</span>));<br>logger.trace(<span class="hljs-string">&quot;JSR-330 &#x27;javax.inject.Named&#x27; annotation found and supported for component scanning&quot;</span>);<br>&#125;<br><span class="hljs-keyword">catch</span> (ClassNotFoundException ex) &#123;<br><span class="hljs-comment">// JSR-330 API not available - simply skip.</span><br>&#125;<br>&#125;<br></code></pre></td></tr></table></div></figure><p>将拦截到的注解添加到List&lt;TypeFilter&gt; includeFilters &#x3D; new LinkedList&lt;&gt;() 容器中。<br>创建注解扫描器完毕，返回到parse()方法中，跟下doScan()过程。</p><figure class="highlight java"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-jt3xu9lhkez7dx"></i><span>java</span><div class="collapse show" id="collapse-jt3xu9lhkez7dx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">protected</span> Set&lt;BeanDefinitionHolder&gt; <span class="hljs-title function_">doScan</span><span class="hljs-params">(String... basePackages)</span> &#123;<br>Assert.notEmpty(basePackages, <span class="hljs-string">&quot;At least one base package must be specified&quot;</span>);<br>Set&lt;BeanDefinitionHolder&gt; beanDefinitions = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedHashSet</span>&lt;&gt;();<br><span class="hljs-keyword">for</span> (String basePackage : basePackages) &#123;<br><span class="hljs-comment">//扫描到有注解的类并封装成BeanDefinition对象</span><br>Set&lt;BeanDefinition&gt; candidates = findCandidateComponents(basePackage);<br><span class="hljs-keyword">for</span> (BeanDefinition candidate : candidates) &#123;<br><span class="hljs-type">ScopeMetadata</span> <span class="hljs-variable">scopeMetadata</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.scopeMetadataResolver.resolveScopeMetadata(candidate);<br>candidate.setScope(scopeMetadata.getScopeName());<br><span class="hljs-type">String</span> <span class="hljs-variable">beanName</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.beanNameGenerator.generateBeanName(candidate, <span class="hljs-built_in">this</span>.registry);<br><span class="hljs-keyword">if</span> (candidate <span class="hljs-keyword">instanceof</span> AbstractBeanDefinition) &#123;<br><span class="hljs-comment">//支持了@Lazy @DependOn注解</span><br>postProcessBeanDefinition((AbstractBeanDefinition) candidate, beanName);<br>&#125;<br><span class="hljs-keyword">if</span> (candidate <span class="hljs-keyword">instanceof</span> AnnotatedBeanDefinition) &#123;<br>AnnotationConfigUtils.processCommonDefinitionAnnotations((AnnotatedBeanDefinition) candidate);<br>&#125;<br><span class="hljs-keyword">if</span> (checkCandidate(beanName, candidate)) &#123;<br><span class="hljs-type">BeanDefinitionHolder</span> <span class="hljs-variable">definitionHolder</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BeanDefinitionHolder</span>(candidate, beanName);<br>definitionHolder =<br>AnnotationConfigUtils.applyScopedProxyMode(scopeMetadata, definitionHolder, <span class="hljs-built_in">this</span>.registry);<br>beanDefinitions.add(definitionHolder);<br><span class="hljs-comment">//BeanDefinition注册</span><br>registerBeanDefinition(definitionHolder, <span class="hljs-built_in">this</span>.registry);<br>&#125;<br>&#125;<br>&#125;<br><span class="hljs-keyword">return</span> beanDefinitions;<br>&#125;<br></code></pre></td></tr></table></div></figure><p>点进去看看registerBeanDefinition()方法</p><figure class="highlight java"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-hokzyflhkez7dx"></i><span>java</span><div class="collapse show" id="collapse-hokzyflhkez7dx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">registerBeanDefinition</span><span class="hljs-params">(BeanDefinitionHolder definitionHolder, BeanDefinitionRegistry registry)</span> &#123;<br>BeanDefinitionReaderUtils.registerBeanDefinition(definitionHolder, registry);<br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment">* BeanDefinitionReaderUtils</span><br><span class="hljs-comment">* Description : 向指定的bean工厂注册BeanDefinition</span><br><span class="hljs-comment">*/</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">registerBeanDefinition</span><span class="hljs-params">(</span><br><span class="hljs-params">BeanDefinitionHolder definitionHolder, BeanDefinitionRegistry registry)</span><br><span class="hljs-keyword">throws</span> BeanDefinitionStoreException &#123;<br><span class="hljs-comment">// Register bean definition under primary name.</span><br><span class="hljs-type">String</span> <span class="hljs-variable">beanName</span> <span class="hljs-operator">=</span> definitionHolder.getBeanName();<br><span class="hljs-comment">//完成BeanDefinition的注册，重点看，重要程度 5</span><br>registry.registerBeanDefinition(beanName, definitionHolder.getBeanDefinition());<br><span class="hljs-comment">//建立别名和 id的映射，这样就可以根据别名获取到id</span><br><span class="hljs-comment">// Register aliases for bean name, if any.</span><br>String[] aliases = definitionHolder.getAliases();<br><span class="hljs-keyword">if</span> (aliases != <span class="hljs-literal">null</span>) &#123;<br><span class="hljs-keyword">for</span> (String alias : aliases) &#123;<br>registry.registerAlias(beanName, alias);<br>&#125;<br>&#125;<br>&#125;<br></code></pre></td></tr></table></div></figure><figure class="highlight java"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-z1ldiilhkez7dx"></i><span>java</span><div class="collapse show" id="collapse-z1ldiilhkez7dx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment">* DefaultListableBeanFactory</span><br><span class="hljs-comment">* Description: 自定义标签的注册，和默认标签的注册方式一致，两个map</span><br><span class="hljs-comment">*/</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">registerBeanDefinition</span><span class="hljs-params">(String beanName, BeanDefinition beanDefinition)</span><br><span class="hljs-keyword">throws</span> BeanDefinitionStoreException &#123;<br>Assert.hasText(beanName, <span class="hljs-string">&quot;Bean name must not be empty&quot;</span>);<br>Assert.notNull(beanDefinition, <span class="hljs-string">&quot;BeanDefinition must not be null&quot;</span>);<br><span class="hljs-keyword">if</span> (beanDefinition <span class="hljs-keyword">instanceof</span> AbstractBeanDefinition) &#123;<br><span class="hljs-keyword">try</span> &#123;<br>((AbstractBeanDefinition) beanDefinition).validate();<br>&#125;<br><span class="hljs-keyword">catch</span> (BeanDefinitionValidationException ex) &#123;<br><span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BeanDefinitionStoreException</span>(beanDefinition.getResourceDescription(), beanName,<br><span class="hljs-string">&quot;Validation of bean definition failed&quot;</span>, ex);<br>&#125;<br>&#125;<br><span class="hljs-comment">// 先判断 BeanDefinition是否已经注册</span><br><span class="hljs-type">BeanDefinition</span> <span class="hljs-variable">existingDefinition</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.beanDefinitionMap.get(beanName);<br><span class="hljs-keyword">if</span> (existingDefinition != <span class="hljs-literal">null</span>) &#123;<br><span class="hljs-keyword">if</span> (!isAllowBeanDefinitionOverriding()) &#123;<br><span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BeanDefinitionOverrideException</span>(beanName, beanDefinition, existingDefinition);<br>&#125;<br><span class="hljs-comment">// ...... 省略 ......</span><br><span class="hljs-keyword">else</span> &#123;<br><span class="hljs-comment">// 把 beanDefinition 缓存到map中</span><br><span class="hljs-built_in">this</span>.beanDefinitionMap.put(beanName, beanDefinition);<br><span class="hljs-comment">//把 beanName放到 beanDefinitionNames list中，bean实例化的时候需要用到</span><br><span class="hljs-built_in">this</span>.beanDefinitionNames.add(beanName);<br><span class="hljs-built_in">this</span>.manualSingletonNames.remove(beanName);<br>&#125;<br><span class="hljs-built_in">this</span>.frozenBeanDefinitionNames = <span class="hljs-literal">null</span>;<br>&#125;<br><span class="hljs-keyword">if</span> (existingDefinition != <span class="hljs-literal">null</span> || containsSingleton(beanName)) &#123;<br>resetBeanDefinition(beanName);<br>&#125;<br>&#125;<br></code></pre></td></tr></table></div></figure><p>至此，自定义标签的解析过程全部完成，也是refresh方法中的obtainFreshBeanFactory()方法执行完成。主要功能总结下：</p><ul><li>创建BeanFactory对象</li><li>解析xml标签，封装成BeanDefinition对象并缓存起来，方便后续bean的实例化调用</li></ul><p>下一章，我将跟下Spring容器bean的实例化过程，敬请期待.^_^</p>]]></content>
    
    
    <categories>
      
      <category>Spring源码学习</category>
      
    </categories>
    
    
    <tags>
      
      <tag>源码</tag>
      
      <tag>Spring</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>【LeetCode】404. 左叶子之和</title>
    <link href="/posts/303765416.html"/>
    <url>/posts/303765416.html</url>
    
    <content type="html"><![CDATA[<h1 id="1-问题"><a href="#1-问题" class="headerlink" title="1.问题"></a>1.问题</h1><p>给定二叉树的根节点 root ，返回所有左叶子之和。</p><h2 id="示例-1"><a href="#示例-1" class="headerlink" title="示例 1"></a>示例 1</h2><p><img src="https://img-blog.csdnimg.cn/1c8275a05ba44dd4938411125d5f47dc.png" alt="图1"></p><blockquote><p>输入: root &#x3D; [3,9,20,null,null,15,7]<br>输出: 24</p></blockquote><p>解释: 在这个二叉树中，有两个左叶子，分别是 9 和 15，所以返回 24</p><h2 id="示例-2"><a href="#示例-2" class="headerlink" title="示例 2"></a>示例 2</h2><blockquote><p>输入: root &#x3D; [1]<br>输出: 0</p></blockquote><p><strong>提示</strong>:</p><ul><li>节点数在 [1, 1000] 范围内</li><li>-1000 &lt;&#x3D; Node.val &lt;&#x3D; 1000</li></ul><h1 id="2-解题思路"><a href="#2-解题思路" class="headerlink" title="2.解题思路"></a>2.解题思路</h1><h2 id="2-1-递归"><a href="#2-1-递归" class="headerlink" title="2.1 递归"></a>2.1 递归</h2><p>按照题目描述，我们需要遍历每个树节点，对于目标值，我们需要判定某个节点是否是需要的，既要判定是叶子节点，又要判定是左边的叶子节点，因而对于和的组成，进行分类谈论，如下：<br>1）节点为null，返回；<br>2）该节点左子树不为空，且为叶子节点，sum+&#x3D;该节点的value；否则递归左子树；<br>3）该节点右子树不为空，这里又要分类：<br>    3.1）右子树为叶子节点，不是题目需要的值的组成部分；<br>    3.2）右子树的子节点，只要左右其中一个不为空，继续递归。</p><p>伪代码：</p><figure class="highlight java"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-w5yyzdlhkez7dx"></i><span>java</span><div class="collapse show" id="collapse-w5yyzdlhkez7dx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//sumOfLeftLeaves(TreeNode root)为计算root所有左叶子节点的和的函数。</span><br><span class="hljs-type">int</span> <span class="hljs-title function_">sumOfLeftLeaves</span><span class="hljs-params">(TreeNode root)</span>&#123;<br><span class="hljs-comment">//节点为null</span><br><span class="hljs-keyword">if</span> root 为<span class="hljs-literal">null</span><br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br><span class="hljs-comment">//左子树</span><br><span class="hljs-keyword">if</span> root.left 不为<span class="hljs-literal">null</span><br><span class="hljs-comment">//root.left为叶子节点</span><br><span class="hljs-keyword">if</span>(root.left为叶子节点)&#123;<br>sum+=root.left.val;<br>&#125;<br><span class="hljs-comment">//否则，继续递归左子树</span><br><span class="hljs-keyword">else</span> &#123;<br>sum+=sumOfLeftLeaves(root.left);<br>&#125;<br><br><span class="hljs-comment">//右子树</span><br><span class="hljs-keyword">if</span> root.right 不为<span class="hljs-literal">null</span><br><span class="hljs-comment">//只要不是叶子节点，继续递归</span><br><span class="hljs-keyword">if</span> root.right 不是叶子节点<br> sum+=sumOfLeftLeaves(root.right);<br><span class="hljs-keyword">return</span> sum;<br>&#125;<br></code></pre></td></tr></table></div></figure><p>而判定是否是叶子节点，代码如下：</p><figure class="highlight java"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-y84lgelhkez7dx"></i><span>java</span><div class="collapse show" id="collapse-y84lgelhkez7dx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//判定是叶子节点</span><br><span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isLeaf</span><span class="hljs-params">(TreeNode node)</span>&#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>!=node &amp;&amp; <span class="hljs-literal">null</span>==node.left &amp;&amp; <span class="hljs-literal">null</span>==node.right;<br>&#125;<br></code></pre></td></tr></table></div></figure><h2 id="2-2-改进的递归"><a href="#2-2-改进的递归" class="headerlink" title="2.2 改进的递归"></a>2.2 改进的递归</h2><p>上述递归流程，过程是清晰明了的，但判定逻辑有点复杂，对于题目已知的条件，我们只需要抓重点，<strong>左叶子节点的和</strong>，其他都放在递归算法里了。<br>详细代码，见第3节代码。</p><h2 id="2-3-BFS"><a href="#2-3-BFS" class="headerlink" title="2.3 BFS"></a>2.3 BFS</h2><p>前面讨论的算法，遍历路径类似前序遍历，先根节点，再左右子节点，本质思想还是深度优先（DFS）。在二叉树遍历系列文章中，我们可以利用层序遍历，同样可以解决本章问题，其思想还是广度优先算法（BFS）。</p><h1 id="3-代码"><a href="#3-代码" class="headerlink" title="3.代码"></a>3.代码</h1><h2 id="3-1-递归算法"><a href="#3-1-递归算法" class="headerlink" title="3.1 递归算法"></a>3.1 递归算法</h2><figure class="highlight java"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-pozl0alhkez7dx"></i><span>java</span><div class="collapse show" id="collapse-pozl0alhkez7dx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">sumOfLeftLeaves2</span><span class="hljs-params">(TreeNode root)</span> &#123;<br>   <span class="hljs-keyword">if</span>(<span class="hljs-literal">null</span>==root)&#123;<br>       <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>   &#125;<br>   <span class="hljs-type">int</span> sum=<span class="hljs-number">0</span>;<br>   <span class="hljs-keyword">if</span>(<span class="hljs-literal">null</span>!=root.left)&#123;<br>       <span class="hljs-comment">//左子树为叶子节点，直接加上，否则继续递归左子树</span><br>       <span class="hljs-keyword">if</span>(isLeaf(root.left))&#123;<br>           sum+=root.left.val;<br>       &#125;<span class="hljs-keyword">else</span> &#123;<br>           sum+=sumOfLeftLeaves(root.left);<br>       &#125;<br>   &#125;<br>   <span class="hljs-comment">//右子树只要不为空，且至少存在一个节点（不管是左还是右）</span><br>   <span class="hljs-keyword">if</span>(<span class="hljs-literal">null</span>!=root.right)&#123;<br>       <span class="hljs-keyword">if</span>(!isLeaf(root.right))&#123;<br>           sum+=sumOfLeftLeaves(root.right);<br>       &#125;<br>   &#125;<br>   <span class="hljs-keyword">return</span> sum;<br>&#125;<br></code></pre></td></tr></table></div></figure><h2 id="3-2-改进的递归"><a href="#3-2-改进的递归" class="headerlink" title="3.2 改进的递归"></a>3.2 改进的递归</h2><figure class="highlight java"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-w9rkb7lhkez7dx"></i><span>java</span><div class="collapse show" id="collapse-w9rkb7lhkez7dx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">int</span> sum=<span class="hljs-number">0</span>;<br><span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">sumOfLeftLeaves</span><span class="hljs-params">(TreeNode root)</span> &#123;<br>    dfs(root);<br>    <span class="hljs-keyword">return</span> sum;<br>&#125;<br><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">dfs</span><span class="hljs-params">(TreeNode root)</span>&#123;<br>    <span class="hljs-keyword">if</span>(<span class="hljs-literal">null</span>==root)&#123;<br>        <span class="hljs-keyword">return</span>;<br>    &#125;<br>    <span class="hljs-comment">//是左叶子节点</span><br>    <span class="hljs-keyword">if</span>(<span class="hljs-literal">null</span>!=root.left &amp;&amp; isLeaf(root.left))&#123;<br>        sum+=root.left.val;<br>    &#125;<br>    <span class="hljs-comment">//继续遍历左右子树</span><br>    dfs(root.left);<br>    dfs(root.right);<br>&#125;<br></code></pre></td></tr></table></div></figure><h2 id="3-3-广度优先算法"><a href="#3-3-广度优先算法" class="headerlink" title="3.3 广度优先算法"></a>3.3 广度优先算法</h2><figure class="highlight java"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-0wih6xlhkez7dx"></i><span>java</span><div class="collapse show" id="collapse-0wih6xlhkez7dx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">sumOfLeftLeaves</span><span class="hljs-params">(TreeNode root)</span> &#123;<br>   <span class="hljs-keyword">if</span>(<span class="hljs-literal">null</span>==root)&#123;<br>       <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>   &#125;<br>   <span class="hljs-type">int</span> sum=<span class="hljs-number">0</span>;<br>   <span class="hljs-comment">//队列</span><br>   Queue&lt;TreeNode&gt; q=<span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedList</span>&lt;&gt;();<br>   q.offer(root);<br>   TreeNode node;<br>   <span class="hljs-comment">//遍历队列</span><br>   <span class="hljs-keyword">while</span>(!q.isEmpty())&#123;<br>       node=q.poll();<br>       <span class="hljs-keyword">if</span>(<span class="hljs-literal">null</span>==node)&#123;<br>           <span class="hljs-keyword">continue</span>;<br>       &#125;<br>       <span class="hljs-comment">//左叶子节点</span><br>       <span class="hljs-keyword">if</span>(<span class="hljs-literal">null</span>!=node.left &amp;&amp; isLeaf(node.left))&#123;<br>           sum+=node.left.val;<br>       &#125;<br>       q.offer(node.left);<br>       q.offer(node.right);<br>   &#125;<br>   <span class="hljs-keyword">return</span> sum;<br>&#125;<br></code></pre></td></tr></table></div></figure>]]></content>
    
    
    <categories>
      
      <category>算法</category>
      
      <category>二叉树</category>
      
      <category>DFS</category>
      
      <category>LeetCode</category>
      
      <category>BFS</category>
      
    </categories>
    
    
    <tags>
      
      <tag>二叉树</tag>
      
      <tag>数据结构</tag>
      
      <tag>LeetCode</tag>
      
      <tag>算法</tag>
      
      <tag>Java</tag>
      
      <tag>DFS</tag>
      
      <tag>BFS</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>【LeetCode】199.二叉树的右视图</title>
    <link href="/posts/2520912758.html"/>
    <url>/posts/2520912758.html</url>
    
    <content type="html"><![CDATA[<h1 id="1-问题"><a href="#1-问题" class="headerlink" title="1.问题"></a>1.问题</h1><p>给定一个二叉树的 根节点 root，想象自己站在它的右侧，按照从顶部到底部的顺序，返回从右侧所能看到的节点值。</p><p>##示例 1</p><p><img src="https://img-blog.csdnimg.cn/img_convert/6d1b1555754a31a4f682823c3d811e34.jpeg#pic_center"></p><blockquote><p>输入: [1,2,3,null,5,null,4]<br>输出: [1,3,4]</p></blockquote><p>##示例 2</p><blockquote><p>输入: [1,null,3]<br>输出: [1,3]</p></blockquote><p>##示例 3</p><blockquote><p>输入: []<br>输出: []</p></blockquote><p><strong>提示</strong>:</p><ul><li>二叉树的节点个数的范围是 [0,100]</li><li>-100 &lt;&#x3D; Node.val &lt;&#x3D; 100</li></ul><h1 id="2-解题思路"><a href="#2-解题思路" class="headerlink" title="2.解题思路"></a>2.解题思路</h1><p>经历过前面几篇关于二叉树的层序遍历算法之后（参见<a href="https://zyxelva.github.io/posts/2462725929.html">102.二叉树的层序遍历</a>，<a href="https://zyxelva.github.io/posts/2499526336.html">107.二叉树的层序遍历II</a>，非常容易的就可以通过这种算法解答此题，基本思想就是围绕队列性质，广度优先算法解决。当然，深度优先算法也是可以解决的。</p><h2 id="2-1-广度优先（BFS）"><a href="#2-1-广度优先（BFS）" class="headerlink" title="2.1 广度优先（BFS）"></a>2.1 广度优先（BFS）</h2><p>利用队列，遍历每层节点，并记录每层最后一个元素，直到遍历完最后一层，即可得到结果。访问顺序如下图所示：<br><img src="https://img-blog.csdnimg.cn/img_convert/25767cc8f2ce74adb672fd79bf3ddf17.png#pic_center"><br>红色结点自上而下组成答案，边缘以<strong>访问顺序</strong>标号。<br><strong>复杂度</strong>：</p><ul><li>时间复杂度： O(N)，每个节点都入队出队了 1 次。 </li><li>空间复杂度： O(N)，使用了额外的队列空间。</li></ul><h2 id="2-2-深度优先（DFS）"><a href="#2-2-深度优先（DFS）" class="headerlink" title="2.2 深度优先（DFS）"></a>2.2 深度优先（DFS）</h2><p>1）优先访问右子树，即访问顺序为：根-右-左；<br>2）如果当前节点所在深度还没有出现在res里（因为一层就一个节点），说明在该深度下当前节点是第一个被访问的节点，因此将当前节点加入res中。</p><figure class="highlight vim"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-v22vfolhkez7dx"></i><span>vim</span><div class="collapse show" id="collapse-v22vfolhkez7dx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs vim"><span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(<span class="hljs-keyword">res</span>) &lt; depth:<br>    <span class="hljs-keyword">res</span>.<span class="hljs-keyword">append</span>(root.val)<br># 遍历右子树<br><span class="hljs-keyword">if</span> root.<span class="hljs-keyword">right</span>:<br>    dfs(root.<span class="hljs-keyword">right</span>, depth + <span class="hljs-number">1</span>, <span class="hljs-keyword">res</span>)<br># 遍历左子树<br><span class="hljs-keyword">if</span> root.<span class="hljs-keyword">left</span>:<br>    dfs(root.<span class="hljs-keyword">left</span>, depth + <span class="hljs-number">1</span>, <span class="hljs-keyword">res</span>)<br></code></pre></td></tr></table></div></figure><p><strong>复杂度</strong>：</p><ul><li>时间复杂度： O(N)，每个节点都访问了 1 次。 </li><li>空间复杂度： O(N)，因为这不是一棵平衡二叉树，二叉树的深度最少是 logN, 最坏的情况下会退化成一条链表，深度就是N，因此递归时使用的栈空间是 O(N) 的。</li></ul><h1 id="3-代码"><a href="#3-代码" class="headerlink" title="3.代码"></a>3.代码</h1><figure class="highlight java"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-apn0hglhkez7dx"></i><span>java</span><div class="collapse show" id="collapse-apn0hglhkez7dx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Definition for a binary tree node.</span><br><span class="hljs-comment"> * public class TreeNode &#123;</span><br><span class="hljs-comment"> *     int val;</span><br><span class="hljs-comment"> *     TreeNode left;</span><br><span class="hljs-comment"> *     TreeNode right;</span><br><span class="hljs-comment"> *     TreeNode() &#123;&#125;</span><br><span class="hljs-comment"> *     TreeNode(int val) &#123; this.val = val; &#125;</span><br><span class="hljs-comment"> *     TreeNode(int val, TreeNode left, TreeNode right) &#123;</span><br><span class="hljs-comment"> *         this.val = val;</span><br><span class="hljs-comment"> *         this.left = left;</span><br><span class="hljs-comment"> *         this.right = right;</span><br><span class="hljs-comment"> *     &#125;</span><br><span class="hljs-comment"> * &#125;</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Solution</span> &#123;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">    广度优先</span><br><span class="hljs-comment">        1.利用层序遍历思想，统计每层最后一个元素，即为答案</span><br><span class="hljs-comment">        2.分层标识</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> List&lt;Integer&gt; <span class="hljs-title function_">rightSideView2</span><span class="hljs-params">(TreeNode root)</span> &#123;<br>        <span class="hljs-comment">//空节点</span><br>        <span class="hljs-keyword">if</span>(<span class="hljs-literal">null</span>==root)&#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>        &#125;<br>        List&lt;Integer&gt; res=<span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>();<br>        <span class="hljs-comment">//每层的遍历结果集</span><br>        List&lt;Integer&gt; tmp=<span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>();<br>        TreeNode node;<br>        <span class="hljs-comment">//队列</span><br>        Queue&lt;TreeNode&gt; q=<span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedList</span>();<br>        <span class="hljs-comment">//入队</span><br>        q.add(root);<br>        <span class="hljs-comment">//分层标识</span><br>        q.add(<span class="hljs-literal">null</span>);<br><br>        <span class="hljs-keyword">while</span>(!q.isEmpty())&#123;<br>            node=q.poll();<br>            <span class="hljs-keyword">if</span>(<span class="hljs-literal">null</span>!=node)&#123;<br>                tmp.add(node.val);<br>                <span class="hljs-comment">//左右子树入队</span><br>                <span class="hljs-keyword">if</span>(<span class="hljs-literal">null</span>!=node.left)&#123;<br>                    q.add(node.left);<br>                &#125;<br>                <span class="hljs-keyword">if</span>(<span class="hljs-literal">null</span>!=node.right)&#123;<br>                    q.add(node.right);<br>                &#125;<br>            &#125;<br>            <span class="hljs-comment">//否层，该层遍历完毕</span><br>            <span class="hljs-keyword">else</span>&#123;<br>                <span class="hljs-keyword">if</span>(!tmp.isEmpty())&#123;<br>                    <span class="hljs-comment">//收集每层最后一个元素</span><br>                    res.add(tmp.get(tmp.size()-<span class="hljs-number">1</span>));<br>                    tmp=<span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>();<br>                    q.add(<span class="hljs-literal">null</span>);<br>                &#125;<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">return</span> res;<br>    &#125;<br><br>    <span class="hljs-comment">//深度优先，递归</span><br>    <span class="hljs-keyword">public</span> List&lt;Integer&gt; <span class="hljs-title function_">rightSideView</span><span class="hljs-params">(TreeNode root)</span> &#123;<br>        <span class="hljs-comment">//判空</span><br>        <span class="hljs-keyword">if</span>(<span class="hljs-literal">null</span>==root)&#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>();<br>        &#125;<br>        List&lt;Integer&gt; res=<span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>();<br>        dfs(root, <span class="hljs-number">0</span>, res);<br>        <span class="hljs-keyword">return</span> res;<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">dfs</span><span class="hljs-params">(TreeNode root, <span class="hljs-type">int</span> depth, List&lt;Integer&gt; res)</span>&#123;<br>        <span class="hljs-keyword">if</span>(res.size()==depth)&#123;<br>            res.add(root.val);<br>        &#125;<br>        <span class="hljs-comment">//左右子树，先遍历右子树，然后左子树</span><br>        <span class="hljs-keyword">if</span>(<span class="hljs-literal">null</span>!=root.right)&#123;<br>            dfs(root.right, depth+<span class="hljs-number">1</span>, res);<br>        &#125;<br>        <span class="hljs-keyword">if</span>(<span class="hljs-literal">null</span>!=root.left)&#123;<br>            dfs(root.left, depth+<span class="hljs-number">1</span>, res);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></div></figure>]]></content>
    
    
    <categories>
      
      <category>算法</category>
      
      <category>二叉树</category>
      
      <category>DFS</category>
      
      <category>LeetCode</category>
      
      <category>BFS</category>
      
    </categories>
    
    
    <tags>
      
      <tag>二叉树</tag>
      
      <tag>数据结构</tag>
      
      <tag>LeetCode</tag>
      
      <tag>算法</tag>
      
      <tag>Java</tag>
      
      <tag>DFS</tag>
      
      <tag>BFS</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>【LeetCode】1768.交替合并字符串</title>
    <link href="/posts/1094624484.html"/>
    <url>/posts/1094624484.html</url>
    
    <content type="html"><![CDATA[<h1 id="一、问题"><a href="#一、问题" class="headerlink" title="一、问题"></a>一、问题</h1><pre><code class="hljs">    给你两个字符串 word1 和 word2 。请你从 word1 开始，通过交替添加字母来合并字符串。如果一个字符串比另一个字符串长，就将多出来的字母追加到合并后字符串的末尾。返回合并后的字符串 。</code></pre><h1 id="二、解题思路"><a href="#二、解题思路" class="headerlink" title="二、解题思路"></a>二、解题思路</h1><h2 id="1-双指针"><a href="#1-双指针" class="headerlink" title="1.双指针"></a>1.双指针</h2><p>1）i，j分别指向字符串word<del>1</del>，word<del>2</del>;<br>2）循环遍历word<del>1</del>，word<del>2</del>，只要i，j均遍历完成</p><h2 id="2-单指针"><a href="#2-单指针" class="headerlink" title="2.单指针"></a>2.单指针</h2><p>其实，只要一个指针就可以搞定，而且遍历次数最多Math.min(word<del>1</del> 的长度, word<del>2</del> 的长度)，剩下的最长那个字符串，利用String.substring(index)即可得到需要的答案。伪代码如下：</p><figure class="highlight java"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-k73bwhlhkez7dx"></i><span>java</span><div class="collapse show" id="collapse-k73bwhlhkez7dx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">while</span>(i&lt;minLength)&#123;<br>sb.append(word1[i]);<br>sb.append(word2[i]);<br>i++;<br>&#125;<br><span class="hljs-keyword">if</span>(i&lt;word1.length())&#123;<br>sb.append(word1.substring(i));<br>&#125;<br><span class="hljs-keyword">if</span>(i&lt;word2.length())&#123;<br>sb.append(word2.substring(i));<br>&#125;<br></code></pre></td></tr></table></div></figure><h1 id="三、代码"><a href="#三、代码" class="headerlink" title="三、代码"></a>三、代码</h1><h2 id="1-双指针-1"><a href="#1-双指针-1" class="headerlink" title="1.双指针"></a>1.双指针</h2><figure class="highlight java"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-4s92wklhkez7dx"></i><span>java</span><div class="collapse show" id="collapse-4s92wklhkez7dx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Solution</span> &#123;<br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">mergeAlternately</span><span class="hljs-params">(String word1, String word2)</span> &#123;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">m</span> <span class="hljs-operator">=</span> word1.length();<br>        <span class="hljs-type">int</span> <span class="hljs-variable">n</span> <span class="hljs-operator">=</span> word2.length();<br>        <span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">j</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br><br>        <span class="hljs-type">StringBuilder</span> <span class="hljs-variable">ans</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>();<br>        <span class="hljs-keyword">while</span> (i &lt; m || j &lt; n) &#123;<br>            <span class="hljs-keyword">if</span> (i &lt; m) &#123;<br>                ans.append(word1.charAt(i));<br>                ++i;<br>            &#125;<br>            <span class="hljs-keyword">if</span> (j &lt; n) &#123;<br>                ans.append(word2.charAt(j));<br>                ++j;<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">return</span> ans.toString();<br>    &#125;<br>&#125;<br><span class="hljs-comment">/**</span><br><span class="hljs-comment">作者：力扣官方题解</span><br><span class="hljs-comment">链接：https://leetcode.cn/problems/merge-strings-alternately/solutions/1913930/jiao-ti-he-bing-zi-fu-chuan-by-leetcode-ac4ih/</span><br><span class="hljs-comment">来源：力扣（LeetCode）</span><br><span class="hljs-comment">著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。</span><br><span class="hljs-comment">*/</span><br></code></pre></td></tr></table></div></figure><h2 id="2-单指针-1"><a href="#2-单指针-1" class="headerlink" title="2.单指针"></a>2.单指针</h2><figure class="highlight java"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-mdhtgclhkez7dx"></i><span>java</span><div class="collapse show" id="collapse-mdhtgclhkez7dx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> String <span class="hljs-title function_">mergeAlternately</span><span class="hljs-params">(String word1, String word2)</span> &#123;<br>    <span class="hljs-type">int</span> i=<span class="hljs-number">0</span>;<br>    StringBuilder sb=<span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>();<br>    <span class="hljs-type">int</span> minLength=Math.min(word1.length(), word2.length());<br>    <span class="hljs-keyword">while</span>(i&lt;minLength)&#123;<br>        sb.append(word1.charAt(i));<br>        sb.append(word2.charAt(i));<br>        i++;<br>    &#125;<br>    <span class="hljs-keyword">if</span>(i&lt;word1.length())&#123;<br>        sb.append(word1.substring(i));<br>    &#125;<br>    <span class="hljs-keyword">if</span>(i&lt;word2.length())&#123;<br>        sb.append(word2.substring(i));<br>    &#125;<br>    <span class="hljs-keyword">return</span> sb.toString();<br>&#125;  <br></code></pre></td></tr></table></div></figure><h2 id="复杂度分析"><a href="#复杂度分析" class="headerlink" title="复杂度分析"></a>复杂度分析</h2><ul><li><p>时间复杂度：O(m+n)，其中 m 和 n 分别是字符串 word<del>1</del> 和 word<del>2</del> 的长度。</p></li><li><p>空间复杂度：O(1)或 O(m+n)。如果使用的语言支持可修改的字符串，那么空间复杂度为 O(1)，否则为 O(m+n)，比如java。注意这里不计入返回值需要的空间。</p></li></ul>]]></content>
    
    
    <categories>
      
      <category>算法</category>
      
      <category>LeetCode</category>
      
      <category>指针</category>
      
    </categories>
    
    
    <tags>
      
      <tag>LeetCode</tag>
      
      <tag>算法</tag>
      
      <tag>指针</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>【Spring源码学习】简介</title>
    <link href="/posts/4250399261.html"/>
    <url>/posts/4250399261.html</url>
    
    <content type="html"><![CDATA[<h1 id="一、为什么要学习Spring源码"><a href="#一、为什么要学习Spring源码" class="headerlink" title="一、为什么要学习Spring源码"></a>一、为什么要学习Spring源码</h1><ul><li>学习大神优秀的思想和代码风格</li><li>面试专业吹牛逼的法宝</li><li>写出更加优秀的代码</li></ul><h1 id="二、怎样学习源码"><a href="#二、怎样学习源码" class="headerlink" title="二、怎样学习源码"></a>二、怎样学习源码</h1><ul><li>java基础需要过硬</li><li>跟着demo跟代码</li><li>记录每个知识点，方便以后查阅和修正</li><li>注释关键点代码</li><li>有规律的复习</li><li>反复Do Exercise(不断练习)-&gt;Learning(由浅到深，由窄到宽)-&gt;Trying(尝试自己去实现)-&gt;Teaching(把自己理解的讲给别人听，查漏补缺，互相进步)</li></ul><h1 id="三、搭建Spring-Demo项目"><a href="#三、搭建Spring-Demo项目" class="headerlink" title="三、搭建Spring-Demo项目"></a>三、搭建Spring-Demo项目</h1><h2 id="1-前期准备"><a href="#1-前期准备" class="headerlink" title="1.前期准备"></a>1.前期准备</h2><ul><li>JDK8</li><li>Spring5.2.8Release</li><li>Idea</li><li>Maven</li></ul><h2 id="2-pom依赖导入"><a href="#2-pom依赖导入" class="headerlink" title="2.pom依赖导入"></a>2.pom依赖导入</h2><p>最最核心的spring依赖</p><figure class="highlight xml"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-zyr9stlhkez7dx"></i><span>xml</span><div class="collapse show" id="collapse-zyr9stlhkez7dx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>   <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>   <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-context<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>   <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>$&#123;spring.version&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></div></figure><p>当然还需要其他的辅助，比如测试、日志</p><figure class="highlight xml"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-edumqflhkez7dx"></i><span>xml</span><div class="collapse show" id="collapse-edumqflhkez7dx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>   <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>   <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-test<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>   <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>$&#123;spring.version&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>ch.qos.logback<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>logback-classic<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.1.2<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></div></figure><h2 id="3-spring-xml"><a href="#3-spring-xml" class="headerlink" title="3.spring.xml"></a>3.spring.xml</h2><p>Spring核心配置文件</p><figure class="highlight xml"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-4j2qinlhkez7dx"></i><span>xml</span><div class="collapse show" id="collapse-4j2qinlhkez7dx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">beans</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">&quot;http://www.springframework.org/schema/beans&quot;</span></span><br><span class="hljs-tag">       <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span><br><span class="hljs-tag">       <span class="hljs-attr">xmlns:context</span>=<span class="hljs-string">&quot;http://www.springframework.org/schema/context&quot;</span></span><br><span class="hljs-tag">       <span class="hljs-attr">xmlns:aop</span>=<span class="hljs-string">&quot;http://www.springframework.org/schema/aop&quot;</span></span><br><span class="hljs-tag">       <span class="hljs-attr">xmlns:p</span>=<span class="hljs-string">&quot;http://www.springframework.org/schema/p&quot;</span></span><br><span class="hljs-tag">       <span class="hljs-attr">xmlns:c</span>=<span class="hljs-string">&quot;http://www.springframework.org/schema/c&quot;</span></span><br><span class="hljs-tag">       <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">&quot;</span></span><br><span class="hljs-string"><span class="hljs-tag">http://www.springframework.org/schema/beans</span></span><br><span class="hljs-string"><span class="hljs-tag">http://www.springframework.org/schema/beans/spring-beans.xsd</span></span><br><span class="hljs-string"><span class="hljs-tag">    http://www.springframework.org/schema/context</span></span><br><span class="hljs-string"><span class="hljs-tag">    http://www.springframework.org/schema/context/spring-context.xsd</span></span><br><span class="hljs-string"><span class="hljs-tag">    http://www.springframework.org/schema/aop</span></span><br><span class="hljs-string"><span class="hljs-tag">http://www.springframework.org/schema/aop/spring-aop-3.2.xsd&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">default-lazy-init</span>=<span class="hljs-string">&quot;false&quot;</span>&gt;</span><br><br>    <span class="hljs-comment">&lt;!--自定义标签--&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">context:component-scan</span> <span class="hljs-attr">base-package</span>=<span class="hljs-string">&quot;com.enjoy.jack&quot;</span> /&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">context:property-placeholder</span> <span class="hljs-attr">location</span>=<span class="hljs-string">&quot;classpath:application.properties&quot;</span>/&gt;</span><br></code></pre></td></tr></table></div></figure><p>其中最重要namespace为</p><figure class="highlight xml"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-5u4ju2lhkez7dx"></i><span>xml</span><div class="collapse show" id="collapse-5u4ju2lhkez7dx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs xml">xmlns:context=&quot;http://www.springframework.org/schema/context&quot;<br>http://www.springframework.org/schema/context<br>http://www.springframework.org/schema/context/spring-context.xsd<br></code></pre></td></tr></table></div></figure><h1 id="四、Spring容器加载方式"><a href="#四、Spring容器加载方式" class="headerlink" title="四、Spring容器加载方式"></a>四、Spring容器加载方式</h1><ul><li>类路径获取配置文件<figure class="highlight java"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-yiw664lhkez7dx"></i><span>java</span><div class="collapse show" id="collapse-yiw664lhkez7dx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">ApplicationContext applicationContext= <span class="hljs-keyword">new</span> <span class="hljs-title class_">ClassPathXmlApplicationContext</span>(<span class="hljs-string">&quot;spring.xml&quot;</span>);<br></code></pre></td></tr></table></div></figure></li><li>文件系统路径获取配置文件【绝对路径】<figure class="highlight java"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-jiwcbblhkez7dx"></i><span>java</span><div class="collapse show" id="collapse-jiwcbblhkez7dx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">ApplicationContext</span> <span class="hljs-variable">applicationContext</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileSystemXmlApplicationContext</span>(<span class="hljs-string">&quot;E:\com\public\springdemo\src\main\resources\spring.xml&quot;</span>);<br></code></pre></td></tr></table></div></figure></li><li>无配置文件加载容器<figure class="highlight java"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-9vc8nllhkez7dx"></i><span>java</span><div class="collapse show" id="collapse-9vc8nllhkez7dx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">ApplicationContext</span> <span class="hljs-variable">applicationContext</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AnnotationConfigApplicationContext</span>(<span class="hljs-string">&quot;com.xx.jack&quot;</span>);<br></code></pre></td></tr></table></div></figure></li><li>Springboot加载容器<figure class="highlight java"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-k6db7hlhkez7dx"></i><span>java</span><div class="collapse show" id="collapse-k6db7hlhkez7dx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">ApplicationContext</span> <span class="hljs-variable">applicationContext</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">EmbeddedWebApplicationContext</span>();<br></code></pre></td></tr></table></div></figure></li></ul><p>后续Spring源码跟进，我主要以ClassPathXmlApplicationContext的方式。</p>]]></content>
    
    
    <categories>
      
      <category>Spring源码学习</category>
      
    </categories>
    
    
    <tags>
      
      <tag>源码</tag>
      
      <tag>Spring</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>【MyBatis源码学习】Spring集成MyBatis的原理分析</title>
    <link href="/posts/3776305968.html"/>
    <url>/posts/3776305968.html</url>
    
    <content type="html"><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>上一章中<a href="https://zyxelva.github.io/2023/04/30/%E3%80%90Mybatis%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0%E3%80%91Spring%E9%9B%86%E6%88%90Mybatis%E7%9A%84%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90/">【MyBatis源码学习】MyBatis与Spring整合</a>，我们介绍了Mybatis与Spring、Spring Boot的融合，其中我们提到了mybatis-spring中的几个关键类，本章我们来跟踪下这几个关键类的源码，看看它们干了些啥.</p><h1 id="一、源码下载"><a href="#一、源码下载" class="headerlink" title="一、源码下载"></a>一、源码下载</h1><p>和mybatis源码下载一样，从GitHub下载好后，本地打包部署一下，方便我们后面进行测试时方便查看。源码地址：<a href="https://github.com/mybatis/spring">这里是MyBatis-Spring源码地址</a>.</p><h1 id="二、核心类源码解析"><a href="#二、核心类源码解析" class="headerlink" title="二、核心类源码解析"></a>二、核心类源码解析</h1><p>先来回顾下核心类的功能：</p><ul><li>SqlSessionFactoryBean：用于创建SqlSessionFactory；</li><li>MapperScannerConfigurer：自动扫描所有的 Mapper 接口，使用时可以直接注入接口。</li></ul><h2 id="1-SqlSessionFactoryBean"><a href="#1-SqlSessionFactoryBean" class="headerlink" title="1.SqlSessionFactoryBean"></a>1.SqlSessionFactoryBean</h2><p>(1) UML<br><img src="https://img-blog.csdnimg.cn/20210324100712686.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2tlemFkZQ==,size_16,color_FFFFFF,t_70"><br>(2) 配置和源码解析<br>通常我们在项目中整合Spring和mybatis时，Spring相关的配置文件会包含：</p><figure class="highlight xml"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-8zssndlhkez7dw"></i><span>xml</span><div class="collapse show" id="collapse-8zssndlhkez7dw"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!-- spring和MyBatis完美整合，不需要mybatis的配置映射文件 --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;sqlSessionFactory&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;org.mybatis.spring.SqlSessionFactoryBean&quot;</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;dataSource&quot;</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">&quot;dataSource&quot;</span> /&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;typeAliasesPackage&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;com.enjoylearning.mybatis.entity&quot;</span> /&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;mapperLocations&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;classpath:sqlmapper/*.xml&quot;</span> /&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span><br></code></pre></td></tr></table></div></figure><p>并且dataSource必须配置，我们可以从方法afterPropertiesSet()看出来：</p><figure class="highlight java"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-hmwb36lhkez7dw"></i><span>java</span><div class="collapse show" id="collapse-hmwb36lhkez7dw"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 在spring容器中创建全局唯一的sqlSessionFactory</span><br><span class="hljs-comment">   *</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@throws</span> Exception 异常</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">afterPropertiesSet</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>    <span class="hljs-comment">//数据源不能为空</span><br>    notNull(dataSource, <span class="hljs-string">&quot;Property &#x27;dataSource&#x27; is required&quot;</span>);<br>    <span class="hljs-comment">//sqlSessionFactoryBuilder不能为空，但初始化SqlSessionFactoryBean完，sqlSessionFactoryBuilder已经创建了</span><br>    notNull(sqlSessionFactoryBuilder, <span class="hljs-string">&quot;Property &#x27;sqlSessionFactoryBuilder&#x27; is required&quot;</span>);<br>    state((configuration == <span class="hljs-literal">null</span> &amp;&amp; configLocation == <span class="hljs-literal">null</span>) || !(configuration != <span class="hljs-literal">null</span> &amp;&amp; configLocation != <span class="hljs-literal">null</span>),<br>              <span class="hljs-string">&quot;Property &#x27;configuration&#x27; and &#x27;configLocation&#x27; can not specified with together&quot;</span>);<br><br>    <span class="hljs-built_in">this</span>.sqlSessionFactory = buildSqlSessionFactory();<br>  &#125;<br></code></pre></td></tr></table></div></figure><p>接下来，看看方法。主要功能构建和丰富Configuration，并创建sqlSessionFactory.</p><figure class="highlight java"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-6bggrmlhkez7dw"></i><span>java</span><div class="collapse show" id="collapse-6bggrmlhkez7dw"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment">   * Build a &#123;<span class="hljs-doctag">@code</span> SqlSessionFactory&#125; instance.</span><br><span class="hljs-comment">   *</span><br><span class="hljs-comment">   * The default implementation uses the standard MyBatis &#123;<span class="hljs-doctag">@code</span> XMLConfigBuilder&#125; API to build a</span><br><span class="hljs-comment">   * &#123;<span class="hljs-doctag">@code</span> SqlSessionFactory&#125; instance based on an Reader.</span><br><span class="hljs-comment">   * Since 1.3.0, it can be specified a &#123;<span class="hljs-doctag">@link</span> Configuration&#125; instance directly(without config file).</span><br><span class="hljs-comment">   *</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@return</span> SqlSessionFactory</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@throws</span> IOException if loading the config file failed</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">protected</span> SqlSessionFactory <span class="hljs-title function_">buildSqlSessionFactory</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>    Configuration configuration;<br>    <span class="hljs-type">XMLConfigBuilder</span> <span class="hljs-variable">xmlConfigBuilder</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>    <span class="hljs-comment">//如果configuration不为空，则使用该对象，并对其进行配置</span><br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.configuration != <span class="hljs-literal">null</span>) &#123;<br>      configuration = <span class="hljs-built_in">this</span>.configuration;<br>      <span class="hljs-keyword">if</span> (configuration.getVariables() == <span class="hljs-literal">null</span>) &#123;<br>        configuration.setVariables(<span class="hljs-built_in">this</span>.configurationProperties);<br>      &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.configurationProperties != <span class="hljs-literal">null</span>) &#123;<br>        configuration.getVariables().putAll(<span class="hljs-built_in">this</span>.configurationProperties);<br>      &#125;<br>      <span class="hljs-comment">//创建xmlConfigBuilder，读取mybatis的核心配置文件</span><br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.configLocation != <span class="hljs-literal">null</span>) &#123;<br>      xmlConfigBuilder = <span class="hljs-keyword">new</span> <span class="hljs-title class_">XMLConfigBuilder</span>(<span class="hljs-built_in">this</span>.configLocation.getInputStream(), <span class="hljs-literal">null</span>, <span class="hljs-built_in">this</span>.configurationProperties);<br>      configuration = xmlConfigBuilder.getConfiguration();<br>      <span class="hljs-comment">//如果configuration为空，实例化一个configuration对象</span><br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-keyword">if</span> (LOGGER.isDebugEnabled()) &#123;<br>        LOGGER.debug(<span class="hljs-string">&quot;Property &#x27;configuration&#x27; or &#x27;configLocation&#x27; not specified, using default MyBatis Configuration&quot;</span>);<br>      &#125;<br>      configuration = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Configuration</span>();<br>      <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.configurationProperties != <span class="hljs-literal">null</span>) &#123;<br>        configuration.setVariables(<span class="hljs-built_in">this</span>.configurationProperties);<br>      &#125;<br>    &#125;<br>    <span class="hljs-comment">//设置objectFactory</span><br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.objectFactory != <span class="hljs-literal">null</span>) &#123;<br>      configuration.setObjectFactory(<span class="hljs-built_in">this</span>.objectFactory);<br>    &#125;<br>    <span class="hljs-comment">//设置objectWrapperFactory</span><br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.objectWrapperFactory != <span class="hljs-literal">null</span>) &#123;<br>      configuration.setObjectWrapperFactory(<span class="hljs-built_in">this</span>.objectWrapperFactory);<br>    &#125;<br>    <span class="hljs-comment">//设置vfs</span><br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.vfs != <span class="hljs-literal">null</span>) &#123;<br>      configuration.setVfsImpl(<span class="hljs-built_in">this</span>.vfs);<br>    &#125;<br>    <span class="hljs-comment">//扫描指定的包typeAliasesPackage，注册别名</span><br>    <span class="hljs-keyword">if</span> (hasLength(<span class="hljs-built_in">this</span>.typeAliasesPackage)) &#123;<br>      String[] typeAliasPackageArray = tokenizeToStringArray(<span class="hljs-built_in">this</span>.typeAliasesPackage, ConfigurableApplicationContext.CONFIG_LOCATION_DELIMITERS);<br>      <span class="hljs-keyword">for</span> (String packageToScan : typeAliasPackageArray) &#123;<br>        configuration.getTypeAliasRegistry().registerAliases(packageToScan, typeAliasesSuperType == <span class="hljs-literal">null</span> ? Object.class : typeAliasesSuperType);<br>        <span class="hljs-keyword">if</span> (LOGGER.isDebugEnabled()) &#123;<br>          LOGGER.debug(<span class="hljs-string">&quot;Scanned package: &#x27;&quot;</span> + packageToScan + <span class="hljs-string">&quot;&#x27; for aliases&quot;</span>);<br>        &#125;<br>      &#125;<br>    &#125;<br>    <span class="hljs-comment">//为typeAliases指定的类注册别名</span><br>    <span class="hljs-keyword">if</span> (!isEmpty(<span class="hljs-built_in">this</span>.typeAliases)) &#123;<br>      <span class="hljs-keyword">for</span> (Class&lt;?&gt; typeAlias : <span class="hljs-built_in">this</span>.typeAliases) &#123;<br>        configuration.getTypeAliasRegistry().registerAlias(typeAlias);<br>        <span class="hljs-keyword">if</span> (LOGGER.isDebugEnabled()) &#123;<br>          LOGGER.debug(<span class="hljs-string">&quot;Registered type alias: &#x27;&quot;</span> + typeAlias + <span class="hljs-string">&quot;&#x27;&quot;</span>);<br>        &#125;<br>      &#125;<br>    &#125;<br>    <span class="hljs-comment">//注册插件</span><br>    <span class="hljs-keyword">if</span> (!isEmpty(<span class="hljs-built_in">this</span>.plugins)) &#123;<br>      <span class="hljs-keyword">for</span> (Interceptor plugin : <span class="hljs-built_in">this</span>.plugins) &#123;<br>        configuration.addInterceptor(plugin);<br>        <span class="hljs-keyword">if</span> (LOGGER.isDebugEnabled()) &#123;<br>          LOGGER.debug(<span class="hljs-string">&quot;Registered plugin: &#x27;&quot;</span> + plugin + <span class="hljs-string">&quot;&#x27;&quot;</span>);<br>        &#125;<br>      &#125;<br>    &#125;<br>    <span class="hljs-comment">//扫描指定的包typeHandlersPackage，注册类型解析器</span><br>    <span class="hljs-keyword">if</span> (hasLength(<span class="hljs-built_in">this</span>.typeHandlersPackage)) &#123;<br>      String[] typeHandlersPackageArray = tokenizeToStringArray(<span class="hljs-built_in">this</span>.typeHandlersPackage, ConfigurableApplicationContext.CONFIG_LOCATION_DELIMITERS);<br>      <span class="hljs-keyword">for</span> (String packageToScan : typeHandlersPackageArray) &#123;<br>        configuration.getTypeHandlerRegistry().register(packageToScan);<br>        <span class="hljs-keyword">if</span> (LOGGER.isDebugEnabled()) &#123;<br>          LOGGER.debug(<span class="hljs-string">&quot;Scanned package: &#x27;&quot;</span> + packageToScan + <span class="hljs-string">&quot;&#x27; for type handlers&quot;</span>);<br>        &#125;<br>      &#125;<br>    &#125;<br>    <span class="hljs-comment">//为typeHandlers指定的类注册类型解析器</span><br>    <span class="hljs-keyword">if</span> (!isEmpty(<span class="hljs-built_in">this</span>.typeHandlers)) &#123;<br>      <span class="hljs-keyword">for</span> (TypeHandler&lt;?&gt; typeHandler : <span class="hljs-built_in">this</span>.typeHandlers) &#123;<br>        configuration.getTypeHandlerRegistry().register(typeHandler);<br>        <span class="hljs-keyword">if</span> (LOGGER.isDebugEnabled()) &#123;<br>          LOGGER.debug(<span class="hljs-string">&quot;Registered type handler: &#x27;&quot;</span> + typeHandler + <span class="hljs-string">&quot;&#x27;&quot;</span>);<br>        &#125;<br>      &#125;<br>    &#125;<br>    <span class="hljs-comment">//配置databaseIdProvider</span><br>    <span class="hljs-comment">//fix #64 set databaseId before parse mapper xmls</span><br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.databaseIdProvider != <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-keyword">try</span> &#123;<br>        configuration.setDatabaseId(<span class="hljs-built_in">this</span>.databaseIdProvider.getDatabaseId(<span class="hljs-built_in">this</span>.dataSource));<br>      &#125; <span class="hljs-keyword">catch</span> (SQLException e) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NestedIOException</span>(<span class="hljs-string">&quot;Failed getting a databaseId&quot;</span>, e);<br>      &#125;<br>    &#125;<br>    <span class="hljs-comment">//配置缓存</span><br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.cache != <span class="hljs-literal">null</span>) &#123;<br>      configuration.addCache(<span class="hljs-built_in">this</span>.cache);<br>    &#125;<br>    <span class="hljs-comment">//使用xmlConfigBuilder读取mybatis的核心配置文件</span><br>    <span class="hljs-keyword">if</span> (xmlConfigBuilder != <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-keyword">try</span> &#123;<br>        xmlConfigBuilder.parse();<br>        <span class="hljs-keyword">if</span> (LOGGER.isDebugEnabled()) &#123;<br>          LOGGER.debug(<span class="hljs-string">&quot;Parsed configuration file: &#x27;&quot;</span> + <span class="hljs-built_in">this</span>.configLocation + <span class="hljs-string">&quot;&#x27;&quot;</span>);<br>        &#125;<br>      &#125; <span class="hljs-keyword">catch</span> (Exception ex) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NestedIOException</span>(<span class="hljs-string">&quot;Failed to parse config resource: &quot;</span> + <span class="hljs-built_in">this</span>.configLocation, ex);<br>      &#125; <span class="hljs-keyword">finally</span> &#123;<br>        ErrorContext.instance().reset();<br>      &#125;<br>    &#125;<br>    <span class="hljs-comment">//默认使用SpringManagedTransactionFactory作为事务管理器</span><br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.transactionFactory == <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-built_in">this</span>.transactionFactory = <span class="hljs-keyword">new</span> <span class="hljs-title class_">SpringManagedTransactionFactory</span>();<br>    &#125;<br>    <span class="hljs-comment">//设置Environment</span><br>    configuration.setEnvironment(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Environment</span>(<span class="hljs-built_in">this</span>.environment, <span class="hljs-built_in">this</span>.transactionFactory, <span class="hljs-built_in">this</span>.dataSource));<br>    <span class="hljs-comment">//根据mapperLocations的配置，处理映射配置文件以及相应的mapper接口</span><br>    <span class="hljs-keyword">if</span> (!isEmpty(<span class="hljs-built_in">this</span>.mapperLocations)) &#123;<br>      <span class="hljs-keyword">for</span> (Resource mapperLocation : <span class="hljs-built_in">this</span>.mapperLocations) &#123;<br>        <span class="hljs-keyword">if</span> (mapperLocation == <span class="hljs-literal">null</span>) &#123;<br>          <span class="hljs-keyword">continue</span>;<br>        &#125;<br>        <span class="hljs-keyword">try</span> &#123;<br>          <span class="hljs-type">XMLMapperBuilder</span> <span class="hljs-variable">xmlMapperBuilder</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">XMLMapperBuilder</span>(mapperLocation.getInputStream(), configuration, mapperLocation.toString(), configuration.getSqlFragments());<br>          xmlMapperBuilder.parse();<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>          <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NestedIOException</span>(<span class="hljs-string">&quot;Failed to parse mapping resource: &#x27;&quot;</span> + mapperLocation + <span class="hljs-string">&quot;&#x27;&quot;</span>, e);<br>        &#125; <span class="hljs-keyword">finally</span> &#123;<br>          ErrorContext.instance().reset();<br>        &#125;<br>        <span class="hljs-keyword">if</span> (LOGGER.isDebugEnabled()) &#123;<br>          LOGGER.debug(<span class="hljs-string">&quot;Parsed mapper file: &#x27;&quot;</span> + mapperLocation + <span class="hljs-string">&quot;&#x27;&quot;</span>);<br>        &#125;<br>      &#125;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-keyword">if</span> (LOGGER.isDebugEnabled()) &#123;<br>        LOGGER.debug(<span class="hljs-string">&quot;Property &#x27;mapperLocations&#x27; was not specified or no matching resources found&quot;</span>);<br>      &#125;<br>    &#125;<br>    <span class="hljs-comment">//最终使用sqlSessionFactoryBuilder创建sqlSessionFactory</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.sqlSessionFactoryBuilder.build(configuration);<br>  &#125;<br></code></pre></td></tr></table></div></figure><p>最后一句</p><figure class="highlight java"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-o86yb2lhkez7dw"></i><span>java</span><div class="collapse show" id="collapse-o86yb2lhkez7dw"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.sqlSessionFactoryBuilder.build(configuration);<br></code></pre></td></tr></table></div></figure><p>是不是又回到了熟悉的地方。</p><h2 id="2-MapperScannerConfigurer"><a href="#2-MapperScannerConfigurer" class="headerlink" title="2.MapperScannerConfigurer"></a>2.MapperScannerConfigurer</h2><p>(1) UML<br><img src="https://img-blog.csdnimg.cn/20210324140422191.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2tlemFkZQ==,size_16,color_FFFFFF,t_70"><br>(2) 配置和源码解析<br>这里我们主要关注这个接口：BeanDefinitionRegistryPostProcessor<br>MapperScannerConfigurer实现了BeanDefinitionRegistryPostProcessor接口，BeanDefinitionRegistryPostProcessor接口是一个可以修改spring工厂中已定义的bean的接口，该接口有个postProcessBeanDefinitionRegistry方法。</p><figure class="highlight java"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-tk2fn4lhkez7dw"></i><span>java</span><div class="collapse show" id="collapse-tk2fn4lhkez7dw"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">postProcessBeanDefinitionRegistry</span><span class="hljs-params">(BeanDefinitionRegistry registry)</span> &#123;<br>  <span class="hljs-comment">//占位符处理</span><br>  <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.processPropertyPlaceHolders) &#123;<br>    processPropertyPlaceHolders();<br>  &#125;<br>  <span class="hljs-comment">//实例化ClassPathMapperScanner，并对scanner相关属性进行配置</span><br>  <span class="hljs-type">ClassPathMapperScanner</span> <span class="hljs-variable">scanner</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ClassPathMapperScanner</span>(registry);<br>  scanner.setAddToConfig(<span class="hljs-built_in">this</span>.addToConfig);<br>  scanner.setAnnotationClass(<span class="hljs-built_in">this</span>.annotationClass);<br>  scanner.setMarkerInterface(<span class="hljs-built_in">this</span>.markerInterface);<br>  scanner.setSqlSessionFactory(<span class="hljs-built_in">this</span>.sqlSessionFactory);<br>  scanner.setSqlSessionTemplate(<span class="hljs-built_in">this</span>.sqlSessionTemplate);<br>  scanner.setSqlSessionFactoryBeanName(<span class="hljs-built_in">this</span>.sqlSessionFactoryBeanName);<br>  scanner.setSqlSessionTemplateBeanName(<span class="hljs-built_in">this</span>.sqlSessionTemplateBeanName);<br>  scanner.setResourceLoader(<span class="hljs-built_in">this</span>.applicationContext);<br>  scanner.setBeanNameGenerator(<span class="hljs-built_in">this</span>.nameGenerator);<br>  <span class="hljs-comment">//根据上述配置，生成过滤器，只扫描合条件的class</span><br>  scanner.registerFilters();<br>  <span class="hljs-comment">//扫描指定的包以及其子包</span><br>  scanner.scan(StringUtils.tokenizeToStringArray(<span class="hljs-built_in">this</span>.basePackage, ConfigurableApplicationContext.CONFIG_LOCATION_DELIMITERS));<br>&#125;<br></code></pre></td></tr></table></div></figure><p>点进去，看看ClassPathMapperScanner.scan()方法：</p><figure class="highlight java"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-yu8j9elhkez7dw"></i><span>java</span><div class="collapse show" id="collapse-yu8j9elhkez7dw"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Calls the parent search that will search and register all the candidates.</span><br><span class="hljs-comment"> * Then the registered objects are post processed to set them as</span><br><span class="hljs-comment"> * MapperFactoryBeans</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> Set&lt;BeanDefinitionHolder&gt; <span class="hljs-title function_">doScan</span><span class="hljs-params">(String... basePackages)</span> &#123;<br>    <span class="hljs-comment">//通过父类ClassPathBeanDefinitionScanner的扫描，获取所有复合条件的BeanDefinitionHolder对象</span><br>    Set&lt;BeanDefinitionHolder&gt; beanDefinitions = <span class="hljs-built_in">super</span>.doScan(basePackages);<br>    <span class="hljs-keyword">if</span> (beanDefinitions.isEmpty()) &#123;<br>        logger.warn(<span class="hljs-string">&quot;No MyBatis mapper was found in &#x27;&quot;</span> + Arrays.toString(basePackages) + <span class="hljs-string">&quot;&#x27; package. Please check your configuration.&quot;</span>);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-comment">//处理扫描得到的BeanDefinitionHolder集合，将集合中的每一个mapper接口转换成MapperFactoryBean后，注册至spring容器</span><br>        processBeanDefinitions(beanDefinitions);<br>    &#125;<br>    <span class="hljs-keyword">return</span> beanDefinitions;<br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 处理扫描得到的BeanDefinitionHolder集合，将集合中的每一个mapper接口转换成MapperFactoryBean后，注册至spring容器</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> beanDefinitions</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">processBeanDefinitions</span><span class="hljs-params">(Set&lt;BeanDefinitionHolder&gt; beanDefinitions)</span> &#123;<br>    GenericBeanDefinition definition;<br>    <span class="hljs-comment">//遍历集合</span><br>    <span class="hljs-keyword">for</span> (BeanDefinitionHolder holder : beanDefinitions) &#123;<br>        definition = (GenericBeanDefinition) holder.getBeanDefinition();<br>        <span class="hljs-keyword">if</span> (logger.isDebugEnabled()) &#123;<br>            logger.debug(<span class="hljs-string">&quot;Creating MapperFactoryBean with name &#x27;&quot;</span> + holder.getBeanName()<br>                    + <span class="hljs-string">&quot;&#x27; and &#x27;&quot;</span> + definition.getBeanClassName() + <span class="hljs-string">&quot;&#x27; mapperInterface&quot;</span>);<br>        &#125;<br>        <span class="hljs-comment">// the mapper interface is the original class of the bean</span><br>        <span class="hljs-comment">// but, the actual class of the bean is MapperFactoryBean</span><br>        <span class="hljs-comment">//增加一个构造方法，接口类型作为构造函数的入参</span><br>        definition.getConstructorArgumentValues().addGenericArgumentValue(definition.getBeanClassName());<br>        <span class="hljs-comment">//将bean的类型转换成mapperFactoryBean</span><br>        definition.setBeanClass(<span class="hljs-built_in">this</span>.mapperFactoryBean.getClass());<br>        <span class="hljs-comment">//增加addToConfig属性</span><br>        definition.getPropertyValues().add(<span class="hljs-string">&quot;addToConfig&quot;</span>, <span class="hljs-built_in">this</span>.addToConfig);<br>        <span class="hljs-type">boolean</span> <span class="hljs-variable">explicitFactoryUsed</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;<br>        <span class="hljs-comment">//增加sqlSessionFactory属性</span><br>        <span class="hljs-keyword">if</span> (StringUtils.hasText(<span class="hljs-built_in">this</span>.sqlSessionFactoryBeanName)) &#123;<br>            definition.getPropertyValues().add(<span class="hljs-string">&quot;sqlSessionFactory&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeBeanReference</span>(<span class="hljs-built_in">this</span>.sqlSessionFactoryBeanName));<br>            explicitFactoryUsed = <span class="hljs-literal">true</span>;<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.sqlSessionFactory != <span class="hljs-literal">null</span>) &#123;<br>            definition.getPropertyValues().add(<span class="hljs-string">&quot;sqlSessionFactory&quot;</span>, <span class="hljs-built_in">this</span>.sqlSessionFactory);<br>            explicitFactoryUsed = <span class="hljs-literal">true</span>;<br>        &#125;<br>        <span class="hljs-comment">//增加sqlSessionTemplate属性</span><br>        <span class="hljs-keyword">if</span> (StringUtils.hasText(<span class="hljs-built_in">this</span>.sqlSessionTemplateBeanName)) &#123;<br>            <span class="hljs-keyword">if</span> (explicitFactoryUsed) &#123;<br>                logger.warn(<span class="hljs-string">&quot;Cannot use both: sqlSessionTemplate and sqlSessionFactory together. sqlSessionFactory is ignored.&quot;</span>);<br>            &#125;<br>            definition.getPropertyValues().add(<span class="hljs-string">&quot;sqlSessionTemplate&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeBeanReference</span>(<span class="hljs-built_in">this</span>.sqlSessionTemplateBeanName));<br>            explicitFactoryUsed = <span class="hljs-literal">true</span>;<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.sqlSessionTemplate != <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">if</span> (explicitFactoryUsed) &#123;<br>                logger.warn(<span class="hljs-string">&quot;Cannot use both: sqlSessionTemplate and sqlSessionFactory together. sqlSessionFactory is ignored.&quot;</span>);<br>            &#125;<br>            definition.getPropertyValues().add(<span class="hljs-string">&quot;sqlSessionTemplate&quot;</span>, <span class="hljs-built_in">this</span>.sqlSessionTemplate);<br>            explicitFactoryUsed = <span class="hljs-literal">true</span>;<br>        &#125;<br>        <span class="hljs-comment">//修改自动注入的方式 bytype</span><br>        <span class="hljs-keyword">if</span> (!explicitFactoryUsed) &#123;<br>            <span class="hljs-keyword">if</span> (logger.isDebugEnabled()) &#123;<br>                logger.debug(<span class="hljs-string">&quot;Enabling autowire by type for MapperFactoryBean with name &#x27;&quot;</span> + holder.getBeanName() + <span class="hljs-string">&quot;&#x27;.&quot;</span>);<br>            &#125;<br>            definition.setAutowireMode(AbstractBeanDefinition.AUTOWIRE_BY_TYPE);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></div></figure><p>注释已经写得很清楚了，这里再看看MapperFactoryBean.<br><img src="https://img-blog.csdnimg.cn/20210324144607379.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2tlemFkZQ==,size_16,color_FFFFFF,t_70"><br>其继承了SqlSessionDaoSupport类，SqlSessionDaoSupport类继承DaoSupport抽象类，DaoSupport抽象类实现了InitializingBean接口，因此实例一个MapperFactoryBean的时候，都会调用InitializingBean接口的afterPropertiesSet方法。而MapperFactoryBean也重写了：</p><figure class="highlight java"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-ht5x2vlhkez7dw"></i><span>java</span><div class="collapse show" id="collapse-ht5x2vlhkez7dw"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * MapperFactoryBean在容器初始化时，要确保mapper接口被注册到mapperRegistry</span><br><span class="hljs-comment"> * &#123;<span class="hljs-doctag">@inheritDoc</span>&#125;</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">checkDaoConfig</span><span class="hljs-params">()</span> &#123;<br>  <span class="hljs-built_in">super</span>.checkDaoConfig();<br>  notNull(<span class="hljs-built_in">this</span>.mapperInterface, <span class="hljs-string">&quot;Property &#x27;mapperInterface&#x27; is required&quot;</span>);<br>  <span class="hljs-comment">//通过SqlSession从容器中拿到configuration</span><br>  <span class="hljs-type">Configuration</span> <span class="hljs-variable">configuration</span> <span class="hljs-operator">=</span> getSqlSession().getConfiguration();<br>  <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.addToConfig &amp;&amp; !configuration.hasMapper(<span class="hljs-built_in">this</span>.mapperInterface)) &#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>  <span class="hljs-comment">//如果mapperRegistry中不包含当前接口的动态代理工厂，则添加一个</span><br>      configuration.addMapper(<span class="hljs-built_in">this</span>.mapperInterface);<br>    &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>      logger.error(<span class="hljs-string">&quot;Error while adding the mapper &#x27;&quot;</span> + <span class="hljs-built_in">this</span>.mapperInterface + <span class="hljs-string">&quot;&#x27; to configuration.&quot;</span>, e);<br>      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(e);<br>    &#125; <span class="hljs-keyword">finally</span> &#123;<br>      ErrorContext.instance().reset();<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></div></figure><p>看到configuration.addMapper()方法，是不是又想起了configuration熟悉的味道了。</p><p>MapperScannerConfigurer在Spring配置文件中的应用如下：</p><figure class="highlight xml"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-1kwvhrlhkez7dw"></i><span>xml</span><div class="collapse show" id="collapse-1kwvhrlhkez7dw"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!-- DAO接口所在包名，Spring会自动查找其下的类 --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;org.mybatis.spring.mapper.MapperScannerConfigurer&quot;</span>&gt;</span><br><span class="hljs-comment">&lt;!-- 可以使用分号或逗号作为分隔符设置多于一个的包路径 --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;basePackage&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;com.enjoylearning.mybatis.mapper&quot;</span> /&gt;</span><br><span class="hljs-comment">&lt;!-- optional unless there are multiple session factories defined --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;sqlSessionFactoryBeanName&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;sqlSessionFactory&quot;</span> /&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span><br></code></pre></td></tr></table></div></figure><p>作用很简单，扫描特定目录下的所有mapper.java，生成MapperFactoryBean，然后创建动态代理工厂类MapperProxyFactory，并注册至mapperRegistry当中。使用时依赖注入即可。<br>当然，如果只有一个mapper，我们也可以这样配置：</p><figure class="highlight xml"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-8jtm0dlhkez7dw"></i><span>xml</span><div class="collapse show" id="collapse-8jtm0dlhkez7dw"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;tUserMapper&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;org.mybatis.spring.mapper.MapperFactoryBean&quot;</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;mapperInterface&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;com.enjoylearning.mybatis.mapper.TUserMapper&quot;</span> /&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;sqlSessionFactory&quot;</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">&quot;sqlSessionFactory&quot;</span> /&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span><br></code></pre></td></tr></table></div></figure><p>但是，一般项目中mapper肯定不止一个，一旦新增了一个新的mapper，我们就需要配置很多个这样子的bean，MapperScannerConfigurer帮我们解决了这样的问题。</p><p>sqlSessionFactoryBeanName非必填，但是如果是多数据源的环境，就必须配置好。注意 bean 的<strong>名称name</strong>是<strong>必须</strong>的,而不是 bean 的引用,因此,value 属性在这里替代通常的ref。</p>]]></content>
    
    
    <categories>
      
      <category>MyBatis源码学习</category>
      
    </categories>
    
    
    <tags>
      
      <tag>MyBatis</tag>
      
      <tag>源码</tag>
      
      <tag>Spring</tag>
      
      <tag>Spring Boot</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>【MyBatis源码学习】MyBatis与Spring整合</title>
    <link href="/posts/844544627.html"/>
    <url>/posts/844544627.html</url>
    
    <content type="html"><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>目前大部分项目中运用MyBatis均与Spring有关，尤其是Spring Boot大行其道，普通程序员基本上可以无缝的完成一个简单的CRUD项目。通过前面对于MyBatis 源码的学习，我已经对其了（一）如（脸）指（懵）掌（逼），本章我们来玩玩MyBatis与Spring的结合以及它们的融合原理。</p><h1 id="一、什么是Mybatis-Spring"><a href="#一、什么是Mybatis-Spring" class="headerlink" title="一、什么是Mybatis-Spring"></a>一、什么是Mybatis-Spring</h1><p>一句话：将 MyBatis 代码无缝地整合到 Spring 中。集成过程中的增强处理主要体现在以下几个方面：</p><ul><li>Spring 将会加载必要的 MyBatis 工厂类和 session 类</li><li>提供一个简单的方式来注入 MyBatis 数据映射器和 SqlSession 到业务层的 bean 中</li><li>方便集成Spring事务</li><li>翻译 MyBatis 的异常到 Spring 的 DataAccessException 异常(数据访问异常)中</li></ul><h1 id="二、关键配置类"><a href="#二、关键配置类" class="headerlink" title="二、关键配置类"></a>二、关键配置类</h1><h2 id="1-SqlSessionFactoryBean"><a href="#1-SqlSessionFactoryBean" class="headerlink" title="1.SqlSessionFactoryBean"></a>1.SqlSessionFactoryBean</h2><p>SqlSessionFactoryBean作用：用于创建SqlSessionFactory。关键参数有：</p><ul><li>dataSource ：<strong>必填</strong>。用于配置数据源，必须通过这个属性配置数据源。</li><li>mapperLocations ： 配置 SqlSessionFactoryBean 扫描*<strong>mapper.xml</strong>映射文件的路径。</li><li>configLocation ：用于配置<strong>mybatis-config.xml</strong>的路径，除了数据源外，对MyBatis的各种配直仍然可以通过这种方式进行，并且配置MyBatis settings 时只能使用这种方式。但配置文件中任意环境,数据源和 MyBatis 的事务管理器都会被忽略；</li><li>typeAliasesPackage ： 配置包中类的别名，配置后，包中的类在 XML 映射文件中使用时可以省略包名部分，直接使用类名。这个配置不支持Ant风格的路径，当需要配置多个包路径时可以使用分号或逗号进行分隔.</li></ul><h2 id="2-MapperScannerConfigurer"><a href="#2-MapperScannerConfigurer" class="headerlink" title="2.MapperScannerConfigurer"></a>2.MapperScannerConfigurer</h2><p>作用：自动扫描所有的 Mapper 接口，使用时可以直接注入接口。<br>关键参数：</p><ul><li>basePackage ：用于配置基本的包路径。可以使用分号或逗号作为分隔符设置多于一个的包路径，每个映射器将会在指定的包路径中递归地被搜索到 。</li><li>annotationClass ：用于过滤被扫描的接口，如果设置了该属性，那么 MyBatis 的接口只有包含该注解才会被扫描进去。</li></ul><h1 id="三、MyBatis与Spring融合实战"><a href="#三、MyBatis与Spring融合实战" class="headerlink" title="三、MyBatis与Spring融合实战"></a>三、MyBatis与Spring融合实战</h1><h2 id="1-依赖"><a href="#1-依赖" class="headerlink" title="1.依赖"></a>1.依赖</h2><figure class="highlight xml"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-33jlu8lhkez7dw"></i><span>xml</span><div class="collapse show" id="collapse-33jlu8lhkez7dw"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!-- https://mvnrepository.com/artifact/mysql/mysql-connector-java --&gt;</span><br>       <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>mysql<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mysql-connector-java<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>5.1.42<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>       <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br>       <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.mybatis<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mybatis<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.5.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>       <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>       <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.mybatis<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mybatis-spring<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.3.3<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>       <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br><span class="hljs-comment">&lt;!-- 数据库连接池 --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.alibaba<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>druid<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.0.20<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br>       <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-core<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>$&#123;spring.version&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>       <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>       <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-context<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>$&#123;spring.version&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>       <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>       <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-beans<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>$&#123;spring.version&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>       <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>       <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-jdbc<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>$&#123;spring.version&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>       <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>       <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-test<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>$&#123;spring.version&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>       <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></div></figure><p>其中spring.version为4.3.3.RELEASE。</p><h2 id="2-Spring配置文件"><a href="#2-Spring配置文件" class="headerlink" title="2.Spring配置文件"></a>2.Spring配置文件</h2><p>本项目中的spring配置文件名为applicationContext.xml，主要用于配置：</p><ul><li>数据源</li><li>sqlSessionFactory</li><li>MapperScannerConfigurer</li></ul><figure class="highlight xml"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-6cj1rklhkez7dw"></i><span>xml</span><div class="collapse show" id="collapse-6cj1rklhkez7dw"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">context:property-placeholder</span> <span class="hljs-attr">location</span>=<span class="hljs-string">&quot;classpath:db.properties&quot;</span> <span class="hljs-attr">ignore-unresolvable</span>=<span class="hljs-string">&quot;true&quot;</span> /&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">context:component-scan</span> <span class="hljs-attr">base-package</span>=<span class="hljs-string">&quot;com.*&quot;</span>/&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;dataSource&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;com.alibaba.druid.pool.DruidDataSource&quot;</span> <span class="hljs-attr">init-method</span>=<span class="hljs-string">&quot;init&quot;</span> <span class="hljs-attr">destroy-method</span>=<span class="hljs-string">&quot;close&quot;</span>&gt;</span><br><span class="hljs-comment">&lt;!-- 基本属性 url、user、password --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;driverClassName&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;$&#123;jdbc_driver&#125;&quot;</span> /&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;url&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;$&#123;jdbc_url&#125;&quot;</span> /&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;username&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;$&#123;jdbc_username&#125;&quot;</span> /&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;password&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;$&#123;jdbc_password&#125;&quot;</span> /&gt;</span><br><span class="hljs-comment">&lt;!-- 配置初始化大小、最小、最大 --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;initialSize&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;1&quot;</span> /&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;minIdle&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;1&quot;</span> /&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;maxActive&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;20&quot;</span> /&gt;</span><br><span class="hljs-comment">&lt;!-- 配置获取连接等待超时的时间 --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;maxWait&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;60000&quot;</span> /&gt;</span><br><span class="hljs-comment">&lt;!-- 配置间隔多久才进行一次检测，检测需要关闭的空闲连接，单位是毫秒 --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;timeBetweenEvictionRunsMillis&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;60000&quot;</span> /&gt;</span><br><span class="hljs-comment">&lt;!-- 配置一个连接在池中最小生存的时间，单位是毫秒 --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;minEvictableIdleTimeMillis&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;300000&quot;</span> /&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;validationQuery&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;SELECT &#x27;x&#x27;&quot;</span> /&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;testWhileIdle&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;true&quot;</span> /&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;testOnBorrow&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;false&quot;</span> /&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;testOnReturn&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;false&quot;</span> /&gt;</span><br><span class="hljs-comment">&lt;!-- 打开PSCache，并且指定每个连接上PSCache的大小 --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;poolPreparedStatements&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;true&quot;</span> /&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;maxPoolPreparedStatementPerConnectionSize&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;20&quot;</span> /&gt;</span><br><span class="hljs-comment">&lt;!-- 配置监控统计拦截的filters --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;filters&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;stat&quot;</span> /&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span><br><br><span class="hljs-comment">&lt;!-- spring和MyBatis完美整合，不需要mybatis的配置映射文件 --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;sqlSessionFactory&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;org.mybatis.spring.SqlSessionFactoryBean&quot;</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;dataSource&quot;</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">&quot;dataSource&quot;</span> /&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;typeAliasesPackage&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;com.enjoylearning.mybatis.entity&quot;</span> /&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;mapperLocations&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;classpath:sqlmapper/*.xml&quot;</span> /&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span><br><br><span class="hljs-comment">&lt;!-- DAO接口所在包名，Spring会自动查找其下的类 --&gt;</span><br> <span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;org.mybatis.spring.mapper.MapperScannerConfigurer&quot;</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;basePackage&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;com.enjoylearning.mybatis.mapper&quot;</span> /&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span><br><br><span class="hljs-comment">&lt;!-- (事务管理)transaction manager --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;transactionManager&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;org.springframework.jdbc.datasource.DataSourceTransactionManager&quot;</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;dataSource&quot;</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">&quot;dataSource&quot;</span> /&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">qualifier</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;transactionManager&quot;</span> /&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span><br><br><span class="hljs-tag">&lt;<span class="hljs-name">tx:annotation-driven</span> <span class="hljs-attr">transaction-manager</span>=<span class="hljs-string">&quot;transactionManager&quot;</span> /&gt;</span><br></code></pre></td></tr></table></div></figure><h2 id="3-Mybatis配置文件"><a href="#3-Mybatis配置文件" class="headerlink" title="3.Mybatis配置文件"></a>3.Mybatis配置文件</h2><p>文件名为mybatis-config.xml，注意该文件除了settings必须配置在里面外，其他都可以在spring配置文件中配置。</p><figure class="highlight xml"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-n4zjixlhkez7dw"></i><span>xml</span><div class="collapse show" id="collapse-n4zjixlhkez7dw"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">settings</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">setting</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;mapUnderscoreToCamelCase&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;true&quot;</span> /&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">settings</span>&gt;</span><br><br><span class="hljs-comment">&lt;!-- 别名定义 --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">typeAliases</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">package</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;com.enjoylearning.mybatis.entity&quot;</span>/&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">typeAliases</span>&gt;</span><br></code></pre></td></tr></table></div></figure><h2 id="4-mapper"><a href="#4-mapper" class="headerlink" title="4.mapper"></a>4.mapper</h2><p>还是以UserInfoMapper.xml为例，文件内容如下：</p><figure class="highlight xml"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-klxjq2lhkez7dw"></i><span>xml</span><div class="collapse show" id="collapse-klxjq2lhkez7dw"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span> ?&gt;</span><br><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">mapper</span> <span class="hljs-keyword">PUBLIC</span> <span class="hljs-string">&quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span> <span class="hljs-string">&quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;</span> &gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">mapper</span> <span class="hljs-attr">namespace</span>=<span class="hljs-string">&quot;com.enjoylearning.mybatis.mapper.UserInfoMapper&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">resultMap</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;BaseResultMap&quot;</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;com.enjoylearning.mybatis.entity.UserInfo&quot;</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">id</span> <span class="hljs-attr">column</span>=<span class="hljs-string">&quot;id&quot;</span> <span class="hljs-attr">property</span>=<span class="hljs-string">&quot;id&quot;</span> <span class="hljs-attr">jdbcType</span>=<span class="hljs-string">&quot;VARCHAR&quot;</span>/&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">result</span> <span class="hljs-attr">column</span>=<span class="hljs-string">&quot;username&quot;</span> <span class="hljs-attr">property</span>=<span class="hljs-string">&quot;username&quot;</span> <span class="hljs-attr">jdbcType</span>=<span class="hljs-string">&quot;VARCHAR&quot;</span>/&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">result</span> <span class="hljs-attr">column</span>=<span class="hljs-string">&quot;password&quot;</span> <span class="hljs-attr">property</span>=<span class="hljs-string">&quot;password&quot;</span> <span class="hljs-attr">jdbcType</span>=<span class="hljs-string">&quot;VARCHAR&quot;</span>/&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">result</span> <span class="hljs-attr">column</span>=<span class="hljs-string">&quot;openid&quot;</span> <span class="hljs-attr">property</span>=<span class="hljs-string">&quot;openid&quot;</span> <span class="hljs-attr">jdbcType</span>=<span class="hljs-string">&quot;VARCHAR&quot;</span>/&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">result</span> <span class="hljs-attr">column</span>=<span class="hljs-string">&quot;role&quot;</span> <span class="hljs-attr">property</span>=<span class="hljs-string">&quot;role&quot;</span> <span class="hljs-attr">jdbcType</span>=<span class="hljs-string">&quot;BIT&quot;</span>/&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">result</span> <span class="hljs-attr">column</span>=<span class="hljs-string">&quot;create_time&quot;</span> <span class="hljs-attr">property</span>=<span class="hljs-string">&quot;createTime&quot;</span> <span class="hljs-attr">jdbcType</span>=<span class="hljs-string">&quot;TIMESTAMP&quot;</span>/&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">result</span> <span class="hljs-attr">column</span>=<span class="hljs-string">&quot;update_time&quot;</span> <span class="hljs-attr">property</span>=<span class="hljs-string">&quot;updateTime&quot;</span> <span class="hljs-attr">jdbcType</span>=<span class="hljs-string">&quot;TIMESTAMP&quot;</span>/&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">resultMap</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">sql</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;Base_Column_List&quot;</span>&gt;</span><br>        id, username, password, openid, role, create_time, update_time<br>    <span class="hljs-tag">&lt;/<span class="hljs-name">sql</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">select</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;selectByPrimaryKey&quot;</span> <span class="hljs-attr">resultMap</span>=<span class="hljs-string">&quot;BaseResultMap&quot;</span> <span class="hljs-attr">parameterType</span>=<span class="hljs-string">&quot;java.lang.String&quot;</span>&gt;</span><br>        select<br>        <span class="hljs-tag">&lt;<span class="hljs-name">include</span> <span class="hljs-attr">refid</span>=<span class="hljs-string">&quot;Base_Column_List&quot;</span>/&gt;</span><br>        from user_info<br>        where id = #&#123;id,jdbcType=VARCHAR&#125;<br>    <span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">mapper</span>&gt;</span><br></code></pre></td></tr></table></div></figure><p>对应dao：</p><figure class="highlight java"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-paaowtlhkez7dw"></i><span>java</span><div class="collapse show" id="collapse-paaowtlhkez7dw"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">UserInfoMapper</span> &#123;<br>    UserInfo <span class="hljs-title function_">selectByPrimaryKey</span><span class="hljs-params">(String id)</span>;<br>&#125;<br></code></pre></td></tr></table></div></figure><p>po:</p><figure class="highlight java"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-y018d9lhkez7dw"></i><span>java</span><div class="collapse show" id="collapse-y018d9lhkez7dw"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserInfo</span> &#123;<br>    <span class="hljs-keyword">private</span> String id;<br>    <span class="hljs-keyword">private</span> String username;<br>    <span class="hljs-keyword">private</span> String password;<br>    <span class="hljs-keyword">private</span> String openid;<br>    <span class="hljs-keyword">private</span> Boolean role;<br>    <span class="hljs-keyword">private</span> Date createTime;<br>    <span class="hljs-keyword">private</span> Date updateTime;<br><span class="hljs-comment">//省略getter、setter</span><br>&#125;<br></code></pre></td></tr></table></div></figure><h2 id="5-测试类"><a href="#5-测试类" class="headerlink" title="5.测试类"></a>5.测试类</h2><figure class="highlight java"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-rt2nejlhkez7dw"></i><span>java</span><div class="collapse show" id="collapse-rt2nejlhkez7dw"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RunWith(SpringJUnit4ClassRunner.class)</span><br><span class="hljs-meta">@ContextConfiguration(&quot;classpath:applicationContext.xml&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MybatisSpringTest</span> &#123;<br><span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> UserInfoMapper userInfoMapper;<br><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">test_selectByPrimaryKey</span><span class="hljs-params">()</span> &#123;<br>        UserInfo userInfo= userInfoMapper.selectByPrimaryKey(<span class="hljs-number">1</span>);<br>        System.out.println(userInfo.toString());<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></div></figure><h1 id="四、Mybatis与SpringBoot融合实战"><a href="#四、Mybatis与SpringBoot融合实战" class="headerlink" title="四、Mybatis与SpringBoot融合实战"></a>四、Mybatis与SpringBoot融合实战</h1><h2 id="1-依赖-1"><a href="#1-依赖-1" class="headerlink" title="1.依赖"></a>1.依赖</h2><figure class="highlight xml"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-qpalgilhkez7dw"></i><span>xml</span><div class="collapse show" id="collapse-qpalgilhkez7dw"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.mybatis.spring.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mybatis-spring-boot-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.0.1<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br><span class="hljs-comment">&lt;!-- mysql驱动 --&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>          <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>mysql<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>          <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mysql-connector-java<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>          <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>5.1.18<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>      <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>      <br><span class="hljs-comment">&lt;!-- 单元测试相关依赖 --&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>          <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>junit<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>          <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>junit<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>          <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>4.12<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>          <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>test<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span><br>      <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br>      <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>          <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.projectlombok<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>          <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>lombok<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>          <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.18.18<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>          <span class="hljs-tag">&lt;<span class="hljs-name">optional</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">optional</span>&gt;</span><br>      <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>      <br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>test<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br></code></pre></td></tr></table></div></figure><h2 id="2-application-yml"><a href="#2-application-yml" class="headerlink" title="2.application.yml"></a>2.application.yml</h2><figure class="highlight yml"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-hz67solhkez7dw"></i><span>yml</span><div class="collapse show" id="collapse-hz67solhkez7dw"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-comment">#DataSource config 配置数据源信息</span><br><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">datasource:</span><br>    <span class="hljs-attr">driver-class-name:</span> <span class="hljs-string">com.mysql.jdbc.Driver</span><br>    <span class="hljs-attr">url:</span> <span class="hljs-string">jdbc:mysql://localhost:3306/springcloudsell?useUnicode=true&amp;characterEncoding=utf-8</span><br>    <span class="hljs-attr">username:</span> <span class="hljs-string">root</span><br>    <span class="hljs-attr">password:</span> <span class="hljs-string">root</span><br><span class="hljs-comment"># 配置MyBatis的配置文件地址和MyBatis的映射文件地址</span><br><span class="hljs-attr">mybatis:</span><br>  <span class="hljs-attr">mapper-locations:</span> <span class="hljs-string">classpath*:sqlmapper/*.xml</span><br>  <span class="hljs-attr">configuration:</span><br>    <span class="hljs-comment"># 关闭二级缓存</span><br>    <span class="hljs-attr">cache-enabled:</span> <span class="hljs-literal">false</span><br>    <span class="hljs-attr">map-underscore-to-camel-case:</span> <span class="hljs-literal">true</span><br><br><span class="hljs-attr">logging:</span><br>  <span class="hljs-attr">level:</span><br>    <span class="hljs-attr">root:</span> <span class="hljs-string">info</span><br>    <span class="hljs-attr">org.springframework.web:</span> <span class="hljs-string">info</span><br>    <span class="hljs-comment">#    打印sql</span><br>    <span class="hljs-attr">com.enjoylearning.mybatis.mapper:</span> <span class="hljs-string">DEBUG</span><br><span class="hljs-attr">server:</span><br>  <span class="hljs-attr">port:</span> <span class="hljs-number">8081</span><br></code></pre></td></tr></table></div></figure><h2 id="3-启动类"><a href="#3-启动类" class="headerlink" title="3.启动类"></a>3.启动类</h2><p>为了不用在每个mapper.java中添加@Mapper注解，可以统一在启动类加上@MapperScan注解。</p><figure class="highlight java"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-jjqucblhkez7dw"></i><span>java</span><div class="collapse show" id="collapse-jjqucblhkez7dw"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@SpringBootApplication</span><br><span class="hljs-meta">@MapperScan(basePackages = &quot;com.enjoylearning.mybatis.dao&quot;)</span><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MybatisSpringbootDemoApplication</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        log.info(<span class="hljs-string">&quot;------------------MybatisSpringbootDemoApplication-----------start &quot;</span>);<br>        SpringApplication.run(MybatisSpringbootDemoApplication.class, args);<br>        log.info(<span class="hljs-string">&quot;------------------MybatisSpringbootDemoApplication------------end &quot;</span>);<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></div></figure><h2 id="4-测试类"><a href="#4-测试类" class="headerlink" title="4.测试类"></a>4.测试类</h2><figure class="highlight java"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-egvchhlhkez7dw"></i><span>java</span><div class="collapse show" id="collapse-egvchhlhkez7dw"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RunWith(SpringRunner.class)</span><br><span class="hljs-meta">@SpringBootTest(classes = MybatisSpringbootDemoApplication.class)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">StudentMapperTest</span>&#123;<br><span class="hljs-meta">@Autowired</span><br><span class="hljs-keyword">private</span> UserInfoMapper userInfoMapper;<br><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">selectStudentById</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>    <span class="hljs-type">UserInfo</span> <span class="hljs-variable">userInfo</span> <span class="hljs-operator">=</span> userInfoMapper.selectByPrimaryKey(<span class="hljs-string">&quot;1&quot;</span>);<br>    System.out.println(<span class="hljs-string">&quot;----&gt;查询结果为=&#123;&#125;&quot;</span> + userInfo);<br>&#125;<br>&#125;<br></code></pre></td></tr></table></div></figure>]]></content>
    
    
    <categories>
      
      <category>MyBatis源码学习</category>
      
    </categories>
    
    
    <tags>
      
      <tag>MyBatis</tag>
      
      <tag>源码</tag>
      
      <tag>Spring</tag>
      
      <tag>Spring Boot</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>【MyBatis源码学习】Sql执行</title>
    <link href="/posts/1202875916.html"/>
    <url>/posts/1202875916.html</url>
    
    <content type="html"><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>上一篇<a href="https://zyxelva.github.io/posts/3395965495.html">【MyBatis源码学习】Sql解析</a>中，我主要梳理了sql的源码解析过程，本章我通过同样的一个例子，来仔细瞧瞧sql是怎样执行下来的。主要分为三个步骤：</p><ul><li>动态代理生成mapper</li><li>sql执行</li><li>结果集处理</li></ul><p>还是通过同样的例子来开始本章的源码sql执行过程跟踪。</p><figure class="highlight java"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-ej1lnnlhkez7dw"></i><span>java</span><div class="collapse show" id="collapse-ej1lnnlhkez7dw"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Test</span><br><span class="hljs-comment">// 程序员喜欢的风格</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">quickStart</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>    <span class="hljs-comment">// 2.获取sqlSession</span><br>    <span class="hljs-type">SqlSession</span> <span class="hljs-variable">sqlSession</span> <span class="hljs-operator">=</span> sqlSessionFactory.openSession();<br>    <span class="hljs-comment">// 3.获取对应mapper</span><br>    <span class="hljs-type">TUserMapper</span> <span class="hljs-variable">mapper</span> <span class="hljs-operator">=</span> sqlSession.getMapper(TUserMapper.class);<br>    <span class="hljs-comment">// 4.执行查询语句并返回单条数据</span><br>    <span class="hljs-type">TUser</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> mapper.selectByPrimaryKey(<span class="hljs-number">2</span>);<br>    System.out.println(user);<br>&#125;<br><br></code></pre></td></tr></table></div></figure><h1 id="一、动态代理生成mapper"><a href="#一、动态代理生成mapper" class="headerlink" title="一、动态代理生成mapper"></a>一、动态代理生成mapper</h1><p>我们直接从这句开始跟下源码：</p><figure class="highlight java"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-opxu6qlhkez7dw"></i><span>java</span><div class="collapse show" id="collapse-opxu6qlhkez7dw"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">TUserMapper</span> <span class="hljs-variable">mapper</span> <span class="hljs-operator">=</span> sqlSession.getMapper(TUserMapper.class);<br></code></pre></td></tr></table></div></figure><p>断点调式开始<br><img src="https://img-blog.csdnimg.cn/20210322102317495.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2tlemFkZQ==,size_16,color_FFFFFF,t_70"><br>我们看到SqlSession实例是DefaultSqlSession，点进去看看getMapper:<br><img src="https://img-blog.csdnimg.cn/20210322102447860.png"><br>进入的是“大管家”Configuration的getMapper.<br><img src="https://img-blog.csdnimg.cn/20210322102558173.png"></p><p>而真正给出接口代理类的是MapperRegistry.<img src="https://img-blog.csdnimg.cn/20210322102754132.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2tlemFkZQ==,size_16,color_FFFFFF,t_70"><br>点进去看看mapperProxyFactory.newInstance(sqlSession)具体生成实例的代码：</p><figure class="highlight java"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-i7dnfzlhkez7dw"></i><span>java</span><div class="collapse show" id="collapse-i7dnfzlhkez7dw"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// MapperProxyFactory</span><br><span class="hljs-comment">// 生成一个 MapperProxy对象</span><br>  <span class="hljs-meta">@SuppressWarnings(&quot;unchecked&quot;)</span><br>  <span class="hljs-keyword">protected</span> T <span class="hljs-title function_">newInstance</span><span class="hljs-params">(MapperProxy&lt;T&gt; mapperProxy)</span> &#123;<br>    <span class="hljs-keyword">return</span> (T) Proxy.newProxyInstance(mapperInterface.getClassLoader(), <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[] &#123; mapperInterface &#125;, mapperProxy);<br>  &#125;<br><br>  <span class="hljs-keyword">public</span> T <span class="hljs-title function_">newInstance</span><span class="hljs-params">(SqlSession sqlSession)</span> &#123;<br>    <span class="hljs-keyword">final</span> MapperProxy&lt;T&gt; mapperProxy = <span class="hljs-keyword">new</span> <span class="hljs-title class_">MapperProxy</span>&lt;&gt;(sqlSession, mapperInterface, methodCache);<br>    <span class="hljs-keyword">return</span> newInstance(mapperProxy);<br>  &#125;<br></code></pre></td></tr></table></div></figure><p>发现，运用的正是JDK动态代理。<br>梳理下该过程的时序图，如下：<br><img src="https://img-blog.csdnimg.cn/20210322110043730.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2tlemFkZQ==,size_16,color_FFFFFF,t_70"></p><h1 id="二、sql执行"><a href="#二、sql执行" class="headerlink" title="二、sql执行"></a>二、sql执行</h1><p>通过一中的过程，我们可以得到一个接口的mapperProxy动态代理对象了。sql的执行过程就是从MapperProxy的invoke方法开始的。<br><img src="https://img-blog.csdnimg.cn/20210322110414703.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2tlemFkZQ==,size_16,color_FFFFFF,t_70"><br><img src="https://img-blog.csdnimg.cn/20210322110853190.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2tlemFkZQ==,size_16,color_FFFFFF,t_70"><br>先去缓存中看看是否已经有了现成的MapperMethod，没有才回去new一个出来。<br>接下来，调用 MapperMethod 中的execute方法。<br><img src="https://img-blog.csdnimg.cn/20210322111101131.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2tlemFkZQ==,size_16,color_FFFFFF,t_70"><br>本例中，执行的是一个查询语句，进入case SELECT分支</p><figure class="highlight java"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-jp7ee5lhkez7dw"></i><span>java</span><div class="collapse show" id="collapse-jp7ee5lhkez7dw"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs java"><br><span class="hljs-keyword">case</span> SELECT: <span class="hljs-comment">// 如果是查询语句</span><br>        <span class="hljs-keyword">if</span> (method.returnsVoid() &amp;&amp; method.hasResultHandler()) &#123; <span class="hljs-comment">// 返回为void，且有结果处理器</span><br>          <span class="hljs-comment">// 使用结果处理器执行查询</span><br>          executeWithResultHandler(sqlSession, args);<br>          result = <span class="hljs-literal">null</span>;<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (method.returnsMany()) &#123; <span class="hljs-comment">// 多条结果查询</span><br>          result = executeForMany(sqlSession, args);<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (method.returnsMap()) &#123; <span class="hljs-comment">// map结果查询</span><br>          result = executeForMap(sqlSession, args);<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (method.returnsCursor()) &#123; <span class="hljs-comment">// 游标类型结果查询</span><br>          result = executeForCursor(sqlSession, args);<br>        &#125; <span class="hljs-keyword">else</span> &#123; <span class="hljs-comment">// 单条结果查询</span><br>          <span class="hljs-comment">// 将参数顺序与实参对应好</span><br>          <span class="hljs-type">Object</span> <span class="hljs-variable">param</span> <span class="hljs-operator">=</span> method.convertArgsToSqlCommandParam(args);<br>          result = sqlSession.selectOne(command.getName(), param);<br>          <span class="hljs-keyword">if</span> (method.returnsOptional()<br>              &amp;&amp; (result == <span class="hljs-literal">null</span> || !method.getReturnType().equals(result.getClass()))) &#123;<br>            result = Optional.ofNullable(result);<br>          &#125;<br>        &#125;<br>        <span class="hljs-keyword">break</span>;<br></code></pre></td></tr></table></div></figure><p>我们可以看到，根据返回的结果类型，进入不同的处理逻辑，主要有</p><ul><li>返回为void</li><li>返回多条结果</li><li>返回map结果</li><li>返回单条结果</li></ul><p>返回值为空的情况下，直接返回 result &#x3D; null。其余几种情况内部都调用了sqlSession 中的selectList 方法。这里我们以selectOne为例。<br>convertArgsToSqlCommandParam()前面我们在<a href="https://blog.csdn.net/kezade/article/details/114801993">【Mybatis源码学习】参数解析</a>做过说明，主要进行参数的顺序映射解析。这里不做赘述。直接看看DefaultSqlSession.selectOne方法。</p><figure class="highlight java"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-1p3daxlhkez7dw"></i><span>java</span><div class="collapse show" id="collapse-1p3daxlhkez7dw"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> &lt;T&gt; T <span class="hljs-title function_">selectOne</span><span class="hljs-params">(String statement, Object parameter)</span> &#123;<br>    <span class="hljs-comment">// Popular vote was to return null on 0 results and throw exception on too many.</span><br>    List&lt;T&gt; list = <span class="hljs-built_in">this</span>.selectList(statement, parameter);<br>    <span class="hljs-keyword">if</span> (list.size() == <span class="hljs-number">1</span>) &#123;<br>      <span class="hljs-keyword">return</span> list.get(<span class="hljs-number">0</span>);<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (list.size() &gt; <span class="hljs-number">1</span>) &#123;<br>      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TooManyResultsException</span>(<span class="hljs-string">&quot;Expected one result (or null) to be returned by selectOne(), but found: &quot;</span> + list.size());<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br>  &#125;<br></code></pre></td></tr></table></div></figure><p>如果selectList查询返回1条，则直接返回；如果返回多条则抛出异常，否则直接返回null。<br>点进去看看selectList方法。</p><figure class="highlight java"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-k365w3lhkez7dw"></i><span>java</span><div class="collapse show" id="collapse-k365w3lhkez7dw"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 查询结果列表</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> &lt;E&gt; 返回的列表元素的类型</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> statement SQL语句</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> parameter 参数对象</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> rowBounds  翻页限制条件</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@return</span> 结果对象列表</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> &lt;E&gt; List&lt;E&gt; <span class="hljs-title function_">selectList</span><span class="hljs-params">(String statement, Object parameter, RowBounds rowBounds)</span> &#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>      <span class="hljs-comment">// 获取查询语句</span><br>      <span class="hljs-type">MappedStatement</span> <span class="hljs-variable">ms</span> <span class="hljs-operator">=</span> configuration.getMappedStatement(statement);<br>      <span class="hljs-comment">// 交由执行器进行查询</span><br>      <span class="hljs-keyword">return</span> executor.query(ms, wrapCollection(parameter), rowBounds, Executor.NO_RESULT_HANDLER);<br>    &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>      <span class="hljs-keyword">throw</span> ExceptionFactory.wrapException(<span class="hljs-string">&quot;Error querying database.  Cause: &quot;</span> + e, e);<br>    &#125; <span class="hljs-keyword">finally</span> &#123;<br>      ErrorContext.instance().reset();<br>    &#125;<br>  &#125;<br></code></pre></td></tr></table></div></figure><p>这里说明下，mybatis默认是开启了二级缓存的，所以这里executor其实是CachingExecutor.我们可以在创建sqlSession中看看Configuration中创建执行器时的代码：<br><img src="https://img-blog.csdnimg.cn/20210322135551582.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2tlemFkZQ==,size_16,color_FFFFFF,t_70"><br>要关闭二级缓存，我们可以在mybatis-config.xml中显示配置，如下：</p><figure class="highlight xml"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-88oo0mlhkez7dw"></i><span>xml</span><div class="collapse show" id="collapse-88oo0mlhkez7dw"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!-- 二级缓存开关，默认为开启--&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">setting</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;cacheEnabled&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;false&quot;</span>/&gt;</span><br></code></pre></td></tr></table></div></figure><p>关闭二级缓存，我们回到selectList方法中，继续跟下这段代码的执行过程：</p><figure class="highlight java"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-36m4v2lhkez7dw"></i><span>java</span><div class="collapse show" id="collapse-36m4v2lhkez7dw"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">executor.query(ms, wrapCollection(parameter), rowBounds, Executor.NO_RESULT_HANDLER)<br></code></pre></td></tr></table></div></figure><p>executor这里为SimpleExecutor，其首先调用的是BaseExecutor的query方法。<br><img src="https://img-blog.csdnimg.cn/2021032214023869.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2tlemFkZQ==,size_16,color_FFFFFF,t_70"></p><figure class="highlight java"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-yu98ydlhkez7dw"></i><span>java</span><div class="collapse show" id="collapse-yu98ydlhkez7dw"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 查询数据库中的数据</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> ms 映射语句</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> parameter 参数对象</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> rowBounds 翻页限制条件</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> resultHandler 结果处理器</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> key 缓存的键</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> boundSql 查询语句</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> &lt;E&gt; 结果类型</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@return</span> 结果列表</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@throws</span> SQLException</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-meta">@SuppressWarnings(&quot;unchecked&quot;)</span><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> &lt;E&gt; List&lt;E&gt; <span class="hljs-title function_">query</span><span class="hljs-params">(MappedStatement ms, Object parameter, RowBounds rowBounds, ResultHandler resultHandler, CacheKey key, BoundSql boundSql)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>    ErrorContext.instance().resource(ms.getResource()).activity(<span class="hljs-string">&quot;executing a query&quot;</span>).object(ms.getId());<br>    <span class="hljs-keyword">if</span> (closed) &#123;<br>      <span class="hljs-comment">// 执行器已经关闭</span><br>      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ExecutorException</span>(<span class="hljs-string">&quot;Executor was closed.&quot;</span>);<br>    &#125;<br>    <span class="hljs-keyword">if</span> (queryStack == <span class="hljs-number">0</span> &amp;&amp; ms.isFlushCacheRequired()) &#123; <span class="hljs-comment">// 新的查询栈且要求清除缓存</span><br>      <span class="hljs-comment">// 新的查询栈，故清除本地缓存，即清除一级缓存</span><br>      clearLocalCache();<br>    &#125;<br>    List&lt;E&gt; list;<br>    <span class="hljs-keyword">try</span> &#123;<br>      queryStack++;<br>      <span class="hljs-comment">// 尝试从本地缓存获取结果</span><br>      list = resultHandler == <span class="hljs-literal">null</span> ? (List&lt;E&gt;) localCache.getObject(key) : <span class="hljs-literal">null</span>;<br>      <span class="hljs-keyword">if</span> (list != <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-comment">// 本地缓存中有结果，则对于CALLABLE语句还需要绑定到IN/INOUT参数上</span><br>        handleLocallyCachedOutputParameters(ms, key, parameter, boundSql);<br>      &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-comment">// 本地缓存没有结果，故需要查询数据库</span><br>        list = queryFromDatabase(ms, parameter, rowBounds, resultHandler, key, boundSql);<br>      &#125;<br>    &#125; <span class="hljs-keyword">finally</span> &#123;<br>      queryStack--;<br>    &#125;<br>    <span class="hljs-keyword">if</span> (queryStack == <span class="hljs-number">0</span>) &#123;<br>      <span class="hljs-comment">// 懒加载操作的处理</span><br>      <span class="hljs-keyword">for</span> (DeferredLoad deferredLoad : deferredLoads) &#123;<br>        deferredLoad.load();<br>      &#125;<br>      <span class="hljs-comment">// issue #601</span><br>      deferredLoads.clear();<br>      <span class="hljs-comment">// 如果本地缓存的作用域为STATEMENT，则立刻清除本地缓存</span><br>      <span class="hljs-keyword">if</span> (configuration.getLocalCacheScope() == LocalCacheScope.STATEMENT) &#123;<br>        <span class="hljs-comment">// issue #482</span><br>        clearLocalCache();<br>      &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> list;<br>  &#125;<br></code></pre></td></tr></table></div></figure><p>先从一级缓存中查询是否已有结果，没有则才去查询数据库。我们直接看查询数据库的部分，也就是方法queryFromDatabase().<br><img src="https://img-blog.csdnimg.cn/20210322141109713.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2tlemFkZQ==,size_16,color_FFFFFF,t_70"><br>进入doQuery()方法，发现这里是个模版方法，由于前面提到我们此处的执行器为SimpleExecutor，所以这个方法来到了SimpleExecutor的doQuery()方法.</p><p><img src="https://img-blog.csdnimg.cn/20210322141449815.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2tlemFkZQ==,size_16,color_FFFFFF,t_70"><br>如上，该方法主要有三步：</p><ul><li>新建一个StatementHandler</li><li>获取Statement</li><li>StatementHandler.query（实际调用的是PreparedStatementHandler）获取查询结果。</li></ul><p>我们看看prepareStatement方法。</p><figure class="highlight java"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-zbmfsdlhkez7dw"></i><span>java</span><div class="collapse show" id="collapse-zbmfsdlhkez7dw"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"> <span class="hljs-comment">//SimpleExcutor</span><br> <span class="hljs-keyword">private</span> Statement <span class="hljs-title function_">prepareStatement</span><span class="hljs-params">(StatementHandler handler, Log statementLog)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>   Statement stmt;<br><span class="hljs-comment">//获取数据库连接</span><br>   <span class="hljs-type">Connection</span> <span class="hljs-variable">connection</span> <span class="hljs-operator">=</span> getConnection(statementLog);<br>   <span class="hljs-comment">//创建Statement</span><br>   stmt = handler.prepare(connection);<br>   <span class="hljs-comment">//为Statement设置IN参数</span><br>   handler.parameterize(stmt);<br>   <span class="hljs-keyword">return</span> stmt;<br> &#125;<br><br></code></pre></td></tr></table></div></figure><p>经典的流程：获取数据库连接；创建Statement; 为Statement设置IN参数。再看第三步执行语句：</p><figure class="highlight java"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-fxe88vlhkez7dw"></i><span>java</span><div class="collapse show" id="collapse-fxe88vlhkez7dw"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"> <span class="hljs-comment">//PreparedStatementHandler</span><br> <span class="hljs-keyword">public</span> &lt;E&gt; List&lt;E&gt; <span class="hljs-title function_">query</span><span class="hljs-params">(Statement statement, ResultHandler resultHandler)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>   <span class="hljs-type">PreparedStatement</span> <span class="hljs-variable">ps</span> <span class="hljs-operator">=</span> (PreparedStatement) statement;<br><span class="hljs-comment">// 执行SQL</span><br>   ps.execute();<br><span class="hljs-comment">// 处理执行结果</span><br>   <span class="hljs-keyword">return</span> resultSetHandler.&lt;E&gt; handleResultSets(ps);<br> &#125;<br><br></code></pre></td></tr></table></div></figure><p>查询完毕，总结一下这个过程的时序图，一目了然：<br><img src="https://img-blog.csdnimg.cn/20210322151224922.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2tlemFkZQ==,size_16,color_FFFFFF,t_70"></p><h1 id="三、结果集处理"><a href="#三、结果集处理" class="headerlink" title="三、结果集处理"></a>三、结果集处理</h1><p>结果集的映射，这部分我会在下一篇详细的跟进。Game over.</p>]]></content>
    
    
    <categories>
      
      <category>MyBatis源码学习</category>
      
    </categories>
    
    
    <tags>
      
      <tag>MyBatis</tag>
      
      <tag>源码</tag>
      
      <tag>SQL</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>【MyBatis源码学习】Sql解析</title>
    <link href="/posts/3395965495.html"/>
    <url>/posts/3395965495.html</url>
    
    <content type="html"><![CDATA[<h1 id="一、前言"><a href="#一、前言" class="headerlink" title="一、前言"></a>一、前言</h1><p>之前我在<a href="https://blog.csdn.net/kezade/article/details/114670150">【Mybatis源码学习】初始化阶段</a>中重点讲述了核心配置类XMLConfigBuilder、XMLMapperBuilder、XMLStatementBuilder各自的功能。我们先熟悉下这“三剑客”，看下图即可。<br><img src="https://img-blog.csdnimg.cn/20210315205850237.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2tlemFkZQ==,size_16,color_FFFFFF,t_70"><br>本章节中，我们重点跟一下XMLMapperBuilder、XMLStatementBuilder解析sql的源码过程。<br>XMLMapperBuilder、XMLStatementBuilder均实现了BaseBuilder。<br><img src="https://img-blog.csdnimg.cn/2021031521015322.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2tlemFkZQ==,size_16,color_FFFFFF,t_70"><br>XMLMapperBuilder主要功能：<br>    遍历mybatis中mapperLocations属性中的xml文件中每个节点的Builder，比如user.xml，内部会使用XMLStatementBuilder处理xml中的每个节点。<br>XMLStatementBuilder主要功能：<br>    解析xml文件中各个节点，比如select,insert,update,delete节点，内部会使用XMLScriptBuilder处理节点的sql部分，遍历产生的数据会丢到Configuration的mappedStatements中。</p><p>在<a href="https://blog.csdn.net/kezade/article/details/114670150">【Mybatis源码学习】初始化阶段</a>中，我们分析了XMLConfigBuilder的主要工作流程。还是以下面的代码为例，重点分析下XMLMapperBuilder和XMLStatementBuilder解析sql的流程。</p><figure class="highlight java"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-uunu9rlhkez7dw"></i><span>java</span><div class="collapse show" id="collapse-uunu9rlhkez7dw"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Before</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">init</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>    <span class="hljs-comment">//--------------------第一阶段---------------------------</span><br>    <span class="hljs-comment">// 1.读取mybatis配置文件创SqlSessionFactory</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">resource</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;mybatis-config.xml&quot;</span>;<br>    <span class="hljs-type">InputStream</span> <span class="hljs-variable">inputStream</span> <span class="hljs-operator">=</span> Resources.getResourceAsStream(resource);<br>    <span class="hljs-comment">// 1.读取mybatis配置文件创SqlSessionFactory</span><br>    sqlSessionFactory = <span class="hljs-keyword">new</span> <span class="hljs-title class_">SqlSessionFactoryBuilder</span>().build(inputStream);<br>    inputStream.close();<br>&#125;<br></code></pre></td></tr></table></div></figure><p>进入new SqlSessionFactoryBuilder().build(inputStream)方法，我们看看parse的方法。<br><img src="https://img-blog.csdnimg.cn/20210316135635377.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2tlemFkZQ==,size_16,color_FFFFFF,t_70"><br><img src="https://img-blog.csdnimg.cn/2021031613571219.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2tlemFkZQ==,size_16,color_FFFFFF,t_70"><br>而我这里的mybatis-config.xml文件如下：</p><figure class="highlight xml"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-f2tlyvlhkez7dw"></i><span>xml</span><div class="collapse show" id="collapse-f2tlyvlhkez7dw"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span> ?&gt;</span><br><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">configuration</span> <span class="hljs-keyword">PUBLIC</span> <span class="hljs-string">&quot;-//mybatis.org//DTD Config 3.0//EN&quot;</span> <span class="hljs-string">&quot;http://mybatis.org/dtd/mybatis-3-config.dtd&quot;</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">configuration</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">properties</span> <span class="hljs-attr">resource</span>=<span class="hljs-string">&quot;db.properties&quot;</span>/&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">settings</span>&gt;</span><br>        <span class="hljs-comment">&lt;!-- 设置自动驼峰转换 --&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">setting</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;mapUnderscoreToCamelCase&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;true&quot;</span>/&gt;</span><br>        <span class="hljs-comment">&lt;!-- 开启懒加载 --&gt;</span><br>        <span class="hljs-comment">&lt;!-- 当启用时，有延迟加载属性的对象在被调用时将会完全加载任意属性。否则，每种属性将会按需要加载。默认：true --&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">setting</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;aggressiveLazyLoading&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;false&quot;</span>/&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">settings</span>&gt;</span><br><br>    <span class="hljs-comment">&lt;!-- 别名定义 --&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">typeAliases</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">package</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;com.enjoylearning.mybatis.entity&quot;</span>/&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">typeAliases</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">plugins</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">plugin</span> <span class="hljs-attr">interceptor</span>=<span class="hljs-string">&quot;com.enjoylearning.mybatis.Interceptors.ThresholdInterceptor&quot;</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;threshold&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;10&quot;</span>/&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">plugin</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">plugin</span> <span class="hljs-attr">interceptor</span>=<span class="hljs-string">&quot;com.github.pagehelper.PageInterceptor&quot;</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;pageSizeZero&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;true&quot;</span>/&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">plugin</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">plugins</span>&gt;</span><br><br>    <span class="hljs-comment">&lt;!--配置environment环境 --&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">environments</span> <span class="hljs-attr">default</span>=<span class="hljs-string">&quot;development&quot;</span>&gt;</span><br>        <span class="hljs-comment">&lt;!-- 环境配置1，每个SqlSessionFactory对应一个环境 --&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">environment</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;development&quot;</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">transactionManager</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;JDBC&quot;</span>/&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">dataSource</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;POOLED&quot;</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;driver&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;$&#123;jdbc_driver&#125;&quot;</span>/&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;url&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;$&#123;jdbc_url&#125;&quot;</span>/&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;username&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;$&#123;jdbc_username&#125;&quot;</span>/&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;password&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;$&#123;jdbc_password&#125;&quot;</span>/&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">dataSource</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">environment</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">environments</span>&gt;</span><br><br>    <span class="hljs-comment">&lt;!-- 映射文件，mapper的配置文件 --&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">mappers</span>&gt;</span><br>        <span class="hljs-comment">&lt;!--直接映射到相应的mapper文件 --&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">mapper</span> <span class="hljs-attr">resource</span>=<span class="hljs-string">&quot;sqlmapper/UserInfoMapper.xml&quot;</span>/&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">mapper</span> <span class="hljs-attr">resource</span>=<span class="hljs-string">&quot;sqlmapper/TUserTestMapper.xml&quot;</span>/&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">mapper</span> <span class="hljs-attr">resource</span>=<span class="hljs-string">&quot;sqlmapper/TRoleMapper.xml&quot;</span>/&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">mapper</span> <span class="hljs-attr">resource</span>=<span class="hljs-string">&quot;sqlmapper/TJobHistoryMapper.xml&quot;</span>/&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">mapper</span> <span class="hljs-attr">resource</span>=<span class="hljs-string">&quot;sqlmapper/TPositionMapper.xml&quot;</span>/&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">mapper</span> <span class="hljs-attr">resource</span>=<span class="hljs-string">&quot;sqlmapper/THealthReportFemaleMapper.xml&quot;</span>/&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">mapper</span> <span class="hljs-attr">resource</span>=<span class="hljs-string">&quot;sqlmapper/THealthReportMaleMapper.xml&quot;</span>/&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">mappers</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">configuration</span>&gt;</span>  <br></code></pre></td></tr></table></div></figure><h1 id="二、XMLMapperBuilder"><a href="#二、XMLMapperBuilder" class="headerlink" title="二、XMLMapperBuilder"></a>二、XMLMapperBuilder</h1><p>对于parser.evalNode(“&#x2F;configuration”)，这里我就不赘述了，重点关注parseConfiguration里面的mapperElement()方法。<br><img src="https://img-blog.csdnimg.cn/20210316135924625.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2tlemFkZQ==,size_16,color_FFFFFF,t_70"><br>这个mapperElement()主要就是解析&lt;mappers&gt;标签下的内容. 这里贴出这个方法的源码，包含注释。</p><figure class="highlight java"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-es7e3xlhkez7dw"></i><span>java</span><div class="collapse show" id="collapse-es7e3xlhkez7dw"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment">  * 解析mappers节点，例如：</span><br><span class="hljs-comment">  * &lt;mappers&gt;</span><br><span class="hljs-comment">  *    &lt;mapper resource=&quot;com/github/yeecode/mybatisDemo/UserDao.xml&quot;/&gt;</span><br><span class="hljs-comment">  *    &lt;package name=&quot;com.github.yeecode.mybatisDemo&quot; /&gt;</span><br><span class="hljs-comment">  * &lt;/mappers&gt;</span><br><span class="hljs-comment">  * <span class="hljs-doctag">@param</span> parent mappers节点</span><br><span class="hljs-comment">  * <span class="hljs-doctag">@throws</span> Exception</span><br><span class="hljs-comment">  */</span><br> <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">mapperElement</span><span class="hljs-params">(XNode parent)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>   <span class="hljs-keyword">if</span> (parent != <span class="hljs-literal">null</span>) &#123;<br>     <span class="hljs-keyword">for</span> (XNode child : parent.getChildren()) &#123;<br>       <span class="hljs-comment">// 处理mappers的子节点，即mapper节点或者package节点</span><br>       <span class="hljs-keyword">if</span> (<span class="hljs-string">&quot;package&quot;</span>.equals(child.getName())) &#123; <span class="hljs-comment">// package节点</span><br>         <span class="hljs-comment">// 取出包路径</span><br>         <span class="hljs-type">String</span> <span class="hljs-variable">mapperPackage</span> <span class="hljs-operator">=</span> child.getStringAttribute(<span class="hljs-string">&quot;name&quot;</span>);<br>         <span class="hljs-comment">// 全部加入Mappers中</span><br>         configuration.addMappers(mapperPackage);<br>       &#125; <span class="hljs-keyword">else</span> &#123;<br>         <span class="hljs-comment">// resource、url、class这三个属性只有一个生效</span><br>         <span class="hljs-type">String</span> <span class="hljs-variable">resource</span> <span class="hljs-operator">=</span> child.getStringAttribute(<span class="hljs-string">&quot;resource&quot;</span>);<br>         <span class="hljs-type">String</span> <span class="hljs-variable">url</span> <span class="hljs-operator">=</span> child.getStringAttribute(<span class="hljs-string">&quot;url&quot;</span>);<br>         <span class="hljs-type">String</span> <span class="hljs-variable">mapperClass</span> <span class="hljs-operator">=</span> child.getStringAttribute(<span class="hljs-string">&quot;class&quot;</span>);<br>         <span class="hljs-keyword">if</span> (resource != <span class="hljs-literal">null</span> &amp;&amp; url == <span class="hljs-literal">null</span> &amp;&amp; mapperClass == <span class="hljs-literal">null</span>) &#123;<br>           ErrorContext.instance().resource(resource);<br>           <span class="hljs-comment">// 获取文件的输入流</span><br>           <span class="hljs-type">InputStream</span> <span class="hljs-variable">inputStream</span> <span class="hljs-operator">=</span> Resources.getResourceAsStream(resource);<br>           <span class="hljs-comment">// 使用XMLMapperBuilder解析映射文件</span><br>           <span class="hljs-type">XMLMapperBuilder</span> <span class="hljs-variable">mapperParser</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">XMLMapperBuilder</span>(inputStream, configuration, resource, configuration.getSqlFragments());<br>           mapperParser.parse();<br>         &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (resource == <span class="hljs-literal">null</span> &amp;&amp; url != <span class="hljs-literal">null</span> &amp;&amp; mapperClass == <span class="hljs-literal">null</span>) &#123;<br>           ErrorContext.instance().resource(url);<br>           <span class="hljs-comment">// 从网络获得输入流</span><br>           <span class="hljs-type">InputStream</span> <span class="hljs-variable">inputStream</span> <span class="hljs-operator">=</span> Resources.getUrlAsStream(url);<br>           <span class="hljs-comment">// 使用XMLMapperBuilder解析映射文件</span><br>           <span class="hljs-type">XMLMapperBuilder</span> <span class="hljs-variable">mapperParser</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">XMLMapperBuilder</span>(inputStream, configuration, url, configuration.getSqlFragments());<br>           mapperParser.parse();<br>         &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (resource == <span class="hljs-literal">null</span> &amp;&amp; url == <span class="hljs-literal">null</span> &amp;&amp; mapperClass != <span class="hljs-literal">null</span>) &#123;<br>           <span class="hljs-comment">// 配置的不是映射文件，而是映射接口</span><br>           Class&lt;?&gt; mapperInterface = Resources.classForName(mapperClass);<br>           configuration.addMapper(mapperInterface);<br>         &#125; <span class="hljs-keyword">else</span> &#123;<br>           <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BuilderException</span>(<span class="hljs-string">&quot;A mapper element may only specify a url, resource or class, but not more than one.&quot;</span>);<br>         &#125;<br>       &#125;<br>     &#125;<br>   &#125;<br> &#125;<br></code></pre></td></tr></table></div></figure><p>for循环里的if主要是针对&lt;mappers&gt;标签下还有&lt;package&gt;标签的解析。而else则是针对&lt;mappers&gt;标签下还有&lt;mapper&gt;标签的解析。通常，我们的&lt;mapper&gt;会有三种形式，且resource、url、class这三个属性只有一个生效。</p><figure class="highlight xml"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-2bo3x0lhkez7dw"></i><span>xml</span><div class="collapse show" id="collapse-2bo3x0lhkez7dw"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!-- 映射器 1使用类路径--&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">mappers</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">mapper</span> <span class="hljs-attr">resource</span>=<span class="hljs-string">&quot;org/mybatis/builder/AuthorMapper.xml&quot;</span>/&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">mapper</span> <span class="hljs-attr">resource</span>=<span class="hljs-string">&quot;org/mybatis/builder/BlogMapper.xml&quot;</span>/&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">mapper</span> <span class="hljs-attr">resource</span>=<span class="hljs-string">&quot;org/mybatis/builder/PostMapper.xml&quot;</span>/&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">mappers</span>&gt;</span><br>       <span class="hljs-comment">&lt;!-- 2使用绝对url路径--&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">mappers</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">mapper</span> <span class="hljs-attr">url</span>=<span class="hljs-string">&quot;file:///var/mappers/AuthorMapper.xml&quot;</span>/&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">mapper</span> <span class="hljs-attr">url</span>=<span class="hljs-string">&quot;file:///var/mappers/BlogMapper.xml&quot;</span>/&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">mapper</span> <span class="hljs-attr">url</span>=<span class="hljs-string">&quot;file:///var/mappers/PostMapper.xml&quot;</span>/&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">mappers</span>&gt;</span><br>      <span class="hljs-comment">&lt;!-- 3使用java类名--&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">mappers</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">mapper</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;org.mybatis.builder.AuthorMapper&quot;</span>/&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">mapper</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;org.mybatis.builder.BlogMapper&quot;</span>/&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">mapper</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;org.mybatis.builder.PostMapper&quot;</span>/&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">mappers</span>&gt;</span><br><span class="hljs-comment">&lt;!-- 4自动扫描包下所有映射器 --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">mappers</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">package</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;org.mybatis.builder&quot;</span>/&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">mappers</span>&gt;</span><br></code></pre></td></tr></table></div></figure><p>这里关注两个方法：</p><ul><li>mapperParser.parse();</li><li>configuration.addMapper(mapperInterface);</li></ul><p>它们最终的目的就是将映射器的class对象，以及其代理类设置到集合中，采用的是JDK代理。<br>我们先看addMapper()做了些啥。</p><figure class="highlight java"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-p9lyczlhkez7dw"></i><span>java</span><div class="collapse show" id="collapse-p9lyczlhkez7dw"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//将mapper接口的工厂类添加到mapper注册中心</span><br><span class="hljs-keyword">public</span> &lt;T&gt; <span class="hljs-keyword">void</span> <span class="hljs-title function_">addMapper</span><span class="hljs-params">(Class&lt;T&gt; type)</span> &#123;<br>  <span class="hljs-keyword">if</span> (type.isInterface()) &#123;<br>      <span class="hljs-keyword">if</span> (hasMapper(type)) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BindingException</span>(<span class="hljs-string">&quot;Type &quot;</span> + type + <span class="hljs-string">&quot; is already known to the MapperRegistry.&quot;</span>);<br>      &#125;<br>    <span class="hljs-type">boolean</span> <span class="hljs-variable">loadCompleted</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;<br>    <span class="hljs-keyword">try</span> &#123;<br>  <span class="hljs-comment">//实例化Mapper接口的代理工程类，并将信息添加至knownMappers</span><br>      knownMappers.put(type, <span class="hljs-keyword">new</span> <span class="hljs-title class_">MapperProxyFactory</span>&lt;T&gt;(type));<br>      <span class="hljs-comment">// It&#x27;s important that the type is added before the parser is run</span><br>      <span class="hljs-comment">// otherwise the binding may automatically be attempted by the</span><br>      <span class="hljs-comment">// mapper parser. If the type is already known, it won&#x27;t try.</span><br>      <span class="hljs-comment">//解析接口上的注解信息，并添加至configuration对象</span><br>      <span class="hljs-type">MapperAnnotationBuilder</span> <span class="hljs-variable">parser</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MapperAnnotationBuilder</span>(config, type);<br>      parser.parse();<br>      loadCompleted = <span class="hljs-literal">true</span>;<br>    &#125; <span class="hljs-keyword">finally</span> &#123;<br>      <span class="hljs-keyword">if</span> (!loadCompleted) &#123;<br>        knownMappers.remove(type);<br>      &#125;<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></div></figure><p>而XMLMapperBuilder的parse()方法：</p><figure class="highlight java"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-wb3cdplhkez7dw"></i><span>java</span><div class="collapse show" id="collapse-wb3cdplhkez7dw"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">parse</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-comment">//判断是否已经加载该配置文件</span><br>    <span class="hljs-keyword">if</span> (!configuration.isResourceLoaded(resource)) &#123;<br>        configurationElement(parser.evalNode(<span class="hljs-string">&quot;/mapper&quot;</span>));<span class="hljs-comment">//处理mapper节点</span><br>        configuration.addLoadedResource(resource);<span class="hljs-comment">//将mapper文件添加到configuration.loadedResources中</span><br>        bindMapperForNamespace();<span class="hljs-comment">//注册mapper接口</span><br>    &#125;<br>    <span class="hljs-comment">//处理解析失败的ResultMap节点</span><br>    parsePendingResultMaps();<br>    <span class="hljs-comment">//处理解析失败的CacheRef节点</span><br>    parsePendingCacheRefs();<br>    <span class="hljs-comment">//处理解析失败的Sql语句节点</span><br>    parsePendingStatements();<br>&#125;<br></code></pre></td></tr></table></div></figure><p>我们在看看MapperAnnotationBuilder的parse方法，该类主要是以注解的方式构建mapper，用的比较少。</p><figure class="highlight java"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-wosihylhkez7dw"></i><span>java</span><div class="collapse show" id="collapse-wosihylhkez7dw"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment">  * 解析包含注解的接口文档</span><br><span class="hljs-comment">  */</span><br> <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">parse</span><span class="hljs-params">()</span> &#123;<br>   <span class="hljs-type">String</span> <span class="hljs-variable">resource</span> <span class="hljs-operator">=</span> type.toString();<br>   <span class="hljs-comment">// 防止重复分析</span><br>   <span class="hljs-keyword">if</span> (!configuration.isResourceLoaded(resource)) &#123;<br>     <span class="hljs-comment">// 寻找类名称对应的 resource路径下是否有 xml 配置，如果有则直接解析掉，这样就支持注解和xml一起混合使用了</span><br>     loadXmlResource();<br>     <span class="hljs-comment">// 记录资源路径</span><br>     configuration.addLoadedResource(resource);<br>     <span class="hljs-comment">// 设置命名空间</span><br>     assistant.setCurrentNamespace(type.getName());<br>     <span class="hljs-comment">// 处理缓存</span><br>     parseCache();<br>     parseCacheRef();<br>     Method[] methods = type.getMethods();<br>     <span class="hljs-keyword">for</span> (Method method : methods) &#123;<br>       <span class="hljs-keyword">try</span> &#123;<br>         <span class="hljs-comment">// 排除桥接方法，桥接方法是为了匹配泛型的类型擦除而由编译器自动引入的，并非用户编写的方法，因此要排除掉。</span><br>         <span class="hljs-comment">// issue #237</span><br>         <span class="hljs-keyword">if</span> (!method.isBridge()) &#123;<br>           <span class="hljs-comment">// 解析该方法</span><br>           parseStatement(method);<br>         &#125;<br>       &#125; <span class="hljs-keyword">catch</span> (IncompleteElementException e) &#123;<br>         <span class="hljs-comment">// 异常方法暂存起来</span><br>         configuration.addIncompleteMethod(<span class="hljs-keyword">new</span> <span class="hljs-title class_">MethodResolver</span>(<span class="hljs-built_in">this</span>, method));<br>       &#125;<br>     &#125;<br>   &#125;<br>   <span class="hljs-comment">// 处理异常的方法</span><br>   parsePendingMethods();<br> &#125;<br></code></pre></td></tr></table></div></figure><p>关键看看parseStatement()方法，主要就是解析注解上的信息。再通过getSqlSourceFromAnnotations方法获取sqlSource.</p><figure class="highlight java"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-pq0w55lhkez7dw"></i><span>java</span><div class="collapse show" id="collapse-pq0w55lhkez7dw"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment">  * 解析该方法，主要是解析方法上的注解信息</span><br><span class="hljs-comment">  * <span class="hljs-doctag">@param</span> method</span><br><span class="hljs-comment">  */</span><br> <span class="hljs-keyword">void</span> <span class="hljs-title function_">parseStatement</span><span class="hljs-params">(Method method)</span> &#123;<br>   <span class="hljs-comment">// 通过字方法获取参数类型</span><br>   Class&lt;?&gt; parameterTypeClass = getParameterType(method);<br>   <span class="hljs-comment">// 获取方法的脚本语言渠道</span><br>   <span class="hljs-type">LanguageDriver</span> <span class="hljs-variable">languageDriver</span> <span class="hljs-operator">=</span> getLanguageDriver(method);<br>   <span class="hljs-comment">// 通过注解获取SqlSource</span><br>   <span class="hljs-type">SqlSource</span> <span class="hljs-variable">sqlSource</span> <span class="hljs-operator">=</span> getSqlSourceFromAnnotations(method, parameterTypeClass, languageDriver);<br>   <span class="hljs-keyword">if</span> (sqlSource != <span class="hljs-literal">null</span>) &#123;<br>     <span class="hljs-comment">// 获取方法上可能存在的配置信息，配置信息由@Options注解指定</span><br>     <span class="hljs-type">Options</span> <span class="hljs-variable">options</span> <span class="hljs-operator">=</span> method.getAnnotation(Options.class);<br>     <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">mappedStatementId</span> <span class="hljs-operator">=</span> type.getName() + <span class="hljs-string">&quot;.&quot;</span> + method.getName();<br>     <span class="hljs-type">Integer</span> <span class="hljs-variable">fetchSize</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>     <span class="hljs-type">Integer</span> <span class="hljs-variable">timeout</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>     <span class="hljs-type">StatementType</span> <span class="hljs-variable">statementType</span> <span class="hljs-operator">=</span> StatementType.PREPARED;<br>     <span class="hljs-type">ResultSetType</span> <span class="hljs-variable">resultSetType</span> <span class="hljs-operator">=</span> configuration.getDefaultResultSetType();<br>     <span class="hljs-type">SqlCommandType</span> <span class="hljs-variable">sqlCommandType</span> <span class="hljs-operator">=</span> getSqlCommandType(method);<br>     <span class="hljs-type">boolean</span> <span class="hljs-variable">isSelect</span> <span class="hljs-operator">=</span> sqlCommandType == SqlCommandType.SELECT;<br>     <span class="hljs-type">boolean</span> <span class="hljs-variable">flushCache</span> <span class="hljs-operator">=</span> !isSelect;<br>     <span class="hljs-type">boolean</span> <span class="hljs-variable">useCache</span> <span class="hljs-operator">=</span> isSelect;<br><br>     KeyGenerator keyGenerator;<br>     <span class="hljs-type">String</span> <span class="hljs-variable">keyProperty</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>     <span class="hljs-type">String</span> <span class="hljs-variable">keyColumn</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>     <span class="hljs-keyword">if</span> (SqlCommandType.INSERT.equals(sqlCommandType) || SqlCommandType.UPDATE.equals(sqlCommandType)) &#123;<br>       <span class="hljs-comment">// first check for SelectKey annotation - that overrides everything else</span><br>       <span class="hljs-type">SelectKey</span> <span class="hljs-variable">selectKey</span> <span class="hljs-operator">=</span> method.getAnnotation(SelectKey.class);<br>       <span class="hljs-keyword">if</span> (selectKey != <span class="hljs-literal">null</span>) &#123;<br>         keyGenerator = handleSelectKeyAnnotation(selectKey, mappedStatementId, getParameterType(method), languageDriver);<br>         keyProperty = selectKey.keyProperty();<br>       &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (options == <span class="hljs-literal">null</span>) &#123;<br>         keyGenerator = configuration.isUseGeneratedKeys() ? Jdbc3KeyGenerator.INSTANCE : NoKeyGenerator.INSTANCE;<br>       &#125; <span class="hljs-keyword">else</span> &#123;<br>         keyGenerator = options.useGeneratedKeys() ? Jdbc3KeyGenerator.INSTANCE : NoKeyGenerator.INSTANCE;<br>         keyProperty = options.keyProperty();<br>         keyColumn = options.keyColumn();<br>       &#125;<br>     &#125; <span class="hljs-keyword">else</span> &#123;<br>       keyGenerator = NoKeyGenerator.INSTANCE;<br>     &#125;<br><br>     <span class="hljs-keyword">if</span> (options != <span class="hljs-literal">null</span>) &#123;<br>       <span class="hljs-keyword">if</span> (FlushCachePolicy.TRUE.equals(options.flushCache())) &#123;<br>         flushCache = <span class="hljs-literal">true</span>;<br>       &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (FlushCachePolicy.FALSE.equals(options.flushCache())) &#123;<br>         flushCache = <span class="hljs-literal">false</span>;<br>       &#125;<br>       useCache = options.useCache();<br>       fetchSize = options.fetchSize() &gt; -<span class="hljs-number">1</span> || options.fetchSize() == Integer.MIN_VALUE ? options.fetchSize() : <span class="hljs-literal">null</span>; <span class="hljs-comment">//issue #348</span><br>       timeout = options.timeout() &gt; -<span class="hljs-number">1</span> ? options.timeout() : <span class="hljs-literal">null</span>;<br>       statementType = options.statementType();<br>       <span class="hljs-keyword">if</span> (options.resultSetType() != ResultSetType.DEFAULT) &#123;<br>         resultSetType = options.resultSetType();<br>       &#125;<br>     &#125;<br><br>     <span class="hljs-type">String</span> <span class="hljs-variable">resultMapId</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>     <span class="hljs-type">ResultMap</span> <span class="hljs-variable">resultMapAnnotation</span> <span class="hljs-operator">=</span> method.getAnnotation(ResultMap.class);<br>     <span class="hljs-keyword">if</span> (resultMapAnnotation != <span class="hljs-literal">null</span>) &#123;<br>       resultMapId = String.join(<span class="hljs-string">&quot;,&quot;</span>, resultMapAnnotation.value());<br>     &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (isSelect) &#123;<br>       resultMapId = parseResultMap(method);<br>     &#125;<br><br>     <span class="hljs-comment">// 将获取到的信息存入 configuration</span><br>     assistant.addMappedStatement(<br>         mappedStatementId,<br>         sqlSource,<br>         statementType,<br>         sqlCommandType,<br>         fetchSize,<br>         timeout,<br>         <span class="hljs-comment">// ParameterMapID</span><br>         <span class="hljs-literal">null</span>,<br>         parameterTypeClass,<br>         resultMapId,<br>         getReturnType(method),<br>         resultSetType,<br>         flushCache,<br>         useCache,<br>         <span class="hljs-comment">// TODO gcode issue #577</span><br>         <span class="hljs-literal">false</span>,<br>         keyGenerator,<br>         keyProperty,<br>         keyColumn,<br>         <span class="hljs-comment">// DatabaseID</span><br>         <span class="hljs-literal">null</span>,<br>         languageDriver,<br>         <span class="hljs-comment">// ResultSets</span><br>         options != <span class="hljs-literal">null</span> ? nullOrEmpty(options.resultSets()) : <span class="hljs-literal">null</span>);<br>   &#125;<br> &#125;<br></code></pre></td></tr></table></div></figure><p>getSqlSourceFromAnnotations()方法。</p><figure class="highlight java"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-2pahvhlhkez7dw"></i><span>java</span><div class="collapse show" id="collapse-2pahvhlhkez7dw"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment">  * 通过注解获取SqlSource对象</span><br><span class="hljs-comment">  * </span><br><span class="hljs-comment">  * <span class="hljs-doctag">@param</span> method 含有注解的方法</span><br><span class="hljs-comment">  * <span class="hljs-doctag">@param</span> parameterType 参数类型</span><br><span class="hljs-comment">  * <span class="hljs-doctag">@param</span> languageDriver 语言渠道</span><br><span class="hljs-comment">  * <span class="hljs-doctag">@return</span> SqlSource对象</span><br><span class="hljs-comment">  */</span><br> <span class="hljs-keyword">private</span> SqlSource <span class="hljs-title function_">getSqlSourceFromAnnotations</span><span class="hljs-params">(Method method, Class&lt;?&gt; parameterType, LanguageDriver languageDriver)</span> &#123;<br>   <span class="hljs-keyword">try</span> &#123;<br>     <span class="hljs-comment">// 遍历寻找是否有 Select、Insert、Update、Delete四个注解之一</span><br>     Class&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Annotation</span>&gt; sqlAnnotationType = getSqlAnnotationType(method);<br>     <span class="hljs-comment">// 遍历寻找是否有 SelectProvider、InsertProvider、UpdateProvider、DeleteProvider 四个注解之一</span><br>     Class&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Annotation</span>&gt; sqlProviderAnnotationType = getSqlProviderAnnotationType(method);<br>     <span class="hljs-keyword">if</span> (sqlAnnotationType != <span class="hljs-literal">null</span>) &#123;<br>       <span class="hljs-keyword">if</span> (sqlProviderAnnotationType != <span class="hljs-literal">null</span>) &#123;<br>         <span class="hljs-comment">// 两类注解不能同时使用</span><br>         <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BindingException</span>(<span class="hljs-string">&quot;You cannot supply both a static SQL and SqlProvider to method named &quot;</span> + method.getName());<br>       &#125;<br>       <span class="hljs-comment">// 取出Select、Insert、Update、Delete四个注解之一</span><br>       <span class="hljs-type">Annotation</span> <span class="hljs-variable">sqlAnnotation</span> <span class="hljs-operator">=</span> method.getAnnotation(sqlAnnotationType);<br>       <span class="hljs-comment">// 取出value值</span><br>       <span class="hljs-keyword">final</span> String[] strings = (String[]) sqlAnnotation.getClass().getMethod(<span class="hljs-string">&quot;value&quot;</span>).invoke(sqlAnnotation);<br>       <span class="hljs-comment">// 基于字符串构建SqlSource，直接注解获取SQL</span><br>       <span class="hljs-keyword">return</span> buildSqlSourceFromStrings(strings, parameterType, languageDriver);<br>     &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (sqlProviderAnnotationType != <span class="hljs-literal">null</span>) &#123;<br>       <span class="hljs-comment">// // 取出 SelectProvider、InsertProvider、UpdateProvider、DeleteProvider 四个注解之一</span><br>       <span class="hljs-type">Annotation</span> <span class="hljs-variable">sqlProviderAnnotation</span> <span class="hljs-operator">=</span> method.getAnnotation(sqlProviderAnnotationType);<br>       <span class="hljs-comment">// 根据对应的方法获取SqlSource，间接注解获取SQL</span><br>       <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ProviderSqlSource</span>(assistant.getConfiguration(), sqlProviderAnnotation, type, method);<br>     &#125;<br>     <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>   &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>     <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BuilderException</span>(<span class="hljs-string">&quot;Could not find value method on SQL annotation.  Cause: &quot;</span> + e, e);<br>   &#125;<br> &#125;<br></code></pre></td></tr></table></div></figure><p>总结下解析mapper的parse()方法有两种方式：</p><ul><li>XMLMapperBuilder的parse方法</li><li>MapperAnnotationBuilder的parse方法</li></ul><p>MapperAnnotationBuilder的parse方法与XMLMapperBuilder的parse方法逻辑上略有不同，主要体现在对节点的解析上。</p><p>上面只是大致分析了*mapper.java与*mapper.xml映射注册的过程，由于我们的*mapper.xml还有很多其他的xml标签，这里我们需要具体了解下其中的解析流程。还是回到XMLMapperBuilder的parse()方法。<br>我们看看configurationElement()方法干了些啥。</p><figure class="highlight java"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-an93sqlhkez7dw"></i><span>java</span><div class="collapse show" id="collapse-an93sqlhkez7dw"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment">  * 解析映射文件的下层节点</span><br><span class="hljs-comment">  * <span class="hljs-doctag">@param</span> context 映射文件根节点</span><br><span class="hljs-comment">  */</span><br> <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">configurationElement</span><span class="hljs-params">(XNode context)</span> &#123;<br>   <span class="hljs-keyword">try</span> &#123;<br>    <span class="hljs-comment">//获取mapper节点的namespace属性</span><br>     <span class="hljs-type">String</span> <span class="hljs-variable">namespace</span> <span class="hljs-operator">=</span> context.getStringAttribute(<span class="hljs-string">&quot;namespace&quot;</span>);<br>     <span class="hljs-keyword">if</span> (namespace == <span class="hljs-literal">null</span> || namespace.equals(<span class="hljs-string">&quot;&quot;</span>)) &#123;<br>         <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BuilderException</span>(<span class="hljs-string">&quot;Mapper&#x27;s namespace cannot be empty&quot;</span>);<br>     &#125;<br>     <span class="hljs-comment">//设置builderAssistant的namespace属性</span><br>     builderAssistant.setCurrentNamespace(namespace);<br>     <span class="hljs-comment">//解析cache-ref节点</span><br>     cacheRefElement(context.evalNode(<span class="hljs-string">&quot;cache-ref&quot;</span>));<br>     <span class="hljs-comment">//重点分析 ：解析cache节点----------------1-------------------二级缓存</span><br>     cacheElement(context.evalNode(<span class="hljs-string">&quot;cache&quot;</span>));<br>     <span class="hljs-comment">//解析parameterMap节点（已废弃）</span><br>     parameterMapElement(context.evalNodes(<span class="hljs-string">&quot;/mapper/parameterMap&quot;</span>));<br>     <span class="hljs-comment">//重点分析 ：解析resultMap节点（基于数据结果去理解）----------------2-------------------</span><br>     resultMapElements(context.evalNodes(<span class="hljs-string">&quot;/mapper/resultMap&quot;</span>));<br>     <span class="hljs-comment">//解析sql节点</span><br>     sqlElement(context.evalNodes(<span class="hljs-string">&quot;/mapper/sql&quot;</span>));<br>     <span class="hljs-comment">//重点分析 ：解析select、insert、update、delete节点 ----------------3-------------------sql解析</span><br>     buildStatementFromContext(context.evalNodes(<span class="hljs-string">&quot;select|insert|update|delete&quot;</span>));<br>   &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>     <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BuilderException</span>(<span class="hljs-string">&quot;Error parsing Mapper XML. The XML location is &#x27;&quot;</span> + resource + <span class="hljs-string">&quot;&#x27;. Cause: &quot;</span> + e, e);<br>   &#125;<br> &#125;<br></code></pre></td></tr></table></div></figure><p>重点关注这几个方法：</p><ul><li>cacheElement：解析&lt;cache&gt;，与二级缓存有关.</li><li>resultMapElements：解析&lt;resultMap&gt;，结果集映射.</li><li>sqlElement：解析sql节点&lt;sql&gt;.</li><li>buildStatementFromContext：解析&lt;select&gt;、&lt;insert&gt;、&lt;update&gt;、&lt;delete&gt;节点.</li></ul><p>而当前我们的UserInfoMapper如下：<br><img src="https://img-blog.csdnimg.cn/20210316160708894.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2tlemFkZQ==,size_16,color_FFFFFF,t_70"><br>接下来，我们关注buildStatementFromContext解析&lt;select&gt;、&lt;insert&gt;、&lt;update&gt;、&lt;delete&gt;标签的过程。主要就是看看XMLStatementBuilder是怎么干活儿的。</p><h1 id="三、XMLStatementBuilder"><a href="#三、XMLStatementBuilder" class="headerlink" title="三、XMLStatementBuilder"></a>三、XMLStatementBuilder</h1><figure class="highlight java"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-fg170elhkez7dw"></i><span>java</span><div class="collapse show" id="collapse-fg170elhkez7dw"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//解析select、insert、update、delete节点</span><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">buildStatementFromContext</span><span class="hljs-params">(List&lt;XNode&gt; list)</span> &#123;<br>    <span class="hljs-keyword">if</span> (configuration.getDatabaseId() != <span class="hljs-literal">null</span>) &#123;<br>        buildStatementFromContext(list, configuration.getDatabaseId());<br>    &#125;<br>    buildStatementFromContext(list, <span class="hljs-literal">null</span>);<br>&#125;<br><br><span class="hljs-comment">//处理所有的sql语句节点并注册至configuration对象</span><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">buildStatementFromContext</span><span class="hljs-params">(List&lt;XNode&gt; list, String requiredDatabaseId)</span> &#123;<br>    <span class="hljs-keyword">for</span> (XNode context : list) &#123;<br>        <span class="hljs-comment">//创建XMLStatementBuilder 专门用于解析sql语句节点</span><br>        <span class="hljs-keyword">final</span> <span class="hljs-type">XMLStatementBuilder</span> <span class="hljs-variable">statementParser</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">XMLStatementBuilder</span>(configuration, builderAssistant, context, requiredDatabaseId);<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-comment">//解析sql语句节点，并将解析结果存储到 configuration 的 mappedStatements 集合中</span><br>            statementParser.parseStatementNode();<br>        &#125; <span class="hljs-keyword">catch</span> (IncompleteElementException e) &#123;<br>            configuration.addIncompleteStatement(statementParser);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></div></figure><p>点进去看看parseStatementNode()方法。</p><figure class="highlight java"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-xlgvo6lhkez7dw"></i><span>java</span><div class="collapse show" id="collapse-xlgvo6lhkez7dw"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">parseStatementNode</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-comment">//获取sql节点的id</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">id</span> <span class="hljs-operator">=</span> context.getStringAttribute(<span class="hljs-string">&quot;id&quot;</span>);<br>    <span class="hljs-type">String</span> <span class="hljs-variable">databaseId</span> <span class="hljs-operator">=</span> context.getStringAttribute(<span class="hljs-string">&quot;databaseId&quot;</span>);<br><br>    <span class="hljs-keyword">if</span> (!databaseIdMatchesCurrent(id, databaseId, <span class="hljs-built_in">this</span>.requiredDatabaseId)) &#123;<br>        <span class="hljs-keyword">return</span>;<br>    &#125;<br>    <span class="hljs-comment">/*获取sql节点的各种属性*/</span><br>    <span class="hljs-type">Integer</span> <span class="hljs-variable">fetchSize</span> <span class="hljs-operator">=</span> context.getIntAttribute(<span class="hljs-string">&quot;fetchSize&quot;</span>);<br>    <span class="hljs-type">Integer</span> <span class="hljs-variable">timeout</span> <span class="hljs-operator">=</span> context.getIntAttribute(<span class="hljs-string">&quot;timeout&quot;</span>);<br>    <span class="hljs-type">String</span> <span class="hljs-variable">parameterMap</span> <span class="hljs-operator">=</span> context.getStringAttribute(<span class="hljs-string">&quot;parameterMap&quot;</span>);<br>    <span class="hljs-type">String</span> <span class="hljs-variable">parameterType</span> <span class="hljs-operator">=</span> context.getStringAttribute(<span class="hljs-string">&quot;parameterType&quot;</span>);<br>    Class&lt;?&gt; parameterTypeClass = resolveClass(parameterType);<br>    <span class="hljs-type">String</span> <span class="hljs-variable">resultMap</span> <span class="hljs-operator">=</span> context.getStringAttribute(<span class="hljs-string">&quot;resultMap&quot;</span>);<br>    <span class="hljs-type">String</span> <span class="hljs-variable">resultType</span> <span class="hljs-operator">=</span> context.getStringAttribute(<span class="hljs-string">&quot;resultType&quot;</span>);<br>    <span class="hljs-type">String</span> <span class="hljs-variable">lang</span> <span class="hljs-operator">=</span> context.getStringAttribute(<span class="hljs-string">&quot;lang&quot;</span>);<br>    <span class="hljs-type">LanguageDriver</span> <span class="hljs-variable">langDriver</span> <span class="hljs-operator">=</span> getLanguageDriver(lang);<br><br>    Class&lt;?&gt; resultTypeClass = resolveClass(resultType);<br>    <span class="hljs-type">String</span> <span class="hljs-variable">resultSetType</span> <span class="hljs-operator">=</span> context.getStringAttribute(<span class="hljs-string">&quot;resultSetType&quot;</span>);<br>    <span class="hljs-type">StatementType</span> <span class="hljs-variable">statementType</span> <span class="hljs-operator">=</span> StatementType.valueOf(context.getStringAttribute(<span class="hljs-string">&quot;statementType&quot;</span>, StatementType.PREPARED.toString()));<br>    <span class="hljs-type">ResultSetType</span> <span class="hljs-variable">resultSetTypeEnum</span> <span class="hljs-operator">=</span> resolveResultSetType(resultSetType);<br><br>    <span class="hljs-comment">//根据sql节点的名称获取SqlCommandType（INSERT, UPDATE, DELETE, SELECT）</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">nodeName</span> <span class="hljs-operator">=</span> context.getNode().getNodeName();<br>    <span class="hljs-type">SqlCommandType</span> <span class="hljs-variable">sqlCommandType</span> <span class="hljs-operator">=</span> SqlCommandType.valueOf(nodeName.toUpperCase(Locale.ENGLISH));<br>    <span class="hljs-type">boolean</span> <span class="hljs-variable">isSelect</span> <span class="hljs-operator">=</span> sqlCommandType == SqlCommandType.SELECT;<br>    <span class="hljs-type">boolean</span> <span class="hljs-variable">flushCache</span> <span class="hljs-operator">=</span> context.getBooleanAttribute(<span class="hljs-string">&quot;flushCache&quot;</span>, !isSelect);<br>    <span class="hljs-type">boolean</span> <span class="hljs-variable">useCache</span> <span class="hljs-operator">=</span> context.getBooleanAttribute(<span class="hljs-string">&quot;useCache&quot;</span>, isSelect);<br>    <span class="hljs-type">boolean</span> <span class="hljs-variable">resultOrdered</span> <span class="hljs-operator">=</span> context.getBooleanAttribute(<span class="hljs-string">&quot;resultOrdered&quot;</span>, <span class="hljs-literal">false</span>);<br><br>    <span class="hljs-comment">// Include Fragments before parsing</span><br>    <span class="hljs-comment">//在解析sql语句之前先解析&lt;include&gt;节点(查询的结果有哪些参数)</span><br>    <span class="hljs-type">XMLIncludeTransformer</span> <span class="hljs-variable">includeParser</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">XMLIncludeTransformer</span>(configuration, builderAssistant);<br>    includeParser.applyIncludes(context.getNode());<br><br>    <span class="hljs-comment">// Parse selectKey after includes and remove them.</span><br>    <span class="hljs-comment">//在解析sql语句之前，处理&lt;selectKey&gt;子节点，并在xml节点中删除</span><br>    processSelectKeyNodes(id, parameterTypeClass, langDriver);<br><br>    <span class="hljs-comment">// Parse the SQL (pre: &lt;selectKey&gt; and &lt;include&gt; were parsed and removed)</span><br>    <span class="hljs-comment">//解析sql语句是解析mapper.xml的核心，实例化sqlSource，使用sqlSource封装sql语句</span><br>    <span class="hljs-type">SqlSource</span> <span class="hljs-variable">sqlSource</span> <span class="hljs-operator">=</span> langDriver.createSqlSource(configuration, context, parameterTypeClass);<br>    <span class="hljs-comment">//获取resultSets属性</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">resultSets</span> <span class="hljs-operator">=</span> context.getStringAttribute(<span class="hljs-string">&quot;resultSets&quot;</span>);<br>    <span class="hljs-comment">//获取主键信息keyProperty</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">keyProperty</span> <span class="hljs-operator">=</span> context.getStringAttribute(<span class="hljs-string">&quot;keyProperty&quot;</span>);<br>    <span class="hljs-comment">//获取主键信息keyColumn</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">keyColumn</span> <span class="hljs-operator">=</span> context.getStringAttribute(<span class="hljs-string">&quot;keyColumn&quot;</span>);<br><br>    <span class="hljs-comment">//根据&lt;selectKey&gt;获取对应的SelectKeyGenerator的id</span><br>    KeyGenerator keyGenerator;<br>    <span class="hljs-type">String</span> <span class="hljs-variable">keyStatementId</span> <span class="hljs-operator">=</span> id + SelectKeyGenerator.SELECT_KEY_SUFFIX;<br>    keyStatementId = builderAssistant.applyCurrentNamespace(keyStatementId, <span class="hljs-literal">true</span>);<br><br><br>    <span class="hljs-comment">//获取keyGenerator对象，如果是insert类型的sql语句，会使用KeyGenerator接口获取数据库生产的id；</span><br>    <span class="hljs-keyword">if</span> (configuration.hasKeyGenerator(keyStatementId)) &#123;<br>        keyGenerator = configuration.getKeyGenerator(keyStatementId);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        keyGenerator = context.getBooleanAttribute(<span class="hljs-string">&quot;useGeneratedKeys&quot;</span>,<br>                configuration.isUseGeneratedKeys() &amp;&amp; SqlCommandType.INSERT.equals(sqlCommandType))<br>                ? Jdbc3KeyGenerator.INSTANCE : NoKeyGenerator.INSTANCE;<br>    &#125;<br><br>    <span class="hljs-comment">//通过builderAssistant实例化MappedStatement，并注册至configuration对象</span><br>    builderAssistant.addMappedStatement(id, sqlSource, statementType, sqlCommandType,<br>            fetchSize, timeout, parameterMap, parameterTypeClass, resultMap, resultTypeClass,<br>            resultSetTypeEnum, flushCache, useCache, resultOrdered,<br>            keyGenerator, keyProperty, keyColumn, databaseId, langDriver, resultSets);<br>&#125;<br></code></pre></td></tr></table></div></figure><p>总结下它干了哪些活儿：</p><ul><li>解析 &lt;include&gt; 节点</li><li>解析 &lt;selectKey&gt; 节点</li><li>解析 SQL，获取 SqlSource</li><li>构建 MappedStatement 实例</li></ul><p>解析&lt;select&gt;、&lt;insert&gt;、&lt;update&gt;、&lt;delete&gt;这些标签的关键方法在这里</p><figure class="highlight reasonml"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-lr66lrlhkez7dw"></i><span>reasonml</span><div class="collapse show" id="collapse-lr66lrlhkez7dw"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">SqlSource sqlSource = langDriver.create<span class="hljs-constructor">SqlSource(<span class="hljs-params">configuration</span>, <span class="hljs-params">context</span>, <span class="hljs-params">parameterTypeClass</span>)</span>;<br></code></pre></td></tr></table></div></figure><p>看看这个方法的一般实现类XMLScriptBuilder.</p><figure class="highlight java"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-l359n4lhkez7dw"></i><span>java</span><div class="collapse show" id="collapse-l359n4lhkez7dw"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-comment">//解析xml文件中的sql语句并封装成SqlSource</span><br><span class="hljs-keyword">public</span> SqlSource <span class="hljs-title function_">createSqlSource</span><span class="hljs-params">(Configuration configuration, XNode script, Class&lt;?&gt; parameterType)</span> &#123;<br>  <span class="hljs-type">XMLScriptBuilder</span> <span class="hljs-variable">builder</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">XMLScriptBuilder</span>(configuration, script, parameterType);<br>  <span class="hljs-keyword">return</span> builder.parseScriptNode();<br>&#125;<br><br><span class="hljs-comment">//解析sql脚本，返回SqlSource</span><br><span class="hljs-keyword">public</span> SqlSource <span class="hljs-title function_">parseScriptNode</span><span class="hljs-params">()</span> &#123;<br>  <span class="hljs-type">MixedSqlNode</span> <span class="hljs-variable">rootSqlNode</span> <span class="hljs-operator">=</span> parseDynamicTags(context);<br>  <span class="hljs-type">SqlSource</span> <span class="hljs-variable">sqlSource</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>  <span class="hljs-keyword">if</span> (isDynamic) &#123;<br>    sqlSource = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DynamicSqlSource</span>(configuration, rootSqlNode);<span class="hljs-comment">//动态sql的解析</span><br>  &#125; <span class="hljs-keyword">else</span> &#123;<br>    sqlSource = <span class="hljs-keyword">new</span> <span class="hljs-title class_">RawSqlSource</span>(configuration, rootSqlNode, parameterType);<span class="hljs-comment">//非动态sql的解析</span><br>  &#125;<br>  <span class="hljs-comment">//实际返回的都是StaticSqlSource，可以直接让数据库执行的sql语句，包含?占位符</span><br>  <span class="hljs-keyword">return</span> sqlSource;<br>&#125;<br></code></pre></td></tr></table></div></figure><p>方法parseDynamicTags()就是真正去解析sql语句的淫儿了。当执行createSqlSource()方法中的new XMLScriptBuilder(configuration, script, parameterType)时，我们看下，它初始化了些什么东东。<br><img src="https://img-blog.csdnimg.cn/20210316174946741.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2tlemFkZQ==,size_16,color_FFFFFF,t_70"><br>可以看到关键的部分，对于不同的标签，比如&lt;trim&gt;、&lt;where&gt;等，都有不同的处理策略。在执行parseDynamicTags()时，会判断节点是否包含一些动态标记，比如 ${} 占位符以及动态 SQL 节点等。若包含动态标记，则会将 isDynamic 设为 true。后续可根据 isDynamic 创建不同的 SqlSource。<br><img src="https://img-blog.csdnimg.cn/20210315210703601.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2tlemFkZQ==,size_16,color_FFFFFF,t_70"></p><p>通常，我们在xml内写sql都是片段的去编写，主要语句写完了，还会有些动态标签包裹的语句，对于mybatis来说，每个片段都会解析成为一个sqlNode存起来，我们先来回忆一下sqlNode有哪些实现类。<br><img src="https://img-blog.csdnimg.cn/20210315210642589.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2tlemFkZQ==,size_16,color_FFFFFF,t_70"><br>这些 SqlNode 是如何生成的呢？我们看看parseDynamicTags()中的这段代码：</p><figure class="highlight java"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-8fueu8lhkez7dw"></i><span>java</span><div class="collapse show" id="collapse-8fueu8lhkez7dw"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">handler.handleNode(child, contents);<br></code></pre></td></tr></table></div></figure><p>它有很多个实现。<br><img src="https://img-blog.csdnimg.cn/20210316180045568.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2tlemFkZQ==,size_16,color_FFFFFF,t_70"><br>到此 SQL 语句的解析过程搞完了。但我们只是完成了xml解析为sqlSource的流程，而一般sql语句还会有一些附加属性，需要mybatis去解析出来，封装至MappedStatement当中，最终还要把它注册到configuration。回到XMLStatementBuilder的parseStatementNode()方法。<br><img src="https://img-blog.csdnimg.cn/2021031618090324.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2tlemFkZQ==,size_16,color_FFFFFF,t_70"><br>具体方法实现：</p><figure class="highlight java"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-1nclr9lhkez7dw"></i><span>java</span><div class="collapse show" id="collapse-1nclr9lhkez7dw"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//添加MappedStatement对象</span><br><span class="hljs-keyword">public</span> MappedStatement <span class="hljs-title function_">addMappedStatement</span><span class="hljs-params">(</span><br><span class="hljs-params">    String id,</span><br><span class="hljs-params">    SqlSource sqlSource,</span><br><span class="hljs-params">    StatementType statementType,</span><br><span class="hljs-params">    SqlCommandType sqlCommandType,</span><br><span class="hljs-params">    Integer fetchSize,</span><br><span class="hljs-params">    Integer timeout,</span><br><span class="hljs-params">    String parameterMap,</span><br><span class="hljs-params">    Class&lt;?&gt; parameterType,</span><br><span class="hljs-params">    String resultMap,</span><br><span class="hljs-params">    Class&lt;?&gt; resultType,</span><br><span class="hljs-params">    ResultSetType resultSetType,</span><br><span class="hljs-params">    <span class="hljs-type">boolean</span> flushCache,</span><br><span class="hljs-params">    <span class="hljs-type">boolean</span> useCache,</span><br><span class="hljs-params">    <span class="hljs-type">boolean</span> resultOrdered,</span><br><span class="hljs-params">    KeyGenerator keyGenerator,</span><br><span class="hljs-params">    String keyProperty,</span><br><span class="hljs-params">    String keyColumn,</span><br><span class="hljs-params">    String databaseId,</span><br><span class="hljs-params">    LanguageDriver lang,</span><br><span class="hljs-params">    String resultSets)</span> &#123;<br><br>  <span class="hljs-keyword">if</span> (unresolvedCacheRef) &#123;<br>    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IncompleteElementException</span>(<span class="hljs-string">&quot;Cache-ref not yet resolved&quot;</span>);<br>  &#125;<br><br>  id = applyCurrentNamespace(id, <span class="hljs-literal">false</span>);<br>  <span class="hljs-type">boolean</span> <span class="hljs-variable">isSelect</span> <span class="hljs-operator">=</span> sqlCommandType == SqlCommandType.SELECT;<br><br>  <span class="hljs-comment">//使用建造者模式创建一个mappedStatment</span><br>  MappedStatement.<span class="hljs-type">Builder</span> <span class="hljs-variable">statementBuilder</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MappedStatement</span>.Builder(configuration, id, sqlSource, sqlCommandType)<br>      .resource(resource)<br>      .fetchSize(fetchSize)<br>      .timeout(timeout)<br>      .statementType(statementType)<br>      .keyGenerator(keyGenerator)<br>      .keyProperty(keyProperty)<br>      .keyColumn(keyColumn)<br>      .databaseId(databaseId)<br>      .lang(lang)<br>      .resultOrdered(resultOrdered)<br>      .resultSets(resultSets)<br>      .resultMaps(getStatementResultMaps(resultMap, resultType, id))<br>      .resultSetType(resultSetType)<br>      .flushCacheRequired(valueOrDefault(flushCache, !isSelect))<br>      .useCache(valueOrDefault(useCache, isSelect))<br>      .cache(currentCache);<br><br>  <span class="hljs-type">ParameterMap</span> <span class="hljs-variable">statementParameterMap</span> <span class="hljs-operator">=</span> getStatementParameterMap(parameterMap, parameterType, id);<br>  <span class="hljs-keyword">if</span> (statementParameterMap != <span class="hljs-literal">null</span>) &#123;<br>    statementBuilder.parameterMap(statementParameterMap);<br>  &#125;<br>  <span class="hljs-comment">//使用建造者模式创建一个mappedStatment</span><br>  <span class="hljs-type">MappedStatement</span> <span class="hljs-variable">statement</span> <span class="hljs-operator">=</span> statementBuilder.build();<br>  <span class="hljs-comment">//将mappedStatment注册到configuration</span><br>  configuration.addMappedStatement(statement);<br>  <span class="hljs-keyword">return</span> statement;<br>&#125;<br></code></pre></td></tr></table></div></figure><p>以上就是生成MappedStatement的过程。但是还没完，*mapper.java还没有和*mapper.xml对应的sql绑定起来。接下来就是绑定过程了。</p><h1 id="四、Mapper-接口绑定"><a href="#四、Mapper-接口绑定" class="headerlink" title="四、Mapper 接口绑定"></a>四、Mapper 接口绑定</h1><p>返回到XMLMapperBuilder的parse()方法。</p><figure class="highlight java"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-34y0pylhkez7dw"></i><span>java</span><div class="collapse show" id="collapse-34y0pylhkez7dw"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">parse</span><span class="hljs-params">()</span> &#123;<br>   <span class="hljs-comment">//判断是否已经加载该配置文件</span><br>   <span class="hljs-keyword">if</span> (!configuration.isResourceLoaded(resource)) &#123;<br>       configurationElement(parser.evalNode(<span class="hljs-string">&quot;/mapper&quot;</span>));<span class="hljs-comment">//处理mapper节点</span><br>       configuration.addLoadedResource(resource);<span class="hljs-comment">//将mapper文件添加到configuration.loadedResources中</span><br>       bindMapperForNamespace();<span class="hljs-comment">//注册mapper接口</span><br>   &#125;<br>   <span class="hljs-comment">//处理解析失败的ResultMap节点</span><br>   parsePendingResultMaps();<br>   <span class="hljs-comment">//处理解析失败的CacheRef节点</span><br>   parsePendingCacheRefs();<br>   <span class="hljs-comment">//处理解析失败的Sql语句节点</span><br>   parsePendingStatements();<br>&#125;<br></code></pre></td></tr></table></div></figure><p>主要关注这个方法bindMapperForNamespace().</p><figure class="highlight java"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-gerrtvlhkez7dw"></i><span>java</span><div class="collapse show" id="collapse-gerrtvlhkez7dw"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//注册mapper接口</span><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">bindMapperForNamespace</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-comment">//获取命名空间</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">namespace</span> <span class="hljs-operator">=</span> builderAssistant.getCurrentNamespace();<br>    <span class="hljs-keyword">if</span> (namespace != <span class="hljs-literal">null</span>) &#123;<br>        Class&lt;?&gt; boundType = <span class="hljs-literal">null</span>;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-comment">//通过命名空间获取mapper接口的class对象</span><br>            boundType = Resources.classForName(namespace);<br>        &#125; <span class="hljs-keyword">catch</span> (ClassNotFoundException e) &#123;<br>            <span class="hljs-comment">//ignore, bound type is not required</span><br>        &#125;<br>        <span class="hljs-keyword">if</span> (boundType != <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">if</span> (!configuration.hasMapper(boundType)) &#123;<span class="hljs-comment">//是否已经注册过该mapper接口？</span><br>                <span class="hljs-comment">// Spring may not know the real resource name so we set a flag</span><br>                <span class="hljs-comment">// to prevent loading again this resource from the mapper interface</span><br>                <span class="hljs-comment">// look at MapperAnnotationBuilder#loadXmlResource</span><br>                <span class="hljs-comment">//将命名空间添加至configuration.loadedResource集合中</span><br>                configuration.addLoadedResource(<span class="hljs-string">&quot;namespace:&quot;</span> + namespace);<br>                <span class="hljs-comment">//将mapper接口添加到mapper注册中心</span><br>                configuration.addMapper(boundType);<br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></div></figure><p>绑定完正常的节点后，还要处理一些不正常的。</p><figure class="highlight java"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-kp46jolhkez7dw"></i><span>java</span><div class="collapse show" id="collapse-kp46jolhkez7dw"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//处理解析失败的ResultMap节点</span><br>parsePendingResultMaps();<br><span class="hljs-comment">//处理解析失败的CacheRef节点</span><br>parsePendingCacheRefs();<br><span class="hljs-comment">//处理解析失败的Sql语句节点</span><br>parsePendingStatements();<br></code></pre></td></tr></table></div></figure><p>比如这种cacheRef标签</p><figure class="highlight xml"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-lxqgvilhkez7dw"></i><span>xml</span><div class="collapse show" id="collapse-lxqgvilhkez7dw"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!-- 映射文件1 --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">mapper</span> <span class="hljs-attr">namespace</span>=<span class="hljs-string">&quot;com.enjoylearning.mybatis.dao.Mapper1&quot;</span>&gt;</span><br>    <span class="hljs-comment">&lt;!-- 引用映射文件2中配置的缓存 --&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">cache-ref</span> <span class="hljs-attr">namespace</span>=<span class="hljs-string">&quot;com.enjoylearning.mybatis.dao.Mapper2&quot;</span>/&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">mapper</span>&gt;</span><br> <br><span class="hljs-comment">&lt;!-- 映射文件2 --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">mapper</span> <span class="hljs-attr">namespace</span>=<span class="hljs-string">&quot;com.enjoylearning.mybatis.dao.Mapper2&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">cache</span>/&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">mapper</span>&gt;</span><br><br></code></pre></td></tr></table></div></figure><p>Game over.</p>]]></content>
    
    
    <categories>
      
      <category>MyBatis源码学习</category>
      
    </categories>
    
    
    <tags>
      
      <tag>MyBatis</tag>
      
      <tag>源码</tag>
      
      <tag>SQL</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>【MyBatis源码学习】参数解析</title>
    <link href="/posts/232353082.html"/>
    <url>/posts/232353082.html</url>
    
    <content type="html"><![CDATA[<h1 id="一、几种入参形式"><a href="#一、几种入参形式" class="headerlink" title="一、几种入参形式"></a>一、几种入参形式</h1><p>这里只分析带有入参的方法。</p><h2 id="1-单个入参"><a href="#1-单个入参" class="headerlink" title="1.单个入参"></a>1.单个入参</h2><figure class="highlight java"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-4cabeslhkez7dw"></i><span>java</span><div class="collapse show" id="collapse-4cabeslhkez7dw"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">UserInfo <span class="hljs-title function_">selectByPrimaryKey</span><span class="hljs-params">(String id)</span>;<br></code></pre></td></tr></table></div></figure><h2 id="2-多个入参"><a href="#2-多个入参" class="headerlink" title="2.多个入参"></a>2.多个入参</h2><figure class="highlight java"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-fqgbrhlhkez7dw"></i><span>java</span><div class="collapse show" id="collapse-fqgbrhlhkez7dw"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">List&lt;UserInfo&gt; <span class="hljs-title function_">getByOpenIdAndUsername2</span><span class="hljs-params">(<span class="hljs-meta">@Param(&quot;openid&quot;)</span> String openId, <span class="hljs-meta">@Param(&quot;username&quot;)</span> String username)</span>;<br></code></pre></td></tr></table></div></figure><h2 id="3-入参为实体对象"><a href="#3-入参为实体对象" class="headerlink" title="3.入参为实体对象"></a>3.入参为实体对象</h2><figure class="highlight java"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-5nu07vlhkez7dw"></i><span>java</span><div class="collapse show" id="collapse-5nu07vlhkez7dw"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">List&lt;UserInfo&gt; <span class="hljs-title function_">getByOpenIdAndUsername3</span><span class="hljs-params">(UserInfo userInfo)</span>;<br></code></pre></td></tr></table></div></figure><h2 id="4-入参为Map"><a href="#4-入参为Map" class="headerlink" title="4.入参为Map"></a>4.入参为Map</h2><figure class="highlight java"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-3bljollhkez7dw"></i><span>java</span><div class="collapse show" id="collapse-3bljollhkez7dw"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">List&lt;UserInfo&gt; <span class="hljs-title function_">getByOpenIdAndUsername</span><span class="hljs-params">(Map&lt;String, Object&gt; params)</span>;<br></code></pre></td></tr></table></div></figure><h1 id="二、mybatis执行入口"><a href="#二、mybatis执行入口" class="headerlink" title="二、mybatis执行入口"></a>二、mybatis执行入口</h1><p>还是以之前的一个例子来进入我们今天的正题。</p><figure class="highlight java"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-94fzlflhkez7dw"></i><span>java</span><div class="collapse show" id="collapse-94fzlflhkez7dw"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Test</span><br><span class="hljs-comment">// 快速入门</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">quickStart</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>    <span class="hljs-comment">//--------------------第二阶段---------------------------</span><br>    <span class="hljs-comment">// 2.获取sqlSession</span><br>    <span class="hljs-type">SqlSession</span> <span class="hljs-variable">sqlSession</span> <span class="hljs-operator">=</span> sqlSessionFactory.openSession();<br>    <span class="hljs-comment">// 3.获取对应mapper</span><br>    <span class="hljs-type">UserInfoMapper</span> <span class="hljs-variable">mapper</span> <span class="hljs-operator">=</span> sqlSession.getMapper(UserInfoMapper.class);<br>    <span class="hljs-comment">//--------------------第三阶段---------------------------</span><br>    <span class="hljs-comment">// 4.执行查询语句并返回单条数据</span><br>    <span class="hljs-type">UserInfo</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> mapper.selectByPrimaryKey(<span class="hljs-string">&quot;1&quot;</span>);<br>    System.out.println(user);<br>&#125;<br></code></pre></td></tr></table></div></figure><p>当我们执行到这一行时，</p><figure class="highlight java"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-ltl4h2lhkez7dw"></i><span>java</span><div class="collapse show" id="collapse-ltl4h2lhkez7dw"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">UserInfoMapper</span> <span class="hljs-variable">mapper</span> <span class="hljs-operator">=</span> sqlSession.getMapper(UserInfoMapper.class);<br></code></pre></td></tr></table></div></figure><p>通过调试我们可以看到，这个mapper其实是通过MapperProxy代理执行的。我们拿到的其实就是个动态代理对象。如下图：<br><img src="https://img-blog.csdnimg.cn/20210314204651483.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2tlemFkZQ==,size_16,color_FFFFFF,t_70"><br>当我们执行查询时，进入MapperProxy动态代理过程。<br><img src="https://img-blog.csdnimg.cn/2021031420510518.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2tlemFkZQ==,size_16,color_FFFFFF,t_70"><br>最终交由MapperMethod类的execute()方法执行，源代码如下：</p><figure class="highlight java"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-hq98hjlhkez7dw"></i><span>java</span><div class="collapse show" id="collapse-hq98hjlhkez7dw"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//三步翻译在此完成</span><br><span class="hljs-keyword">public</span> Object <span class="hljs-title function_">execute</span><span class="hljs-params">(SqlSession sqlSession, Object[] args)</span> &#123;<br>  Object result;<br>  <span class="hljs-comment">//第一步 根据sql语句类型以及接口返回的参数选择调用不同的方法</span><br>  <span class="hljs-keyword">switch</span> (command.getType()) &#123;<br>    <span class="hljs-keyword">case</span> INSERT: &#123;<br>  <span class="hljs-type">Object</span> <span class="hljs-variable">param</span> <span class="hljs-operator">=</span> method.convertArgsToSqlCommandParam(args);<br>      result = rowCountResult(sqlSession.insert(command.getName(), param));<br>      <span class="hljs-keyword">break</span>;<br>    &#125;<br>    <span class="hljs-keyword">case</span> UPDATE: &#123;<br>      <span class="hljs-type">Object</span> <span class="hljs-variable">param</span> <span class="hljs-operator">=</span> method.convertArgsToSqlCommandParam(args);<br>      result = rowCountResult(sqlSession.update(command.getName(), param));<br>      <span class="hljs-keyword">break</span>;<br>    &#125;<br>    <span class="hljs-keyword">case</span> DELETE: &#123;<br>      <span class="hljs-type">Object</span> <span class="hljs-variable">param</span> <span class="hljs-operator">=</span> method.convertArgsToSqlCommandParam(args);<br>      result = rowCountResult(sqlSession.delete(command.getName(), param));<br>      <span class="hljs-keyword">break</span>;<br>    &#125;<br>    <span class="hljs-keyword">case</span> SELECT:<br>      <span class="hljs-keyword">if</span> (method.returnsVoid() &amp;&amp; method.hasResultHandler()) &#123;<span class="hljs-comment">//返回值为void</span><br>        executeWithResultHandler(sqlSession, args);<br>        result = <span class="hljs-literal">null</span>;<br>      &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (method.returnsMany()) &#123;<span class="hljs-comment">//返回值为集合或者数组</span><br>        result = executeForMany(sqlSession, args);<br>      &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (method.returnsMap()) &#123;<span class="hljs-comment">//返回值为map</span><br>        result = executeForMap(sqlSession, args);<br>      &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (method.returnsCursor()) &#123;<span class="hljs-comment">//返回值为游标</span><br>        result = executeForCursor(sqlSession, args);<br>      &#125; <span class="hljs-keyword">else</span> &#123;<span class="hljs-comment">//处理返回为单一对象的情况</span><br>        <span class="hljs-comment">//通过参数解析器解析解析参数</span><br>        <span class="hljs-type">Object</span> <span class="hljs-variable">param</span> <span class="hljs-operator">=</span> method.convertArgsToSqlCommandParam(args);<span class="hljs-comment">//第三步翻译，将入参转化成Map</span><br>        result = sqlSession.selectOne(command.getName(), param);<br>        <span class="hljs-keyword">if</span> (method.returnsOptional() &amp;&amp;<br>            (result == <span class="hljs-literal">null</span> || !method.getReturnType().equals(result.getClass()))) &#123;<br>          result = OptionalUtil.ofNullable(result);<br>        &#125;<br>      &#125;<br>      <span class="hljs-keyword">break</span>;<br>    <span class="hljs-keyword">case</span> FLUSH:<br>      result = sqlSession.flushStatements();<br>      <span class="hljs-keyword">break</span>;<br>    <span class="hljs-keyword">default</span>:<br>      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BindingException</span>(<span class="hljs-string">&quot;Unknown execution method for: &quot;</span> + command.getName());<br>  &#125;<br>  <span class="hljs-keyword">if</span> (result == <span class="hljs-literal">null</span> &amp;&amp; method.getReturnType().isPrimitive() &amp;&amp; !method.returnsVoid()) &#123;<br>    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BindingException</span>(<span class="hljs-string">&quot;Mapper method &#x27;&quot;</span> + command.getName()<br>        + <span class="hljs-string">&quot; attempted to return null from a method with a primitive return type (&quot;</span> + method.getReturnType() + <span class="hljs-string">&quot;).&quot;</span>);<br>  &#125;<br>  <span class="hljs-keyword">return</span> result;<br>&#125;<br></code></pre></td></tr></table></div></figure><p>所以，本章参数解析的过程，我们重点关注这个方法即可，这个方法就是convertArgsToSqlCommandParam。它其实是方法的参数解析器ParamNameResolver的getNamedParams()方法完成的。<br><img src="https://img-blog.csdnimg.cn/20210314205954450.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2tlemFkZQ==,size_16,color_FFFFFF,t_70"><br>而这个ParamNameResolver则是在MapperProxy获取mapperMethod时（先不说从cache中取）进行初始化的，<br><img src="https://img-blog.csdnimg.cn/20210314211304810.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2tlemFkZQ==,size_16,color_FFFFFF,t_70"><br><img src="https://img-blog.csdnimg.cn/20210314211424528.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2tlemFkZQ==,size_16,color_FFFFFF,t_70"><br><img src="https://img-blog.csdnimg.cn/20210314211600469.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2tlemFkZQ==,size_16,color_FFFFFF,t_70"><br>而ParamNameResolver实例化时，主要工作就是进行初步的映射关系存储，其字段names是一个SortedMap，存储了参数名的顺序映射。</p><figure class="highlight java"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-sy2lnplhkez7dw"></i><span>java</span><div class="collapse show" id="collapse-sy2lnplhkez7dw"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment">   * &lt;p&gt;</span><br><span class="hljs-comment">   * The key is the index and the value is the name of the parameter.&lt;br /&gt;</span><br><span class="hljs-comment">   * The name is obtained from &#123;<span class="hljs-doctag">@link</span> Param&#125; if specified. When &#123;<span class="hljs-doctag">@link</span> Param&#125; is not specified,</span><br><span class="hljs-comment">   * the parameter index is used. Note that this index could be different from the actual index</span><br><span class="hljs-comment">   * when the method has special parameters (i.e. &#123;<span class="hljs-doctag">@link</span> RowBounds&#125; or &#123;<span class="hljs-doctag">@link</span> ResultHandler&#125;).</span><br><span class="hljs-comment">   * &lt;/p&gt;</span><br><span class="hljs-comment">   * &lt;ul&gt;</span><br><span class="hljs-comment">   * &lt;li&gt;aMethod(<span class="hljs-doctag">@Param</span>(&quot;M&quot;) int a, <span class="hljs-doctag">@Param</span>(&quot;N&quot;) int b) -&amp;gt; &#123;&#123;0, &quot;M&quot;&#125;, &#123;1, &quot;N&quot;&#125;&#125;&lt;/li&gt;</span><br><span class="hljs-comment">   * &lt;li&gt;aMethod(int a, int b) -&amp;gt; &#123;&#123;0, &quot;0&quot;&#125;, &#123;1, &quot;1&quot;&#125;&#125;&lt;/li&gt;</span><br><span class="hljs-comment">   * &lt;li&gt;aMethod(int a, RowBounds rb, int b) -&amp;gt; &#123;&#123;0, &quot;0&quot;&#125;, &#123;2, &quot;1&quot;&#125;&#125;&lt;/li&gt;</span><br><span class="hljs-comment">   * &lt;/ul&gt;</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> SortedMap&lt;Integer, String&gt; names;<br></code></pre></td></tr></table></div></figure><p>继续看getNamedParams（）方法。</p><figure class="highlight java"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-r0rvmelhkez7dw"></i><span>java</span><div class="collapse show" id="collapse-r0rvmelhkez7dw"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//将多个参数封装成MAP</span><br><span class="hljs-keyword">public</span> Object <span class="hljs-title function_">getNamedParams</span><span class="hljs-params">(Object[] args)</span> &#123;<br>  <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">paramCount</span> <span class="hljs-operator">=</span> names.size();<br>  <span class="hljs-keyword">if</span> (args == <span class="hljs-literal">null</span> || paramCount == <span class="hljs-number">0</span>) &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>  &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!hasParamAnnotation &amp;&amp; paramCount == <span class="hljs-number">1</span>) &#123;<br>    <span class="hljs-keyword">return</span> args[names.firstKey()];<br>  &#125; <span class="hljs-keyword">else</span> &#123;<br>    <span class="hljs-keyword">final</span> Map&lt;String, Object&gt; param = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ParamMap</span>&lt;&gt;();<br>    <span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">for</span> (Map.Entry&lt;Integer, String&gt; entry : names.entrySet()) &#123;<br>      param.put(entry.getValue(), args[entry.getKey()]);<br>      <span class="hljs-comment">// add generic param names (param1, param2, ...)</span><br>      <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">genericParamName</span> <span class="hljs-operator">=</span> GENERIC_NAME_PREFIX + String.valueOf(i + <span class="hljs-number">1</span>);<br>      <span class="hljs-comment">// ensure not to overwrite parameter named with @Param</span><br>      <span class="hljs-keyword">if</span> (!names.containsValue(genericParamName)) &#123;<br>        param.put(genericParamName, args[entry.getKey()]);<br>      &#125;<br>      i++;<br>    &#125;<br>    <span class="hljs-keyword">return</span> param;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></div></figure><p>本例子中，由于无@Param注解，所以在第二个else if那里就返回了。</p><h1 id="三、参数解析流程"><a href="#三、参数解析流程" class="headerlink" title="三、参数解析流程"></a>三、参数解析流程</h1><p>以下面的代码为例，其他形式的入参大同小异。</p><figure class="highlight java"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-f75fnulhkez7dw"></i><span>java</span><div class="collapse show" id="collapse-f75fnulhkez7dw"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testManyParamQuery</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-comment">// 2.获取sqlSession</span><br>    <span class="hljs-type">SqlSession</span> <span class="hljs-variable">sqlSession</span> <span class="hljs-operator">=</span> sqlSessionFactory.openSession();<br>    <span class="hljs-comment">// 3.获取对应mapper</span><br>    <span class="hljs-type">UserInfoMapper</span> <span class="hljs-variable">mapper</span> <span class="hljs-operator">=</span> sqlSession.getMapper(UserInfoMapper.class);<br>    <span class="hljs-type">String</span> <span class="hljs-variable">username</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;zyx&quot;</span>;<br>    <span class="hljs-type">String</span> <span class="hljs-variable">openId</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;zyxelva&quot;</span>;<br><br>    <span class="hljs-comment">// 第一种方式使用map</span><br>    Map&lt;String, Object&gt; params = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>    params.put(<span class="hljs-string">&quot;username&quot;</span>, username);<br>    params.put(<span class="hljs-string">&quot;openid&quot;</span>, openId);<br>    List&lt;UserInfo&gt; list1 = mapper.getByUsernameAndOpenId(params);<br>    System.out.println(list1);<br>&#125;<br></code></pre></td></tr></table></div></figure><p>对应的mapper.xml方法</p><figure class="highlight xml"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-aaqjw9lhkez7dw"></i><span>xml</span><div class="collapse show" id="collapse-aaqjw9lhkez7dw"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">select</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;getByUsernameAndOpenId&quot;</span> <span class="hljs-attr">resultMap</span>=<span class="hljs-string">&quot;BaseResultMap&quot;</span>&gt;</span><br>   select<br>    <span class="hljs-tag">&lt;<span class="hljs-name">include</span> <span class="hljs-attr">refid</span>=<span class="hljs-string">&quot;Base_Column_List&quot;</span>/&gt;</span><br>    from user_info <br>    where username=#&#123;username&#125; and openid=#&#123;openid&#125;<br><span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span><br></code></pre></td></tr></table></div></figure><p>我们从方法</p><figure class="highlight java"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-glh5m2lhkez7dw"></i><span>java</span><div class="collapse show" id="collapse-glh5m2lhkez7dw"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">List&lt;UserInfo&gt; list1 = mapper.getByUsernameAndOpenId(params);<br></code></pre></td></tr></table></div></figure><p>开始断点调试。我们看到，进入到了MapperProxy的动态代理过程。直接进入mapperMethod.execute(sqlSession, args);</p><p><img src="https://img-blog.csdnimg.cn/20210315111605602.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2tlemFkZQ==,size_16,color_FFFFFF,t_70"><br>来到MapperMethod中的execute方法中。由于我们的例子是查询操作，故进入Select。又例子的返回类型是List,故进入第二个if语句中。<br><img src="https://img-blog.csdnimg.cn/20210315111929562.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2tlemFkZQ==,size_16,color_FFFFFF,t_70"><br><img src="https://img-blog.csdnimg.cn/20210315112106406.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2tlemFkZQ==,size_16,color_FFFFFF,t_70"><br>进入方法executeForMany(). 没有分页，所以进入else语句中。而convertArgsToSqlCommandParam方法我们在二中已经分析了，这里不再具体梳理。<br><img src="https://img-blog.csdnimg.cn/20210315112219141.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2tlemFkZQ==,size_16,color_FFFFFF,t_70"><br>进入DefaultSQLSession的selectList方法中。可以看下statement实际形式是namespace+id，就可以从MappedStatement中获取。<br><img src="https://img-blog.csdnimg.cn/20210315112604497.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2tlemFkZQ==,size_16,color_FFFFFF,t_70"><br>而MappedStatement也有很多信息，主要是<select>标签以及该节点其他重要的属性。<br><img src="https://img-blog.csdnimg.cn/20210315113216306.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2tlemFkZQ==,size_16,color_FFFFFF,t_70"><br>而sql的实际执行者，则为Executor. 代理对象执行方法被拦截器拦截，执行以下方法。<br><img src="https://img-blog.csdnimg.cn/20210315113629172.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2tlemFkZQ==,size_16,color_FFFFFF,t_70"><br>先看看getBoundSql干了啥：<br><img src="https://img-blog.csdnimg.cn/20210315135210374.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2tlemFkZQ==,size_16,color_FFFFFF,t_70"><br><img src="https://img-blog.csdnimg.cn/20210315135542105.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2tlemFkZQ==,size_16,color_FFFFFF,t_70"><br>进入RawSqlSource,因例子的sql无${},无动态SQL节点。<br><img src="https://img-blog.csdnimg.cn/20210315140041749.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2tlemFkZQ==,size_16,color_FFFFFF,t_70"><br>先看看RawSqlSource的构造方法，看看#{}是怎么替换成?的，发现主要是SqlSourceBuilder在干活儿。<br><img src="https://img-blog.csdnimg.cn/20210315141654652.png"><br><img src="https://img-blog.csdnimg.cn/20210315141735671.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2tlemFkZQ==,size_16,color_FFFFFF,t_70"><br>主要看GenericTokenParser.parse().该方法主要完成占位符的定位工作，然后把占位符的替换工作交给与其关联的 TokenHandler 处理.<br><img src="https://img-blog.csdnimg.cn/20210315142304221.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2tlemFkZQ==,size_16,color_FFFFFF,t_70"><br>TokenHandler有四个小弟，<br><img src="https://img-blog.csdnimg.cn/20210315142425559.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2tlemFkZQ==,size_16,color_FFFFFF,t_70"><br>BindingTokenParser：该对象的handleToken方法会取出占位符中的变量，然后使用该变量作为键去上下文环境中寻找对应的值。之后，会用找到的值替换占位符。因此，该对象可以完成占位符的替换工作；<br>DynamicCheckerTokenParser：该对象的 handleToken 方法会置位成员属性isDynamic。因此该对象可以记录自身是否遇到过占位符。<br>ParameterMappingTokenHandler：将DynamicSqlSource和RawSqlSource中的“#{}”符号替换掉，从而将他们转化为StaticSqlSource；<br>VariableTokenHandler：handleToken方法中传入输入参数后，该方法会以输入参数为键尝试从variables属性中寻找对应的值返回。<br><img src="https://img-blog.csdnimg.cn/20210315140144135.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2tlemFkZQ==,size_16,color_FFFFFF,t_70"><br>到此BoundSql的解析过程基本结束。getBoundSql方法执行完后，我们再看看一级缓存的key生成策略。<br><img src="https://img-blog.csdnimg.cn/20210315140541909.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2tlemFkZQ==,size_16,color_FFFFFF,t_70"><br><img src="https://img-blog.csdnimg.cn/20210315140853968.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2tlemFkZQ==,size_16,color_FFFFFF,t_70"></select></p><p>可以看出，cacheKey由namespace的id,分页参数，sql语句，入参以及<environment>节点的信息组成。<br>回到查询过程，实际执行的方法为<br><img src="https://img-blog.csdnimg.cn/20210315113709359.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2tlemFkZQ==,size_16,color_FFFFFF,t_70"><br>而首次查询不会进入if语句，调用BaseExecutor的方法：<br><img src="https://img-blog.csdnimg.cn/20210315113913105.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2tlemFkZQ==,size_16,color_FFFFFF,t_70"><br>本地缓存没有结果，故需要查询数据库，进入queryFromDatabase().<br><img src="https://img-blog.csdnimg.cn/20210315114121102.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2tlemFkZQ==,size_16,color_FFFFFF,t_70"><br>doQuery()则调用的为SimpleExecutor的方法。<br><img src="https://img-blog.csdnimg.cn/20210315114350394.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2tlemFkZQ==,size_16,color_FFFFFF,t_70"><br>看看newStatementHandler()。<br><img src="https://img-blog.csdnimg.cn/20210315114428448.png"><br><img src="https://img-blog.csdnimg.cn/20210315114501949.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2tlemFkZQ==,size_16,color_FFFFFF,t_70"><br>由于我们的例子当中sql带有#{}，故进入PREPARED，生成PreparedStatementHandler。<br>执行完语句后，放入一级缓存。<br><img src="https://img-blog.csdnimg.cn/20210315115037492.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2tlemFkZQ==,size_16,color_FFFFFF,t_70"><br>后续就是结果映射执行过程，这里不再赘述，后续跟上。</environment></p><h1 id="四、总结"><a href="#四、总结" class="headerlink" title="四、总结"></a>四、总结</h1><p>本章主要讲述了mybatis参数解析的过程，重点跟踪了执行sql时，变量占位符${}以及参数占位符#{}的替换和解析过程。实际开发过程中，要注意这两者的区别，能用#{}的地方尽量用#。而${}主要用于order by语句、原生jdbc、表名作参数。</p>]]></content>
    
    
    <categories>
      
      <category>MyBatis源码学习</category>
      
    </categories>
    
    
    <tags>
      
      <tag>MyBatis</tag>
      
      <tag>源码</tag>
      
      <tag>SQL</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>【MyBatis源码学习】代理阶段</title>
    <link href="/posts/567296641.html"/>
    <url>/posts/567296641.html</url>
    
    <content type="html"><![CDATA[<h1 id="一、Mybatis-的接口层"><a href="#一、Mybatis-的接口层" class="headerlink" title="一、Mybatis 的接口层"></a>一、Mybatis 的接口层</h1><h2 id="1-SqlSession"><a href="#1-SqlSession" class="headerlink" title="1.SqlSession"></a>1.SqlSession</h2><p>sqlSession总结<br><img src="https://img-blog.csdnimg.cn/20210312101600300.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2tlemFkZQ==,size_16,color_FFFFFF,t_70" alt="图1"><br>总之一句话：</p><figure class="highlight smali"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-3yd0b5lhkez7dw"></i><span>smali</span><div class="collapse show" id="collapse-3yd0b5lhkez7dw"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs smali">/**<br> * The primary Java interface for working with MyBatis.<br> * Through this interface you can<span class="hljs-built_in"> execute </span>commands, get mappers<span class="hljs-built_in"> and </span>manage transactions.<br> *<br> * @author Clinton Begin<br> */<br></code></pre></td></tr></table></div></figure><p>翻译过来，就是：对外访问统一的接口，通过这些接口，完成读写命令，获取映射和管理事务。</p><p>UML：<br><img src="https://img-blog.csdnimg.cn/20210312102149880.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2tlemFkZQ==,size_16,color_FFFFFF,t_70" alt="图2"><br>SqlSession查询接口嵌套关系<br><img src="https://img-blog.csdnimg.cn/20210312102442855.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2tlemFkZQ==,size_16,color_FFFFFF,t_70" alt="SqlSession查询接口嵌套关系"></p><h2 id="2-SqlSessionFactory"><a href="#2-SqlSessionFactory" class="headerlink" title="2.SqlSessionFactory"></a>2.SqlSessionFactory</h2><p>SqlSessionFactory与SqlSession关系UML图<br><img src="https://img-blog.csdnimg.cn/20210312103052478.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2tlemFkZQ==,size_16,color_FFFFFF,t_70" alt="SqlSessionFactory与SqlSession关系UML图"><br>SqlSessionFactory 使用工厂模式创建SqlSession，其默认的实现类为DefaultSqlSessionFactory，其中获取SqlSession 的核心方法为openSessionFromDataSource(ExecutorType, TransactionIsolationLevel, boolean)，在这个方法中从configuration 中获取的TransactionFactory 是典型的策略模式的应用。运行期，TransactionFactory 接口的实现，是由配置文件配置决定的，可配置选项包括：JDBC、Managed，可根据需求灵活的替换TransactionFactory 的实现。</p><h1 id="二、binding-模块分析"><a href="#二、binding-模块分析" class="headerlink" title="二、binding 模块分析"></a>二、binding 模块分析</h1><h2 id="0-MyBatis两种编程模型"><a href="#0-MyBatis两种编程模型" class="headerlink" title="0.MyBatis两种编程模型"></a>0.MyBatis两种编程模型</h2><p>(1) 使用mapper接口编程，就可以访问数据库；</p><figure class="highlight java"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-ssaxgblhkez7dw"></i><span>java</span><div class="collapse show" id="collapse-ssaxgblhkez7dw"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Test</span><br><span class="hljs-comment">// 程序员喜欢的风格</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">quickStart</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>    <span class="hljs-comment">// 2.获取sqlSession</span><br>    <span class="hljs-type">SqlSession</span> <span class="hljs-variable">sqlSession</span> <span class="hljs-operator">=</span> sqlSessionFactory.openSession();<br>    <span class="hljs-comment">// 3.获取对应mapper</span><br>    <span class="hljs-type">TUserMapper</span> <span class="hljs-variable">mapper</span> <span class="hljs-operator">=</span> sqlSession.getMapper(TUserMapper.class);<br>    <span class="hljs-comment">// 4.执行查询语句并返回单条数据</span><br>    <span class="hljs-type">TUser</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> mapper.selectByPrimaryKey(<span class="hljs-number">2</span>);<br>    System.out.println(user);<br>&#125;<br></code></pre></td></tr></table></div></figure><p>(2) 使用sqlsession对外提供数据库的访问；</p><figure class="highlight java"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-mydf80lhkez7dw"></i><span>java</span><div class="collapse show" id="collapse-mydf80lhkez7dw"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Test</span><br><span class="hljs-comment">// 原始风格，ibatis编程模型 本质分析</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">originalOperation</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>    <span class="hljs-comment">// 2.获取sqlSession</span><br>    <span class="hljs-type">SqlSession</span> <span class="hljs-variable">sqlSession</span> <span class="hljs-operator">=</span> sqlSessionFactory.openSession();<br>    <span class="hljs-comment">// 3.执行查询语句并返回结果</span><br>    <span class="hljs-type">TUser</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> sqlSession.selectOne(<span class="hljs-string">&quot;com.taeyeon.mybatis.mapper.TUserMapper.selectByPrimaryKey&quot;</span>, <span class="hljs-number">2</span>);<br>    System.out.println(user.toString());<br>&#125;<br></code></pre></td></tr></table></div></figure><p>可以比较以下两种编程风格，发现，直接使用SqlSession 进行数据库开发存在代码可读性差、可维护性差的问题，所以我们很少使用，而是使用Mapper接口的方式进行数据库的开发。实现的基础涉及配置文件的解读以及动态代理的运用。</p><h2 id="1-核心类"><a href="#1-核心类" class="headerlink" title="1.核心类"></a>1.核心类</h2><p><img src="https://img-blog.csdnimg.cn/20210312105114200.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2tlemFkZQ==,size_16,color_FFFFFF,t_70" alt="图3"></p><h2 id="2-运行流程"><a href="#2-运行流程" class="headerlink" title="2.运行流程"></a>2.运行流程</h2><p><img src="https://img-blog.csdnimg.cn/20210312105706612.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2tlemFkZQ==,size_16,color_FFFFFF,t_70" alt="图4"></p><h1 id="三、举个栗子"><a href="#三、举个栗子" class="headerlink" title="三、举个栗子"></a>三、举个栗子</h1><p>demo如下：</p><figure class="highlight java"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-rvdfe3lhkez7dw"></i><span>java</span><div class="collapse show" id="collapse-rvdfe3lhkez7dw"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Test</span><br><span class="hljs-comment">// 程序员喜欢的风格</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">quickStart</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>    <span class="hljs-comment">// 2.获取sqlSession</span><br>    <span class="hljs-type">SqlSession</span> <span class="hljs-variable">sqlSession</span> <span class="hljs-operator">=</span> sqlSessionFactory.openSession();<br>    <span class="hljs-comment">// 3.获取对应mapper</span><br>    <span class="hljs-type">TUserMapper</span> <span class="hljs-variable">mapper</span> <span class="hljs-operator">=</span> sqlSession.getMapper(TUserMapper.class);<br>    <span class="hljs-comment">// 4.执行查询语句并返回单条数据</span><br>    <span class="hljs-type">TUser</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> mapper.selectByPrimaryKey(<span class="hljs-number">2</span>);<br>    System.out.println(user);<br>&#125;<br></code></pre></td></tr></table></div></figure><h2 id="1-打开一个会话"><a href="#1-打开一个会话" class="headerlink" title="1.打开一个会话"></a>1.打开一个会话</h2><figure class="highlight java"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-s7ncqklhkez7dw"></i><span>java</span><div class="collapse show" id="collapse-s7ncqklhkez7dw"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">SqlSession</span> <span class="hljs-variable">sqlSession</span> <span class="hljs-operator">=</span> sqlSessionFactory.openSession();<br></code></pre></td></tr></table></div></figure><h2 id="2-DefaultSqlSessionFactory"><a href="#2-DefaultSqlSessionFactory" class="headerlink" title="2.DefaultSqlSessionFactory"></a>2.DefaultSqlSessionFactory</h2><p>有两个实现类，主要看DefaultSqlSessionFactory.<br><img src="https://img-blog.csdnimg.cn/2021031211034090.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2tlemFkZQ==,size_16,color_FFFFFF,t_70" alt="图5"></p><p>点进去看看openSession的方法内容</p><figure class="highlight java"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-zgmb9elhkez7dw"></i><span>java</span><div class="collapse show" id="collapse-zgmb9elhkez7dw"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> SqlSession <span class="hljs-title function_">openSession</span><span class="hljs-params">()</span> &#123;<br>  <span class="hljs-keyword">return</span> openSessionFromDataSource(configuration.getDefaultExecutorType(), <span class="hljs-literal">null</span>, <span class="hljs-literal">false</span>);<br>&#125;<br></code></pre></td></tr></table></div></figure><p>关键瞧瞧openSessionFromDataSource这个方法干了什么。</p><figure class="highlight java"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-wea5jvlhkez7dw"></i><span>java</span><div class="collapse show" id="collapse-wea5jvlhkez7dw"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment">  * 从数据源获取数据库连接</span><br><span class="hljs-comment">  *</span><br><span class="hljs-comment">  * <span class="hljs-doctag">@param</span> execType   执行类型，ExecutorType主要有三种类型：SIMPLE, REUSE, BATCH，默认是SIMPLE，都在枚举类ExecutorType里面</span><br><span class="hljs-comment">  * <span class="hljs-doctag">@param</span> level      事务隔离级别，都在枚举类TransactionIsolationLevel中定义</span><br><span class="hljs-comment">  * <span class="hljs-doctag">@param</span> autoCommit 是否自动提交，主要是事务提交的设置</span><br><span class="hljs-comment">  * <span class="hljs-doctag">@return</span> SqlSession</span><br><span class="hljs-comment">  */</span><br> <span class="hljs-keyword">private</span> SqlSession <span class="hljs-title function_">openSessionFromDataSource</span><span class="hljs-params">(ExecutorType execType, TransactionIsolationLevel level, <span class="hljs-type">boolean</span> autoCommit)</span> &#123;<br>   <span class="hljs-type">Transaction</span> <span class="hljs-variable">tx</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>   <span class="hljs-keyword">try</span> &#123;<br>   <span class="hljs-comment">//获取mybatis配置文件中的environment对象</span><br>     <span class="hljs-keyword">final</span> <span class="hljs-type">Environment</span> <span class="hljs-variable">environment</span> <span class="hljs-operator">=</span> configuration.getEnvironment();<br>     <span class="hljs-comment">//从environment获取transactionFactory对象</span><br>     <span class="hljs-keyword">final</span> <span class="hljs-type">TransactionFactory</span> <span class="hljs-variable">transactionFactory</span> <span class="hljs-operator">=</span> getTransactionFactoryFromEnvironment(environment);<br>     <span class="hljs-comment">//创建事务对象</span><br>     tx = transactionFactory.newTransaction(environment.getDataSource(), level, autoCommit);<br>     <span class="hljs-comment">//根据配置创建executor</span><br>     <span class="hljs-keyword">final</span> <span class="hljs-type">Executor</span> <span class="hljs-variable">executor</span> <span class="hljs-operator">=</span> configuration.newExecutor(tx, execType);<br>     <span class="hljs-comment">//创建DefaultSqlSession</span><br>     <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultSqlSession</span>(configuration, executor, autoCommit);<br>   &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>     <span class="hljs-comment">// may have fetched a connection so lets call close()</span><br>     closeTransaction(tx);<br>     <span class="hljs-keyword">throw</span> ExceptionFactory.wrapException(<span class="hljs-string">&quot;Error opening session.  Cause: &quot;</span> + e, e);<br>   &#125; <span class="hljs-keyword">finally</span> &#123;<br>     ErrorContext.instance().reset();<br>   &#125;<br> &#125;<br></code></pre></td></tr></table></div></figure><p>重点看看新创建的执行器和DefaultSqlSession。</p><h2 id="3-newExecutor"><a href="#3-newExecutor" class="headerlink" title="3.newExecutor"></a>3.newExecutor</h2><figure class="highlight java"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-6666zslhkez7dw"></i><span>java</span><div class="collapse show" id="collapse-6666zslhkez7dw"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> Executor <span class="hljs-title function_">newExecutor</span><span class="hljs-params">(Transaction transaction, ExecutorType executorType)</span> &#123;<br>    executorType = executorType == <span class="hljs-literal">null</span> ? defaultExecutorType : executorType;<br>    executorType = executorType == <span class="hljs-literal">null</span> ? ExecutorType.SIMPLE : executorType;<br>    Executor executor;<br>    <span class="hljs-comment">//BatchExecutor、SimpleExecutor和CachingExecutor三者之一</span><br>    <span class="hljs-keyword">if</span> (ExecutorType.BATCH == executorType) &#123;<br>      executor = <span class="hljs-keyword">new</span> <span class="hljs-title class_">BatchExecutor</span>(<span class="hljs-built_in">this</span>, transaction);<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (ExecutorType.REUSE == executorType) &#123;<br>      executor = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReuseExecutor</span>(<span class="hljs-built_in">this</span>, transaction);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      executor = <span class="hljs-keyword">new</span> <span class="hljs-title class_">SimpleExecutor</span>(<span class="hljs-built_in">this</span>, transaction);<br>    &#125;<br>    <span class="hljs-comment">//如果有&lt;cache&gt;节点，通过装饰器，添加二级缓存的能力</span><br>    <span class="hljs-keyword">if</span> (cacheEnabled) &#123;<br>      executor = <span class="hljs-keyword">new</span> <span class="hljs-title class_">CachingExecutor</span>(executor);<br>    &#125;<br>    <span class="hljs-comment">//通过interceptorChain遍历所有的插件为executor增强，添加插件的功能</span><br>    executor = (Executor) interceptorChain.pluginAll(executor);<br>    <span class="hljs-keyword">return</span> executor;<br>  &#125;<br></code></pre></td></tr></table></div></figure><h2 id="4-DefaultSqlSession"><a href="#4-DefaultSqlSession" class="headerlink" title="4.DefaultSqlSession"></a>4.DefaultSqlSession</h2><p>再去瞄下DefaultSqlSession干了啥。</p><figure class="highlight java"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-mobmizlhkez7dw"></i><span>java</span><div class="collapse show" id="collapse-mobmizlhkez7dw"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-title function_">DefaultSqlSession</span><span class="hljs-params">(Configuration configuration, Executor executor, <span class="hljs-type">boolean</span> autoCommit)</span> &#123;<br>  <span class="hljs-built_in">this</span>.configuration = configuration;<br>  <span class="hljs-built_in">this</span>.executor = executor;<br>  <span class="hljs-built_in">this</span>.dirty = <span class="hljs-literal">false</span>;<br>  <span class="hljs-built_in">this</span>.autoCommit = autoCommit;<br>&#125;<br></code></pre></td></tr></table></div></figure><p>DefaultSqlSession实现了SqlSession的方法。<br><img src="https://img-blog.csdnimg.cn/20210312111811946.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2tlemFkZQ==,size_16,color_FFFFFF,t_70" alt="图6"><br>当执行以下代码时，调用的其实就是DefaultSqlSession类的selectOne方法（最终调用该类下的selectList方法）：</p><figure class="highlight java"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-bsnd3alhkez7dw"></i><span>java</span><div class="collapse show" id="collapse-bsnd3alhkez7dw"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> &lt;T&gt; T <span class="hljs-title function_">selectOne</span><span class="hljs-params">(String statement, Object parameter)</span> &#123;<br>  <span class="hljs-comment">// Popular vote was to return null on 0 results and throw exception on too many.</span><br>  List&lt;T&gt; list = <span class="hljs-built_in">this</span>.&lt;T&gt;selectList(statement, parameter);<br>  <span class="hljs-keyword">if</span> (list.size() == <span class="hljs-number">1</span>) &#123;<br>    <span class="hljs-keyword">return</span> list.get(<span class="hljs-number">0</span>);<br>  &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (list.size() &gt; <span class="hljs-number">1</span>) &#123;<br>    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TooManyResultsException</span>(<span class="hljs-string">&quot;Expected one result (or null) to be returned by selectOne(), but found: &quot;</span> + list.size());<br>  &#125; <span class="hljs-keyword">else</span> &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>  &#125;<br>&#125;<br><br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> &lt;E&gt; List&lt;E&gt; <span class="hljs-title function_">selectList</span><span class="hljs-params">(String statement, Object parameter, RowBounds rowBounds)</span> &#123;<br>  <span class="hljs-keyword">try</span> &#123;<br>    <span class="hljs-comment">//从configuration中获取要执行的sql语句的配置信息</span><br>    <span class="hljs-type">MappedStatement</span> <span class="hljs-variable">ms</span> <span class="hljs-operator">=</span> configuration.getMappedStatement(statement);<br>    <span class="hljs-comment">//通过executor执行语句，并返回指定的结果集</span><br>    <span class="hljs-keyword">return</span> executor.query(ms, wrapCollection(parameter), rowBounds, Executor.NO_RESULT_HANDLER);<br>  &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>    <span class="hljs-keyword">throw</span> ExceptionFactory.wrapException(<span class="hljs-string">&quot;Error querying database.  Cause: &quot;</span> + e, e);<br>  &#125; <span class="hljs-keyword">finally</span> &#123;<br>    ErrorContext.instance().reset();<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></div></figure><h2 id="5-Executor"><a href="#5-Executor" class="headerlink" title="5.Executor"></a>5.Executor</h2><p>先大致了解下Executor的类继承关系。<br><img src="https://img-blog.csdnimg.cn/20210312112927579.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2tlemFkZQ==,size_16,color_FFFFFF,t_70" alt="图7"><br>所以，我们重点看看这段代码的奥秘。</p><figure class="highlight java"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-l4q31ulhkez7dw"></i><span>java</span><div class="collapse show" id="collapse-l4q31ulhkez7dw"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">return</span> executor.query(ms, wrapCollection(parameter), rowBounds, Executor.NO_RESULT_HANDLER);<br></code></pre></td></tr></table></div></figure><p>先看BaseExecutor.</p><figure class="highlight java"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-4zfnv5lhkez7dw"></i><span>java</span><div class="collapse show" id="collapse-4zfnv5lhkez7dw"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> &lt;E&gt; List&lt;E&gt; <span class="hljs-title function_">query</span><span class="hljs-params">(MappedStatement ms, Object parameter, RowBounds rowBounds, ResultHandler resultHandler)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br><span class="hljs-comment">//获取sql语句信息，包括占位符，参数等信息</span><br>  <span class="hljs-type">BoundSql</span> <span class="hljs-variable">boundSql</span> <span class="hljs-operator">=</span> ms.getBoundSql(parameter);<br>  <span class="hljs-comment">//拼装缓存的key值，这里后续讲讲key的生成规则</span><br>  <span class="hljs-type">CacheKey</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> createCacheKey(ms, parameter, rowBounds, boundSql);<br>  <span class="hljs-keyword">return</span> query(ms, parameter, rowBounds, resultHandler, key, boundSql);<br>&#125;<br><br><span class="hljs-meta">@SuppressWarnings(&quot;unchecked&quot;)</span><br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> &lt;E&gt; List&lt;E&gt; <span class="hljs-title function_">query</span><span class="hljs-params">(MappedStatement ms, Object parameter, RowBounds rowBounds, ResultHandler resultHandler, CacheKey key, BoundSql boundSql)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>  ErrorContext.instance().resource(ms.getResource()).activity(<span class="hljs-string">&quot;executing a query&quot;</span>).object(ms.getId());<br>  <span class="hljs-keyword">if</span> (closed) &#123;<span class="hljs-comment">//检查当前executor是否关闭</span><br>    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ExecutorException</span>(<span class="hljs-string">&quot;Executor was closed.&quot;</span>);<br>  &#125;<br>  <span class="hljs-keyword">if</span> (queryStack == <span class="hljs-number">0</span> &amp;&amp; ms.isFlushCacheRequired()) &#123;<span class="hljs-comment">//非嵌套查询，并且FlushCache配置为true，则需要清空一级缓存</span><br>    clearLocalCache();<br>  &#125;<br>  List&lt;E&gt; list;<br>  <span class="hljs-keyword">try</span> &#123;<br>    queryStack++;<span class="hljs-comment">//查询层次加一</span><br>    list = resultHandler == <span class="hljs-literal">null</span> ? (List&lt;E&gt;) localCache.getObject(key) : <span class="hljs-literal">null</span>;<span class="hljs-comment">//查询以及缓存</span><br>    <span class="hljs-keyword">if</span> (list != <span class="hljs-literal">null</span>) &#123;<br>   <span class="hljs-comment">//针对调用存储过程的结果处理</span><br>      handleLocallyCachedOutputParameters(ms, key, parameter, boundSql);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>   <span class="hljs-comment">//缓存未命中，从数据库加载数据</span><br>      list = queryFromDatabase(ms, parameter, rowBounds, resultHandler, key, boundSql);<br>    &#125;<br>  &#125; <span class="hljs-keyword">finally</span> &#123;<br>    queryStack--;<br>  &#125;<br>  <span class="hljs-keyword">if</span> (queryStack == <span class="hljs-number">0</span>) &#123;<br>    <span class="hljs-keyword">for</span> (DeferredLoad deferredLoad : deferredLoads) &#123;<span class="hljs-comment">//延迟加载处理</span><br>      deferredLoad.load();<br>    &#125;<br>    <span class="hljs-comment">// issue #601</span><br>    deferredLoads.clear();<br>    <span class="hljs-keyword">if</span> (configuration.getLocalCacheScope() == LocalCacheScope.STATEMENT) &#123;<span class="hljs-comment">//如果当前sql的一级缓存配置为STATEMENT，查询完既清空一集缓存</span><br>      <span class="hljs-comment">// issue #482</span><br>      clearLocalCache();<br>    &#125;<br>  &#125;<br>  <span class="hljs-keyword">return</span> list;<br>&#125;<br></code></pre></td></tr></table></div></figure><p>我们先看缓存未命中的部分，即queryFromDatabase方法。</p><figure class="highlight java"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-lr3uiylhkez7dw"></i><span>java</span><div class="collapse show" id="collapse-lr3uiylhkez7dw"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//真正访问数据库获取结果的方法</span><br><span class="hljs-keyword">private</span> &lt;E&gt; List&lt;E&gt; <span class="hljs-title function_">queryFromDatabase</span><span class="hljs-params">(MappedStatement ms, Object parameter, RowBounds rowBounds, ResultHandler resultHandler, CacheKey key, BoundSql boundSql)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>  List&lt;E&gt; list;<br>  localCache.putObject(key, EXECUTION_PLACEHOLDER);<span class="hljs-comment">//在缓存中添加占位符</span><br>  <span class="hljs-keyword">try</span> &#123;<br>    <span class="hljs-comment">//调用抽象方法doQuery，方法查询数据库并返回结果，可选的实现包括：simple、reuse、batch</span><br>    list = doQuery(ms, parameter, rowBounds, resultHandler, boundSql);<br>  &#125; <span class="hljs-keyword">finally</span> &#123;<br>    localCache.removeObject(key);<span class="hljs-comment">//在缓存中删除占位符</span><br>  &#125;<br>  localCache.putObject(key, list);<span class="hljs-comment">//将真正的结果对象添加到一级缓存</span><br>  <span class="hljs-keyword">if</span> (ms.getStatementType() == StatementType.CALLABLE) &#123;<span class="hljs-comment">//如果是调用存储过程</span><br>    localOutputParameterCache.putObject(key, parameter);<span class="hljs-comment">//缓存输出类型结果参数</span><br>  &#125;<br>  <span class="hljs-keyword">return</span> list;<br>&#125;<br></code></pre></td></tr></table></div></figure><p>其最终调用SimpleExecutor的doQuery方法。</p><figure class="highlight java"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-fcoftzlhkez7dw"></i><span>java</span><div class="collapse show" id="collapse-fcoftzlhkez7dw"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-comment">//查询的实现</span><br><span class="hljs-keyword">public</span> &lt;E&gt; List&lt;E&gt; <span class="hljs-title function_">doQuery</span><span class="hljs-params">(MappedStatement ms, Object parameter, RowBounds rowBounds, ResultHandler resultHandler, BoundSql boundSql)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>  <span class="hljs-type">Statement</span> <span class="hljs-variable">stmt</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>  <span class="hljs-keyword">try</span> &#123;<br>    <span class="hljs-comment">//获取configuration对象</span><br>    <span class="hljs-type">Configuration</span> <span class="hljs-variable">configuration</span> <span class="hljs-operator">=</span> ms.getConfiguration();<br>    <span class="hljs-comment">//创建StatementHandler对象，</span><br>    <span class="hljs-type">StatementHandler</span> <span class="hljs-variable">handler</span> <span class="hljs-operator">=</span> configuration.newStatementHandler(wrapper, ms, parameter, rowBounds, resultHandler, boundSql);<br>    <span class="hljs-comment">//StatementHandler对象创建stmt,并使用parameterHandler对占位符进行处理</span><br>    stmt = prepareStatement(handler, ms.getStatementLog());<br>    <span class="hljs-comment">//通过statementHandler对象调用ResultSetHandler将结果集转化为指定对象返回</span><br>    <span class="hljs-keyword">return</span> handler.&lt;E&gt;query(stmt, resultHandler);<br>  &#125; <span class="hljs-keyword">finally</span> &#123;<br>    closeStatement(stmt);<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></div></figure><p>看看doQuery方法的内部执行步骤：<br>（1）获取配置信息对象。<br>（2）通过配置对象获取一个新的StatementHandler，该类主要用来处理一次SQL操作。<br>（3）预处理StatementHandler对象，得到Statement对象。<br>（4）传入Statement和结果处理对象，通过StatementHandler的query方法来执行SQL，并对执行结果进行处理。</p><p>先看看newStatementHandler干了啥。</p><figure class="highlight java"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-k78didlhkez7dw"></i><span>java</span><div class="collapse show" id="collapse-k78didlhkez7dw"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> StatementHandler <span class="hljs-title function_">newStatementHandler</span><span class="hljs-params">(Executor executor, MappedStatement mappedStatement, Object parameterObject, RowBounds rowBounds, ResultHandler resultHandler, BoundSql boundSql)</span> &#123;<br><span class="hljs-comment">//创建RoutingStatementHandler对象，实际由statmentType来指定真实的StatementHandler来实现</span><br><span class="hljs-type">StatementHandler</span> <span class="hljs-variable">statementHandler</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RoutingStatementHandler</span>(executor, mappedStatement, parameterObject, rowBounds, resultHandler, boundSql);<br><span class="hljs-comment">//加入插件</span><br>  statementHandler = (StatementHandler) interceptorChain.pluginAll(statementHandler);<br>  <span class="hljs-keyword">return</span> statementHandler;<br>&#125;<br></code></pre></td></tr></table></div></figure><p>瞧瞧StatementHandler的小弟们。<br><img src="https://img-blog.csdnimg.cn/20210312114334576.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2tlemFkZQ==,size_16,color_FFFFFF,t_70" alt="图8"><br>总结下StatementHandler是干啥的，以及它的小弟们分别能干啥。<br><img src="https://img-blog.csdnimg.cn/20210312114441395.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2tlemFkZQ==,size_16,color_FFFFFF,t_70" alt="图9"></p><p>再看看prepare干了啥。</p><figure class="highlight java"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-hi5s1plhkez7dw"></i><span>java</span><div class="collapse show" id="collapse-hi5s1plhkez7dw"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">stmt = handler.prepare(connection, transaction.getTimeout());<br></code></pre></td></tr></table></div></figure><p>主要是BaseStatementHandler干活儿.</p><figure class="highlight java"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-ydkm01lhkez7dw"></i><span>java</span><div class="collapse show" id="collapse-ydkm01lhkez7dw"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-comment">//使用模板模式，定义了获取Statement的步骤，其子类实现实例化Statement的具体的方式；</span><br><span class="hljs-keyword">public</span> Statement <span class="hljs-title function_">prepare</span><span class="hljs-params">(Connection connection, Integer transactionTimeout)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>  ErrorContext.instance().sql(boundSql.getSql());<br>  <span class="hljs-type">Statement</span> <span class="hljs-variable">statement</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>  <span class="hljs-keyword">try</span> &#123;<br>    <span class="hljs-comment">//通过不同的子类实例化不同的Statement，分为三类：simple(statement)、prepare(prepareStatement)、callable(CallableStatementHandler)</span><br>    statement = instantiateStatement(connection);<br>    <span class="hljs-comment">//设置超时时间</span><br>    setStatementTimeout(statement, transactionTimeout);<br>    <span class="hljs-comment">//设置数据集大小</span><br>    setFetchSize(statement);<br>    <span class="hljs-keyword">return</span> statement;<br>  &#125; <span class="hljs-keyword">catch</span> (SQLException e) &#123;<br>    closeStatement(statement);<br>    <span class="hljs-keyword">throw</span> e;<br>  &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>    closeStatement(statement);<br>    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ExecutorException</span>(<span class="hljs-string">&quot;Error preparing statement.  Cause: &quot;</span> + e, e);<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></div></figure><p>  最后执行query方法<br>  <figure class="highlight java"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-jrr8ljlhkez7dw"></i><span>java</span><div class="collapse show" id="collapse-jrr8ljlhkez7dw"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">handler.&lt;E&gt;query(stmt, resultHandler);<br></code></pre></td></tr></table></div></figure><br>获得结果集。（这里面有结果集的处理，后续再讲。）</p>]]></content>
    
    
    <categories>
      
      <category>MyBatis源码学习</category>
      
    </categories>
    
    
    <tags>
      
      <tag>MyBatis</tag>
      
      <tag>源码</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>【MyBatis源码学习】初始化阶段</title>
    <link href="/posts/3933706317.html"/>
    <url>/posts/3933706317.html</url>
    
    <content type="html"><![CDATA[<h1 id="一、核心配置类"><a href="#一、核心配置类" class="headerlink" title="一、核心配置类"></a>一、核心配置类</h1><p>XMLConfigBuilder： 主要负责解析mybatis-config.xml；<br>XMLMapperBuilder： 主要负责解析映射配置Mapper.xml 文件；<br>XMLStatementBuilder： 主要负责解析映射配置文件中的SQL 节点<br>三者之间的关系，如下图<br><img src="https://img-blog.csdnimg.cn/20210311160137766.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2tlemFkZQ==,size_16,color_FFFFFF,t_70" alt="核心配置类三剑客关系图"></p><h2 id="1-XMLConfigBuilder"><a href="#1-XMLConfigBuilder" class="headerlink" title="1.XMLConfigBuilder"></a>1.XMLConfigBuilder</h2><p>主要负责解析mybatis关键配置文件mybatis-config.xml，重点关注91行，全局唯一初始化的大配置类。<img src="https://img-blog.csdnimg.cn/20210311161114699.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2tlemFkZQ==,size_16,color_FFFFFF,t_70" alt="图1"><br>面试题经常会问，为啥mybatis的配置类Configuration是单例的？首先我们在BaseBuilder中发现它是final类型的，其次91行是全局唯一初始化它的地方。<br><img src="https://img-blog.csdnimg.cn/20210311161415639.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2tlemFkZQ==,size_16,color_FFFFFF,t_70" alt="图2"></p><h2 id="2-XMLMapperBuilder"><a href="#2-XMLMapperBuilder" class="headerlink" title="2.XMLMapperBuilder"></a>2.XMLMapperBuilder</h2><p>负责解析<em>mapper.xml和</em>mapper.java文件，关键代码<br><img src="https://img-blog.csdnimg.cn/2021031116211879.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2tlemFkZQ==,size_16,color_FFFFFF,t_70" alt="图3"><br>重点关注下configurationElement方法<br><img src="https://img-blog.csdnimg.cn/20210311162203404.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2tlemFkZQ==,size_16,color_FFFFFF,t_70" alt="图4"></p><h2 id="3-XMLStatementBuilder"><a href="#3-XMLStatementBuilder" class="headerlink" title="3.XMLStatementBuilder"></a>3.XMLStatementBuilder</h2><p>主要负责解析*mapper.xml中的select、insert、update、delete标签语句。重点关注下这个方法<br><img src="https://img-blog.csdnimg.cn/2021031116252489.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2tlemFkZQ==,size_16,color_FFFFFF,t_70" alt="图5"></p><h2 id="4-Configuration"><a href="#4-Configuration" class="headerlink" title="4.Configuration"></a>4.Configuration</h2><p><img src="https://img-blog.csdnimg.cn/20210311162859567.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2tlemFkZQ==,size_16,color_FFFFFF,t_70" alt="图6"></p><h1 id="二、源码追踪初始化流程"><a href="#二、源码追踪初始化流程" class="headerlink" title="二、源码追踪初始化流程"></a>二、源码追踪初始化流程</h1><h2 id="1-准备工作"><a href="#1-准备工作" class="headerlink" title="1.准备工作"></a>1.准备工作</h2><p>编写测试类</p><figure class="highlight java"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-3d6t15lhkez7dw"></i><span>java</span><div class="collapse show" id="collapse-3d6t15lhkez7dw"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MybatisDemo</span> &#123;<br><span class="hljs-keyword">private</span> SqlSessionFactory sqlSessionFactory;<br><br><span class="hljs-meta">@Before</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">init</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException &#123;<br><span class="hljs-comment">//--------------------第一阶段---------------------------</span><br>    <span class="hljs-comment">// 1.1 读取mybatis配置文件创SqlSessionFactory</span><br><span class="hljs-type">String</span> <span class="hljs-variable">resource</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;mybatis-config.xml&quot;</span>;<br><span class="hljs-type">InputStream</span> <span class="hljs-variable">inputStream</span> <span class="hljs-operator">=</span> Resources.getResourceAsStream(resource);<br><span class="hljs-comment">// 1.2 读取mybatis配置文件创SqlSessionFactory</span><br>sqlSessionFactory = <span class="hljs-keyword">new</span> <span class="hljs-title class_">SqlSessionFactoryBuilder</span>().build(inputStream);<br>inputStream.close();<br>&#125;<br>&#125;<br></code></pre></td></tr></table></div></figure><h2 id="2-源码分析"><a href="#2-源码分析" class="headerlink" title="2.源码分析"></a>2.源码分析</h2><h3 id="2-1-第一阶段"><a href="#2-1-第一阶段" class="headerlink" title="2.1.第一阶段"></a>2.1.第一阶段</h3><h4 id="2-1-1-生成SqlSessionFactory"><a href="#2-1-1-生成SqlSessionFactory" class="headerlink" title="2.1.1.生成SqlSessionFactory"></a>2.1.1.生成SqlSessionFactory</h4><figure class="highlight java"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-dapc38lhkez7dw"></i><span>java</span><div class="collapse show" id="collapse-dapc38lhkez7dw"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 1.1 读取mybatis配置文件创SqlSessionFactory</span><br><span class="hljs-type">String</span> <span class="hljs-variable">resource</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;mybatis-config.xml&quot;</span>;<br><span class="hljs-type">InputStream</span> <span class="hljs-variable">inputStream</span> <span class="hljs-operator">=</span> Resources.getResourceAsStream(resource);<br></code></pre></td></tr></table></div></figure><p>读取Mybaits的主配置配置文件，并返回该文件的输入流，我们知道Mybatis所有的SQL语句都写在XML配置文件里面,所以第一步就需要读取这些XML配置文件，这个不难理解，关键是读取文件后怎么存。</p><figure class="highlight java"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-ifyc2tlhkez7dw"></i><span>java</span><div class="collapse show" id="collapse-ifyc2tlhkez7dw"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 1.2 读取mybatis配置文件创SqlSessionFactory</span><br>sqlSessionFactory = <span class="hljs-keyword">new</span> <span class="hljs-title class_">SqlSessionFactoryBuilder</span>().build(inputStream);<br></code></pre></td></tr></table></div></figure><p>读取配置文件流并将这些配置信息存放到Configuration类中.</p><h4 id="2-1-2-解析配置，生成configuration对象"><a href="#2-1-2-解析配置，生成configuration对象" class="headerlink" title="2.1.2.解析配置，生成configuration对象"></a>2.1.2.解析配置，生成configuration对象</h4><p>重点关注下SqlSessionFactoryBuilder的build方法，主要分为两类：</p><figure class="highlight java"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-gxaq5olhkez7dw"></i><span>java</span><div class="collapse show" id="collapse-gxaq5olhkez7dw"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//字符流</span><br>SqlSessionFactory <span class="hljs-title function_">build</span><span class="hljs-params">(Reader reader)</span>;<br>SqlSessionFactory <span class="hljs-title function_">build</span><span class="hljs-params">(Reader reader, String environment)</span>;<br>SqlSessionFactory <span class="hljs-title function_">build</span><span class="hljs-params">(Reader reader, Properties properties)</span>;<br>SqlSessionFactory <span class="hljs-title function_">build</span><span class="hljs-params">(Reader reader, String environment, Properties properties)</span>;<br><span class="hljs-comment">//字节流</span><br>SqlSessionFactory <span class="hljs-title function_">build</span><span class="hljs-params">(InputStream inputStream)</span>;<br>SqlSessionFactory <span class="hljs-title function_">build</span><span class="hljs-params">(InputStream inputStream, String environment)</span>;<br>SqlSessionFactory <span class="hljs-title function_">build</span><span class="hljs-params">(InputStream inputStream, Properties properties)</span>;<br>SqlSessionFactory <span class="hljs-title function_">build</span><span class="hljs-params">(InputStream inputStream, String environment, Properties properties)</span>;<br></code></pre></td></tr></table></div></figure><p>我们只看InputStream对应的build方法即可，顺带一提的是，其实我们可以通过</p><figure class="highlight java"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-zrwuzdlhkez7dw"></i><span>java</span><div class="collapse show" id="collapse-zrwuzdlhkez7dw"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">Reader reader=<span class="hljs-keyword">new</span> <span class="hljs-title class_">InputStreamReader</span>(inputStream);<br></code></pre></td></tr></table></div></figure><p>来将Inputstream转换为Reader对象。</p><figure class="highlight java"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-25cbk6lhkez7dw"></i><span>java</span><div class="collapse show" id="collapse-25cbk6lhkez7dw"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment">  * 通过字节流创建 SqlSessionFactory</span><br><span class="hljs-comment">  *</span><br><span class="hljs-comment">  * <span class="hljs-doctag">@param</span> inputStream mybatis配置文件对应的字节流（可以通过Reader reader=new InputStreamReader(inputStream);来将Inputstream转换为Reader对象）</span><br><span class="hljs-comment">  * <span class="hljs-doctag">@param</span> environment 指定当前使用的环境标志</span><br><span class="hljs-comment">  * <span class="hljs-doctag">@param</span> properties  用户自定义的属性对象</span><br><span class="hljs-comment">  * <span class="hljs-doctag">@return</span> SqlSessionFactory</span><br><span class="hljs-comment">  */</span><br> <span class="hljs-keyword">public</span> SqlSessionFactory <span class="hljs-title function_">build</span><span class="hljs-params">(InputStream inputStream, String environment, Properties properties)</span> &#123;<br>     <span class="hljs-keyword">try</span> &#123;<br>         <span class="hljs-type">XMLConfigBuilder</span> <span class="hljs-variable">parser</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">XMLConfigBuilder</span>(inputStream, environment, properties);<br>         <span class="hljs-keyword">return</span> build(parser.parse());<br>     &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>         <span class="hljs-keyword">throw</span> ExceptionFactory.wrapException(<span class="hljs-string">&quot;Error building SqlSession.&quot;</span>, e);<br>     &#125; <span class="hljs-keyword">finally</span> &#123;<br>         ErrorContext.instance().reset();<br>         <span class="hljs-keyword">try</span> &#123;<br>             inputStream.close();<br>         &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>             <span class="hljs-comment">// Intentionally ignore. Prefer previous error.</span><br>         &#125;<br>     &#125;<br> &#125;<br></code></pre></td></tr></table></div></figure><p>点进去XMLConfigBuilder的构造方法</p><figure class="highlight java"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-ria4ynlhkez7dw"></i><span>java</span><div class="collapse show" id="collapse-ria4ynlhkez7dw"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-title function_">XMLConfigBuilder</span><span class="hljs-params">(XPathParser parser, String environment, Properties props)</span> &#123;<br><span class="hljs-comment">//重点地方，全局唯一构造Configuration对象的地方</span><br>    <span class="hljs-built_in">super</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Configuration</span>());<br>    ErrorContext.instance().resource(<span class="hljs-string">&quot;SQL Mapper Configuration&quot;</span>);<br>    <span class="hljs-built_in">this</span>.configuration.setVariables(props);<br>    <span class="hljs-built_in">this</span>.parsed = <span class="hljs-literal">false</span>;<br>    <span class="hljs-built_in">this</span>.environment = environment;<br>    <span class="hljs-built_in">this</span>.parser = parser;<br>  &#125;<br></code></pre></td></tr></table></div></figure><p>再去瞧瞧XMLConfigBuilder的parse方法，重点关注parseConfiguration方法。</p><figure class="highlight java"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-6cypgjlhkez7dw"></i><span>java</span><div class="collapse show" id="collapse-6cypgjlhkez7dw"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> Configuration <span class="hljs-title function_">parse</span><span class="hljs-params">()</span> &#123;<br>  <span class="hljs-keyword">if</span> (parsed) &#123;<br>    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BuilderException</span>(<span class="hljs-string">&quot;Each XMLConfigBuilder can only be used once.&quot;</span>);<br>  &#125;<br>  parsed = <span class="hljs-literal">true</span>;<br>  parseConfiguration(parser.evalNode(<span class="hljs-string">&quot;/configuration&quot;</span>));<br>  <span class="hljs-keyword">return</span> configuration;<br>&#125;<br><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">parseConfiguration</span><span class="hljs-params">(XNode root)</span> &#123;<br>  <span class="hljs-keyword">try</span> &#123;<br>    <span class="hljs-comment">//issue #117 read properties first</span><br>   <span class="hljs-comment">//解析&lt;properties&gt;节点</span><br>    propertiesElement(root.evalNode(<span class="hljs-string">&quot;properties&quot;</span>));<br>    <span class="hljs-comment">//解析&lt;settings&gt;节点</span><br>    <span class="hljs-type">Properties</span> <span class="hljs-variable">settings</span> <span class="hljs-operator">=</span> settingsAsProperties(root.evalNode(<span class="hljs-string">&quot;settings&quot;</span>));<br>    loadCustomVfs(settings);<br>    <span class="hljs-comment">//解析&lt;typeAliases&gt;节点</span><br>    typeAliasesElement(root.evalNode(<span class="hljs-string">&quot;typeAliases&quot;</span>));<br>    <span class="hljs-comment">//解析&lt;plugins&gt;节点</span><br>    pluginElement(root.evalNode(<span class="hljs-string">&quot;plugins&quot;</span>));<br>    <span class="hljs-comment">//解析&lt;objectFactory&gt;节点</span><br>    objectFactoryElement(root.evalNode(<span class="hljs-string">&quot;objectFactory&quot;</span>));<br>    <span class="hljs-comment">//解析&lt;objectWrapperFactory&gt;节点</span><br>    objectWrapperFactoryElement(root.evalNode(<span class="hljs-string">&quot;objectWrapperFactory&quot;</span>));<br>    <span class="hljs-comment">//解析&lt;reflectorFactory&gt;节点</span><br>    reflectorFactoryElement(root.evalNode(<span class="hljs-string">&quot;reflectorFactory&quot;</span>));<br>    <span class="hljs-comment">//将settings填充到configuration</span><br>    settingsElement(settings);<br>    <span class="hljs-comment">// read it after objectFactory and objectWrapperFactory issue #631</span><br>    <span class="hljs-comment">//解析&lt;environments&gt;节点</span><br>    environmentsElement(root.evalNode(<span class="hljs-string">&quot;environments&quot;</span>));<br>    <span class="hljs-comment">//解析&lt;databaseIdProvider&gt;节点</span><br>    databaseIdProviderElement(root.evalNode(<span class="hljs-string">&quot;databaseIdProvider&quot;</span>));<br>    <span class="hljs-comment">//解析&lt;typeHandlers&gt;节点</span><br>    typeHandlerElement(root.evalNode(<span class="hljs-string">&quot;typeHandlers&quot;</span>));<br>    <span class="hljs-comment">//解析&lt;mappers&gt;节点</span><br>    mapperElement(root.evalNode(<span class="hljs-string">&quot;mappers&quot;</span>));<br>  &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BuilderException</span>(<span class="hljs-string">&quot;Error parsing SQL Mapper Configuration. Cause: &quot;</span> + e, e);<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></div></figure><p>以上是分析</p><figure class="highlight java"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-g8566klhkez7dw"></i><span>java</span><div class="collapse show" id="collapse-g8566klhkez7dw"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">XMLConfigBuilder</span> <span class="hljs-variable">parser</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">XMLConfigBuilder</span>(inputStream, environment, properties);<br><span class="hljs-comment">//解析配置文件得到configuration对象，并返回SqlSessionFactory</span><br><span class="hljs-keyword">return</span> build(parser.parse()); <br></code></pre></td></tr></table></div></figure><p>parser.parse()的部分，下面看看build()部分：</p><figure class="highlight java"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-iatoztlhkez7dw"></i><span>java</span><div class="collapse show" id="collapse-iatoztlhkez7dw"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> SqlSessionFactory <span class="hljs-title function_">build</span><span class="hljs-params">(Configuration config)</span> &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultSqlSessionFactory</span>(config);<br>&#125;<br></code></pre></td></tr></table></div></figure><p>很简单，就是把读取配置文件后的Configuration对象赋给DefaultSqlSessionFactory，返回一个构建好的sqlSessionFactory，而DefaultSqlSessionFactory是SqlSessionFactory的默认实现. </p><h3 id="2-2-第二阶段"><a href="#2-2-第二阶段" class="headerlink" title="2.2.第二阶段"></a>2.2.第二阶段</h3><figure class="highlight java"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-fs6rfqlhkez7dw"></i><span>java</span><div class="collapse show" id="collapse-fs6rfqlhkez7dw"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 2.获取sqlSession</span><br><span class="hljs-type">SqlSession</span> <span class="hljs-variable">sqlSession</span> <span class="hljs-operator">=</span> sqlSessionFactory.openSession();<br></code></pre></td></tr></table></div></figure><p>通过调用DefaultSqlSessionFactory的openSession方法返回一个SqlSession实例,我们看一下具体是怎么得到一个SqlSession实例的。首先调用openSessionFromDataSource方法。<br>摸进去看看openSessionFromDataSource():</p><figure class="highlight java"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-qtpinwlhkez7dw"></i><span>java</span><div class="collapse show" id="collapse-qtpinwlhkez7dw"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment">  * 从数据源获取数据库连接</span><br><span class="hljs-comment">  *</span><br><span class="hljs-comment">  * <span class="hljs-doctag">@param</span> execType   执行类型，ExecutorType主要有三种类型：SIMPLE, REUSE, BATCH，默认是SIMPLE，都在枚举类ExecutorType里面</span><br><span class="hljs-comment">  * <span class="hljs-doctag">@param</span> level      事务隔离级别，都在枚举类TransactionIsolationLevel中定义</span><br><span class="hljs-comment">  * <span class="hljs-doctag">@param</span> autoCommit 是否自动提交，主要是事务提交的设置</span><br><span class="hljs-comment">  * <span class="hljs-doctag">@return</span> SqlSession DefaultSqlSession是SqlSession的实现类，该类主要提供操作数据库的方法给开发人员使用</span><br><span class="hljs-comment">  */</span><br> <span class="hljs-keyword">private</span> SqlSession <span class="hljs-title function_">openSessionFromDataSource</span><span class="hljs-params">(ExecutorType execType, TransactionIsolationLevel level, <span class="hljs-type">boolean</span> autoCommit)</span> &#123;<br>   <span class="hljs-type">Transaction</span> <span class="hljs-variable">tx</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>   <span class="hljs-keyword">try</span> &#123;<br>   <span class="hljs-comment">//获取mybatis配置文件中的environment对象,包括使用哪种数据库，连接数据库的信息，事务</span><br>     <span class="hljs-keyword">final</span> <span class="hljs-type">Environment</span> <span class="hljs-variable">environment</span> <span class="hljs-operator">=</span> configuration.getEnvironment();<br>     <span class="hljs-comment">//从environment获取transactionFactory对象</span><br>     <span class="hljs-keyword">final</span> <span class="hljs-type">TransactionFactory</span> <span class="hljs-variable">transactionFactory</span> <span class="hljs-operator">=</span> getTransactionFactoryFromEnvironment(environment);<br>     <span class="hljs-comment">//创建事务对象</span><br>     tx = transactionFactory.newTransaction(environment.getDataSource(), level, autoCommit);<br>     <span class="hljs-comment">//根据配置创建executor</span><br>     <span class="hljs-keyword">final</span> <span class="hljs-type">Executor</span> <span class="hljs-variable">executor</span> <span class="hljs-operator">=</span> configuration.newExecutor(tx, execType);<br>     <span class="hljs-comment">//创建DefaultSqlSession</span><br>     <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultSqlSession</span>(configuration, executor, autoCommit);<br>   &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>     <span class="hljs-comment">// may have fetched a connection so lets call close()</span><br>     closeTransaction(tx);<br>     <span class="hljs-keyword">throw</span> ExceptionFactory.wrapException(<span class="hljs-string">&quot;Error opening session.  Cause: &quot;</span> + e, e);<br>   &#125; <span class="hljs-keyword">finally</span> &#123;<br>     ErrorContext.instance().reset();<br>   &#125;<br> &#125;<br></code></pre></td></tr></table></div></figure><h1 id="三、总结"><a href="#三、总结" class="headerlink" title="三、总结"></a>三、总结</h1><p>步骤一：读取Mybatis的主配置文件，并将文件读成文件流形式(InputStream)。</p><p>步骤二：从主配置文件流中读取文件的各个节点信息并存放到Configuration对象中。读取mappers节点的引用文件，并将这些文件的各个节点信息存放到Configuration对象。</p><p>步骤三：根据Configuration对象的信息获取数据库连接，并设置连接的事务隔离级别等信息，将经过包装数据库连接对象SqlSession接口返回，DefaultSqlSession是SqlSession的实现类，所以这里返回的是DefaultSqlSession，SqlSession接口里面就是对外提供的各种数据库操作。</p>]]></content>
    
    
    <categories>
      
      <category>MyBatis源码学习</category>
      
    </categories>
    
    
    <tags>
      
      <tag>MyBatis</tag>
      
      <tag>源码</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>【LeetCode】987.二叉树的垂序遍历</title>
    <link href="/posts/2232042003.html"/>
    <url>/posts/2232042003.html</url>
    
    <content type="html"><![CDATA[<h1 id="1-问题"><a href="#1-问题" class="headerlink" title="1.问题"></a>1.问题</h1><p>给你二叉树的根结点 root ，请你设计算法计算二叉树的 垂序遍历 序列。</p><p>对位于 (row, col) 的每个结点而言，其左右子结点分别位于 (row + 1, col - 1) 和 (row + 1, col + 1) 。树的根结点位于 (0, 0) 。</p><p>二叉树的 <strong>垂序遍历</strong> 从最左边的列开始直到最右边的列结束，按列索引每一列上的所有结点，形成一个按出现位置从上到下排序的有序列表。如果同行同列上有多个结点，则按结点的值从小到大进行排序。</p><p>返回二叉树的 <strong>垂序遍历</strong> 序列。</p><h2 id="示例-1"><a href="#示例-1" class="headerlink" title="示例 1"></a>示例 1</h2><p><img src="https://img-blog.csdnimg.cn/img_convert/e04967e5622978d8f038f3f484c96344.jpeg#pic_center" alt="图1"></p><blockquote><p>输入：root &#x3D; [3,9,20,null,null,15,7]<br>输出：[[9],[3,15],[20],[7]]</p></blockquote><p><strong>解释</strong>：<br>列 -1 ：只有结点 9 在此列中。<br>列  0 ：只有结点 3 和 15 在此列中，按从上到下顺序。<br>列  1 ：只有结点 20 在此列中。<br>列  2 ：只有结点 7 在此列中。</p><h2 id="示例-2"><a href="#示例-2" class="headerlink" title="示例 2"></a>示例 2</h2><p><img src="https://img-blog.csdnimg.cn/img_convert/928311391554fa02c32df8d2fe82f29f.jpeg#pic_center" alt="图2"></p><blockquote><p>输入：root &#x3D; [1,2,3,4,5,6,7]<br>输出：[[4],[2],[1,5,6],[3],[7]]</p></blockquote><p><strong>解释</strong>：<br>列 -2 ：只有结点 4 在此列中。<br>列 -1 ：只有结点 2 在此列中。<br>列  0 ：结点 1 、5 和 6 都在此列中。<br>          1 在上面，所以它出现在前面。<br>          5 和 6 位置都是 (2, 0) ，所以按值从小到大排序，5 在 6 的前面。<br>列  1 ：只有结点 3 在此列中。<br>列  2 ：只有结点 7 在此列中。</p><h2 id="示例-3"><a href="#示例-3" class="headerlink" title="示例 3"></a>示例 3</h2><p><img src="https://img-blog.csdnimg.cn/img_convert/21f2fd6f20821d1e1279984777466b85.jpeg#pic_center" alt="图3"></p><blockquote><p>输入：root &#x3D; [1,2,3,4,6,5,7]<br>输出：[[4],[2],[1,5,6],[3],[7]]</p></blockquote><p><strong>解释</strong>：<br>这个示例实际上与示例 2 完全相同，只是结点 5 和 6 在树中的位置发生了交换。<br>因为 5 和 6 的位置仍然相同，所以答案保持不变，仍然按值从小到大排序。</p><p><strong>提示</strong>：</p><ul><li>树中结点数目总数在范围 [1, 1000] 内</li><li>0 &lt;&#x3D; Node.val &lt;&#x3D; 1000</li></ul><h1 id="2-解题思路"><a href="#2-解题思路" class="headerlink" title="2.解题思路"></a>2.解题思路</h1><p>从示例可以得出，最终答案是先按列号从小到大排列，列号相同再按行号从小到大，行号相同再按值从小到大输出。因而我们在遍历二叉树时需要统计各个节点(列号，行号，值)的三元组，然后按照列号、行号、值的升序排列，最后输出结果。</p><ul><li>定义一个map，key为节点，value存储该节点的列号，行号，值</li><li>深度优先算法，遍历各个节点，记录各节点 列号、行号、值，保存至map中</li><li>对map的values按照排序规则进行排序</li></ul><p><strong>复杂度</strong>：</p><ul><li>时间复杂度：令总节点数量为 n，填充哈希表时进行树的遍历，复杂度为 O(n)；构造答案时需要进行排序，复杂度为 O(nlog⁡n)。整体复杂度为 O(nlog⁡n)</li><li>空间复杂度：O(n)</li></ul><h1 id="3-代码"><a href="#3-代码" class="headerlink" title="3.代码"></a>3.代码</h1><figure class="highlight java"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-2g8up0lhkez7dx"></i><span>java</span><div class="collapse show" id="collapse-2g8up0lhkez7dx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Definition for a binary tree node.</span><br><span class="hljs-comment"> * public class TreeNode &#123;</span><br><span class="hljs-comment"> *     int val;</span><br><span class="hljs-comment"> *     TreeNode left;</span><br><span class="hljs-comment"> *     TreeNode right;</span><br><span class="hljs-comment"> *     TreeNode() &#123;&#125;</span><br><span class="hljs-comment"> *     TreeNode(int val) &#123; this.val = val; &#125;</span><br><span class="hljs-comment"> *     TreeNode(int val, TreeNode left, TreeNode right) &#123;</span><br><span class="hljs-comment"> *         this.val = val;</span><br><span class="hljs-comment"> *         this.left = left;</span><br><span class="hljs-comment"> *         this.right = right;</span><br><span class="hljs-comment"> *     &#125;</span><br><span class="hljs-comment"> * &#125;</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Solution</span> &#123;<br>    <span class="hljs-comment">//记录节点 列号、行号、值</span><br>    Map&lt;TreeNode, <span class="hljs-type">int</span>[]&gt; map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>    <span class="hljs-keyword">public</span> List&lt;List&lt;Integer&gt;&gt; <span class="hljs-title function_">verticalTraversal</span><span class="hljs-params">(TreeNode root)</span> &#123;<br>        <span class="hljs-comment">//示例规则，先按列号从小到大排列，列号相同再按行号从小到大，行号相同再按值从小到大输出</span><br>        <span class="hljs-comment">//定义一个map,key为节点，value存储该节点的 列号，行号，值</span><br>        <span class="hljs-comment">//深度优先算法，遍历各个节点，记录各节点 列号、行号、值，保存至map中</span><br>        <span class="hljs-comment">//对map的values按照排序规则进行排序</span><br>        <br>        <span class="hljs-comment">//root - map</span><br>        map.put(root,<span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,root.val&#125;);<br>        dfs(root);<br><br>        <span class="hljs-comment">//各节点 遍历的信息列表</span><br>        List&lt;<span class="hljs-type">int</span>[]&gt; list=<span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;(map.values());<br>        <span class="hljs-comment">//排序</span><br>        Collections.sort(list, (a,b)-&gt;&#123;<br>            <span class="hljs-comment">//优先按列比较</span><br>            <span class="hljs-keyword">if</span>(a[<span class="hljs-number">0</span>]!=b[<span class="hljs-number">0</span>])&#123;<br>                <span class="hljs-keyword">return</span> a[<span class="hljs-number">0</span>]-b[<span class="hljs-number">0</span>];<br>            &#125;<br>            <span class="hljs-comment">//其次 按行号比较</span><br>            <span class="hljs-keyword">if</span>(a[<span class="hljs-number">1</span>]!=b[<span class="hljs-number">1</span>])&#123;<br>                <span class="hljs-keyword">return</span> a[<span class="hljs-number">1</span>]-b[<span class="hljs-number">1</span>];<br>            &#125;<br>            <span class="hljs-comment">//最后，按值比较</span><br>            <span class="hljs-keyword">return</span> a[<span class="hljs-number">2</span>]-b[<span class="hljs-number">2</span>];<br>        &#125;);<br><br>        <span class="hljs-comment">//遍历list，输出结果集</span><br>        List&lt;List&lt;Integer&gt;&gt; res=<span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>        List&lt;Integer&gt; tmp;<br>        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>;i&lt;list.size();)&#123;<br>            <span class="hljs-type">int</span> j=i;<br>            tmp=<span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>            <span class="hljs-comment">//列号相同的</span><br>            <span class="hljs-keyword">while</span>(j&lt;list.size() &amp;&amp; list.get(j)[<span class="hljs-number">0</span>]==list.get(i)[<span class="hljs-number">0</span>])&#123;<br>                tmp.add(list.get(j)[<span class="hljs-number">2</span>]);<br>                j++;<br>            &#125;<br>            res.add(tmp);<br>            i=j;<br>        &#125;<br>        <span class="hljs-keyword">return</span> res;<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">dfs</span><span class="hljs-params">(TreeNode node)</span>&#123;<br>        <span class="hljs-keyword">if</span>(<span class="hljs-literal">null</span>==node)&#123;<br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br>        <span class="hljs-type">int</span>[] nodeColRowVal=map.get(node);<br>        <span class="hljs-type">int</span> nodeCol=nodeColRowVal[<span class="hljs-number">0</span>];<br>        <span class="hljs-type">int</span> nodeRow=nodeColRowVal[<span class="hljs-number">1</span>];<br>        <span class="hljs-type">int</span> value=nodeColRowVal[<span class="hljs-number">2</span>];<br><br>        <span class="hljs-comment">//左子树</span><br>        <span class="hljs-keyword">if</span>(<span class="hljs-literal">null</span>!=node.left)&#123;<br>            map.put(node.left, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;nodeCol-<span class="hljs-number">1</span>, nodeRow+<span class="hljs-number">1</span>, node.left.val&#125;);<br>            dfs(node.left);<br>        &#125;<br><br>        <span class="hljs-comment">//右子树</span><br>        <span class="hljs-keyword">if</span>(<span class="hljs-literal">null</span>!=node.right)&#123;<br>            map.put(node.right, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;nodeCol+<span class="hljs-number">1</span>, nodeRow+<span class="hljs-number">1</span>, node.right.val&#125;);<br>            dfs(node.right);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></div></figure>]]></content>
    
    
    <categories>
      
      <category>算法</category>
      
      <category>二叉树</category>
      
      <category>LeetCode</category>
      
    </categories>
    
    
    <tags>
      
      <tag>二叉树</tag>
      
      <tag>数据结构</tag>
      
      <tag>LeetCode</tag>
      
      <tag>算法</tag>
      
      <tag>Java</tag>
      
      <tag>DFS</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>【LeetCode】103.二叉树的锯齿形层序遍历(之字形遍历)</title>
    <link href="/posts/371555309.html"/>
    <url>/posts/371555309.html</url>
    
    <content type="html"><![CDATA[<h1 id="1-问题"><a href="#1-问题" class="headerlink" title="1.问题"></a>1.问题</h1><p>给你二叉树的根节点 root ，返回其节点值的 锯齿形层序遍历 。（即先从左往右，再从右往左进行下一层遍历，以此类推，层与层之间交替进行）。</p><p>示例 1：</p><p><img src="https://img-blog.csdnimg.cn/img_convert/1e841d2f824fe1aeb776c1755d367ca1.jpeg#pic_center" alt="图1"></p><blockquote><p>输入：root &#x3D; [3,9,20,null,null,15,7]<br>输出：[[3],[20,9],[15,7]]</p></blockquote><p>示例 2：</p><blockquote><p>输入：root &#x3D; [1]<br>输出：[[1]]</p></blockquote><p>示例 3：</p><blockquote><p>输入：root &#x3D; []<br>输出：[]</p></blockquote><p><strong>提示</strong>：</p><ul><li>树中节点数目在范围 [0, 2000] 内</li><li>-100 &lt;&#x3D; Node.val &lt;&#x3D; 100</li></ul><h1 id="2-解题思路"><a href="#2-解题思路" class="headerlink" title="2.解题思路"></a>2.解题思路</h1><p>从结果集来看，该题是<a href="https://zyxelva.github.io/posts/2462725929.html">102.二叉树的层序遍历</a>，<a href="https://zyxelva.github.io/posts/2499526336.html">107.二叉树的层序遍历II</a>的结合，每层既有正序输出，又有逆序输出。只要给定一个标识，奇数层正序输出，而偶数层逆序输出即可解决。</p><h1 id="3-代码"><a href="#3-代码" class="headerlink" title="3.代码"></a>3.代码</h1><figure class="highlight java"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-87e2ttlhkez7dx"></i><span>java</span><div class="collapse show" id="collapse-87e2ttlhkez7dx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Definition for a binary tree node.</span><br><span class="hljs-comment"> * public class TreeNode &#123;</span><br><span class="hljs-comment"> *     int val;</span><br><span class="hljs-comment"> *     TreeNode left;</span><br><span class="hljs-comment"> *     TreeNode right;</span><br><span class="hljs-comment"> *     TreeNode() &#123;&#125;</span><br><span class="hljs-comment"> *     TreeNode(int val) &#123; this.val = val; &#125;</span><br><span class="hljs-comment"> *     TreeNode(int val, TreeNode left, TreeNode right) &#123;</span><br><span class="hljs-comment"> *         this.val = val;</span><br><span class="hljs-comment"> *         this.left = left;</span><br><span class="hljs-comment"> *         this.right = right;</span><br><span class="hljs-comment"> *     &#125;</span><br><span class="hljs-comment"> * &#125;</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Solution</span> &#123;<br>    <span class="hljs-keyword">public</span> List&lt;List&lt;Integer&gt;&gt; <span class="hljs-title function_">zigzagLevelOrder</span><span class="hljs-params">(TreeNode root)</span> &#123;<br>        <span class="hljs-comment">//利用层序遍历，奇数层从左往右，偶数层从右往左</span><br>        <span class="hljs-keyword">if</span>(<span class="hljs-literal">null</span> == root)&#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>();<br>        &#125;<br>        List&lt;List&lt;Integer&gt;&gt; res=<span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>();<br>        List&lt;Integer&gt; tempList=<span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>();<br>        List&lt;TreeNode&gt; temp=<span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;TreeNode&gt;();<br>        temp.add(root);<br>        temp.add(<span class="hljs-literal">null</span>);<br>        TreeNode node;<br>        <span class="hljs-type">int</span> layer=<span class="hljs-number">1</span>;<br>        <span class="hljs-keyword">while</span>(!temp.isEmpty())&#123;<br>            node=temp.remove(<span class="hljs-number">0</span>);<br>            <span class="hljs-keyword">if</span>(<span class="hljs-literal">null</span> != node)&#123;<br>                <span class="hljs-comment">//奇数层从左往右，偶数层从右往左</span><br>                <span class="hljs-keyword">if</span>(layer%<span class="hljs-number">2</span>==<span class="hljs-number">0</span>)&#123;<br>                    tempList.add(<span class="hljs-number">0</span>, node.val);<br>                &#125; <span class="hljs-keyword">else</span> &#123;<br>                    tempList.add(node.val);<br>                &#125;<br>                <span class="hljs-keyword">if</span>(<span class="hljs-literal">null</span>!=node.left)&#123;<br>                    temp.add(node.left);<br>                &#125;<br>                <span class="hljs-keyword">if</span>(<span class="hljs-literal">null</span>!=node.right)&#123;<br>                    temp.add(node.right);<br>                &#125;<br>            &#125; <br>            <span class="hljs-comment">//本层已遍历完毕</span><br>            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(!tempList.isEmpty())&#123;<br>                res.add(tempList);<br>                tempList=<span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>();<br>                temp.add(<span class="hljs-literal">null</span>);<br>                layer++;<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">return</span> res;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></div></figure>]]></content>
    
    
    <categories>
      
      <category>算法</category>
      
      <category>二叉树</category>
      
      <category>LeetCode</category>
      
    </categories>
    
    
    <tags>
      
      <tag>二叉树</tag>
      
      <tag>数据结构</tag>
      
      <tag>LeetCode</tag>
      
      <tag>算法</tag>
      
      <tag>Java</tag>
      
      <tag>BFS</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>【LeetCode】107.二叉树的层序遍历II</title>
    <link href="/posts/2499526336.html"/>
    <url>/posts/2499526336.html</url>
    
    <content type="html"><![CDATA[<h1 id="1-问题"><a href="#1-问题" class="headerlink" title="1.问题"></a>1.问题</h1><p>给你二叉树的根节点 root ，返回其节点值 自底向上的层序遍历 。 （即按从叶子节点所在层到根节点所在的层，逐层从左向右遍历）<br>示例 1：</p><p><img src="https://img-blog.csdnimg.cn/img_convert/956745c1eb8e7500919a008256ec9311.jpeg#pic_center" alt="图1"></p><blockquote><p>输入：root &#x3D; [3,9,20,null,null,15,7]<br>输出：[[15,7],[9,20],[3]]</p></blockquote><p>示例 2：</p><blockquote><p>输入：root &#x3D; [1]<br>输出：[[1]]</p></blockquote><p>示例 3：</p><blockquote><p>输入：root &#x3D; []<br>输出：[]</p></blockquote><p><strong>提示</strong>：</p><ul><li>树中节点数目在范围 [0, 2000] 内</li><li>-1000 &lt;&#x3D; Node.val &lt;&#x3D; 1000</li></ul><h1 id="2-解题思路"><a href="#2-解题思路" class="headerlink" title="2.解题思路"></a>2.解题思路</h1><p>其实与<a href="https://zyxelva.github.io/posts/2462725929.html">【LeetCode】102.二叉树的层序遍历</a> 广度优先的思路没啥大的区别，从结果来看，就是结果集逆序输出，只要我们在遍历每层完成后，将临时结果集按照头插法插入结果集即可。可以利用List.add(index,value)的方法完成头插法。</p><h1 id="3-代码"><a href="#3-代码" class="headerlink" title="3.代码"></a>3.代码</h1><figure class="highlight java"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-5yxbe8lhkez7dx"></i><span>java</span><div class="collapse show" id="collapse-5yxbe8lhkez7dx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Definition for a binary tree node.</span><br><span class="hljs-comment"> * public class TreeNode &#123;</span><br><span class="hljs-comment"> *     int val;</span><br><span class="hljs-comment"> *     TreeNode left;</span><br><span class="hljs-comment"> *     TreeNode right;</span><br><span class="hljs-comment"> *     TreeNode() &#123;&#125;</span><br><span class="hljs-comment"> *     TreeNode(int val) &#123; this.val = val; &#125;</span><br><span class="hljs-comment"> *     TreeNode(int val, TreeNode left, TreeNode right) &#123;</span><br><span class="hljs-comment"> *         this.val = val;</span><br><span class="hljs-comment"> *         this.left = left;</span><br><span class="hljs-comment"> *         this.right = right;</span><br><span class="hljs-comment"> *     &#125;</span><br><span class="hljs-comment"> * &#125;</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Solution</span> &#123;<br>    <span class="hljs-keyword">public</span> List&lt;List&lt;Integer&gt;&gt; <span class="hljs-title function_">levelOrderBottom</span><span class="hljs-params">(TreeNode root)</span> &#123;<br>        <span class="hljs-comment">//分层遍历，利用队列思想，头插法</span><br>        <span class="hljs-keyword">if</span>(<span class="hljs-literal">null</span> == root)&#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>();<br>        &#125;<br>        <span class="hljs-comment">//结果集</span><br>        List&lt;List&lt;Integer&gt;&gt; res=<span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>();<br>        <span class="hljs-comment">//每层的结果集</span><br>        List&lt;Integer&gt; tempList=<span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>();<br>        List&lt;TreeNode&gt; temp=<span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;TreeNode&gt;();<br>        <span class="hljs-comment">//根节点入队</span><br>        temp.add(root);<br>        temp.add(<span class="hljs-literal">null</span>);<br>        TreeNode node;<br>        <span class="hljs-keyword">while</span>(!temp.isEmpty())&#123;<br>            node=temp.remove(<span class="hljs-number">0</span>);<br>            <span class="hljs-keyword">if</span>(<span class="hljs-literal">null</span> != node)&#123;<br>                tempList.add(node.val);<br>                <span class="hljs-keyword">if</span>(<span class="hljs-literal">null</span>!=node.left)&#123;<br>                    temp.add(node.left);<br>                &#125;<br>                <span class="hljs-keyword">if</span>(<span class="hljs-literal">null</span>!=node.right)&#123;<br>                    temp.add(node.right);<br>                &#125;<br>            &#125; <br>            <span class="hljs-comment">//本层已遍历完毕</span><br>            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(!tempList.isEmpty())&#123;<br>                <span class="hljs-comment">//头插法（与102不同的地方）</span><br>                res.add(<span class="hljs-number">0</span>, tempList);<br>                tempList=<span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>();<br>                temp.add(<span class="hljs-literal">null</span>);<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">return</span> res;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></div></figure>]]></content>
    
    
    <categories>
      
      <category>算法</category>
      
      <category>二叉树</category>
      
      <category>LeetCode</category>
      
    </categories>
    
    
    <tags>
      
      <tag>二叉树</tag>
      
      <tag>数据结构</tag>
      
      <tag>LeetCode</tag>
      
      <tag>算法</tag>
      
      <tag>Java</tag>
      
      <tag>BFS</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>【LeetCode】145.二叉树的后续遍历</title>
    <link href="/posts/3424163710.html"/>
    <url>/posts/3424163710.html</url>
    
    <content type="html"><![CDATA[<meta name="referrer" content="no-referrer"><h1 id="1-问题"><a href="#1-问题" class="headerlink" title="1.问题"></a>1.问题</h1><p>给你一棵二叉树的根节点 root ，返回其节点值的 <strong>后序</strong> 遍历 。</p><h2 id="示例-1"><a href="#示例-1" class="headerlink" title="示例 1"></a>示例 1</h2><p><img src="https://img-blog.csdnimg.cn/img_convert/b17249866b98973447035d4bf6648b45.jpeg#pic_center" alt="图1"></p><blockquote><p>输入：root &#x3D; [1,null,2,3]<br>输出：[3,2,1]</p></blockquote><h2 id="示例-2"><a href="#示例-2" class="headerlink" title="示例 2"></a>示例 2</h2><blockquote><p>输入：root &#x3D; []<br>输出：[]</p></blockquote><h2 id="示例-3"><a href="#示例-3" class="headerlink" title="示例 3"></a>示例 3</h2><blockquote><p>输入：root &#x3D; [1]<br>输出：[1]</p></blockquote><p><strong>提示</strong>：</p><ul><li>树中节点的数目在范围 [0, 100] 内</li><li>-100 &lt;&#x3D; Node.val &lt;&#x3D; 100</li></ul><h1 id="2-解题思路"><a href="#2-解题思路" class="headerlink" title="2.解题思路"></a>2.解题思路</h1><p>二叉树的后序遍历规则：左-右-根，解题思路其实和前面两篇<a href="https://zyxelva.github.io/2023/04/29/%E4%BA%8C%E5%8F%89%E6%A0%91%E7%9A%84%E5%89%8D%E5%BA%8F%E9%81%8D%E5%8E%86/">二叉树的前序遍历</a>、<a href="https://zyxelva.github.io/2023/04/29/%E4%BA%8C%E5%8F%89%E6%A0%91%E7%9A%84%E4%B8%AD%E5%BA%8F%E9%81%8D%E5%8E%86/">二叉树的中序遍历</a>差不太多.</p><h2 id="2-1-递归"><a href="#2-1-递归" class="headerlink" title="2.1 递归"></a>2.1 递归</h2><p>定义函数 postOrderTraversal(root)为遍历root节点。则调用顺序为：</p><figure class="highlight java"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-in0v2jlhkez7dx"></i><span>java</span><div class="collapse show" id="collapse-in0v2jlhkez7dx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java">postOrderTraversal(root.left);<br>postOrderTraversal(root.right);<br>root.val;<br></code></pre></td></tr></table></div></figure><p><strong>复杂度分析</strong></p><ul><li><p>时间复杂度：O(n)，其中 n 是二叉搜索树的节点数。每一个节点恰好被遍历一次。</p></li><li><p>空间复杂度：O(n)，为递归过程中栈的开销，平均情况下为 O(log⁡n)，最坏情况下树呈现链状，为 O(n)。</p></li></ul><h2 id="2-2-迭代"><a href="#2-2-迭代" class="headerlink" title="2.2 迭代"></a>2.2 迭代</h2><ol><li>遍历root<br><img src="https://img-blog.csdnimg.cn/img_convert/7af3c2bb2c4365ed4c37aefa8a4a3c6e.png#pic_center" alt="图2"></li><li>root入栈<br><img src="https://img-blog.csdnimg.cn/img_convert/9070a7206c86a1ea612fc04ec2f71a00.png#pic_center" alt="图3"><br>3）root.left入栈<br><img src="https://img-blog.csdnimg.cn/img_convert/857102064a004707e583721556231ba5.png#pic_center" alt="图4"><br>4）root.left再无左子树了，左子树根节点出栈，遍历，并标记当前出栈的节点为已访问过，否则遍历、入栈root.right<br><img src="https://img-blog.csdnimg.cn/img_convert/f002bede3c25ca19cb98e36727b302aa.png#pic_center" alt="图5"><br><img src="https://img-blog.csdnimg.cn/img_convert/1372fe88616786229ad090b22fbd30cf.png#pic_center" alt="图6"><br><img src="https://img-blog.csdnimg.cn/img_convert/b033abfd3c38a61cf2febbc3cabb69ec.png#pic_center" alt="图7"><br><img src="https://img-blog.csdnimg.cn/img_convert/765e04b0d1cda730a3ba05243a079ef7.png#pic_center" alt="图8"></li></ol><p>5）同理，先把4所有左节点入栈，到达最左节点后，出栈，遍历val，标记当前出栈的节点为已访问过，遍历root.right，出栈root.right，root.<br><img src="https://img-blog.csdnimg.cn/img_convert/37c2e0b67765c6b6a219cf3e21864db2.png#pic_center" alt="图9"><br>5出栈<br><img src="https://img-blog.csdnimg.cn/img_convert/349c04a123e6d5fe20da5a184eb3cb9b.png#pic_center" alt="图10"><br><img src="https://img-blog.csdnimg.cn/img_convert/611d2d7e7ffe0f43fe396655e31a4fff.png#pic_center" alt="图11"><br>4出栈，但4的右节点存在，入栈4.right<br><img src="https://img-blog.csdnimg.cn/img_convert/733a9e18379af93d68e5173774b2d1f2.png#pic_center" alt="图12"><br><img src="https://img-blog.csdnimg.cn/img_convert/022d50585c4aaafd920d3a590c48ea3f.png#pic_center" alt="图13"><br><img src="https://img-blog.csdnimg.cn/img_convert/701a24fb73d25b6e2fed1a31317d31ca.png#pic_center" alt="图14"><br>7出栈，遍历，依次出栈4，3，遍历完毕<br><img src="https://img-blog.csdnimg.cn/img_convert/ddee700bc6ee3175f2c8007270d340ec.png#pic_center" alt="图15"><br><img src="https://img-blog.csdnimg.cn/img_convert/ffb6ce833111af31275a768dc5888df1.png#pic_center" alt="图16"><br><img src="https://img-blog.csdnimg.cn/img_convert/f89ee6166faf12b4f89d048abfc08569.png#pic_center" alt="图17"><br><img src="https://img-blog.csdnimg.cn/img_convert/885f14118fa6d9c7801c914926e1c5b3.png#pic_center" alt="图18"><br><img src="https://img-blog.csdnimg.cn/img_convert/9deb56a376dec731acd2e6cf3cb4c3d0.png#pic_center" alt="图19"><br><img src="https://img-blog.csdnimg.cn/img_convert/bd7589948385a47db4365d8182abd12d.png#pic_center" alt="图20"><br><strong>复杂度分析</strong></p><ul><li><p>时间复杂度：O(n)，其中 n 是二叉搜索树的节点数。每一个节点恰好被遍历一次。</p></li><li><p>空间复杂度：O(n)，为迭代过程中显式栈的开销，平均情况下为 O(log⁡n)，最坏情况下树呈现链状，为 O(n)。</p></li></ul><h1 id="3-代码"><a href="#3-代码" class="headerlink" title="3.代码"></a>3.代码</h1><figure class="highlight java"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-2fmm24lhkez7dx"></i><span>java</span><div class="collapse show" id="collapse-2fmm24lhkez7dx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Definition for a binary tree node.</span><br><span class="hljs-comment"> * public class TreeNode &#123;</span><br><span class="hljs-comment"> *     int val;</span><br><span class="hljs-comment"> *     TreeNode left;</span><br><span class="hljs-comment"> *     TreeNode right;</span><br><span class="hljs-comment"> *     TreeNode() &#123;&#125;</span><br><span class="hljs-comment"> *     TreeNode(int val) &#123; this.val = val; &#125;</span><br><span class="hljs-comment"> *     TreeNode(int val, TreeNode left, TreeNode right) &#123;</span><br><span class="hljs-comment"> *         this.val = val;</span><br><span class="hljs-comment"> *         this.left = left;</span><br><span class="hljs-comment"> *         this.right = right;</span><br><span class="hljs-comment"> *     &#125;</span><br><span class="hljs-comment"> * &#125;</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Solution</span> &#123;<br><span class="hljs-comment">//迭代</span><br>    <span class="hljs-keyword">public</span> List&lt;Integer&gt; <span class="hljs-title function_">postorderTraversal</span><span class="hljs-params">(TreeNode root)</span> &#123;<br>        List&lt;Integer&gt; res = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>        <span class="hljs-keyword">if</span> (<span class="hljs-literal">null</span> == root) &#123;<br>            <span class="hljs-keyword">return</span> res;<br>        &#125;<br>        Stack&lt;TreeNode&gt; stack = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Stack</span>&lt;&gt;();<br>        <span class="hljs-type">TreeNode</span> <span class="hljs-variable">prev</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>        <span class="hljs-type">TreeNode</span> <span class="hljs-variable">current</span> <span class="hljs-operator">=</span> root;<br>        <span class="hljs-keyword">while</span> (<span class="hljs-literal">null</span> != current || !stack.isEmpty()) &#123;<br>            <span class="hljs-keyword">while</span> (<span class="hljs-literal">null</span> != current) &#123;<br>                stack.push(current);<br>                current = current.left;<br>            &#125;<br>            <span class="hljs-comment">//获取当前栈顶节点</span><br>            current = stack.peek();<br>            <span class="hljs-comment">//右节点为空，或者已经访问过，则打印，并标记当前出栈的节点为已访问过</span><br>            <span class="hljs-keyword">if</span> (<span class="hljs-literal">null</span> == current.right || prev == current.right) &#123;<br>                res.add(current.val);<br>                prev = current;<br>                stack.pop();<br>                current = <span class="hljs-literal">null</span>;<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                current = current.right;<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">return</span> res;<br>    &#125;<br><br><span class="hljs-comment">//递归</span><br><span class="hljs-keyword">public</span> <span class="hljs-type">int</span>[] postorderTraversal2 (TreeNode root) &#123;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-literal">null</span> == root) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[<span class="hljs-number">0</span>];<br>        &#125;<br>        List&lt;Integer&gt; list = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;Integer&gt;();<br>        postorderTraversal2(list, root);<br>        <span class="hljs-keyword">return</span> list.stream().mapToInt(Integer::valueOf).toArray();<br>    &#125;<br> <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">postorderTraversal2</span> <span class="hljs-params">(List&lt;Integer&gt; list, TreeNode root)</span> &#123;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-literal">null</span> == root) &#123;<br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br>        postorderTraversal2(list, root.left);<br>        postorderTraversal2(list, root.right);<br>        list.add(root.val);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></div></figure>]]></content>
    
    
    <categories>
      
      <category>算法</category>
      
      <category>二叉树</category>
      
      <category>LeetCode</category>
      
    </categories>
    
    
    <tags>
      
      <tag>二叉树</tag>
      
      <tag>数据结构</tag>
      
      <tag>LeetCode</tag>
      
      <tag>算法</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>【LeetCode】94.二叉树的中序遍历</title>
    <link href="/posts/240635441.html"/>
    <url>/posts/240635441.html</url>
    
    <content type="html"><![CDATA[<meta name="referrer" content="no-referrer"><h1 id="1-问题"><a href="#1-问题" class="headerlink" title="1.问题"></a>1.问题</h1><p>给定一个二叉树的根节点 root ，返回 它的 <strong>中序</strong> 遍历 。</p><h2 id="示例-1"><a href="#示例-1" class="headerlink" title="示例 1"></a>示例 1</h2><p><img src="https://img-blog.csdnimg.cn/img_convert/7c55ac8a6fe7df8e5a4939e503566cb5.jpeg#pic_center" alt="图1"></p><blockquote><p>输入：root &#x3D; [1,null,2,3]<br>输出：[1,3,2]</p></blockquote><h2 id="示例-2"><a href="#示例-2" class="headerlink" title="示例 2"></a>示例 2</h2><blockquote><p>输入：root &#x3D; []<br>输出：[]</p></blockquote><h2 id="示例-3"><a href="#示例-3" class="headerlink" title="示例 3"></a>示例 3</h2><blockquote><p>输入：root &#x3D; [1]<br>输出：[1]</p></blockquote><p><strong>提示</strong>：</p><ul><li>树中节点数目在范围 [0, 100] 内</li><li>-100 &lt;&#x3D; Node.val &lt;&#x3D; 100</li></ul><h1 id="2-解题思路"><a href="#2-解题思路" class="headerlink" title="2.解题思路"></a>2.解题思路</h1><h2 id="2-1-递归"><a href="#2-1-递归" class="headerlink" title="2.1 递归"></a>2.1 递归</h2><p>类似<a href="https://zyxelva.github.io/2023/04/29/%E4%BA%8C%E5%8F%89%E6%A0%91%E7%9A%84%E5%89%8D%E5%BA%8F%E9%81%8D%E5%8E%86/">二叉树的前序遍历</a>，中序遍历规则为 左-根-右，只要对前序遍历-递归稍作调整，即可实现；</p><p><strong>复杂度分析</strong></p><ul><li><p>时间复杂度：O(n)，其中 n 为二叉树节点的个数。二叉树的遍历中每个节点会被访问一次且只会被访问一次。</p></li><li><p>空间复杂度：O(n)。空间复杂度取决于递归的栈深度，而栈深度在二叉树为一条链的情况下会达到 O(n) 的级别。</p></li></ul><h2 id="2-2-迭代（栈）"><a href="#2-2-迭代（栈）" class="headerlink" title="2.2 迭代（栈）"></a>2.2 迭代（栈）</h2><p>若利用栈（迭代思想），则需要调整下入栈顺序，遍历顺序<br>1）先遍历根节点，入栈<br><img src="https://img-blog.csdnimg.cn/img_convert/346ead11b93d1e268442d3268d22c544.png#pic_center" alt="图2"><br>2）循环遍历左子树<br><img src="https://img-blog.csdnimg.cn/img_convert/c423efbaa00943b29c58b1a55e20e802.png#pic_center" alt="图3"><br><img src="https://img-blog.csdnimg.cn/img_convert/795f1e51a84546e874987a7ac8425e7f.png#pic_center" alt="图4"><br>3）到达最左边，出栈，遍历该节点右子树，入栈，没有的话，再出栈该节点的根节点，比如目前节点是4，右子树没有了，出栈根节点2<br><img src="https://img-blog.csdnimg.cn/img_convert/37ff491c7c271fb4f326cc57a74f4122.png#pic_center" alt="图5"><br><img src="https://img-blog.csdnimg.cn/img_convert/7aa96355593a980611f6c2298e71009b.png#pic_center" alt="图6"><br><img src="https://img-blog.csdnimg.cn/img_convert/431308dd45151de979645577be90e040.png#pic_center" alt="图7"><br><img src="https://img-blog.csdnimg.cn/img_convert/f62bc4615e0da03a3e45d9a64acd158b.png#pic_center" alt="图8"></p><p>4）根节点的左子树遍历完毕，开始遍历1的右子树，先出栈根节点1，同理遍历右子树<br><img src="https://img-blog.csdnimg.cn/img_convert/75966ba0cf835e89054d0fd5c4824a56.png#pic_center" alt="图9"></p><p><img src="https://img-blog.csdnimg.cn/img_convert/b28df401f758e0b0c558c52f5ef1b08c.png#pic_center" alt="图10"><br><img src="https://img-blog.csdnimg.cn/img_convert/ad63fdcac27c54c96ad5c202f804e81f.png#pic_center" alt="图11"><br><img src="https://img-blog.csdnimg.cn/img_convert/6dfe1efa71dc1da0ff6b115bbeb46f2f.png#pic_center" alt="图12"><br><img src="https://img-blog.csdnimg.cn/img_convert/db58b8ed3cdde4808ecc14551cd02fd5.png#pic_center" alt="图13"><br><img src="https://img-blog.csdnimg.cn/img_convert/ac29b2347b8098dc63cd4be6e7496bc2.png#pic_center" alt="图14"><br><strong>复杂度分析</strong></p><ul><li><p>时间复杂度：O(n)，其中 n 为二叉树节点的个数。二叉树的遍历中每个节点会被访问一次且只会被访问一次。</p></li><li><p>空间复杂度：O(n)。空间复杂度取决于栈深度，而栈深度在二叉树为一条链的情况下会达到 O(n) 的级别。</p></li></ul><h1 id="3-代码"><a href="#3-代码" class="headerlink" title="3.代码"></a>3.代码</h1><figure class="highlight java"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-z0ui5xlhkez7dx"></i><span>java</span><div class="collapse show" id="collapse-z0ui5xlhkez7dx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * public class TreeNode &#123;</span><br><span class="hljs-comment"> *   int val = 0;</span><br><span class="hljs-comment"> *   TreeNode left = null;</span><br><span class="hljs-comment"> *   TreeNode right = null;</span><br><span class="hljs-comment"> *   public TreeNode(int val) &#123;</span><br><span class="hljs-comment"> *     this.val = val;</span><br><span class="hljs-comment"> *   &#125;</span><br><span class="hljs-comment"> * &#125;</span><br><span class="hljs-comment"> */</span><br> <br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Solution</span> &#123;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 递归</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * 递归算法</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> root TreeNode类</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> int整型一维数组</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span>[] inorderTraversal2 (TreeNode root) &#123;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-literal">null</span> == root) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[<span class="hljs-number">0</span>];<br>        &#125;<br>        List&lt;Integer&gt; list = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>();<br>        inorderTraversal2(list, root);<br>        <span class="hljs-keyword">return</span> list.stream().mapToInt(Integer::valueOf).toArray();<br>    &#125;<br> <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">inorderTraversal2</span> <span class="hljs-params">(List&lt;Integer&gt; list, TreeNode root)</span> &#123;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-literal">null</span> == root) &#123;<br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br>        inorderTraversal2(list, root.left);<br>        list.add(root.val);<br>        inorderTraversal2(list, root.right);<br>    &#125;<br> <br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">    非递归算法</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span>[] inorderTraversal (TreeNode root) &#123;<br>        <span class="hljs-keyword">if</span> (root == <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[<span class="hljs-number">0</span>];<br>        &#125;<br>        List&lt;Integer&gt; list = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>        <span class="hljs-type">TreeNode</span> <span class="hljs-variable">cur</span> <span class="hljs-operator">=</span> root;<br>        Stack&lt;TreeNode&gt; stack = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Stack</span>&lt;&gt;();<br>        <span class="hljs-type">TreeNode</span> <span class="hljs-variable">top</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>        <span class="hljs-keyword">while</span> (cur != <span class="hljs-literal">null</span> || !stack.isEmpty()) &#123;<br>            <span class="hljs-comment">//把左节点所有左节点入栈</span><br>            <span class="hljs-keyword">while</span> (cur != <span class="hljs-literal">null</span>) &#123;<br>                stack.push(cur);<br>                cur = cur.left;<br>            &#125;<br>            <span class="hljs-comment">//出栈</span><br>            top = stack.pop();<br>            list.add(top.val);<br>            cur = top.right;<br>        &#125;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">size</span> <span class="hljs-operator">=</span> list.size();<br>        <span class="hljs-type">int</span>[] arr = <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[size];<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; size; i++) &#123;<br>            arr[i] = list.get(i);<br>        &#125;<br>        <span class="hljs-keyword">return</span> arr;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></div></figure>]]></content>
    
    
    <categories>
      
      <category>算法</category>
      
      <category>二叉树</category>
      
      <category>LeetCode</category>
      
    </categories>
    
    
    <tags>
      
      <tag>二叉树</tag>
      
      <tag>数据结构</tag>
      
      <tag>LeetCode</tag>
      
      <tag>算法</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>【LeetCode】102.二叉树的层序遍历</title>
    <link href="/posts/2462725929.html"/>
    <url>/posts/2462725929.html</url>
    
    <content type="html"><![CDATA[<meta name="referrer" content="no-referrer"><h1 id="1-问题"><a href="#1-问题" class="headerlink" title="1.问题"></a>1.问题</h1><p>给你二叉树的根节点 root ，返回其节点值的 层序遍历 。 （即逐层地，从左到右访问所有节点）。</p><p> <img src="https://img-blog.csdnimg.cn/img_convert/2e1724d19c6520ecce7f331873f7bee9.jpeg#pic_center" alt="图1"></p><h2 id="示例-1"><a href="#示例-1" class="headerlink" title="示例 1"></a>示例 1</h2><blockquote><p>输入：root &#x3D; [3,9,20,null,null,15,7]<br>输出：[[3],[9,20],[15,7]]</p></blockquote><h2 id="示例-2"><a href="#示例-2" class="headerlink" title="示例 2"></a>示例 2</h2><blockquote><p>输入：root &#x3D; [1]<br>输出：[[1]]</p></blockquote><h2 id="示例-3"><a href="#示例-3" class="headerlink" title="示例 3"></a>示例 3</h2><blockquote><p>输入：root &#x3D; []<br>输出：[]</p></blockquote><p><strong>提示</strong>：</p><ul><li>树中节点数目在范围 [0, 2000] 内</li><li>-1000 &lt;&#x3D; Node.val &lt;&#x3D; 1000</li></ul><h1 id="2-解题思路"><a href="#2-解题思路" class="headerlink" title="2.解题思路"></a>2.解题思路</h1><h2 id="2-1-队列"><a href="#2-1-队列" class="headerlink" title="2.1 队列"></a>2.1 队列</h2><p>二叉树每层的遍历符合队列的特性，必须FIFO(first in first out)，再遍历每层完成后，可以给定一个标记或者层数，表示该层已经遍历完毕，可以将此时的该层遍历结果输出。伪代码：</p><figure class="highlight java"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-3pmey2lhkez7dx"></i><span>java</span><div class="collapse show" id="collapse-3pmey2lhkez7dx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//定义队列</span><br>Queue q;<br><span class="hljs-comment">//结果集</span><br>List res;<br><span class="hljs-comment">//root 入队</span><br>q.add(root);<br><span class="hljs-comment">//给定一个标识，标记第一层遍历的结尾</span><br>q.add(<span class="hljs-literal">null</span>);<br><span class="hljs-keyword">while</span>(q不为空)&#123;<br><span class="hljs-comment">//出队</span><br>temp=q.peek();<br><span class="hljs-comment">//不是标识的话，入队root.left、root.right</span><br><span class="hljs-keyword">if</span>(temp不为<span class="hljs-literal">null</span>)&#123;<br>res.add(temp.val);<br><span class="hljs-keyword">if</span>(temp.left不为<span class="hljs-literal">null</span>)&#123;<br>q.add(temp.left);<br>&#125;<br><span class="hljs-keyword">if</span>(temp.right不为<span class="hljs-literal">null</span>)&#123;<br>q.add(temp.right);<br>&#125;<br>&#125;<br><span class="hljs-comment">//否则，该层遍历完毕</span><br><span class="hljs-keyword">else</span> &#123;<br>q.add(<span class="hljs-literal">null</span>);<br>&#125;<br>&#125;<br></code></pre></td></tr></table></div></figure><p><img src="https://img-blog.csdnimg.cn/img_convert/774fe28d36b44dfdda1b8167197e72e6.gif#pic_center" alt="图2"><br><strong>复杂度分析</strong>：</p><ul><li>时间复杂度：O(n)，其中n为二叉树的节点数，每个节点访问一次</li><li>空间复杂度：O(n)，队列的空间为二叉树的一层的节点数，最坏情况二叉树的一层为O(n)级</li></ul><h2 id="2-2-递归"><a href="#2-2-递归" class="headerlink" title="2.2 递归"></a>2.2 递归</h2><p>根据二叉树的定义，不难看出，每个节点都有类似的性质。当遍历发生时，对于其左右子树同样适用相同的规则，非常适合递归。可以借鉴之前对于二叉树的前中后序遍历，既然可以用递归解决，那层次遍历也未尝不可。同样可以运用标记的思想，对于同一层，可以标记为相同的深度来进行遍历。伪代码：</p><figure class="highlight java"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-9kbxeqlhkez7dx"></i><span>java</span><div class="collapse show" id="collapse-9kbxeqlhkez7dx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">void</span> <span class="hljs-title function_">traverse</span><span class="hljs-params">(TreeNode root, <span class="hljs-type">int</span> depth)</span>;<br><br><span class="hljs-comment">//计入子节点，则深度depth+1</span><br><span class="hljs-comment">//递归左右时深度记得加1</span><br>traverse(root.left, depth + <span class="hljs-number">1</span>); <br>traverse(root.right, depth + <span class="hljs-number">1</span>);<br><br><span class="hljs-comment">//每个节点值放入对应的二维数组相应行</span><br>res[depth - <span class="hljs-number">1</span>].push_back(root-&gt;val);<br><br></code></pre></td></tr></table></div></figure><p><strong>复杂度分析</strong></p><ul><li>时间复杂度：O(n)，n为节点数量，DFS对每个节点访问一次，因此递归调用n次，每次调用执行常数次操作，时间复杂度O(n)。</li><li>空间复杂度：O(n)，空间复杂度在于递归调用深度和每次递归调用辅助空间，辅助空间为常数级，与节点深度相关，当节点深度为n时最大，为O(n)。</li></ul><h1 id="3-代码"><a href="#3-代码" class="headerlink" title="3.代码"></a>3.代码</h1><figure class="highlight java"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-rvvmfhlhkez7dx"></i><span>java</span><div class="collapse show" id="collapse-rvvmfhlhkez7dx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> java.util.*;<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * public class TreeNode &#123;</span><br><span class="hljs-comment"> *   int val = 0;</span><br><span class="hljs-comment"> *   TreeNode left = null;</span><br><span class="hljs-comment"> *   TreeNode right = null;</span><br><span class="hljs-comment"> * &#125;</span><br><span class="hljs-comment"> */</span><br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Solution</span> &#123;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 利用队列的性质</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> root TreeNode类</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> int整型ArrayList&lt;ArrayList&lt;&gt;&gt;</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> ArrayList&lt;ArrayList&lt;Integer&gt;&gt; <span class="hljs-title function_">levelOrder</span> <span class="hljs-params">(TreeNode root)</span> &#123;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-literal">null</span> == root) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>        &#125;<br>        <span class="hljs-comment">//结果</span><br>        ArrayList&lt;ArrayList&lt;Integer&gt;&gt; res = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>        <span class="hljs-comment">//每层临时结果</span><br>        ArrayList&lt;Integer&gt; temp = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>        TreeNode node;<br>        <span class="hljs-comment">//队列</span><br>        LinkedList&lt;TreeNode&gt; list = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedList</span>&lt;TreeNode&gt;();<br>        list.add(root);<br>        <span class="hljs-comment">//给定个 层标识</span><br>        list.add(<span class="hljs-literal">null</span>);<br>        <span class="hljs-comment">//遍历队列</span><br>        <span class="hljs-keyword">while</span> (!list.isEmpty()) &#123;<br>            node = list.removeFirst();<br>            <span class="hljs-keyword">if</span> (<span class="hljs-literal">null</span> != node) &#123;<br>                temp.add(node.val);<br>                <span class="hljs-keyword">if</span> (<span class="hljs-literal">null</span> != node.left) &#123;<br>                    list.add(node.left);<br>                &#125;<br>                <span class="hljs-keyword">if</span> (<span class="hljs-literal">null</span> != node.right) &#123;<br>                    list.add(node.right);<br>                &#125;<br>            &#125;<br>            <span class="hljs-comment">//为null节点，说明这一层已经遍历完成</span><br>            <span class="hljs-keyword">else</span> &#123;<br>                <span class="hljs-comment">//这里一定要判断下，如果为空，表明二叉树已经遍历完成了</span><br>                <span class="hljs-keyword">if</span> (!temp.isEmpty()) &#123;<br>                    res.add(temp);<br>                    temp = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>                    list.add(<span class="hljs-literal">null</span>);<br>                &#125;<br><br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">return</span> res;<br>    &#125;<br><br><span class="hljs-comment">//记录输出</span><br>    ArrayList&lt;ArrayList&lt;Integer&gt; &gt; res = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>();<br>    <br><span class="hljs-comment">//递归</span><br><span class="hljs-keyword">public</span> ArrayList&lt;ArrayList&lt;Integer&gt;&gt; <span class="hljs-title function_">levelOrder</span> <span class="hljs-params">(TreeNode root)</span> &#123;<br>        <span class="hljs-keyword">if</span>(root == <span class="hljs-literal">null</span>)<br>            <span class="hljs-comment">//如果是空，则直接返回</span><br>            <span class="hljs-keyword">return</span> res;<br>        <span class="hljs-comment">//递归层次遍历</span><br>        traverse(root, <span class="hljs-number">0</span>);<br>        <span class="hljs-keyword">return</span> res;<br>    &#125;<br>    <br>    <span class="hljs-comment">//临时结果集</span><br>    ArrayList&lt;Integer&gt; row;<br>    <br><span class="hljs-keyword">void</span> <span class="hljs-title function_">traverse</span><span class="hljs-params">(TreeNode root, <span class="hljs-type">int</span> depth)</span> &#123;<br>        <span class="hljs-keyword">if</span>(root != <span class="hljs-literal">null</span>)&#123;<br>            <span class="hljs-comment">//新的一层: 对于二维res来说，将根视为第0层，树的深度正好等于一维res的个数</span><br>            <span class="hljs-keyword">if</span>(res.size() == depth)&#123; <br>                row = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>();<br>                res.add(row);<br>            <span class="hljs-comment">//读取该层的一维数组，将元素加入末尾</span><br>            &#125;<span class="hljs-keyword">else</span>&#123;<br>                row = res.get(depth); <br>            &#125;<br>            row.add(root.val);<br>        &#125;<br>        <span class="hljs-keyword">else</span><br>            <span class="hljs-keyword">return</span>;<br>        <span class="hljs-comment">//递归左右时深度记得加1</span><br>        traverse(root.left, depth + <span class="hljs-number">1</span>);<br>        traverse(root.right, depth + <span class="hljs-number">1</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></div></figure>]]></content>
    
    
    <categories>
      
      <category>算法</category>
      
      <category>二叉树</category>
      
      <category>LeetCode</category>
      
    </categories>
    
    
    <tags>
      
      <tag>二叉树</tag>
      
      <tag>数据结构</tag>
      
      <tag>LeetCode</tag>
      
      <tag>算法</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>【LeetCode】144.二叉树的前序遍历</title>
    <link href="/posts/2952228873.html"/>
    <url>/posts/2952228873.html</url>
    
    <content type="html"><![CDATA[<meta name="referrer" content="no-referrer"><h1 id="1-问题"><a href="#1-问题" class="headerlink" title="1.问题"></a>1.问题</h1><figure class="highlight xquery"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-5nqabzlhkez7dx"></i><span>xquery</span><div class="collapse show" id="collapse-5nqabzlhkez7dx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs xquery">给你二叉树的根节点<span class="hljs-built_in"> root</span> ，返回它节点值的 前序 遍历。<br></code></pre></td></tr></table></div></figure><h2 id="示例-1"><a href="#示例-1" class="headerlink" title="示例 1"></a>示例 1</h2><p><img src="https://img-blog.csdnimg.cn/img_convert/bfcfd742f58b7f629df27b4bf8a169a9.jpeg#pic_center" alt="图1"></p><blockquote><p>输入：root &#x3D; [1,null,2,3]<br>输出：[1,2,3]</p></blockquote><h2 id="示例-2"><a href="#示例-2" class="headerlink" title="示例 2"></a>示例 2</h2><blockquote><p>输入：root &#x3D; []<br>输出：[]</p></blockquote><h2 id="示例-3"><a href="#示例-3" class="headerlink" title="示例 3"></a>示例 3</h2><blockquote><p>输入：root &#x3D; [1]<br>输出：[1]</p></blockquote><h2 id="示例-4"><a href="#示例-4" class="headerlink" title="示例 4"></a>示例 4</h2><p><img src="https://img-blog.csdnimg.cn/img_convert/055d4e3cd757f49afe71b8e1467d480a.jpeg#pic_center" alt="图2"></p><blockquote><p>输入：root &#x3D; [1,2]<br>输出：[1,2]</p></blockquote><h2 id="示例-5"><a href="#示例-5" class="headerlink" title="示例 5"></a>示例 5</h2><p><img src="https://img-blog.csdnimg.cn/img_convert/1e3a847f0b72e64b899dbeb0dcbca616.jpeg#pic_center" alt="图3"></p><blockquote><p>输入：root &#x3D; [1,null,2]<br>输出：[1,2]</p></blockquote><p><strong>提示</strong>：</p><ul><li>树中节点数目在范围 [0, 100] 内</li><li>-100 &lt;&#x3D; Node.val &lt;&#x3D; 100</li></ul><h1 id="2-解题思路"><a href="#2-解题思路" class="headerlink" title="2.解题思路"></a>2.解题思路</h1><h2 id="2-1-递归"><a href="#2-1-递归" class="headerlink" title="2.1 递归"></a>2.1 递归</h2><p>中序遍历的规则是 根-左-右，然后访问左子树、右子树时同样按照此规则遍历，非常容易通过递归实现，按照规则，代码非常容易写出来。定义 <strong>preorderTraversal(root)</strong> 为递归遍历函数方法，root 为根节点。伪代码：</p><figure class="highlight java"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-5mlcbwlhkez7dx"></i><span>java</span><div class="collapse show" id="collapse-5mlcbwlhkez7dx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java">root.val;<br>preorderTraversal(root.left);<br>preorderTraversal(root.right);<br></code></pre></td></tr></table></div></figure><p><strong>复杂度分析</strong></p><ul><li><p>时间复杂度：O(n)，其中 n 是二叉树的节点数。每一个节点恰好被遍历一次。</p></li><li><p>空间复杂度：O(n)，为递归过程中栈的开销，平均情况下为 O(log⁡n)，最坏情况下树呈现链状，为 O(n)。</p></li></ul><h2 id="2-2-迭代"><a href="#2-2-迭代" class="headerlink" title="2.2 迭代"></a>2.2 迭代</h2><p>显示利用栈结构，遍历二叉树。<br>引用LeetCode动态图解迭代过程：<br>1）访问根节点<br><img src="https://img-blog.csdnimg.cn/img_convert/9d2a4485420c7a95799a09999b81d662.png#pic_center" alt="图4"><br>2）根节点入栈<br><img src="https://img-blog.csdnimg.cn/img_convert/64301bc1906294b4853a32161890f3ec.png#pic_center" alt="图5"><br>3）左子树根节点遍历、入栈<br><img src="https://img-blog.csdnimg.cn/img_convert/625bc2dd91f7e489d64311098b60599c.png#pic_center" alt="图6"><br>4）左子树根节点出栈，遍历其左右子节点<br><img src="https://img-blog.csdnimg.cn/img_convert/1795695bfe91736dd9daba150dc75b02.png#pic_center" alt="图7"><br>5）左根节点左子树不存在，遍历其右子树4<br><img src="https://img-blog.csdnimg.cn/img_convert/053fb2ab6e498be02df4e0b7c1e8bd78.png#pic_center" alt="图8"><br>6）左子树遍历完毕，遍历根节点右子树<br><img src="https://img-blog.csdnimg.cn/img_convert/92ba07a2ab80979a6adcbb932f43c0ad.png#pic_center" alt="图9"><br>7）遍历右子树根节点，根节点出栈<br><img src="https://img-blog.csdnimg.cn/img_convert/d19f60849640fb1625a0424b3cbde631.png#pic_center" alt="图10"><br>8）右子树根节点入栈<br><img src="https://img-blog.csdnimg.cn/img_convert/2db7363f3e0366a1b2242fb703c95751.png#pic_center" alt="图11"></p><p>9）右子树左节点遍历，入栈<br><img src="https://img-blog.csdnimg.cn/img_convert/0df77d13242bf0d1028476a613d15084.png#pic_center" alt="图12"></p><p>10）右子树左节点遍历完毕，该节点出栈<br><img src="https://img-blog.csdnimg.cn/img_convert/3a874f3193e082298063797fc8fba000.png#pic_center" alt="图13"><br>11）遍历右子树右节点，右子树根节点出栈<br><img src="https://img-blog.csdnimg.cn/img_convert/62cd727620a3733c5b93de45ef8c8d83.png#pic_center" alt="图14"><br>12）右子树右节点遍历，入栈<br><img src="https://img-blog.csdnimg.cn/img_convert/44473bed64019699f1a718508dbf4a24.png#pic_center" alt="图15"><br>13）右子树遍历完毕，出栈<br><img src="https://img-blog.csdnimg.cn/img_convert/87b30e5ca23edf3bee8fe942d99b7e4b.png#pic_center" alt="图16"><br>14）遍历完毕<br><img src="https://img-blog.csdnimg.cn/img_convert/c2cee3c4c3edf74912ccc14b9dbba9af.png#pic_center" alt="图17"><br><strong>复杂度分析</strong></p><ul><li><p>时间复杂度：O(n)，其中 n 是二叉树的节点数。每一个节点恰好被遍历一次。</p></li><li><p>空间复杂度：O(n)，为迭代过程中显式栈的开销，平均情况下为 O(log⁡n)，最坏情况下树呈现链状，为 O(n)。</p></li></ul><h1 id="3-代码"><a href="#3-代码" class="headerlink" title="3.代码"></a>3.代码</h1><figure class="highlight java"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-hg5z3slhkez7dx"></i><span>java</span><div class="collapse show" id="collapse-hg5z3slhkez7dx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Solution</span> &#123;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 递归</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> root TreeNode类</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> int整型一维数组</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span>[] preorderTraversal (TreeNode root) &#123;<br>        <span class="hljs-comment">// write code here</span><br>        <span class="hljs-keyword">if</span> (<span class="hljs-literal">null</span> == root) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[<span class="hljs-number">0</span>];<br>        &#125;<br>        List&lt;Integer&gt; list = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>();<br>        preorderTraversal2(list, root);<br>        <span class="hljs-keyword">return</span> list.stream().mapToInt(Integer::valueOf).toArray();<br>    &#125;<br> <br> <span class="hljs-comment">//递归方法</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">preorderTraversal2</span> <span class="hljs-params">(List&lt;Integer&gt; list, TreeNode root)</span> &#123;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-literal">null</span> == root) &#123;<br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br>        list.add(root.val);<br>        preorderTraversal2(list, root.left);<br>        preorderTraversal2(list, root.right);<br>    &#125;<br><br><span class="hljs-comment">//迭代，栈思想</span><br><span class="hljs-keyword">public</span> List&lt;Integer&gt; <span class="hljs-title function_">preorderTraversal</span><span class="hljs-params">(TreeNode root)</span> &#123;<br>        List&lt;Integer&gt; res = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>        <span class="hljs-keyword">if</span> (<span class="hljs-literal">null</span> == root) &#123;<br>            <span class="hljs-keyword">return</span> res;<br>        &#125;<br>        Stack&lt;TreeNode&gt; stack = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Stack</span>&lt;&gt;();<br>        stack.add(root);<br>        TreeNode p;<br>        <span class="hljs-keyword">while</span> (!stack.isEmpty()) &#123;<br>            p = stack.pop();<br>            res.add(p.val);<br>            <span class="hljs-comment">//先把右节点入栈</span><br>            <span class="hljs-keyword">if</span> (<span class="hljs-literal">null</span> != p.right) &#123;<br>                stack.add(p.right);<br>            &#125;<br>            <span class="hljs-keyword">if</span> (<span class="hljs-literal">null</span> != p.left) &#123;<br>                stack.add(p.left);<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">return</span> res;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></div></figure>]]></content>
    
    
    <categories>
      
      <category>算法</category>
      
      <category>二叉树</category>
      
      <category>LeetCode</category>
      
    </categories>
    
    
    <tags>
      
      <tag>二叉树</tag>
      
      <tag>数据结构</tag>
      
      <tag>LeetCode</tag>
      
      <tag>算法</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Hello World</title>
    <link href="/posts/1243066710.html"/>
    <url>/posts/1243066710.html</url>
    
    <content type="html"><![CDATA[<p>Welcome to <a href="https://hexo.io/">Hexo</a>! This is your very first post. Check <a href="https://hexo.io/docs/">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="https://hexo.io/docs/troubleshooting.html">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues">GitHub</a>.</p><h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-i9914olhkez7dw"></i><span>bash</span><div class="collapse show" id="collapse-i9914olhkez7dw"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ hexo new <span class="hljs-string">&quot;My New Post&quot;</span><br></code></pre></td></tr></table></div></figure><p>More info: <a href="https://hexo.io/docs/writing.html">Writing</a></p><h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-hroja2lhkez7dw"></i><span>bash</span><div class="collapse show" id="collapse-hroja2lhkez7dw"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ hexo server<br></code></pre></td></tr></table></div></figure><p>More info: <a href="https://hexo.io/docs/server.html">Server</a></p><h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-bqhopalhkez7dw"></i><span>bash</span><div class="collapse show" id="collapse-bqhopalhkez7dw"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ hexo generate<br></code></pre></td></tr></table></div></figure><p>More info: <a href="https://hexo.io/docs/generating.html">Generating</a></p><h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><i class="iconfont icon-github-fill" type="button" data-toggle="collapse" data-target="#collapse-7tq384lhkez7dw"></i><span>bash</span><div class="collapse show" id="collapse-7tq384lhkez7dw"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ hexo deploy<br></code></pre></td></tr></table></div></figure><p>More info: <a href="https://hexo.io/docs/one-command-deployment.html">Deployment</a></p>]]></content>
    
    
    
  </entry>
  
  
  
  
</search>
