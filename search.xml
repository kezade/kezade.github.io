<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>ã€LeetCodeã€‘47.å…¨æ’åˆ—II</title>
      <link href="/posts/3655403458.html"/>
      <url>/posts/3655403458.html</url>
      
        <content type="html"><![CDATA[<h1 id="1-é—®é¢˜"><a href="#1-é—®é¢˜" class="headerlink" title="1 é—®é¢˜"></a>1 é—®é¢˜</h1><p>ç»™å®šä¸€ä¸ªå¯<code>åŒ…å«é‡å¤</code>æ•°å­—çš„åºåˆ— <code>nums</code> ï¼ŒæŒ‰<code>ä»»æ„é¡ºåº</code>è¿”å›æ‰€æœ‰<code>ä¸é‡å¤çš„å…¨æ’åˆ—</code>ã€‚</p><h2 id="ç¤ºä¾‹-1"><a href="#ç¤ºä¾‹-1" class="headerlink" title="ç¤ºä¾‹ 1"></a>ç¤ºä¾‹ 1</h2><ul><li>è¾“å…¥ï¼šnums &#x3D; [1,1,2]</li><li>è¾“å‡ºï¼š<blockquote><p>[[1,1,2],<br>[1,2,1],<br>[2,1,1]]</p></blockquote></li></ul><h2 id="ç¤ºä¾‹-2"><a href="#ç¤ºä¾‹-2" class="headerlink" title="ç¤ºä¾‹ 2"></a>ç¤ºä¾‹ 2</h2><blockquote><p>è¾“å…¥ï¼šnums &#x3D; [1,2,3]<br>è¾“å‡ºï¼š[[1,2,3],[1,3,2],[2,1,3],[2,3,1],[3,1,2],[3,2,1]]</p></blockquote><p>æç¤ºï¼š</p><ul><li>1 &lt;&#x3D; nums.length &lt;&#x3D; 8</li><li>-10 &lt;&#x3D; nums[i] &lt;&#x3D; 10</li></ul><h1 id="2-è§£é¢˜æ€è·¯"><a href="#2-è§£é¢˜æ€è·¯" class="headerlink" title="2 è§£é¢˜æ€è·¯"></a>2 è§£é¢˜æ€è·¯</h1><p>å¯å‚è€ƒä¸Šä¸€ç¯‡æ–‡ç« ä¸­æåˆ°çš„<code>å›æº¯æ³•</code>è§£å†³ã€‚ä¸»è¦åŒºåˆ«åœ¨äºæ­¤é¢˜ä¸­çš„æ•°ç»„åŒ…å«<code>é‡å¤</code>æ•°å­—ã€‚å› è€Œï¼Œåœ¨å›æº¯å¼€å§‹ä¹‹å‰ï¼Œå¯¹æ•°ç»„<code>nums</code>è¿›è¡Œæ’åºã€‚</p><p>åœ¨<code>for</code>å¾ªç¯ä¸­ï¼Œå¯¹äº<code>é‡å¤</code>ã€<code>æœªä½¿ç”¨çš„</code>çš„æ•°å­—è¦è¿›è¡Œæ’é™¤ï¼Œå³è·³è¿‡æ­¤æ¬¡å¾ªç¯ã€‚</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>nums<span class="token punctuation">.</span>length<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            <span class="token keyword">if</span><span class="token punctuation">(</span>used<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>                <span class="token keyword">continue</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>            <span class="token comment">//å»é‡æœ€ä¸ºå…³é”®çš„ä»£ç ã€‚</span>            <span class="token keyword">if</span><span class="token punctuation">(</span>i<span class="token operator">></span><span class="token number">0</span> <span class="token operator">&amp;&amp;</span> nums<span class="token punctuation">[</span>i<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">==</span>nums<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>used<span class="token punctuation">[</span>i<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>                <span class="token keyword">continue</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ä¹Ÿå¯ä»¥æ˜¯è¿™æ ·ï¼š</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">></span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> nums<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">==</span> nums<span class="token punctuation">[</span>i <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> used<span class="token punctuation">[</span>i <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">continue</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>ä¸ºå•¥å­ï¼Ÿ</p><blockquote><p><code>used[i - 1] == false</code> æˆ–è€… <code>!used[i-1]</code> å±äº <code>æ ‘å±‚ä¸Šçš„å»é‡</code><br><code>used[i-1] == true</code> æˆ–è€… <code>used[i-1]</code> å±äº <code>æ ‘æä¸Šçš„å»é‡</code></p></blockquote><p>æ¯”å¦‚ï¼š[1,1,1] </p><p>æ ‘å±‚ä¸Šå»é‡(used[i - 1] &#x3D;&#x3D; false)ï¼Œçš„æ ‘å½¢ç»“æ„å¦‚ä¸‹ï¼š<br><img src="https://pic.leetcode.cn/1674877047-sDePiT-image.png" alt="æ ‘å±‚ä¸Šå»é‡"></p><p>æ ‘æä¸Šå»é‡ï¼ˆused[i - 1] &#x3D;&#x3D; trueï¼‰çš„æ ‘å‹ç»“æ„å¦‚ä¸‹ï¼š<br><img src="https://pic.leetcode.cn/1674877065-APVcHw-image.png" alt="æ ‘æä¸Šå»é‡"></p><p>å…·ä½“å‚è€ƒ<a href="https://leetcode.cn/problems/permutations-ii/solutions/418230/47-quan-pai-lie-iiche-di-li-jie-pai-lie-zhong-de-q/">å½•å“¥</a> çš„æ€è·¯ã€‚è¿™æ˜¯ğŸ‚ğŸºã€‚</p><p><img src="https://pic.leetcode.cn/1674877014-GhcSpO-image.png" alt="åŒ…å«é‡å¤æ•°å­—çš„å…¨æ’åˆ—æµç¨‹"></p><h1 id="3-ä»£ç "><a href="#3-ä»£ç " class="headerlink" title="3 ä»£ç "></a>3 ä»£ç </h1><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">class</span> <span class="token class-name">Solution</span> <span class="token punctuation">&#123;</span>    <span class="token comment">//ç»“æœé›†</span>    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">></span><span class="token punctuation">></span></span> res<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">LinkedList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//ä¸´æ—¶ç»“æœ</span>    <span class="token class-name">LinkedList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">></span></span> track<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">LinkedList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//æ˜¯å¦å·²ä½¿ç”¨</span>    <span class="token keyword">boolean</span><span class="token punctuation">[</span><span class="token punctuation">]</span> used<span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">></span><span class="token punctuation">></span></span> <span class="token function">permuteUnique</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> nums<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        used<span class="token operator">=</span><span class="token keyword">new</span> <span class="token keyword">boolean</span><span class="token punctuation">[</span>nums<span class="token punctuation">.</span>length<span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token comment">//é¢˜ç›®ä¸­æœ‰é‡å¤æ•°å­—å¯ç”¨ï¼Œé‚£å°±å…ˆæ’åºï¼ŒæŠŠç›¸åŒçš„æ”¾ä¸€èµ·</span>        <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span>nums<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">backtrace</span><span class="token punctuation">(</span>nums<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> res<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">backtrace</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> nums<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>track<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">==</span>nums<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            res<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">LinkedList</span><span class="token punctuation">(</span>track<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">return</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>nums<span class="token punctuation">.</span>length<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            <span class="token keyword">if</span><span class="token punctuation">(</span>used<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>                <span class="token keyword">continue</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>            <span class="token comment">//å»é‡æœ€ä¸ºå…³é”®çš„ä»£ç ã€‚è‡³äºæ˜¯åˆ©ç”¨ !used[i-1]ï¼Œè¿˜æ˜¯ used[i-1]ï¼Œå‚è€ƒï¼šhttps://leetcode.cn/problems/permutations-ii/solutions/418230/47-quan-pai-lie-iiche-di-li-jie-pai-lie-zhong-de-q/</span>            <span class="token keyword">if</span><span class="token punctuation">(</span>i<span class="token operator">></span><span class="token number">0</span> <span class="token operator">&amp;&amp;</span> nums<span class="token punctuation">[</span>i<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">==</span>nums<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>used<span class="token punctuation">[</span>i<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>                <span class="token keyword">continue</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>            used<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">=</span><span class="token boolean">true</span><span class="token punctuation">;</span>            track<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>nums<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">backtrace</span><span class="token punctuation">(</span>nums<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment">//å‰”é™¤å½“å‰é€‰æ‹©</span>            track<span class="token punctuation">.</span><span class="token function">removeLast</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            used<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">=</span><span class="token boolean">false</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> ç®—æ³• </category>
          
      </categories>
      
      
        <tags>
            
            <tag> LeetCode </tag>
            
            <tag> å›æº¯ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ã€LeetCodeã€‘46.å…¨æ’åˆ—</title>
      <link href="/posts/558427405.html"/>
      <url>/posts/558427405.html</url>
      
        <content type="html"><![CDATA[<h1 id="1-é—®é¢˜"><a href="#1-é—®é¢˜" class="headerlink" title="1 é—®é¢˜"></a>1 é—®é¢˜</h1><p>ç»™å®šä¸€ä¸ª<code>ä¸å«é‡å¤</code>æ•°å­—çš„æ•°ç»„ <code>nums</code> ï¼Œè¿”å›å…¶<code>æ‰€æœ‰</code>å¯èƒ½çš„<code>å…¨æ’åˆ—</code> ã€‚ä½ å¯ä»¥ <code>æŒ‰ä»»æ„é¡ºåº</code> è¿”å›ç­”æ¡ˆã€‚</p><h2 id="ç¤ºä¾‹-1"><a href="#ç¤ºä¾‹-1" class="headerlink" title="ç¤ºä¾‹ 1"></a>ç¤ºä¾‹ 1</h2><blockquote><p>è¾“å…¥ï¼šnums &#x3D; [1,2,3]<br>è¾“å‡ºï¼š[[1,2,3],[1,3,2],[2,1,3],[2,3,1],[3,1,2],[3,2,1]]</p></blockquote><h2 id="ç¤ºä¾‹-2"><a href="#ç¤ºä¾‹-2" class="headerlink" title="ç¤ºä¾‹ 2"></a>ç¤ºä¾‹ 2</h2><blockquote><p>è¾“å…¥ï¼šnums &#x3D; [0,1]<br>è¾“å‡ºï¼š[[0,1],[1,0]]</p></blockquote><h2 id="ç¤ºä¾‹-3"><a href="#ç¤ºä¾‹-3" class="headerlink" title="ç¤ºä¾‹ 3"></a>ç¤ºä¾‹ 3</h2><blockquote><p>è¾“å…¥ï¼šnums &#x3D; [1]<br>è¾“å‡ºï¼š[[1]]</p></blockquote><p><strong>æç¤º</strong>ï¼š</p><ul><li>1 &lt;&#x3D; nums.length &lt;&#x3D; 6</li><li>-10 &lt;&#x3D; nums[i] &lt;&#x3D; 10</li><li>nums ä¸­çš„æ‰€æœ‰æ•´æ•° <code>äº’ä¸ç›¸åŒ</code></li></ul><h1 id="2-è§£é¢˜æ€è·¯"><a href="#2-è§£é¢˜æ€è·¯" class="headerlink" title="2 è§£é¢˜æ€è·¯"></a>2 è§£é¢˜æ€è·¯</h1><h2 id="2-1-å›æº¯æ³•"><a href="#2-1-å›æº¯æ³•" class="headerlink" title="2.1 å›æº¯æ³•"></a>2.1 å›æº¯æ³•</h2><p>æœ¬é¢˜ç»™å®šçš„æ¡ä»¶æ˜¯ï¼š<code>ä¸é‡å¤</code>çš„æ•°å­—ã€<code>å…¨æ’åˆ—</code>ï¼Œæ ¹æ®æ•°å­¦ä¸­çš„æ’åˆ—ç»„åˆå…¬å¼ï¼Œå…¨æ’åˆ—çš„ä¸ªæ•°æœ‰ n!ï¼Œå…¶ä¸­<code>n</code>ä¸ºæ•°ç»„å…ƒç´ ä¸ªæ•°ã€‚</p><h3 id="2-1-1-åŸºæœ¬å…¬å¼ï¼ˆä¼ªä»£ç ï¼‰"><a href="#2-1-1-åŸºæœ¬å…¬å¼ï¼ˆä¼ªä»£ç ï¼‰" class="headerlink" title="2.1.1 åŸºæœ¬å…¬å¼ï¼ˆä¼ªä»£ç ï¼‰"></a>2.1.1 åŸºæœ¬å…¬å¼ï¼ˆä¼ªä»£ç ï¼‰</h3><pre class="line-numbers language-none"><code class="language-none">result &#x3D; []def backtrack(è·¯å¾„, é€‰æ‹©åˆ—è¡¨):    if æ»¡è¶³ç»“æŸæ¡ä»¶:        result.add(è·¯å¾„)        return    for é€‰æ‹© in é€‰æ‹©åˆ—è¡¨:        åšé€‰æ‹©        backtrack(è·¯å¾„, é€‰æ‹©åˆ—è¡¨)        æ’¤é”€é€‰æ‹©<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>è·¯å¾„ï¼šå·²ç»åšå‡ºçš„é€‰æ‹©ã€‚</li><li>é€‰æ‹©åˆ—è¡¨ï¼šä¹Ÿå°±æ˜¯ä½ å½“å‰å¯ä»¥åšçš„é€‰æ‹©ã€‚</li><li>ç»“æŸæ¡ä»¶ï¼šä¹Ÿå°±æ˜¯åˆ°è¾¾å†³ç­–æ ‘åº•å±‚ï¼Œæ— æ³•å†åšé€‰æ‹©çš„æ¡ä»¶ã€‚</li></ul><h3 id="2-1-2-æ ¸å¿ƒæ€æƒ³"><a href="#2-1-2-æ ¸å¿ƒæ€æƒ³" class="headerlink" title="2.1.2 æ ¸å¿ƒæ€æƒ³"></a>2.1.2 æ ¸å¿ƒæ€æƒ³</h3><blockquote><p>for å¾ªç¯é‡Œé¢çš„é€’å½’ï¼Œåœ¨é€’å½’è°ƒç”¨ä¹‹å‰<code>åšé€‰æ‹©</code>ï¼Œåœ¨é€’å½’è°ƒç”¨ä¹‹å<code>æ’¤é”€é€‰æ‹©</code>ã€‚</p></blockquote><p>åœ¨<code>for</code>å¾ªç¯ä¸­ï¼Œæˆ‘ä»¬å¼•å…¥ä¸€ä¸ª<code>boolean</code>æ•°ç»„ï¼Œç”¨äºè®°å½•æ•°ç»„ä¸­å„ä½æ˜¯å¦ä½¿ç”¨ï¼Œå³æ˜¯å¦å·²ç»é€‰æ‹©äº†æŸä¸ªå…ƒç´ ã€‚åšå‡ºé€‰æ‹©ï¼Œæ ‡è®°ä¸º<code>true</code>ï¼›å–æ¶ˆé€‰æ‹©ï¼Œæ ‡è®°ä¸º<code>false</code>ã€‚</p><p><img src="https://pic.leetcode.cn/1674875632-abWPjF-image.png" alt="å›æº¯æ³•ç¤ºæ„å›¾"></p><h2 id="2-2-è¿­ä»£ï¼ˆæ’ç©ºæ³•ï¼‰"><a href="#2-2-è¿­ä»£ï¼ˆæ’ç©ºæ³•ï¼‰" class="headerlink" title="2.2 è¿­ä»£ï¼ˆæ’ç©ºæ³•ï¼‰"></a>2.2 è¿­ä»£ï¼ˆæ’ç©ºæ³•ï¼‰</h2><p>è¯¦è§è¿™ä½å¤§ç¥çš„<a href="https://leetcode.cn/problems/permutations/solutions/2151252/die-dai-fei-di-gui-fei-hui-su-cha-kong-f-xpg0/">è§£æ³•</a>ã€‚</p><h1 id="3-ä»£ç "><a href="#3-ä»£ç " class="headerlink" title="3 ä»£ç "></a>3 ä»£ç </h1><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">class</span> <span class="token class-name">Solution</span> <span class="token punctuation">&#123;</span>    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">></span><span class="token punctuation">></span></span> res<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">LinkedList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">></span><span class="token punctuation">></span></span> <span class="token function">permute</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> nums<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">LinkedList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">></span></span> track<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">LinkedList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// ã€Œè·¯å¾„ã€ä¸­çš„å…ƒç´ ä¼šè¢«æ ‡è®°ä¸º trueï¼Œé¿å…é‡å¤ä½¿ç”¨</span>        <span class="token keyword">boolean</span><span class="token punctuation">[</span><span class="token punctuation">]</span> used <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">boolean</span><span class="token punctuation">[</span>nums<span class="token punctuation">.</span>length<span class="token punctuation">]</span><span class="token punctuation">;</span>                <span class="token function">backtrack</span><span class="token punctuation">(</span>nums<span class="token punctuation">,</span> track<span class="token punctuation">,</span> used<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> res<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">/**     * å›æº¯:     * @param track è·¯å¾„ï¼šè®°å½•åœ¨ track ä¸­     * @param nums-é€‰æ‹©åˆ—è¡¨ï¼šnums ä¸­ä¸å­˜åœ¨äº track çš„é‚£äº›å…ƒç´      * ç»“æŸæ¡ä»¶ï¼šnums ä¸­çš„å…ƒç´ å…¨éƒ½åœ¨ track ä¸­å‡ºç°     */</span>    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">backtrack</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> nums<span class="token punctuation">,</span> <span class="token class-name">LinkedList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">></span></span> track<span class="token punctuation">,</span> <span class="token keyword">boolean</span><span class="token punctuation">[</span><span class="token punctuation">]</span> used<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>track<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">==</span>nums<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            res<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">LinkedList</span><span class="token punctuation">(</span>track<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">return</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token comment">//éå†</span>        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>nums<span class="token punctuation">.</span>length<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            <span class="token comment">//å·²ç»ä½¿ç”¨è¿‡äº†ï¼Œè·³è¿‡è¯¥æ•°å­—</span>            <span class="token keyword">if</span><span class="token punctuation">(</span>used<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>                <span class="token keyword">continue</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>            used<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">=</span><span class="token boolean">true</span><span class="token punctuation">;</span>            <span class="token comment">//é€‰æ‹©ï¼ŒåŠ å…¥è¯¥æ•°å­—</span>            track<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>nums<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment">//è¿›å…¥ä¸‹ä¸€å±‚</span>            <span class="token function">backtrack</span><span class="token punctuation">(</span>nums<span class="token punctuation">,</span> track<span class="token punctuation">,</span> used<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment">//å–æ¶ˆé€‰æ‹©</span>            track<span class="token punctuation">.</span><span class="token function">removeLast</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment">//æ¢å¤è¯¥æ•°å­—ä¸º æœªä½¿ç”¨</span>            used<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">=</span><span class="token boolean">false</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> ç®—æ³• </category>
          
      </categories>
      
      
        <tags>
            
            <tag> LeetCode </tag>
            
            <tag> å›æº¯ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ã€LeetCodeã€‘11.ç››æœ€å¤šæ°´çš„å®¹å™¨</title>
      <link href="/posts/3685282081.html"/>
      <url>/posts/3685282081.html</url>
      
        <content type="html"><![CDATA[<h1 id="1-é—®é¢˜"><a href="#1-é—®é¢˜" class="headerlink" title="1 é—®é¢˜"></a>1 é—®é¢˜</h1><p>ç»™å®šä¸€ä¸ªé•¿åº¦ä¸º n çš„æ•´æ•°æ•°ç»„ <code>height</code> ã€‚æœ‰ n æ¡å‚çº¿ï¼Œç¬¬ i æ¡çº¿çš„ä¸¤ä¸ªç«¯ç‚¹æ˜¯<code> (i, 0)</code> å’Œ <code>(i, height[i])</code> ã€‚</p><p>æ‰¾å‡ºå…¶ä¸­çš„ä¸¤æ¡çº¿ï¼Œä½¿å¾—å®ƒä»¬ä¸ x è½´å…±åŒæ„æˆçš„å®¹å™¨å¯ä»¥å®¹çº³<code>æœ€å¤š</code>çš„æ°´ã€‚</p><p>è¿”å›å®¹å™¨å¯ä»¥å‚¨å­˜çš„<code>æœ€å¤§æ°´é‡</code>ã€‚</p><p>è¯´æ˜ï¼šä½ ä¸èƒ½å€¾æ–œå®¹å™¨ã€‚</p><h2 id="ç¤ºä¾‹-1"><a href="#ç¤ºä¾‹-1" class="headerlink" title="ç¤ºä¾‹ 1"></a>ç¤ºä¾‹ 1</h2><p><img src="https://aliyun-lc-upload.oss-cn-hangzhou.aliyuncs.com/aliyun-lc-upload/uploads/2018/07/25/question_11.jpg" alt="ç¤ºæ„å›¾"></p><blockquote><p>è¾“å…¥ï¼š[1,8,6,2,5,4,8,3,7]<br>è¾“å‡ºï¼š49<br>è§£é‡Šï¼šå›¾ä¸­å‚ç›´çº¿ä»£è¡¨è¾“å…¥æ•°ç»„ [1,8,6,2,5,4,8,3,7]ã€‚åœ¨æ­¤æƒ…å†µä¸‹ï¼Œå®¹å™¨èƒ½å¤Ÿå®¹çº³æ°´ï¼ˆè¡¨ç¤ºä¸ºè“è‰²éƒ¨åˆ†ï¼‰çš„æœ€å¤§å€¼ä¸º 49ã€‚</p></blockquote><h2 id="ç¤ºä¾‹-2"><a href="#ç¤ºä¾‹-2" class="headerlink" title="ç¤ºä¾‹ 2"></a>ç¤ºä¾‹ 2</h2><blockquote><p>è¾“å…¥ï¼šheight &#x3D; [1,1]<br>è¾“å‡ºï¼š1</p></blockquote><p>æç¤ºï¼š</p><ul><li>n &#x3D;&#x3D; height.length</li><li>2 &lt;&#x3D; n &lt;&#x3D; 105</li><li>0 &lt;&#x3D; height[i] &lt;&#x3D; 104</li></ul><h1 id="2-è§£é¢˜æ€è·¯"><a href="#2-è§£é¢˜æ€è·¯" class="headerlink" title="2 è§£é¢˜æ€è·¯"></a>2 è§£é¢˜æ€è·¯</h1><h2 id="2-1-åŒæŒ‡é’ˆ"><a href="#2-1-åŒæŒ‡é’ˆ" class="headerlink" title="2.1 åŒæŒ‡é’ˆ"></a>2.1 åŒæŒ‡é’ˆ</h2><p>è½¬è‡ª<a href="https://leetcode.cn/problems/container-with-most-water/solutions/11491/container-with-most-water-shuang-zhi-zhen-fa-yi-do/">Krahets</a></p><p>è®¾ä¸¤æŒ‡é’ˆ <code>left</code> , <code>right</code> ï¼ŒæŒ‡å‘çš„æ°´æ§½æ¿é«˜åº¦åˆ†åˆ«ä¸º $h_{left}$ï¼Œ$h_{right}$ï¼Œæ­¤çŠ¶æ€ä¸‹æ°´æ§½é¢ç§¯ä¸º $S_{ij}$ ã€‚ç”±äºå¯å®¹çº³æ°´çš„é«˜åº¦ç”±ä¸¤æ¿ä¸­çš„ <code>çŸ­æ¿</code> å†³å®šï¼Œå› æ­¤å¯å¾—å¦‚ä¸‹é¢ç§¯å…¬å¼ ï¼š</p><blockquote><p>$S_{ij}$ &#x3D; (right-left)*Min($h_{left}$ï¼Œ$h_{right}$)</p></blockquote><ul><li>ç®—æ³•æµç¨‹ï¼š<ul><li>åˆå§‹åŒ–ï¼š åŒæŒ‡é’ˆ <code>left</code> , <code>right</code> åˆ†åˆ—æ°´æ§½<code>å·¦</code>ã€<code>å³</code>ä¸¤ç«¯ï¼›</li><li>å¾ªç¯æ”¶çª„ï¼š ç›´è‡³åŒæŒ‡é’ˆç›¸é‡æ—¶è·³å‡ºï¼›</li><li>æ›´æ–°é¢ç§¯æœ€å¤§å€¼ <code>res</code> ï¼›</li><li>é€‰å®šä¸¤æ¿é«˜åº¦ä¸­çš„<code>çŸ­æ¿</code>ï¼Œå‘ä¸­é—´æ”¶çª„ä¸€æ ¼ï¼›</li><li>è¿”å›å€¼ï¼š è¿”å›é¢ç§¯æœ€å¤§å€¼ res å³å¯ï¼›</li></ul></li></ul><p><img src="https://pic.leetcode-cn.com/9341a245384b77afda31ed8b4040d7a382be107a2d22c0e1fc2652a21707cf8c.jpg"></p><h1 id="3-ä»£ç "><a href="#3-ä»£ç " class="headerlink" title="3 ä»£ç "></a>3 ä»£ç </h1><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">class</span> <span class="token class-name">Solution</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">maxArea</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> height<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token comment">//åŒæŒ‡é’ˆ</span>        <span class="token comment">//å®¹é‡ï¼šï¼ˆright-left)*Min(height[left], height[right])</span>        <span class="token keyword">int</span> left<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>        <span class="token keyword">int</span> right<span class="token operator">=</span>height<span class="token punctuation">.</span>length<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>        <span class="token keyword">int</span> res<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>        <span class="token keyword">int</span> s<span class="token punctuation">;</span>        <span class="token keyword">while</span><span class="token punctuation">(</span>left<span class="token operator">&lt;</span>right<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            s<span class="token operator">=</span><span class="token punctuation">(</span>right<span class="token operator">-</span>left<span class="token punctuation">)</span><span class="token operator">*</span><span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>height<span class="token punctuation">[</span>left<span class="token punctuation">]</span><span class="token punctuation">,</span> height<span class="token punctuation">[</span>right<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            res<span class="token operator">=</span><span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span>res<span class="token punctuation">,</span> s<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span><span class="token punctuation">(</span>height<span class="token punctuation">[</span>left<span class="token punctuation">]</span><span class="token operator">&lt;</span>height<span class="token punctuation">[</span>right<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>                left<span class="token operator">++</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>            <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>                right<span class="token operator">--</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">return</span> res<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> ç®—æ³• </category>
          
      </categories>
      
      
        <tags>
            
            <tag> LeetCode </tag>
            
            <tag> åŒæŒ‡é’ˆ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ã€LeetCodeã€‘392. åˆ¤æ–­å­åºåˆ—</title>
      <link href="/posts/4207119070.html"/>
      <url>/posts/4207119070.html</url>
      
        <content type="html"><![CDATA[<h1 id="1-é—®é¢˜"><a href="#1-é—®é¢˜" class="headerlink" title="1 é—®é¢˜"></a>1 é—®é¢˜</h1><p>ç»™å®šå­—ç¬¦ä¸² s å’Œ t ï¼Œåˆ¤æ–­ s æ˜¯å¦ä¸º t çš„å­åºåˆ—ã€‚</p><p>å­—ç¬¦ä¸²çš„ä¸€ä¸ª<code>å­åºåˆ—</code>æ˜¯åŸå§‹å­—ç¬¦ä¸²åˆ é™¤ä¸€äº›ï¼ˆä¹Ÿå¯ä»¥ä¸åˆ é™¤ï¼‰å­—ç¬¦è€Œ<code>ä¸æ”¹å˜</code>å‰©ä½™å­—ç¬¦<code>ç›¸å¯¹ä½ç½®</code>å½¢æˆçš„æ–°å­—ç¬¦ä¸²ã€‚ï¼ˆä¾‹å¦‚ï¼Œâ€aceâ€æ˜¯â€abcdeâ€çš„ä¸€ä¸ªå­åºåˆ—ï¼Œè€Œâ€aecâ€ä¸æ˜¯ï¼‰ã€‚</p><p><strong>è¿›é˜¶</strong>ï¼š</p><p>å¦‚æœæœ‰å¤§é‡è¾“å…¥çš„ Sï¼Œç§°ä½œ S1, S2, â€¦ , Sk å…¶ä¸­ k &gt;&#x3D; 10äº¿ï¼Œä½ éœ€è¦ä¾æ¬¡æ£€æŸ¥å®ƒä»¬æ˜¯å¦ä¸º T çš„å­åºåˆ—ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œä½ ä¼šæ€æ ·æ”¹å˜ä»£ç ï¼Ÿ</p><p><strong>è‡´è°¢</strong>ï¼š</p><p>ç‰¹åˆ«æ„Ÿè°¢ @pbrother æ·»åŠ æ­¤é—®é¢˜å¹¶ä¸”åˆ›å»ºæ‰€æœ‰æµ‹è¯•ç”¨ä¾‹ã€‚</p><h2 id="ç¤ºä¾‹-1"><a href="#ç¤ºä¾‹-1" class="headerlink" title="ç¤ºä¾‹ 1"></a>ç¤ºä¾‹ 1</h2><blockquote><p>è¾“å…¥ï¼šs &#x3D; â€œabcâ€, t &#x3D; â€œahbgdcâ€<br>è¾“å‡ºï¼štrue</p></blockquote><h2 id="ç¤ºä¾‹-2"><a href="#ç¤ºä¾‹-2" class="headerlink" title="ç¤ºä¾‹ 2"></a>ç¤ºä¾‹ 2</h2><blockquote><p>è¾“å…¥ï¼šs &#x3D; â€œaxcâ€, t &#x3D; â€œahbgdcâ€<br>è¾“å‡ºï¼šfalse</p></blockquote><p>æç¤ºï¼š</p><ul><li>0 &lt;&#x3D; s.length &lt;&#x3D; 100</li><li>0 &lt;&#x3D; t.length &lt;&#x3D; $10^4$</li><li>ä¸¤ä¸ªå­—ç¬¦ä¸²éƒ½åªç”±<code>å°å†™å­—ç¬¦</code>ç»„æˆã€‚</li></ul><h1 id="2-è§£é¢˜æ€è·¯"><a href="#2-è§£é¢˜æ€è·¯" class="headerlink" title="2 è§£é¢˜æ€è·¯"></a>2 è§£é¢˜æ€è·¯</h1><h2 id="2-1-è´ªå¿ƒç®—æ³•"><a href="#2-1-è´ªå¿ƒç®—æ³•" class="headerlink" title="2.1 è´ªå¿ƒç®—æ³•"></a>2.1 è´ªå¿ƒç®—æ³•</h2><p>é€ä½æ¯”è¾ƒ<code>s</code>å’Œ<code>t</code>çš„å­—ç¬¦ï¼Œ</p><ul><li>è‹¥$s_i$&#x3D;&#x3D;$t_j$ï¼Œåˆ™ <code>i++</code>;</li><li><code>j++</code></li></ul><p>éå†å®Œæ¯•ï¼ˆä¾æ®æ˜¯è¦ä¹ˆ<code>i==s.length</code>ï¼Œè¦ä¹ˆ<code>j==t.length</code>ï¼‰ï¼Œ<code>s</code>æ­£å¥½éå†å®Œæ¯•ï¼Œå³ <code>i=s.length</code>ï¼Œåˆ™è¯æ˜sæ˜¯tçš„å­åºåˆ—ï¼›å¦åˆ™ä¾¿ä¸æ˜¯ã€‚</p><h2 id="2-2-åŠ¨æ€è§„åˆ’"><a href="#2-2-åŠ¨æ€è§„åˆ’" class="headerlink" title="2.2 åŠ¨æ€è§„åˆ’"></a>2.2 åŠ¨æ€è§„åˆ’</h2><h3 id="2-2-1-å®šä¹‰dp"><a href="#2-2-1-å®šä¹‰dp" class="headerlink" title="2.2.1 å®šä¹‰dp"></a>2.2.1 å®šä¹‰dp</h3><blockquote><p>$dp_{ij}$ è¡¨ç¤ºï¼Œs[0,j] æ˜¯å¦æ˜¯ t[0,i] çš„å­åºåˆ—.</p></blockquote><h3 id="2-2-2-é€’è¿›è§„åˆ™"><a href="#2-2-2-é€’è¿›è§„åˆ™" class="headerlink" title="2.2.2 é€’è¿›è§„åˆ™"></a>2.2.2 é€’è¿›è§„åˆ™</h3><ul><li>è‹¥$s_j$&#x3D;&#x3D;$t_i$ï¼Œåˆ™åªéœ€è¦çŸ¥é“ s[0, j-1] æ˜¯å¦ç­‰äº t[0, i-1] å³å¯ï¼Œå³ï¼š<blockquote><p>$dp_{ij}$ &#x3D; $dp_{i-1, j-1}$</p></blockquote></li></ul><p>eg: t&#x3D;â€abcdsefgtâ€; s&#x3D;â€abstâ€;<br>å‡å®šç°åœ¨å·²ç»éå†è‡³ t[0,4]&#x3D;â€abcdsâ€, s[0,2]&#x3D;â€absâ€. åˆ™$dp_{42}$ &#x3D; $dp_{31}$. å³â€abcdâ€æ˜¯åŒ…å«äº†â€abâ€çš„ã€‚åº”ä¸º true.</p><ul><li>å¦åˆ™ï¼Œè¦åˆ¤æ–­ t[0, i-1]æ˜¯å¦åŒ…å« s[0, j]ï¼Œå³ï¼š<blockquote><p>$dp_{ij}$ &#x3D; $dp_{i-1, j}$</p></blockquote></li></ul><p>åŒæ ·çš„ä¾‹å­ï¼Œå½“å‰ t[0,5]&#x3D;â€abcdseâ€, s[0,3]&#x3D;â€abstâ€, t[5]!&#x3D;s[3]ï¼Œåˆ™ $dp_{53}$ çš„çŠ¶æ€ä¸ $dp_{43}$ æœ‰å…³ï¼Œå³ â€œabcdsâ€ æ˜¯ä¸åŒ…å« â€œabstâ€çš„ã€‚åº”ä¸ºfalseã€‚</p><h1 id="3-ä»£ç "><a href="#3-ä»£ç " class="headerlink" title="3 ä»£ç "></a>3 ä»£ç </h1><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">class</span> <span class="token class-name">Solution</span> <span class="token punctuation">&#123;</span>    <span class="token comment">//è´ªå¿ƒç®—æ³•</span>    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">isSubsequence1</span><span class="token punctuation">(</span><span class="token class-name">String</span> s<span class="token punctuation">,</span> <span class="token class-name">String</span> t<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>        <span class="token keyword">int</span> j<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>        <span class="token keyword">while</span><span class="token punctuation">(</span>i<span class="token operator">&lt;</span>s<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> j<span class="token operator">&lt;</span>t<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            <span class="token keyword">if</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token operator">==</span>t<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span>j<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>                i<span class="token operator">++</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>            j<span class="token operator">++</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token comment">//å¦‚æœséå†å®Œæ¯•ï¼Œåˆ™è¯æ˜æ‰¾åˆ°äº†ï¼Œå¦åˆ™ï¼Œæ²¡æ‰¾åˆ°</span>        <span class="token keyword">return</span> i<span class="token operator">==</span>s<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">//åŠ¨æ€è§„åˆ’</span>    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">isSubsequence</span><span class="token punctuation">(</span><span class="token class-name">String</span> s<span class="token punctuation">,</span> <span class="token class-name">String</span> t<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token comment">//å®šä¹‰ï¼šdp[i][j]ä¸ºs[0,j]æ˜¯å¦ä¸ºt[0,i]çš„å­åºåˆ—</span>        <span class="token keyword">int</span> sLen<span class="token operator">=</span>s<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">int</span> tLen<span class="token operator">=</span>t<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">boolean</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span> dp <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">boolean</span><span class="token punctuation">[</span>tLen<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span>sLen<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token comment">//è‹¥sä¸ºç©ºä¸²ï¼Œåˆ™dp[i][0]å…¨ä¸ºtrueï¼Œç©ºä¸²è‚¯å®šæ˜¯tçš„å­åºåˆ—</span>        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;=</span>tLen<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            dp<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token boolean">true</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token comment">//è§„åˆ’</span>        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>i<span class="token operator">&lt;=</span>tLen<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> j<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>j<span class="token operator">&lt;=</span>sLen<span class="token punctuation">;</span>j<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>                <span class="token comment">//å·²ç»éå†çš„tçš„é•¿åº¦è‡³å°‘è¦æ¯”å·²ç»éå†çš„sçš„é•¿åº¦å¤§</span>                <span class="token keyword">if</span><span class="token punctuation">(</span>i<span class="token operator">&lt;</span>j<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>                    <span class="token keyword">continue</span><span class="token punctuation">;</span>                <span class="token punctuation">&#125;</span>                <span class="token comment">//ç›¸ç­‰ï¼Œåˆ™dp[i][j]çŠ¶æ€å˜æ›´ä¸ºdp[i-1][j-1];</span>                <span class="token keyword">if</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span>i<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">==</span>s<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span>j<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>                    dp<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> dp<span class="token punctuation">[</span>i<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>                <span class="token punctuation">&#125;</span>                <span class="token comment">//ä¸ç­‰ï¼Œåˆ™è¦çœ‹s[0,j]æ˜¯å¦æ˜¯t[0,i-1]çš„å­åºåˆ—</span>                <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>                    dp<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> dp<span class="token punctuation">[</span>i<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">;</span>                <span class="token punctuation">&#125;</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">return</span> dp<span class="token punctuation">[</span>tLen<span class="token punctuation">]</span><span class="token punctuation">[</span>sLen<span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> ç®—æ³• </category>
          
      </categories>
      
      
        <tags>
            
            <tag> LeetCode </tag>
            
            <tag> åŒæŒ‡é’ˆ </tag>
            
            <tag> è´ªå¿ƒç®—æ³• </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ã€Pythonã€‘çˆ¬å–Markdownæ–‡ç« å†…çš„å›¾ç‰‡</title>
      <link href="/posts/653918332.html"/>
      <url>/posts/653918332.html</url>
      
        <content type="html"><![CDATA[<p>ã€Pythonã€‘è‡ªåŠ¨è§£æmarkdownä¸­çš„å›¾ç‰‡å¹¶ä¿å­˜</p><h1 id="1-èµ·å› "><a href="#1-èµ·å› " class="headerlink" title="1.èµ·å› "></a>1.èµ·å› </h1><p>ä¸ºä»€ä¹ˆéœ€è¦pythonæ¥ä¸‹è½½mdé‡Œé¢çš„å›¾ç‰‡ï¼ŸåŸå› å¾ˆç®€å•ï¼Œé‚£å°±æ˜¯éœ€è¦æŠŠå›¾ç‰‡ä¿å­˜ä¸‹æ¥ï¼Œä¸Šä¼ åˆ°ç¬¬äºŒä¸ªå›¾åºŠï¼ˆè¿ç§»ï¼‰</p><p>å¯¹äºé˜¿é‡Œäº‘OSSæ¥è¯´ï¼Œæœ‰ä¸¤ç§è¿ç§»åŠæ³•</p><p>ä½¿ç”¨å®˜æ–¹çš„æ•°æ®å¯¼å‡ºåŠŸèƒ½<br>ä½¿ç”¨apiæ¥å£éå†ossç›®å½•ä¸‹è½½æ‰€æœ‰å›¾ç‰‡<br>è¿™ä¸¤ç§åŠæ³•éƒ½ä¸æ˜¯é‚£ä¹ˆæ–¹ä¾¿ï¼Œæ‰€ä»¥æˆ‘é€‰æ‹©äº†ç¬¬ä¸‰ç§</p><p>è§£ææœ¬åœ°mdæ–‡ä»¶ä¸­çš„img urlï¼Œä¸‹è½½å›¾ç‰‡å¹¶ä¿å­˜åˆ°æœ¬åœ°<br>é‚£è¦æ€ä¹ˆåšå‘¢ï¼ŸğŸ‘‡</p><h1 id="2-æ•™ç¨‹"><a href="#2-æ•™ç¨‹" class="headerlink" title="2.æ•™ç¨‹"></a>2.æ•™ç¨‹</h1><p>æˆ‘åœ¨githubæ‰¾åˆ°äº†è¿™ä¸ªé¡¹ç›® ğŸ‘‰ <a href="https://github.com/Deali-Axy/Markdown-Image-Parser">Deali-Axy&#x2F;Markdown-Image-Parser</a></p><p>ä½œè€…çš„ä»£ç å†™çš„å¾ˆæ£’ï¼Œä½†æ˜¯READMEé‡Œé¢å´å°‘äº†ä¸€ä¸ªé‡è¦çš„å¯åŠ¨æ•™ç¨‹ï¼Œé‚£å°±æ˜¯ä½ éœ€è¦åœ¨å½“å‰ç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ªfilesæ–‡ä»¶å¤¹ï¼ˆmdæ–‡ä»¶æ”¾åˆ°è¿™é‡Œé¢ï¼‰ï¼Œå¯¹åº”å¯åŠ¨é¡¹é‡Œé¢å¼€å¯çš„æ ¹ç›®å½•</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>files_list <span class="token operator">=</span> get_files_list<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>abspath<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token string">'.'</span><span class="token punctuation">,</span> <span class="token string">'files'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>éšåï¼Œæ‰§è¡Œ<code>python spider.py</code>ï¼Œå¼€å§‹è¿è¡Œï¼Œè„šæœ¬ä¼šè‡ªåŠ¨å°†mdè½¬æˆhtmlå¹¶ä¸‹è½½å›¾ç‰‡</p><p>æˆ‘å°†ä½œè€…çš„ä»£ç è¿›ä¸€æ­¥ç»†åŒ–ï¼Œå¹¶ä¿®æ”¹äº†ä¸€éƒ¨åˆ†bugğŸ‘‡å»ºè®®ä½¿ç”¨<a href="https://github.com/musnows/Markdown-Image-Parser">æˆ‘forkçš„ç‰ˆæœ¬</a></p><h2 id="2-1-UnicodeDecodeError"><a href="#2-1-UnicodeDecodeError" class="headerlink" title="2.1 UnicodeDecodeError"></a>2.1 UnicodeDecodeError</h2><p>åœ¨å¯åŠ¨çš„æ—¶å€™ï¼Œä½ å¯èƒ½ä¼šé‡åˆ°è¿™ä¸ªæŠ¥é”™</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">UnicodeDecodeError<span class="token punctuation">:</span> <span class="token string">'utf-8'</span> codec can't decode byte <span class="token number">0xbc</span> <span class="token keyword">in</span> position <span class="token number">2</span><span class="token punctuation">:</span> invalid start byt<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>è§£å†³åŠæ³•å‚è€ƒ ğŸ‘‰ <a href="https://blog.csdn.net/sunflower_sara/article/details/103957385">ç‚¹æˆ‘</a></p><p>è§£å†³åŠæ³•æ˜¯å°†æ‰“å¼€æ–‡ä»¶ç¼–ç çš„utf-8 ä¿®æ”¹æˆISO-8859-1</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token builtin">file</span><span class="token punctuation">,</span> encoding<span class="token operator">=</span><span class="token string">'ISO-8859-1'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>md_content <span class="token operator">=</span> f<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h2 id="2-2-request-failed"><a href="#2-2-request-failed" class="headerlink" title="2.2 request failed"></a>2.2 request failed</h2><p>å› ä¸ºä½œè€…å¹¶æ²¡æœ‰å†™åˆ¤æ–­ï¼Œæ­¤æ—¶å°±ä¼šå‡ºç°ä¸€ä¸ªä¸¥é‡é—®é¢˜ï¼šæœ¬åœ°å›¾ç‰‡ä¹Ÿä¼šè¿›è¡Œrequestsè¯·æ±‚</p><p>æ¯”å¦‚æˆ‘çš„mdé‡Œé¢å°±æœ‰ä¸€äº›å›¾ç‰‡æ˜¯æœ¬åœ°çš„<code>img/å›¾ç‰‡æ–‡ä»¶å</code>ï¼Œè¿™ä¸ªä»£ç ä¾æ—§å¯¹è¿™ä¸ªè·¯å¾„å½“åšç½‘ç»œè·¯å¾„è¿›è¡Œè¯·æ±‚ï¼Œäºæ˜¯å°±å‡ºç°äº†æŠ¥é”™</p><p>æ‰€ä»¥å°±éœ€è¦åœ¨<code>download_pics</code>å‡½æ•°ä¸­å¯¹urlè¿›è¡Œåˆ¤æ–­ï¼Œè¿™é‡Œå¯ä»¥å†™æˆä¸‹é¢çš„æ ¼å¼ï¼ˆå› ä¸ºæˆ‘çŸ¥é“æˆ‘çš„é˜¿é‡Œäº‘OSSé“¾æ¥é‡Œé¢ä¸åŒ…å«imgæ–‡ä»¶å¤¹ï¼Œæ‰€ä»¥<code>img/</code>çš„å›¾ç‰‡æ˜¯æœ¬åœ°æ–‡ä»¶</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">download_pics</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> <span class="token builtin">file</span><span class="token punctuation">,</span>MDfilename<span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token keyword">if</span> <span class="token string">'img/'</span> <span class="token keyword">in</span> url<span class="token punctuation">:</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'ä¸å¤„ç†æœ¬åœ°å›¾ç‰‡: '</span><span class="token punctuation">,</span> url<span class="token punctuation">)</span><span class="token keyword">return</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>ä½†æ˜¯è¿™æ ·å…¶å®è¿˜æ˜¯æœ‰ç‚¹å‘†å‘†çš„ï¼Œæˆ‘ä»¬ç›´æ¥åˆ¤æ–­httpåœ¨ä¸åœ¨é‡Œé¢ä¸å°±çŸ¥é“æ˜¯ä¸æ˜¯ç½‘ç»œå›¾ç‰‡äº†ğŸ˜‚</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">download_pics</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> <span class="token builtin">file</span><span class="token punctuation">,</span>MDfilename<span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token keyword">if</span> <span class="token string">'http'</span> <span class="token keyword">not</span> <span class="token keyword">in</span> url<span class="token punctuation">:</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'ä¸å¤„ç†æœ¬åœ°å›¾ç‰‡: '</span><span class="token punctuation">,</span> url<span class="token punctuation">)</span><span class="token keyword">return</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h2 id="2-3-å›¾ç‰‡ä¿å­˜è·¯å¾„"><a href="#2-3-å›¾ç‰‡ä¿å­˜è·¯å¾„" class="headerlink" title="2.3 å›¾ç‰‡ä¿å­˜è·¯å¾„"></a>2.3 å›¾ç‰‡ä¿å­˜è·¯å¾„</h2><p>é»˜è®¤æƒ…å†µä¸‹ï¼Œå›¾ç‰‡ä¼šä¿å­˜åˆ°å­æ–‡ä»¶å¤¹ä¸‹çš„markdownæ–‡ä»¶åç›®å½•</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">targer_dir <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>dirname<span class="token punctuation">,</span>assert_dir<span class="token punctuation">)</span><span class="token keyword">if</span> <span class="token keyword">not</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span>targer_dir<span class="token punctuation">)</span><span class="token punctuation">:</span>     os<span class="token punctuation">.</span>mkdir<span class="token punctuation">(</span>targer_dir<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>è¿™æ ·å…¶å®éå¸¸éå¸¸ä¸æ–¹ä¾¿ç®¡ç†ï¼Œæœ‰å‡ ä¸ªmdæ–‡æ¡£å°±æœ‰å‡ ä¸ªmdå›¾ç‰‡è·¯å¾„ï¼Œå¯å¤ªéš¾å—äº†</p><p>æ‰€ä»¥æˆ‘ä»¬éœ€è¦æ³¨é‡Šæ‰è¿™éƒ¨åˆ†ä»£ç ï¼Œç›´æ¥é€‰æ‹©ä¸€ä¸ªæ ¹ç›®å½•è¿›è¡Œå›¾ç‰‡çš„ä¿å­˜</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">targer_dir <span class="token operator">=</span><span class="token string">'./files/img/'</span> <span class="token comment"># æ‰€æœ‰å›¾ç‰‡éƒ½ä¿å­˜åˆ° ./files/img/ æ–‡ä»¶å¤¹é‡Œé¢</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h2 id="2-4-try-x2F-except"><a href="#2-4-try-x2F-except" class="headerlink" title="2.4 try&#x2F;except"></a>2.4 try&#x2F;except</h2><p>ä½œè€…ä»£ç é‡Œé¢çš„æœ€æœ€æœ€å¤§æ¼æ´ï¼Œé‚£å°±æ˜¯æ²¡æœ‰å¯¹forå¾ªç¯é‡Œé¢çš„è¯·æ±‚è¿›è¡Œ<code>try/except</code></p><p>è¿™æ ·å°±ä¼šå¯¼è‡´ï¼Œå¦‚æœæœ‰ä¸€ä¸ªå›¾ç‰‡è¯·æ±‚å¤±è´¥ï¼Œæ•´ä¸ªè¿›ç¨‹ä¼šç›´æ¥ç»ˆæ­¢ï¼</p><p>é‚£ä¹ˆé—®é¢˜å°±æ¥äº†ï¼Œå³ä¾¿è¿™ä¸ªç¨‹åºä¼šåœ¨éå†çš„æ—¶å€™æ‰“å°å½“å‰å¤„ç†çš„æ–‡ä»¶åå­—ï¼Œä½†è¿™éœ€è¦ç”¨æˆ·å»ç¿»å‘½ä»¤è¡Œè¾“å‡ºï¼Œå†æ‰¾åˆ°åˆ°åº•æ˜¯å“ªä¸€ä¸ªå›¾ç‰‡å‘ç”Ÿé”™è¯¯ï¼Œéå¸¸éå¸¸éå¸¸éš¾å—ï¼</p><p>å¦‚æœé‡æ–°æ‰§è¡Œï¼Œé‚£å°±ç›¸å½“ä¸æŠŠå·²ç»ä¸‹å¥½çš„å›¾ç‰‡åˆé‡ä¸‹ä¸€éï¼Œæµªè´¹OSSçš„æµé‡ã€‚</p><p>æ‰€ä»¥æˆ‘ä»¬å¿…é¡»è¦ç»™forå¾ªç¯å†…éƒ¨æ·»åŠ ä¸Šå¼‚å¸¸æ•è·ï¼Œå¦‚æœé‡åˆ°é”™è¯¯ï¼Œå°±å°†è¿™ä¸ªå›¾ç‰‡çš„urlå­˜ä¸‹æ¥ï¼Œç»§ç»­å¾€åæ‰§è¡Œï¼</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">for</span> <span class="token builtin">file</span> <span class="token keyword">in</span> files_list<span class="token punctuation">:</span>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'æ­£åœ¨å¤„ç†ï¼š</span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token builtin">file</span><span class="token punctuation">&#125;</span></span><span class="token string">'</span></span><span class="token punctuation">)</span>    <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token builtin">file</span><span class="token punctuation">,</span> encoding<span class="token operator">=</span><span class="token string">'ISO-8859-1'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>        md_content <span class="token operator">=</span> f<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>    pics_list <span class="token operator">=</span> get_pics_list<span class="token punctuation">(</span>md_content<span class="token punctuation">)</span>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'å‘ç°å›¾ç‰‡ </span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token builtin">len</span><span class="token punctuation">(</span>pics_list<span class="token punctuation">)</span><span class="token punctuation">&#125;</span></span><span class="token string"> å¼ '</span></span><span class="token punctuation">)</span>    <span class="token keyword">for</span> index<span class="token punctuation">,</span> pic <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>pics_list<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">try</span><span class="token punctuation">:</span>            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'æ­£åœ¨ä¸‹è½½ç¬¬ </span><span class="token interpolation"><span class="token punctuation">&#123;</span>index <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">&#125;</span></span><span class="token string"> å¼ å›¾ç‰‡...'</span></span><span class="token punctuation">)</span>            MDfilename <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>basename<span class="token punctuation">(</span><span class="token builtin">file</span><span class="token punctuation">)</span> <span class="token comment"># å½“å‰å¤„ç†çš„mdæ–‡ä»¶çš„åå­—</span>            download_pics<span class="token punctuation">(</span>pic<span class="token punctuation">,</span> <span class="token builtin">file</span><span class="token punctuation">,</span>MDfilename<span class="token punctuation">)</span>            time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">0.5</span><span class="token punctuation">)</span> <span class="token comment"># é¿å…ä¸‹è½½è¶…é€Ÿ</span>        <span class="token keyword">except</span> KeyboardInterrupt<span class="token punctuation">:</span>            os<span class="token punctuation">.</span>abort<span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token keyword">except</span><span class="token punctuation">:</span>            <span class="token keyword">print</span><span class="token punctuation">(</span>traceback<span class="token punctuation">.</span>format_exc<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>            <span class="token keyword">if</span> MDfilename <span class="token keyword">not</span> <span class="token keyword">in</span> err_img<span class="token punctuation">:</span>                err_img<span class="token punctuation">[</span>MDfilename<span class="token punctuation">]</span><span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span>            <span class="token comment"># æ·»åŠ å›¾ç‰‡</span>            err_img<span class="token punctuation">[</span>MDfilename<span class="token punctuation">]</span><span class="token punctuation">.</span>append<span class="token punctuation">(</span>pic<span class="token punctuation">)</span>            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"å›¾ç‰‡è·å–é”™è¯¯ï¼š"</span><span class="token punctuation">,</span>pic<span class="token punctuation">)</span>            time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'å¤„ç†å®Œæˆã€‚'</span></span><span class="token punctuation">)</span>write_file<span class="token punctuation">(</span><span class="token string">'err.json'</span><span class="token punctuation">,</span>err_img<span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'å†™å…¥errå®Œæˆ'</span></span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å®Œæ•´ä»£ç è§æˆ‘çš„githubä»“åº“<br>è½¬è‡ªï¼š<a href="https://blog.csdn.net/muxuen/article/details/128941666">æ…•é›ªåå¹´</a></p>]]></content>
      
      
      <categories>
          
          <category> Pythonå­¦ä¹ ä¸åº”ç”¨ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Python </tag>
            
            <tag> Markdown </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ã€LeetCodeã€‘283.ç§»åŠ¨é›¶</title>
      <link href="/posts/1974715365.html"/>
      <url>/posts/1974715365.html</url>
      
        <content type="html"><![CDATA[<h1 id="1-é—®é¢˜"><a href="#1-é—®é¢˜" class="headerlink" title="1 é—®é¢˜"></a>1 é—®é¢˜</h1><p>ç»™å®šä¸€ä¸ªæ•°ç»„ <code>nums</code>ï¼Œç¼–å†™ä¸€ä¸ªå‡½æ•°å°†<code>æ‰€æœ‰ 0 </code>ç§»åŠ¨åˆ°æ•°ç»„çš„<code>æœ«å°¾</code>ï¼ŒåŒæ—¶ä¿æŒ<code>éé›¶å…ƒç´ </code>çš„<code>ç›¸å¯¹é¡ºåº</code>ã€‚</p><p><strong>è¯·æ³¨æ„</strong> ï¼Œå¿…é¡»åœ¨ä¸å¤åˆ¶æ•°ç»„çš„æƒ…å†µä¸‹åŸåœ°å¯¹æ•°ç»„è¿›è¡Œæ“ä½œã€‚</p><h2 id="ç¤ºä¾‹-1"><a href="#ç¤ºä¾‹-1" class="headerlink" title="ç¤ºä¾‹ 1"></a>ç¤ºä¾‹ 1</h2><blockquote><p>è¾“å…¥: nums &#x3D; [0,1,0,3,12]<br>è¾“å‡º: [1,3,12,0,0]</p></blockquote><h2 id="ç¤ºä¾‹-2"><a href="#ç¤ºä¾‹-2" class="headerlink" title="ç¤ºä¾‹ 2"></a>ç¤ºä¾‹ 2</h2><blockquote><p>è¾“å…¥: nums &#x3D; [0]<br>è¾“å‡º: [0]</p></blockquote><p>æç¤º:</p><ul><li>1 &lt;&#x3D; nums.length &lt;&#x3D; 104</li><li>-231 &lt;&#x3D; nums[i] &lt;&#x3D; 231 - 1</li></ul><p>è¿›é˜¶ï¼šä½ èƒ½å°½é‡å‡å°‘å®Œæˆçš„æ“ä½œæ¬¡æ•°å—ï¼Ÿ</p><h1 id="2-è§£é¢˜æ€è·¯"><a href="#2-è§£é¢˜æ€è·¯" class="headerlink" title="2 è§£é¢˜æ€è·¯"></a>2 è§£é¢˜æ€è·¯</h1><h2 id="2-1-å¿«æ’æ€æƒ³"><a href="#2-1-å¿«æ’æ€æƒ³" class="headerlink" title="2.1 å¿«æ’æ€æƒ³"></a>2.1 å¿«æ’æ€æƒ³</h2><p>å›å¿†ä¸‹å¿«æ’ï¼ŒåŸºæœ¬æ€æƒ³æ˜¯</p><ul><li>ç¡®å®šä¸€åŸºå‡†<code>pivot</code>ï¼š<ul><li>è‹¥å³æŒ‡é’ˆ<code>right</code>æ‰€æŒ‡å‘çš„å€¼æ¯”<code>pivot</code>å¤§ï¼Œåˆ™<code>right--</code>ï¼›</li><li>å¦åˆ™äº¤æ¢è¿™ä¸¤å€¼ï¼Œç„¶åæ¯”è¾ƒå·¦æŒ‡é’ˆ<code>left</code>æŒ‡å‘çš„å€¼ï¼›<ul><li>è‹¥<code>pivot</code>å¤§äº<code>left</code>æ‰€æŒ‡çš„å€¼ï¼Œleft++ï¼›</li><li>å¦åˆ™ï¼Œäº¤æ¢<code>pivot</code>å’Œ<code>left</code>æ‰€æŒ‡çš„å€¼ã€‚</li></ul></li></ul></li></ul><p>æ€»ä¹‹ï¼Œå¿«æ’çš„æ€æƒ³ä¸€å¥è¯å°±æ˜¯ï¼Œå°†æ•°ç»„æ’åˆ—æˆä¸€ä¸ªä»¥åŸºå‡†å€¼ä¸ºå‡†ï¼Œå·¦ä¾§æ˜¯æ¯”åŸºå‡†å€¼å°çš„å€¼ï¼Œå³ä¾§æ˜¯æ¯”åŸºå‡†å€¼å¤§çš„å€¼ã€‚</p><p>æœ¬é¢˜ä¸­ï¼ŒåŸºå‡†å€¼ä¸º0ï¼Œåªè¦<code>right</code>æ‰€æŒ‡çš„å€¼ä¸ä¸º0ï¼Œå°±ä¸<code>left</code>æ‰€æŒ‡çš„å€¼äº¤æ¢ï¼Œ<code>left++</code>.å¾ªç¯<code>right</code>ï¼Œåˆ™ä¸ä¸º0çš„å€¼å°±éƒ½åœ¨å·¦è¾¹äº†ã€‚<br><img src="https://pic.leetcode-cn.com/36d1ac5d689101cbf9947465e94753c626eab7fcb736ae2175f5d87ebc85fdf0-283_2.gif" alt="åŒæŒ‡é’ˆç®—æ³•ç¤ºæ„å›¾"></p><h2 id="2-2-ä¸¤æ¬¡éå†"><a href="#2-2-ä¸¤æ¬¡éå†" class="headerlink" title="2.2 ä¸¤æ¬¡éå†"></a>2.2 ä¸¤æ¬¡éå†</h2><p>æˆ‘ä»¬åˆ›å»ºä¸¤ä¸ªæŒ‡é’ˆ i å’Œ jï¼Œç¬¬ä¸€æ¬¡éå†çš„æ—¶å€™æŒ‡é’ˆ j ç”¨æ¥è®°å½•<code>å½“å‰æœ‰å¤šå°‘é0 å…ƒç´ </code>ã€‚å³éå†çš„æ—¶å€™æ¯é‡åˆ°ä¸€ä¸ª <code>é0</code> å…ƒç´ å°±å°†å…¶å¾€æ•°ç»„å·¦è¾¹æŒªï¼Œç¬¬ä¸€æ¬¡éå†å®Œåï¼Œj æŒ‡é’ˆçš„ä¸‹æ ‡å°±æŒ‡å‘äº†æœ€åä¸€ä¸ª <code>é0</code> å…ƒç´ ä¸‹æ ‡ã€‚<br>ç¬¬äºŒæ¬¡éå†çš„æ—¶å€™ï¼Œèµ·å§‹ä½ç½®å°±ä» j å¼€å§‹åˆ°ç»“æŸï¼Œå°†å‰©ä¸‹çš„è¿™æ®µåŒºåŸŸå†…çš„å…ƒç´ å…¨éƒ¨ç½®ä¸º 0ã€‚<br>åŠ¨ç”»æ¼”ç¤ºï¼š<br><img src="https://pic.leetcode-cn.com/9669b4ffb158eaeeee6f0cd66a70f24411575edab1ab8a037c4c9084b1c743f5-283_1.gif" alt="ä¸¤æ¬¡éå†"></p><p>è½¬è‡ªä½œè€…ï¼šç‹å°¼ç›</p><h1 id="3-ä»£ç "><a href="#3-ä»£ç " class="headerlink" title="3 ä»£ç "></a>3 ä»£ç </h1><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">class</span> <span class="token class-name">Solution</span> <span class="token punctuation">&#123;</span>  <span class="token comment">//ä¸¤æ¬¡éå†</span>  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">moveZeroes</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> nums<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>nums <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      <span class="token keyword">return</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">//ç¬¬ä¸€æ¬¡éå†çš„æ—¶å€™ï¼ŒjæŒ‡é’ˆè®°å½•é0çš„ä¸ªæ•°ï¼Œåªè¦æ˜¯é0çš„ç»Ÿç»Ÿéƒ½èµ‹ç»™nums[j]</span>    <span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> nums<span class="token punctuation">.</span>length<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>nums<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        nums<span class="token punctuation">[</span>j<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> nums<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>      <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">//é0å…ƒç´ ç»Ÿè®¡å®Œäº†ï¼Œå‰©ä¸‹çš„éƒ½æ˜¯0äº†</span>    <span class="token comment">//æ‰€ä»¥ç¬¬äºŒæ¬¡éå†æŠŠæœ«å°¾çš„å…ƒç´ éƒ½èµ‹ä¸º0å³å¯</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> j<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> nums<span class="token punctuation">.</span>length<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      nums<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>  <span class="token punctuation">&#125;</span>  <span class="token comment">//åŒæŒ‡é’ˆ</span>  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">moveZeroes2</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> nums<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token comment">//leftæŒ‡å‘ç¬¬ä¸€ä¸ªä¸º0çš„å…ƒç´ ç´¢å¼•</span>    <span class="token keyword">int</span> left <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token keyword">int</span> right <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> right <span class="token operator">&lt;</span> nums<span class="token punctuation">.</span>length<span class="token punctuation">;</span> right<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      <span class="token comment">// å½“å‰å…ƒç´ !=0ï¼Œå°±æŠŠå…¶äº¤æ¢åˆ°å·¦è¾¹ï¼Œç­‰äº0çš„äº¤æ¢åˆ°å³è¾¹</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>nums<span class="token punctuation">[</span>right<span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">int</span> tmp <span class="token operator">=</span> nums<span class="token punctuation">[</span>right<span class="token punctuation">]</span><span class="token punctuation">;</span>        nums<span class="token punctuation">[</span>right<span class="token punctuation">]</span> <span class="token operator">=</span> nums<span class="token punctuation">[</span>left<span class="token punctuation">]</span><span class="token punctuation">;</span>        nums<span class="token punctuation">[</span>left<span class="token punctuation">]</span> <span class="token operator">=</span> tmp<span class="token punctuation">;</span>        left<span class="token operator">++</span><span class="token punctuation">;</span>      <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>  <span class="token punctuation">&#125;</span>  <span class="token comment">//ä¸€æ¬¡éå†</span>  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">moveZeroes3</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> nums<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">int</span> cnt <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> nums<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>nums<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        cnt<span class="token operator">++</span><span class="token punctuation">;</span>      <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>nums<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> cnt <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        nums<span class="token punctuation">[</span>i <span class="token operator">-</span> cnt<span class="token punctuation">]</span> <span class="token operator">=</span> nums<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>        nums<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>      <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> ç®—æ³• </category>
          
      </categories>
      
      
        <tags>
            
            <tag> LeetCode </tag>
            
            <tag> åŒæŒ‡é’ˆ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ã€MySQLå­¦ä¹ ã€‘1.åŸºç¡€</title>
      <link href="/posts/3577477089.html"/>
      <url>/posts/3577477089.html</url>
      
        <content type="html"><![CDATA[<h1 id="1-æ¨èä¹¦ç±"><a href="#1-æ¨èä¹¦ç±" class="headerlink" title="1 æ¨èä¹¦ç±"></a>1 æ¨èä¹¦ç±</h1><p>-ã€Šæ·±å…¥æµ…å‡º MySQLã€‹<br>-ã€Šæ·±å…¥ç†è§£ MySQL æ ¸å¿ƒæŠ€æœ¯ã€‹<br>-ã€Šé«˜æ€§èƒ½ MySQLã€‹<br>-ã€ŠMySQL æŠ€æœ¯å†…å¹• : InnoDB å­˜å‚¨å¼•æ“ ç¬¬ 2 ç‰ˆã€‹<br>-ã€ŠMySqlå¿…çŸ¥å¿…ä¼šã€‹</p><h1 id="2-MySQL-çš„åˆ†æ”¯ã€å˜ç§ä¸æ›¿ä»£"><a href="#2-MySQL-çš„åˆ†æ”¯ã€å˜ç§ä¸æ›¿ä»£" class="headerlink" title="2 MySQL çš„åˆ†æ”¯ã€å˜ç§ä¸æ›¿ä»£"></a>2 MySQL çš„åˆ†æ”¯ã€å˜ç§ä¸æ›¿ä»£</h1><p>MySQL å˜ç§æœ‰å¥½å‡ ä¸ªï¼Œä¸»è¦æœ‰<strong>ä¸‰ä¸ª</strong>ä¹…ç»è€ƒéªŒçš„ä¸»æµå˜ç§:<code>Percona Server</code>ï¼Œ <code>MariaDB</code> å’Œ <code>Drizzle</code>ã€‚å®ƒä»¬éƒ½æœ‰æ´»è·ƒçš„ç”¨æˆ·ç¤¾åŒºå’ŒæŸç§ç¨‹åº¦ä¸Šçš„å•†ä¸šæ”¯æŒï¼Œå‡ç”±ç‹¬ç«‹çš„æœåŠ¡ä¾›åº”å•†æ”¯æŒã€‚</p><h2 id="2-1-Drizzle"><a href="#2-1-Drizzle" class="headerlink" title="2.1 Drizzle"></a>2.1 Drizzle</h2><p><code>Drizzle</code> æ˜¯çœŸæ­£çš„ <code>MySQL</code> åˆ†æ”¯ï¼Œè€Œä¸”æ˜¯<code>å®Œå…¨å¼€æº</code>çš„äº§å“ï¼Œè€Œéåªæ˜¯ä¸ªå˜ç§æˆ–å¢å¼ºç‰ˆæœ¬ã€‚å®ƒ<strong>å¹¶ä¸ä¸ MySQL å…¼å®¹</strong>ï¼Œä¸èƒ½ç®€å•åœ°å°† MySQL åç«¯æ›¿æ¢ä¸º Drizzleã€‚</p><p>Drizzle ä¸ MySQL æœ‰å¾ˆå¤§å·®åˆ«ï¼Œè¿›è¡Œäº†ä¸€äº›<code>é‡å¤§æ›´æ”¹</code>ï¼Œç”šè‡³ SQL è¯­æ³•çš„å˜åŒ–éƒ½éå¸¸å¤§ï¼Œ<code>è®¾è®¡ç›®æ ‡ä¹‹ä¸€</code>æ˜¯<strong>æä¾›ä¸€ç§å‡ºè‰²çš„è§£å†³æ–¹æ¡ˆæ¥è§£å†³é«˜å¯ç”¨æ€§é—®é¢˜</strong>ã€‚åœ¨å®ç°ä¸Šï¼ŒDrizzle æ¸…é™¤äº†ä¸€äº›è¡¨ç°ä¸ä½³å’Œä¸å¿…è¦çš„åŠŸèƒ½ï¼Œå°†å¾ˆå¤šä»£ç é‡å†™ï¼Œå¯¹å®ƒä»¬è¿›è¡Œäº†ä¼˜åŒ–ï¼Œç”šè‡³å°†æ‰€ç”¨è¯­è¨€ä» <code>C</code> æ¢æˆäº† <code>C++</code>ã€‚</p><p>æ­¤å¤–ï¼ŒDrizzle <code>å¦ä¸€ä¸ªè®¾è®¡ç›®æ ‡</code>æ˜¯<strong>èƒ½å¾ˆå¥½çš„é€‚åº”å…·æœ‰å¤§é‡å†…å®¹çš„å¤šæ ¸æœåŠ¡å™¨ã€ è¿è¡Œ Linux çš„ 64 ä½æœºå™¨ã€äº‘è®¡ç®—ä¸­ä½¿ç”¨çš„æœåŠ¡å™¨ã€æ‰˜ç®¡ç½‘ç«™çš„æœåŠ¡å™¨å’Œæ¯åˆ†é’Ÿæ¥æ”¶æ•°ä»¥ä¸‡è®¡ç‚¹å‡»ç‡çš„æœåŠ¡å™¨å¹¶ä¸”å¤§å¹…åº¦çš„å‰Šå‡æœåŠ¡å™¨æˆæœ¬</strong>ã€‚</p><h2 id="2-2-MariaDB"><a href="#2-2-MariaDB" class="headerlink" title="2.2 MariaDB"></a>2.2 MariaDB</h2><p>åœ¨ Sun æ”¶è´­ MySQL åï¼Œ<code>Monty Widenius</code>ï¼Œè¿™ä½ MySQL çš„åˆ›å»ºè€…ï¼Œå› ä¸è®¤åŒ MySQL å¼€å‘æµç¨‹è€Œç¦»å¼€ Sunã€‚ä»–æˆç«‹äº† <code>Monty</code> ç¨‹åºå…¬å¸ï¼Œåˆ›ç«‹äº† MariaDBã€‚MariaDB çš„<code>ç›®æ ‡</code>æ˜¯<code>ç¤¾åŒºå¼€å‘</code>ï¼Œ<code>Bug ä¿®å¤</code>å’Œè®¸å¤šçš„<code>æ–°ç‰¹æ€§</code>ã€‚å®é™…ä¸Šï¼Œå¯ä»¥å°† MariaDB è§†ä¸º MySQL çš„<code>æ‰©å±•é›†</code>ï¼Œå®ƒä¸ä»…æä¾› MySQL æä¾›çš„æ‰€æœ‰åŠŸèƒ½ï¼Œè¿˜æä¾›å…¶ä»–åŠŸèƒ½ã€‚MariaDB æ˜¯åŸç‰ˆ MySQL çš„è¶…é›†ï¼Œå› æ­¤å·²æœ‰çš„ç³»ç»Ÿ<strong>ä¸éœ€è¦ä»»ä½•ä¿®æ”¹å°±å¯ä»¥è¿è¡Œ</strong>ã€‚</p><p>è¯¸å¦‚ <code>Google</code>ï¼Œ<code>Facebook</code>ã€<code>ç»´åŸºç™¾ç§‘</code>ç­‰å…¬å¸æˆ–è€…ç½‘ç«™æ‰€ä½¿ç”¨äº† MariaDBã€‚ä¸è¿‡ Monty å…¬å¸ä¸æ˜¯ä»¥èµ¢åˆ©ä¸ºç›®çš„ï¼Œè€Œæ˜¯ç”±äº§å“é©±åŠ¨çš„ï¼Œè¿™å¯èƒ½ä¼šå¸¦æ¥é—®é¢˜ï¼Œå› ä¸ºæ²¡æœ‰èµ¢åˆ©çš„å…¬å¸ä¸ä¸€å®šèƒ½é•¿ä¹…ç»´æŒä¸‹å»ã€‚</p><h2 id="2-3-Percona-Server"><a href="#2-3-Percona-Server" class="headerlink" title="2.3 Percona Server"></a>2.3 Percona Server</h2><p>ç”±é¢†å…ˆçš„ MySQL å’¨è¯¢å…¬å¸ <code>Percona</code> å‘å¸ƒï¼ŒPercona å…¬å¸çš„å£å·å°±æ˜¯<code>The Database Performance Experts</code>ï¼ŒPercona çš„åˆ›å§‹äººä¹Ÿå°±æ˜¯<code>ã€Šé«˜æ€§èƒ½ MySQLã€‹</code>ä¹¦çš„ä½œè€…ã€‚</p><p>Percona Server æ˜¯ä¸ªä¸ MySQL <code>å‘åå…¼å®¹</code>çš„<code>æ›¿ä»£å“</code>ï¼Œå®ƒå°½å¯èƒ½ä¸æ”¹å˜ SQL è¯­æ³•ã€ å®¢æˆ·ç«¯&#x2F;æœåŠ¡å™¨åè®®å’Œç£ç›˜ä¸Šçš„æ–‡ä»¶æ ¼å¼ã€‚ä»»ä½•è¿è¡Œåœ¨ MySQL ä¸Šçš„éƒ½å¯ä»¥è¿è¡Œåœ¨ Percona Server ä¸Šè€Œä¸éœ€è¦ä¿®æ”¹ã€‚åˆ‡æ¢åˆ° Percona Server åªéœ€è¦å…³é—­ MySQL å’Œå¯åŠ¨ <code>PerconaServer</code>ï¼Œä¸éœ€è¦å¯¼å‡ºå’Œé‡æ–°å¯¼å…¥æ•°æ®ã€‚</p><p>Percona Server æœ‰<code>ä¸‰ä¸ª</code>ä¸»è¦çš„ç›®æ ‡ï¼š</p><ul><li>é€æ˜ï¼Œå¢åŠ å…è®¸ç”¨æˆ·æ›´ç´§å¯†åœ°æŸ¥çœ‹æœåŠ¡å™¨å†…éƒ¨ä¿¡æ¯å’Œè¡Œä¸ºçš„æ–¹æ³•ã€‚æ¯”å¦‚æ…¢æŸ¥è¯¢æ—¥å¿—ä¸­ç‰¹åˆ«å¢åŠ çš„è¯¦ç»†ä¿¡æ¯ï¼›</li><li>æ€§èƒ½ï¼Œ<code>Percona Server</code> åŒ…å«è®¸å¤šæ€§èƒ½å’Œå¯æ‰©å±•æ€§æ–¹é¢çš„æ”¹è¿›ï¼Œè¿˜åŠ å¼ºäº†æ€§èƒ½çš„<code>å¯é¢„æµ‹æ€§</code>å’Œ<code>ç¨³å®šæ€§</code>ã€‚å…¶ä¸­ä¸»è¦é›†ä¸­äº <code>InnoDB</code>ï¼›</li><li>æ“ä½œçµæ´»æ€§ï¼Œ<code>Percona Server</code> ä½¿æ“ä½œäººå‘˜å’Œç³»ç»Ÿç®¡ç†å‘˜åœ¨è®© MySQL ä½œä¸ºæ¶æ„çš„ä¸€éƒ¨åˆ†è€Œ<code>å¯é å¹¶ç¨³å®š</code>è¿è¡Œæ—¶æä¾›äº†å¾ˆå¤šä¾¿åˆ©ã€‚</li></ul><p>ä¸€èˆ¬æ¥è¯´ï¼Œ<code>Percona Server</code> ä¸­çš„è®¸å¤šç‰¹æ€§ä¼šåœ¨åæ¥çš„<code>æ ‡å‡† MySQL</code> ä¸­å‡ºç°ã€‚ å›½å†…å…¬å¸é˜¿é‡Œå†…éƒ¨å°±è¿è¡Œäº†ä¸Šåƒä¸ª Percona Server çš„å®ä¾‹ã€‚</p><h2 id="2-4-Postgre-SQL"><a href="#2-4-Postgre-SQL" class="headerlink" title="2.4 Postgre SQL"></a>2.4 Postgre SQL</h2><p><code>PostgreSQL</code> ç§°è‡ªå·±æ˜¯ä¸–ç•Œä¸Šæœ€å…ˆè¿›çš„å¼€æºæ•°æ®åº“ï¼ŒåŒæ—¶ä¹Ÿæ˜¯ä¸ªä¸€ä¸“å¤šé•¿çš„<code>å…¨æ ˆæ•°æ®åº“</code>ã€‚æœ€åˆæ˜¯ 1985 å¹´åœ¨åŠ åˆ©ç¦å°¼äºšå¤§å­¦ä¼¯å…‹åˆ©åˆ†æ ¡å¼€å‘çš„ã€‚</p><ul><li><code>PostgreSQL</code> çš„<code>ç¨³å®šæ€§æå¼º</code>ï¼Œåœ¨å´©æºƒã€æ–­ç”µä¹‹ç±»çš„ç¾éš¾åœºæ™¯ä¸‹ä¾ç„¶å¯ä»¥ä¿è¯æ•°æ®çš„æ­£ç¡®ï¼›</li><li>åœ¨é«˜å¹¶å‘è¯»å†™ï¼Œè´Ÿè½½é€¼è¿‘æé™ä¸‹ï¼Œ<code>PG</code> çš„æ€§èƒ½æŒ‡æ ‡ä»å¯ä»¥ç»´æŒ<code>åŒæ›²çº¿</code>ç”šè‡³<code>å¯¹æ•°æ›²çº¿</code>ï¼Œåˆ°é¡¶å³°ä¹‹åä¸å†ä¸‹é™ï¼Œè¡¨ç°å¾—éå¸¸ç¨³å®šï¼Œè€Œ MySQL æ˜æ˜¾å‡ºç° ä¸€ä¸ªæ³¢å³°åä¸‹æ»‘ï¼›</li><li>PG å¤šå¹´æ¥åœ¨ <code>GIS</code> é¢†åŸŸå¤„äºä¼˜åŠ¿åœ°ä½ï¼Œå› ä¸ºå®ƒæœ‰ä¸°å¯Œçš„å‡ ä½•ç±» å‹ï¼Œå®é™…ä¸Šä¸æ­¢å‡ ä½•ç±»å‹ï¼ŒPG æœ‰å¤§é‡<code>å­—å…¸</code>ã€<code>æ•°ç»„</code>ã€<code>bitmap</code> ç­‰æ•°æ®ç±»å‹ï¼Œç›¸æ¯”ä¹‹ä¸‹ mysql å°±å·®å¾ˆå¤šã€‚</li></ul><p>æ‰€ä»¥æ€»çš„æ¥è¯´ï¼ŒPostgreSQL æ›´<code>å­¦æœ¯åŒ–</code>ä¸€äº›ï¼Œåœ¨ç»å¯¹éœ€è¦<code>å¯é æ€§</code>å’Œ<code>æ•°æ®å®Œæ•´æ€§</code>çš„æ—¶å€™ï¼ŒPostgreSQL æ˜¯æ›´å¥½çš„é€‰æ‹©ã€‚ä½†æ˜¯ä»å•†ä¸šæ”¯æŒã€æ–‡æ¡£èµ„æ–™ã€ æ˜“ç”¨æ€§ï¼Œç¬¬ä¸‰æ–¹æ”¯æŒæ¥è¯´ï¼ŒMySQL æ— ç–‘æ›´å¥½äº›ã€‚</p><h2 id="2-5-SQLite"><a href="#2-5-SQLite" class="headerlink" title="2.5 SQLite"></a>2.5 SQLite</h2><p><code>SQLite</code> æ˜¯ä¸–ç•Œä¸Šéƒ¨ç½²<code>æœ€å¹¿æ³›</code>çš„æ•°æ®åº“å¼•æ“ï¼Œä¸ºç‰©è”ç½‘(IoT)ä¸‹çš„æ•°æ®åº“é¦–é€‰ï¼Œå¹¶ä¸”æ˜¯<code>æ‰‹æœº</code>ï¼Œ<code>PDA</code>ï¼Œç”šè‡³ <code>MP3 æ’­æ”¾å™¨</code>ä¸‹çš„é¦–é€‰ã€‚</p><p><code>SQLite</code> ä»£ç å ç”¨ç©ºé—´å°ï¼Œ å¹¶ä¸”ä¸éœ€è¦æ•°æ®åº“ç®¡ç†å‘˜çš„ç»´æŠ¤ã€‚</p><p><code>SQLite</code> æ²¡æœ‰å•ç‹¬çš„æœåŠ¡å™¨è¿›ç¨‹ï¼Œæä¾›çš„äº‹åŠ¡ä¹ŸåŸºæœ¬ç¬¦åˆ <code>ACID</code>ã€‚å½“ç„¶ï¼Œç®€å•ä¹Ÿå°±æ„å‘³ç€åŠŸèƒ½å’Œæ€§èƒ½å—é™ã€‚</p><h1 id="3-MySQL-ä½“ç³»æ¶æ„"><a href="#3-MySQL-ä½“ç³»æ¶æ„" class="headerlink" title="3 MySQL ä½“ç³»æ¶æ„"></a>3 MySQL ä½“ç³»æ¶æ„</h1><p>ä¸Šå›¾<br><img src="https://cdn.jsdelivr.net/gh/zyxelva/picgo@main/markdown/MySQL-Architecture.jpeg" alt="MySQLä½“ç³»æ¶æ„"></p><p>å¯ä»¥çœ‹å‡º MySQL æœ€ä¸Šå±‚æ˜¯<code>è¿æ¥ç»„ä»¶</code>ã€‚ä¸‹é¢<code>æœåŠ¡å™¨</code>æ˜¯ç”±<code>è¿æ¥æ± </code>ã€<code>ç®¡ç†å·¥å…·</code>å’Œ<code>æœåŠ¡</code>ã€<code>SQL æ¥å£</code>ã€<code>è§£æå™¨</code>ã€<code>ä¼˜åŒ–å™¨</code>ã€<code>ç¼“å­˜</code>ã€<code>å­˜å‚¨å¼•æ“</code>ã€<code>æ–‡ä»¶ç³»ç»Ÿ</code>ç»„æˆã€‚</p><h2 id="3-1-è¿æ¥æ± "><a href="#3-1-è¿æ¥æ± " class="headerlink" title="3.1 è¿æ¥æ± "></a>3.1 è¿æ¥æ± </h2><p>ç”±äºæ¯æ¬¡å»ºç«‹å»ºç«‹éœ€è¦æ¶ˆè€—å¾ˆå¤šæ—¶é—´ï¼Œ<strong>è¿æ¥æ± çš„ä½œç”¨</strong>å°±æ˜¯å°†è¿™äº›è¿æ¥<code>ç¼“å­˜</code>ä¸‹æ¥ï¼Œä¸‹æ¬¡å¯ä»¥ç›´æ¥ç”¨å·²ç»å»ºç«‹å¥½çš„è¿æ¥ï¼Œæå‡æœåŠ¡å™¨æ€§èƒ½ã€‚</p><h2 id="3-2-ç®¡ç†å·¥å…·å’ŒæœåŠ¡"><a href="#3-2-ç®¡ç†å·¥å…·å’ŒæœåŠ¡" class="headerlink" title="3.2 ç®¡ç†å·¥å…·å’ŒæœåŠ¡"></a>3.2 ç®¡ç†å·¥å…·å’ŒæœåŠ¡</h2><p><code>ç³»ç»Ÿç®¡ç†</code>å’Œ<code>æ§åˆ¶å·¥å…·</code>ï¼Œä¾‹å¦‚<code>å¤‡ä»½æ¢å¤</code>ã€<code>Mysql å¤åˆ¶</code>ã€<code>é›†ç¾¤</code>ç­‰ã€‚</p><h2 id="3-3-SQLæ¥å£"><a href="#3-3-SQLæ¥å£" class="headerlink" title="3.3 SQLæ¥å£"></a>3.3 SQLæ¥å£</h2><p>æ¥å—ç”¨æˆ·çš„SQLå‘½ä»¤ï¼Œå¹¶ä¸”è¿”å›ç”¨æˆ·éœ€è¦æŸ¥è¯¢çš„ç»“æœã€‚æ¯”å¦‚<code>select from</code> å°±æ˜¯è°ƒç”¨ <code>SQL Interface</code>ã€‚</p><h2 id="3-4-è§£æå™¨"><a href="#3-4-è§£æå™¨" class="headerlink" title="3.4 è§£æå™¨"></a>3.4 è§£æå™¨</h2><p><code>SQL å‘½ä»¤</code>ä¼ é€’åˆ°<code>è§£æå™¨</code>çš„æ—¶å€™ä¼šè¢«è§£æå™¨<code>éªŒè¯å’Œè§£æ</code>ã€‚</p><p>è§£æå™¨ä¸»è¦åŠŸèƒ½ï¼š</p><ul><li>å°† <code>SQLè¯­å¥</code>åˆ†è§£æˆ<code>æ•°æ®ç»“æ„</code>ï¼Œå¹¶å°†è¿™ä¸ªç»“æ„ä¼ é€’åˆ°åç»­æ­¥éª¤ï¼Œä»¥å SQL è¯­å¥çš„ä¼ é€’å’Œå¤„ç†å°±æ˜¯åŸºäºè¿™ä¸ªç»“æ„çš„ï¼›</li><li>å¦‚æœåœ¨åˆ†è§£æ„æˆä¸­é‡åˆ°é”™è¯¯ï¼Œé‚£ä¹ˆå°±è¯´æ˜è¿™ä¸ª SQL è¯­å¥æ˜¯<code>ä¸åˆç†çš„</code>ã€‚</li></ul><h2 id="3-5-ä¼˜åŒ–å™¨"><a href="#3-5-ä¼˜åŒ–å™¨" class="headerlink" title="3.5 ä¼˜åŒ–å™¨"></a>3.5 ä¼˜åŒ–å™¨</h2><p>æŸ¥è¯¢ä¼˜åŒ–å™¨ï¼ŒSQL è¯­å¥åœ¨æŸ¥è¯¢ä¹‹å‰ä¼šä½¿ç”¨æŸ¥è¯¢ä¼˜åŒ–å™¨å¯¹æŸ¥è¯¢è¿›è¡Œä¼˜åŒ–ã€‚</p><h2 id="3-6-ç¼“å­˜å™¨"><a href="#3-6-ç¼“å­˜å™¨" class="headerlink" title="3.6 ç¼“å­˜å™¨"></a>3.6 ç¼“å­˜å™¨</h2><p>æŸ¥è¯¢ç¼“å­˜ï¼Œå¦‚æœæŸ¥è¯¢ç¼“å­˜æœ‰å‘½ä¸­çš„æŸ¥è¯¢ç»“æœï¼ŒæŸ¥è¯¢è¯­å¥å°±å¯ä»¥ç›´æ¥å»æŸ¥è¯¢ç¼“å­˜ä¸­å–æ•°æ®ã€‚</p><p>è¿™ä¸ªç¼“å­˜æœºåˆ¶æ˜¯ç”±ä¸€ç³»åˆ—<code>å°ç¼“å­˜</code>ç»„æˆçš„ã€‚æ¯”å¦‚<code>è¡¨ç¼“å­˜</code>ï¼Œ<code>è®°å½•ç¼“å­˜</code>ï¼Œ<code>key ç¼“å­˜</code>ï¼Œ <code>æƒé™ç¼“å­˜</code>ç­‰ã€‚</p><h2 id="3-7-å­˜å‚¨å¼•æ“"><a href="#3-7-å­˜å‚¨å¼•æ“" class="headerlink" title="3.7 å­˜å‚¨å¼•æ“"></a>3.7 å­˜å‚¨å¼•æ“</h2><p>æ˜¯åº•å±‚<code>ç‰©ç†ç»“æ„</code>å’Œ<code>å®é™…æ–‡ä»¶è¯»å†™</code>çš„å®ç°ã€‚</p><p>ç±»å‹æœ‰<code>InnoDBå­˜å‚¨å¼•æ“</code>ï¼Œ<code>MylSAM å­˜å‚¨å¼•æ“</code>ï¼Œ<code>CSV å¼•æ“</code>ï¼Œ<code>Memory å¼•æ“</code>ï¼Œ<code>NDB é›†ç¾¤å¼•æ“</code>ï¼Œ<code>Federated å¼•æ“</code>ï¼Œ<code>Blackhole å¼•æ“</code>ï¼Œ<code>Archive å¼•æ“</code>ï¼Œ<code>Mrg_MylSAM</code>ã€‚</p><p>è¿˜æœ‰ç¬¬ä¸‰æ–¹å¼•æ“<code>Percona çš„ XtraDB å­˜å‚¨å¼•æ“</code>ï¼Œ<code>TokuDB å¼•æ“</code>ï¼Œ<code>Infobright</code>ã€‚</p><p>ä»<code>MySQL 5.6</code>åŠä»¥åï¼ŒMySQLæ•°æ®åº“é»˜è®¤çš„å¼•æ“å°±æ˜¯<code>InnoDB</code>ï¼Œåœ¨ <code>MySQL 5.1 åŠä¹‹å‰</code>çš„ç‰ˆæœ¬ï¼Œ<code>MyISAM</code> æ˜¯é»˜è®¤çš„å­˜å‚¨å¼•æ“ã€‚</p><h3 id="3-7-1-InnoDB-å­˜å‚¨å¼•æ“"><a href="#3-7-1-InnoDB-å­˜å‚¨å¼•æ“" class="headerlink" title="3.7.1 InnoDB å­˜å‚¨å¼•æ“"></a>3.7.1 InnoDB å­˜å‚¨å¼•æ“</h3><ul><li>ç‰¹æ€§<ul><li>InnoDBæ˜¯äº‹åŠ¡æ€§å­˜å‚¨å¼•æ“ï¼Œ<code>æ”¯æŒäº‹åŠ¡</code>ï¼Œä¹Ÿæ˜¯MySQLå†…<code>å”¯ä¸€</code>ä¸€ä¸ªæ”¯æŒäº‹åŠ¡çš„å­˜å‚¨å¼•æ“ï¼›</li><li>å®Œå…¨æ”¯æŒäº‹åŠ¡çš„<code>ACID</code>ç‰¹æ€§ï¼›</li><li>InnoDBæ”¯æŒ<code>è¡Œé”</code>ã€<code>é¡µé”</code>å’Œ<code>è¡¨é”</code>ï¼Œåœ¨ä½¿ç”¨å¾—å½“çš„æ—¶å€™ï¼Œå¯ä»¥æœ‰æ•ˆåœ°æé«˜æ•°æ®åº“çš„å¹¶å‘ç¨‹åº¦ã€‚</li></ul></li></ul><h3 id="3-7-2-MylSAM-å­˜å‚¨å¼•æ“"><a href="#3-7-2-MylSAM-å­˜å‚¨å¼•æ“" class="headerlink" title="3.7.2 MylSAM å­˜å‚¨å¼•æ“"></a>3.7.2 MylSAM å­˜å‚¨å¼•æ“</h3><p>æä¾›å¦‚<code>å‹ç¼©è¡¨</code>ã€<code>ç©ºé—´æ•°æ®ç´¢å¼•</code>ã€<code>å…¨æ–‡ç´¢å¼•</code>ç­‰ç‰¹æ€§ã€‚</p><p><strong>ä¸æ”¯æŒ</strong><code>äº‹åŠ¡</code>å’Œ<code>è¡Œçº§é”</code>ï¼Œå´©æºƒå<code>æ— æ³•å®‰å…¨æ¢å¤</code>ï¼Œä½†å®ƒç»ä¸æ˜¯ä¸€æ— æ˜¯å¤„çš„ã€‚å¯¹äº<code>åªè¯»</code>çš„æ•°æ®ï¼Œæˆ–è€…<code>è¡¨æ¯”è¾ƒå°</code>ã€å¯ä»¥å¿å—ä¿®å¤(repair)æ“ä½œï¼Œåˆ™ä¾ç„¶å¯ä»¥ç»§ç»­ä½¿ç”¨ <code>MyISAM</code>ã€‚</p><h3 id="3-7-3-MyISAMå’ŒInnoDBçš„æ¯”è¾ƒ"><a href="#3-7-3-MyISAMå’ŒInnoDBçš„æ¯”è¾ƒ" class="headerlink" title="3.7.3 MyISAMå’ŒInnoDBçš„æ¯”è¾ƒ"></a>3.7.3 MyISAMå’ŒInnoDBçš„æ¯”è¾ƒ</h3><p><code>MyISAM</code>å’Œ<code>InnoDB</code>æ˜¯MySQLæ•°æ®åº“ä¸­<code>æœ€å¸¸ç”¨</code>çš„ä¸¤ä¸ªå¼•æ“ï¼Œä¸‹é¢æ¯”è¾ƒä¸€ä¸‹ä¸¤ä¸ªå¼•æ“çš„<code>åŒºåˆ«</code>ã€‚</p><table border="0" cellpadding="0" cellspacing="0" width="764" style="border-collapse: collapse;table-layout:fixed;width:573pt;box-sizing: inherit;border-spacing: 0px; font-variant-ligatures: normal;font-variant-caps: normal;orphans: 2; text-align:start;widows: 2;-webkit-text-stroke-width: 0px;text-decoration-thickness: initial; text-decoration-style: initial;text-decoration-color: initial"> <col width="91" style="mso-width-source:userset;mso-width-alt:2901;width:68pt"> <col width="253" style="mso-width-source:userset;mso-width-alt:8106;width:190pt"> <col width="420" style="mso-width-source:userset;mso-width-alt:13440;width:315pt"> <tr height="24" style="height:18.0pt;box-sizing: inherit;border-bottom:rgba(0, 0, 0, 0.12)">  <td height="24" class="xl65" width="91" style="height:18.0pt;width:68pt">å¯¹æ¯”é¡¹</td>  <td class="xl65" width="253" style="width:190pt">MyISAM</td>  <td class="xl65" width="420" style="width:315pt">InnoDB</td> </tr> <tr height="24" style="height:18.0pt;box-sizing: inherit;border-bottom:rgba(0, 0, 0, 0.12)">  <td height="24" class="xl66" style="height:18.0pt;box-sizing: inherit;display:  table-cell;border-radius: 2px;min-width: 80px">ä¸»å¤–é”®</td>  <td class="xl66" style="box-sizing: inherit;display:table-cell;border-radius: 2px;  min-width: 80px">ä¸æ”¯æŒ</td>  <td class="xl66" style="box-sizing: inherit;display:table-cell;border-radius: 2px;  min-width: 80px">æ”¯æŒ</td> </tr> <tr height="24" style="height:18.0pt;box-sizing: inherit;border-bottom:rgba(0, 0, 0, 0.12)">  <td height="24" class="xl66" style="height:18.0pt;box-sizing: inherit;display:  table-cell;border-radius: 2px;min-width: 80px">äº‹åŠ¡</td>  <td class="xl66" style="box-sizing: inherit;display:table-cell;border-radius: 2px;  min-width: 80px">ä¸æ”¯æŒ</td>  <td class="xl66" style="box-sizing: inherit;display:table-cell;border-radius: 2px;  min-width: 80px">æ”¯æŒ</td> </tr> <tr height="24" style="mso-height-source:userset;height:18.0pt;box-sizing: inherit;  border-bottom:rgba(0, 0, 0, 0.12)">  <td rowspan="3" height="72" class="xl66" style="height:54.0pt;box-sizing: inherit;  display:table-cell;border-radius: 2px;min-width: 80px">è¡Œè¡¨é”</td>  <td rowspan="3" class="xl67" width="253" style="width:190pt;box-sizing: inherit;  display:table-cell;border-radius: 2px;min-width: 80px">è¡¨é”<br>    ä¸é€‚åˆé«˜å¹¶å‘çš„è¯»å†™æ“ä½œ</td>  <td rowspan="3" class="xl67" width="420" style="width:315pt;box-sizing: inherit;  display:table-cell;border-radius: 2px;min-width: 80px">è¡Œé”<br>    é€‚åˆé«˜å¹¶å‘æ“ä½œ<br>    åŒæ—¶ä¹Ÿæ”¯æŒè¡¨é”å’Œé¡µé”</td> </tr> <tr height="24" style="mso-height-source:userset;height:18.0pt"> </tr> <tr height="24" style="mso-height-source:userset;height:18.0pt"> </tr> <tr height="24" style="height:18.0pt;box-sizing: inherit;border-bottom:rgba(0, 0, 0, 0.12)">  <td height="24" class="xl66" style="height:18.0pt;box-sizing: inherit;display:  table-cell;border-radius: 2px;min-width: 80px">ç¼“å­˜</td>  <td class="xl66" style="box-sizing: inherit;display:table-cell;border-radius: 2px;  min-width: 80px">åªç¼“å­˜ç´¢å¼•ï¼Œä¸ç¼“å­˜çœŸå®æ•°æ®</td>  <td class="xl66" style="box-sizing: inherit;display:table-cell;border-radius: 2px;  min-width: 80px">ä¸ä»…ç¼“å­˜ç´¢å¼•ï¼Œè¿˜è¦ç¼“å­˜çœŸå®æ•°æ®ï¼Œå¯¹å†…å­˜è¦æ±‚é«˜</td> </tr> <tr height="24" style="height:18.0pt;box-sizing: inherit;border-bottom:rgba(0, 0, 0, 0.12)">  <td height="24" class="xl66" style="height:18.0pt;box-sizing: inherit;display:  table-cell;border-radius: 2px;min-width: 80px">è¡¨ç©ºé—´</td>  <td class="xl66" style="box-sizing: inherit;display:table-cell;border-radius: 2px;  min-width: 80px">å°</td>  <td class="xl66" style="box-sizing: inherit;display:table-cell;border-radius: 2px;  min-width: 80px">å¤§</td> </tr> <tr height="24" style="height:18.0pt;box-sizing: inherit;border-bottom:rgba(0, 0, 0, 0.12)">  <td height="24" class="xl66" style="height:18.0pt;box-sizing: inherit;display:  table-cell;border-radius: 2px;min-width: 80px">å…³æ³¨ç‚¹</td>  <td class="xl66" style="box-sizing: inherit;display:table-cell;border-radius: 2px;  min-width: 80px">æ€§èƒ½</td>  <td class="xl66" style="box-sizing: inherit;display:table-cell;border-radius: 2px;  min-width: 80px">äº‹åŠ¡</td> </tr> <tr height="24" style="height:18.0pt;box-sizing: inherit;border-bottom:rgba(0, 0, 0, 0.12)">  <td height="24" class="xl66" style="height:18.0pt;box-sizing: inherit;display:  table-cell;border-radius: 2px;min-width: 80px">é»˜è®¤å®‰è£…</td>  <td class="xl66" style="box-sizing: inherit;display:table-cell;border-radius: 2px;  min-width: 80px">Y</td>  <td class="xl66" style="box-sizing: inherit;display:table-cell;border-radius: 2px;  min-width: 80px">Y</td> </tr> <![if supportMisalignedColumns]> <tr height="0" style="display:none">  <td width="91" style="width:68pt"></td>  <td width="253" style="width:190pt"></td>  <td width="420" style="width:315pt"></td> </tr> <![endif]></table><h2 id="3-8-æ–‡ä»¶ç³»ç»Ÿ"><a href="#3-8-æ–‡ä»¶ç³»ç»Ÿ" class="headerlink" title="3.8 æ–‡ä»¶ç³»ç»Ÿ"></a>3.8 æ–‡ä»¶ç³»ç»Ÿ</h2><h3 id="3-8-1-ç›®å½•å’Œæ–‡ä»¶"><a href="#3-8-1-ç›®å½•å’Œæ–‡ä»¶" class="headerlink" title="3.8.1 ç›®å½•å’Œæ–‡ä»¶"></a>3.8.1 ç›®å½•å’Œæ–‡ä»¶</h3><ul><li>binç›®å½•ï¼šå­˜æ”¾ç€è®¸å¤š<code>å¯æ‰§è¡Œæ–‡ä»¶</code>ï¼Œæ¯”å¦‚<code>mysqld</code>ã€<code>mysqldump</code>ã€‚</li><li>æ•°æ®ç›®å½•</li></ul><p>åƒ<code>InnoDB</code>ã€<code>MyISAM</code> è¿™æ ·çš„å­˜å‚¨å¼•æ“éƒ½æ˜¯æŠŠè¡¨å­˜å‚¨åœ¨<code>ç£ç›˜</code>ä¸Šçš„ï¼Œè€Œæ“ä½œç³»ç»Ÿç”¨æ¥ç®¡ç†ç£ç›˜çš„é‚£ä¸ªä¸œä¸œåˆè¢«ç§°ä¸º<code>æ–‡ä»¶ç³»ç»Ÿ</code>ï¼Œæ‰€ä»¥ç”¨ä¸“ä¸šä¸€ç‚¹çš„è¯æ¥è¡¨è¿°å°±æ˜¯ï¼š</p><blockquote><p>åƒ <code>InnoDB</code>ã€<code>MyISAM</code> è¿™æ ·çš„å­˜å‚¨å¼•æ“éƒ½æ˜¯æŠŠ<code>è¡¨</code>å­˜å‚¨åœ¨<code>æ–‡ä»¶ç³»ç»Ÿ</code>ä¸Šçš„ã€‚<br>å½“æˆ‘ä»¬æƒ³<code>è¯»å–</code>æ•°æ®çš„æ—¶å€™ï¼Œè¿™äº›å­˜å‚¨å¼•æ“ä¼šä»æ–‡ä»¶ç³»ç»Ÿä¸­æŠŠæ•°æ®<code>è¯»å‡ºæ¥</code>è¿”å›ç»™æˆ‘ä»¬ï¼Œ å½“æˆ‘ä»¬æƒ³<code>å†™å…¥</code>æ•°æ®çš„æ—¶å€™ï¼Œè¿™äº›å­˜å‚¨å¼•æ“ä¼šæŠŠè¿™äº›æ•°æ®åˆ<code>å†™å›æ–‡ä»¶ç³»ç»Ÿ</code>ã€‚</p></blockquote><h4 id="3-8-1-1-ç¡®å®š-MySQL-ä¸­çš„æ•°æ®ç›®å½•"><a href="#3-8-1-1-ç¡®å®š-MySQL-ä¸­çš„æ•°æ®ç›®å½•" class="headerlink" title="3.8.1.1 ç¡®å®š MySQL ä¸­çš„æ•°æ®ç›®å½•"></a>3.8.1.1 ç¡®å®š MySQL ä¸­çš„æ•°æ®ç›®å½•</h4><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">show variables like <span class="token string">'datadir'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h4 id="3-8-1-2-æ•°æ®ç›®å½•çš„ä½œç”¨"><a href="#3-8-1-2-æ•°æ®ç›®å½•çš„ä½œç”¨" class="headerlink" title="3.8.1.2 æ•°æ®ç›®å½•çš„ä½œç”¨"></a>3.8.1.2 æ•°æ®ç›®å½•çš„ä½œç”¨</h4><p>MySOL åœ¨è¿è¡Œè¿‡ç¨‹ä¸­éƒ½ä¼šäº§ç”Ÿå“ªäº›æ•°æ®å‘¢?<br>å½“ç„¶ä¼šåŒ…å«æˆ‘ä»¬åˆ›å»ºçš„<code>æ•°æ®åº“</code>ã€ <code>è¡¨</code>ã€<code>è§†å›¾</code>å’Œ<code>è§¦å‘å™¨</code>ç­‰<strong>ç”¨æˆ·æ•°æ®</strong>ï¼Œé™¤äº†è¿™äº›ç”¨æˆ·æ•°æ®ï¼Œä¸ºäº†ç¨‹åºæ›´å¥½çš„è¿è¡Œï¼ŒMySQL ä¹Ÿä¼šåˆ›å»ºä¸€äº›å…¶ä»–çš„é¢å¤–æ•°æ®ã€‚</p><ul><li><code>æ•°æ®åº“</code>åœ¨æ–‡ä»¶ç³»ç»Ÿä¸­çš„è¡¨ç¤º<ul><li>åœ¨æ•°æ®ç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ªå’Œæ•°æ®åº“å<code>åŒå</code>çš„å­ç›®å½•ï¼ˆæˆ–è€…è¯´æ˜¯æ–‡ä»¶å¤¹)ï¼›</li><li>åœ¨ä¸è¯¥æ•°æ®åº“å<code>åŒå</code>çš„å­ç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ªåä¸º<code>db.opt</code> çš„æ–‡ä»¶ï¼Œè¿™ä¸ªæ–‡ä»¶ä¸­åŒ…å«äº†è¯¥æ•°æ®åº“çš„å„ç§å±æ€§ï¼Œæ¯”æ–¹è¯´è¯¥æ•°æ®åº“çš„<code>å­—ç¬¦é›†</code>å’Œ<code>æ¯”è¾ƒè§„åˆ™</code>æ˜¯ä¸ªå•¥ã€‚</li></ul></li><li><code>è¡¨</code>åœ¨æ–‡ä»¶ç³»ç»Ÿä¸­çš„è¡¨ç¤º<ul><li>è¡¨ç»“æ„çš„å®šä¹‰ï¼šæ ¼å¼ï¼šè¡¨å.frmï¼›</li><li>è¡¨ä¸­çš„æ•°æ®ï¼šåœ¨<code>MyISAM</code>ã€<code>InnoDB</code>å­˜å‚¨å¼•æ“ä¸­åˆå„ä¸ç›¸åŒã€‚<ul><li><code>MyISAM</code>ï¼šæ•°æ®å’Œç´¢å¼•æ˜¯åˆ†å¼€å­˜æ”¾çš„ï¼›æ— è¡¨ç©ºé—´ä¸€è¯´ï¼›è¡¨æ•°æ®éƒ½å­˜æ”¾åˆ°å¯¹åº”çš„æ•°æ®åº“å­ç›®å½•ä¸‹ã€‚</li><li><code>InnoDB</code>ï¼šåœ¨<code>MySQL5.6</code>ç‰ˆæœ¬ä¹‹å‰ï¼Œ<code>InnoDB</code>é»˜è®¤æ˜¯é‡‡ç”¨<code>ç³»ç»Ÿè¡¨ç©ºé—´</code>ï¼Œä½†æ˜¯<code>5.6ä»¥å</code>å°±é»˜è®¤é‡‡ç”¨äº†<code>ç‹¬ç«‹è¡¨ç©ºé—´</code>ï¼›</li></ul></li></ul></li></ul><blockquote><p>Tipsï¼š</p><ul><li><code>ç³»ç»Ÿè¡¨ç©ºé—´</code>ï¼šä¸€ä¸ªMySQLæ•°æ®åº“ä¸­ï¼Œå­˜å‚¨çš„æ•°æ®éƒ½æ˜¯æ”¾åœ¨<code>ä¸€ä¸ªç³»ç»Ÿçº§çš„æ–‡ä»¶</code>ä¸­ï¼Œä¹Ÿå°±æ˜¯æ‰€æœ‰è¡¨çš„æ•°æ®éƒ½å­˜å‚¨åœ¨<code>åŒä¸€ä¸ªæ–‡ä»¶</code>ä¸­ã€‚</li><li><code>ç‹¬ç«‹è¡¨ç©ºé—´</code>ï¼šæ¯ä¸ªè¡¨çš„æ•°æ®<code>å¯¹åº”ä¸€ä¸ªæ•°æ®æ–‡ä»¶</code>ï¼Œäº’ä¸å¹²æ‰°ã€‚</li></ul></blockquote><blockquote><p>ç‹¬ç«‹è¡¨ç©ºé—´å’Œç³»ç»Ÿè¡¨ç©ºé—´çš„æ¯”è¾ƒï¼š</p><ul><li><code>ç³»ç»Ÿè¡¨ç©ºé—´</code><strong>æ— æ³•</strong>ç®€å•çš„æ”¶ç¼©æ–‡ä»¶çš„å¤§å°ï¼›</li><li><code>ç‹¬ç«‹è¡¨ç©ºé—´</code>å¯ä»¥é€šè¿‡optimize tableæ”¶ç¼©æ–‡ä»¶ï¼›</li><li><code>ç³»ç»Ÿè¡¨ç©ºé—´</code>ä¼šäº§ç”Ÿ<code>IOç“¶é¢ˆ</code>ï¼Œåœ¨æ•°æ®é‡å¤§çš„æ—¶å€™ï¼Œè¯»å–æ•ˆç‡è¾ƒç‹¬ç«‹è¡¨ç©ºé—´æ…¢ï¼›</li><li><code>ç‹¬ç«‹è¡¨ç©ºé—´</code>å¯ä»¥<code>åŒæ—¶</code>å‘å¤šä¸ªæ–‡ä»¶åˆ·æ–°æ•°æ®ï¼Œå› ä¸ºæ¯ä¸ªè¡¨å¯¹åº”çš„å­˜å‚¨æ–‡ä»¶æ˜¯<code>ç‹¬ç«‹çš„</code>ã€‚</li></ul></blockquote><p><img src="https://cdn.jsdelivr.net/gh/zyxelva/picgo@main/markdown/MySQL-Tablespace.png" alt="InnoDBä¸‹çš„ç‹¬ç«‹è¡¨ç©ºé—´"></p><h4 id="3-8-1-2-æ—¥å¿—æ–‡ä»¶"><a href="#3-8-1-2-æ—¥å¿—æ–‡ä»¶" class="headerlink" title="3.8.1.2 æ—¥å¿—æ–‡ä»¶"></a>3.8.1.2 æ—¥å¿—æ–‡ä»¶</h4><ul><li><code>é”™è¯¯æ—¥å¿—</code>ï¼ˆerror logï¼‰<ul><li>å¯¹MySQL çš„<code>å¯åŠ¨</code>ã€<code>è¿è¡Œ</code>ã€<code>å…³é—­</code>è¿‡ç¨‹è¿›è¡Œäº†<code>è®°å½•</code>ï¼›</li><li>ä¹Ÿè®°å½•ä¸€äº›<code>è­¦å‘Šä¿¡æ¯</code>æˆ–<code>æ­£ç¡®çš„ä¿¡æ¯</code>ï¼›</li><li>æŸ¥çœ‹é”™è¯¯æ—¥å¿—æ–‡ä»¶çš„ä½ç½®ï¼š<code>show variables like &#39;log_error&#39;\G</code>ã€‚</li></ul></li><li><code>æ…¢æŸ¥è¯¢æ—¥å¿—</code>ï¼ˆslow query logï¼‰</li><li><code>æŸ¥è¯¢æ—¥å¿—</code>ï¼ˆquery logï¼‰ï¼šé»˜è®¤æ–‡ä»¶åï¼šä¸»æœºå.logã€‚</li><li><code>äºŒè¿›åˆ¶æ–‡ä»¶</code>ï¼ˆbin logï¼‰<ul><li>è®°å½•äº†å¯¹<code>MySQL</code> æ•°æ®åº“<code>æ‰§è¡Œæ›´æ”¹çš„æ‰€æœ‰æ“ä½œ</code>ï¼›</li><li>ä¸åŒ…æ‹¬<code>select</code> å’Œ<code>show</code> è¿™ç±»æ“ä½œï¼›</li><li>å‡ ç§ä½œç”¨ï¼š<code>æ¢å¤</code>ï¼ˆrecoveryï¼‰,<code>å¤åˆ¶</code>ï¼ˆreplicationï¼‰,<code>å®¡è®¡</code>ï¼ˆauditï¼‰ã€‚</li></ul></li></ul><h4 id="3-8-1-3-å…¶ä»–çš„é¢å¤–æ•°æ®"><a href="#3-8-1-3-å…¶ä»–çš„é¢å¤–æ•°æ®" class="headerlink" title="3.8.1.3 å…¶ä»–çš„é¢å¤–æ•°æ®"></a>3.8.1.3 å…¶ä»–çš„é¢å¤–æ•°æ®</h4><ul><li>æœåŠ¡å™¨è¿›ç¨‹æ–‡ä»¶</li><li><code>socket</code> æ–‡ä»¶</li><li>é»˜è®¤&#x2F;è‡ªåŠ¨ç”Ÿæˆçš„<code>SSL</code> å’Œ<code>RSA è¯ä¹¦</code>å’Œ<code>å¯†é’¥</code>æ–‡ä»¶ã€‚</li></ul><h1 id="4-ç³»ç»Ÿåº“"><a href="#4-ç³»ç»Ÿåº“" class="headerlink" title="4 ç³»ç»Ÿåº“"></a>4 ç³»ç»Ÿåº“</h1><h2 id="4-1-performance-schema"><a href="#4-1-performance-schema" class="headerlink" title="4.1 performance_schema"></a>4.1 performance_schema</h2><p>ä¿å­˜MySQL æœåŠ¡å™¨è¿è¡Œè¿‡ç¨‹ä¸­çš„ä¸€äº›<code>çŠ¶æ€ä¿¡æ¯</code>ï¼ŒåŒ…æ‹¬<code>ç»Ÿè®¡æœ€è¿‘æ‰§è¡Œäº†å“ªäº›è¯­å¥</code>ï¼Œ<code>åœ¨æ‰§è¡Œè¿‡ç¨‹çš„æ¯ä¸ªé˜¶æ®µéƒ½èŠ±è´¹äº†å¤šé•¿æ—¶é—´</code>ï¼Œ<code>å†…å­˜çš„ä½¿ç”¨æƒ…å†µ</code>ç­‰ç­‰ä¿¡æ¯ã€‚</p><h2 id="4-2-sys"><a href="#4-2-sys" class="headerlink" title="4.2 sys"></a>4.2 sys</h2><p>é€šè¿‡è§†å›¾çš„å½¢å¼æŠŠ<code>information_schema</code> å’Œ <code>performance_schema</code> ç»“åˆèµ·æ¥ï¼Œè®©ç¨‹åºå‘˜å¯ä»¥æ›´æ–¹ä¾¿åœ°äº†è§£<code>MySQL æœåŠ¡å™¨</code>çš„ä¸€äº›<code>æ€§èƒ½ä¿¡æ¯</code>ã€‚</p><p>æ”¯æŒMySQL 5.6 æˆ–æ›´é«˜ç‰ˆæœ¬ã€‚</p><h2 id="4-3-information-schema"><a href="#4-3-information-schema" class="headerlink" title="4.3 information_schema"></a>4.3 information_schema</h2><p>ä¿å­˜ç€MySQL æœåŠ¡å™¨ç»´æŠ¤çš„æ‰€æœ‰å…¶ä»–æ•°æ®åº“çš„ä¿¡æ¯ï¼Œæ¯”å¦‚æœ‰å“ªäº›è¡¨ã€å“ªäº›è§†å›¾ã€å“ªäº›è§¦å‘å™¨ã€å“ªäº›åˆ—ã€å“ªäº›ç´¢å¼•ã€‚è¿™äº›ä¿¡æ¯å¹¶ä¸æ˜¯çœŸå®çš„ç”¨æˆ·æ•°æ®ï¼Œè€Œæ˜¯ä¸€äº›æè¿°æ€§ä¿¡æ¯ï¼Œæœ‰æ—¶å€™ä¹Ÿç§°ä¹‹ä¸º<code>å…ƒæ•°æ®</code>ã€‚</p><h2 id="4-4-mysql"><a href="#4-4-mysql" class="headerlink" title="4.4 mysql"></a>4.4 mysql</h2><p>åœ¨ MySQL ç³»ç»Ÿåº“ä¸­ï¼ŒMySQL <code>è®¿é—®æƒé™ç³»ç»Ÿè¡¨</code>ï¼Œæ”¾åœ¨ MySQL åº“ä¸­ï¼Œä¸»è¦åŒ…å«å¦‚ä¸‹å‡ ä¸ªè¡¨ï¼š</p><ul><li><code>user</code>ï¼šåŒ…å«ç”¨æˆ·è´¦æˆ·ã€å…¨å±€æƒé™å’Œå…¶ä»–éæƒé™åˆ—è¡¨(å®‰å…¨é…ç½®å­—æ®µå’Œèµ„ æºæ§åˆ¶å­—æ®µ)ã€‚</li><li><code>db</code>ï¼šæ•°æ®åº“çº§åˆ«çš„æƒé™è¡¨ã€‚è¯¥è¡¨ä¸­è®°å½•çš„æƒé™ä¿¡æ¯ä»£è¡¨ç”¨æˆ·æ˜¯å¦å¯ä»¥ä½¿ ç”¨è¿™äº›æƒé™æ¥è®¿é—®è¢«æˆäºˆè®¿é—®çš„æ•°æ®åº“ä¸‹çš„æ‰€æœ‰å¯¹è±¡(è¡¨æˆ–å­˜å‚¨ç¨‹åº)ã€‚</li><li><code>tables_priv</code>ï¼šè¡¨çº§åˆ«çš„æƒé™è¡¨ã€‚</li><li><code>columns_priv</code>ï¼šå­—æ®µçº§åˆ«çš„æƒé™è¡¨ã€‚</li><li><code>procs_priv</code>ï¼šå­˜å‚¨è¿‡ç¨‹å’Œå‡½æ•°æƒé™è¡¨ã€‚</li><li><code>proxies_priv</code>ï¼šä»£ç†ç”¨æˆ·æƒé™è¡¨ã€‚</li></ul><p>ä¸‹ä¸€ç« èŠ‚è®²è®²<code>äº‹åŠ¡å’Œäº‹åŠ¡çš„éš”ç¦»çº§åˆ«</code>ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> MySQLå­¦ä¹  </category>
          
      </categories>
      
      
        <tags>
            
            <tag> MySQL </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ã€Zookeeperå­¦ä¹ ã€‘4.ZookeeperåŸºç¡€</title>
      <link href="/posts/297429493.html"/>
      <url>/posts/297429493.html</url>
      
        <content type="html"><![CDATA[<h1 id="1-ç®€ä»‹"><a href="#1-ç®€ä»‹" class="headerlink" title="1 ç®€ä»‹"></a>1 ç®€ä»‹</h1><p>Zookeeperæ˜¯ç”±é›…è™åˆ›å»ºï¼ŒZookeeperå¹¶<strong>æ²¡æœ‰ç›´æ¥é‡‡ç”¨</strong><code>Paxosç®—æ³•</code>ï¼Œè€Œæ˜¯é‡‡ç”¨äº†ä¸€ç§è¢«ç§°ä¸º<code>ZAB</code>ï¼ˆZookeeper Atomic Broadcastï¼‰çš„<code>ä¸€è‡´æ€§åè®®</code>ã€‚</p><p>Zookeeperæ˜¯ä¸€ä¸ªå…¸å‹çš„<code>åˆ†å¸ƒå¼æ•°æ®ä¸€è‡´æ€§çš„è§£å†³æ–¹æ¡ˆ</code>ï¼Œåˆ†å¸ƒå¼åº”ç”¨ç¨‹åºå¯ä»¥åŸºäºå®ƒå®ç°è¯¸å¦‚<code>æ•°æ®å‘å¸ƒ/è®¢é˜…</code>ã€<code>è´Ÿè½½å‡è¡¡</code>ã€<code>å‘½åæœåŠ¡</code>ã€<code>åˆ†å¸ƒå¼åè°ƒ/é€šçŸ¥</code>ã€<code>é›†ç¾¤ç®¡ç†</code>ã€<code>Masteré€‰ä¸¾</code>ã€<code>åˆ†å¸ƒå¼é”</code>å’Œ<code>åˆ†å¸ƒå¼é˜Ÿåˆ—</code>ç­‰åŠŸèƒ½ã€‚</p><h1 id="2-ZookeeperåŸºæœ¬æ¦‚å¿µ"><a href="#2-ZookeeperåŸºæœ¬æ¦‚å¿µ" class="headerlink" title="2 ZookeeperåŸºæœ¬æ¦‚å¿µ"></a>2 ZookeeperåŸºæœ¬æ¦‚å¿µ</h1><h2 id="2-1-é›†ç¾¤è§’è‰²"><a href="#2-1-é›†ç¾¤è§’è‰²" class="headerlink" title="2.1 é›†ç¾¤è§’è‰²"></a>2.1 é›†ç¾¤è§’è‰²</h2><p><code>Leader</code>ï¼šLeaderæœåŠ¡å™¨ä¸ºå®¢æˆ·ç«¯æä¾›è¯»å†™æœåŠ¡<br><code>Follower</code>ï¼šFollowerä¸ºå®¢æˆ·ç«¯æä¾›è¯»æœåŠ¡<br><code>Observer</code>ï¼šObserverä¸ºå®¢æˆ·ç«¯æä¾›è¯»æœåŠ¡ï¼Œä¸å‚ä¸é€‰ä¸¾Leaderï¼Œä¸å‚ä¸äº‹åŠ¡æŠ•ç¥¨ï¼Œä¸å½±å“å†™æ€§èƒ½æé«˜é›†ç¾¤çš„è¯»æ€§èƒ½ã€‚</p><h2 id="2-2-ä¼šè¯ï¼ˆSessionï¼‰"><a href="#2-2-ä¼šè¯ï¼ˆSessionï¼‰" class="headerlink" title="2.2 ä¼šè¯ï¼ˆSessionï¼‰"></a>2.2 ä¼šè¯ï¼ˆSessionï¼‰</h2><p><code>Session</code>æ˜¯æŒ‡<code>å®¢æˆ·ç«¯ä¼šè¯</code>ï¼Œæ˜¯å®¢æˆ·ç«¯è¿æ¥æœåŠ¡ç«¯çš„ä¸€ä¸ª<code>TCPé•¿è¿æ¥</code>ã€‚æœåŠ¡ç«¯çš„<code>Watchäº‹ä»¶é€šçŸ¥</code>ä¹Ÿæ˜¯é€šè¿‡è¯¥<code>TCPè¿æ¥</code>ã€‚</p><h2 id="2-3-æ•°æ®èŠ‚ç‚¹ï¼ˆZnodeï¼‰"><a href="#2-3-æ•°æ®èŠ‚ç‚¹ï¼ˆZnodeï¼‰" class="headerlink" title="2.3 æ•°æ®èŠ‚ç‚¹ï¼ˆZnodeï¼‰"></a>2.3 æ•°æ®èŠ‚ç‚¹ï¼ˆZnodeï¼‰</h2><p>Zookeeperå°†æ‰€æœ‰çš„æ•°æ®å­˜å‚¨åœ¨<code>å†…å­˜</code>ä¸­ï¼Œæ•°æ®æ¨¡å‹æ˜¯<code>ä¸€æ£µæ ‘</code>ï¼ˆZnode Treeï¼‰ï¼Œç”±æ–œæ†è¿›è¡Œåˆ†å‰²çš„è·¯å¾„ï¼Œå°±æ˜¯ä¸€ä¸ª<code>Znode</code>ï¼Œæ¯ä¸ª<code>Znode</code>ä¸Šéƒ½ä¼šä¿å­˜è‡ªå·±çš„æ•°æ®å†…å®¹ï¼ŒåŒæ—¶è¿˜ä¼šä¿å­˜ä¸€äº›åˆ—çš„å±æ€§ä¿¡æ¯ã€‚<br><img src="https://cdn.jsdelivr.net/gh/zyxelva/picgo@main/markdown/Znode(v3.6.0).png" alt="Znodeç»“æ„"></p><p>åœ¨Zookeeperä¸­ï¼ŒZnodeåˆ†ä¸º<code>æŒä¹…èŠ‚ç‚¹</code>å’Œ<code>ä¸´æ—¶èŠ‚ç‚¹</code>ï¼ŒæŒä¹…èŠ‚ç‚¹æ˜¯æŒ‡ä¸€æ—¦åˆ›å»ºï¼Œé™¤éä¸»åŠ¨åˆ é™¤ï¼Œå¦åˆ™è¿™ä¸ªZnodeä¼šä¸€ç›´åœ¨Zookeeperä¸­ï¼Œä¸´æ—¶èŠ‚ç‚¹å®ƒçš„ç”Ÿå‘½å‘¨æœŸæ˜¯è·Ÿ<code>ä¼šè¯</code>ç»‘å®šï¼Œä¸€æ—¦å®¢æˆ·ç«¯<code>ä¼šè¯å¤±æ•ˆ</code>ï¼Œä¸´æ—¶èŠ‚ç‚¹å°†ä¼š<code>åˆ é™¤</code>ã€‚å¦å¤–ï¼ŒZookeeperå¯ä»¥ä¸ºæ¯ä¸ªèŠ‚ç‚¹æ·»åŠ <code>SEQUENTIAL</code>å±æ€§ï¼Œä¸€æ—¦æœ‰è¿™ä¸ªå±æ€§ï¼Œé‚£ä¹ˆèŠ‚ç‚¹å°±æ˜¯ä¸€ä¸ª<code>æœ‰åºèŠ‚ç‚¹</code>ã€‚</p><ul><li>æŒä¹…èŠ‚ç‚¹ï¼ˆPERSISTENTï¼‰ï¼ˆé»˜è®¤ï¼‰ï¼šåœ¨è¯¥æ•°æ®èŠ‚ç‚¹åˆ›å»ºåï¼Œå°±<code>ä¸€ç›´å­˜åœ¨</code>ä¸ZookeeperæœåŠ¡å™¨ä¸Šï¼Œç›´åˆ°æœ‰<code>åˆ é™¤æ“ä½œ</code>æ¥<code>ä¸»åŠ¨æ¸…é™¤</code>è¿™ä¸ªèŠ‚ç‚¹ã€‚ä¸ä¼šå› ä¸ºåˆ›å»ºè¯¥èŠ‚ç‚¹çš„å®¢æˆ·ç«¯ä¼šè¯å¤±æ•ˆè€Œæ¶ˆå¤±ï¼›</li><li>æŒä¹…é¡ºåºèŠ‚ç‚¹ï¼ˆPERSISTENT_SEQUENTIALï¼‰ï¼šåœ¨ZKä¸­æ¯ä¸ª<code>çˆ¶èŠ‚ç‚¹</code>ä¼šä¸ºä»–çš„<code>ç¬¬ä¸€çº§å­èŠ‚ç‚¹</code>ç»´æŠ¤ä¸€ä»½é¡ºåºï¼Œç”¨äºè®°å½•æ¯ä¸ªå­èŠ‚ç‚¹<code>åˆ›å»ºçš„å…ˆåé¡ºåº</code>ï¼›</li><li>ä¸´æ—¶èŠ‚ç‚¹ï¼ˆEPHEMERALï¼‰ï¼šå’ŒæŒä¹…èŠ‚ç‚¹ä¸åŒï¼Œä¸´æ—¶èŠ‚ç‚¹çš„ç”Ÿå‘½å‘¨æœŸå’Œ<code>å®¢æˆ·ç«¯ä¼šè¯</code>ç»‘å®šã€‚å¦‚æœå®¢æˆ·ç«¯ä¼šè¯å¤±æ•ˆï¼Œé‚£ä¹ˆè¿™ä¸ªèŠ‚ç‚¹å°±ä¼šè‡ªåŠ¨è¢«æ¸…é™¤æ‰ã€‚<strong>æ³¨æ„ï¼Œè¿™é‡Œæåˆ°çš„æ˜¯ä¼šè¯å¤±æ•ˆï¼Œè€ŒéTCPè¿æ¥æ–­å¼€</strong>ï¼›</li><li>ä¸´æ—¶é¡ºåºèŠ‚ç‚¹ï¼ˆEPHEMERAL_SEQUENTIALï¼‰</li></ul><h2 id="2-4-ç‰ˆæœ¬"><a href="#2-4-ç‰ˆæœ¬" class="headerlink" title="2.4 ç‰ˆæœ¬"></a>2.4 ç‰ˆæœ¬</h2><p>Zookeeperä¼šå¯¹æ¯ä¸€ä¸ªZnodeç»´æŠ¤ä¸€ä¸ª<code>Stat</code>çš„æ•°æ®ç»“æ„ï¼Œ<code>Stat</code>ä¸­è®°å½•äº†Znodeçš„<code>ä¸‰ä¸ªæ•°æ®ç‰ˆæœ¬</code>ï¼Œåˆ†åˆ«æ˜¯ï¼š</p><ul><li><code>version</code>ï¼ˆå½“å‰<code>Znodeçš„ç‰ˆæœ¬</code>ï¼‰</li><li><code>cversion</code>ï¼ˆå½“å‰Znode<code>å­èŠ‚ç‚¹çš„ç‰ˆæœ¬</code>ï¼‰</li><li><code>aversion</code>ï¼ˆå½“å‰Znodeçš„<code>ACLç‰ˆæœ¬</code>ï¼‰</li></ul><p><img src="https://cdn.jsdelivr.net/gh/zyxelva/picgo@main/markdown/Znode-Stat.png" alt="Znode stat"></p><h2 id="2-5-Watcher"><a href="#2-5-Watcher" class="headerlink" title="2.5 Watcher"></a>2.5 Watcher</h2><p><code>Watcher</code>ï¼ˆäº‹ä»¶ç›‘å¬å™¨ï¼‰ï¼ŒZookeeperå…è®¸ç”¨æˆ·åœ¨<code>æŒ‡å®šèŠ‚ç‚¹</code>ä¸Š<code>æ³¨å†Œwatcher</code>ï¼Œå¹¶ä¸”åœ¨ä¸€äº›ç‰¹å®šäº‹ä»¶<code>è§¦å‘</code>çš„æ—¶å€™ï¼ŒZookeeperæœåŠ¡ç«¯ä¼šå°†äº‹ä»¶<code>é€šçŸ¥</code>åˆ°æ„Ÿå…´è¶£çš„å®¢æˆ·ç«¯ä¸Šå»ï¼Œè¯¥æœºåˆ¶æ˜¯Zookeeperå®ç°<code>åˆ†å¸ƒå¼åè°ƒæœåŠ¡</code>çš„é‡è¦ç‰¹æ€§ã€‚</p><ul><li>ç‰¹ç‚¹<ul><li>ä¸€æ¬¡æ€§ï¼š<ul><li><code>åªè§¦å‘ä¸€æ¬¡</code>watchesï¼›</li><li><code>å…ˆæ³¨å†Œ</code>å†è§¦å‘</li></ul></li><li>å¼‚æ­¥ï¼š<ul><li><code>watcher event</code> <strong>å¼‚æ­¥</strong>å‘é€ <code>watcher</code> çš„<code>é€šçŸ¥äº‹ä»¶</code>ï¼Œå³ï¼šä» <code>server</code> å‘é€åˆ° <code>client</code> æ˜¯<code>å¼‚æ­¥çš„</code>ï¼›</li><li>åªèƒ½ä¿è¯<code>æœ€ç»ˆçš„ä¸€è‡´æ€§</code>ã€‚</li></ul></li><li>è½»é‡çº§äº‹ä»¶ï¼š<ul><li><code>Watcher</code> é€šçŸ¥éå¸¸ç®€å•ï¼Œåªä¼šå‘Šè¯‰å®¢æˆ·ç«¯å‘ç”Ÿäº†äº‹ä»¶ï¼Œè€Œ<strong>ä¸ä¼šè¯´æ˜</strong>äº‹ä»¶çš„å…·ä½“å†…å®¹ï¼›</li><li>å®¢æˆ·ç«¯å‘æœåŠ¡ç«¯æ³¨å†Œ <code>Watcher</code> çš„æ—¶å€™ï¼Œå¹¶ä¸ä¼šæŠŠå®¢æˆ·ç«¯çœŸå®çš„ <code>Watcher</code> å¯¹è±¡å®ä½“ä¼ é€’åˆ°æœåŠ¡ç«¯ï¼Œä»…ä»…æ˜¯åœ¨å®¢æˆ·ç«¯è¯·æ±‚ä¸­ä½¿ç”¨ <code>boolean</code> ç±»å‹å±æ€§è¿›è¡Œäº†æ ‡è®°ã€‚</li></ul></li><li>å®¢æˆ·ç«¯ä¸²è¡Œæ‰§è¡Œï¼šå®¢æˆ·ç«¯ <code>Watcher</code> å›è°ƒçš„è¿‡ç¨‹æ˜¯ä¸€ä¸ª<code>ä¸²è¡ŒåŒæ­¥</code>çš„è¿‡ç¨‹ã€‚</li></ul></li></ul><h3 id="2-5-1-å·¥ä½œæœºåˆ¶"><a href="#2-5-1-å·¥ä½œæœºåˆ¶" class="headerlink" title="2.5.1 å·¥ä½œæœºåˆ¶"></a>2.5.1 å·¥ä½œæœºåˆ¶</h3><ul><li>å®¢æˆ·ç«¯æ³¨å†Œ watcher<ul><li>è°ƒç”¨ <code>getData()</code>&#x2F;<code>getChildren()</code>&#x2F;<code>exist()</code>ä¸‰ä¸ª APIï¼Œä¼ å…¥ <code>Watcher å¯¹è±¡</code>ï¼›</li><li>æ ‡è®°è¯·æ±‚ <code>request</code>ï¼Œå°è£… <code>Watcher</code> åˆ° <code>WatchRegistration</code>ï¼›</li><li>å°è£…æˆ <code>Packet å¯¹è±¡</code>ï¼Œå‘æœåŠ¡ç«¯å‘é€ <code>request</code>ï¼›</li><li>æ”¶åˆ°æœåŠ¡ç«¯å“åº”åï¼Œå°† <code>Watcher</code> <strong>æ³¨å†Œ</strong>åˆ° <code>ZKWatcherManager</code> ä¸­è¿›è¡Œç®¡ç†ï¼›</li><li>è¯·æ±‚è¿”å›ï¼Œå®Œæˆæ³¨å†Œã€‚</li></ul></li><li>æœåŠ¡ç«¯å¤„ç† <code>watcher</code><ul><li>æœåŠ¡ç«¯<code>æ¥æ”¶ Watcher å¹¶å­˜å‚¨</code>ï¼šæ¥æ”¶åˆ°å®¢æˆ·ç«¯è¯·æ±‚ï¼Œå¤„ç†è¯·æ±‚åˆ¤æ–­æ˜¯å¦éœ€è¦æ³¨å†Œ <code>Watcher</code>ï¼Œéœ€è¦çš„è¯å°†æ•°æ®èŠ‚ç‚¹çš„èŠ‚ç‚¹è·¯å¾„å’Œ <code>ServerCnxn</code>ï¼ˆServerCnxn ä»£è¡¨ä¸€ä¸ªå®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯çš„è¿æ¥ï¼Œå®ç°äº† <code>Watcher</code> çš„ <code>process</code> æ¥å£ï¼Œæ­¤æ—¶å¯ä»¥çœ‹æˆä¸€ä¸ª <code>Watcher å¯¹è±¡</code>ï¼‰å­˜å‚¨åœ¨<code>WatcherManager</code> çš„ <code>WatchTable</code> å’Œ <code>watch2Paths</code> ä¸­å»ã€‚</li><li>Watcher è§¦å‘ï¼šä»¥æœåŠ¡ç«¯æ¥æ”¶åˆ° <code>setData()</code> äº‹åŠ¡è¯·æ±‚è§¦å‘ <code>NodeDataChanged äº‹ä»¶</code>ä¸ºä¾‹ï¼š<ul><li>å°è£… <code>WatchedEvent</code>ï¼šå°†<code>é€šçŸ¥çŠ¶æ€</code>ï¼ˆSyncConnectedï¼‰ã€<code>äº‹ä»¶ç±»å‹</code>ï¼ˆNodeDataChangedï¼‰ä»¥åŠ<code>èŠ‚ç‚¹è·¯å¾„</code>å°è£…æˆä¸€ä¸ª <code>WatchedEvent å¯¹è±¡</code>ï¼›</li><li>æŸ¥è¯¢ <code>Watcher</code>ï¼šä» <code>WatchTable</code> ä¸­æ ¹æ®èŠ‚ç‚¹è·¯å¾„æŸ¥æ‰¾ <code>Watcher</code>ï¼›</li><li>æ²¡æ‰¾åˆ°ï¼šè¯´æ˜<code>æ²¡æœ‰</code>å®¢æˆ·ç«¯åœ¨è¯¥æ•°æ®èŠ‚ç‚¹ä¸Š<code>æ³¨å†Œ</code>è¿‡ <code>Watcher</code>ï¼›</li><li>æ‰¾åˆ°ï¼š<code>æå–</code>å¹¶ä» <code>WatchTable</code> å’Œ <code>Watch2Paths</code> ä¸­<code>åˆ é™¤</code>å¯¹åº” <code>Watcher</code>ï¼ˆä»è¿™é‡Œå¯ä»¥çœ‹å‡º Watcher åœ¨æœåŠ¡ç«¯æ˜¯<code>ä¸€æ¬¡æ€§çš„</code>ï¼Œè§¦å‘ä¸€æ¬¡å°±å¤±æ•ˆäº†ï¼‰</li></ul></li><li>è°ƒç”¨ <code>process æ–¹æ³•</code>æ¥è§¦å‘ <code>Watcher</code>ï¼šè¿™é‡Œ <code>process</code> ä¸»è¦å°±æ˜¯é€šè¿‡ <code>ServerCnxn</code> å¯¹åº”çš„ <code>TCP è¿æ¥</code>å‘é€ <code>Watcher äº‹ä»¶é€šçŸ¥</code>ã€‚</li></ul></li><li>å®¢æˆ·ç«¯å›è°ƒ <code>watcher</code><ul><li><p>å®¢æˆ·ç«¯ <code>SendThread</code> çº¿ç¨‹<code>æ¥æ”¶</code>äº‹ä»¶é€šçŸ¥ï¼Œäº¤ç”± <code>EventThread</code> çº¿ç¨‹å›è°ƒ <code>Watcher</code>ï¼›</p></li><li><p>å®¢æˆ·ç«¯çš„ <code>Watcher æœºåˆ¶</code>åŒæ ·æ˜¯<code>ä¸€æ¬¡æ€§çš„</code>ï¼Œä¸€æ—¦è¢«è§¦å‘åï¼Œè¯¥ Watcher å°±å¤±æ•ˆäº†ã€‚</p><ul><li></li></ul></li></ul></li></ul><p><img src="https://cdn.jsdelivr.net/gh/zyxelva/picgo@main/markdown/Watch-Flow.png" alt="Watcheræµç¨‹"></p>]]></content>
      
      
      <categories>
          
          <category> Zookeeperå­¦ä¹  </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Zookeeper </tag>
            
            <tag> ZNode </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ã€LeetCodeã€‘14. æœ€é•¿å…¬å…±å‰ç¼€</title>
      <link href="/posts/1483968058.html"/>
      <url>/posts/1483968058.html</url>
      
        <content type="html"><![CDATA[<h1 id="1-é—®é¢˜"><a href="#1-é—®é¢˜" class="headerlink" title="1. é—®é¢˜"></a>1. é—®é¢˜</h1><p>ç¼–å†™ä¸€ä¸ªå‡½æ•°æ¥æŸ¥æ‰¾å­—ç¬¦ä¸²æ•°ç»„ä¸­çš„<code>æœ€é•¿å…¬å…±å‰ç¼€</code>ã€‚</p><p>å¦‚æœä¸å­˜åœ¨å…¬å…±å‰ç¼€ï¼Œè¿”å›ç©ºå­—ç¬¦ä¸² â€œâ€ã€‚</p><h2 id="ç¤ºä¾‹-1"><a href="#ç¤ºä¾‹-1" class="headerlink" title="ç¤ºä¾‹ 1"></a>ç¤ºä¾‹ 1</h2><blockquote><p>è¾“å…¥ï¼šstrs &#x3D; [â€œflowerâ€,â€flowâ€,â€flightâ€]<br>è¾“å‡ºï¼šâ€flâ€</p></blockquote><h2 id="ç¤ºä¾‹-2"><a href="#ç¤ºä¾‹-2" class="headerlink" title="ç¤ºä¾‹ 2"></a>ç¤ºä¾‹ 2</h2><blockquote><p>è¾“å…¥ï¼šstrs &#x3D; [â€œdogâ€,â€racecarâ€,â€carâ€]<br>è¾“å‡ºï¼šâ€â€<br>è§£é‡Šï¼šè¾“å…¥ä¸å­˜åœ¨å…¬å…±å‰ç¼€ã€‚</p></blockquote><p><strong>æç¤º</strong>ï¼š</p><ul><li>1 &lt;&#x3D; strs.length &lt;&#x3D; 200</li><li>0 &lt;&#x3D; strs[i].length &lt;&#x3D; 200</li><li>strs[i] ä»…ç”±å°å†™è‹±æ–‡å­—æ¯ç»„æˆ</li></ul><h1 id="2-è§£é¢˜æ€è·¯"><a href="#2-è§£é¢˜æ€è·¯" class="headerlink" title="2.è§£é¢˜æ€è·¯"></a>2.è§£é¢˜æ€è·¯</h1><ul><li>å…ˆæ±‚å‡º<code>strs[0]</code>å’Œ<code>strs[1]</code>çš„å…¬å…±å‰ç¼€ï¼›</li><li>å°†å¾—åˆ°ç»“æœä¸åç»­å­—ç¬¦ä¸²æ¯”è¾ƒï¼Œå¾—åˆ°æ–°çš„å…¬å…±å‰ç¼€ï¼Œä»¥æ­¤ç±»æ¨ã€‚</li></ul><p>ä»¥ä¸‹å›¾ä¸ºä¾‹ï¼š</p><p><img src="https://cdn.jsdelivr.net/gh/zyxelva/picgo@main/csdn/3d6d20ea9eea494586a729dcffaf9fbc.png" alt="ç®—æ³•ç¤ºæ„å›¾"></p><ul><li>$s_1$ å’Œ $s_2$ çš„å…¬å…±å‰ç¼€æ˜¯ <code>leet</code>;</li><li><code>leet</code> ä¸ $s_3$ çš„å…¬å…±å‰ç¼€è¿˜æ˜¯ <code>leet</code>;</li><li><code>leet</code> ä¸ $s_4$ çš„å…¬å…±å‰ç¼€ä¸º <code>lee</code>ï¼Œå³ä¸º $s_1$ï¼Œ$s_2$ï¼Œ$s_3$ï¼Œ$s_4$ çš„å…¬å…±å‰ç¼€ã€‚</li></ul><p><strong>å¤æ‚åº¦åˆ†æ</strong></p><ul><li><p>æ—¶é—´å¤æ‚åº¦ï¼šO(mn)ï¼Œå…¶ä¸­ m æ˜¯å­—ç¬¦ä¸²æ•°ç»„ä¸­çš„å­—ç¬¦ä¸²çš„å¹³å‡é•¿åº¦ï¼Œn æ˜¯å­—ç¬¦ä¸²çš„æ•°é‡ã€‚æœ€åæƒ…å†µä¸‹ï¼Œå­—ç¬¦ä¸²æ•°ç»„ä¸­çš„æ¯ä¸ªå­—ç¬¦ä¸²çš„æ¯ä¸ªå­—ç¬¦éƒ½ä¼šè¢«æ¯”è¾ƒä¸€æ¬¡ã€‚</p></li><li><p>ç©ºé—´å¤æ‚åº¦ï¼šO(1)ã€‚ä½¿ç”¨çš„é¢å¤–ç©ºé—´å¤æ‚åº¦ä¸ºå¸¸æ•°ã€‚</p></li></ul><h1 id="3-ä»£ç "><a href="#3-ä»£ç " class="headerlink" title="3.ä»£ç "></a>3.ä»£ç </h1><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">class</span> <span class="token class-name">Solution</span> <span class="token punctuation">&#123;</span>    <span class="token comment">/**     1.å…ˆæŠŠä¸¤ä¸ªå­—ç¬¦ä¸²çš„å…¬å…±å‰ç¼€æ‰¾å‡ºï¼Œå®šä¸ºans     2.ç”¨ansä¸åé¢çš„å­—ç¬¦ä¸²æ¯ä¸ªä½ä¸€ä¸€æ¯”è¾ƒï¼Œåé¢çš„ansä¸å¯èƒ½ä¼šé€’å¢ï¼Œåªè¦æœ‰ä¸€ä½ä¸åŒ¹é…ï¼Œåˆ™anså°±ä¼šå°‘ä¸€ä¸ªå…¬å…±çš„å­—ç¬¦ï¼Œä»è€Œæ‰¾å‡ºæœ€é•¿çš„å…¬å…±å‰ç¼€     */</span>    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">longestCommonPrefix</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> strs<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token comment">//å¦‚æœè¾“å…¥çš„strsä¸ºç©ºï¼Œåˆ™è¿”å›ç©ºå­—ç¬¦ä¸²""</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>strs<span class="token punctuation">.</span>length <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">return</span> <span class="token string">""</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token comment">//å®šä¹‰ä¸€ä¸ªansä¸ºstrs.[0],è·å–åˆ°strsçš„ç¬¬ä¸€ä¸ªå­—ç¬¦ä¸²ä¸ºäº†ä¸€ä¸‹é¢çš„å¾ªç¯æ¯”è¾ƒ</span>        <span class="token class-name">String</span> ans <span class="token operator">=</span> strs<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> strs<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token comment">//åœ¨è¿™é‡Œå®šä¹‰j=0ï¼Œè€Œä¸æ˜¯åœ¨foré‡Œé¢å®šä¹‰ï¼›æ˜¯ä¸ºäº†ans.substring(0,j)èƒ½è°ƒç”¨jçš„å€¼</span>            <span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> ans<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> j <span class="token operator">&lt;</span> strs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                <span class="token comment">//æ¯”è¾ƒä¿©ä¸ªå­—ç¬¦ä¸²ç›¸åŒçš„éƒ¨åˆ†ï¼Œä¸ç›¸åŒåˆ™é€€å‡ºå¾ªç¯</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>ans<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span>j<span class="token punctuation">)</span> <span class="token operator">!=</span> strs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span>j<span class="token punctuation">)</span><span class="token punctuation">)</span>                    <span class="token keyword">break</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>            <span class="token comment">//è·å–ä»0åˆ°jç›¸åŒçš„å­—ç¬¦ä¸²</span>            ans <span class="token operator">=</span> ans<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> j<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment">//å¦‚æœansè·å–çš„ç»“æœä¸ºç©ºåˆ™è¿”å›ç©ºå­—ç¬¦</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>ans<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">" "</span><span class="token punctuation">)</span><span class="token punctuation">)</span>                <span class="token keyword">return</span> ans<span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token comment">//è¿”å›æœ€ç»ˆè·å–åˆ°çš„ans</span>        <span class="token keyword">return</span> ans<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> ç®—æ³• </category>
          
      </categories>
      
      
        <tags>
            
            <tag> LeetCode </tag>
            
            <tag> è¿­ä»£ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ã€LeetCodeã€‘1668.æœ€å¤§é‡å¤å­å­—ç¬¦ä¸²</title>
      <link href="/posts/1535077223.html"/>
      <url>/posts/1535077223.html</url>
      
        <content type="html"><![CDATA[<h1 id="1-é—®é¢˜"><a href="#1-é—®é¢˜" class="headerlink" title="1.é—®é¢˜"></a>1.é—®é¢˜</h1><p>ç»™ä½ ä¸€ä¸ªå­—ç¬¦ä¸² <code>sequence</code> ï¼Œå¦‚æœå­—ç¬¦ä¸² <code>word</code> è¿ç»­é‡å¤ <code>k</code> æ¬¡å½¢æˆçš„å­—ç¬¦ä¸²æ˜¯ <code>sequence</code> çš„ä¸€ä¸ª<code>å­å­—ç¬¦ä¸²</code>ï¼Œé‚£ä¹ˆå•è¯ <code>word</code> çš„ <strong>é‡å¤å€¼</strong>ä¸º <code>k</code> ã€‚å•è¯ word çš„ <strong>æœ€å¤§é‡å¤å€¼</strong> æ˜¯å•è¯ <code>word</code> åœ¨ <code>sequence</code> ä¸­æœ€å¤§çš„é‡å¤å€¼ã€‚å¦‚æœ <code>word</code> ä¸æ˜¯ <code>sequence</code> çš„å­ä¸²ï¼Œé‚£ä¹ˆé‡å¤å€¼ <code>k</code> ä¸º 0 ã€‚</p><p>ç»™ä½ ä¸€ä¸ªå­—ç¬¦ä¸² <code>sequence</code> å’Œ <code>word</code> ï¼Œè¯·ä½ è¿”å› <code>æœ€å¤§é‡å¤å€¼ k</code> ã€‚</p><h2 id="ç¤ºä¾‹-1"><a href="#ç¤ºä¾‹-1" class="headerlink" title="ç¤ºä¾‹ 1"></a>ç¤ºä¾‹ 1</h2><blockquote><p>è¾“å…¥ï¼šsequence &#x3D; â€œababcâ€, word &#x3D; â€œabâ€<br>è¾“å‡ºï¼š2<br>è§£é‡Šï¼šâ€ababâ€ æ˜¯ â€œababcâ€ çš„å­å­—ç¬¦ä¸²ã€‚</p></blockquote><h2 id="ç¤ºä¾‹-2"><a href="#ç¤ºä¾‹-2" class="headerlink" title="ç¤ºä¾‹ 2"></a>ç¤ºä¾‹ 2</h2><blockquote><p>è¾“å…¥ï¼šsequence &#x3D; â€œababcâ€, word &#x3D; â€œbaâ€<br>è¾“å‡ºï¼š1<br>è§£é‡Šï¼šâ€baâ€ æ˜¯ â€œababcâ€ çš„å­å­—ç¬¦ä¸²ï¼Œä½† â€œbabaâ€ ä¸æ˜¯ â€œababcâ€ çš„å­å­—ç¬¦ä¸²ã€‚</p></blockquote><h2 id="ç¤ºä¾‹-3"><a href="#ç¤ºä¾‹-3" class="headerlink" title="ç¤ºä¾‹ 3"></a>ç¤ºä¾‹ 3</h2><blockquote><p>è¾“å…¥ï¼šsequence &#x3D; â€œababcâ€, word &#x3D; â€œacâ€<br>è¾“å‡ºï¼š0<br>è§£é‡Šï¼šâ€acâ€ ä¸æ˜¯ â€œababcâ€ çš„å­å­—ç¬¦ä¸²ã€‚</p></blockquote><p><strong>æç¤º</strong></p><ul><li>1 &lt;&#x3D; sequence.length &lt;&#x3D; 100</li><li>1 &lt;&#x3D; word.length &lt;&#x3D; 100</li><li><code>sequence</code> å’Œ <code>word</code> éƒ½åªåŒ…å«<strong>å°å†™è‹±æ–‡å­—æ¯</strong>ã€‚</li></ul><h1 id="2-è§£é¢˜æ€è·¯"><a href="#2-è§£é¢˜æ€è·¯" class="headerlink" title="2.è§£é¢˜æ€è·¯"></a>2.è§£é¢˜æ€è·¯</h1><h2 id="2-1-è§£æ³•ä¸€ï¼šè¯•æ¢"><a href="#2-1-è§£æ³•ä¸€ï¼šè¯•æ¢" class="headerlink" title="2.1 è§£æ³•ä¸€ï¼šè¯•æ¢"></a>2.1 è§£æ³•ä¸€ï¼šè¯•æ¢</h2><p>é‡å¤æ‹¼æ¥<code>word</code>ï¼Œè®°ä¸º<code>ss</code>ï¼Œå¦‚æœ<code>sequence</code>ä»ç„¶åŒ…å«<code>ss</code>ï¼Œåˆ™é‡å¤å€¼<code>k++</code>(kåˆå§‹ä¸º0)ï¼›å¦åˆ™è¿”å›å½“å‰<code>k</code>å€¼ã€‚è¯¦è§ä»£ç ä¸­çš„è§£æ³•ä¸€ã€‚</p><h2 id="2-2-è§£æ³•äºŒï¼šåºåˆ—DP"><a href="#2-2-è§£æ³•äºŒï¼šåºåˆ—DP" class="headerlink" title="2.2 è§£æ³•äºŒï¼šåºåˆ—DP"></a>2.2 è§£æ³•äºŒï¼šåºåˆ—DP</h2><p>å®šä¹‰åŠ¨æ€è½¬ç§»æ–¹ç¨‹ä¸ºï¼š</p><blockquote><p>$f_i$ &#x3D; $f_{i-m}$ + 1</p></blockquote><p>å…¶ä¸­ï¼Œ<code>m</code>ä¸ºwordçš„é•¿åº¦ï¼Œ$f_i$ ä¸ºsequenceä¸­é•¿åº¦ä¸º<code>m</code>çš„å­ä¸²$ss_i$å¹¶ä¸wordç›¸ç­‰æ—¶çš„æœ€å¤§é‡å¤å€¼.<br>ä¸¾ä¾‹ï¼š</p><blockquote><p>å‡è®¾ sequence &#x3D; â€œababcâ€ï¼›word&#x3D;â€abâ€ï¼›ï¼ˆå½“å‰ <code>i=2</code>ï¼Œ<code>i&lt;2</code>æ—¶ï¼Œsequenceå­ä¸²é•¿åº¦ä¸å¤Ÿwordçš„é•¿åº¦ã€‚å³ $ss_0$ï¼Œ$ss_1$é•¿åº¦ä¸ç­‰äº2ï¼Œå…¶å¯¹åº”çš„ $f_0$ã€$f_1$ å‡ä¸º 0ã€‚ï¼‰</p><ul><li><p>åˆ™ $ss_2$ &#x3D;sequence.substring(0, 2)ï¼›å³ $ss_2$ &#x3D; â€œabâ€.<br>  å› ä¸º $ss_2$.equals(word)ï¼Œæ‰€ä»¥ $f_2$ &#x3D; $f_0$ + 1; å…¶ä¸­ $f_0$åˆå§‹å€¼ä¸º0.</p></li><li><p>åˆ $ss_3$ &#x3D;sequence.substring(1, 3)ï¼›å³ $ss_3$ &#x3D; â€œbaâ€ï¼Œä¸ç­‰äº wordã€‚<br>æ‰€ä»¥ $f_3$ è¿˜æ˜¯é»˜è®¤çš„é‚£ä¸ªå€¼ï¼Œä¸º0ï¼›</p></li><li><p>åˆ $ss_4$ &#x3D; sequence.substring(2, 4)ï¼›å³ $ss_4$ &#x3D; â€œabâ€ï¼Œç­‰äº wordï¼Œ<br>æ‰€ä»¥ $f_4$ &#x3D; $f_2$ + 1 &#x3D; 2ã€‚</p></li><li><p>åˆ $ss_5$ &#x3D; sequence.substring(3, 5)ï¼Œå³ $ss_5$ &#x3D; â€œbcâ€ï¼Œä¸ç­‰äº wordã€‚<br>éå†å®Œæ¯•ï¼Œæœ€å¤§é‡å¤å€¼ä¸º 2ã€‚</p></li></ul></blockquote><p>è¯¦è§ä»£ç ä¸­è§£æ³•äºŒã€‚</p><h1 id="3-ä»£ç "><a href="#3-ä»£ç " class="headerlink" title="3.ä»£ç "></a>3.ä»£ç </h1><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">class</span> <span class="token class-name">Solution</span> <span class="token punctuation">&#123;</span><span class="token comment">//è§£æ³•ä¸€</span><span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">maxRepeating</span><span class="token punctuation">(</span><span class="token class-name">String</span> sequence<span class="token punctuation">,</span> <span class="token class-name">String</span> word<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">int</span> k<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>    <span class="token class-name">StringBuilder</span> sb<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">StringBuilder</span><span class="token punctuation">(</span>word<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">while</span> <span class="token punctuation">(</span>sequence<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>sb<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>       <span class="token comment">//å åŠ åä»ç„¶åŒ…å«ï¼Œé‡å¤å€¼+1</span>        k<span class="token operator">++</span><span class="token punctuation">;</span>        <span class="token comment">//å åŠ word</span>        sb<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>word<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">return</span> k<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">//è§£æ³•äºŒ</span><span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">maxRepeating</span><span class="token punctuation">(</span><span class="token class-name">String</span> ss<span class="token punctuation">,</span> <span class="token class-name">String</span> pp<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">int</span> n <span class="token operator">=</span> ss<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> m <span class="token operator">=</span> pp<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ans <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>        <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> f <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">int</span><span class="token punctuation">[</span>n <span class="token operator">+</span> <span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> m<span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> n<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>ss<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span>i <span class="token operator">-</span> m<span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>pp<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                f<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> f<span class="token punctuation">[</span>i <span class="token operator">-</span> m<span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>            ans <span class="token operator">=</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span>ans<span class="token punctuation">,</span> f<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">return</span> ans<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> ç®—æ³• </category>
          
      </categories>
      
      
        <tags>
            
            <tag> LeetCode </tag>
            
            <tag> åŠ¨æ€è§„åˆ’ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ã€Nettyå­¦ä¹ ã€‘4.Nettyçš„ä¸€ä¸ªä¾‹å­</title>
      <link href="/posts/1478672774.html"/>
      <url>/posts/1478672774.html</url>
      
        <content type="html"><![CDATA[<h1 id="1-ç¯å¢ƒé…ç½®"><a href="#1-ç¯å¢ƒé…ç½®" class="headerlink" title="1 ç¯å¢ƒé…ç½®"></a>1 ç¯å¢ƒé…ç½®</h1><p>è¦è¿è¡Œèµ·Netty Demoï¼Œä¸»è¦ä¾èµ–äº<code>JDK</code>å’Œ<code>Maven</code>ï¼Œå…·ä½“æ€ä¹ˆå®‰è£…å¯è‡ªè¡ŒGoogleã€‚</p><p>æœ¬æœºç¯å¢ƒåˆ—è¡¨ï¼š</p><blockquote><p>JDK: 1.8.0_112<br>Maven: 3.5.3<br>IDE: IntelliJ IDEA 2021.3 (Ultimate Edition)<br>OS: MacOS 10.15</p></blockquote><h1 id="2-Demo"><a href="#2-Demo" class="headerlink" title="2 Demo"></a>2 Demo</h1><h2 id="2-1-Server"><a href="#2-1-Server" class="headerlink" title="2.1 Server"></a>2.1 Server</h2><p>Serverç«¯è‡³å°‘éœ€è¦ä»¥ä¸‹ç»„ä»¶ï¼š</p><ul><li>å¼•å¯¼ï¼š<code>ServerBootstrap</code></li><li>è‡³å°‘ä¸€ä¸ª<code>ChannelHandler</code></li></ul><h3 id="2-1-2-ServerBootstrap"><a href="#2-1-2-ServerBootstrap" class="headerlink" title="2.1.2 ServerBootstrap"></a>2.1.2 ServerBootstrap</h3><p>å…ˆä¸Šä»£ç ã€‚</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">io<span class="token punctuation">.</span>netty<span class="token punctuation">.</span>bootstrap<span class="token punctuation">.</span></span><span class="token class-name">ServerBootstrap</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">io<span class="token punctuation">.</span>netty<span class="token punctuation">.</span>channel<span class="token punctuation">.</span></span><span class="token class-name">ChannelFuture</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">io<span class="token punctuation">.</span>netty<span class="token punctuation">.</span>channel<span class="token punctuation">.</span></span><span class="token class-name">ChannelInitializer</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">io<span class="token punctuation">.</span>netty<span class="token punctuation">.</span>channel<span class="token punctuation">.</span></span><span class="token class-name">EventLoopGroup</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">io<span class="token punctuation">.</span>netty<span class="token punctuation">.</span>channel<span class="token punctuation">.</span>nio<span class="token punctuation">.</span></span><span class="token class-name">NioEventLoopGroup</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">io<span class="token punctuation">.</span>netty<span class="token punctuation">.</span>channel<span class="token punctuation">.</span>socket<span class="token punctuation">.</span></span><span class="token class-name">SocketChannel</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">io<span class="token punctuation">.</span>netty<span class="token punctuation">.</span>channel<span class="token punctuation">.</span>socket<span class="token punctuation">.</span>nio<span class="token punctuation">.</span></span><span class="token class-name">NioServerSocketChannel</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>net<span class="token punctuation">.</span></span><span class="token class-name">InetSocketAddress</span></span><span class="token punctuation">;</span><span class="token comment">/** * @author zyxelva * @date 2022/08/25 * @description åŸºäºNettyçš„æœåŠ¡å™¨ */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">EchoServer</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">int</span> port<span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token class-name">EchoServer</span><span class="token punctuation">(</span><span class="token keyword">int</span> port<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>port <span class="token operator">=</span> port<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">int</span> port <span class="token operator">=</span> <span class="token number">9999</span><span class="token punctuation">;</span>        <span class="token class-name">EchoServer</span> echoServer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">EchoServer</span><span class="token punctuation">(</span>port<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"æœåŠ¡å™¨å³å°†å¯åŠ¨"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        echoServer<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"æœåŠ¡å™¨å…³é—­"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">final</span> <span class="token class-name">EchoServerHandler</span> serverHandler <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">EchoServerHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">/*çº¿ç¨‹ç»„*/</span>        <span class="token class-name">EventLoopGroup</span> group <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NioEventLoopGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>            <span class="token comment">/*æœåŠ¡ç«¯å¯åŠ¨å¿…å¤‡*/</span>            <span class="token class-name">ServerBootstrap</span> b <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ServerBootstrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            b<span class="token punctuation">.</span><span class="token function">group</span><span class="token punctuation">(</span>group<span class="token punctuation">)</span>                    <span class="token comment">/*æŒ‡å®šä½¿ç”¨NIOçš„é€šä¿¡æ¨¡å¼*/</span>                    <span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token class-name">NioServerSocketChannel</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>                    <span class="token comment">/*æŒ‡å®šç›‘å¬ç«¯å£*/</span>                    <span class="token punctuation">.</span><span class="token function">localAddress</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">InetSocketAddress</span><span class="token punctuation">(</span>port<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">childHandler</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ChannelInitializer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SocketChannel</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                        <span class="token annotation punctuation">@Override</span>                        <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">initChannel</span><span class="token punctuation">(</span><span class="token class-name">SocketChannel</span> ch<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                            ch<span class="token punctuation">.</span><span class="token function">pipeline</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span>serverHandler<span class="token punctuation">)</span><span class="token punctuation">;</span>                        <span class="token punctuation">&#125;</span>                    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment">/*å¼‚æ­¥ç»‘å®šåˆ°æœåŠ¡å™¨ï¼Œsync()ä¼šé˜»å¡åˆ°å®Œæˆ*/</span>            <span class="token class-name">ChannelFuture</span> f <span class="token operator">=</span> b<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment">/*é˜»å¡å½“å‰çº¿ç¨‹ï¼Œç›´åˆ°æœåŠ¡å™¨çš„ServerChannelè¢«å…³é—­*/</span>            f<span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">closeFuture</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span> <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span>            group<span class="token punctuation">.</span><span class="token function">shutdownGracefully</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>æ–°å»º<code>ServerBootstrap</code>å®ä¾‹</li><li>æ³¨å†Œ<code>EventLoopGroup</code><br>ä¸Šä¸€ç« èŠ‚ä¸­ï¼Œæˆ‘ä»¬æåˆ°Netty Serverç«¯ä¸€èˆ¬æ˜¯æœ‰ä¸¤ä¸ª<code>EventLoopGroup</code>ï¼Œä¸€ä¸ªæ˜¯<code>Boss</code>ï¼Œä¸€ä¸ªæ˜¯<code>Worker</code>ï¼Œæˆ‘ä»¬å¯ä»¥æŸ¥çœ‹ <code>ServerBootstrap</code>çš„<code>group</code>æ–¹æ³•ï¼š<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ServerBootstrap</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractBootstrap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ServerBootstrap</span><span class="token punctuation">,</span> <span class="token class-name">ServerChannel</span><span class="token punctuation">></span></span> <span class="token punctuation">&#123;</span>    <span class="token keyword">public</span> <span class="token class-name">ServerBootstrap</span> <span class="token function">group</span><span class="token punctuation">(</span><span class="token class-name">EventLoopGroup</span> group<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">group</span><span class="token punctuation">(</span>group<span class="token punctuation">,</span> group<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">public</span> <span class="token class-name">ServerBootstrap</span> <span class="token function">group</span><span class="token punctuation">(</span><span class="token class-name">EventLoopGroup</span> parentGroup<span class="token punctuation">,</span> <span class="token class-name">EventLoopGroup</span> childGroup<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token comment">//æ­¤å¤„çœç•¥å‡ è¡Œä»£ç ...</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">//æ­¤å¤„çœç•¥ä¸€ä¸‡ä¸ªå­—ç¬¦</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ul><p>å¯ä»¥çœ‹å‡ºï¼Œ<code>group</code>åªæœ‰ä¸€ä¸ªå‚æ•°æ—¶ï¼Œå…¶å®<code>Boss</code>å’Œ<code>Work</code>å…±ç”¨ä¸€ä¸ª<code>EventLoopGroup</code>ã€‚</p><ul><li><p>æ³¨å†ŒIOçš„é€šä¿¡æ¨¡å¼<br>å‰é¢ä»‹ç»<code>IOæ¨¡å‹</code>æ—¶ä»‹ç»è¿‡ï¼Œè¿™é‡ŒNettyæä¾›äº†ä»¥ä¸‹å‡ ç§ï¼š</p><ul><li><code>EpollServerSocketChannel</code></li><li><code>NioServerSocketChannel</code></li><li><code>OioServerSocketChannel</code></li><li><code>KQueueServerSocketChannel</code>ï¼šè¿™ä¸ªä¸»è¦æ˜¯åœ¨<code>Unix</code>æ“ä½œç³»ç»Ÿä¸­ï¼Œæ¯”å¦‚<code>MacOS</code>ã€‚</li></ul></li><li><p>ç»‘å®šç”¨äºå®¢æˆ·ç«¯è¿æ¥ä½¿ç”¨çš„ç«¯å£</p></li><li><p>æ³¨å†Œ<code>ChannelHandler</code>ã€‚ä¸¤ç§æ–¹å¼ï¼š</p><ul><li>ç›´æ¥æ³¨å†Œå®ç°äº†<code>ChannelHandler</code>çš„å®ä¾‹</li><li>é€šè¿‡å®ç°<code>ChannelInitializer</code>æ¥å£çš„å®ä¾‹æ³¨å†Œ</li></ul></li></ul><p>æ€»ç»“ä¸‹ï¼Œ<code>ServerBootstrap</code>è¦å¹²çš„äº‹å„¿:</p><blockquote><p><code>new</code>ä¸€ä¸ª<code>ServerBootstrap</code>å®ä¾‹<br>ç»‘å®šä¸€ä¸ª<code>Channel</code>ï¼Œ<code>Channel</code>å¯ä»¥æ˜¯<code>OIO</code>ç±»å‹çš„ï¼Œä¹Ÿå¯ä»¥æ˜¯<code>NIO</code>ç±»å‹çš„<br>ç»‘å®šç«¯å£ï¼Œæä¾›ç»™å®¢æˆ·ç«¯é“¾æ¥<br>æ³¨å†ŒæœåŠ¡äº<code>Channel</code>çš„æ‰€æœ‰è¯·æ±‚çš„<code>ChannelHandler</code><br>å¼€å¯ç›‘å¬</p></blockquote><h3 id="2-1-3-ChannelHandler"><a href="#2-1-3-ChannelHandler" class="headerlink" title="2.1.3 ChannelHandler"></a>2.1.3 ChannelHandler</h3><p><code>ChannelHandler</code>æ˜¯ä¸€ä¸ª<code>æ¥å£æ—çš„çˆ¶æ¥å£</code>ï¼Œå®ƒçš„å®ç°è´Ÿè´£<code>æ¥æ”¶å¹¶å“åº”äº‹ä»¶é€šçŸ¥</code>ã€‚ åœ¨Netty åº”ç”¨ç¨‹åºä¸­ï¼Œæ‰€æœ‰çš„æ•°æ®å¤„ç†é€»è¾‘éƒ½åŒ…å«åœ¨è¿™äº›æ ¸å¿ƒæŠ½è±¡çš„å®ç°ä¸­ã€‚</p><p>å› ä¸ºä½ çš„<code>Echo æœåŠ¡å™¨</code>ä¼š<code>å“åº”</code>ä¼ å…¥çš„æ¶ˆæ¯ï¼Œæ‰€ä»¥å®ƒéœ€è¦å®ç°<code>ChannelInboundHandler</code> æ¥å£ï¼Œç”¨æ¥å®šä¹‰å“åº”<code>å…¥ç«™äº‹ä»¶</code>çš„æ–¹æ³•ã€‚è¿™ä¸ªç®€å•çš„åº”ç”¨ç¨‹åºåªéœ€è¦ç”¨åˆ°<code>å°‘é‡çš„</code>è¿™äº›æ–¹æ³•ï¼Œæ‰€ä»¥ç»§æ‰¿ <code>ChannelInboundHandlerAdapter</code> ç±»ä¹Ÿå°±è¶³å¤Ÿäº†ï¼Œ<code>å®ƒæä¾›äº†ChannelInboundHandler</code> çš„é»˜è®¤å®ç°ã€‚</p><p>æ ·ä¾‹ä»£ç å¦‚ä¸‹ï¼š</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">io<span class="token punctuation">.</span>netty<span class="token punctuation">.</span>buffer<span class="token punctuation">.</span></span><span class="token class-name">ByteBuf</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">io<span class="token punctuation">.</span>netty<span class="token punctuation">.</span>channel<span class="token punctuation">.</span></span><span class="token class-name">ChannelHandler</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">io<span class="token punctuation">.</span>netty<span class="token punctuation">.</span>channel<span class="token punctuation">.</span></span><span class="token class-name">ChannelHandlerContext</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">io<span class="token punctuation">.</span>netty<span class="token punctuation">.</span>channel<span class="token punctuation">.</span></span><span class="token class-name">ChannelInboundHandlerAdapter</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">io<span class="token punctuation">.</span>netty<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">CharsetUtil</span></span><span class="token punctuation">;</span><span class="token comment">/** * @author zyxelva */</span><span class="token comment">//EchoServerHandler è¢«æ ‡æ³¨ä¸º@Shareableï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥æ€»æ˜¯ä½¿ç”¨åŒæ ·çš„å®ä¾‹</span><span class="token annotation punctuation">@ChannelHandler.Sharable</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">EchoServerHandler</span> <span class="token keyword">extends</span> <span class="token class-name">ChannelInboundHandlerAdapter</span> <span class="token punctuation">&#123;</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">channelRead</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">,</span> <span class="token class-name">Object</span> msg<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">ByteBuf</span> in <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">ByteBuf</span><span class="token punctuation">)</span> msg<span class="token punctuation">;</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Server accept: "</span> <span class="token operator">+</span> in<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token class-name">CharsetUtil</span><span class="token punctuation">.</span><span class="token constant">UTF_8</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        ctx<span class="token punctuation">.</span><span class="token function">writeAndFlush</span><span class="token punctuation">(</span>in<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">channelReadComplete</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      ctx<span class="token punctuation">.</span><span class="token function">writeAndFlush</span><span class="token punctuation">(</span><span class="token class-name">Unpooled</span><span class="token punctuation">.</span><span class="token constant">EMPTY_BUFFER</span><span class="token punctuation">)</span>              <span class="token punctuation">.</span><span class="token function">addListener</span><span class="token punctuation">(</span><span class="token class-name">ChannelFutureListener</span><span class="token punctuation">.</span><span class="token constant">CLOSE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">exceptionCaught</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">,</span> <span class="token class-name">Throwable</span> cause<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>        cause<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        ctx<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æˆ‘ä»¬æ„Ÿå…´è¶£çš„æ–¹æ³•æ˜¯ï¼š</p><ul><li><code>channelRead()</code>ï¼šå¯¹äºæ¯ä¸ªä¼ å…¥çš„æ¶ˆæ¯éƒ½è¦è°ƒç”¨ï¼›</li><li><code>channelReadComplete()</code>ï¼šé€šçŸ¥<code>ChannelInboundHandler</code> æœ€åä¸€æ¬¡å¯¹<code>channelRead()</code>çš„è°ƒç”¨æ˜¯å½“å‰æ‰¹é‡è¯»å–ä¸­çš„<code>æœ€åä¸€æ¡</code>æ¶ˆæ¯ï¼›</li><li><code>exceptionCaught()</code>ï¼šåœ¨<code>è¯»å–</code>æ“ä½œæœŸé—´ï¼Œæœ‰å¼‚å¸¸æŠ›å‡ºæ—¶ä¼šè°ƒç”¨ã€‚</li></ul><blockquote><p>å¦‚æœä¸æ•è·å¼‚å¸¸ï¼Œä¼šå‘ç”Ÿä»€ä¹ˆå‘¢?<br>æ¯ä¸ª<code>Channel</code> éƒ½æ‹¥æœ‰ä¸€ä¸ªä¸ä¹‹ç›¸å…³è”çš„<code>ChannelPipeline</code>ï¼Œå…¶æŒæœ‰ä¸€ä¸ª<code>ChannelHandler</code> çš„<code>å®ä¾‹é“¾</code>ã€‚åœ¨é»˜è®¤çš„æƒ…å†µä¸‹ï¼Œ<code>ChannelHandler</code> ä¼šæŠŠå¯¹å®ƒçš„æ–¹æ³•çš„è°ƒç”¨è½¬å‘ç»™é“¾ä¸­çš„<code>ä¸‹ä¸€ä¸ªChannelHandler</code>ã€‚å› æ­¤ï¼Œå¦‚æœ<code>exceptionCaught()</code>æ–¹æ³•æ²¡æœ‰è¢«è¯¥é“¾ä¸­çš„æŸå¤„å®ç°ï¼Œé‚£ä¹ˆæ‰€æ¥æ”¶çš„å¼‚å¸¸å°†ä¼šè¢«ä¼ é€’åˆ°<code>ChannelPipeline çš„å°¾ç«¯</code>å¹¶è¢«è®°å½•ã€‚ä¸ºæ­¤ï¼Œä½ çš„åº”ç”¨ç¨‹åºåº”è¯¥æä¾›<code>è‡³å°‘æœ‰ä¸€ä¸ª</code>å®ç°äº†<code>exceptionCaught()</code>æ–¹æ³•çš„<code>ChannelHandler</code>ã€‚</p></blockquote><h2 id="2-2-Client"><a href="#2-2-Client" class="headerlink" title="2.2 Client"></a>2.2 Client</h2><p>è€æ ·å­ï¼Œå…ˆä¸Šä»£ç ï¼š</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">io<span class="token punctuation">.</span>netty<span class="token punctuation">.</span>bootstrap<span class="token punctuation">.</span></span><span class="token class-name">Bootstrap</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">io<span class="token punctuation">.</span>netty<span class="token punctuation">.</span>bootstrap<span class="token punctuation">.</span></span><span class="token class-name">ServerBootstrap</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">io<span class="token punctuation">.</span>netty<span class="token punctuation">.</span>channel<span class="token punctuation">.</span></span><span class="token class-name">ChannelFuture</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">io<span class="token punctuation">.</span>netty<span class="token punctuation">.</span>channel<span class="token punctuation">.</span></span><span class="token class-name">ChannelInitializer</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">io<span class="token punctuation">.</span>netty<span class="token punctuation">.</span>channel<span class="token punctuation">.</span></span><span class="token class-name">EventLoopGroup</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">io<span class="token punctuation">.</span>netty<span class="token punctuation">.</span>channel<span class="token punctuation">.</span>nio<span class="token punctuation">.</span></span><span class="token class-name">NioEventLoopGroup</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">io<span class="token punctuation">.</span>netty<span class="token punctuation">.</span>channel<span class="token punctuation">.</span>socket<span class="token punctuation">.</span></span><span class="token class-name">SocketChannel</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">io<span class="token punctuation">.</span>netty<span class="token punctuation">.</span>channel<span class="token punctuation">.</span>socket<span class="token punctuation">.</span>nio<span class="token punctuation">.</span></span><span class="token class-name">NioServerSocketChannel</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">io<span class="token punctuation">.</span>netty<span class="token punctuation">.</span>channel<span class="token punctuation">.</span>socket<span class="token punctuation">.</span>nio<span class="token punctuation">.</span></span><span class="token class-name">NioSocketChannel</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>net<span class="token punctuation">.</span></span><span class="token class-name">InetSocketAddress</span></span><span class="token punctuation">;</span><span class="token comment">/** * @author zyxelva * @date 2022/08/25 * @description åŸºäºNettyçš„å®¢æˆ·ç«¯ */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">EchoClient</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">int</span> port<span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">String</span> host<span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token class-name">EchoClient</span><span class="token punctuation">(</span><span class="token keyword">int</span> port<span class="token punctuation">,</span> <span class="token class-name">String</span> host<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>port <span class="token operator">=</span> port<span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>host <span class="token operator">=</span> host<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">&#123;</span>        <span class="token comment">//çº¿ç¨‹ç»„</span>        <span class="token class-name">EventLoopGroup</span> group <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NioEventLoopGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>            <span class="token comment">//å®¢æˆ·ç«¯å¯åŠ¨å¿…å¤‡</span>            <span class="token class-name">Bootstrap</span> b <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Bootstrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            b<span class="token punctuation">.</span><span class="token function">group</span><span class="token punctuation">(</span>group<span class="token punctuation">)</span>                    <span class="token comment">//æŒ‡å®šä½¿ç”¨NIOçš„é€šä¿¡æ¨¡å¼</span>                    <span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token class-name">NioSocketChannel</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>                    <span class="token comment">//æŒ‡å®šæœåŠ¡å™¨çš„IPåœ°å€å’Œç«¯å£</span>                    <span class="token punctuation">.</span><span class="token function">remoteAddress</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">InetSocketAddress</span><span class="token punctuation">(</span>host<span class="token punctuation">,</span> port<span class="token punctuation">)</span><span class="token punctuation">)</span>                    <span class="token comment">//æ³¨å†ŒChannelHandler</span>                    <span class="token punctuation">.</span><span class="token function">handler</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ChannelInitializer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SocketChannel</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                        <span class="token annotation punctuation">@Override</span>                        <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">initChannel</span><span class="token punctuation">(</span><span class="token class-name">SocketChannel</span> ch<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>                            ch<span class="token punctuation">.</span><span class="token function">pipeline</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">EchoClientHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                        <span class="token punctuation">&#125;</span>                    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment">//å¼‚æ­¥è¿æ¥åˆ°æœåŠ¡å™¨ï¼Œsync()ä¼šé˜»å¡åˆ°å®Œæˆ</span>            <span class="token class-name">ChannelFuture</span> f <span class="token operator">=</span> b<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment">//é˜»å¡å½“å‰çº¿ç¨‹ï¼Œç›´åˆ°å®¢æˆ·ç«¯çš„Channelè¢«å…³é—­</span>            f<span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">closeFuture</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span> <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span>            group<span class="token punctuation">.</span><span class="token function">shutdownGracefully</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">new</span> <span class="token class-name">EchoClient</span><span class="token punctuation">(</span><span class="token number">9999</span><span class="token punctuation">,</span> <span class="token string">"127.0.0.1"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>Clientç«¯å¯åŠ¨ä¸Serverç«¯ç±»ä¼¼ï¼Œéœ€è¦ä»¥ä¸‹ç»„ä»¶ï¼š</p><ul><li>å¼•å¯¼ï¼š<code>Bootstrap</code></li><li>è‡³å°‘ä¸€ä¸ª<code>ChannelHandler</code></li></ul><h3 id="2-2-1-Bootstrap"><a href="#2-2-1-Bootstrap" class="headerlink" title="2.2.1 Bootstrap"></a>2.2.1 Bootstrap</h3><ul><li>æ–°å»º<code>Bootstrap</code>å®ä¾‹<br>ä¸Serverç«¯ä¸»è¦åŒºåˆ«åœ¨äºå¼•å¯¼ç±»æ˜¯<code>Bootstrap</code>ï¼ŒClientç«¯éœ€è¦çš„æ˜¯<code>Bootstrapå®ä¾‹</code>ï¼Œä¸”éœ€è¦æŒ‡å®š<code>Serverç«¯</code>æä¾›çš„<code>åœ°å€</code>å’Œ<code>ç«¯å£</code>ï¼Œä»¥ä¾¿äº<code>è¿æ¥</code>ã€‚</li><li>æ³¨å†ŒIOçš„é€šä¿¡æ¨¡å¼</li><li>æŒ‡å®šæœåŠ¡å™¨çš„<code>IPåœ°å€</code>å’Œ<code>ç«¯å£</code></li><li>æ³¨å†Œ<code>ChannelHandler</code></li><li>å¼‚æ­¥<code>è¿æ¥</code>åˆ°æœåŠ¡å™¨</li></ul><h3 id="2-2-2-ChannelHandler"><a href="#2-2-2-ChannelHandler" class="headerlink" title="2.2.2 ChannelHandler"></a>2.2.2 ChannelHandler</h3><p>å¦‚åŒæœåŠ¡å™¨ï¼Œå®¢æˆ·ç«¯å°†æ‹¥æœ‰ä¸€ä¸ªç”¨æ¥å¤„ç†æ•°æ®çš„<code>ChannelInboundHandler</code>ã€‚åœ¨è¿™ä¸ªåœºæ™¯ä¸‹ï¼Œä½ å°†æ‰©å±•<code>SimpleChannelInboundHandler ç±»</code>ä»¥å¤„ç†æ‰€æœ‰å¿…é¡»çš„ä»»åŠ¡ï¼Œå¦‚ä¸‹ä»£ç æ¸…å•æ‰€ç¤ºã€‚è¿™è¦æ±‚é‡å†™ä¸‹é¢çš„æ–¹æ³•ï¼š</p><ul><li><code>channelActive()</code>ï¼šåœ¨åˆ°æœåŠ¡å™¨çš„<code>è¿æ¥å·²ç»å»ºç«‹ä¹‹å</code>å°†è¢«è°ƒç”¨ï¼›</li><li><code>channelRead0()</code>ï¼šå½“ä»æœåŠ¡å™¨<code>æ¥æ”¶</code>åˆ°ä¸€æ¡æ¶ˆæ¯æ—¶è¢«è°ƒç”¨ï¼›</li><li><code>exceptionCaught()</code>ï¼šåœ¨å¤„ç†è¿‡ç¨‹ä¸­<code>å¼•å‘å¼‚å¸¸</code>æ—¶è¢«è°ƒç”¨ã€‚</li></ul><p>å®ç°ä»£ç ï¼š</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">io<span class="token punctuation">.</span>netty<span class="token punctuation">.</span>buffer<span class="token punctuation">.</span></span><span class="token class-name">ByteBuf</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">io<span class="token punctuation">.</span>netty<span class="token punctuation">.</span>buffer<span class="token punctuation">.</span></span><span class="token class-name">Unpooled</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">io<span class="token punctuation">.</span>netty<span class="token punctuation">.</span>channel<span class="token punctuation">.</span></span><span class="token class-name">ChannelHandlerContext</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">io<span class="token punctuation">.</span>netty<span class="token punctuation">.</span>channel<span class="token punctuation">.</span></span><span class="token class-name">SimpleChannelInboundHandler</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">io<span class="token punctuation">.</span>netty<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">CharsetUtil</span></span><span class="token punctuation">;</span><span class="token comment">/** * @author zyxelva * @date 2022/08/25 * @description EchoClientHandler */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">EchoClientHandler</span> <span class="token keyword">extends</span> <span class="token class-name">SimpleChannelInboundHandler</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ByteBuf</span><span class="token punctuation">></span></span> <span class="token punctuation">&#123;</span>    <span class="token comment">/**     * è¯»å–åˆ°ç½‘ç»œæ•°æ®åè¿›è¡Œä¸šåŠ¡å¤„ç†     */</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">channelRead0</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">,</span> <span class="token class-name">ByteBuf</span> msg<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"client Accept"</span> <span class="token operator">+</span> msg<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token class-name">CharsetUtil</span><span class="token punctuation">.</span><span class="token constant">UTF_8</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">/**     * channelæ´»è·ƒåï¼Œåšä¸šåŠ¡å¤„ç†     */</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">channelActive</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>        ctx<span class="token punctuation">.</span><span class="token function">writeAndFlush</span><span class="token punctuation">(</span><span class="token class-name">Unpooled</span><span class="token punctuation">.</span><span class="token function">copiedBuffer</span><span class="token punctuation">(</span><span class="token string">"Hello,Netty"</span><span class="token punctuation">,</span> <span class="token class-name">CharsetUtil</span><span class="token punctuation">.</span><span class="token constant">UTF_8</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>        <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">exceptionCaught</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">,</span> <span class="token class-name">Throwable</span> cause<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        cause<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        ctx<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p><code>SimpleChannelInboundHandler</code> ä¸<code>ChannelInboundHandler</code><br>ä¸ºä»€ä¹ˆæˆ‘ä»¬åœ¨<code>å®¢æˆ·ç«¯</code>ä½¿ç”¨çš„æ˜¯<code>SimpleChannelInboundHandler</code>ï¼Œè€Œä¸æ˜¯åœ¨<code>EchoServerHandler</code> ä¸­æ‰€ä½¿ç”¨çš„<code>ChannelInboundHandlerAdapter</code> å‘¢ï¼Ÿè¿™å’Œä¸¤ä¸ªå› ç´ çš„ç›¸äº’ä½œç”¨æœ‰å…³ï¼š<strong>ä¸šåŠ¡é€»è¾‘å¦‚ä½•å¤„ç†æ¶ˆæ¯</strong>ä»¥åŠ<strong>Netty å¦‚ä½•ç®¡ç†èµ„æº</strong>ã€‚<br>åœ¨<code>å®¢æˆ·ç«¯</code>ï¼Œå½“<code>channelRead0()</code>æ–¹æ³•å®Œæˆæ—¶ï¼Œä½ å·²ç»æœ‰äº†ä¼ å…¥æ¶ˆæ¯ï¼Œå¹¶ä¸”å·²ç»å¤„ç†å®Œå®ƒäº†ã€‚å½“è¯¥æ–¹æ³•è¿”å›æ—¶ï¼Œ<code>SimpleChannelInboundHandler</code> è´Ÿè´£é‡Šæ”¾æŒ‡å‘ä¿å­˜è¯¥æ¶ˆæ¯çš„<code>ByteBuf</code> çš„å†…å­˜å¼•ç”¨ã€‚<br>åœ¨<code>EchoServerHandler</code> ä¸­ï¼Œä½ ä»ç„¶éœ€è¦å°†ä¼ å…¥æ¶ˆæ¯å›é€ç»™å‘é€è€…ï¼Œè€Œ<code>write()</code>æ“ä½œæ˜¯<code>å¼‚æ­¥çš„</code>ï¼Œç›´åˆ°<code>channelRead()</code>æ–¹æ³•è¿”å›åå¯èƒ½ä»ç„¶æ²¡æœ‰å®Œæˆã€‚ä¸ºæ­¤ï¼Œ<code>EchoServerHandler</code>æ‰©å±•äº†<code>ChannelInboundHandlerAdapter</code>ï¼Œå…¶åœ¨è¿™ä¸ªæ—¶é—´ç‚¹ä¸Šä¸ä¼šé‡Šæ”¾æ¶ˆæ¯ã€‚<br>æ¶ˆæ¯åœ¨<code>EchoServerHandler</code> çš„<code>channelReadComplete()</code>æ–¹æ³•ä¸­ï¼Œå½“<code>writeAndFlush()</code>æ–¹æ³•è¢«è°ƒç”¨æ—¶è¢«é‡Šæ”¾ã€‚</p></blockquote><p>æ€»ç»“ä¸‹Clientå¯åŠ¨æµç¨‹ï¼š</p><ul><li>ä¸ºåˆå§‹åŒ–å®¢æˆ·ç«¯ï¼Œåˆ›å»ºäº†ä¸€ä¸ª<code>Bootstrap å®ä¾‹</code>ï¼›</li><li>ä¸ºè¿›è¡Œäº‹ä»¶å¤„ç†åˆ†é…äº†ä¸€ä¸ª<code>NioEventLoopGroup å®ä¾‹</code>ï¼Œå…¶ä¸­äº‹ä»¶å¤„ç†åŒ…æ‹¬<code>åˆ›å»ºæ–°çš„è¿æ¥</code>ä»¥åŠ<code>å¤„ç†å…¥ç«™å’Œå‡ºç«™æ•°æ®</code>ï¼›</li><li>ä¸ºæœåŠ¡å™¨è¿æ¥åˆ›å»ºäº†ä¸€ä¸ª<code>InetSocketAddress å®ä¾‹</code>ï¼›</li><li>å½“è¿æ¥è¢«å»ºç«‹æ—¶ï¼Œä¸€ä¸ª<code>EchoClientHandler å®ä¾‹</code>ä¼šè¢«å®‰è£…åˆ°ï¼ˆè¯¥Channel çš„ï¼‰<code>ChannelPipeline</code> ä¸­ï¼›</li><li>åœ¨ä¸€åˆ‡éƒ½è®¾ç½®å®Œæˆåï¼Œè°ƒç”¨<code>Bootstrap.connect()</code>æ–¹æ³•<code>è¿æ¥</code>åˆ°è¿œç¨‹èŠ‚ç‚¹ï¼›</li></ul><p>å®Œæˆäº†å®¢æˆ·ç«¯ï¼Œä½ ä¾¿å¯ä»¥ç€æ‰‹æ„å»ºå¹¶æµ‹è¯•è¯¥ç³»ç»Ÿäº†ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> Nettyå­¦ä¹  </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Netty </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ã€Nettyå­¦ä¹ ã€‘3.Nettyçš„ç»„ä»¶</title>
      <link href="/posts/1355578097.html"/>
      <url>/posts/1355578097.html</url>
      
        <content type="html"><![CDATA[<h1 id="1-ä¸ºä»€ä¹ˆè¦ç”¨-Netty"><a href="#1-ä¸ºä»€ä¹ˆè¦ç”¨-Netty" class="headerlink" title="1 ä¸ºä»€ä¹ˆè¦ç”¨ Netty?"></a>1 ä¸ºä»€ä¹ˆè¦ç”¨ Netty?</h1><ul><li>æä¾›äº† <code>JAVA NIO</code>ä½†<code>æ²¡æœ‰æä¾›</code>é’ˆå¯¹ <code>Protocol Buffer</code>ã€<code>JSON</code> è¿™äº›ä¿¡æ¯æ ¼å¼çš„<code>å°è£…</code>ã€‚</li><li>NIOç±»åº“å’Œ API <code>å¤æ‚</code>ï¼Œ<code>ç½‘ç»œç¼–ç¨‹å¤æ‚</code>ï¼Œ<code>éš¾åº¦è¾ƒå¤§</code>ã€‚</li><li>æä¾›ä¸Šå±‚ç‰¹æœ‰æœåŠ¡ï¼Œå¦‚æ•°æ®æ ¼å¼å°è£…ï¼Œå®¢æˆ·ç«¯æƒé™ã€ç®€å•çš„æ•°æ®è¯»å–ã€æ–­è¿é‡è¿ã€åŠåŒ…è¯»å†™ã€å¿ƒè·³ç­‰ã€‚</li><li><code>JAVA NIO</code> å­˜åœ¨ <code>epoll bug</code>, <code>selector</code> ä¸èƒ½é˜»å¡ï¼ŒCPU ä¼šé£šè‡³ 100%ï¼ˆåªèƒ½åœ¨ LINUX å†…æ ¸ä¸Šé‡ç°ï¼‰ï¼ŒNetty å·²ç»è§£å†³ã€‚<ul><li>åŸå› ï¼š<blockquote><p>å› ä¸º<code>poll</code>å’Œ<code>epoll</code>å¯¹äº<strong>çªç„¶ä¸­æ–­</strong>çš„è¿æ¥socketä¼šå¯¹è¿”å›çš„<code>eventSetäº‹ä»¶é›†åˆ</code>ç½®ä¸º<code>POLLHUP</code>æˆ–è€…<code>POLLERR</code>ï¼Œ<code>eventSetäº‹ä»¶é›†åˆ</code>å‘ç”Ÿäº†å˜åŒ–ï¼Œè¿™å°±å¯¼è‡´<code>Selector</code>ä¼š<strong>è¢«å”¤é†’</strong>ï¼Œè¿›è€Œå¯¼è‡´CPU 100%é—®é¢˜ã€‚<code>æ ¹æœ¬åŸå› </code>å°±æ˜¯<strong>JDKæ²¡æœ‰å¤„ç†å¥½è¿™ç§æƒ…å†µ</strong>ã€‚</p></blockquote></li><li>netty è§£å†³åŠæ³•ï¼š<blockquote><p>åˆ›å»ºä¸€ä¸ªæ–°çš„<code>Selector</code>ã€‚å¤„ç†æœºåˆ¶å°±æ˜¯å¦‚æœå‘ç”Ÿäº†è¿™ç§æƒ…å†µï¼Œå¹¶ä¸”å‘ç”Ÿæ¬¡æ•°è¶…è¿‡äº†<code>SELECTOR_AUTO_REBUILD_THRESHOLD</code>(é»˜è®¤512)ï¼Œåˆ™è°ƒç”¨<code>rebuildSelector()</code>è¿›è¡Œ<code>Selecttoré‡å»º</code>ï¼Œè¿™æ ·å°±ä¸ç”¨ç®¡ä¹‹å‰å‘ç”Ÿäº†å¼‚å¸¸æƒ…å†µçš„é‚£ä¸ªè¿æ¥äº†ã€‚å› ä¸ºé‡å»ºä¹Ÿæ˜¯æ ¹æ®<code>SelectionKeyäº‹ä»¶</code>å¯¹åº”çš„<code>è¿æ¥</code>æ¥<code>é‡æ–°æ³¨å†Œ</code>çš„ã€‚</p></blockquote></li><li>NIO <code>epoll bug</code>ä¸æ˜¯<code>linux epoll</code>çš„é—®é¢˜ï¼Œè€Œæ˜¯<code>JDK</code>è‡ªå·±å®ç°<code>epoll</code>æ—¶æ²¡æœ‰è€ƒè™‘è¿™ç§æƒ…å†µã€‚</li></ul></li></ul><h1 id="2-ä¸ºä»€ä¹ˆNetty-ä½¿ç”¨NIOè€Œä¸æ˜¯AIOï¼Ÿ"><a href="#2-ä¸ºä»€ä¹ˆNetty-ä½¿ç”¨NIOè€Œä¸æ˜¯AIOï¼Ÿ" class="headerlink" title="2 ä¸ºä»€ä¹ˆNetty ä½¿ç”¨NIOè€Œä¸æ˜¯AIOï¼Ÿ"></a>2 ä¸ºä»€ä¹ˆNetty ä½¿ç”¨NIOè€Œä¸æ˜¯AIOï¼Ÿ</h1><ul><li>Netty ä¸çœ‹é‡<code>Windows</code>ä¸Šçš„ä½¿ç”¨ï¼Œåœ¨<code>Linux</code>ç³»ç»Ÿä¸Šï¼ŒAIO çš„åº•å±‚å®ç°ä»ä½¿ç”¨<code>EPOLL</code>ï¼Œæ²¡æœ‰å¾ˆå¥½å®ç°<code>AIO</code>ï¼Œå› æ­¤åœ¨æ€§èƒ½ä¸Šæ²¡æœ‰æ˜æ˜¾çš„ä¼˜åŠ¿ï¼Œè€Œä¸”è¢«<code>JDK</code> å°è£…äº†ä¸€å±‚ä¸å®¹æ˜“æ·±åº¦ä¼˜åŒ–ã€‚</li><li>AIO è¿˜æœ‰ä¸ª<code>ç¼ºç‚¹</code>æ˜¯æ¥æ”¶æ•°æ®éœ€è¦<code>é¢„å…ˆåˆ†é…ç¼“å­˜</code>, è€Œä¸æ˜¯NIO é‚£ç§<code>éœ€è¦æ¥æ”¶</code>æ—¶æ‰éœ€è¦åˆ†é…ç¼“å­˜, æ‰€ä»¥å¯¹è¿æ¥æ•°é‡éå¸¸å¤§ä½†æµé‡å°çš„æƒ…å†µ, å†…å­˜æµªè´¹å¾ˆå¤šã€‚</li></ul><h1 id="3-ä¸ºä»€ä¹ˆä¸ç”¨Netty5"><a href="#3-ä¸ºä»€ä¹ˆä¸ç”¨Netty5" class="headerlink" title="3 ä¸ºä»€ä¹ˆä¸ç”¨Netty5?"></a>3 ä¸ºä»€ä¹ˆä¸ç”¨Netty5?</h1><p>Netty5 å·²ç»åœæ­¢å¼€å‘ã€‚</p><h1 id="4-Netty-ç»„ä»¶"><a href="#4-Netty-ç»„ä»¶" class="headerlink" title="4 Netty ç»„ä»¶"></a>4 Netty ç»„ä»¶</h1><h2 id="4-1-Channel"><a href="#4-1-Channel" class="headerlink" title="4.1 Channel"></a>4.1 Channel</h2><p>ä»£è¡¨ä¸€ä¸ªåˆ°<code>å®ä½“</code>ï¼ˆå¦‚ä¸€ä¸ªç¡¬ä»¶è®¾å¤‡ã€ä¸€ä¸ªæ–‡ä»¶ã€ä¸€ä¸ªç½‘ç»œå¥—æ¥å­—æˆ–è€…ä¸€ä¸ªèƒ½å¤Ÿæ‰§è¡Œä¸€ä¸ªæˆ–è€…å¤šä¸ªä¸åŒçš„I&#x2F;O æ“ä½œçš„ç¨‹åºç»„ä»¶ï¼‰çš„<code>å¼€æ”¾è¿æ¥</code>ï¼Œå¦‚<code>è¯»æ“ä½œ</code>å’Œ<code>å†™æ“ä½œ</code>ã€‚</p><p>ç›®å‰ï¼Œå¯ä»¥æŠŠChannelçœ‹ä½œæ˜¯<code>ä¼ å…¥</code>ï¼ˆå…¥ç«™ï¼‰æˆ–è€…<code>ä¼ å‡º</code>ï¼ˆå‡ºç«™ï¼‰æ•°æ®çš„è½½ä½“ã€‚å› æ­¤ï¼Œå®ƒå¯ä»¥<code>è¢«æ‰“å¼€</code>æˆ–è€…<code>è¢«å…³é—­</code>ï¼Œ<code>è¿æ¥</code>æˆ–è€…<code>æ–­å¼€è¿æ¥</code>ã€‚<br><img src="https://img-blog.csdn.net/20151005150520638" alt="æŠ½è±¡çš„Channel"></p><ul><li>ç”Ÿå‘½å‘¨æœŸ<ul><li>ChannelUnregisteredï¼š<code>Channel</code> å·²ç»<code>è¢«åˆ›å»º</code>ï¼Œä½†è¿˜<code>æœªæ³¨å†Œ</code>åˆ°<code>EventLoop</code>ï¼›</li><li>ChannelRegisteredï¼š<code>Channel</code> å·²ç»<code>è¢«æ³¨å†Œ</code>åˆ°äº†<code>EventLoop</code>ï¼›</li><li>ChannelActiveï¼š<code>Channel</code>å¤„äº<code>æ´»åŠ¨çŠ¶æ€</code>ï¼ˆå·²ç»è¿æ¥åˆ°å®ƒçš„è¿œç¨‹èŠ‚ç‚¹ï¼‰ã€‚å®ƒç°åœ¨å¯ä»¥<code>æ¥æ”¶</code>å’Œ<code>å‘é€</code>æ•°æ®äº†ï¼›</li><li>ChannelInactiveï¼š<code>Channel</code> æ²¡æœ‰è¿æ¥åˆ°è¿œç¨‹èŠ‚ç‚¹ï¼Œå½“è¿™äº›çŠ¶æ€å‘ç”Ÿæ”¹å˜æ—¶ï¼Œå°†ä¼šç”Ÿæˆå¯¹åº”çš„äº‹ä»¶ã€‚è¿™äº›äº‹ä»¶å°†ä¼šè¢«è½¬å‘ç»™<code>ChannelPipeline</code>ä¸­çš„<code>ChannelHandler</code>ï¼Œå…¶å¯ä»¥éšåå¯¹å®ƒä»¬åšå‡ºå“åº”ã€‚</li></ul></li></ul><p>å½“è¿™äº›çŠ¶æ€å‘ç”Ÿæ”¹å˜æ—¶ï¼Œå°†ä¼šç”Ÿæˆå¯¹åº”çš„äº‹ä»¶ã€‚è¿™äº›äº‹ä»¶å°†ä¼šè¢«è½¬å‘ç»™<code>ChannelPipeline</code>ä¸­çš„<code>ChannelHandler</code>ï¼Œå…¶å¯ä»¥éšåå¯¹å®ƒä»¬åšå‡ºå“åº”ã€‚</p><p><img src="https://img-blog.csdn.net/20151005210409421" alt="Channelç”Ÿå‘½å‘¨æœŸ"></p><ul><li>æ¥å£</li></ul><p>åŸºæœ¬çš„ <code>I/O æ“ä½œ</code>(<code>bind()</code>ã€<code>connect()</code>ã€<code>read()</code>å’Œ <code>write()</code>)ä¾èµ–äºåº•å±‚ç½‘ç»œä¼ è¾“æ‰€æä¾›çš„<code>åŸè¯­</code>ã€‚åœ¨åŸºäº Java çš„ç½‘ç»œç¼–ç¨‹ä¸­ï¼Œå…¶åŸºæœ¬çš„æ„é€ æ˜¯<code>ç±» Socket</code>ã€‚Netty çš„ <code>Channel æ¥å£</code>æ‰€æä¾›çš„ <code>API</code>ï¼Œè¢«ç”¨äºæ‰€æœ‰çš„ <code>I/O æ“ä½œ</code>ã€‚å¤§å¤§åœ°é™ä½äº†ç›´æ¥ä½¿ç”¨ Socket ç±»çš„å¤æ‚æ€§ã€‚æ­¤å¤–ï¼ŒChannel ä¹Ÿæ˜¯æ‹¥æœ‰è®¸å¤š<code>é¢„å®šä¹‰çš„</code>ã€<code>ä¸“é—¨åŒ–å®ç°çš„</code>å¹¿æ³›ç±»å±‚æ¬¡ç»“æ„çš„æ ¹ã€‚</p><p>ç”±äºChannel æ˜¯<code>ç‹¬ä¸€æ— äºŒ</code>çš„ï¼Œæ‰€ä»¥ä¸ºäº†ä¿è¯é¡ºåºå°†Channel å£°æ˜ä¸º<code>java.lang.Comparable</code> çš„ä¸€ä¸ª<code>å­æ¥å£</code>ã€‚å› æ­¤ï¼Œå¦‚æœä¸¤ä¸ªä¸åŒçš„ <code>Channel å®ä¾‹</code>éƒ½è¿”å›äº†ç›¸åŒçš„æ•£åˆ—ç ï¼Œé‚£ä¹ˆ <code>AbstractChannel</code> ä¸­çš„ <code>compareTo()æ–¹æ³•</code>çš„å®ç°å°†ä¼šæŠ›å‡ºä¸€ä¸ª <code>Error</code>ã€‚</p><ul><li>æœ€é‡è¦ Channel çš„æ–¹æ³•<ul><li><code>eventLoop</code>: è¿”å›åˆ†é…ç»™ Channel çš„ EventLoop</li><li><code>pipeline</code>: è¿”å›åˆ†é…ç»™ Channel çš„ ChannelPipeline</li><li><code>isActive</code>: å¦‚æœ Channel æ˜¯æ´»åŠ¨çš„ï¼Œåˆ™è¿”å› trueã€‚æ´»åŠ¨çš„æ„ä¹‰å¯èƒ½ä¾èµ–äºåº•å±‚çš„ä¼ è¾“ã€‚ ä¾‹å¦‚ï¼Œä¸€ä¸ª Socket ä¼ è¾“ä¸€æ—¦è¿æ¥åˆ°äº†è¿œç¨‹èŠ‚ç‚¹ä¾¿æ˜¯æ´»åŠ¨çš„ï¼Œè€Œä¸€ä¸ª Datagram ä¼ è¾“ä¸€æ—¦è¢« æ‰“å¼€ä¾¿æ˜¯æ´»åŠ¨çš„ã€‚</li><li><code>localAddress</code>: è¿”å›<strong>æœ¬åœ°</strong>çš„ <code>SokcetAddress</code></li><li><code>remoteAddress</code>: è¿”å›<strong>è¿œç¨‹</strong>çš„ <code>SocketAddress</code></li><li><code>write</code>: å°†æ•°æ®å†™åˆ°è¿œç¨‹èŠ‚ç‚¹ã€‚è¿™ä¸ªæ•°æ®å°†è¢«ä¼ é€’ç»™ <code>ChannelPipeline</code>ï¼Œå¹¶ä¸”æ’é˜Ÿç›´åˆ°å®ƒè¢«å†²åˆ·</li><li><code>flush</code>: å°†ä¹‹å‰å·²å†™çš„æ•°æ®å†²åˆ·åˆ°åº•å±‚ä¼ è¾“ï¼Œå¦‚ä¸€ä¸ª <code>Socket</code></li><li><code>writeAndFlush</code>: ä¸€ä¸ªç®€ä¾¿çš„æ–¹æ³•ï¼Œç­‰åŒäºè°ƒç”¨ <code>write()</code>å¹¶æ¥ç€è°ƒç”¨ <code>flush()</code></li></ul></li></ul><h2 id="4-2-EventLoop-Group"><a href="#4-2-EventLoop-Group" class="headerlink" title="4.2 EventLoop(Group)"></a>4.2 EventLoop(Group)</h2><p>å›æƒ³ä¸€ä¸‹æˆ‘ä»¬åœ¨ <code>NIO</code> ä¸­æ˜¯å¦‚ä½•å¤„ç†æˆ‘ä»¬å…³å¿ƒçš„äº‹ä»¶çš„?</p><blockquote><p>åœ¨ä¸€ä¸ª <code>while</code> å¾ªç¯ä¸­ <code>select</code> å‡ºäº‹ä»¶ï¼Œç„¶åä¾æ¬¡å¤„ç†æ¯ç§äº‹ä»¶ã€‚æˆ‘ä»¬å¯ä»¥æŠŠå®ƒç§°ä¸º<code>äº‹ä»¶å¾ªç¯</code>ï¼Œè¿™å°±æ˜¯ <code>EventLoop</code>ã€‚</p></blockquote><p><code>interface io.netty.channel.EventLoop</code> å®šä¹‰äº† Netty çš„æ ¸å¿ƒæŠ½è±¡ï¼Œç”¨äºå¤„ç†ç½‘ç»œè¿æ¥çš„ç”Ÿå‘½å‘¨æœŸä¸­æ‰€å‘ç”Ÿçš„äº‹ä»¶ã€‚</p><p>Netty çš„ <code>EventLoop</code> æ˜¯<code>ååŒè®¾è®¡</code> çš„ä¸€éƒ¨åˆ†ï¼Œå®ƒé‡‡ç”¨äº†ä¸¤ä¸ªåŸºæœ¬çš„ API:<code>å¹¶å‘</code>å’Œ<code>ç½‘ç»œç¼–ç¨‹</code>ã€‚</p><ul><li><p><code>io.netty.util.concurrent</code> åŒ…æ„å»ºåœ¨ JDK çš„ <code>java.util.concurrent</code> åŒ…ä¸Šï¼Œç”¨æ¥æä¾›<code>çº¿ç¨‹æ‰§è¡Œå™¨</code>ã€‚</p></li><li><p><code>io.netty.channel</code> åŒ…ä¸­çš„ç±»ï¼Œä¸ºäº†ä¸ <code>Channel</code> çš„äº‹ä»¶è¿›è¡Œäº¤äº’ï¼Œ æ‰©å±•äº†è¿™äº›æ¥å£&#x2F;ç±»ã€‚<br><img src="https://cdn.jsdelivr.net/gh/zyxelva/picgo@main/markdown/EventLoop.png" alt="EventLoopç±»å±‚æ¬¡ç»“æ„"></p></li><li><p>ä¸€ä¸ª <code>EventLoop</code> å°†ç”±ä¸€ä¸ª<strong>æ°¸è¿œéƒ½ä¸ä¼šæ”¹å˜</strong>çš„ <code>Thread</code> é©±åŠ¨ï¼ŒåŒæ—¶<code>ä»»åŠ¡</code>(Runnable æˆ–è€… Callable)å¯ä»¥<strong>ç›´æ¥</strong>æäº¤ç»™ <code>EventLoop</code> å®ç°ï¼Œä»¥ç«‹å³æ‰§è¡Œæˆ–è€…è°ƒåº¦æ‰§è¡Œã€‚</p></li><li><p>Netty çš„ <code>EventLoop</code> åœ¨ç»§æ‰¿äº† <code>ScheduledExecutorService</code> çš„åŒæ—¶ï¼Œåªå®šä¹‰äº†ä¸€ä¸ªæ–¹æ³•ï¼Œ <code>parent()</code>ã€‚åœ¨ <code>Netty 4</code> ä¸­ï¼Œæ‰€æœ‰çš„ <code>I/O æ“ä½œå’Œäº‹ä»¶</code>éƒ½ç”±å·²ç»è¢«åˆ†é…ç»™äº† <code>EventLoop</code> çš„é‚£ä¸ª <code>Thread</code> æ¥å¤„ç†ã€‚</p></li></ul><p><code>EventLoopGroup</code> æ˜¯ä¸€ç»„ <code>EventLoop</code>ï¼ŒChannel ä¸€èˆ¬ä¼šè°ƒç”¨ <code>EventLoopGroup</code> çš„ <code>register</code> æ–¹æ³•æ¥<code>ç»‘å®š</code>å…¶ä¸­ä¸€ä¸ª <code>EventLoop</code>ï¼Œåç»­è¿™ä¸ª Channel ä¸Šçš„ <code>IO äº‹ä»¶</code>éƒ½ç”±æ­¤ <code>EventLoop</code> æ¥å¤„ç†ï¼ˆä¿è¯äº† IO äº‹ä»¶å¤„ç†æ—¶çš„çº¿ç¨‹å®‰å…¨ï¼‰ã€‚</p><h3 id="4-2-1-ä»»åŠ¡è°ƒåº¦"><a href="#4-2-1-ä»»åŠ¡è°ƒåº¦" class="headerlink" title="4.2.1 ä»»åŠ¡è°ƒåº¦"></a>4.2.1 ä»»åŠ¡è°ƒåº¦</h3><p>å¶å°”ï¼Œä½ å°†éœ€è¦è°ƒåº¦ä¸€ä¸ªä»»åŠ¡ä»¥ä¾¿ç¨å(å»¶è¿Ÿ)æ‰§è¡Œæˆ–è€…å‘¨æœŸæ€§åœ°æ‰§è¡Œã€‚ä¾‹å¦‚ï¼Œä½ å¯èƒ½æƒ³è¦æ³¨å†Œä¸€ä¸ªåœ¨å®¢æˆ·ç«¯å·²ç»è¿æ¥äº† 5 åˆ†é’Ÿä¹‹åè§¦å‘çš„ä»»åŠ¡ã€‚ä¸€ä¸ªå¸¸è§çš„ç”¨ä¾‹æ˜¯ï¼Œå‘é€<code>å¿ƒè·³æ¶ˆæ¯</code>åˆ°è¿œç¨‹èŠ‚ç‚¹ï¼Œä»¥æ£€æŸ¥è¿æ¥æ˜¯å¦ä»ç„¶è¿˜æ´»ç€ã€‚å¦‚æœæ²¡æœ‰å“åº”ï¼Œä½ ä¾¿çŸ¥é“å¯ä»¥å…³é—­è¯¥ <code>Channel</code> äº†ã€‚</p><h3 id="4-2-2-çº¿ç¨‹ç®¡ç†"><a href="#4-2-2-çº¿ç¨‹ç®¡ç†" class="headerlink" title="4.2.2 çº¿ç¨‹ç®¡ç†"></a>4.2.2 çº¿ç¨‹ç®¡ç†</h3><p>åœ¨å†…éƒ¨ï¼Œå½“æäº¤ä»»åŠ¡åˆ°å¦‚æœ(å½“å‰)è°ƒç”¨çº¿ç¨‹æ­£æ˜¯æ”¯æ’‘ EventLoop çš„çº¿ç¨‹ï¼Œé‚£ä¹ˆæ‰€æäº¤çš„ä»£ç å—å°†ä¼šè¢«(ç›´æ¥)æ‰§è¡Œã€‚å¦åˆ™ï¼ŒEventLoop å°†è°ƒåº¦è¯¥ä»»åŠ¡ä»¥ä¾¿ç¨åæ‰§è¡Œï¼Œå¹¶å°†å®ƒæ”¾å…¥ åˆ°å†…éƒ¨é˜Ÿåˆ—ä¸­ã€‚å½“ EventLoop ä¸‹æ¬¡å¤„ç†å®ƒçš„äº‹ä»¶æ—¶ï¼Œå®ƒä¼šæ‰§è¡Œé˜Ÿåˆ—ä¸­çš„é‚£äº›ä»»åŠ¡&#x2F;äº‹ä»¶ã€‚<br><img src="https://cdn.jsdelivr.net/gh/zyxelva/picgo@main/markdown/EventLoop%20Execution%20Logic.png" alt="EventLoopçš„æ‰§è¡Œé€»è¾‘"></p><h3 id="4-2-3-çº¿ç¨‹åˆ†é…"><a href="#4-2-3-çº¿ç¨‹åˆ†é…" class="headerlink" title="4.2.3 çº¿ç¨‹åˆ†é…"></a>4.2.3 çº¿ç¨‹åˆ†é…</h3><p>æœåŠ¡äº Channel çš„ <code>I/O</code> å’Œäº‹ä»¶çš„ <code>EventLoop</code> åŒ…å«åœ¨ <code>EventLoopGroup</code> ä¸­ã€‚æ ¹æ®ä¸åŒçš„ä¼ è¾“å®ç°ï¼Œ<code>EventLoop</code> çš„åˆ›å»ºå’Œåˆ†é…æ–¹å¼ä¹Ÿä¸åŒã€‚</p><ul><li>å¼‚æ­¥ä¼ è¾“</li></ul><p>å¼‚æ­¥ä¼ è¾“å®ç°åªä½¿ç”¨äº†<code>å°‘é‡çš„ EventLoop</code>(ä»¥åŠå’Œå®ƒä»¬ç›¸å…³è”çš„ <code>Thread</code>)ï¼Œè€Œä¸”åœ¨å½“å‰çš„çº¿ç¨‹æ¨¡å‹ä¸­ï¼Œå®ƒä»¬å¯èƒ½ä¼šè¢«å¤šä¸ª <code>Channel</code> æ‰€å…±äº«ã€‚è¿™ä½¿å¾—å¯ä»¥é€šè¿‡å°½å¯èƒ½å°‘é‡çš„ <code>Thread</code> æ¥æ”¯æ’‘å¤§é‡çš„ <code>Channel</code>ï¼Œè€Œä¸æ˜¯æ¯ä¸ª <code>Channel</code> åˆ†é…ä¸€ä¸ª <code>Thread</code>ã€‚<br>ä¸‹å›¾ä¸­æ˜¾ç¤ºäº†ä¸€ä¸ª <code>EventLoopGroup</code>ï¼Œå®ƒå…·æœ‰ 3 ä¸ª<code>å›ºå®šå¤§å°</code>çš„ <code>EventLoop</code>(æ¯ä¸ª EventLoop éƒ½ç”±ä¸€ä¸ª Thread æ”¯æ’‘)ã€‚åœ¨åˆ›å»º <code>EventLoopGroup</code> æ—¶å°±ç›´æ¥åˆ†é…äº† <code>EventLoop</code>(ä»¥åŠæ”¯æ’‘å®ƒä»¬çš„ <code>Thread</code>)ï¼Œä»¥ç¡®ä¿åœ¨éœ€è¦æ—¶å®ƒä»¬æ˜¯å¯ç”¨çš„ã€‚</p><p><img src="https://cdn.jsdelivr.net/gh/zyxelva/picgo@main/markdown/NIO%20Dispatch%20Model.png" alt="ç”¨äºéé˜»å¡ä¼ è¾“(å¦‚ NIO å’Œ AIO)çš„ EventLoop åˆ†é…æ–¹å¼"></p><ul><li>é˜»å¡ä¼ è¾“</li></ul><p>ç”¨äºåƒ <code>OIO</code>(æ—§çš„é˜»å¡ I&#x2F;O)è¿™æ ·çš„å…¶ä»–ä¼ è¾“çš„è®¾è®¡ç•¥æœ‰ä¸åŒï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚è¿™é‡Œæ¯ä¸€ä¸ª <code>Channel</code> éƒ½å°†è¢«åˆ†é…ç»™<code>ä¸€ä¸ª EventLoop</code>(ä»¥åŠå®ƒçš„ Thread)ã€‚å¦‚æœä½ å¼€å‘çš„åº”ç”¨ç¨‹åºä½¿ç”¨è¿‡ <code>java.io</code> åŒ…ä¸­çš„<code>é˜»å¡ I/O</code> å®ç°ï¼Œä½ å¯èƒ½å°±é‡åˆ°è¿‡è¿™ç§æ¨¡å‹ã€‚<br><img src="https://cdn.jsdelivr.net/gh/zyxelva/picgo@main/markdown/OIO%20Dispatch%20Model.png" alt="é˜»å¡ä¼ è¾“(å¦‚ OIO)çš„ EventLoop åˆ†é…æ–¹å¼"></p><p>ä½†æ˜¯ï¼Œæ­£å¦‚åŒä¹‹å‰ä¸€æ ·ï¼Œå¾—åˆ°çš„ä¿è¯æ˜¯æ¯ä¸ª <code>Channel</code> çš„ <code>I/O äº‹ä»¶</code>éƒ½å°†åªä¼šè¢«<code>ä¸€ä¸ª Thread</code> (ç”¨äºæ”¯æ’‘è¯¥ Channel çš„ EventLoop çš„é‚£ä¸ª Thread)å¤„ç†ã€‚è¿™ä¹Ÿæ˜¯å¦ä¸€ä¸ª Netty <code>è®¾è®¡ä¸€è‡´æ€§</code>çš„ä¾‹å­ï¼Œå®ƒ(è¿™ç§è®¾è®¡ä¸Šçš„ä¸€è‡´æ€§)å¯¹ Netty çš„<code>å¯é æ€§</code>å’Œ<code>æ˜“ç”¨æ€§</code>åšå‡ºäº†å·¨å¤§è´¡çŒ®ã€‚</p><h2 id="4-3-ChannelFuture"><a href="#4-3-ChannelFuture" class="headerlink" title="4.3 ChannelFuture"></a>4.3 ChannelFuture</h2><blockquote><p>Netty ä¸­æ‰€æœ‰çš„ I&#x2F;O æ“ä½œéƒ½æ˜¯<code>å¼‚æ­¥çš„</code>ã€‚</p></blockquote><p>JDK é¢„ç½®äº† <code>interface java.util.concurrent.Future</code>ï¼Œ<code>Future</code> æä¾›äº†ä¸€ç§åœ¨æ“ä½œå®Œæˆæ—¶<code>é€šçŸ¥</code>åº”ç”¨ç¨‹åºçš„æ–¹å¼ã€‚è¿™ä¸ªå¯¹è±¡å¯ä»¥çœ‹ä½œæ˜¯ä¸€ä¸ª<code>å¼‚æ­¥æ“ä½œ</code>çš„ç»“æœçš„<code>å ä½ç¬¦</code>;</p><ul><li>å®ƒå°†åœ¨æœªæ¥çš„æŸä¸ªæ—¶åˆ»å®Œæˆï¼Œå¹¶æä¾›å¯¹å…¶ç»“æœçš„è®¿é—®ã€‚ä½†æ˜¯å…¶æ‰€æä¾›çš„å®ç°ï¼Œåªå…è®¸æ‰‹åŠ¨æ£€æŸ¥å¯¹åº”çš„æ“ä½œæ˜¯å¦å·²ç»å®Œæˆï¼Œæˆ–è€…ä¸€ç›´é˜»å¡ç›´åˆ°å®ƒå®Œæˆã€‚è¿™æ˜¯éå¸¸ç¹ççš„ï¼Œæ‰€ä»¥ Netty æä¾›äº†å®ƒè‡ªå·±çš„å®ç°â€”â€” <code>ChannelFuture</code>ï¼Œç”¨äºåœ¨æ‰§è¡Œ<code>å¼‚æ­¥æ“ä½œ</code>çš„æ—¶å€™ä½¿ç”¨ã€‚</li><li>æ¯ä¸ª Netty çš„<code>å‡ºç«™</code> I&#x2F;O æ“ä½œéƒ½å°†è¿”å›ä¸€ä¸ª <code>ChannelFuture</code>ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå®ƒä»¬éƒ½ä¸ä¼šé˜»å¡ã€‚ æ­£å¦‚æˆ‘ä»¬å‰é¢æ‰€æåˆ°è¿‡çš„ä¸€æ ·ï¼ŒNetty å®Œå…¨æ˜¯<code>å¼‚æ­¥</code>å’Œ<code>äº‹ä»¶é©±åŠ¨</code>çš„ã€‚</li></ul><h2 id="4-4-ChannelHandler"><a href="#4-4-ChannelHandler" class="headerlink" title="4.4 ChannelHandler"></a>4.4 ChannelHandler</h2><p>ä»åº”ç”¨ç¨‹åºå¼€å‘äººå‘˜çš„è§’åº¦æ¥çœ‹ï¼ŒNetty çš„ä¸»è¦ç»„ä»¶æ˜¯ <code>ChannelHandler</code>ï¼Œå®ƒå……å½“äº†æ‰€æœ‰å¤„ç†<code>å…¥ç«™</code>å’Œ<code>å‡ºç«™</code>æ•°æ®çš„åº”ç”¨ç¨‹åºé€»è¾‘çš„<code>å®¹å™¨</code>ã€‚</p><p><code>ChannelHandler</code> çš„æ–¹æ³•æ˜¯ç”±<code>ç½‘ç»œäº‹ä»¶</code>è§¦å‘çš„ã€‚ äº‹å®ä¸Šï¼Œ<code>ChannelHandler</code> å¯ä¸“é—¨ç”¨äºå‡ ä¹ä»»ä½•ç±»å‹çš„åŠ¨ä½œï¼Œä¾‹å¦‚å°†æ•°æ®ä»ä¸€ç§æ ¼å¼è½¬æ¢ä¸ºå¦å¤–ä¸€ç§æ ¼å¼ï¼Œä¾‹å¦‚å„ç§ç¼–è§£ç ï¼Œæˆ–è€…å¤„ç†è½¬æ¢è¿‡ç¨‹ä¸­æ‰€æŠ›å‡ºçš„å¼‚å¸¸ã€‚</p><ul><li>ChannelHandler çš„ç”Ÿå‘½å‘¨æœŸï¼šåœ¨<code>ChannelHandler</code>è¢«<code>æ·»åŠ </code>åˆ°<code>ChannelPipeline</code> ä¸­æˆ–è€…è¢«ä»<code>ChannelPipeline</code> ä¸­<code>ç§»é™¤</code>æ—¶ä¼šè°ƒç”¨ä¸‹é¢è¿™äº›æ–¹æ³•ã€‚è¿™äº›æ–¹æ³•ä¸­çš„æ¯ä¸€ä¸ªéƒ½æ¥å—ä¸€ä¸ª <code>ChannelHandlerContext</code> å‚æ•°ã€‚ <ul><li><code>handlerAdded</code>ï¼šå½“æŠŠ <code>ChannelHandler</code> <code>æ·»åŠ </code>åˆ° <code>ChannelPipeline</code> ä¸­æ—¶è¢«è°ƒç”¨ï¼›</li><li><code>handlerRemoved</code>ï¼šå½“ä» <code>ChannelPipeline</code> ä¸­<code>ç§»é™¤</code> <code>ChannelHandler</code> æ—¶è¢«è°ƒç”¨ï¼›</li><li><code>exceptionCaught</code>ï¼šå½“å¤„ç†è¿‡ç¨‹ä¸­åœ¨ <code>ChannelPipeline</code> ä¸­<code>æœ‰é”™è¯¯äº§ç”Ÿ</code>æ—¶è¢«è°ƒç”¨ã€‚</li></ul></li></ul><p>Netty å®šä¹‰äº†ä¸‹é¢ä¸¤ä¸ªé‡è¦çš„ <code>ChannelHandler</code> å­æ¥å£: </p><ul><li><code>ChannelInboundHandler</code>: å¤„ç†<code>å…¥ç«™</code>æ•°æ®ä»¥åŠå„ç§<code>çŠ¶æ€</code>å˜åŒ–; </li><li><code>ChannelOutboundHandler</code>: å¤„ç†<code>å‡ºç«™</code>æ•°æ®å¹¶ä¸”å…è®¸<code>æ‹¦æˆª</code>æ‰€æœ‰çš„æ“ä½œã€‚</li></ul><p>å¦å¤–ï¼Œ3 ä¸ª <code>ChannelHandler</code> çš„å­ç±»å‹ï¼š<code>ç¼–ç å™¨</code>ã€<code>è§£ç å™¨</code>å’Œ <code>SimpleChannelInboundHandler&lt;T&gt;</code> â€”â€” <code>ChannelInboundHandlerAdapter</code> çš„ä¸€ä¸ª<code>å­ç±»</code>ã€‚</p><h3 id="4-4-1-ChannelInboundHandler-æ¥å£"><a href="#4-4-1-ChannelInboundHandler-æ¥å£" class="headerlink" title="4.4.1 ChannelInboundHandler æ¥å£"></a>4.4.1 ChannelInboundHandler æ¥å£</h3><p>ä¸‹é¢åˆ—å‡ºäº†æ¥å£ <code>ChannelInboundHandler</code> çš„ç”Ÿå‘½å‘¨æœŸæ–¹æ³•ã€‚è¿™äº›æ–¹æ³•å°†ä¼šåœ¨æ•°æ®<code>è¢«æ¥æ”¶</code>æ—¶æˆ–è€…ä¸å…¶å¯¹åº”çš„ Channel <code>çŠ¶æ€å‘ç”Ÿæ”¹å˜</code>æ—¶è¢«è°ƒç”¨ã€‚æ­£å¦‚æˆ‘ä»¬å‰é¢æ‰€æåˆ°çš„ï¼Œè¿™äº›æ–¹æ³•å’Œ Channel çš„ç”Ÿå‘½å‘¨æœŸ<code>å¯†åˆ‡ç›¸å…³</code>ã€‚</p><ul><li><code>channelRegistered</code>ï¼šå½“ <code>Channel</code> å·²ç»<code>æ³¨å†Œ</code>åˆ°å®ƒçš„ <code>EventLoop</code> å¹¶ä¸”èƒ½å¤Ÿå¤„ç† <code>I/O</code> æ—¶è¢«è°ƒç”¨ï¼›</li><li><code>channelUnregistered</code>ï¼šå½“ <code>Channel</code> ä»å®ƒçš„ <code>EventLoop</code> <code>æ³¨é”€</code>å¹¶ä¸”æ— æ³•å¤„ç†ä»»ä½• <code>I/O</code> æ—¶è¢«è°ƒç”¨ï¼›</li><li><code>channelActive</code>ï¼šå½“ <code>Channel</code> å¤„äº<code>æ´»åŠ¨çŠ¶æ€</code>æ—¶è¢«è°ƒç”¨ï¼›<code>Channel</code> å·²ç»<code>è¿æ¥/ç»‘å®š</code>å¹¶ä¸”å·²ç»<code>å°±ç»ª</code>ï¼›</li><li><code>channelInactive</code>ï¼šå½“ <code>Channel</code> <code>ç¦»å¼€æ´»åŠ¨çŠ¶æ€</code>å¹¶ä¸”<code>ä¸å†è¿æ¥</code>å®ƒçš„è¿œç¨‹èŠ‚ç‚¹æ—¶è¢«è°ƒç”¨ï¼›ã€</li><li><code>channelReadComplete</code>ï¼šå½“ <code>Channel</code> ä¸Šçš„ä¸€ä¸ª<code>è¯»æ“ä½œ``å®Œæˆ</code>æ—¶è¢«è°ƒç”¨ï¼›</li><li><code>channelRead</code>ï¼šå½“ä» <code>Channel</code> <code>è¯»å–æ•°æ®</code>æ—¶è¢«è°ƒç”¨ï¼›</li><li><code>ChannelWritabilityChanged</code>ï¼šå½“ <code>Channel</code> çš„<code>å¯å†™çŠ¶æ€</code>å‘ç”Ÿæ”¹å˜æ—¶è¢«è°ƒç”¨ã€‚å¯ä»¥é€šè¿‡è°ƒç”¨ <code>Channel</code> çš„ <code>isWritable()</code>æ–¹æ³•æ¥æ£€æµ‹ <code>Channel</code> çš„<code>å¯å†™æ€§</code>ã€‚ä¸å¯å†™æ€§ç›¸å…³çš„é˜ˆå€¼å¯ä»¥é€šè¿‡ <code>Channel.config().setWriteHighWaterMark()</code>å’Œ <code>Channel.config().setWriteLowWaterMark()</code>æ–¹æ³•æ¥è®¾ç½®ï¼›</li><li><code>userEventTriggered</code>ï¼šå½“ <code>ChannelInboundHandler.fireUserEventTriggered()</code>æ–¹æ³•è¢«è°ƒç”¨æ—¶è¢«è°ƒç”¨ã€‚</li></ul><h3 id="4-4-2-ChannelOutboundHandler-æ¥å£"><a href="#4-4-2-ChannelOutboundHandler-æ¥å£" class="headerlink" title="4.4.2 ChannelOutboundHandler æ¥å£"></a>4.4.2 ChannelOutboundHandler æ¥å£</h3><p><code>å‡ºç«™æ“ä½œ</code>å’Œæ•°æ®å°†ç”± <code>ChannelOutboundHandler</code> å¤„ç†ã€‚å®ƒçš„æ–¹æ³•å°†è¢« <code>Channel</code>ã€<code>ChannelPipeline</code> ä»¥åŠ <code>ChannelHandlerContext</code> è°ƒç”¨ã€‚</p><p>æ‰€æœ‰ç”± ChannelOutboundHandler æœ¬èº«æ‰€å®šä¹‰çš„æ–¹æ³•: </p><ul><li><code>bind(ChannelHandlerContext,SocketAddress,ChannelPromise)</code>ï¼šå½“è¯·æ±‚å°† <code>Channel</code> <code>ç»‘å®š</code>åˆ°æœ¬åœ°åœ°å€æ—¶è¢«è°ƒç”¨ï¼›</li><li><code>connect(ChannelHandlerContext,SocketAddress,SocketAddress,ChannelPromise)</code>ï¼šå½“è¯·æ±‚å°† <code>Channel</code> <code>è¿æ¥</code>åˆ°è¿œç¨‹èŠ‚ç‚¹æ—¶è¢«è°ƒç”¨ï¼›</li><li><code>disconnect(ChannelHandlerContext,ChannelPromise)</code>ï¼šå½“è¯·æ±‚å°† <code>Channel</code> ä»è¿œç¨‹èŠ‚ç‚¹<code>æ–­å¼€</code>æ—¶è¢«è°ƒç”¨</li><li><code>close(ChannelHandlerContext,ChannelPromise)</code> å½“è¯·æ±‚<code>å…³é—­ Channel</code> æ—¶è¢«è°ƒç”¨ï¼›</li><li><code>deregister(ChannelHandlerContext,ChannelPromise)</code>ï¼šå½“è¯·æ±‚å°† <code>Channel</code> ä»å®ƒçš„ <code>EventLoop</code> <code>æ³¨é”€</code>æ—¶è¢«è°ƒç”¨ï¼›</li><li><code>read(ChannelHandlerContext)</code>ï¼šå½“è¯·æ±‚ä» <code>Channel</code> <code>è¯»å–</code>æ›´å¤šçš„æ•°æ®æ—¶è¢«è°ƒç”¨ï¼›</li><li><code>flush(ChannelHandlerContext)</code>ï¼šå½“è¯·æ±‚é€šè¿‡ <code>Channel</code> å°†<code>å…¥é˜Ÿæ•°æ®``å†²åˆ·</code>åˆ°<code>è¿œç¨‹èŠ‚ç‚¹</code>æ—¶è¢«è°ƒç”¨ï¼›</li><li><code>write(ChannelHandlerContext,Object,ChannelPromise)</code>ï¼šå½“è¯·æ±‚é€šè¿‡ <code>Channel</code> å°†æ•°æ®<code>å†™</code>åˆ°è¿œç¨‹èŠ‚ç‚¹æ—¶è¢«è°ƒç”¨ï¼›</li></ul><h3 id="4-4-3-ChannelInboundHandlerAdapter"><a href="#4-4-3-ChannelInboundHandlerAdapter" class="headerlink" title="4.4.3 ChannelInboundHandlerAdapter"></a>4.4.3 ChannelInboundHandlerAdapter</h3><p>æœ‰ä¸€äº›é€‚é…å™¨ç±»å¯ä»¥å°†ç¼–å†™è‡ªå®šä¹‰çš„ <code>ChannelHandler</code> æ‰€éœ€è¦çš„å·¥ä½œé™åˆ°<code>æœ€ä½é™åº¦</code>ï¼Œå› ä¸ºå®ƒä»¬æä¾›äº†å®šä¹‰åœ¨å¯¹åº”æ¥å£ä¸­çš„æ‰€æœ‰æ–¹æ³•çš„<code>é»˜è®¤å®ç°</code>ã€‚å› ä¸ºä½ æœ‰æ—¶ä¼šå¿½ç•¥é‚£äº›ä¸æ„Ÿå…´è¶£çš„äº‹ä»¶ï¼Œæ‰€ä»¥ Netty æä¾›äº†æŠ½è±¡åŸºç±» <code>ChannelInboundHandlerAdapter</code> å’Œ <code>ChannelOutboundHandlerAdapter</code>ã€‚</p><blockquote><p>ä¸‹é¢è¿™äº›æ˜¯ç¼–å†™è‡ªå®šä¹‰ ChannelHandler æ—¶ç»å¸¸ä¼šç”¨åˆ°çš„é€‚é…å™¨ç±»:</p><ul><li>ChannelHandlerAdapter</li><li>ChannelInboundHandlerAdapter</li><li>ChannelOutboundHandlerAdapter</li><li>ChannelDuplexHandler</li></ul></blockquote><h3 id="4-4-4-ç¼–ç å™¨å’Œè§£ç å™¨"><a href="#4-4-4-ç¼–ç å™¨å’Œè§£ç å™¨" class="headerlink" title="4.4.4 ç¼–ç å™¨å’Œè§£ç å™¨"></a>4.4.4 ç¼–ç å™¨å’Œè§£ç å™¨</h3><p>ç½‘ç»œæ•°æ®æ€»æ˜¯ä¸€äº›å­—èŠ‚ï¼Œéœ€è¦é€šè¿‡è§£ç è§£æç»™ç³»ç»Ÿï¼Œè®©å…¶èƒ½å¤Ÿè®¤è¯†ï¼›åŒæ ·ä»ç³»ç»Ÿå†™å‡ºå»çš„æ•°æ®ï¼Œå…·æœ‰æ™®éè®¤å¯åº¦çš„ä¸€èˆ¬æ˜¯äºŒè¿›åˆ¶ï¼Œæ‰€ä»¥éœ€è¦è¿›è¡Œç¼–ç ï¼›</p><p>å¯¹åº”äºç‰¹å®šçš„éœ€è¦ï¼ŒNetty ä¸º<code>ç¼–ç å™¨</code>å’Œ<code>è§£ç å™¨</code>æä¾›äº†ä¸åŒç±»å‹çš„<code>æŠ½è±¡ç±»</code>ã€‚é€šå¸¸æ¥è¯´ï¼Œè¿™äº›åŸºç±»çš„åç§°å°†ç±»ä¼¼äº <code>ByteToMessageDecoder</code> æˆ– <code>MessageToByteEncoder</code>ã€‚å¯¹äºç‰¹æ®Šçš„ç±»å‹ï¼Œä½ å¯èƒ½ä¼šå‘ç°ç±»ä¼¼äº <code>ProtobufEncoder</code> å’Œ <code>ProtobufDecoder</code> è¿™æ ·çš„åç§°â€”â€”é¢„ç½®çš„ç”¨æ¥æ”¯æŒ Google çš„ <code>Protocol Buffers</code>ã€‚</p><p>æ‰€æœ‰ç”± Netty æä¾›çš„<code>ç¼–ç å™¨/è§£ç å™¨é€‚é…å™¨ç±»</code>éƒ½å®ç° äº† <code>ChannelOutboundHandler</code> æˆ–è€… <code>ChannelInboundHandler</code> æ¥å£ã€‚</p><h3 id="4-4-5-æŠ½è±¡ç±»-SimpleChannelInboundHandler"><a href="#4-4-5-æŠ½è±¡ç±»-SimpleChannelInboundHandler" class="headerlink" title="4.4.5 æŠ½è±¡ç±» SimpleChannelInboundHandler"></a>4.4.5 æŠ½è±¡ç±» SimpleChannelInboundHandler</h3><p>æœ€å¸¸è§çš„æƒ…å†µæ˜¯ï¼Œä½ çš„åº”ç”¨ç¨‹åºä¼šåˆ©ç”¨ä¸€ä¸ª <code>ChannelHandler</code> æ¥æ¥æ”¶è§£ç æ¶ˆæ¯ï¼Œå¹¶å¯¹è¯¥æ•°æ®åº”ç”¨ä¸šåŠ¡é€»è¾‘ã€‚è¦åˆ›å»ºä¸€ä¸ªè¿™æ ·çš„ ChannelHandlerï¼Œä½ åªéœ€è¦æ‰©å±•åŸºç±» <code>SimpleChannelInboundHandler&lt;T&gt;</code>ï¼Œå…¶ä¸­ <code>T</code> æ˜¯ä½ è¦å¤„ç†çš„æ¶ˆæ¯çš„ <code>Java ç±»å‹</code> ã€‚åœ¨è¿™ä¸ª ChannelHandler ä¸­ï¼Œ ä½ å°†éœ€è¦<code>é‡å†™</code>åŸºç±»çš„ä¸€ä¸ªæˆ–è€…å¤šä¸ªæ–¹æ³•ï¼Œå¹¶ä¸”è·å–ä¸€ä¸ªåˆ° <code>ChannelHandlerContext</code> çš„<code>å¼•ç”¨</code>ï¼Œ è¿™ä¸ªå¼•ç”¨å°†ä½œä¸ºè¾“å…¥å‚æ•°ä¼ é€’ç»™ ChannelHandler çš„æ‰€æœ‰æ–¹æ³•ã€‚</p><p>åœ¨è¿™ç§ç±»å‹çš„ <code>ChannelHandler</code> ä¸­ï¼Œæœ€é‡è¦çš„æ–¹æ³•æ˜¯ <code>channelRead0(ChannelHandlerContext, T)</code>ã€‚é™¤äº†è¦æ±‚<code>ä¸è¦é˜»å¡</code>å½“å‰çš„ <code>I/O çº¿ç¨‹</code>ä¹‹å¤–ï¼Œå…¶å…·ä½“å®ç°å®Œå…¨å–å†³äºä½ ã€‚åç»­å†è®²ç¼–è§£ç å™¨æ—¶ï¼Œæˆ‘å°†å¯¹è¿™ä¸€ä¸»é¢˜è¿›è¡Œæ›´å¤šçš„è¯´æ˜ã€‚</p><h2 id="4-5-ChannelPipeline"><a href="#4-5-ChannelPipeline" class="headerlink" title="4.5 ChannelPipeline"></a>4.5 ChannelPipeline</h2><p>å½“ <code>Channel</code> è¢«<code>åˆ›å»º</code>æ—¶ï¼Œå®ƒå°†ä¼šè¢«<code>è‡ªåŠ¨åœ°åˆ†é…</code>ä¸€ä¸ªæ–°çš„ <code>ChannelPipeline</code>ã€‚è¿™é¡¹å…³è”æ˜¯<code>æ°¸ä¹…æ€§çš„</code>ã€‚</p><p><code>Channel</code> æ—¢<code>ä¸èƒ½é™„åŠ </code>å¦å¤–ä¸€ä¸ª <code>ChannelPipeline</code>ï¼Œä¹Ÿ<code>ä¸èƒ½åˆ†ç¦»</code>å…¶å½“å‰çš„ã€‚åœ¨ Netty ç»„ä»¶çš„ç”Ÿå‘½å‘¨æœŸä¸­ï¼Œè¿™æ˜¯ä¸€é¡¹<code>å›ºå®šçš„</code>æ“ä½œï¼Œä¸éœ€è¦å¼€å‘äººå‘˜çš„ä»»ä½•å¹²é¢„ã€‚</p><p>ä½¿å¾—äº‹ä»¶æµç» <code>ChannelPipeline</code> æ˜¯ <code>ChannelHandler</code> çš„å·¥ä½œï¼Œå®ƒä»¬æ˜¯åœ¨åº”ç”¨ç¨‹åºçš„<code>åˆå§‹åŒ–</code>æˆ–è€…<code>å¼•å¯¼é˜¶æ®µ</code>è¢«å®‰è£…çš„ã€‚è¿™äº›å¯¹è±¡æ¥æ”¶äº‹ä»¶ã€æ‰§è¡Œå®ƒä»¬æ‰€å®ç°çš„å¤„ç†é€»è¾‘ï¼Œå¹¶å°†æ•°æ®ä¼ é€’ç»™é“¾ä¸­çš„ä¸‹ä¸€ä¸ª <code>ChannelHandler</code>ã€‚å®ƒä»¬çš„æ‰§è¡Œé¡ºåºæ˜¯ç”±å®ƒä»¬<code>è¢«æ·»åŠ çš„é¡ºåº</code>æ‰€å†³å®šçš„ã€‚</p><h3 id="4-5-1-ChannelPipeline-ä¸­-ChannelHandler"><a href="#4-5-1-ChannelPipeline-ä¸­-ChannelHandler" class="headerlink" title="4.5.1 ChannelPipeline ä¸­ ChannelHandler"></a>4.5.1 ChannelPipeline ä¸­ ChannelHandler</h3><p><code>å…¥ç«™</code>å’Œ<code>å‡ºç«™</code> <code>ChannelHandler</code> å¯ä»¥è¢«å®‰è£…åˆ°åŒä¸€ä¸ª <code>ChannelPipeline</code> ä¸­ã€‚å¦‚æœä¸€ä¸ªæ¶ˆæ¯æˆ–è€…ä»»ä½•å…¶ä»–çš„å…¥ç«™äº‹ä»¶è¢«è¯»å–ï¼Œé‚£ä¹ˆå®ƒä¼šä» ChannelPipeline çš„<code>å¤´éƒ¨</code>å¼€å§‹æµåŠ¨ï¼Œæœ€ç»ˆï¼Œæ•°æ®å°†ä¼šåˆ°è¾¾ <code>ChannelPipeline</code> çš„<code>å°¾ç«¯</code>ï¼Œå±Šæ—¶ï¼Œæ‰€æœ‰å¤„ç†å°±éƒ½ç»“æŸäº†ã€‚</p><p>æ•°æ®çš„<code>å‡ºç«™è¿åŠ¨</code>(å³æ­£åœ¨è¢«å†™çš„æ•°æ®)åœ¨æ¦‚å¿µä¸Šä¹Ÿæ˜¯ä¸€æ ·çš„ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæ•°æ®å°†ä» <code>ChannelOutboundHandler</code> é“¾çš„<code>å°¾ç«¯</code>å¼€å§‹æµåŠ¨ï¼Œç›´åˆ°å®ƒåˆ°è¾¾é“¾çš„<code>å¤´éƒ¨</code>ä¸ºæ­¢ã€‚åœ¨è¿™ä¹‹åï¼Œå‡ºç«™æ•°æ®å°†ä¼šåˆ°è¾¾<code>ç½‘ç»œä¼ è¾“å±‚</code>ï¼Œè¿™é‡Œæ˜¾ç¤ºä¸º Socketã€‚é€šå¸¸æƒ…å†µä¸‹ï¼Œè¿™å°†è§¦å‘ä¸€ä¸ª<code>å†™æ“ä½œ</code>ã€‚</p><p>å¦‚æœå°†ä¸¤ä¸ªç±»åˆ«çš„<code>ChannelHandler</code>éƒ½æ··åˆæ·»åŠ åˆ°åŒä¸€ä¸ª<code>ChannelPipeline</code> ä¸­ä¼šå‘ç”Ÿä»€ä¹ˆã€‚ è™½ç„¶ <code>ChannelInboundHandle</code> å’Œ <code>ChannelOutboundHandle</code> éƒ½æ‰©å±•è‡ª <code>ChannelHandler</code>ï¼Œä½†æ˜¯ Netty èƒ½åŒºåˆ† <code>ChannelInboundHandler</code> å®ç°å’Œ <code>ChannelOutboundHandler</code> å®ç°ï¼Œå¹¶ç¡®ä¿æ•°æ®åªä¼šåœ¨å…·æœ‰<code>ç›¸åŒå®šå‘ç±»å‹</code>çš„ä¸¤ä¸ª <code>ChannelHandler</code> ä¹‹é—´ä¼ é€’ã€‚</p><p><img src="https://cdn.jsdelivr.net/gh/zyxelva/picgo@main/markdown/ChannelPipeline.png" alt="åŒ…å«å…¥ç«™å‡ºç«™çš„pipeline"></p><h2 id="4-6-ChannelHandlerContext"><a href="#4-6-ChannelHandlerContext" class="headerlink" title="4.6 ChannelHandlerContext"></a>4.6 ChannelHandlerContext</h2><p>é€šè¿‡ä½¿ç”¨ä½œä¸ºå‚æ•°ä¼ é€’åˆ°æ¯ä¸ªæ–¹æ³•çš„ <code>ChannelHandlerContext</code>ï¼Œäº‹ä»¶å¯ä»¥è¢«ä¼ é€’ç»™å½“å‰ <code>ChannelHandler</code> é“¾ä¸­çš„<code>ä¸‹ä¸€ä¸ª ChannelHandler</code>ã€‚è™½ç„¶è¿™ä¸ªå¯¹è±¡å¯ä»¥è¢«ç”¨äºè·å–åº•å±‚çš„ Channelï¼Œä½†æ˜¯å®ƒä¸»è¦è¿˜æ˜¯è¢«ç”¨äº<code>å†™å‡ºç«™æ•°æ®</code>ã€‚</p><p><code>ChannelHandlerContext</code> ä»£è¡¨äº†<code>ChannelHandler</code> å’Œ <code>ChannelPipeline</code> ä¹‹é—´çš„å…³è”ï¼Œæ¯å½“æœ‰ <code>ChannelHandler</code> <code>æ·»åŠ </code>åˆ° <code>ChannelPipeline</code> ä¸­æ—¶ï¼Œéƒ½ä¼šåˆ›å»º <code>ChannelHandlerContext</code>ã€‚</p><p><code>ChannelHandlerContext</code> çš„ä¸»è¦åŠŸèƒ½æ˜¯ç®¡ç†å®ƒæ‰€å…³è”çš„ <code>ChannelHandler</code> å’Œåœ¨åŒä¸€ä¸ª <code>ChannelPipeline</code> ä¸­çš„å…¶ä»– <code>ChannelHandler</code> ä¹‹é—´çš„äº¤äº’ã€‚</p><p><img src="https://cdn.jsdelivr.net/gh/zyxelva/picgo@main/markdown/ChannelHandler-in-ChannelHandlerContext.png" alt="ChannelHandlerä¸ChannelHandlerContext"></p><p><code>ChannelHandlerContext</code> æœ‰å¾ˆå¤šçš„æ–¹æ³•ï¼Œå…¶ä¸­ä¸€äº›æ–¹æ³•ä¹Ÿå­˜åœ¨äº <code>Channel</code> å’Œ <code>ChannelPipeline</code> æœ¬èº«ä¸Šï¼Œä½†æ˜¯æœ‰ä¸€ç‚¹é‡è¦ä¸åŒã€‚å¦‚æœè°ƒç”¨<code>Channel</code> æˆ–è€…<code>ChannelPipeline</code> ä¸Šçš„è¿™äº›æ–¹æ³•ï¼Œå®ƒä»¬å°†æ²¿ç€<code>æ•´ä¸ª ChannelPipeline</code>è¿›è¡Œä¼ æ’­ã€‚è€Œè°ƒç”¨ä½äº <code>ChannelHandlerContext</code>ä¸Šçš„ç›¸åŒæ–¹æ³•ï¼Œåˆ™å°†ä»<code>å½“å‰æ‰€å…³è”çš„ ChannelHandler</code> å¼€å§‹ï¼Œå¹¶ä¸”<code>åªä¼š</code>ä¼ æ’­ç»™ä½äºè¯¥ <code>ChannelPipeline</code> ä¸­çš„<code>ä¸‹ä¸€ä¸ª</code>(å…¥ç«™ä¸‹ä¸€ä¸ªï¼Œå‡ºç«™ä¸Šä¸€ä¸ª)èƒ½å¤Ÿå¤„ç†è¯¥äº‹ä»¶çš„ <code>ChannelHandler</code>ã€‚</p><p><img src="https://cdn.jsdelivr.net/gh/zyxelva/picgo@main/markdown/ChannelPipeline2.png" alt="ChannelPipelineã€ChannelHandlerä¸ChannelHandlerContext"></p><h3 id="4-6-1-ChannelHandlerContext-çš„-API"><a href="#4-6-1-ChannelHandlerContext-çš„-API" class="headerlink" title="4.6.1 ChannelHandlerContext çš„ API"></a>4.6.1 ChannelHandlerContext çš„ API</h3><ul><li><code>alloc</code> è¿”å›å’Œè¿™ä¸ªå®ä¾‹ç›¸å…³è”çš„ <code>Channel</code> æ‰€é…ç½®çš„ <code>ByteBufAllocator</code></li><li><code>bind</code> ç»‘å®šåˆ°ç»™å®šçš„ <code>SocketAddress</code>ï¼Œå¹¶è¿”å› <code>ChannelFuture</code></li><li><code>channel</code> è¿”å›ç»‘å®šåˆ°è¿™ä¸ªå®ä¾‹çš„ <code>Channel</code></li><li><code>close</code> å…³é—­ <code>Channel</code>ï¼Œå¹¶è¿”å› <code>ChannelFuture</code></li><li><code>connect</code> è¿æ¥ç»™å®šçš„ <code>SocketAddress</code>ï¼Œå¹¶è¿”å› <code>ChannelFuture</code></li><li><code>deregister</code> ä»ä¹‹å‰åˆ†é…çš„ <code>EventExecutor</code> æ³¨é”€ï¼Œå¹¶è¿”å› <code>ChannelFuture</code></li><li><code>disconnect</code> ä»è¿œç¨‹èŠ‚ç‚¹æ–­å¼€ï¼Œå¹¶è¿”å› <code>ChannelFuture</code></li><li><code>executor</code> è¿”å›è°ƒåº¦äº‹ä»¶çš„ <code>EventExecutor</code></li><li><code>fireChannelActive</code> è§¦å‘å¯¹ä¸‹ä¸€ä¸ª <code>ChannelInboundHandler</code> ä¸Šçš„ <code>channelActive()</code>æ–¹æ³•(å·²è¿æ¥)çš„è°ƒç”¨</li><li><code>fireChannelInactive</code> è§¦å‘å¯¹ä¸‹ä¸€ä¸ª <code>ChannelInboundHandler</code> ä¸Šçš„ <code>channelInactive()</code>æ–¹æ³• (å·²å…³é—­)çš„è°ƒç”¨</li><li><code>fireChannelRead</code> è§¦å‘å¯¹ä¸‹ä¸€ä¸ª <code>ChannelInboundHandler</code> ä¸Šçš„ <code>channelRead()</code>æ–¹æ³•(å·²æ¥æ”¶çš„æ¶ˆæ¯)çš„è°ƒç”¨</li><li><code>fireChannelReadComplete</code> è§¦å‘å¯¹ä¸‹ä¸€ä¸ª <code>ChannelInboundHandler</code> ä¸Šçš„ <code>channelReadComplete()</code>æ–¹æ³•çš„è°ƒç”¨</li><li><code>fireChannelRegistered</code> è§¦å‘å¯¹ä¸‹ä¸€ä¸ª <code>ChannelInboundHandler</code> ä¸Šçš„ <code>fireChannelRegistered()</code>æ–¹æ³•çš„è°ƒç”¨</li><li><code>fireChannelUnregistered</code> è§¦å‘å¯¹ä¸‹ä¸€ä¸ª <code>ChannelInboundHandler</code> ä¸Šçš„ <code>fireChannelUnregistered()</code>æ–¹æ³•çš„è°ƒç”¨</li><li><code>fireChannelWritabilityChanged</code> è§¦å‘å¯¹ä¸‹ä¸€ä¸ª <code>ChannelInboundHandler</code> ä¸Šçš„ <code>fireChannelWritabilityChanged()</code>æ–¹æ³•çš„è°ƒç”¨</li><li><code>fireExceptionCaught</code> è§¦å‘å¯¹ä¸‹ä¸€ä¸ª <code>ChannelInboundHandler</code> ä¸Šçš„ <code>fireExceptionCaught(Throwable)</code>æ–¹æ³•çš„è°ƒç”¨</li><li><code>fireUserEventTriggered</code> è§¦å‘å¯¹ä¸‹ä¸€ä¸ª <code>ChannelInboundHandler</code> ä¸Šçš„ <code>fireUserEventTriggered(Object evt)</code>æ–¹æ³•çš„è°ƒç”¨</li><li><code>handler</code> è¿”å›ç»‘å®šåˆ°è¿™ä¸ªå®ä¾‹çš„ <code>ChannelHandler</code></li><li><code>isRemoved</code> å¦‚æœæ‰€å…³è”çš„ <code>ChannelHandler</code> å·²ç»è¢«ä» <code>ChannelPipeline</code> ä¸­<code>ç§»é™¤</code>åˆ™è¿”å› true</li><li><code>name</code> è¿”å›è¿™ä¸ªå®ä¾‹çš„<code>å”¯ä¸€</code>åç§°</li><li><code>pipeline</code> è¿”å›è¿™ä¸ªå®ä¾‹æ‰€å…³è”çš„ <code>ChannelPipeline</code></li><li><code>read</code> å°†æ•°æ®ä» <code>Channel</code> è¯»å–åˆ°ç¬¬ä¸€ä¸ªå…¥ç«™ç¼“å†²åŒº;å¦‚æœè¯»å–æˆåŠŸåˆ™è§¦å‘ä¸€ä¸ª <code>channelRead</code> äº‹ä»¶ï¼Œå¹¶(åœ¨æœ€åä¸€ä¸ªæ¶ˆæ¯è¢«è¯»å–å®Œæˆå)é€šçŸ¥ <code>ChannelInboundHandler</code> çš„ <code>channelReadComplete(ctx)</code>æ–¹æ³•</li><li><code>write</code> é€šè¿‡è¿™ä¸ªå®ä¾‹<code>å†™å…¥</code>æ¶ˆæ¯å¹¶<code>ç»è¿‡</code> <code>ChannelPipeline</code></li><li><code>writeAndFlush</code> é€šè¿‡è¿™ä¸ªå®ä¾‹<code>å†™å…¥å¹¶å†²åˆ·</code>æ¶ˆæ¯å¹¶<code>ç»è¿‡</code> <code>ChannelPipeline</code></li></ul><blockquote><p>å½“ä½¿ç”¨ <code>ChannelHandlerContext</code> çš„ <code>API</code> çš„æ—¶å€™ï¼Œæœ‰ä»¥ä¸‹<strong>ä¸¤ç‚¹</strong>:</p><ul><li><code>ChannelHandlerContext</code> å’Œ <code>ChannelHandler</code> ä¹‹é—´çš„<code>å…³è”(ç»‘å®š)</code>æ˜¯<code>æ°¸è¿œä¸ä¼šæ”¹å˜çš„</code>ï¼Œ æ‰€ä»¥ç¼“å­˜å¯¹å®ƒçš„å¼•ç”¨æ˜¯<code>å®‰å…¨çš„</code>;</li><li>å¦‚åŒæˆ‘ä»¬åœ¨æœ¬èŠ‚å¼€å¤´æ‰€è§£é‡Šçš„ä¸€æ ·ï¼Œç›¸å¯¹äºå…¶ä»–ç±»çš„åŒåæ–¹æ³•ï¼Œ<code>ChannelHandlerContext</code> çš„æ–¹æ³•å°†äº§ç”Ÿæ›´çŸ­çš„äº‹ä»¶æµï¼Œåº”è¯¥å°½å¯èƒ½åœ°åˆ©ç”¨è¿™ä¸ªç‰¹æ€§æ¥è·å¾—æœ€å¤§çš„æ€§èƒ½ã€‚</li></ul></blockquote><h2 id="4-7-å†…ç½®é€šè®¯ä¼ è¾“æ¨¡å¼"><a href="#4-7-å†…ç½®é€šè®¯ä¼ è¾“æ¨¡å¼" class="headerlink" title="4.7 å†…ç½®é€šè®¯ä¼ è¾“æ¨¡å¼"></a>4.7 å†…ç½®é€šè®¯ä¼ è¾“æ¨¡å¼</h2><ul><li><code>NIO</code>: <code>io.netty.channel.socket.nio</code>ä½¿ç”¨ <code>java.nio.channels</code> åŒ…ä½œä¸ºåŸºç¡€â€”â€”åŸºäº<code>é€‰æ‹©å™¨</code>çš„æ–¹å¼ï¼›</li><li><code>Epoll</code>ï¼š<code>io.netty.channel.epoll</code> ç”± <code>JNI</code> é©±åŠ¨çš„ <code>epoll()</code>å’Œ<code>éé˜»å¡ IO</code>ã€‚è¿™ä¸ªä¼ è¾“æ”¯æŒåªæœ‰åœ¨ <code>Linux</code> ä¸Šå¯ç”¨çš„å¤šç§ç‰¹æ€§ï¼Œå¦‚ <code>SO_REUSEPORT</code>ï¼Œæ¯” <code>NIO</code> ä¼ è¾“æ›´å¿«ï¼Œè€Œä¸”æ˜¯å®Œå…¨<code>éé˜»å¡</code>çš„ã€‚å°† <code>NioEventLoopGroup</code> æ›¿æ¢ä¸º <code>EpollEventLoopGroup</code> ï¼Œ å¹¶ä¸”å°† <code>NioServerSocketChannel.class</code> æ›¿æ¢ä¸º <code>EpollServerSocketChannel.class</code> å³å¯ï¼›</li><li><code>OIO</code>ï¼š<code>io.netty.channel.socket.oio</code> ä½¿ç”¨ <code>java.net</code> åŒ…ä½œä¸ºåŸºç¡€â€”â€”ä½¿ç”¨<code>é˜»å¡æµ</code>ï¼›</li><li><code>Local</code>ï¼š<code>io.netty.channel.local</code> å¯ä»¥åœ¨ <code>VM</code> å†…éƒ¨é€šè¿‡<code>ç®¡é“</code>è¿›è¡Œé€šä¿¡çš„<code>æœ¬åœ°</code>ä¼ è¾“</li><li><code>Embedded</code>ï¼š<code>io.netty.channel.embedded</code>ï¼Œå…è®¸ä½¿ç”¨ <code>ChannelHandler</code> è€Œåˆä¸éœ€è¦ä¸€ä¸ªçœŸæ­£çš„åŸºäºç½‘ç»œçš„ä¼ è¾“ã€‚åœ¨æµ‹è¯• <code>ChannelHandler</code> å®ç°æ—¶éå¸¸æœ‰ç”¨ã€‚</li></ul><h2 id="4-8-Bootstrap"><a href="#4-8-Bootstrap" class="headerlink" title="4.8 Bootstrap"></a>4.8 Bootstrap</h2><p>ç½‘ç»œç¼–ç¨‹é‡Œï¼Œ<code>æœåŠ¡å™¨</code>å’Œ<code>å®¢æˆ·ç«¯</code>å®é™…ä¸Šè¡¨ç¤ºäº†<code>ä¸åŒçš„ç½‘ç»œè¡Œä¸º</code>ã€‚æ¢å¥è¯è¯´ï¼Œæ˜¯<code>ç›‘å¬</code>ä¼ å…¥çš„è¿æ¥è¿˜æ˜¯<code>å»ºç«‹</code>åˆ°ä¸€ä¸ªæˆ–è€…å¤šä¸ªè¿›ç¨‹çš„è¿æ¥ã€‚<br>å› æ­¤ï¼Œæœ‰ä¸¤ç§ç±»å‹çš„å¼•å¯¼ï¼š</p><ul><li>ä¸€ç§ç”¨äº<code>å®¢æˆ·ç«¯</code>(ç®€å•åœ°ç§°ä¸º <code>Bootstrap</code>)ï¼›</li><li>å¦ä¸€ç§ç”¨äº<code>æœåŠ¡å™¨</code> (<code>ServerBootstrap</code>)ã€‚</li></ul><p>æ— è®ºä½ çš„åº”ç”¨ç¨‹åºä½¿ç”¨å“ªç§åè®®æˆ–è€…å¤„ç†å“ªç§ç±»å‹çš„æ•°æ®ï¼Œ <code>å”¯ä¸€</code>å†³å®šå®ƒä½¿ç”¨å“ªç§å¼•å¯¼ç±»çš„æ˜¯ï¼š<strong>å®ƒæ˜¯ä½œä¸ºä¸€ä¸ªå®¢æˆ·ç«¯è¿˜æ˜¯ä½œä¸ºä¸€ä¸ªæœåŠ¡å™¨</strong>ã€‚</p><p>æ¯”è¾ƒ <code>Bootstrap</code> ç±»ï¼š</p><table><thead><tr><th>Differents</th><th>Bootstrap</th><th>ServerBootstrap</th></tr></thead><tbody><tr><td>ç½‘ç»œç¼–ç¨‹ä¸­çš„ä½œç”¨</td><td>è¿æ¥åˆ°è¿œç¨‹ä¸»æœºå’Œç«¯å£</td><td>ç»‘å®šåˆ°ä¸€ä¸ªæœ¬åœ°ç«¯å£</td></tr><tr><td><code>EventLoopGroup</code> çš„æ•°ç›®</td><td>1</td><td>2</td></tr></tbody></table><blockquote><p>ä¸ºå•¥<code>ServerBootstrap</code>éœ€è¦ä¸¤ä¸ª<code>EventLoopGroup</code>?<br>å› ä¸ºæœåŠ¡å™¨éœ€è¦<code>ä¸¤ç»„ä¸åŒçš„ Channel</code>ï¼š</p><ul><li>ç¬¬ä¸€ç»„å°†åªåŒ…å«<code>ä¸€ä¸ª ServerChannel</code>ï¼Œä»£è¡¨æœåŠ¡å™¨è‡ªèº«çš„<code>å·²ç»‘å®š</code>åˆ°æŸä¸ª<code>æœ¬åœ°ç«¯å£</code>çš„æ­£åœ¨<code>ç›‘å¬</code>çš„å¥—æ¥å­—ã€‚</li><li>è€Œç¬¬äºŒç»„å°†åŒ…å«æ‰€æœ‰å·²åˆ›å»ºçš„ç”¨æ¥å¤„ç†ä¼ å…¥<code>å®¢æˆ·ç«¯è¿æ¥</code>(å¯¹äºæ¯ä¸ªæœåŠ¡å™¨å·²ç»æ¥å—çš„è¿æ¥éƒ½æœ‰ä¸€ä¸ª)çš„ <code>Channel</code>ã€‚</li></ul></blockquote><blockquote><p>å®é™…ä¸Šï¼Œ<code>ServerBootstrapç±»</code>ä¹Ÿå¯ä»¥åªä½¿ç”¨<code>ä¸€ä¸ªEventLoopGroup</code>ï¼Œæ­¤æ—¶å…¶å°†åœ¨ä¸¤ä¸ªåœºæ™¯ä¸‹å…±ç”¨<code>åŒä¸€ä¸ªEventLoopGroup</code>ã€‚</p></blockquote><p><img src="https://cdn.jsdelivr.net/gh/zyxelva/picgo@main/markdown/Two-EventLoopGroups-of-a-Server.png" alt="å…·æœ‰ä¸¤ä¸ª EventLoopGroup çš„æœåŠ¡å™¨"></p><h2 id="4-9-ByteBuf"><a href="#4-9-ByteBuf" class="headerlink" title="4.9 ByteBuf"></a>4.9 ByteBuf</h2><p>ç½‘ç»œä¸­çš„æ•°æ®ï¼Œå…¶åŸºæœ¬å•ä½æ˜¯å­—èŠ‚ï¼Œåœ¨<code>JAVA NIO</code>ä¸­ï¼Œåˆ©ç”¨<code>ByteBuffer</code>ä½œä¸ºå­—èŠ‚çš„æ•°æ®è½½ä½“ï¼Œä½†æ˜¯ä¹‹æ‰€ä»¥æœ‰Nettyï¼Œä¸å°±æ˜¯å› ä¸ºåŸç”Ÿç½‘ç»œç¼–ç¨‹å¤æ‚ï¼Œä¸”APIè¾ƒæ™¦æ¶©å’©ï¼Ÿå› è€ŒNettyæä¾›äº†å¦å¤–çš„è½½ä½“â€”<code>ByteBuf</code>ï¼Œä¸€ä¸ªå¼ºå¤§çš„å®ç°ï¼Œæ—¢è§£å†³äº† <code>JDK API</code> çš„å±€é™æ€§ï¼Œ åˆä¸ºç½‘ç»œåº”ç”¨ç¨‹åºçš„å¼€å‘è€…æä¾›äº†æ›´å¥½çš„ APIã€‚</p><h3 id="4-9-1-å·¥ä½œåŸç†"><a href="#4-9-1-å·¥ä½œåŸç†" class="headerlink" title="4.9.1 å·¥ä½œåŸç†"></a>4.9.1 å·¥ä½œåŸç†</h3><p><code>ByteBuf</code> ç»´æŠ¤äº†<strong>ä¸¤ä¸ªä¸åŒçš„ç´¢å¼•</strong>ï¼š</p><ul><li>ä¸€ä¸ªç”¨äº<code>è¯»å–</code></li><li>ä¸€ä¸ªç”¨äº<code>å†™å…¥</code>ã€‚</li></ul><p>å½“ä½ ä» <code>ByteBuf</code> <code>è¯»å–</code>æ—¶ï¼Œ å®ƒçš„ <code>readerIndex</code> å°†ä¼š<code>è¢«é€’å¢</code>å·²ç»è¢«è¯»å–çš„å­—èŠ‚æ•°ã€‚åŒæ ·åœ°ï¼Œå½“ä½ <code>å†™å…¥ ByteBuf </code>æ—¶ï¼Œå®ƒçš„ <code>writerIndex</code> ä¹Ÿä¼š<code>è¢«é€’å¢</code>ã€‚ä¸‹å›¾å±•ç¤ºäº†ä¸€ä¸ª<code>ç©º ByteBuf</code> çš„å¸ƒå±€ç»“æ„å’ŒçŠ¶æ€ã€‚<br><img src="https://cdn.jsdelivr.net/gh/zyxelva/picgo@main/markdown/A-Blank-ByteBuf.png" alt="ä¸€ä¸ªè¯»ç´¢å¼•å’Œå†™ç´¢å¼•éƒ½è®¾ç½®ä¸º 0 çš„ 16 å­—èŠ‚ ByteBuf"></p><p>è¦äº†è§£è¿™äº›ç´¢å¼•<code>ä¸¤ä¸¤ä¹‹é—´</code>çš„å…³ç³»ï¼Œè¯·è€ƒè™‘ä¸€ä¸‹ï¼Œå¦‚æœæ‰“ç®—<code>è¯»å–</code>å­—èŠ‚ç›´åˆ° <code>readerIndex</code> è¾¾åˆ°å’Œ <code>writerIndex</code> åŒæ ·çš„å€¼æ—¶ä¼šå‘ç”Ÿä»€ä¹ˆã€‚åœ¨é‚£æ—¶ï¼Œä½ å°†ä¼šåˆ°è¾¾<code>å¯ä»¥è¯»å–çš„</code>æ•°æ®çš„æœ«å°¾ã€‚å°±å¦‚åŒè¯•å›¾è¯»å–<code>è¶…å‡º</code>æ•°ç»„æœ«å°¾çš„æ•°æ®ä¸€æ ·ï¼Œè¯•å›¾è¯»å–è¶…å‡ºè¯¥ç‚¹çš„æ•°æ®å°†ä¼šè§¦å‘ä¸€ä¸ª <code>IndexOutOfBoundsException</code>ã€‚</p><p>åç§°ä»¥ <code>read</code> æˆ–è€… <code>write</code> å¼€å¤´çš„ <code>ByteBuf</code> æ–¹æ³•ï¼Œå°†ä¼šæ¨è¿›å…¶å¯¹åº”çš„ç´¢å¼•ï¼Œè€Œåç§°ä»¥ <code>set</code> æˆ– è€… <code>get</code> å¼€å¤´çš„æ“ä½œåˆ™ä¸ä¼šã€‚åé¢çš„è¿™äº›æ–¹æ³•å°†åœ¨ä½œä¸ºä¸€ä¸ª<code>å‚æ•°</code>ä¼ å…¥çš„ä¸€ä¸ª<code>ç›¸å¯¹ç´¢å¼•</code>ä¸Šæ‰§è¡Œæ“ä½œã€‚</p><p>å¯ä»¥æŒ‡å®š <code>ByteBuf</code> çš„<strong>æœ€å¤§å®¹é‡</strong>ã€‚è¯•å›¾ç§»åŠ¨<code>å†™ç´¢å¼•</code>(å³ <code>writerIndex</code>)è¶…è¿‡è¿™ä¸ªå€¼å°†ä¼šè§¦å‘ä¸€ä¸ª<code>å¼‚å¸¸</code>ã€‚(é»˜è®¤çš„é™åˆ¶æ˜¯ <code>Integer.MAX_VALUE</code>ã€‚)</p><h3 id="4-9-1-ByteBuf-API-çš„ä¼˜ç‚¹"><a href="#4-9-1-ByteBuf-API-çš„ä¼˜ç‚¹" class="headerlink" title="4.9.1 ByteBuf API çš„ä¼˜ç‚¹"></a>4.9.1 ByteBuf API çš„ä¼˜ç‚¹</h3><ul><li>å®ƒå¯ä»¥è¢«ç”¨æˆ·è‡ªå®šä¹‰çš„ç¼“å†²åŒºç±»å‹<code>æ‰©å±•</code>;</li><li>é€šè¿‡å†…ç½®çš„<code>å¤åˆç¼“å†²åŒº</code>ç±»å‹å®ç°äº†é€æ˜çš„<code>é›¶æ‹·è´</code>;</li><li><code>å®¹é‡</code>å¯ä»¥<code>æŒ‰éœ€å¢é•¿</code>(ç±»ä¼¼äº JDK çš„ <code>StringBuilder</code>);</li><li>åœ¨<code>è¯»</code>å’Œ<code>å†™</code>è¿™ä¸¤ç§æ¨¡å¼ä¹‹é—´åˆ‡æ¢<strong>ä¸éœ€è¦</strong>è°ƒç”¨ <code>ByteBuffer</code> çš„ <code>flip()</code>æ–¹æ³•;</li><li><code>è¯»</code>å’Œ<code>å†™</code>ä½¿ç”¨äº†<strong>ä¸åŒçš„ç´¢å¼•</strong>;</li><li>æ”¯æŒæ–¹æ³•çš„<code>é“¾å¼è°ƒç”¨</code>;</li><li>æ”¯æŒ<code>å¼•ç”¨è®¡æ•°</code>;</li><li>æ”¯æŒ<code>æ± åŒ–</code>.</li></ul><h3 id="4-9-2-ä½¿ç”¨æ¨¡å¼"><a href="#4-9-2-ä½¿ç”¨æ¨¡å¼" class="headerlink" title="4.9.2 ä½¿ç”¨æ¨¡å¼"></a>4.9.2 ä½¿ç”¨æ¨¡å¼</h3><ul><li>å †ç¼“å†²åŒº</li></ul><p>æœ€å¸¸ç”¨çš„ <code>ByteBufæ¨¡å¼</code>æ˜¯å°†æ•°æ®å­˜å‚¨åœ¨ JVM çš„<code>å †ç©ºé—´</code>ä¸­ã€‚è¿™ç§æ¨¡å¼è¢«ç§°ä¸º<code>æ”¯æ’‘æ•°ç»„</code> (backing array)ï¼Œå®ƒèƒ½åœ¨æ²¡æœ‰ä½¿ç”¨<code>æ± åŒ–</code>çš„æƒ…å†µä¸‹æä¾›å¿«é€Ÿçš„<code>åˆ†é…å’Œé‡Šæ”¾</code>ã€‚å¯ä»¥ç”± <code>hasArray()</code> æ¥åˆ¤æ–­æ£€æŸ¥ ByteBuf æ˜¯å¦ç”±<code>æ•°ç»„</code>æ”¯æ’‘ã€‚å¦‚æœä¸æ˜¯ï¼Œåˆ™è¿™æ˜¯ä¸€ä¸ª<code>ç›´æ¥ç¼“å†²åŒº</code>ã€‚</p><ul><li>ç›´æ¥ç¼“å†²åŒº</li></ul><p><code>ç›´æ¥ç¼“å†²åŒº</code>æ˜¯å¦å¤–ä¸€ç§ ByteBuf æ¨¡å¼ã€‚ç›´æ¥ç¼“å†²åŒºçš„<strong>ä¸»è¦ç¼ºç‚¹</strong>æ˜¯ï¼Œç›¸å¯¹äºåŸºäºå †çš„ç¼“å†²åŒºï¼Œå®ƒä»¬çš„åˆ†é…å’Œé‡Šæ”¾éƒ½è¾ƒä¸º<code>æ˜‚è´µ</code>ã€‚</p><p>-å¤åˆç¼“å†²åŒº</p><p><code>å¤åˆç¼“å†²åŒºCompositeByteBuf</code>ï¼Œå®ƒä¸º<strong>å¤šä¸ª</strong>ByteBuf æä¾›ä¸€ä¸ª<code>èšåˆè§†å›¾</code>ã€‚æ¯”å¦‚HTTP åè®®ï¼Œ åˆ†ä¸ºæ¶ˆæ¯å¤´å’Œæ¶ˆæ¯ä½“ï¼Œè¿™ä¸¤éƒ¨åˆ†å¯èƒ½ç”±åº”ç”¨ç¨‹åºçš„ä¸åŒæ¨¡å—äº§ç”Ÿï¼Œå„æœ‰å„çš„ ByteBufï¼Œå°†ä¼šåœ¨æ¶ˆæ¯è¢«å‘é€çš„æ—¶å€™<code>ç»„è£…</code>ä¸º<strong>ä¸€ä¸ª ByteBuf</strong>ï¼Œæ­¤æ—¶å¯ä»¥å°†è¿™ä¸¤ä¸ª ByteBuf <code>èšåˆ</code>ä¸ºä¸€ä¸ª <code>CompositeByteBuf</code>ï¼Œç„¶åä½¿ç”¨ç»Ÿä¸€å’Œé€šç”¨çš„ <code>ByteBuf API</code> æ¥æ“ä½œã€‚</p><h3 id="4-9-3-åˆ†é…æ–¹å¼"><a href="#4-9-3-åˆ†é…æ–¹å¼" class="headerlink" title="4.9.3 åˆ†é…æ–¹å¼"></a>4.9.3 åˆ†é…æ–¹å¼</h3><p>å¦‚ä½•åœ¨æˆ‘ä»¬çš„ç¨‹åºä¸­è·å¾— <code>ByteBuf çš„å®ä¾‹</code>ï¼Œå¹¶ä½¿ç”¨å®ƒå‘¢ï¼ŸNetty æä¾›äº†<strong>ä¸¤ç§æ–¹å¼</strong>ã€‚</p><ul><li>æŒ‰éœ€åˆ†é…ï¼šByteBufAllocator æ¥å£</li></ul><p>Nettyçš„ä¸€ç§å®ä¾‹åˆ†é…æ± åŒ–æ¥å£ã€‚é€šè¿‡ <code>interface ByteBufAllocator</code> åˆ†é…æˆ‘ä»¬æ‰€æè¿°è¿‡çš„<code>ä»»æ„ç±»å‹</code>çš„ <code>ByteBuf å®ä¾‹</code>ã€‚</p><p>ä¸‹è¡¨åˆ—å‡ºäº†<code>ByteBufAllocator</code>æä¾›çš„ä¸€äº›æ“ä½œã€‚</p><table border="0" cellpadding="0" cellspacing="0" width="889" style="border-collapse: collapse;table-layout:fixed;width:667pt"> <col width="429" style="mso-width-source:userset;mso-width-alt:13738;width:322pt"> <col width="460" style="mso-width-source:userset;mso-width-alt:14720;width:345pt"> <tr height="24" style="height:18.0pt">  <td height="24" class="xl65" width="429" style="height:18.0pt;width:322pt"><font class="font7">åç§°</font></td>  <td class="xl65" width="460" style="width:345pt"><font class="font7">æè¿°</font></td> </tr> <tr height="24" style="height:18.0pt">  <td height="24" class="xl65" style="height:18.0pt">  <div title="Page 90">buffer();</div></td>  <td rowspan="3" class="xl65"><font class="font7">è¿”å›ä¸€ä¸ªåŸºäºå †æˆ–è€…ç›´æ¥å†…å­˜å­˜å‚¨çš„</font><font class="font6"> ByteBuf</font></td> </tr> <tr height="24" style="height:18.0pt">  <td height="24" class="xl65" style="height:18.0pt">buffer(int initialCapacity);</td> </tr> <tr height="24" style="height:18.0pt">  <td height="24" class="xl65" style="height:18.0pt">buffer(int initialCapacity,  int maxCapacity);<span style="mso-spacerun:yes">Â </span>  </td> </tr> <tr height="24" style="height:18.0pt">  <td height="24" class="xl65" style="height:18.0pt">  <div title="Page 90">heapBuffer();</div></td>  <td rowspan="3" class="xl65"><font class="font7">è¿”å›ä¸€ä¸ªåŸºäºå †å†…å­˜å­˜å‚¨çš„</font><font class="font6">ByteBuf</font></td> </tr> <tr height="24" style="height:18.0pt">  <td height="24" class="xl65" style="height:18.0pt">heapBuffer(int  initialCapacity);</td> </tr> <tr height="24" style="height:18.0pt">  <td height="24" class="xl65" style="height:18.0pt">heapBuffer(int  initialCapacity, int maxCapacity);  </td> </tr> <tr height="24" style="height:18.0pt">  <td height="24" class="xl65" style="height:18.0pt">  <div title="Page 90">directBuffer();</div></td>  <td rowspan="3" class="xl65">  <div title="Page 90"><font class="font8">è¿”å›ä¸€ä¸ªåŸºäºç›´æ¥å†…å­˜å­˜å‚¨çš„</font><font class="font6">ByteBuf</font></div></td> </tr> <tr height="24" style="height:18.0pt">  <td height="24" class="xl65" style="height:18.0pt">directBuffer(int  initialCapacity);</td> </tr> <tr height="25" style="height:19.0pt">  <td height="25" class="xl66" width="429" style="height:19.0pt;width:322pt">directBuffer(int  initialCapacity, int maxCapacity);  </td> </tr> <tr height="24" style="height:18.0pt">  <td height="24" class="xl65" style="height:18.0pt">  <div title="Page 90">compositeBuffer();</div></td>  <td rowspan="6" class="xl67" width="460" style="width:345pt"><font class="font8">è¿”å›ä¸€ä¸ªå¯ä»¥é€šè¿‡æ·»åŠ æœ€å¤§åˆ°æŒ‡å®šæ•°ç›®çš„åŸºäºå †çš„æˆ–è€…ç›´æ¥å†…å­˜å­˜å‚¨çš„ç¼“å†²åŒºæ¥æ‰©å±•çš„</font><font class="font6"> CompositeByteBuf<span style="mso-spacerun:yes">Â </span></font></td> </tr> <tr height="25" style="height:19.0pt">  <td height="25" class="xl66" width="429" style="height:19.0pt;width:322pt">compositeBuffer(int  maxNumComponents);  </td> </tr> <tr height="24" style="height:18.0pt">  <td height="24" class="xl65" style="height:18.0pt">compositeDirectBuffer();</td> </tr> <tr height="24" style="height:18.0pt">  <td height="24" class="xl65" style="height:18.0pt">compositeDirectBuffer(int  maxNumComponents);</td> </tr> <tr height="24" style="height:18.0pt">  <td height="24" class="xl65" style="height:18.0pt">compositeHeapBuffer();</td> </tr> <tr height="24" style="height:18.0pt">  <td height="24" class="xl65" style="height:18.0pt">compositeHeapBuffer(int  maxNumComponents);<span style="mso-spacerun:yes">Â </span></td> </tr> <tr height="24" style="height:18.0pt">  <td height="24" class="xl65" style="height:18.0pt">  <div title="Page 90">ioBuffer()<span style="mso-spacerun:yes">Â </span></div>  </td>  <td class="xl65"><font class="font8">è¿”å›ä¸€ä¸ªç”¨äºå¥—æ¥å­—çš„</font><font class="font6"> I/O </font><font class="font8">æ“ä½œçš„</font><font class="font6"> ByteBuf<span style="mso-spacerun:yes">Â </span></font>  </td> </tr> <![if supportMisalignedColumns]> <tr height="0" style="display:none">  <td width="429" style="width:322pt"></td>  <td width="460" style="width:345pt"></td> </tr> <![endif]></table><p>å¯ä»¥é€šè¿‡ <code>Channel</code>(æ¯ä¸ªéƒ½å¯ä»¥æœ‰ä¸€ä¸ªä¸åŒçš„ <code>ByteBufAllocator</code> å®ä¾‹)æˆ–è€…ç»‘å®šåˆ° <code>ChannelHandler</code> çš„ <code>ChannelHandlerContext</code> è·å–ä¸€ä¸ªåˆ° <code>ByteBufAllocator</code> çš„<code>å¼•ç”¨</code>ã€‚</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">Channel</span> channel <span class="token operator">=</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">;</span><span class="token class-name">ByteBufAllocator</span> allocator <span class="token operator">=</span> channel<span class="token punctuation">.</span><span class="token function">alloc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// ä» Channel è·å–ä¸€ä¸ªåˆ° ByteBufAllocator çš„å¼•ç”¨</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token class-name">ChannelHandlerContext</span> ctx <span class="token operator">=</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">;</span><span class="token class-name">ByteBufAllocator</span> allocator2 <span class="token operator">=</span> ctx<span class="token punctuation">.</span><span class="token function">alloc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// ä» ChannelHandlerContext è·å–ä¸€ä¸ªåˆ° ByteBufAllocator çš„å¼•ç”¨</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>ä¸¤ç§ByteBufAllocatorçš„å®ç°</p><ul><li>PooledByteBufAllocatorï¼ˆé»˜è®¤ï¼‰ï¼š<code>æ± åŒ–</code>äº†<code>ByteBuf</code>çš„å®ä¾‹ä»¥æé«˜æ€§èƒ½å¹¶æœ€å¤§é™åº¦åœ°å‡å°‘å†…å­˜ç¢ç‰‡ã€‚</li><li>UnpooledByteBufAllocatorï¼šå®ç°<code>ä¸æ± åŒ–</code>ByteBufå®ä¾‹ï¼Œå¹¶ä¸”åœ¨æ¯æ¬¡å®ƒè¢«è°ƒç”¨æ—¶éƒ½ä¼šè¿”å›ä¸€ä¸ª<code>æ–°çš„å®ä¾‹</code>ã€‚</li></ul></blockquote><ul><li>Unpooled ç¼“å†²åŒº<br>Netty æä¾›äº†ä¸€ä¸ªç®€å•çš„ç§°ä¸º Unpooled çš„å·¥å…·ç±»<code>ByteBufUtil</code>ï¼Œå®ƒæä¾›äº†<code>é™æ€</code>çš„è¾…åŠ©æ–¹æ³•æ¥åˆ›å»º<code>æœªæ± åŒ–</code>çš„ ByteBuf å®ä¾‹ã€‚<table border="0" cellpadding="0" cellspacing="0" width="854" style="border-collapse: collapse;table-layout:fixed;width:640pt"> <col width="423" style="mso-width-source:userset;mso-width-alt:13525;width:317pt"> <col width="431" style="mso-width-source:userset;mso-width-alt:13781;width:323pt"> <tr height="24" style="height:18.0pt"><td height="24" class="xl65" width="423" style="height:18.0pt;width:317pt"><font class="font7">åç§°</font></td><td class="xl65" width="431" style="width:323pt"><font class="font7">æè¿°</font></td> </tr> <tr height="24" style="height:18.0pt"><td height="24" class="xl65" style="height:18.0pt"><div title="Page 91">buffer()</div></td><td rowspan="3" class="xl65"><div title="Page 91"><font class="font8">è¿”å›ä¸€ä¸ªæœªæ± åŒ–çš„åŸºäºå †å†…å­˜å­˜å‚¨çš„</font><font class="font6">ByteBuf</font></div></td> </tr> <tr height="24" style="height:18.0pt"><td height="24" class="xl65" style="height:18.0pt">buffer(int initialCapacity)</td> </tr> <tr height="24" style="height:18.0pt"><td height="24" class="xl65" style="height:18.0pt">buffer(int initialCapacity,int maxCapacity)<span style="mso-spacerun:yes">Â </span></td> </tr> <tr height="24" style="height:18.0pt"><td height="24" class="xl65" style="height:18.0pt"><div title="Page 91">directBuffer()</div></td><td rowspan="3" class="xl65"><div title="Page 91"><font class="font8">è¿”å›ä¸€ä¸ªæœªæ± åŒ–çš„åŸºäºç›´æ¥å†…å­˜å­˜å‚¨çš„</font><font class="font6">ByteBuf</font></div></td> </tr> <tr height="24" style="height:18.0pt"><td height="24" class="xl65" style="height:18.0pt">directBuffer(intinitialCapacity)</td> </tr> <tr height="24" style="height:18.0pt"><td height="24" class="xl65" style="height:18.0pt">directBuffer(intinitialCapacity, int maxCapacity)</td> </tr> <tr height="24" style="height:18.0pt"><td height="24" class="xl65" style="height:18.0pt"><div title="Page 91">wrappedBuffer()<span style="mso-spacerun:yes">Â </span></div></td><td class="xl65"><div title="Page 91"><font class="font8">è¿”å›ä¸€ä¸ªåŒ…è£…äº†ç»™å®šæ•°æ®çš„</font><font class="font6">ByteBuf</font></div></td> </tr> <tr height="24" style="height:18.0pt"><td height="24" class="xl65" style="height:18.0pt"><div title="Page 91">copiedBuffer()<span style="mso-spacerun:yes">Â </span></div></td><td class="xl65"><font class="font7">è¿”å›ä¸€ä¸ªå¤åˆ¶äº†ç»™å®šæ•°æ®çš„</font><font class="font6">ByteBuf</font></td> </tr> <![if supportMisalignedColumns]> <tr height="0" style="display:none"><td width="423" style="width:317pt"></td><td width="431" style="width:323pt"></td> </tr> <![endif]></table></li></ul><p><code>Unpooled ç±»</code>è¿˜ä½¿å¾— ByteBuf åŒæ ·å¯ç”¨äºé‚£äº›å¹¶ä¸éœ€è¦ Netty çš„å…¶ä»–ç»„ä»¶çš„<code>éç½‘ç»œé¡¹ç›®</code>ï¼Œ ä½¿å¾—å…¶èƒ½å¾—ç›Šäºé«˜æ€§èƒ½çš„å¯æ‰©å±•çš„ç¼“å†²åŒº APIã€‚</p><h3 id="4-9-4-å­—èŠ‚çº§æ“ä½œ"><a href="#4-9-4-å­—èŠ‚çº§æ“ä½œ" class="headerlink" title="4.9.4 å­—èŠ‚çº§æ“ä½œ"></a>4.9.4 å­—èŠ‚çº§æ“ä½œ</h3><h4 id="4-9-4-1-éšæœºè®¿é—®ç´¢å¼•"><a href="#4-9-4-1-éšæœºè®¿é—®ç´¢å¼•" class="headerlink" title="4.9.4.1 éšæœºè®¿é—®ç´¢å¼•"></a>4.9.4.1 éšæœºè®¿é—®ç´¢å¼•</h4><p>ç±»ä¼¼javaçš„å­—èŠ‚æ•°ç»„éå†ã€‚</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">ByteBuf</span> buffer <span class="token operator">=</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">;</span><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> buffer<span class="token punctuation">.</span><span class="token function">capacity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">byte</span> b <span class="token operator">=</span> buffer<span class="token punctuation">.</span><span class="token function">getByte</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token punctuation">)</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œä½¿ç”¨é‚£äº›éœ€è¦<code>ä¸€ä¸ªç´¢å¼•å€¼å‚æ•°</code>çš„æ–¹æ³•(çš„å…¶ä¸­)ä¹‹ä¸€æ¥è®¿é—®æ•°æ®æ—¢<code>ä¸ä¼šæ”¹å˜ readerIndex</code> ä¹Ÿ<code>ä¸ä¼šæ”¹å˜ writerIndex</code>ã€‚å¦‚æœæœ‰éœ€è¦ï¼Œä¹Ÿå¯ä»¥é€šè¿‡è°ƒç”¨ <code>readerIndex(index)</code> æˆ–è€… <code>writerIndex(index)</code>æ¥æ‰‹åŠ¨ç§»åŠ¨è¿™ä¸¤è€…ã€‚</p></blockquote><h4 id="4-9-4-2-é¡ºåºè®¿é—®ç´¢å¼•"><a href="#4-9-4-2-é¡ºåºè®¿é—®ç´¢å¼•" class="headerlink" title="4.9.4.2 é¡ºåºè®¿é—®ç´¢å¼•"></a>4.9.4.2 é¡ºåºè®¿é—®ç´¢å¼•</h4><p>è™½ç„¶ ByteBuf åŒæ—¶å…·æœ‰<code>è¯»ç´¢å¼•</code>å’Œ<code>å†™ç´¢å¼•</code>ï¼Œä½†æ˜¯ JDK çš„ <code>ByteBuffer</code> å´åªæœ‰<code>ä¸€ä¸ªç´¢å¼•</code>ï¼Œè¿™ ä¹Ÿå°±æ˜¯ä¸ºä»€ä¹ˆå¿…é¡»è°ƒç”¨ <code>flip()</code>æ–¹æ³•æ¥åœ¨<code>è¯»æ¨¡å¼</code>å’Œ<code>å†™æ¨¡å¼</code>ä¹‹é—´è¿›è¡Œåˆ‡æ¢çš„åŸå› ã€‚</p><p><img src="https://cdn.jsdelivr.net/gh/zyxelva/picgo@main/markdown/ByteBuf-Inner-Segments.png" alt="ByteBufçš„å†…éƒ¨åˆ†æ®µ"></p><h4 id="4-9-4-3-å¯ä¸¢å¼ƒå­—èŠ‚"><a href="#4-9-4-3-å¯ä¸¢å¼ƒå­—èŠ‚" class="headerlink" title="4.9.4.3 å¯ä¸¢å¼ƒå­—èŠ‚"></a>4.9.4.3 å¯ä¸¢å¼ƒå­—èŠ‚</h4><p><code>å¯ä¸¢å¼ƒå­—èŠ‚çš„åˆ†æ®µ</code>åŒ…å«äº†å·²ç»<code>è¢«è¯»è¿‡</code>çš„å­—èŠ‚ã€‚é€šè¿‡è°ƒç”¨ <code>discardReadBytes()</code>æ–¹æ³•ï¼Œå¯ä»¥<code>ä¸¢å¼ƒ</code>å®ƒä»¬å¹¶<code>å›æ”¶ç©ºé—´</code>ã€‚è¿™ä¸ªåˆ†æ®µçš„åˆå§‹å¤§å°ä¸º 0ï¼Œå­˜å‚¨åœ¨ <code>readerIndex</code> ä¸­ï¼Œä¼šéšç€ <code>read</code> æ“ä½œçš„æ‰§è¡Œè€Œå¢åŠ (get*æ“ä½œä¸ä¼šç§»åŠ¨ readerIndex)ã€‚</p><p>ç¼“å†²åŒºä¸Šè°ƒç”¨ <code>discardReadBytes()</code>æ–¹æ³•åï¼Œ<code>å¯ä¸¢å¼ƒå­—èŠ‚åˆ†æ®µ</code>ä¸­çš„ç©ºé—´å·²ç»å˜ä¸º<code>å¯å†™</code>çš„äº†ã€‚ é¢‘ç¹åœ°è°ƒç”¨ <code>discardReadBytes()</code>æ–¹æ³•ä»¥ç¡®ä¿å¯å†™åˆ†æ®µçš„æœ€å¤§åŒ–ï¼Œä½†æ˜¯<strong>è¯·æ³¨æ„</strong>ï¼Œè¿™å°†ææœ‰å¯èƒ½ä¼šå¯¼è‡´<code>å†…å­˜å¤åˆ¶</code>ï¼Œå› ä¸º<code>å¯è¯»å­—èŠ‚</code>å¿…é¡»è¢«ç§»åŠ¨åˆ°ç¼“å†²åŒºçš„å¼€å§‹ä½ç½®ã€‚å»ºè®®åªåœ¨æœ‰çœŸæ­£éœ€è¦çš„æ—¶å€™æ‰è¿™æ ·åšï¼Œä¾‹å¦‚ï¼Œå½“å†…å­˜éå¸¸å®è´µçš„æ—¶å€™ã€‚</p><p><img src="https://cdn.jsdelivr.net/gh/zyxelva/picgo@main/markdown/discardReadBytes-ByteBuf.png" alt="ä¸¢å¼ƒå·²è¯»å­—èŠ‚ä¹‹åçš„ ByteBuf"></p><h4 id="4-9-4-4-å¯è¯»å­—èŠ‚"><a href="#4-9-4-4-å¯è¯»å­—èŠ‚" class="headerlink" title="4.9.4.4 å¯è¯»å­—èŠ‚"></a>4.9.4.4 å¯è¯»å­—èŠ‚</h4><p>ByteBuf çš„å¯è¯»å­—èŠ‚åˆ†æ®µå­˜å‚¨äº†å®é™…æ•°æ®ã€‚æ–°åˆ†é…çš„ã€åŒ…è£…çš„æˆ–è€…å¤åˆ¶çš„ç¼“å†²åŒºçš„é»˜è®¤çš„ <code>readerIndex</code> å€¼ä¸º 0ã€‚</p><h4 id="4-9-4-5-å¯å†™å­—èŠ‚"><a href="#4-9-4-5-å¯å†™å­—èŠ‚" class="headerlink" title="4.9.4.5 å¯å†™å­—èŠ‚"></a>4.9.4.5 å¯å†™å­—èŠ‚</h4><p>å¯å†™å­—èŠ‚åˆ†æ®µæ˜¯æŒ‡ä¸€ä¸ªæ‹¥æœ‰<code>æœªå®šä¹‰å†…å®¹çš„</code>ã€<code>å†™å…¥å°±ç»ªçš„</code>å†…å­˜åŒºåŸŸã€‚æ–°åˆ†é…çš„ç¼“å†²åŒºçš„ <code>writerIndex</code> çš„é»˜è®¤å€¼ä¸º 0ã€‚ä»»ä½•åç§°ä»¥ <code>write å¼€å¤´</code>çš„æ“ä½œéƒ½å°†ä»å½“å‰çš„ <code>writerIndex</code> å¤„å¼€å§‹ å†™æ•°æ®ï¼Œå¹¶å°†å®ƒå¢åŠ å·²ç»å†™å…¥çš„å­—èŠ‚æ•°ã€‚</p><h4 id="4-9-4-6-ç´¢å¼•ç®¡ç†"><a href="#4-9-4-6-ç´¢å¼•ç®¡ç†" class="headerlink" title="4.9.4.6 ç´¢å¼•ç®¡ç†"></a>4.9.4.6 ç´¢å¼•ç®¡ç†</h4><p>è°ƒç”¨ <code>markReaderIndex()</code>ã€<code>markWriterIndex()</code>ã€<code>resetWriterIndex()</code>å’Œ <code>resetReaderIndex()</code>æ¥<code>æ ‡è®°</code>å’Œ<code>é‡ç½®</code> ByteBuf çš„ <code>readerIndex</code> å’Œ <code>writerIndex</code>ã€‚</p><p>ä¹Ÿå¯ä»¥é€šè¿‡è°ƒç”¨ <code>readerIndex(int)</code>æˆ–è€… <code>writerIndex(int)</code>æ¥å°†ç´¢å¼•ç§»åŠ¨åˆ°æŒ‡å®šä½ç½®ã€‚è¯•å›¾å°†ä»»ä½•ä¸€ä¸ªç´¢å¼•è®¾ç½®åˆ°ä¸€ä¸ª<code>æ— æ•ˆçš„</code>ä½ç½®éƒ½å°†å¯¼è‡´ä¸€ä¸ª <code>IndexOutOfBoundsException</code>ã€‚</p><p>å¯ä»¥é€šè¿‡è°ƒç”¨ <code>clear()</code>æ–¹æ³•æ¥å°† <code>readerIndex</code> å’Œ <code>writerIndex</code> éƒ½è®¾ç½®ä¸º 0ã€‚æ³¨æ„ï¼Œè¿™å¹¶<code>ä¸ä¼šæ¸…é™¤</code>å†…å­˜ä¸­çš„å†…å®¹ã€‚</p><h4 id="4-9-4-7-æŸ¥æ‰¾æ“ä½œ"><a href="#4-9-4-7-æŸ¥æ‰¾æ“ä½œ" class="headerlink" title="4.9.4.7 æŸ¥æ‰¾æ“ä½œ"></a>4.9.4.7 æŸ¥æ‰¾æ“ä½œ</h4><p>åœ¨ <code>ByteBuf</code> ä¸­æœ‰å¤šç§å¯ä»¥ç”¨æ¥ç¡®å®šæŒ‡å®šå€¼çš„ç´¢å¼•çš„æ–¹æ³•ã€‚æœ€ç®€å•çš„æ˜¯ä½¿ç”¨ <code>indexOf()</code>æ–¹æ³•ã€‚è¾ƒå¤æ‚çš„æŸ¥æ‰¾å¯ä»¥é€šè¿‡è°ƒç”¨ <code>forEachByte()</code>ã€‚<br>ä»£ç å±•ç¤ºäº†ä¸€ä¸ªæŸ¥æ‰¾å›è½¦ç¬¦(\r)çš„ä¾‹å­ã€‚</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">ByteBuf</span> buffer <span class="token operator">=</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">;</span><span class="token keyword">int</span> index <span class="token operator">=</span> buffer<span class="token punctuation">.</span><span class="token function">forEachByte</span><span class="token punctuation">(</span><span class="token class-name">ByteBufProcessor</span><span class="token punctuation">.</span><span class="token constant">FIND_CR</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h4 id="4-9-4-8-æ´¾ç”Ÿç¼“å†²åŒº"><a href="#4-9-4-8-æ´¾ç”Ÿç¼“å†²åŒº" class="headerlink" title="4.9.4.8 æ´¾ç”Ÿç¼“å†²åŒº"></a>4.9.4.8 æ´¾ç”Ÿç¼“å†²åŒº</h4><p>æ´¾ç”Ÿç¼“å†²åŒºä¸º ByteBuf æä¾›äº†ä»¥ä¸“é—¨çš„æ–¹å¼æ¥å‘ˆç°å…¶å†…å®¹çš„è§†å›¾ã€‚è¿™ç±»è§†å›¾æ˜¯é€šè¿‡ä»¥ä¸‹æ–¹æ³•è¢«åˆ›å»ºçš„:</p><ul><li>duplicate();</li><li>slice();</li><li>slice(int, int);</li><li>Unpooled.unmodifiableBuffer(â€¦);</li><li>order(ByteOrder);</li><li>readSlice(int)ã€‚</li></ul><p>æ¯ä¸ªè¿™äº›æ–¹æ³•éƒ½å°†è¿”å›ä¸€ä¸ª<code>æ–°çš„ ByteBuf å®ä¾‹</code>ï¼Œå®ƒå…·æœ‰è‡ªå·±çš„<code>è¯»ç´¢å¼•</code>ã€<code>å†™ç´¢å¼•</code>å’Œ<code>æ ‡è®°ç´¢å¼•</code>ã€‚å…¶å†…éƒ¨å­˜å‚¨å’Œ JDK çš„ <code>ByteBuffer</code> ä¸€æ ·ä¹Ÿæ˜¯<code>å…±äº«çš„</code>ã€‚</p><blockquote><p><code>ByteBuf å¤åˆ¶</code>å¦‚æœéœ€è¦ä¸€ä¸ªç°æœ‰ç¼“å†²åŒºçš„çœŸå®å‰¯æœ¬ï¼Œè¯·ä½¿ç”¨ <code>copy()</code>æˆ–è€… <code>copy(int, int)</code>æ–¹æ³•ã€‚ä¸åŒäºæ´¾ç”Ÿç¼“å†²åŒºï¼Œç”±è¿™ä¸ªè°ƒç”¨æ‰€è¿”å›çš„ <code>ByteBuf</code> æ‹¥æœ‰<code>ç‹¬ç«‹çš„æ•°æ®å‰¯æœ¬</code>ã€‚</p></blockquote><h4 id="4-9-4-9-å¼•ç”¨è®¡æ•°"><a href="#4-9-4-9-å¼•ç”¨è®¡æ•°" class="headerlink" title="4.9.4.9 å¼•ç”¨è®¡æ•°"></a>4.9.4.9 å¼•ç”¨è®¡æ•°</h4><p><code>å¼•ç”¨è®¡æ•°</code>æ˜¯ä¸€ç§é€šè¿‡åœ¨æŸä¸ªå¯¹è±¡æ‰€æŒæœ‰çš„èµ„æºä¸å†è¢«å…¶ä»–å¯¹è±¡å¼•ç”¨æ—¶é‡Šæ”¾è¯¥å¯¹è±¡æ‰€æŒæœ‰çš„èµ„æºæ¥ä¼˜åŒ–å†…å­˜ä½¿ç”¨å’Œæ€§èƒ½çš„æŠ€æœ¯ã€‚Netty åœ¨ç¬¬4 ç‰ˆä¸­ä¸ºByteBufå¼•å…¥äº†å¼•ç”¨è®¡æ•°æŠ€æœ¯ï¼Œ <code>interface ReferenceCounted</code>ã€‚</p><h4 id="4-9-4-10-èµ„æºé‡Šæ”¾"><a href="#4-9-4-10-èµ„æºé‡Šæ”¾" class="headerlink" title="4.9.4.10 èµ„æºé‡Šæ”¾"></a>4.9.4.10 èµ„æºé‡Šæ”¾</h4><p>å½“æŸä¸ª <code>ChannelInboundHandler</code> çš„å®ç°<code>é‡å†™ channelRead()</code>æ–¹æ³•æ—¶ï¼Œå®ƒè¦è´Ÿè´£<strong>æ˜¾å¼åœ°</strong>é‡Šæ”¾ä¸æ± åŒ–çš„ <code>ByteBuf å®ä¾‹</code>ç›¸å…³çš„å†…å­˜ã€‚</p><p>Netty ä¸ºæ­¤æä¾›äº†ä¸€ä¸ªå®ç”¨æ–¹æ³• <code>ReferenceCountUtil.release()</code>ã€‚</p><p>Netty å°†ä½¿ç”¨ <code>WARN çº§åˆ«</code>çš„<code>æ—¥å¿—æ¶ˆæ¯</code>è®°å½•<code>æœªé‡Šæ”¾</code>çš„èµ„æºï¼Œä½¿å¾—å¯ä»¥éå¸¸ç®€å•åœ°åœ¨ä»£ç ä¸­å‘ç°è¿è§„çš„å®ä¾‹ã€‚ä½†æ˜¯ä»¥è¿™ç§æ–¹å¼ç®¡ç†èµ„æºå¯èƒ½<code>å¾ˆç¹ç</code>ã€‚ä¸€ä¸ªæ›´åŠ ç®€å•çš„æ–¹å¼æ˜¯ä½¿ç”¨ <code>SimpleChannelInboundHandler</code>ï¼Œå®ƒä¼š<code>è‡ªåŠ¨é‡Šæ”¾</code>èµ„æºã€‚</p><ul><li><p>å¯¹äº<code>å…¥ç«™è¯·æ±‚</code>ï¼ŒNetty çš„ <code>EventLoop</code> åœ¨å¤„ç† Channel çš„<code>è¯»æ“ä½œ</code>æ—¶è¿›è¡Œåˆ†é… ByteBufï¼Œå¯¹äºè¿™ç±» ByteBufï¼Œéœ€è¦æˆ‘ä»¬è‡ªè¡Œè¿›è¡Œé‡Šæ”¾ï¼Œæœ‰ä¸‰ç§æ–¹å¼ï¼š</p><ul><li>ä½¿ç”¨ <code>SimpleChannelInboundHandler</code></li><li>åœ¨<code>é‡å†™ channelRead()</code>æ–¹æ³•ä½¿ç”¨ <code>ReferenceCountUtil.release()</code></li><li>ä½¿ç”¨ <code>ctx.fireChannelRead</code> ç»§ç»­å‘åä¼ é€’;</li></ul></li><li><p>å¯¹äº<code>å‡ºç«™è¯·æ±‚</code>ï¼Œä¸ç®¡ ByteBuf æ˜¯å¦ç”±æˆ‘ä»¬çš„ä¸šåŠ¡åˆ›å»ºçš„ï¼Œå½“è°ƒç”¨äº† <code>write</code> æˆ–è€… <code>writeAndFlush</code> æ–¹æ³•åï¼ŒNetty ä¼šè‡ªåŠ¨æ›¿æˆ‘ä»¬é‡Šæ”¾ï¼Œä¸éœ€è¦æˆ‘ä»¬ä¸šåŠ¡ä»£ç è‡ªè¡Œé‡Šæ”¾ã€‚</p></li></ul><p>ä¸‹ä¸€ä¸ªç« èŠ‚å°†ä¸¾ä¸ªæ —å­ï¼Œåˆè¯†ä¸‹Nettyçš„åº”ç”¨åŸºç¡€ç”¨æ³•ã€‚</p><p>å‚è€ƒèµ„æ–™ï¼š</p><ul><li>ã€ŠNetty in Actionã€‹</li></ul>]]></content>
      
      
      <categories>
          
          <category> Nettyå­¦ä¹  </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Netty </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ã€Nettyå­¦ä¹ ã€‘2.JavaåŸç”Ÿç½‘ç»œç¼–ç¨‹</title>
      <link href="/posts/1837626065.html"/>
      <url>/posts/1837626065.html</url>
      
        <content type="html"><![CDATA[<h1 id="1-å¸¸è§æœ¯è¯­"><a href="#1-å¸¸è§æœ¯è¯­" class="headerlink" title="1 å¸¸è§æœ¯è¯­"></a>1 å¸¸è§æœ¯è¯­</h1><h2 id="1-1-Socket"><a href="#1-1-Socket" class="headerlink" title="1.1 Socket"></a>1.1 Socket</h2><p><code>Socket</code> æ˜¯åº”ç”¨å±‚ä¸ <code>TCP/IP åè®®æ—</code>é€šä¿¡çš„ä¸­é—´è½¯ä»¶æŠ½è±¡å±‚ï¼Œå®ƒæ˜¯ä¸€ç»„<strong>æ¥å£</strong>ã€‚åœ¨è®¾è®¡æ¨¡å¼ ä¸­ï¼ŒSocket å…¶å®å°±æ˜¯ä¸€ä¸ª<code>é—¨é¢æ¨¡å¼</code>ï¼Œå®ƒæŠŠå¤æ‚çš„ TCP&#x2F;IP åè®®æ—éšè—åœ¨ Socket æ¥å£åé¢ï¼Œå¯¹ç”¨æˆ·æ¥è¯´ï¼Œä¸€ç»„ç®€å•çš„æ¥å£å°±æ˜¯å…¨éƒ¨ï¼Œè®© Socket å»ç»„ç»‡æ•°æ®ï¼Œä»¥ç¬¦åˆæŒ‡å®šçš„åè®®ã€‚</p><blockquote><p><strong>ä¸»æœº A</strong> çš„åº”ç”¨ç¨‹åºè¦èƒ½å’Œ<strong>ä¸»æœº B</strong> çš„åº”ç”¨ç¨‹åºé€šä¿¡ï¼Œå¿…é¡»é€šè¿‡ Socket å»ºç«‹è¿æ¥ï¼Œè€Œ<strong>å»ºç«‹ Socket è¿æ¥</strong>å¿…é¡»éœ€è¦åº•å±‚ <code>TCP/IPåè®®</code>æ¥å»ºç«‹ <code>TCP è¿æ¥</code>ã€‚å»ºç«‹ TCP è¿æ¥éœ€è¦åº•å±‚ <code>IP åè®®</code>æ¥<strong>å¯»å€</strong>ç½‘ç»œä¸­çš„ä¸»æœºã€‚æˆ‘ä»¬çŸ¥é“ç½‘ç»œå±‚ä½¿ç”¨çš„ IP åè®®å¯ä»¥å¸®åŠ©æˆ‘ä»¬æ ¹æ® IP åœ°å€æ¥æ‰¾åˆ°ç›®æ ‡ä¸»æœºï¼Œä½†æ˜¯ä¸€å°ä¸»æœºä¸Šå¯èƒ½è¿è¡Œç€å¤šä¸ªåº”ç”¨ç¨‹åºï¼Œå¦‚ä½•æ‰èƒ½ä¸æŒ‡å®šçš„åº”ç”¨ç¨‹åºé€šä¿¡å°±è¦é€šè¿‡ <code>TCP æˆ– UPD</code> çš„åœ°å€ä¹Ÿå°±æ˜¯<code>ç«¯å£å·</code>æ¥æŒ‡å®šã€‚è¿™æ ·å°±å¯ä»¥é€šè¿‡ä¸€ä¸ª Socket å®ä¾‹<strong>å”¯ä¸€</strong>ä»£è¡¨ä¸€ä¸ªä¸»æœºä¸Šçš„ä¸€ä¸ªåº”ç”¨ç¨‹åºçš„é€šä¿¡é“¾è·¯äº†ã€‚</p></blockquote><h2 id="1-2-çŸ­è¿æ¥"><a href="#1-2-çŸ­è¿æ¥" class="headerlink" title="1.2 çŸ­è¿æ¥"></a>1.2 çŸ­è¿æ¥</h2><p>çŸ­è¿æ¥è¿‡ç¨‹ï¼šè¿æ¥-&gt;ä¼ è¾“æ•°æ®-&gt;å…³é—­è¿æ¥ã€‚</p><blockquote><p>ä¼ ç»Ÿ <code>HTTP</code> æ˜¯<code>æ— çŠ¶æ€çš„</code>ï¼Œæµè§ˆå™¨å’ŒæœåŠ¡å™¨æ¯è¿›è¡Œä¸€æ¬¡ HTTP æ“ä½œï¼Œå°±å»ºç«‹ä¸€æ¬¡è¿æ¥ï¼Œä½†ä»»åŠ¡ç»“æŸå°±ä¸­æ–­è¿æ¥ã€‚</p></blockquote><blockquote><p>ä¹Ÿå¯ä»¥è¿™æ ·è¯´ï¼šçŸ­è¿æ¥æ˜¯æŒ‡ SOCKET è¿æ¥åï¼Œå‘é€åï¼Œæ¥æ”¶å®Œæ•°æ®åé©¬ä¸Šæ–­å¼€è¿æ¥ã€‚</p></blockquote><h2 id="1-3-é•¿è¿æ¥"><a href="#1-3-é•¿è¿æ¥" class="headerlink" title="1.3 é•¿è¿æ¥"></a>1.3 é•¿è¿æ¥</h2><p>è¿‡ç¨‹ï¼šè¿æ¥-&gt;ä¼ è¾“æ•°æ®-&gt;ä¿æŒè¿æ¥ -&gt; ä¼ è¾“æ•°æ®-&gt; ã€‚ã€‚ã€‚ -&gt;å…³é—­è¿æ¥ã€‚</p><blockquote><p>é•¿è¿æ¥æŒ‡å»ºç«‹ SOCKET è¿æ¥åä¸ç®¡æ˜¯å¦ä½¿ç”¨éƒ½<strong>ä¿æŒè¿æ¥</strong>ã€‚</p></blockquote><p>ä»€ä¹ˆæ—¶å€™ç”¨é•¿è¿æ¥ï¼ŒçŸ­è¿æ¥?</p><p>é•¿è¿æ¥å¤šç”¨äºæ“ä½œé¢‘ç¹ï¼Œç‚¹å¯¹ç‚¹çš„é€šè®¯ï¼Œè€Œä¸”è¿æ¥æ•°ä¸èƒ½å¤ªå¤šçš„æƒ…å†µã€‚æ¯ä¸ª TCP è¿æ¥éƒ½éœ€è¦<code>ä¸‰æ¬¡æ¡æ‰‹</code>ï¼Œè¿™éœ€è¦æ—¶é—´ï¼Œå¦‚æœæ¯ä¸ªæ“ä½œéƒ½æ˜¯å…ˆè¿æ¥ï¼Œå†æ“ä½œçš„è¯é‚£ä¹ˆå¤„ç†é€Ÿåº¦ä¼šé™ä½å¾ˆå¤šï¼Œæ‰€ä»¥æ¯ä¸ªæ“ä½œå®Œåéƒ½ä¸æ–­å¼€ï¼Œä¸‹æ¬¡å¤„ç†æ—¶ç›´æ¥å‘é€æ•°æ®åŒ…å°± OK äº†ï¼Œä¸ç”¨å»ºç«‹ TCP è¿æ¥ã€‚</p><p>ä¾‹å¦‚ï¼š<code>æ•°æ®åº“çš„è¿æ¥</code>ç”¨<code>é•¿è¿æ¥</code>ï¼Œ å¦‚æœç”¨çŸ­è¿æ¥é¢‘ç¹çš„é€šä¿¡ä¼šé€ æˆ socket é”™è¯¯ï¼Œè€Œä¸”é¢‘ç¹çš„ socket åˆ›å»ºä¹Ÿæ˜¯å¯¹èµ„æºçš„æµªè´¹ã€‚</p><p>è€ŒåƒWEBç½‘ç«™çš„<code>HTTPæœåŠ¡</code>ä¸€èˆ¬éƒ½ç”¨<code>çŸ­é“¾æ¥</code>ï¼Œå› ä¸ºé•¿è¿æ¥å¯¹äºæœåŠ¡ç«¯æ¥è¯´ä¼šè€—è´¹ä¸€å®šçš„èµ„æºï¼Œè€Œåƒ WEB ç½‘ç«™è¿™ä¹ˆé¢‘ç¹çš„æˆåƒä¸Šä¸‡ç”šè‡³ä¸Šäº¿å®¢æˆ·ç«¯çš„è¿æ¥ç”¨çŸ­è¿æ¥ä¼šæ›´çœä¸€äº›èµ„æºã€‚</p><p>æ€»ä¹‹ï¼Œé•¿è¿æ¥å’ŒçŸ­è¿æ¥çš„é€‰æ‹©è¦è§†æƒ…å†µè€Œå®šã€‚</p><h1 id="2-é€šç”¨å¸¸è¯†"><a href="#2-é€šç”¨å¸¸è¯†" class="headerlink" title="2 é€šç”¨å¸¸è¯†"></a>2 é€šç”¨å¸¸è¯†</h1><h2 id="2-1-æœåŠ¡ç«¯"><a href="#2-1-æœåŠ¡ç«¯" class="headerlink" title="2.1 æœåŠ¡ç«¯"></a>2.1 æœåŠ¡ç«¯</h2><p>åœ¨é€šä¿¡ç¼–ç¨‹é‡Œ<strong>æä¾›æœåŠ¡</strong>çš„å«<code>æœåŠ¡ç«¯</code>ã€‚</p><h2 id="2-2-å®¢æˆ·ç«¯"><a href="#2-2-å®¢æˆ·ç«¯" class="headerlink" title="2.2 å®¢æˆ·ç«¯"></a>2.2 å®¢æˆ·ç«¯</h2><p>è¿æ¥æœåŠ¡ç«¯<strong>ä½¿ç”¨æœåŠ¡</strong>çš„å«<code>å®¢æˆ·ç«¯</code>ã€‚</p><h2 id="2-3-ä¸‰ä»¶äº‹"><a href="#2-3-ä¸‰ä»¶äº‹" class="headerlink" title="2.3 ä¸‰ä»¶äº‹"></a>2.3 ä¸‰ä»¶äº‹</h2><p>åœ¨é€šä¿¡ç¼–ç¨‹é‡Œï¼Œæˆ‘ä»¬å…³æ³¨çš„å…¶å®ä¹Ÿå°±æ˜¯ä¸‰ä¸ªäº‹æƒ…ï¼š</p><ul><li>è¿æ¥(å®¢æˆ·ç«¯è¿æ¥æœåŠ¡å™¨ï¼ŒæœåŠ¡å™¨ç­‰å¾…å’Œæ¥æ”¶è¿æ¥)</li><li>è¯»ç½‘ç»œæ•°æ®</li><li>å†™ç½‘ç»œæ•°æ®</li></ul><p>æœåŠ¡ç«¯<code>æä¾› IP</code> å’Œ<code>ç›‘å¬ç«¯å£</code>ï¼Œå®¢æˆ·ç«¯é€šè¿‡è¿æ¥æ“ä½œå‘æœåŠ¡ç«¯ç›‘å¬çš„åœ°å€<code>å‘èµ·è¿æ¥è¯·æ±‚</code>ï¼Œ é€šè¿‡<code>ä¸‰æ¬¡æ¡æ‰‹</code>è¿æ¥ï¼Œå¦‚æœè¿æ¥æˆåŠŸå»ºç«‹ï¼ŒåŒæ–¹å°±å¯ä»¥é€šè¿‡å¥—æ¥å­—è¿›è¡Œé€šä¿¡ã€‚</p><h1 id="3-IOæ¨¡å‹"><a href="#3-IOæ¨¡å‹" class="headerlink" title="3 IOæ¨¡å‹"></a>3 IOæ¨¡å‹</h1><h2 id="3-0-ä»€ä¹ˆæ˜¯IOï¼Ÿ"><a href="#3-0-ä»€ä¹ˆæ˜¯IOï¼Ÿ" class="headerlink" title="3.0 ä»€ä¹ˆæ˜¯IOï¼Ÿ"></a>3.0 ä»€ä¹ˆæ˜¯IOï¼Ÿ</h2><p>IO (Input&#x2F;Outputï¼Œè¾“å…¥&#x2F;è¾“å‡º)ï¼Œå³æ•°æ®çš„<code>è¯»å–ï¼ˆæ¥æ”¶ï¼‰</code>æˆ–<code>å†™å…¥ï¼ˆå‘é€ï¼‰</code>æ“ä½œã€‚<br>é€šå¸¸ç”¨æˆ·è¿›ç¨‹ä¸­çš„ä¸€ä¸ªå®Œæ•´IOåˆ†ä¸º<code>ä¸¤é˜¶æ®µ</code>ï¼š</p><ul><li><p>ç­‰å¾…æ•°æ®å‡†å¤‡ (Waiting for the data to be ready)<br><code>IOè¯·æ±‚</code>ä¸€èˆ¬éœ€è¦è¯·æ±‚ç‰¹æ®Šçš„èµ„æºï¼ˆå¦‚ç£ç›˜ã€RAMã€æ–‡ä»¶ï¼‰ï¼Œå½“èµ„æºè¢«ä¸Šä¸€ä¸ªä½¿ç”¨è€…ä½¿ç”¨æ²¡æœ‰è¢«é‡Šæ”¾æ—¶ï¼ŒIOè¯·æ±‚å°±ä¼šè¢«<code>é˜»å¡</code>ï¼Œç›´åˆ°èƒ½å¤Ÿä½¿ç”¨è¿™ä¸ªèµ„æºã€‚ åœ¨<code>ç­‰å¾…æ•°æ®</code>é˜¶æ®µï¼ŒIOåˆ†ä¸ºï¼š</p><ul><li><code>é˜»å¡IO</code>ï¼šèµ„æºä¸å¯ç”¨æ—¶ï¼ŒIOè¯·æ±‚ä¸€ç›´é˜»å¡ï¼Œç›´åˆ°åé¦ˆç»“æœï¼ˆæœ‰æ•°æ®æˆ–è¶…æ—¶ï¼‰ã€‚</li><li><code>éé˜»å¡IO</code>ï¼šèµ„æºä¸å¯ç”¨æ—¶ï¼ŒIOè¯·æ±‚ç¦»å¼€è¿”å›ï¼Œè¿”å›æ•°æ®æ ‡è¯†èµ„æºä¸å¯ç”¨</li></ul></li><li><p>å°†æ•°æ®ä»å†…æ ¸æ‹·è´åˆ°è¿›ç¨‹ä¸­ (Copying the data from the kernel to the process)<br>çœŸæ­£è¿›è¡Œæ•°æ®æ¥æ”¶å’Œå‘ç”Ÿã€‚å°†æ•°æ®ä»å†…æ ¸æ‹·è´åˆ°ç”¨æˆ·è¿›ç¨‹ã€‚åœ¨ä½¿ç”¨èµ„æºé˜¶æ®µï¼ŒIOåˆ†ä¸ºï¼š</p><ul><li><code>åŒæ­¥IO</code>ï¼šåº”ç”¨é˜»å¡åœ¨å‘é€æˆ–æ¥æ”¶æ•°æ®çš„çŠ¶æ€ï¼Œç›´åˆ°æ•°æ®æˆåŠŸä¼ è¾“æˆ–è¿”å›å¤±è´¥ã€‚</li><li><code>å¼‚æ­¥IO</code>ï¼šåº”ç”¨å‘é€æˆ–æ¥æ”¶æ•°æ®åç«‹åˆ»è¿”å›ï¼Œæ•°æ®å†™å…¥OSç¼“å­˜ï¼Œç”±OSå®Œæˆæ•°æ®å‘é€æˆ–æ¥æ”¶ï¼Œå¹¶è¿”å›æˆåŠŸæˆ–å¤±è´¥çš„ä¿¡æ¯ç»™åº”ç”¨ã€‚</li></ul></li></ul><p><img src="https://img-blog.csdn.net/20161028200138458" alt="IOè¿‡ç¨‹"></p><p>IOæœ‰<code>å†…å­˜IO</code>ã€<code>ç½‘ç»œIO</code>å’Œ<code>ç£ç›˜IO</code>ä¸‰ç§ï¼Œé€šå¸¸æˆ‘ä»¬è¯´çš„IOæŒ‡çš„æ˜¯åä¸¤è€…ã€‚</p><p><strong>ã€ŠUNIXç½‘ç»œç¼–ç¨‹ã€‹</strong>[^1]ä½œè€…æŒ‡å‡ºï¼Œ5ç§IOæ¨¡å‹åˆ†åˆ«æ˜¯<code>é˜»å¡å¼IOæ¨¡å‹</code>ã€<code>éé˜»å¡å¼IOæ¨¡å‹</code>ã€<code>IOå¤ç”¨æ¨¡å‹</code>ã€<code>ä¿¡å·é©±åŠ¨å¼IO</code>ã€<code>å¼‚æ­¥IO</code>ï¼›å‰4ç§ä¸º<code>åŒæ­¥IO</code>æ“ä½œï¼Œåªæœ‰<code>å¼‚æ­¥IOæ¨¡å‹</code>æ˜¯<code>å¼‚æ­¥IO</code>æ“ä½œã€‚</p><h2 id="3-1-BIO"><a href="#3-1-BIO" class="headerlink" title="3.1 BIO"></a>3.1 BIO</h2><p>BIOå°±æ˜¯ï¼šBlocking IOã€‚</p><p><img src="https://cdn.jsdelivr.net/gh/zyxelva/picgo@main/markdown/BIO.png" alt="BIO"></p><p><code>åº”ç”¨ç¨‹åº</code><strong>è¯·æ±‚IOæ“ä½œ</strong>ï¼Œå¹¶ä¸€ç›´ç­‰å¾…å¤„ç†ç»“æœï¼›<code>æ“ä½œç³»ç»Ÿ</code>åŒæ—¶ä¹Ÿè¿›è¡Œ<strong>IOæ“ä½œ</strong>ï¼Œå¹¶ç­‰å¾…è®¾å¤‡çš„å¤„ç†ç»“æœï¼›å¯ä»¥çœ‹å‡ºï¼Œåº”ç”¨ç¨‹åºçš„è¯·æ±‚çº¿ç¨‹å’Œæ“ä½œç³»ç»Ÿçš„å†…æ ¸çº¿ç¨‹éƒ½æ˜¯ç­‰å¾…çŠ¶æ€ã€‚</p><ul><li><p>ä¼˜ç‚¹</p><blockquote><p>åº”ç”¨çš„ç¨‹åºå¼€å‘éå¸¸<strong>ç®€å•</strong>ï¼Œåœ¨é˜»å¡ç­‰å¾…æ•°æ®æœŸé—´ï¼Œç”¨æˆ·çº¿ç¨‹æŒ‚èµ·ï¼›åœ¨é˜»å¡æœŸé—´ï¼Œç”¨æˆ·çº¿ç¨‹åŸºæœ¬ä¸ä¼šå ç”¨CPUèµ„æºã€‚<br>å®ç°éš¾åº¦ä½ã€å¼€å‘åº”ç”¨è¾ƒå®¹æ˜“ï¼›<br>é€‚ç”¨å¹¶å‘é‡å°çš„ç½‘ç»œåº”ç”¨å¼€å‘ï¼›</p></blockquote></li><li><p>ç¼ºç‚¹</p><blockquote><p>ä¸€ä¸ªçº¿ç¨‹ç»´æŠ¤ä¸€ä¸ªè¿æ¥çš„IOæ“ä½œã€‚åœ¨å¹¶å‘é‡å°çš„æƒ…å†µä¸‹ï¼Œè¿™æ ·åšæ²¡æœ‰ä»€ä¹ˆé—®é¢˜ã€‚ä½†æ˜¯ï¼Œå½“åœ¨<strong>é«˜å¹¶å‘</strong>çš„åº”ç”¨åœºæ™¯ä¸‹ï¼Œéœ€è¦<strong>å¤§é‡</strong>çš„çº¿ç¨‹æ¥ç»´æŠ¤å¤§é‡çš„ç½‘ç»œè¿æ¥ï¼Œå†…å­˜ã€çº¿ç¨‹åˆ‡æ¢<strong>å¼€é”€ä¼šéå¸¸å·¨å¤§</strong>ã€‚</p></blockquote></li><li><p>é€‚ç”¨åœºæ™¯</p><blockquote><p>é€‚ç”¨äº<code>è¿æ¥æ•°ç›®æ¯”è¾ƒå°</code>ä¸”<code>å›ºå®š</code>çš„æ¶æ„ï¼Œè¿™ç§æ–¹å¼å¯¹æœåŠ¡å™¨èµ„æºè¦æ±‚æ¯”è¾ƒé«˜ï¼Œå¹¶å‘å±€é™äºåº”ç”¨ä¸­ï¼ŒJDK1.4ä»¥å‰çš„å”¯ä¸€é€‰æ‹©ï¼Œä½†ç¨‹åºç›´è§‚ç®€å•æ˜“ç†è§£.</p></blockquote></li></ul><h2 id="3-2-NIO"><a href="#3-2-NIO" class="headerlink" title="3.2 NIO"></a>3.2 NIO</h2><p>NIO: Non-Blocking IO.<br><img src="https://cdn.jsdelivr.net/gh/zyxelva/picgo@main/markdown/NIO.png" alt="NIO"></p><p><code>åº”ç”¨ç¨‹åº</code><strong>è¯·æ±‚IO</strong>ï¼Œå¹¶ä¸”<strong>ä¸ç”¨</strong>ä¸€ç›´<strong>ç­‰å¾…</strong>è¿”å›ç»“æœå°±å»åšå…¶ä»–äº‹æƒ…ã€‚éš”ä¸€å®šçš„å‘¨æœŸï¼Œå†å»<strong>è¯¢é—®</strong>æ“ä½œç³»ç»Ÿä¸Šæ¬¡IOæ“ä½œæœ‰æ²¡æœ‰ç»“æœï¼Œç›´åˆ°æŸä¸€æ¬¡è¯¢é—®ä»æ“ä½œç³»ç»Ÿæ‹¿åˆ°IOç»“æœï¼›<code>æ“ä½œç³»ç»Ÿ</code>å†…æ ¸çº¿ç¨‹åœ¨è¿›è¡Œ<strong>IOæ“ä½œ</strong>æ—¶ï¼Œè¿˜æ˜¯å¤„ç†ä¸€ç›´<strong>ç­‰å¾…</strong>è®¾å¤‡è¿”å›æ“ä½œç»“æœçš„çŠ¶æ€ã€‚</p><ul><li><p>ç‰¹ç‚¹</p><blockquote><p><code>åº”ç”¨ç¨‹åº</code>çš„çº¿ç¨‹éœ€è¦ä¸æ–­åœ°è¿›è¡Œ<code>IOç³»ç»Ÿè°ƒç”¨</code>ï¼Œ<code>è½®è¯¢</code>æ•°æ®æ˜¯å¦å·²ç»å‡†å¤‡å¥½ï¼Œå¦‚æœæ²¡æœ‰å‡†å¤‡å¥½ï¼Œå°±ç»§ç»­è½®è¯¢ï¼Œç›´åˆ°å®ŒæˆIOç³»ç»Ÿè°ƒç”¨ä¸ºæ­¢ã€‚</p></blockquote></li><li><p>ä¼˜ç‚¹</p><blockquote><p>æ¯æ¬¡å‘èµ·çš„IOç³»ç»Ÿè°ƒç”¨ï¼Œåœ¨å†…æ ¸ç­‰å¾…æ•°æ®è¿‡ç¨‹ä¸­å¯ä»¥<code>ç«‹å³è¿”å›</code>ã€‚ç”¨æˆ·çº¿ç¨‹<strong>ä¸ä¼šé˜»å¡</strong>ï¼Œå®æ—¶æ€§è¾ƒå¥½ï¼Œé€‚ç”¨äº<strong>è¿æ¥æ•°ç›®å¤šä¸”è¿æ¥æ¯”è¾ƒçŸ­</strong>ï¼ˆè½»æ“ä½œï¼‰çš„æ¶æ„ï¼Œæ¯”å¦‚<code>èŠå¤©æœåŠ¡å™¨</code>ï¼Œå¹¶å‘å±€é™äºåº”ç”¨ä¸­ï¼Œç¼–ç¨‹æ¯”è¾ƒå¤æ‚ï¼ŒJDK1.4å¼€å§‹æ”¯æŒã€‚Â </p></blockquote></li><li><p>ç¼ºç‚¹</p><blockquote><p>ä¸æ–­åœ°è½®è¯¢å†…æ ¸ï¼Œè¿™å°†<strong>å ç”¨å¤§é‡çš„CPUæ—¶é—´</strong>ï¼Œæ•ˆç‡ä½ä¸‹ã€‚</p></blockquote></li></ul><h2 id="3-3-IOå¤šè·¯å¤ç”¨"><a href="#3-3-IOå¤šè·¯å¤ç”¨" class="headerlink" title="3.3 IOå¤šè·¯å¤ç”¨"></a>3.3 IOå¤šè·¯å¤ç”¨</h2><p>æŒ‡çš„æ˜¯ä¸€ä¸ª<code>è¿›ç¨‹/çº¿ç¨‹</code>å¯ä»¥<strong>åŒæ—¶ç›‘è§†</strong>å¤šä¸ª<code>æ–‡ä»¶æè¿°ç¬¦</code>ï¼ˆä¸€ä¸ªç½‘ç»œè¿æ¥ï¼Œæ“ä½œç³»ç»Ÿåº•å±‚ä½¿ç”¨ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦æ¥è¡¨ç¤ºï¼‰ï¼Œä¸€æ—¦å…¶ä¸­çš„ä¸€ä¸ªæˆ–è€…å¤šä¸ªæ–‡ä»¶æè¿°ç¬¦<code>å¯è¯»æˆ–è€…å¯å†™</code>ï¼Œç³»ç»Ÿå†…æ ¸å°±<code>é€šçŸ¥</code>è¯¥è¿›ç¨‹&#x2F;çº¿ç¨‹ã€‚</p><p><img src="https://cdn.jsdelivr.net/gh/zyxelva/picgo/markdown/IO-Multiplexing.png" alt="IO Multiplexing"></p><ul><li>ç‰¹ç‚¹<blockquote><p>IOå¤šè·¯å¤ç”¨æ¨¡å‹å»ºç«‹åœ¨æ“ä½œç³»ç»Ÿçš„åŸºç¡€è®¾æ–½ä¹‹ä¸Šï¼Œå³æ“ä½œç³»ç»Ÿçš„å†…æ ¸å¿…é¡»èƒ½å¤Ÿæä¾›å¤šè·¯åˆ†ç¦»çš„ç³»ç»Ÿè°ƒç”¨ï¼Œæ¯”å¦‚select&#x2F;epollã€‚</p></blockquote></li><li>ä¼˜ç‚¹<blockquote><p>ä¸ä¸€ä¸ªçº¿ç¨‹ç»´æŠ¤ä¸€ä¸ªè¿æ¥çš„é˜»å¡IOæ¨¡å¼ç›¸æ¯”ï¼Œä½¿ç”¨select&#x2F;epollçš„æœ€å¤§ä¼˜åŠ¿åœ¨äºï¼Œ<code>ä¸€ä¸ªé€‰æ‹©å™¨</code>æŸ¥è¯¢çº¿ç¨‹å¯ä»¥<strong>åŒæ—¶</strong>å¤„ç†æˆ<strong>åƒä¸Šä¸‡ä¸ªè¿æ¥</strong>ï¼Œç³»ç»Ÿ<code>ä¸å¿…åˆ›å»º</code>å¤§é‡çš„çº¿ç¨‹ï¼Œä¹Ÿ<code>ä¸å¿…ç»´æŠ¤</code>è¿™äº›çº¿ç¨‹ï¼Œä»è€Œå¤§å¤§<strong>å‡å°äº†ç³»ç»Ÿçš„å¼€é”€</strong>ã€‚</p></blockquote></li><li>ç¼ºç‚¹<blockquote><p>æœ¬è´¨ä¸Šï¼Œselect&#x2F;epollç³»ç»Ÿè°ƒç”¨æ˜¯<code>é˜»å¡å¼çš„</code>ï¼Œå±äº<code>åŒæ­¥IO</code>ã€‚éƒ½éœ€è¦åœ¨è¯»å†™äº‹ä»¶å°±ç»ªåï¼Œç”±<code>ç³»ç»Ÿè°ƒç”¨</code>æœ¬èº«è´Ÿè´£è¿›è¡Œè¯»å†™ï¼Œä¹Ÿå°±æ˜¯è¯´è¿™ä¸ª<code>è¯»å†™è¿‡ç¨‹æ˜¯é˜»å¡çš„</code>ã€‚</p></blockquote></li></ul><p>ç›®å‰æµè¡Œçš„IOå¤šè·¯å¤ç”¨å®ç°ä¸»è¦åŒ…æ‹¬å››ç§: <code>select</code>ã€<code>poll</code>ã€<code>epoll</code>ã€<code>kqueue</code>ã€‚</p><blockquote><p>IOå¤šè·¯å¤ç”¨æŠ€æœ¯æœ€é€‚ç”¨çš„æ˜¯<strong>â€œé«˜å¹¶å‘â€</strong>åœºæ™¯ï¼Œæ‰€è°“é«˜å¹¶å‘æ˜¯æŒ‡1æ¯«ç§’å†…è‡³å°‘åŒæ—¶æœ‰ä¸Šåƒä¸ªè¿æ¥è¯·æ±‚å‡†å¤‡å¥½ã€‚å…¶ä»–æƒ…å†µä¸‹IOå¤šè·¯å¤ç”¨æŠ€æœ¯å‘æŒ¥ä¸å‡ºæ¥å®ƒçš„ä¼˜åŠ¿ã€‚å¦ä¸€æ–¹é¢ï¼Œä½¿ç”¨JAVA NIOè¿›è¡ŒåŠŸèƒ½å®ç°ï¼Œç›¸å¯¹äºä¼ ç»Ÿçš„Socketå¥—æ¥å­—å®ç°è¦å¤æ‚ä¸€äº›ï¼Œæ‰€ä»¥å®é™…åº”ç”¨ä¸­ï¼Œéœ€è¦æ ¹æ®è‡ªå·±çš„ä¸šåŠ¡éœ€æ±‚è¿›è¡ŒæŠ€æœ¯é€‰æ‹©ã€‚</p></blockquote><h2 id="3-4-ä¿¡å·é©±åŠ¨IO"><a href="#3-4-ä¿¡å·é©±åŠ¨IO" class="headerlink" title="3.4 ä¿¡å·é©±åŠ¨IO"></a>3.4 ä¿¡å·é©±åŠ¨IO</h2><p>ä¸éé˜»å¡IOç±»ä¼¼ï¼Œå…¶åœ¨<strong>æ•°æ®ç­‰å¾…é˜¶æ®µ</strong><code>å¹¶ä¸é˜»å¡</code>ï¼Œä½†æ˜¯åŸç†ä¸åŒã€‚<code>ä¿¡å·é©±åŠ¨IO</code>æ˜¯åœ¨å¥—æ¥å­—ä¸Š<code>æ³¨å†Œ</code>äº†ä¸€ä¸ª<code>ä¿¡å·è°ƒç”¨æ–¹æ³•</code>ã€‚è¿™ä¸ªæ³¨å†ŒåŠ¨ä½œä¼šå°†å†…æ ¸å‘å‡ºä¸€ä¸ªè¯·æ±‚ï¼Œåœ¨å¥—æ¥å­—çš„æ”¶åˆ°æ•°æ®æ—¶å†…æ ¸ä¼šç»™è¿›ç¨‹å‘å‡ºä¸€ä¸ª<code>sigioä¿¡å·</code>ã€‚è¯¥æ³¨å†Œè°ƒç”¨å¾ˆå¿«è¿”å›ï¼Œå› æ­¤åº”ç”¨ç¨‹åºå¯ä»¥è½¬å»å¤„ç†åˆ«çš„ä»»åŠ¡ã€‚å½“å†…æ ¸å‡†å¤‡å¥½æ•°æ®åï¼Œå°±ç»™è¿›ç¨‹å‘å‡ºäº†ä¿¡å·ã€‚è¿›ç¨‹å°±å¯ä»¥é€šè¿‡<code>recvfromè°ƒç”¨</code>æ¥è¯»å–æ•°æ®ã€‚å…¶æ¨¡å‹å¦‚ä¸‹ï¼š</p><p><img src="https://cdn.jsdelivr.net/gh/zyxelva/picgo@main/markdown/Signal-driven-IO.png" alt="ä¿¡å·é©±åŠ¨IOæ¨¡å‹"></p><ul><li>ä¼˜ç‚¹ï¼šåœ¨æ•°æ®åŒ…åˆ°è¾¾ä¹‹å‰ï¼Œè¿›ç¨‹ä¸ä¼šè¢«é˜»å¡ã€‚è€Œä¸”é‡‡ç”¨<code>é€šçŸ¥</code>çš„æ–¹å¼ä¹Ÿé¿å…äº†è½®è®­å¸¦æ¥çš„æŸè€—ã€‚</li></ul><p>è¿™ç§æ¨¡å‹åœ¨Javaä¸­å¹¶æ²¡æœ‰å¯¹åº”çš„å®ç°ã€‚</p><h2 id="3-5-AIO"><a href="#3-5-AIO" class="headerlink" title="3.5 AIO"></a>3.5 AIO</h2><p>å¼‚æ­¥IOåˆ™æ˜¯é‡‡ç”¨â€œè®¢é˜…-é€šçŸ¥â€æ¨¡å¼: å³åº”ç”¨ç¨‹åºå‘æ“ä½œç³»ç»Ÿæ³¨å†ŒIOç›‘å¬ï¼Œç„¶åç»§ç»­åšè‡ªå·±çš„äº‹æƒ…ã€‚å½“æ“ä½œç³»ç»Ÿå‘ç”ŸIOäº‹ä»¶ï¼Œå¹¶ä¸”å‡†å¤‡å¥½æ•°æ®åï¼Œåœ¨ä¸»åŠ¨é€šçŸ¥åº”ç”¨ç¨‹åºï¼Œè§¦å‘ç›¸åº”çš„å‡½æ•°ã€‚<br><img src="https://cdn.jsdelivr.net/gh/zyxelva/picgo@main/markdown/AIO.png" alt="AIO"></p><ul><li><p>ç‰¹ç‚¹</p><blockquote><p>é€‚ç”¨äº<strong>è¿æ¥æ•°ç›®å¤šä¸”è¿æ¥æ¯”è¾ƒé•¿</strong>ï¼ˆé‡æ“ä½œï¼‰çš„æ¶æ„ï¼Œæ¯”å¦‚<code>ç›¸å†ŒæœåŠ¡å™¨</code>ï¼Œå……åˆ†è°ƒç”¨OSå‚ä¸å¹¶å‘æ“ä½œï¼Œç¼–ç¨‹æ¯”è¾ƒå¤æ‚ï¼ŒJDK7å¼€å§‹æ”¯æŒ</p></blockquote></li><li><p>ä¼˜ç‚¹</p><blockquote><p>åœ¨å†…æ ¸<code>ç­‰å¾…æ•°æ®</code>å’Œ<code>å¤åˆ¶æ•°æ®</code>çš„ä¸¤ä¸ªé˜¶æ®µï¼Œç”¨æˆ·çº¿ç¨‹<strong>éƒ½ä¸æ˜¯é˜»å¡çš„</strong>ã€‚ç”¨æˆ·çº¿ç¨‹éœ€è¦æ¥æ”¶å†…æ ¸çš„IOæ“ä½œå®Œæˆçš„äº‹ä»¶ï¼Œæˆ–è€…ç”¨æˆ·çº¿ç¨‹éœ€è¦<code>æ³¨å†Œ</code>ä¸€ä¸ªIOæ“ä½œå®Œæˆçš„<code>å›è°ƒå‡½æ•°</code></p></blockquote></li><li><p>ç¼ºç‚¹</p><blockquote><p>åº”ç”¨ç¨‹åºä»…éœ€è¦è¿›è¡Œ<strong>äº‹ä»¶çš„æ³¨å†Œä¸æ¥æ”¶</strong>ï¼Œå…¶ä½™çš„å·¥ä½œéƒ½ç•™ç»™äº†æ“ä½œç³»ç»Ÿï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œéœ€è¦åº•å±‚å†…æ ¸æä¾›æ”¯æŒã€‚Windowsç³»ç»Ÿä¸‹é€šè¿‡IOCPå®ç°äº†çœŸæ­£çš„å¼‚æ­¥IOã€‚è€Œåœ¨Linuxç³»ç»Ÿä¸‹ï¼Œå¼‚æ­¥IOæ¨¡å‹åœ¨2.6ç‰ˆæœ¬æ‰å¼•å…¥ï¼Œç›®å‰å¹¶ä¸å®Œå–„ï¼Œå…¶åº•å±‚å®ç°ä»ä½¿ç”¨epollï¼Œä¸IOå¤šè·¯å¤ç”¨ç›¸åŒï¼Œå› æ­¤åœ¨æ€§èƒ½ä¸Šæ²¡æœ‰æ˜æ˜¾çš„ä¼˜åŠ¿ã€‚</p></blockquote></li></ul><p>ä¸ä¿¡å·é©±åŠ¨ IO ç›¸æ¯”ï¼Œ<strong>æœ€å¤§çš„ä¸åŒ</strong>åœ¨äº<code>ä¿¡å·é©±åŠ¨ IO</code>æ˜¯å†…æ ¸é€šçŸ¥åº”ç”¨ç¨‹åº<code>å¯ä»¥è¯»å–æ•°æ®äº†</code>ï¼›è€Œ<code>å¼‚æ­¥IO</code>æ˜¯å†…æ ¸é€šçŸ¥åº”ç”¨ç¨‹åºæ•°æ®<code>å·²ç»è¯»å–å®Œæ¯•äº†</code>ã€‚</p><p>å‚è§å¤§ç¥çš„è®²è§£<a href="https://yinwj.blog.csdn.net/article/details/48784375">æ¶æ„è®¾è®¡ï¼šç³»ç»Ÿé—´é€šä¿¡ï¼ˆ5ï¼‰â€”â€”IOé€šä¿¡æ¨¡å‹å’ŒJAVAå®è·µ ä¸‹ç¯‡</a>ã€‚</p><h2 id="3-6-å¯¹æ¯”"><a href="#3-6-å¯¹æ¯”" class="headerlink" title="3.6 å¯¹æ¯”"></a>3.6 å¯¹æ¯”</h2><p>æ¥çœ‹ä¸‹äº”ç§ IO æ¨¡å‹çš„å¯¹æ¯”ï¼Œå¦‚ä¸‹ï¼š<br><img src="https://cdn.jsdelivr.net/gh/zyxelva/picgo@main/markdown/IO-Comparison.png" alt="äº”ç§ IO æ¨¡å‹å¯¹æ¯”"></p><h1 id="4-åŸç”Ÿç½‘ç»œç¼–ç¨‹"><a href="#4-åŸç”Ÿç½‘ç»œç¼–ç¨‹" class="headerlink" title="4 åŸç”Ÿç½‘ç»œç¼–ç¨‹"></a>4 åŸç”Ÿç½‘ç»œç¼–ç¨‹</h1><h2 id="4-1-BIO"><a href="#4-1-BIO" class="headerlink" title="4.1 BIO"></a>4.1 BIO</h2><p><img src="https://cdn.jsdelivr.net/gh/zyxelva/picgo@main/markdown/BIO2.png" alt="BIO"></p><ul><li>åº”ç”¨-RPC<blockquote><p>RPCï¼ˆRemote Procedure Call è¿œç¨‹è¿‡ç¨‹è°ƒç”¨ï¼‰ æ¡†æ¶ï¼Œæ˜¯ä¸€ç§é€šè¿‡ç½‘ç»œä»è¿œç¨‹è®¡ç®—æœºç¨‹åºä¸Šè¯·æ±‚æœåŠ¡ï¼Œè€Œä¸éœ€è¦äº†è§£åº•å±‚ç½‘ç»œçš„æŠ€æœ¯ã€‚<br><img src="https://cdn.jsdelivr.net/gh/zyxelva/picgo@main/markdown/RPC.png" alt="RPC"></p></blockquote></li></ul><h2 id="4-2-NIO"><a href="#4-2-NIO" class="headerlink" title="4.2 NIO"></a>4.2 NIO</h2><h3 id="4-2-1-é‡è¦æ¦‚å¿µ"><a href="#4-2-1-é‡è¦æ¦‚å¿µ" class="headerlink" title="4.2.1 é‡è¦æ¦‚å¿µ"></a>4.2.1 é‡è¦æ¦‚å¿µ</h3><ul><li><p>Selector é€‰æ‹©å™¨</p><ul><li>ä¸€ä¸ªIOäº‹ä»¶çš„æŸ¥è¯¢å™¨ã€‚</li><li>ä½œç”¨ï¼šä¸€ä¸ªçº¿ç¨‹å¯ä»¥æŸ¥è¯¢å¤šä¸ªé€šé“çš„IOäº‹ä»¶çš„å°±ç»ªçŠ¶æ€ã€‚</li><li>æœ€å¤§ä¼˜åŠ¿ï¼šç³»ç»Ÿå¼€é”€å°ï¼Œç³»ç»Ÿä¸å¿…ä¸ºæ¯ä¸€ä¸ªç½‘ç»œè¿æ¥ï¼ˆæ–‡ä»¶æè¿°ç¬¦ï¼‰åˆ›å»ºè¿›ç¨‹&#x2F;çº¿ç¨‹ï¼Œä»è€Œå¤§å¤§å‡å°äº†ç³»ç»Ÿçš„å¼€é”€ã€‚</li></ul></li><li><p>Channel ç®¡é“</p><ul><li>ç›¸å½“äºOIO(Old IOçš„ socket)ï¼›OIOæœ‰ä¸¤ä¸ªæµï¼š<code>è¾“å…¥æµ</code>ï¼Œ<code>è¾“å‡ºæµ</code>ã€‚</li><li>NIOä¸­ç½‘ç»œè¿æ¥ä½¿ç”¨channelï¼Œä¸”åªæœ‰ä¸€ä¸ªï¼Œ<code>åŒå·¥çš„</code>ã€‚</li></ul></li><li><p>Buffer ç¼“å†²åŒº</p><ul><li>åº”ç”¨ç¨‹åºä¸é€šé“ï¼ˆChannelï¼‰ä¸»è¦çš„äº¤äº’æ“ä½œï¼Œå°±æ˜¯è¿›è¡Œæ•°æ®çš„<code>readè¯»å–</code>å’Œ<code>writeå†™å…¥</code>ã€‚</li><li>é€šé“çš„è¯»å–ï¼Œå°±æ˜¯å°†æ•°æ®ä»<code>é€šé“</code>ä¸­<code>è¯»å–</code>åˆ°<code>ç¼“å†²åŒº</code>ä¸­ã€‚</li><li>é€šé“çš„å†™å…¥ï¼Œå°±æ˜¯å°†æ•°æ®ä»<code>ç¼“å†²åŒº</code>ä¸­<code>å†™å…¥</code>åˆ°<code>é€šé“</code>ä¸­ã€‚</li></ul></li></ul><p><img src="https://cdn.jsdelivr.net/gh/zyxelva/picgo@main/markdown/IO-Multiplexing-Flow.png" alt="IO Multiplexing Flow"></p><h3 id="4-2-2-NIO-ä¹‹Reactor-æ¨¡å¼"><a href="#4-2-2-NIO-ä¹‹Reactor-æ¨¡å¼" class="headerlink" title="4.2.2 NIO ä¹‹Reactor æ¨¡å¼"></a>4.2.2 NIO ä¹‹Reactor æ¨¡å¼</h3><blockquote><p>â€œå¥½è±åæ³•åˆ™â€ï¼ˆä¸è¦è°ƒç”¨æˆ‘ï¼Œè®©æˆ‘æ¥è°ƒç”¨ä½ ï¼‰ï¼šå…·ä½“äº‹ä»¶å¤„ç†ç¨‹åºä¸è°ƒç”¨ååº”å™¨ï¼Œè€Œå‘ååº”å™¨æ³¨å†Œä¸€ä¸ªäº‹ä»¶å¤„ç†å™¨ï¼Œè¡¨ç¤ºè‡ªå·±å¯¹æŸäº›äº‹ä»¶æ„Ÿå…´è¶£ï¼Œæœ‰æ—¶é—´æ¥äº†ï¼Œå…·ä½“äº‹ä»¶å¤„ç†ç¨‹åºé€šè¿‡äº‹ä»¶å¤„ç†å™¨å¯¹æŸä¸ªæŒ‡å®šçš„äº‹ä»¶å‘ç”Ÿåšå‡ºååº”ã€‚</p></blockquote><ul><li><p>Acceptor</p><ul><li>å¤„ç†å®¢æˆ·ç«¯æ–°è¿æ¥ï¼Œå¹¶åˆ†æ´¾è¯·æ±‚åˆ°å¤„ç†å™¨é“¾ä¸­ã€‚</li></ul></li><li><p>Reactor</p><ul><li>è´Ÿè´£ç›‘å¬å’Œåˆ†é…äº‹ä»¶ï¼Œå°†I&#x2F;Oäº‹ä»¶åˆ†æ´¾ç»™å¯¹åº”çš„Handlerã€‚</li><li>æ–°çš„äº‹ä»¶åŒ…å«è¿æ¥å»ºç«‹å°±ç»ªã€è¯»å°±ç»ªã€å†™å°±ç»ªç­‰ã€‚</li></ul></li><li><p>Handler</p><ul><li>å°†è‡ªèº«ä¸äº‹ä»¶ç»‘å®šï¼Œæ‰§è¡Œéé˜»å¡è¯»&#x2F;å†™ä»»åŠ¡ï¼Œå®Œæˆchannelçš„è¯»å…¥ï¼Œå®Œæˆå¤„ç†ä¸šåŠ¡é€»è¾‘åï¼Œè´Ÿè´£å°†ç»“æœå†™å‡ºchannelã€‚</li><li>å¯ç”¨èµ„æºæ± æ¥ç®¡ç†ã€‚</li></ul></li></ul><p><code>å•Reactor-å•çº¿ç¨‹</code></p><blockquote><p>å‰å°æ¥å¾…å‘˜å’ŒæœåŠ¡å‘˜æ˜¯åŒä¸€ä¸ªäººï¼Œå…¨ç¨‹ä¸ºé¡¾å®¢æœåŠ¡.</p></blockquote><ul><li>è¿‡ç¨‹<ul><li>æœåŠ¡å™¨ç«¯çš„ <code>Reactor</code> æ˜¯<strong>ä¸€ä¸ªçº¿ç¨‹å¯¹è±¡</strong>ï¼Œè¯¥çº¿ç¨‹ä¼šå¯åŠ¨äº‹ä»¶å¾ªç¯ï¼Œå¹¶ä½¿ç”¨ <code>Selector(é€‰æ‹©å™¨)</code>æ¥å®ç° <code>IOå¤šè·¯å¤ç”¨</code>ã€‚<code>æ³¨å†Œ</code>ä¸€ä¸ª <code>Acceptoräº‹ä»¶å¤„ç†å™¨</code>åˆ° Reactor ä¸­ï¼ŒAcceptor äº‹ä»¶å¤„ç†å™¨æ‰€å…³æ³¨çš„äº‹ä»¶æ˜¯ <code>ACCEPTäº‹ä»¶</code>ï¼Œè¿™æ · Reactor ä¼š<code>ç›‘å¬</code>å®¢æˆ·ç«¯å‘æœåŠ¡å™¨ç«¯å‘èµ·çš„<code>è¿æ¥è¯·æ±‚äº‹ä»¶</code>(ACCEPT äº‹ä»¶)ã€‚</li><li>å®¢æˆ·ç«¯å‘æœåŠ¡å™¨ç«¯å‘èµ·ä¸€ä¸ª<code>è¿æ¥è¯·æ±‚</code>ï¼ŒReactor<code>ç›‘å¬</code>åˆ°äº†è¯¥ <code>ACCEPTäº‹ä»¶</code>çš„å‘ç”Ÿå¹¶å°†è¯¥ ACCEPT äº‹ä»¶æ´¾å‘ç»™ç›¸åº”çš„ <code>Acceptorå¤„ç†å™¨</code>æ¥è¿›è¡Œå¤„ç†ã€‚Acceptor å¤„ç†å™¨é€šè¿‡ <code>accept()æ–¹æ³•</code>å¾—åˆ°ä¸è¿™ä¸ªå®¢æˆ·ç«¯å¯¹åº”çš„<code>è¿æ¥(SocketChannel)</code>ï¼Œç„¶åå°†è¯¥è¿æ¥æ‰€å…³æ³¨çš„ <code>READäº‹ä»¶</code>ä»¥åŠå¯¹åº”çš„ <code>READäº‹ä»¶å¤„ç†å™¨</code><strong>æ³¨å†Œ</strong>åˆ° Reactor ä¸­ï¼Œè¿™æ ·ä¸€æ¥ Reactor å°±ä¼šç›‘å¬è¯¥è¿æ¥çš„ READ äº‹ä»¶äº†ã€‚</li><li>å½“ Reactor <strong>ç›‘å¬</strong>åˆ°æœ‰<code>è¯»æˆ–è€…å†™äº‹ä»¶</code>å‘ç”Ÿæ—¶ï¼Œå°†ç›¸å…³çš„äº‹ä»¶æ´¾å‘ç»™å¯¹åº”çš„å¤„ç†å™¨è¿›è¡Œå¤„ç†ã€‚æ¯”å¦‚ï¼Œè¯»å¤„ç†å™¨ä¼šé€šè¿‡ <code>SocketChannel</code> çš„ <code>read()</code>æ–¹æ³•è¯»å–æ•°æ®ï¼Œæ­¤æ—¶ read()æ“ä½œå¯ä»¥ç›´æ¥è¯»å–åˆ°æ•°æ®ï¼Œè€Œä¸ä¼šå µå¡ä¸ç­‰å¾…å¯è¯»çš„æ•°æ®åˆ°æ¥ã€‚</li><li>æ¯å½“å¤„ç†å®Œæ‰€æœ‰<strong>å°±ç»ªçš„ã€æ„Ÿå…´è¶£çš„</strong> <code>I/O äº‹ä»¶</code>åï¼ŒReactor çº¿ç¨‹ä¼š<strong>å†æ¬¡</strong>æ‰§è¡Œ <code>select()</code>é˜»å¡ç­‰å¾…æ–°çš„äº‹ä»¶å°±ç»ªå¹¶å°†å…¶åˆ†æ´¾ç»™å¯¹åº”å¤„ç†å™¨è¿›è¡Œå¤„ç†ã€‚</li></ul></li></ul><p><strong>æ³¨æ„</strong>ï¼ŒReactor çš„å•çº¿ç¨‹æ¨¡å¼çš„å•çº¿ç¨‹ä¸»è¦æ˜¯é’ˆå¯¹äº <code>I/O æ“ä½œ</code>è€Œè¨€ï¼Œä¹Ÿå°±æ˜¯æ‰€æœ‰çš„ I&#x2F;O çš„ <code>accept()</code>ã€<code>read()</code>ã€<code>write()</code>ä»¥åŠ <code>connect()</code>æ“ä½œéƒ½åœ¨<strong>ä¸€ä¸ªçº¿ç¨‹</strong>ä¸Šå®Œæˆçš„ã€‚<br>ä½†åœ¨ç›®å‰çš„å•çº¿ç¨‹ Reactor æ¨¡å¼ä¸­ï¼Œä¸ä»… <code>I/O æ“ä½œ</code>åœ¨è¯¥ Reactor çº¿ç¨‹ä¸Šï¼Œè¿<code>é I/O çš„ä¸šåŠ¡æ“ä½œ</code>ä¹Ÿåœ¨è¯¥çº¿ç¨‹ä¸Šè¿›è¡Œå¤„ç†äº†ï¼Œè¿™å¯èƒ½ä¼šå¤§å¤§<strong>å»¶è¿Ÿ</strong> I&#x2F;O è¯·æ±‚çš„å“åº”ã€‚æ‰€ä»¥æˆ‘ä»¬åº”è¯¥å°†é I&#x2F;O çš„ä¸šåŠ¡é€»è¾‘æ“ä½œä» Reactor çº¿ç¨‹ä¸Šå¸è½½ï¼Œä»¥æ­¤æ¥åŠ é€Ÿ Reactor çº¿ç¨‹å¯¹ I&#x2F;O è¯·æ±‚çš„å“åº”ã€‚</p><p><img src="https://cdn.jsdelivr.net/gh/zyxelva/picgo@main/markdown/Single-Reactor-Mono-Thread.png" alt="å•Reactor-å•çº¿ç¨‹"></p><p><code>å•Reactor-å¤šçº¿ç¨‹</code></p><blockquote><p>1ä¸ªå‰å°æ¥å¾…å‘˜ï¼Œå¤šä¸ªæœåŠ¡å‘˜ï¼Œæ¥å¾…å‘˜åªè´Ÿè´£æ¥å¾….</p></blockquote><ul><li><p>å°†éI&#x2F;O æ“ä½œä»Reactorçº¿ç¨‹ä¸­ç§»å‡ºè½¬äº¤ç»™å·¥ä½œè€…çº¿ç¨‹æ± æ¥æ‰§è¡Œ.</p></li><li><p>å¯¹äº<code>é«˜è´Ÿè½½</code>ã€<code>å¤§å¹¶å‘</code>æˆ–<code>å¤§æ•°æ®é‡</code>çš„åº”ç”¨åœºæ™¯å´<code>ä¸åˆé€‚</code>.</p></li><li><p>ä½¿ç”¨çº¿ç¨‹æ± çš„ä¼˜åŠ¿</p><ul><li>é€šè¿‡<strong>é‡ç”¨</strong>ç°æœ‰çš„çº¿ç¨‹è€Œä¸æ˜¯åˆ›å»ºæ–°çº¿ç¨‹ï¼Œå¯ä»¥åœ¨å¤„ç†å¤šä¸ªè¯·æ±‚æ—¶åˆ†æ‘Šåœ¨<code>çº¿ç¨‹åˆ›å»º</code>å’Œ<code>é”€æ¯</code>è¿‡ç¨‹äº§ç”Ÿçš„<code>å·¨å¤§å¼€é”€</code>ã€‚</li><li>å¦ä¸€ä¸ªé¢å¤–çš„å¥½å¤„æ˜¯ï¼Œå½“è¯·æ±‚åˆ°è¾¾æ—¶ï¼Œå·¥ä½œçº¿ç¨‹é€šå¸¸å·²ç»å­˜åœ¨ï¼Œå› æ­¤<strong>ä¸ä¼š</strong>ç”±äºç­‰å¾…åˆ›å»ºçº¿ç¨‹è€Œå»¶è¿Ÿä»»åŠ¡çš„æ‰§è¡Œï¼Œä»è€Œ<strong>æé«˜äº†å“åº”æ€§</strong>ã€‚</li><li>é€šè¿‡é€‚å½“è°ƒæ•´çº¿ç¨‹æ± çš„å¤§å°ï¼Œå¯ä»¥åˆ›å»ºè¶³å¤Ÿå¤šçš„çº¿ç¨‹ä»¥ä¾¿å¤„ç†å™¨<strong>ä¿æŒå¿™ç¢ŒçŠ¶æ€</strong>ã€‚ åŒæ—¶è¿˜å¯ä»¥é˜²æ­¢è¿‡å¤šçº¿ç¨‹ç›¸äº’ç«äº‰èµ„æºè€Œä½¿åº”ç”¨ç¨‹åºè€—å°½å†…å­˜æˆ–å¤±è´¥ã€‚</li></ul></li></ul><p>æ”¹è¿›çš„ç‰ˆæœ¬ä¸­ï¼Œæ‰€æœ‰çš„ <code>I/O æ“ä½œ</code>ä¾æ—§ç”±<strong>ä¸€ä¸ª Reactor</strong> æ¥å®Œæˆï¼ŒåŒ…æ‹¬ I&#x2F;O çš„ <code>accept()</code>ã€<code>read()</code>ã€ <code>write()</code>ä»¥åŠ <code>connect()</code>æ“ä½œã€‚</p><p>å¯¹äºä¸€äº›<strong>å°å®¹é‡</strong>åº”ç”¨åœºæ™¯ï¼Œå¯ä»¥ä½¿ç”¨å•çº¿ç¨‹æ¨¡å‹ã€‚ä½†æ˜¯å¯¹äº<code>é«˜è´Ÿè½½</code>ã€<code>å¤§å¹¶å‘</code>æˆ–<code>å¤§æ•°æ®é‡</code>çš„åº”ç”¨åœºæ™¯å´ä¸åˆé€‚ï¼Œ<strong>ä¸»è¦åŸå› </strong>å¦‚ä¸‹:</p><ul><li>ä¸€ä¸ª <code>NIO çº¿ç¨‹</code><strong>åŒæ—¶å¤„ç†</strong>æˆç™¾ä¸Šåƒçš„é“¾è·¯ï¼Œæ€§èƒ½ä¸Š<strong>æ— æ³•æ”¯æ’‘</strong>ï¼Œå³ä¾¿ NIO çº¿ç¨‹çš„ CPU è´Ÿè·è¾¾åˆ°100%ï¼Œä¹Ÿ<strong>æ— æ³•æ»¡è¶³</strong>æµ·é‡æ¶ˆæ¯çš„è¯»å–å’Œå‘é€;</li><li>å½“ <code>NIO çº¿ç¨‹</code>è´Ÿè½½è¿‡é‡ä¹‹åï¼Œå¤„ç†é€Ÿåº¦å°†å˜æ…¢ï¼Œè¿™ä¼šå¯¼è‡´å¤§é‡å®¢æˆ·ç«¯<code>è¿æ¥è¶…æ—¶</code>ï¼Œè¶…æ—¶ä¹‹åå¾€å¾€ä¼šè¿›è¡Œ<code>é‡å‘</code>ï¼Œè¿™<strong>æ›´åŠ é‡</strong>äº† NIO çº¿ç¨‹çš„è´Ÿè½½ï¼Œæœ€ç»ˆä¼šå¯¼è‡´<code>å¤§é‡æ¶ˆæ¯ç§¯å‹</code>å’Œ<code>å¤„ç†è¶…æ—¶</code>ï¼Œ æˆä¸ºç³»ç»Ÿçš„æ€§èƒ½ç“¶é¢ˆã€‚</li></ul><p><img src="https://cdn.jsdelivr.net/gh/zyxelva/picgo@main/markdown/Single-Reactor-Multi-Thread.png" alt="å•Reactor-å¤šçº¿ç¨‹"></p><p><code>ä¸»ä»å¤šçº¿ç¨‹Reactoræ¨¡å¼</code></p><blockquote><p>1ä¸ªå¤§å ‚ç»ç†ï¼Œå¤šä¸ªå‰å°æ¥å¾…å‘˜ï¼Œå¤šä¸ªæœåŠ¡å‘˜.</p></blockquote><ul><li><p>è¿‡ç¨‹</p><ul><li><strong>æ³¨å†Œ</strong>ä¸€ä¸ª <code>Acceptor äº‹ä»¶å¤„ç†å™¨</code>åˆ° <code>mainReactor</code> ä¸­ï¼ŒAcceptor äº‹ä»¶å¤„ç†å™¨æ‰€å…³æ³¨çš„äº‹ä»¶æ˜¯ <code>ACCEPT äº‹ä»¶</code>ï¼Œè¿™æ · mainReactor ä¼š<strong>ç›‘å¬</strong>å®¢æˆ·ç«¯å‘æœåŠ¡å™¨ç«¯å‘èµ·çš„è¿æ¥è¯·æ±‚äº‹ä»¶(ACCEPT äº‹ä»¶)ã€‚å¯åŠ¨ mainReactor çš„äº‹ä»¶å¾ªç¯ã€‚</li><li>å®¢æˆ·ç«¯å‘æœåŠ¡å™¨ç«¯<strong>å‘èµ·</strong>ä¸€ä¸ª<code>è¿æ¥è¯·æ±‚</code>ï¼Œ<code>mainReactor</code> <strong>ç›‘å¬</strong>åˆ°äº†è¯¥ <code>ACCEPT äº‹ä»¶</code>å¹¶å°†è¯¥ ACCEPT äº‹ä»¶æ´¾å‘ç»™ <code>Acceptor å¤„ç†å™¨</code>æ¥è¿›è¡Œå¤„ç†ã€‚Acceptor å¤„ç†å™¨é€šè¿‡ <code>accept()æ–¹æ³•</code>å¾—åˆ°ä¸è¿™ä¸ªå®¢æˆ·ç«¯å¯¹åº”çš„<code>è¿æ¥(SocketChannel)</code>ï¼Œç„¶åå°†è¿™ä¸ª SocketChannel ä¼ é€’ç»™ <code>subReactor çº¿ç¨‹æ± </code>ã€‚</li><li><code>subReactor çº¿ç¨‹æ± </code>åˆ†é…ä¸€ä¸ª <code>subReactor çº¿ç¨‹</code>ç»™è¿™ä¸ª <code>SocketChannel</code>ï¼Œå³ï¼Œå°† SocketChannel å…³æ³¨çš„ <code>READ äº‹ä»¶</code>ä»¥åŠå¯¹åº”çš„ <code>READ äº‹ä»¶å¤„ç†å™¨</code><strong>æ³¨å†Œ</strong>åˆ° <code>subReactor çº¿ç¨‹</code>ä¸­ã€‚å½“ç„¶ä¹Ÿæ³¨å†Œ <code>WRITE äº‹ä»¶</code>ä»¥åŠ <code>WRITE äº‹ä»¶å¤„ç†å™¨</code>åˆ° <code>subReactor çº¿ç¨‹</code>ä¸­ä»¥å®Œæˆ <code>I/O å†™æ“ä½œ</code>ã€‚ <code>Reactor çº¿ç¨‹æ± </code>ä¸­çš„æ¯ä¸€ä¸ª<code>Reactor çº¿ç¨‹</code>éƒ½ä¼šæœ‰è‡ªå·±çš„ <code>Selector</code>ã€<code>çº¿ç¨‹</code>å’Œ<code>åˆ†å‘</code>çš„å¾ªç¯é€»è¾‘ã€‚</li><li>å½“æœ‰ <code>I/O äº‹ä»¶</code><strong>å°±ç»ª</strong>æ—¶ï¼Œç›¸å…³çš„ <code>subReactor</code>å°±å°†äº‹ä»¶<strong>æ´¾å‘</strong>ç»™ç›¸åº”çš„å¤„ç†å™¨å¤„ç†ã€‚<strong>æ³¨æ„</strong>ï¼Œè¿™é‡Œ <code>subReactor çº¿ç¨‹</code><strong>åªè´Ÿè´£</strong>å®Œæˆ I&#x2F;O çš„<code>read()æ“ä½œ</code>ï¼Œåœ¨è¯»å–åˆ°æ•°æ®åå°†ä¸šåŠ¡é€»è¾‘çš„å¤„ç†æ”¾å…¥åˆ°<code>çº¿ç¨‹æ± </code>ä¸­å®Œæˆï¼Œè‹¥å®Œæˆä¸šåŠ¡é€»è¾‘åéœ€è¦è¿”å›æ•°æ®ç»™å®¢æˆ·ç«¯ï¼Œåˆ™ç›¸å…³çš„ I&#x2F;O çš„ <code>write æ“ä½œ</code>è¿˜æ˜¯ä¼š<strong>è¢«æäº¤å›</strong> <code>subReactor çº¿ç¨‹</code>æ¥å®Œæˆã€‚</li></ul></li><li><p>mainReactor å¯ä»¥<code>åªæœ‰ä¸€ä¸ª</code>ï¼Œä½†subReactor <code>ä¸€èˆ¬ä¼šæœ‰å¤šä¸ª</code>.</p></li><li><p>mainReactor çº¿ç¨‹ä¸»è¦è´Ÿè´£<strong>æ¥æ”¶å®¢æˆ·ç«¯çš„è¿æ¥è¯·æ±‚</strong>ï¼Œç„¶åå°†æ¥æ”¶åˆ°çš„<code>SocketChannel</code>ä¼ é€’ç»™<code>subReactor</code>ï¼Œç”±<code>subReactor</code>æ¥å®Œæˆå’Œå®¢æˆ·ç«¯çš„é€šä¿¡.</p></li><li><p>æ‰€æœ‰çš„<code>I/Oæ“ä½œ</code>(åŒ…æ‹¬ I&#x2F;O çš„<code>accept()</code>ã€<code>read()</code>ã€<code>write()</code>ä»¥åŠ<code>connect()</code>æ“ä½œ)ä¾æ—§è¿˜æ˜¯åœ¨<code>Reactorçº¿ç¨‹</code>(mainReactor çº¿ç¨‹æˆ–subReactor çº¿ç¨‹)ä¸­å®Œæˆçš„.</p></li><li><p><code>Thread Pool(çº¿ç¨‹æ± )</code>ä»…ç”¨æ¥å¤„ç†<code>éI/O æ“ä½œ</code>çš„é€»è¾‘.</p></li></ul><p><img src="https://cdn.jsdelivr.net/gh/zyxelva/picgo@main/markdown/Master-Slave-Multi-Thread-Reactor.png" alt="ä¸»ä»å¤šçº¿ç¨‹Reactoræ¨¡å¼"></p><p>Nettyä¸­çš„Reactoræ¶æ„ï¼š<br><img src="https://cdn.jsdelivr.net/gh/zyxelva/picgo@main/markdown/Netty-Reactor.png" alt="Nettyä¸­çš„Reactor"></p><h3 id="4-2-3-JAVAå¯¹IOå¤šè·¯å¤ç”¨çš„æ”¯æŒ"><a href="#4-2-3-JAVAå¯¹IOå¤šè·¯å¤ç”¨çš„æ”¯æŒ" class="headerlink" title="4.2.3 JAVAå¯¹IOå¤šè·¯å¤ç”¨çš„æ”¯æŒ"></a>4.2.3 JAVAå¯¹IOå¤šè·¯å¤ç”¨çš„æ”¯æŒ</h3><p><img src="https://img-blog.csdn.net/20150924091829616" alt="JAVA IOå¤šè·¯å¤ç”¨å®ç°"></p><p><img src="https://img-blog.csdn.net/20150922120210682" alt="JAVA NIO Selectorå®ç°æ¥å£"></p><h3 id="4-2-4-IOå¤šè·¯å¤ç”¨çš„ä¼˜ç¼ºç‚¹-2"><a href="#4-2-4-IOå¤šè·¯å¤ç”¨çš„ä¼˜ç¼ºç‚¹-2" class="headerlink" title="4.2.4 IOå¤šè·¯å¤ç”¨çš„ä¼˜ç¼ºç‚¹[^2]"></a>4.2.4 IOå¤šè·¯å¤ç”¨çš„ä¼˜ç¼ºç‚¹[^2]</h3><ul><li><p>ä¸ç”¨å†ä½¿ç”¨<code>å¤šçº¿ç¨‹</code>æ¥è¿›è¡ŒIOå¤„ç†äº†ï¼ˆåŒ…æ‹¬æ“ä½œç³»ç»Ÿå†…æ ¸IOç®¡ç†æ¨¡å—å’Œåº”ç”¨ç¨‹åºè¿›ç¨‹è€Œè¨€ï¼‰ã€‚å½“ç„¶å®é™…ä¸šåŠ¡çš„å¤„ç†ä¸­ï¼Œåº”ç”¨ç¨‹åºè¿›ç¨‹è¿˜æ˜¯å¯ä»¥å¼•å…¥çº¿ç¨‹æ± æŠ€æœ¯çš„</p></li><li><p><code>åŒä¸€ä¸ªç«¯å£</code>å¯ä»¥å¤„ç†<code>å¤šç§åè®®</code>ï¼Œä¾‹å¦‚ï¼Œä½¿ç”¨ServerSocketChannelæµ‹æµ‹çš„æœåŠ¡å™¨ç«¯å£ç›‘å¬ï¼Œæ—¢å¯ä»¥å¤„ç†TCPåè®®åˆå¯ä»¥å¤„ç†UDPåè®®ã€‚</p></li><li><p>æ“ä½œç³»ç»Ÿçº§åˆ«çš„ä¼˜åŒ–ï¼šIOå¤šè·¯å¤ç”¨æŠ€æœ¯å¯ä»¥æ˜¯æ“ä½œç³»ç»Ÿçº§åˆ«åœ¨ä¸€ä¸ªç«¯å£ä¸Šèƒ½å¤ŸåŒæ—¶æ¥å—å¤šä¸ªå®¢æˆ·ç«¯çš„IOäº‹ä»¶ã€‚åŒæ—¶å…·æœ‰ä¹‹å‰æˆ‘ä»¬è®²åˆ°çš„é˜»å¡å¼åŒæ­¥IOå’Œéé˜»å¡å¼åŒæ­¥IOçš„æ‰€æœ‰ç‰¹ç‚¹ã€‚Selectorçš„ä¸€éƒ¨åˆ†ä½œç”¨æ›´ç›¸å½“äºâ€œè½®è¯¢ä»£ç†å™¨â€ã€‚</p></li><li><p>éƒ½æ˜¯åŒæ­¥IOï¼šç›®å‰æˆ‘ä»¬ä»‹ç»çš„<code>é˜»å¡å¼IO</code>ã€<code>éé˜»å¡å¼IO</code>ç”šè‡³åŒ…æ‹¬<code>IOå¤šè·¯å¤ç”¨</code>ï¼Œè¿™äº›éƒ½æ˜¯åŸºäºæ“ä½œ<strong>ç³»ç»Ÿçº§åˆ«</strong>å¯¹<code>åŒæ­¥IO</code>çš„å®ç°ã€‚æˆ‘ä»¬ä¸€ç›´åœ¨è¯´â€œåŒæ­¥IOâ€ï¼Œä¸€ç›´éƒ½æ²¡æœ‰è¯¦ç»†è¯´ï¼Œä»€ä¹ˆå«åšâ€œåŒæ­¥IOâ€ã€‚å®é™…ä¸Šä¸€å¥è¯å°±å¯ä»¥è¯´æ¸…æ¥šï¼šåªæœ‰ä¸Šå±‚ï¼ˆåŒ…æ‹¬ä¸Šå±‚çš„æŸç§ä»£ç†æœºåˆ¶ï¼‰ç³»ç»Ÿè¯¢é—®æˆ‘æ˜¯å¦æœ‰æŸä¸ªäº‹ä»¶å‘ç”Ÿäº†ï¼Œå¦åˆ™æˆ‘ä¸ä¼šä¸»åŠ¨å‘Šè¯‰ä¸Šå±‚ç³»ç»Ÿäº‹ä»¶å‘ç”Ÿäº†ã€‚</p></li></ul><p>[^1]:Richard Stevensçš„ã€ŠUNIXÂ® Network Programming Volume 1, Third Edition: The Sockets Networkingã€‹<br>[^2]:<a href="https://blog.csdn.net/yinwenjie/article/details/48522403">IOé€šä¿¡æ¨¡å‹å’ŒJAVAå®è·µ ä¸­ç¯‡</a></p><p>å‚è€ƒæ–‡çŒ®ï¼š<br>1.<a href="https://blog.csdn.net/tjiyu/article/details/52959418">5ç§IOæ¨¡å‹ã€é˜»å¡IOå’Œéé˜»å¡IOã€åŒæ­¥IOå’Œå¼‚æ­¥IO</a><br>2.<a href="https://blog.csdn.net/libaineu2004/article/details/77453235">IOåŒæ­¥ï¼Œå¼‚æ­¥ï¼Œé˜»å¡ï¼Œéé˜»å¡</a><br>3.<a href="https://blog.csdn.net/qq_35190492/article/details/113174359">è‚äº†ä¸€æœˆçš„NettyçŸ¥è¯†ç‚¹</a><br>4.<a href="https://blog.csdn.net/yinwenjie/article/details/48472237">ç³»ç»Ÿé—´é€šä¿¡ï¼ˆ3ï¼‰â€”â€”IOé€šä¿¡æ¨¡å‹å’ŒJAVAå®è·µ ä¸Šç¯‡</a></p>]]></content>
      
      
      <categories>
          
          <category> Nettyå­¦ä¹  </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Netty </tag>
            
            <tag> BIO </tag>
            
            <tag> NIO </tag>
            
            <tag> AIO </tag>
            
            <tag> IOå¤šè·¯å¤ç”¨ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ã€LeetCodeã€‘15. ä¸‰æ•°ä¹‹å’Œ</title>
      <link href="/posts/4286590179.html"/>
      <url>/posts/4286590179.html</url>
      
        <content type="html"><![CDATA[<h1 id="1-é—®é¢˜"><a href="#1-é—®é¢˜" class="headerlink" title="1.é—®é¢˜"></a>1.é—®é¢˜</h1><p>ç»™ä½ ä¸€ä¸ªæ•´æ•°æ•°ç»„ <code>nums</code> ï¼Œåˆ¤æ–­æ˜¯å¦å­˜åœ¨ä¸‰å…ƒç»„ <code>[nums[i], nums[j], nums[k]]</code> æ»¡è¶³ <code>i != jã€i != k ä¸” j != k</code> ï¼ŒåŒæ—¶è¿˜æ»¡è¶³ <code>nums[i] + nums[j] + nums[k] == 0</code> ã€‚è¯·ä½ è¿”å›æ‰€æœ‰å’Œä¸º 0 ä¸”<code>ä¸é‡å¤</code>çš„ä¸‰å…ƒç»„ã€‚</p><p><strong>æ³¨æ„</strong>ï¼šç­”æ¡ˆä¸­ä¸å¯ä»¥åŒ…å«é‡å¤çš„ä¸‰å…ƒç»„ã€‚</p><h2 id="ç¤ºä¾‹-1"><a href="#ç¤ºä¾‹-1" class="headerlink" title="ç¤ºä¾‹ 1"></a>ç¤ºä¾‹ 1</h2><blockquote><p>è¾“å…¥ï¼šnums &#x3D; [-1,0,1,2,-1,-4]<br>è¾“å‡ºï¼š[[-1,-1,2],[-1,0,1]]<br>è§£é‡Šï¼š nums[0] + nums[1] + nums[2] &#x3D; (-1) + 0 + 1 &#x3D; 0 ã€‚<br>nums[1] + nums[2] + nums[4] &#x3D; 0 + 1 + (-1) &#x3D; 0 ã€‚<br>nums[0] + nums[3] + nums[4] &#x3D; (-1) + 2 + (-1) &#x3D; 0 ã€‚<br>ä¸åŒçš„ä¸‰å…ƒç»„æ˜¯ [-1,0,1] å’Œ [-1,-1,2] ã€‚<br>æ³¨æ„ï¼Œè¾“å‡ºçš„é¡ºåºå’Œä¸‰å…ƒç»„çš„é¡ºåºå¹¶ä¸é‡è¦ã€‚</p></blockquote><h2 id="ç¤ºä¾‹-2"><a href="#ç¤ºä¾‹-2" class="headerlink" title="ç¤ºä¾‹ 2"></a>ç¤ºä¾‹ 2</h2><blockquote><p>è¾“å…¥ï¼šnums &#x3D; [0,1,1]<br>è¾“å‡ºï¼š[]<br>è§£é‡Šï¼šå”¯ä¸€å¯èƒ½çš„ä¸‰å…ƒç»„å’Œä¸ä¸º 0 ã€‚</p></blockquote><h2 id="ç¤ºä¾‹-3"><a href="#ç¤ºä¾‹-3" class="headerlink" title="ç¤ºä¾‹ 3"></a>ç¤ºä¾‹ 3</h2><blockquote><p>è¾“å…¥ï¼šnums &#x3D; [0,0,0]<br>è¾“å‡ºï¼š[[0,0,0]]<br>è§£é‡Šï¼šå”¯ä¸€å¯èƒ½çš„ä¸‰å…ƒç»„å’Œä¸º 0 ã€‚</p></blockquote><p><strong>æç¤º</strong>ï¼š</p><ul><li>3 &lt;&#x3D; nums.length &lt;&#x3D; 3000</li><li>-105 &lt;&#x3D; nums[i] &lt;&#x3D; 105</li></ul><h1 id="2-è§£é¢˜æ€è·¯"><a href="#2-è§£é¢˜æ€è·¯" class="headerlink" title="2.è§£é¢˜æ€è·¯"></a>2.è§£é¢˜æ€è·¯</h1><h2 id="2-1-è§£æ³•ä¸€"><a href="#2-1-è§£æ³•ä¸€" class="headerlink" title="2.1 è§£æ³•ä¸€"></a>2.1 è§£æ³•ä¸€</h2><ul><li>å…ˆæ’åºï¼Œå‡è®¾ç¬¬ä¸€ä¸ªæ•°å°±å¤§äº0äº†ï¼Œåˆ™ä¸ç”¨å†éå†æ•°ç»„äº†ï¼Œä¸å¯èƒ½å­˜åœ¨ä¸‰æ•°å‡å¤§äº0ä¸”å’Œä¸º0.</li><li>å›ºå®šç¬¬ä¸€ä¸ªæ•°<code>nums[i]</code>ï¼Œç„¶åç¬¬äºŒä¸ªæ•°<code>nums[j]</code>å’Œç¬¬ä¸‰ä¸ªæ•°<code>nums[k]</code>åœ¨æ•°ç»„ç´¢å¼•<code>(i, nums.length)</code>èŒƒå›´ï¼š<ul><li>å…ˆå¯¹<code>nums[i]</code>å»é‡</li><li>è‹¥<code>sum&gt;0</code>ï¼Œåˆ™è¦å‡å°å…ƒç´ ï¼Œ<code>k--</code></li><li>è‹¥<code>sum&lt;0</code>ï¼Œåˆ™è¦å¢å¤§å…ƒç´ ï¼Œ<code>j++</code></li><li>è‹¥<code>sum==0</code>ï¼Œä¿å­˜ç»“æœï¼Œä¸”å¯¹ç¬¬äºŒä¸ªæ•°ï¼Œç¬¬ä¸‰ä¸ªæ•°å»é‡ï¼Œç»§ç»­éå†</li></ul></li></ul><p>æ—¶é—´å¤æ‚åº¦ï¼šO($n^2$)ï¼Œn ä¸ºæ•°ç»„é•¿åº¦.</p><h2 id="2-2-è§£æ³•äºŒï¼ˆä¼˜åŒ–ï¼‰"><a href="#2-2-è§£æ³•äºŒï¼ˆä¼˜åŒ–ï¼‰" class="headerlink" title="2.2 è§£æ³•äºŒï¼ˆä¼˜åŒ–ï¼‰"></a>2.2 è§£æ³•äºŒï¼ˆä¼˜åŒ–ï¼‰</h2><p>å›ºå®šç¬¬ä¸€ä¸ªæ•°åï¼Œåœ¨å¯¹åé¢ä¸¤æ•°é€šè¿‡åŒæŒ‡é’ˆéå†æ—¶ï¼Œå…ˆä¸è®¡ç®—ä¸‰æ•°ä¹‹å’Œï¼Œå…ˆåˆ¤å®šç¬¬äºŒä¸ªæ•°çš„é‡å¤æ€§ï¼Œè¿™æ ·å¯ä»¥å‡å°‘å¯¹ç¬¬ä¸‰ä¸ªæ•°çš„åˆ¤é‡ã€‚å› ä¸ºï¼š</p><ul><li>ç¬¬äºŒä¸ªæ•°å…ˆå»é‡äº†ï¼Œå½“ç¬¬äºŒä¸ªæ•°ç¬¬ä¸€æ¬¡æ»¡è¶³ä¸‰æ•°ä¹‹å’Œä¸º0ï¼Œåˆ™ä¸‹ä¸€æ¬¡ç¬¬äºŒä¸ªæ•°å·²ç»æ¯”åŸæ¥çš„å¤§ï¼Œç¬¬ä¸‰ä¸ªæ•°å³æ—¶ç›¸åŒï¼Œä¹Ÿä¸æ»¡è¶³ä¸‰å’Œä¸ºé›¶çš„ç»“æœï¼›</li><li>å½“ç¬¬äºŒä¸ªæ•°ä¸æ»¡è¶³ä¸‰æ•°ä¹‹å’Œä¸º0ï¼Œè¦ä¹ˆ<code>j++</code>ï¼Œè¦ä¹ˆ<code>k--</code>ï¼Œå³ä½¿ç¬¬ä¸‰ä¸ªæ•°ç›¸åŒï¼Œä¹Ÿä¸ä¼šæ»¡è¶³ç»“æœï¼Œç»§ç»­éå†å³å¯ã€‚</li></ul><h1 id="3-ä»£ç "><a href="#3-ä»£ç " class="headerlink" title="3.ä»£ç "></a>3.ä»£ç </h1><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">class</span> <span class="token class-name">Solution</span> <span class="token punctuation">&#123;</span><span class="token comment">//è§£æ³•ä¸€</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">></span><span class="token punctuation">></span></span> <span class="token function">threeSum</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> nums<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">></span><span class="token punctuation">></span></span> ans <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">int</span> len <span class="token operator">=</span> nums<span class="token punctuation">.</span>length<span class="token punctuation">;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>nums <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> len <span class="token operator">&lt;</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">return</span> ans<span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token comment">// æ’åº</span>        <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span>nums<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> len <span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token comment">// å¦‚æœå½“å‰æ•°å­—å¤§äº0ï¼Œåˆ™ä¸‰æ•°ä¹‹å’Œä¸€å®šå¤§äº0ï¼Œæ‰€ä»¥ç»“æŸå¾ªç¯</span>            <span class="token keyword">if</span><span class="token punctuation">(</span>nums<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">break</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>            <span class="token comment">//å¯¹ç¬¬ä¸€ä¸ªæ•°å»é‡</span>            <span class="token keyword">if</span><span class="token punctuation">(</span>i <span class="token operator">></span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> nums<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">==</span> nums<span class="token punctuation">[</span>i<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">continue</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>            <span class="token keyword">int</span> <span class="token class-name">L</span> <span class="token operator">=</span> i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">;</span>            <span class="token keyword">int</span> <span class="token class-name">R</span> <span class="token operator">=</span> len<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>            <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token class-name">L</span> <span class="token operator">&lt;</span> <span class="token class-name">R</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>                <span class="token keyword">int</span> sum <span class="token operator">=</span> nums<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">+</span> nums<span class="token punctuation">[</span><span class="token class-name">L</span><span class="token punctuation">]</span> <span class="token operator">+</span> nums<span class="token punctuation">[</span><span class="token class-name">R</span><span class="token punctuation">]</span><span class="token punctuation">;</span>                <span class="token keyword">if</span><span class="token punctuation">(</span>sum <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>                    ans<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span>nums<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span>nums<span class="token punctuation">[</span><span class="token class-name">L</span><span class="token punctuation">]</span><span class="token punctuation">,</span>nums<span class="token punctuation">[</span><span class="token class-name">R</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token comment">//ç¬¬äºŒä¸ªæ•°å»é‡</span>                    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token class-name">L</span><span class="token operator">&lt;</span><span class="token class-name">R</span> <span class="token operator">&amp;&amp;</span> nums<span class="token punctuation">[</span><span class="token class-name">L</span><span class="token punctuation">]</span> <span class="token operator">==</span> nums<span class="token punctuation">[</span><span class="token class-name">L</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token class-name">L</span><span class="token operator">++</span><span class="token punctuation">;</span>                    <span class="token comment">// ç¬¬ä¸‰ä¸ªæ•°å»é‡</span>                    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token class-name">L</span><span class="token operator">&lt;</span><span class="token class-name">R</span> <span class="token operator">&amp;&amp;</span> nums<span class="token punctuation">[</span><span class="token class-name">R</span><span class="token punctuation">]</span> <span class="token operator">==</span> nums<span class="token punctuation">[</span><span class="token class-name">R</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token class-name">R</span><span class="token operator">--</span><span class="token punctuation">;</span>                    <span class="token class-name">L</span><span class="token operator">++</span><span class="token punctuation">;</span>                    <span class="token class-name">R</span><span class="token operator">--</span><span class="token punctuation">;</span>                <span class="token punctuation">&#125;</span>                <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>sum <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>                 <span class="token class-name">L</span><span class="token operator">++</span><span class="token punctuation">;</span>                <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>sum <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span>                 <span class="token class-name">R</span><span class="token operator">--</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>                <span class="token keyword">return</span> ans<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token comment">//è§£æ³•äºŒ</span><span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">></span><span class="token punctuation">></span></span> <span class="token function">threeSum</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> nums<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span>nums<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">int</span> n <span class="token operator">=</span> nums<span class="token punctuation">.</span>length<span class="token punctuation">;</span>        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">></span><span class="token punctuation">></span></span> ans <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> n<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token comment">//ç¬¬ä¸€ä¸ªæ•°å»é‡</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">></span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> nums<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">==</span> nums<span class="token punctuation">[</span>i <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>                 <span class="token keyword">continue</span><span class="token punctuation">;</span>            <span class="token keyword">int</span> j <span class="token operator">=</span> i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>            <span class="token keyword">int</span> k <span class="token operator">=</span> n <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>            <span class="token keyword">while</span> <span class="token punctuation">(</span>j <span class="token operator">&lt;</span> k<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                <span class="token comment">//ç¬¬äºŒä¸ªæ•° å»é‡</span>                <span class="token keyword">while</span> <span class="token punctuation">(</span>j <span class="token operator">></span> i <span class="token operator">+</span> <span class="token number">1</span> <span class="token operator">&amp;&amp;</span> j <span class="token operator">&lt;</span> n <span class="token operator">&amp;&amp;</span> nums<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">==</span> nums<span class="token punctuation">[</span>j <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>                     j<span class="token operator">++</span><span class="token punctuation">;</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>j <span class="token operator">>=</span> k<span class="token punctuation">)</span>                     <span class="token keyword">break</span><span class="token punctuation">;</span>                <span class="token keyword">int</span> sum <span class="token operator">=</span> nums<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">+</span> nums<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">+</span> nums<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">;</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>sum <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                    ans<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span>nums<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> nums<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">,</span> nums<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    j<span class="token operator">++</span><span class="token punctuation">;</span>                <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>sum <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                    k<span class="token operator">--</span><span class="token punctuation">;</span>                <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>sum <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                    j<span class="token operator">++</span><span class="token punctuation">;</span>                <span class="token punctuation">&#125;</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">return</span> ans<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> ç®—æ³• </category>
          
      </categories>
      
      
        <tags>
            
            <tag> LeetCode </tag>
            
            <tag> ç®—æ³• </tag>
            
            <tag> åŒæŒ‡é’ˆ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ã€LeetCodeã€‘1. ä¸¤æ•°ä¹‹å’Œ</title>
      <link href="/posts/2798825052.html"/>
      <url>/posts/2798825052.html</url>
      
        <content type="html"><![CDATA[<h1 id="1-é—®é¢˜"><a href="#1-é—®é¢˜" class="headerlink" title="1. é—®é¢˜"></a>1. é—®é¢˜</h1><p>ç»™å®šä¸€ä¸ªæ•´æ•°æ•°ç»„ <code>nums</code> å’Œä¸€ä¸ªæ•´æ•°ç›®æ ‡å€¼ <code>target</code>ï¼Œè¯·ä½ åœ¨è¯¥æ•°ç»„ä¸­æ‰¾å‡º<code>å’Œä¸ºç›®æ ‡å€¼ target</code>çš„é‚£ <code>ä¸¤ä¸ª</code> æ•´æ•°ï¼Œå¹¶è¿”å›å®ƒä»¬çš„<code>æ•°ç»„ä¸‹æ ‡</code>ã€‚</p><p>ä½ å¯ä»¥å‡è®¾æ¯ç§è¾“å…¥åªä¼šå¯¹åº”ä¸€ä¸ªç­”æ¡ˆã€‚ä½†æ˜¯ï¼Œæ•°ç»„ä¸­åŒä¸€ä¸ªå…ƒç´ åœ¨ç­”æ¡ˆé‡Œ<code>ä¸èƒ½é‡å¤</code>å‡ºç°ã€‚</p><p>ä½ å¯ä»¥æŒ‰ä»»æ„é¡ºåºè¿”å›ç­”æ¡ˆã€‚</p><h2 id="ç¤ºä¾‹-1"><a href="#ç¤ºä¾‹-1" class="headerlink" title="ç¤ºä¾‹ 1"></a>ç¤ºä¾‹ 1</h2><blockquote><p>è¾“å…¥ï¼šnums &#x3D; [2,7,11,15], target &#x3D; 9<br>è¾“å‡ºï¼š[0,1]<br>è§£é‡Šï¼šå› ä¸º nums[0] + nums[1] &#x3D;&#x3D; 9 ï¼Œè¿”å› [0, 1] ã€‚</p></blockquote><h2 id="ç¤ºä¾‹-2"><a href="#ç¤ºä¾‹-2" class="headerlink" title="ç¤ºä¾‹ 2"></a>ç¤ºä¾‹ 2</h2><blockquote><p>è¾“å…¥ï¼šnums &#x3D; [3,2,4], target &#x3D; 6<br>è¾“å‡ºï¼š[1,2]</p></blockquote><h2 id="ç¤ºä¾‹-3"><a href="#ç¤ºä¾‹-3" class="headerlink" title="ç¤ºä¾‹ 3"></a>ç¤ºä¾‹ 3</h2><blockquote><p>è¾“å…¥ï¼šnums &#x3D; [3,3], target &#x3D; 6<br>è¾“å‡ºï¼š[0,1]</p></blockquote><p><strong>æç¤º</strong>ï¼š</p><ul><li>2 &lt;&#x3D; nums.length &lt;&#x3D; 104</li><li>-109 &lt;&#x3D; nums[i] &lt;&#x3D; 109</li><li>-109 &lt;&#x3D; target &lt;&#x3D; 109</li><li>åªä¼šå­˜åœ¨ä¸€ä¸ªæœ‰æ•ˆç­”æ¡ˆ</li></ul><p>è¿›é˜¶ï¼šä½ å¯ä»¥æƒ³å‡ºä¸€ä¸ªæ—¶é—´å¤æ‚åº¦å°äº O($n^2$) çš„ç®—æ³•å—ï¼Ÿ</p><h1 id="2-è§£é¢˜æ€è·¯"><a href="#2-è§£é¢˜æ€è·¯" class="headerlink" title="2. è§£é¢˜æ€è·¯"></a>2. è§£é¢˜æ€è·¯</h1><h2 id="2-1-æš´åŠ›"><a href="#2-1-æš´åŠ›" class="headerlink" title="2.1 æš´åŠ›"></a>2.1 æš´åŠ›</h2><p>ä½¿ç”¨<code>ä¸¤é‡å¾ªç¯</code>æšä¸¾ä¸‹æ ‡ <code>i</code> å’Œ <code>j</code>ï¼Œåˆ†åˆ«ä»£è¡¨è¦æ‰¾çš„ä¸¤ä¸ªæ•°ã€‚åˆ¤æ–­</p><blockquote><p>nums[i] + nums[j] &#x3D;&#x3D; target</p></blockquote><p>æ˜¯å¦æˆç«‹ã€‚è¯¦è§ä»£ç è§£æ³•ä¸€ã€‚</p><p>å¤æ‚åº¦ï¼š</p><ul><li>æ—¶é—´å¤æ‚åº¦ï¼šä¸¤é‡å¾ªç¯ï¼Œæ‰€ä»¥å¤æ‚åº¦æ˜¯ O($n^2$)ã€‚</li><li>ç©ºé—´å¤æ‚åº¦ï¼šO(1)ã€‚</li></ul><h2 id="2-2-å“ˆå¸Œè¡¨"><a href="#2-2-å“ˆå¸Œè¡¨" class="headerlink" title="2.2 å“ˆå¸Œè¡¨"></a>2.2 å“ˆå¸Œè¡¨</h2><p>å“ˆå¸ŒæŸ¥æ‰¾çš„æ—¶é—´å¤æ‚åº¦ä¸º <code>O(1)</code>ï¼Œæ‰€ä»¥å¯ä»¥åˆ©ç”¨å“ˆå¸Œå®¹å™¨ map é™ä½æ—¶é—´å¤æ‚åº¦</p><ul><li>éå†æ•°ç»„ <code>nums</code>ï¼Œ<code>i </code>ä¸ºå½“å‰ä¸‹æ ‡ï¼Œæ¯ä¸ªå€¼éƒ½åˆ¤æ–­mapä¸­æ˜¯å¦å­˜åœ¨ <code>target-nums[i]</code> çš„ <code>key</code> å€¼;</li><li>å¦‚æœå­˜åœ¨ï¼Œåˆ™æ‰¾åˆ°äº†ä¸¤ä¸ªå€¼;</li><li>å¦‚æœä¸å­˜åœ¨ï¼Œåˆ™å°†å½“å‰çš„ <code>(nums[i], i)</code> å­˜å…¥ map ä¸­ï¼Œç»§ç»­éå†ç›´åˆ°éå†ç»“æŸã€‚</li></ul><p>è¯¦è§ä»£ç ä¸­è§£æ³•äºŒã€‚</p><p>å¤æ‚åº¦ï¼š</p><ul><li>æ—¶é—´å¤æ‚åº¦ï¼šå“ˆå¸Œè¡¨çš„åšæ³•åªä¼šå¯¹æ•°ç»„è¿›è¡Œä¸€éæ‰«æï¼Œå¤æ‚åº¦æ˜¯ <code>O(N)</code>ï¼›</li><li>ç©ºé—´å¤æ‚åº¦ï¼šä½¿ç”¨äº†å“ˆå¸Œè¡¨è¿›è¡Œè®°å½•ï¼Œå¤æ‚åº¦æ˜¯ <code>O(N)</code>ã€‚</li></ul><h1 id="3-ä»£ç "><a href="#3-ä»£ç " class="headerlink" title="3.ä»£ç "></a>3.ä»£ç </h1><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">class</span> <span class="token class-name">Solution</span> <span class="token punctuation">&#123;</span><span class="token comment">//è§£æ³•ä¸€ï¼šæš´åŠ›</span>    <span class="token keyword">public</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">twoSum</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> nums<span class="token punctuation">,</span> <span class="token keyword">int</span> t<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">int</span> n <span class="token operator">=</span> nums<span class="token punctuation">.</span>length<span class="token punctuation">;</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> n <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> n<span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>t <span class="token operator">==</span> nums<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">+</span> nums<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span>i<span class="token punctuation">,</span>j<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>                <span class="token punctuation">&#125;</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token comment">//è§£æ³•äºŒï¼šå“ˆå¸Œè¡¨</span><span class="token keyword">public</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">twoSum2</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> nums<span class="token punctuation">,</span> <span class="token keyword">int</span> target<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token comment">//map å­˜å‚¨å·²æ‰«æè¿‡çš„æ•°å­—</span>        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">></span></span> map<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">//ç»“æœé›†</span>        <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> res <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token comment">//éå†</span>        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span>nums<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            <span class="token comment">//å¦ä¸€ä¸ªæ•°æ˜¯å¦å­˜åœ¨map</span>            <span class="token keyword">if</span><span class="token punctuation">(</span>map<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>target <span class="token operator">-</span> nums<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>                res<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">=</span>i<span class="token punctuation">;</span>                res<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">=</span>map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>target <span class="token operator">-</span> nums<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">return</span> res<span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>            map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>nums<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">return</span> res<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> ç®—æ³• </category>
          
      </categories>
      
      
        <tags>
            
            <tag> LeetCode </tag>
            
            <tag> ç®—æ³• </tag>
            
            <tag> å“ˆå¸Œè¡¨ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ã€Nettyå­¦ä¹ ã€‘1.ç½‘ç»œåè®®</title>
      <link href="/posts/3253867670.html"/>
      <url>/posts/3253867670.html</url>
      
        <content type="html"><![CDATA[<h1 id="1-ç½‘ç»œåè®®"><a href="#1-ç½‘ç»œåè®®" class="headerlink" title="1.ç½‘ç»œåè®®"></a>1.ç½‘ç»œåè®®</h1><h2 id="1-1-è®¡ç®—æœºç½‘ç»œ"><a href="#1-1-è®¡ç®—æœºç½‘ç»œ" class="headerlink" title="1.1 è®¡ç®—æœºç½‘ç»œ"></a>1.1 è®¡ç®—æœºç½‘ç»œ</h2><ul><li>å®šä¹‰<blockquote><p>è®¡ç®—æœºç½‘ç»œçš„æ ‡å‡†å®šä¹‰æ˜¯: åˆ©ç”¨é€šä¿¡çº¿è·¯å°†åœ°ç†ä¸Š<code>åˆ†æ•£çš„</code>ã€<code>å…·æœ‰ç‹¬ç«‹åŠŸèƒ½çš„è®¡ç®—æœºç³»ç»Ÿ</code>å’Œ<code>é€šä¿¡è®¾å¤‡</code>æŒ‰ä¸åŒçš„å½¢å¼è¿æ¥èµ·æ¥ï¼Œä»¥åŠŸèƒ½å®Œå–„çš„<code>ç½‘ç»œè½¯ä»¶</code>åŠ<code>åè®®</code>å®ç°èµ„æºå…±äº«å’Œä¿¡æ¯ä¼ é€’çš„<code>ç³»ç»Ÿ</code>ã€‚</p></blockquote></li><li>åˆ†ç±»<ul><li>æŒ‰è¦†ç›–èŒƒå›´åˆ’åˆ†<ul><li>å±€åŸŸç½‘<code>LAN</code>(ä½œç”¨èŒƒå›´ä¸€èˆ¬ä¸ºå‡ ç±³åˆ°å‡ åå…¬é‡Œ)</li><li>åŸåŸŸç½‘<code>MAN</code>(ç•Œäº WAN ä¸ LAN ä¹‹é—´)</li><li>å¹¿åŸŸç½‘<code>WAN</code>(ä½œç”¨ èŒƒå›´ä¸€èˆ¬ä¸ºå‡ ååˆ°å‡ åƒå…¬é‡Œ)</li></ul></li><li>æŒ‰æ‹“æ‰‘ç»“æ„åˆ’åˆ†<ul><li>æ€»çº¿å‹</li><li>ç¯å‹</li><li>æ˜Ÿå‹</li><li>ç½‘çŠ¶</li></ul></li><li>æŒ‰æŒ‰ä¿¡æ¯çš„äº¤æ¢æ–¹å¼<ul><li>ç”µè·¯äº¤æ¢</li><li>æŠ¥æ–‡äº¤</li><li>æŠ¥æ–‡åˆ†ç»„äº¤æ¢</li></ul></li></ul></li></ul><h1 id="2-è®¡ç®—æœºç½‘ç»œä½“ç³»ç»“æ„"><a href="#2-è®¡ç®—æœºç½‘ç»œä½“ç³»ç»“æ„" class="headerlink" title="2.è®¡ç®—æœºç½‘ç»œä½“ç³»ç»“æ„"></a>2.è®¡ç®—æœºç½‘ç»œä½“ç³»ç»“æ„</h1><h2 id="2-1-OSIä¸ƒå±‚æ¨¡å‹"><a href="#2-1-OSIä¸ƒå±‚æ¨¡å‹" class="headerlink" title="2.1 OSIä¸ƒå±‚æ¨¡å‹"></a>2.1 OSIä¸ƒå±‚æ¨¡å‹</h2><p>å¼€æ”¾ç³»ç»Ÿäº’è¿å‚è€ƒæ¨¡å‹ (<code>Open System Interconnect ç®€ç§° OSI</code>) é‡‡ç”¨äº†åˆ†å±‚çš„ç»“æ„åŒ–æŠ€æœ¯ï¼Œå…±åˆ†ä¸ƒå±‚ï¼Œ<code>ç‰©ç†å±‚</code>ã€<code>æ•°æ®é“¾è·¯å±‚</code>ã€<code>ç½‘ç»œå±‚</code>ã€<code>ä¼ è¾“å±‚</code>ã€<code>ä¼šè¯å±‚</code>ã€<code>è¡¨ç¤ºå±‚</code>ã€<code>åº”ç”¨å±‚</code>ã€‚</p><p><img src="https://cdn.jsdelivr.net/gh/zyxelva/picgo@main/markdown/OSI%E4%B8%83%E5%B1%82%E6%A8%A1%E5%9E%8B.png" alt="OSIä¸ƒå±‚æ¨¡å‹"></p><ul><li>å„å±‚çš„ä½œç”¨åŠå¯¹åº”çš„åè®®(ç®€åŒ–)</li></ul><p><img src="https://cdn.jsdelivr.net/gh/zyxelva/picgo@main/markdown/OSI%E4%B8%83%E5%B1%82%E6%A8%A1%E5%9E%8B%EF%BC%88%E7%AE%80%E5%8C%96%EF%BC%89.png" alt="ç½‘ç»œç¡¬ä»¶ä¸æ•°æ®ä¼ è¾“å±‚ä¸ƒå±‚çš„åè®® - éšæ„çš„ä¸–ç•Œ"></p><h2 id="2-2-TCP-x2F-IP-å››å±‚æ¨¡å‹"><a href="#2-2-TCP-x2F-IP-å››å±‚æ¨¡å‹" class="headerlink" title="2.2 TCP&#x2F;IP å››å±‚æ¨¡å‹"></a>2.2 TCP&#x2F;IP å››å±‚æ¨¡å‹</h2><p><code>OSIæ¨¡å‹</code>æ¯”è¾ƒå¤æ‚ä¸”å­¦æœ¯åŒ–ï¼Œæ‰€ä»¥æˆ‘ä»¬å®é™…ä½¿ç”¨çš„ <code>TCP/IP æ¨¡å‹</code>ï¼Œå…±åˆ† 4 å±‚ï¼Œ<code>é“¾è·¯å±‚</code>ã€<code>ç½‘ç»œå±‚</code>ã€<code>ä¼ è¾“å±‚</code>ã€<code>åº”ç”¨å±‚</code>ã€‚</p><ul><li>ä¸¤ä¸ªæ¨¡å‹ä¹‹é—´çš„å¯¹åº”å…³ç³»å¦‚å›¾æ‰€ç¤º:</li></ul><p><img src="https://cdn.jsdelivr.net/gh/zyxelva/picgo@main/markdown/%E5%9B%9B%E5%B1%82%E4%B8%8E%E4%B8%83%E5%B1%82%E5%AF%B9%E5%BA%94%E5%85%B3%E7%B3%BB.png" alt="å¯¹åº”å…³ç³»"></p><h2 id="2-3-äº”å±‚æ¨¡å‹"><a href="#2-3-äº”å±‚æ¨¡å‹" class="headerlink" title="2.3 äº”å±‚æ¨¡å‹"></a>2.3 äº”å±‚æ¨¡å‹</h2><blockquote><p>äº”å±‚æ¨¡å‹åªå‡ºç°åœ¨è®¡ç®—æœºç½‘ç»œå­¦ä¹ æ•™å­¦è¿‡ç¨‹ä¸­ï¼Œä»–æ˜¯å¯¹ä¸ƒå±‚æ¨¡å‹å’Œå››å±‚æ¨¡å‹çš„ä¸€ä¸ªæŠ˜ä¸­ï¼ŒåŠç»¼åˆäº†<code>OSI</code>å’Œ<code>TCP/IP</code> ä½“ç³»ç»“æ„çš„ä¼˜ç‚¹ï¼Œè¿™æ ·æ—¢ç®€æ´åˆèƒ½å°†æ¦‚å¿µé˜è¿°æ¸…æ¥šã€‚</p></blockquote><p><img src="https://cdn.jsdelivr.net/gh/zyxelva/picgo@main/markdown/%E4%BA%94%E5%B1%82%E5%8D%8F%E8%AE%AE.png" alt="äº”å±‚æ¨¡å‹"></p><h2 id="2-4-TCP-x2F-IP-åè®®æ—"><a href="#2-4-TCP-x2F-IP-åè®®æ—" class="headerlink" title="2.4 TCP&#x2F;IP åè®®æ—"></a>2.4 TCP&#x2F;IP åè®®æ—</h2><p><img src="https://cdn.jsdelivr.net/gh/zyxelva/picgo@main/markdown/TCP:IP%E5%8F%8A%E5%85%B6%E5%8D%8F%E8%AE%AE%E7%B0%87.png" alt="TCP/IP åè®®æ—"></p><h2 id="2-5-TCP-x2F-IP-ç½‘ç»œä¼ è¾“ä¸­çš„æ•°æ®"><a href="#2-5-TCP-x2F-IP-ç½‘ç»œä¼ è¾“ä¸­çš„æ•°æ®" class="headerlink" title="2.5 TCP&#x2F;IP ç½‘ç»œä¼ è¾“ä¸­çš„æ•°æ®"></a>2.5 TCP&#x2F;IP ç½‘ç»œä¼ è¾“ä¸­çš„æ•°æ®</h2><p><img src="https://cdn.jsdelivr.net/gh/zyxelva/picgo@main/markdown/TCP%E6%8A%A5%E6%96%87%E6%B5%81%E7%A8%8B.png" alt="TCP/IP ç½‘ç»œä¼ è¾“ä¸­çš„æ•°æ®"></p><h2 id="2-6-åœ°å€å’Œç«¯å£å·"><a href="#2-6-åœ°å€å’Œç«¯å£å·" class="headerlink" title="2.6 åœ°å€å’Œç«¯å£å·"></a>2.6 åœ°å€å’Œç«¯å£å·</h2><h3 id="2-6-1-MACåœ°å€"><a href="#2-6-1-MACåœ°å€" class="headerlink" title="2.6.1 MACåœ°å€"></a>2.6.1 MACåœ°å€</h3><p>MAC åœ°å€å…¨ç§°å«åš<code>åª’ä½“è®¿é—®æ§åˆ¶åœ°å€(Media Access Control)</code>ï¼Œä¹Ÿç§°ä¸º<code>å±€åŸŸç½‘åœ°å€(LAN Address)</code>ï¼Œ<code>MAC ä½å€</code>ï¼Œ <code>ä»¥å¤ªç½‘åœ°å€(Ethernet Address)</code>æˆ–<code>ç‰©ç†åœ°å€(Physical Address)</code>ï¼Œç”±ç½‘ç»œè®¾å¤‡åˆ¶é€ å•†ç”Ÿäº§æ—¶å†™åœ¨ç¡¬ä»¶å†…éƒ¨ã€‚</p><ul><li>MAC åœ°å€ä¸ç½‘ç»œæ— å…³ã€‚</li><li>å…±48ä½ï¼ˆ6 ä¸ªå­—èŠ‚ï¼‰ã€‚å‰24ä½ç”±<code>IEEEï¼ˆç”µæ°”å’Œç”µå­å·¥ç¨‹å¸ˆåä¼šï¼‰</code>å†³å®šå¦‚ä½•åˆ†é…ï¼Œå24ä½ç”±å®é™…ç”Ÿäº§è¯¥ç½‘ç»œè®¾å¤‡çš„å‚å•†è‡ªè¡Œåˆ¶å®šã€‚<br><img src="https://cdn.jsdelivr.net/gh/zyxelva/picgo@main/markdown/MAC.png" alt="è¾“å…¥å›¾ç‰‡è¯´æ˜"></li></ul><h2 id="2-7-IP-åœ°å€"><a href="#2-7-IP-åœ°å€" class="headerlink" title="2.7 IP åœ°å€"></a>2.7 IP åœ°å€</h2><p><code>IP åœ°å€(Internet Protocol Address)</code>çš„å…¨ç§°å«ä½œ<code>äº’è”ç½‘åè®®åœ°å€</code>ï¼Œå®ƒçš„æœ¬ä¹‰æ˜¯ä¸ºäº’è”ç½‘ä¸Šçš„æ¯ä¸€ä¸ªç½‘ç»œå’Œæ¯ä¸€å°ä¸»æœºé…ç½®ä¸€ä¸ª<code>å”¯ä¸€çš„é€»è¾‘åœ°å€</code>ï¼Œç”¨æ¥ä¸<code>ç‰©ç†åœ°å€</code>ä½œåŒºåˆ†ã€‚</p><p>æ‰€ä»¥ IP åœ°å€ç”¨æ¥è¯†åˆ« TCP&#x2F;IP ç½‘ç»œä¸­äº’è¿çš„ä¸»æœºå’Œè·¯ç”±å™¨ã€‚IP åœ°å€åŸºäºé€»è¾‘ï¼Œæ¯”è¾ƒçµæ´»ï¼Œä¸å—ç¡¬ä»¶é™åˆ¶ï¼Œä¹Ÿå®¹æ˜“è®°å¿†ã€‚</p><p>IP åœ°å€åˆ†ä¸º:</p><ul><li><code>IPv4</code> </li><li><code>IPv6</code></li></ul><p>æˆ‘ä»¬è¿™é‡Œç€é‡è®²çš„æ˜¯ IPv4 åœ°å€ï¼ŒIP åœ°å€æ˜¯ç”± 32 ä½çš„<code>äºŒè¿›åˆ¶æ•°</code>ç»„æˆï¼Œå®ƒä»¬é€šå¸¸è¢«åˆ†ä¸º <code>4 ä¸ªâ€œ8 ä½äºŒè¿›åˆ¶æ•°â€</code>ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠå®ƒç†è§£ä¸º <code>4 ä¸ªå­—èŠ‚</code>ï¼Œæ ¼å¼è¡¨ç¤ºä¸º: </p><blockquote><p>A.B.C.D</p></blockquote><p>å…¶ä¸­ï¼ŒAï¼ŒBï¼ŒCï¼ŒD è¿™å››ä¸ªè‹±æ–‡å­—æ¯è¡¨ç¤ºä¸º <code>0-255 çš„åè¿›åˆ¶çš„æ•´æ•°</code>ã€‚ä¾‹: <code>192.168.1.1</code></p><blockquote><p><strong>Tips</strong>: IP åœ°å€å’Œ MAC åœ°å€ä¹‹é—´çš„åŒºåˆ«</p><ul><li>1ã€å¯¹äºç½‘ç»œä¸­çš„ä¸€äº›è®¾å¤‡ï¼Œè·¯ç”±å™¨æˆ–è€…æ˜¯ PC åŠè€Œè¨€ï¼ŒIP åœ°å€çš„è®¾è®¡æ˜¯å‡ºäºæ‹“æ‰‘è®¾è®¡å‡ºæ¥çš„ï¼Œåªè¦åœ¨<strong>ä¸é‡å¤ IP åœ°å€</strong>çš„æƒ…å†µä¸‹ï¼Œå®ƒæ˜¯<strong>å¯ä»¥éšæ„æ›´æ”¹çš„</strong>ï¼›è€Œ MAC åœ°å€æ˜¯æ ¹æ®ç”Ÿäº§å‚å•†çƒ§å½•å¥½çš„ï¼Œå®ƒ<strong>ä¸€èˆ¬ä¸èƒ½æ”¹åŠ¨çš„</strong>ï¼Œä¸€èˆ¬æ¥è¯´ï¼Œå½“ä¸€å° PC æœºçš„ç½‘å¡åäº†ä¹‹åï¼Œæ›´æ¢äº†ç½‘å¡ä¹‹å MAC åœ°å€å°±ä¼šå˜äº†ã€‚</li><li>2ã€åœ¨å‰é¢çš„ä»‹ç»é‡Œé¢ï¼Œå®ƒä»¬æœ€æ˜æ˜¾çš„åŒºåˆ«å°±æ˜¯é•¿åº¦ä¸åŒï¼Œ<strong>IP åœ°å€çš„é•¿åº¦ä¸º 32 ä½</strong>ï¼Œè€Œ <strong>MAC åœ°å€ä¸º 48 ä½</strong>ã€‚</li><li>3ã€<strong>å®ƒä»¬çš„å¯»å€åè®®å±‚ä¸åŒ</strong>ã€‚IP åœ°å€åº”ç”¨äº OSI æ¨¡å‹çš„<strong>ç½‘ç»œå±‚</strong>ï¼Œè€Œ MAC åœ°å€åº”ç”¨åœ¨ OSI æ¨¡å‹çš„<strong>æ•°æ®é“¾è·¯å±‚</strong>ã€‚ æ•°æ®é“¾è·¯å±‚åè®®å¯ä»¥ä½¿æ•°æ®ä»ä¸€ä¸ªèŠ‚ç‚¹ä¼ é€’åˆ°ç›¸åŒé“¾è·¯çš„å¦ä¸€ä¸ªèŠ‚ç‚¹ä¸Š(é€šè¿‡ MAC åœ°å€)ï¼Œè€Œç½‘ç»œå±‚åè®®ä½¿æ•°æ®å¯ä»¥ä»ä¸€ä¸ªç½‘ç»œä¼ é€’åˆ°å¦ä¸€ä¸ªç½‘ç»œä¸Š(ARP æ ¹æ®ç›®çš„ IP åœ°å€ï¼Œæ‰¾åˆ°ä¸­é—´èŠ‚ç‚¹çš„ MAC åœ°å€ï¼Œé€šè¿‡ä¸­é—´èŠ‚ç‚¹ä¼ é€ï¼Œä»è€Œæœ€ç»ˆåˆ°è¾¾ç›®çš„ç½‘ç»œ)ã€‚</li><li>4ã€<strong>åˆ†é…ä¾æ®ä¸åŒ</strong>ã€‚IP åœ°å€çš„åˆ†é…æ˜¯åŸºäºæˆ‘ä»¬è‡ªèº«å®šä¹‰çš„ç½‘ç»œæ‹“æ‰‘ï¼ŒMAC åœ°å€çš„åˆ†é…æ˜¯åŸºäºåˆ¶é€ å•†ã€‚</li></ul></blockquote><h2 id="2-8-ç«¯å£å·"><a href="#2-8-ç«¯å£å·" class="headerlink" title="2.8 ç«¯å£å·"></a>2.8 ç«¯å£å·</h2><ul><li>ç”¨æ¥è¯†åˆ«åŒä¸€å°è®¡ç®—æœºä¸­è¿›è¡Œé€šä¿¡çš„ä¸åŒåº”ç”¨ç¨‹åºã€‚</li><li>æ ‡å‡†æ—¢å®šçš„ç«¯å£å·ï¼Œå³<code>çŸ¥åç«¯å£å·</code>ï¼Œåˆ†å¸ƒåœ¨<code>0 ~ 1023</code> ä¹‹é—´ã€‚æ¯”å¦‚HTTPï¼ˆ80ï¼‰ã€FTPï¼ˆ22ï¼‰ã€‚</li><li>æ­£å¼æ³¨å†Œçš„ç«¯å£å·ï¼Œå®ƒä»¬åˆ†å¸ƒåœ¨<code>1024 ~ 49151</code> ä¹‹é—´ã€‚</li><li>æ“ä½œç³»ç»Ÿåˆ†é…ï¼ŒåŠ¨æ€åˆ†é…çš„ç«¯å£å·èŒƒå›´åœ¨<code>49152~65535</code> ä¹‹é—´ã€‚</li></ul><h2 id="2-9-äº”å…ƒç´ è¯†åˆ«å”¯ä¸€ä¸€ä¸ªç½‘ç»œé€šä¿¡"><a href="#2-9-äº”å…ƒç´ è¯†åˆ«å”¯ä¸€ä¸€ä¸ªç½‘ç»œé€šä¿¡" class="headerlink" title="2.9 äº”å…ƒç´ è¯†åˆ«å”¯ä¸€ä¸€ä¸ªç½‘ç»œé€šä¿¡"></a>2.9 äº”å…ƒç´ è¯†åˆ«å”¯ä¸€ä¸€ä¸ªç½‘ç»œé€šä¿¡</h2><p>äº”å…ƒç´ ï¼šæºIPåœ°å€ã€ç›®æ ‡IPåœ°å€ã€åè®®å·ï¼ˆåè®®ç±»å‹ï¼‰ã€æºç«¯å£å·ä»¥åŠç›®æ ‡ç«¯å£å·ã€‚<br><img src="https://cdn.jsdelivr.net/gh/zyxelva/picgo@main/markdown/%E4%BA%94%E5%85%83%E7%B4%A0.png" alt="äº”å…ƒç´ "></p><h1 id="3-TCPæ¦‚è¿°"><a href="#3-TCPæ¦‚è¿°" class="headerlink" title="3.TCPæ¦‚è¿°"></a>3.TCPæ¦‚è¿°</h1><p><code>TCP(Transmission Control Protocol)</code>æ˜¯<code>é¢å‘è¿æ¥</code>çš„é€šä¿¡åè®®ï¼Œé€šè¿‡<code>ä¸‰æ¬¡æ¡æ‰‹</code>å»ºç«‹è¿æ¥ï¼Œ ç„¶åæ‰èƒ½å¼€å§‹æ•°æ®çš„è¯»å†™ï¼Œé€šè®¯å®Œæˆæ—¶è¦æ‹†é™¤è¿æ¥ï¼ˆ<code>å››æ¬¡æŒ¥æ‰‹</code>ï¼‰ï¼Œç”±äº TCP æ˜¯é¢å‘è¿æ¥çš„æ‰€ä»¥åªèƒ½ç”¨äº<code>ç«¯åˆ°ç«¯</code>çš„é€šè®¯ã€‚</p><p>TCP æä¾›çš„æ˜¯ä¸€ç§<code>å¯é çš„</code>æ•°æ®æµæœåŠ¡ï¼Œæ•°æ®æœ‰å¯èƒ½è¢«æ‹†åˆ†åå‘é€ï¼Œé‚£ä¹ˆé‡‡ç”¨<code>è¶…æ—¶é‡ä¼ æœºåˆ¶</code>å’Œ<code>åº”ç­”ç¡®è®¤æœºåˆ¶</code>æ˜¯ç»„æˆ TCP å¯é ä¼ è¾“çš„å…³é”®è®¾è®¡ã€‚</p><h2 id="3-1-ä¸‰æ¬¡æ¡æ‰‹-å»ºç«‹è¿æ¥"><a href="#3-1-ä¸‰æ¬¡æ¡æ‰‹-å»ºç«‹è¿æ¥" class="headerlink" title="3.1 ä¸‰æ¬¡æ¡æ‰‹-å»ºç«‹è¿æ¥"></a>3.1 ä¸‰æ¬¡æ¡æ‰‹-å»ºç«‹è¿æ¥</h2><p><img src="https://cdn.jsdelivr.net/gh/zyxelva/picgo@main/markdown/%E4%B8%89%E6%AC%A1%E6%8F%A1%E6%89%8B.png" alt="ä¸‰æ¬¡æ¡æ‰‹"><br>TCP æä¾›é¢å‘æœ‰è¿æ¥çš„é€šä¿¡ä¼ è¾“ã€‚</p><blockquote><p>é¢å‘æœ‰è¿æ¥æ˜¯æŒ‡åœ¨æ•°æ®é€šä¿¡å¼€å§‹ä¹‹å‰å…ˆåšå¥½ä¸¤ç«¯ä¹‹é—´çš„å‡†å¤‡å·¥ä½œã€‚</p></blockquote><h3 id="3-1-1-è¿‡ç¨‹"><a href="#3-1-1-è¿‡ç¨‹" class="headerlink" title="3.1.1 è¿‡ç¨‹"></a>3.1.1 è¿‡ç¨‹</h3><p>æ‰€è°“<code>ä¸‰æ¬¡æ¡æ‰‹</code>æ˜¯æŒ‡å»ºç«‹ä¸€ä¸ª TCP è¿æ¥æ—¶éœ€è¦å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ç«¯æ€»å…±å‘é€<code>ä¸‰ä¸ªåŒ…</code>ä»¥ç¡®è®¤è¿æ¥çš„å»ºç«‹ã€‚åœ¨ <code>socket</code> ç¼–ç¨‹ä¸­ï¼Œè¿™ä¸€è¿‡ç¨‹ç”±å®¢æˆ·ç«¯æ‰§è¡Œ <code>connect</code> æ¥è§¦å‘ã€‚</p><ul><li><p>ç¬¬ä¸€æ¬¡æ¡æ‰‹<br>  å®¢æˆ·ç«¯å°†æ ‡å¿—ä½ <code>SYN ç½®ä¸º 1</code>ï¼Œéšæœºäº§ç”Ÿä¸€ä¸ªå€¼ <code>seq=J</code>ï¼Œå¹¶å°†è¯¥æ•°æ®åŒ…å‘é€ç»™æœåŠ¡å™¨ç«¯ï¼Œå®¢æˆ·ç«¯è¿›å…¥ <code>SYN_SENT</code>çŠ¶æ€ï¼Œç­‰å¾…æœåŠ¡å™¨ç«¯ç¡®è®¤ã€‚</p></li><li><p>ç¬¬äºŒæ¬¡æ¡æ‰‹<br>  æœåŠ¡å™¨ç«¯æ”¶åˆ°æ•°æ®åŒ…åç”±æ ‡å¿—ä½ <code>SYN=1</code> çŸ¥é“å®¢æˆ·ç«¯è¯·æ±‚å»ºç«‹è¿æ¥ï¼ŒæœåŠ¡å™¨ç«¯å°†æ ‡å¿—ä½ <code>SYN</code> å’Œ <code>ACK</code> éƒ½ç½®ä¸º 1ï¼Œ<code>ack=J+1</code>ï¼Œéšæœºäº§ç”Ÿä¸€ä¸ªå€¼ <code>seq=K</code>ï¼Œå¹¶å°†è¯¥æ•°æ®åŒ…å‘é€ç»™å®¢æˆ·ç«¯ä»¥ç¡®è®¤è¿æ¥è¯·æ±‚ï¼ŒæœåŠ¡å™¨ç«¯è¿›å…¥ <code>SYN_RCVD</code> çŠ¶æ€ã€‚</p></li><li><p>ç¬¬ä¸‰æ¬¡æ¡æ‰‹<br>  å®¢æˆ·ç«¯æ”¶åˆ°ç¡®è®¤åï¼Œæ£€æŸ¥ <code>ack</code> æ˜¯å¦ä¸º <code>J+1</code>ï¼Œ<code>ACK</code> æ˜¯å¦ä¸º 1ï¼Œå¦‚æœæ­£ç¡®åˆ™å°†æ ‡å¿—ä½ <code>ACK</code> ç½®ä¸º 1ï¼Œ<code>ack=K+1</code>ï¼Œå¹¶å°†è¯¥æ•°æ®åŒ…å‘é€ç»™æœåŠ¡å™¨ç«¯ï¼ŒæœåŠ¡å™¨ç«¯æ£€æŸ¥ <code>ack</code> æ˜¯å¦ä¸º <code>K+1</code>ï¼Œ <code>ACK</code> æ˜¯å¦ä¸º 1ï¼Œå¦‚æœæ­£ç¡®åˆ™è¿æ¥å»ºç«‹æˆåŠŸï¼Œå®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ç«¯è¿›å…¥ <code>ESTABLISHED</code> çŠ¶æ€ï¼Œå®Œæˆ<code>ä¸‰æ¬¡æ¡æ‰‹</code>ï¼Œéšåå®¢æˆ·ç«¯ä¸æœåŠ¡å™¨ç«¯ä¹‹é—´å¯ä»¥å¼€å§‹ä¼ è¾“æ•°æ®äº†ã€‚</p></li></ul><blockquote><p>ä¸‰æ¬¡æ¡æ‰‹æ˜¯ä¿è¯æ•°æ®å¯é ä¼ è¾“åˆèƒ½æé«˜ä¼ è¾“æ•ˆç‡çš„<code>æœ€å°æ¬¡æ•°</code>.<br>ä¸‰æ¬¡æ¡æ‰‹çš„è¿‡ç¨‹å³æ˜¯é€šä¿¡åŒæ–¹ç›¸äº’å‘ŠçŸ¥<code>åºåˆ—å·èµ·å§‹å€¼</code>ï¼Œå¹¶<code>ç¡®è®¤</code>å¯¹æ–¹å·²ç»æ”¶åˆ°äº†åºåˆ—å·èµ·å§‹å€¼çš„å¿…ç»æ­¥éª¤.</p></blockquote><h3 id="3-1-2-TCP-çš„ä¸‰æ¬¡æ¡æ‰‹çš„æ¼æ´-SYN-æ´ªæ³›æ”»å‡»"><a href="#3-1-2-TCP-çš„ä¸‰æ¬¡æ¡æ‰‹çš„æ¼æ´-SYN-æ´ªæ³›æ”»å‡»" class="headerlink" title="3.1.2 TCP çš„ä¸‰æ¬¡æ¡æ‰‹çš„æ¼æ´-SYN æ´ªæ³›æ”»å‡»"></a>3.1.2 TCP çš„ä¸‰æ¬¡æ¡æ‰‹çš„æ¼æ´-SYN æ´ªæ³›æ”»å‡»</h3><p>ä¸‰æ¬¡æ¡æ‰‹ä¸­æœ‰ä¸€ä¸ª<code>ç¬¬äºŒæ¬¡æ¡æ‰‹</code>ï¼ŒæœåŠ¡ç«¯å‘å®¢æˆ·ç«¯<code>åº”ç­”è¯·æ±‚</code>ï¼Œåº”ç­”è¯·æ±‚æ˜¯éœ€è¦å®¢æˆ·ç«¯IP çš„ï¼Œæ”»å‡»è€…å°±<code>ä¼ªé€ </code>è¿™ä¸ªIPï¼Œå¾€æœåŠ¡å™¨ç«¯<code>ç‹‚å‘é€</code>ç¬¬ä¸€æ¬¡æ¡æ‰‹çš„å†…å®¹ï¼Œå½“ç„¶ç¬¬ä¸€æ¬¡æ¡æ‰‹ä¸­çš„å®¢æˆ·ç«¯IP åœ°å€æ˜¯<code>ä¼ªé€ çš„</code>ï¼Œä»è€ŒæœåŠ¡ç«¯å¿™äºè¿›è¡Œç¬¬äºŒæ¬¡æ¡æ‰‹ä½†æ˜¯ç¬¬äºŒæ¬¡æ¡æ‰‹å½“ç„¶æ²¡æœ‰ç»“æœï¼Œæ‰€ä»¥å¯¼è‡´æœåŠ¡å™¨ç«¯è¢«æ‹–ç´¯ï¼Œæ­»æœº.</p><p>è§£å†³æ–¹æ¡ˆ:</p><ul><li><code>æ— æ•ˆè¿æ¥ç›‘è§†é‡Šæ”¾ï¼ˆä¸æ¨èï¼‰</code>ï¼Œä¸åœç›‘è§†æ‰€æœ‰çš„è¿æ¥ï¼ŒåŒ…æ‹¬ä¸‰æ¬¡æ¡æ‰‹çš„ï¼Œè¿˜æœ‰æ¡æ‰‹ä¸€æ¬¡çš„ï¼Œå½“è¾¾åˆ°ä¸€å®š(ä¸)é˜ˆå€¼æ—¶æ‹†é™¤è¿™äº›è¿æ¥ï¼Œä»è€Œé‡Šæ”¾ç³»ç»Ÿèµ„æºï¼Œä¸ç®¡æ˜¯æ­£å¸¸çš„è¿˜æ˜¯æ”»å‡»çš„ï¼›</li><li><code>å»¶ç¼“TCB åˆ†é…æ–¹æ³•</code>ï¼Œä¸€èˆ¬çš„åšå®Œç¬¬ä¸€æ¬¡æ¡æ‰‹ä¹‹åï¼ŒæœåŠ¡å™¨å°±éœ€è¦ä¸ºè¯¥è¯·æ±‚åˆ†é…ä¸€ä¸ª<code>TCBï¼ˆè¿æ¥æ§åˆ¶èµ„æºï¼Œè¦200å¤šä¸ªå­—èŠ‚ï¼‰</code>ï¼Œå½“æ­£å¸¸è¿æ¥å»ºç«‹èµ·æ¥åå†åˆ†é…TCB åˆ™å¯ä»¥æœ‰æ•ˆåœ°å‡è½»æœåŠ¡å™¨èµ„æºçš„æ¶ˆè€—ï¼›</li><li><code>ä½¿ç”¨é˜²ç«å¢™</code>ï¼Œé˜²ç«å¢™åœ¨ç¡®è®¤äº†è¿æ¥çš„æœ‰æ•ˆæ€§åï¼Œæ‰å‘å†…éƒ¨çš„æœåŠ¡å™¨ï¼ˆ<code>Listener</code>ï¼‰å‘èµ·<code>SYN</code> è¯·æ±‚</li></ul><h2 id="3-2-å››æ¬¡æŒ¥æ‰‹-æ–­å¼€è¿æ¥"><a href="#3-2-å››æ¬¡æŒ¥æ‰‹-æ–­å¼€è¿æ¥" class="headerlink" title="3.2 å››æ¬¡æŒ¥æ‰‹-æ–­å¼€è¿æ¥"></a>3.2 å››æ¬¡æŒ¥æ‰‹-æ–­å¼€è¿æ¥</h2><p><img src="https://cdn.jsdelivr.net/gh/zyxelva/picgo@main/markdown/%E5%9B%9B%E6%AC%A1%E6%8C%A5%E6%89%8B.png" alt="å››æ¬¡æŒ¥æ‰‹"></p><ul><li>ä¸ºä»€ä¹ˆTCP çš„æŒ¥æ‰‹éœ€è¦å››æ¬¡ï¼ŸTCP æ˜¯<code>å…¨åŒå·¥</code>çš„è¿æ¥ï¼Œå¿…é¡»ä¸¤ç«¯<code>åŒæ—¶å…³é—­</code>è¿æ¥ï¼Œè¿æ¥æ‰ç®—çœŸæ­£å…³é—­;</li><li>ä¸ºä»€ä¹ˆéœ€è¦<code>TIME-WAIT</code> çŠ¶æ€ï¼Ÿ<ul><li>å¯é çš„ç»ˆæ­¢TCP è¿æ¥</li><li>ä¿è¯è®©è¿Ÿæ¥çš„TCP æŠ¥æ–‡æœ‰è¶³å¤Ÿçš„æ—¶é—´è¢«è¯†åˆ«å¹¶ä¸¢å¼ƒ</li></ul></li></ul><h1 id="4-ç½‘ç»œå·¥å…·"><a href="#4-ç½‘ç»œå·¥å…·" class="headerlink" title="4.ç½‘ç»œå·¥å…·"></a>4.ç½‘ç»œå·¥å…·</h1><ul><li>WireShark</li><li>tcpdump</li></ul><h1 id="5-HTTP"><a href="#5-HTTP" class="headerlink" title="5.HTTP"></a>5.HTTP</h1><p>HTTP åè®®æ˜¯ <code>Hyper Text Transfer Protocol(è¶…æ–‡æœ¬ä¼ è¾“åè®®)</code>çš„ç¼©å†™,æ˜¯ç”¨äºä»ä¸‡ç»´ç½‘ (<code>WWW:World Wide Web</code> )æœåŠ¡å™¨ä¼ è¾“<code>è¶…æ–‡æœ¬</code>åˆ°æœ¬åœ°æµè§ˆå™¨çš„ä¼ é€åè®®ã€‚</p><ul><li><p>HTTP æ˜¯ä¸€ä¸ª<code>æ— çŠ¶æ€</code>çš„åè®®ã€‚</p><blockquote><p>æ— çŠ¶æ€æ˜¯æŒ‡å®¢æˆ·æœº(Web æµè§ˆå™¨)å’ŒæœåŠ¡å™¨ä¹‹é—´ä¸éœ€è¦å»ºç«‹æŒä¹…çš„è¿æ¥ï¼Œ è¿™æ„å‘³ç€å½“ä¸€ä¸ªå®¢æˆ·ç«¯å‘æœåŠ¡å™¨ç«¯å‘å‡ºè¯·æ±‚ï¼Œç„¶åæœåŠ¡å™¨è¿”å›å“åº”(response)ï¼Œè¿æ¥å°±è¢«å…³é—­äº†ï¼Œåœ¨æœ åŠ¡å™¨ç«¯ä¸ä¿ç•™è¿æ¥çš„æœ‰å…³ä¿¡æ¯ã€‚</p></blockquote></li><li><p>HTTP ä½¿ç”¨ç»Ÿä¸€èµ„æºæ ‡è¯†ç¬¦(<code>Uniform Resource Identifiers, URI</code>)æ¥ä¼ è¾“æ•°æ®å’Œå»ºç«‹è¿æ¥ã€‚</p></li><li><p><code>URL</code> æ˜¯ä¸€ç§ç‰¹æ®Šç±»å‹çš„ <code>URI</code>ï¼ŒåŒ…å«äº†ç”¨äºæŸ¥æ‰¾æŸä¸ªèµ„æºçš„è¶³å¤Ÿçš„ä¿¡æ¯ã€‚  </p><blockquote><p>URLï¼Œå…¨ç§°æ˜¯ <code>Uniform Resource Locator</code>, ä¸­æ–‡å«<code>ç»Ÿä¸€èµ„æºå®šä½ç¬¦</code>ï¼Œæ˜¯äº’è”ç½‘ä¸Šç”¨æ¥æ ‡è¯†æŸä¸€å¤„èµ„æºçš„åœ°å€ã€‚</p></blockquote></li><li><p>ä¼ è¾“æµç¨‹</p><ul><li>åœ°å€è§£æ</li><li>å°è£… HTTP è¯·æ±‚æ•°æ®åŒ…</li><li>å°è£…æˆ TCP åŒ…å¹¶å»ºç«‹è¿æ¥</li><li>å®¢æˆ·æœºå‘é€è¯·æ±‚å‘½ä»¤</li><li>æœåŠ¡å™¨å“åº”</li><li>æœåŠ¡å™¨å…³é—­ TCP è¿æ¥</li></ul></li></ul><p>ä¸€å¥—å®Œæ•´çš„ç½‘ç»œçš„æµç¨‹<br><img src="https://cdn.jsdelivr.net/gh/zyxelva/picgo@main/markdown/%E5%AE%8C%E6%95%B4%E7%9A%84%E7%BD%91%E7%BB%9C%E7%9A%84%E6%B5%81%E7%A8%8B.png" alt="å®Œæ•´çš„ç½‘ç»œæµç¨‹"></p><h2 id="5-1-HTTP-åè®®æŠ¥æ–‡ç»“æ„"><a href="#5-1-HTTP-åè®®æŠ¥æ–‡ç»“æ„" class="headerlink" title="5.1 HTTP åè®®æŠ¥æ–‡ç»“æ„"></a>5.1 HTTP åè®®æŠ¥æ–‡ç»“æ„</h2><p>ç”¨äº HTTP åè®®äº¤äº’çš„ä¿¡æ¯è¢«ç§°ä¸º <code>HTTP æŠ¥æ–‡</code>ã€‚</p><ul><li><code>è¯·æ±‚ç«¯(å®¢æˆ·ç«¯)</code>çš„ HTTP æŠ¥æ–‡å«åš <code>è¯·æ±‚æŠ¥æ–‡</code>;</li><li><code>å“åº”ç«¯(æœåŠ¡å™¨ç«¯)</code>çš„å«åš<code>å“åº”æŠ¥æ–‡</code>ã€‚<br><code>HTTP æŠ¥æ–‡</code>æœ¬èº«æ˜¯ç”±<code>å¤šè¡Œ</code>(ç”¨ CR+LF ä½œæ¢è¡Œç¬¦)æ•°æ®æ„æˆçš„å­—ç¬¦ä¸²æ–‡æœ¬ã€‚</li></ul><p>HTTP æŠ¥æ–‡å¤§è‡´å¯åˆ†ä¸º<code>æŠ¥æ–‡é¦–éƒ¨</code>å’Œ<code>æŠ¥æ–‡ä¸»ä½“</code>ä¸¤éƒ¨åˆ†ã€‚ä¸¤è€…ç”±æœ€åˆå‡ºç°çš„ç©ºè¡Œ(CR+LF) æ¥åˆ’åˆ†ã€‚é€šå¸¸ï¼Œå¹¶ä¸ä¸€å®šæœ‰æŠ¥æ–‡ä¸»ä½“ã€‚</p><p><img src="https://img.halfrost.com/Blog/ArticleImage/89_7.png"></p><h3 id="5-1-1-è¯·æ±‚æŠ¥æ–‡"><a href="#5-1-1-è¯·æ±‚æŠ¥æ–‡" class="headerlink" title="5.1.1 è¯·æ±‚æŠ¥æ–‡"></a>5.1.1 è¯·æ±‚æŠ¥æ–‡</h3><p><img src="https://img.halfrost.com/Blog/ArticleImage/89_8.png"></p><h3 id="5-1-2-å“åº”æŠ¥æ–‡"><a href="#5-1-2-å“åº”æŠ¥æ–‡" class="headerlink" title="5.1.2 å“åº”æŠ¥æ–‡"></a>5.1.2 å“åº”æŠ¥æ–‡</h3><p><img src="https://img.halfrost.com/Blog/ArticleImage/89_9.png"></p><p>è¯·æ±‚&#x2F;å“åº”æŠ¥æ–‡å®ä¾‹ï¼š<br><img src="https://img.halfrost.com/Blog/ArticleImage/89_10.png"></p><p>å…·ä½“å¯å‚è€ƒ ã€Šå›¾è§£ HTTPã€‹ã€ŠHTTP æƒå¨æŒ‡å—ã€‹ï¼Œä»¥åŠ<a href="https://halfrost.com/http/">éœœç¥</a></p>]]></content>
      
      
      <categories>
          
          <category> Nettyå­¦ä¹  </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Netty </tag>
            
            <tag> ç½‘ç»œåè®® </tag>
            
            <tag> TCP/IP </tag>
            
            <tag> HTTP </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ã€Zookeeperå­¦ä¹ ã€‘3.Zookeeperå­¦ä¹ æµç¨‹</title>
      <link href="/posts/824710590.html"/>
      <url>/posts/824710590.html</url>
      
        <content type="html"><![CDATA[<h1 id="1-ä¸ºä»€ä¹ˆå­¦ä¹ -Zookeeper"><a href="#1-ä¸ºä»€ä¹ˆå­¦ä¹ -Zookeeper" class="headerlink" title="1 ä¸ºä»€ä¹ˆå­¦ä¹  Zookeeper"></a>1 ä¸ºä»€ä¹ˆå­¦ä¹  Zookeeper</h1><p>åº”è¯¥é‡ç‚¹æŒæ¡åˆ†å¸ƒå¼ç¯å¢ƒçš„æ¼”è¿›è¿‡ç¨‹ï¼Œä»ä¸€ä¸ªå•èŠ‚ç‚¹å¼€å§‹ï¼Œæ…¢æ…¢è¿‡æ¸¡åˆ°åˆ†å¸ƒå¼ï¼Œä¸ºä»€ä¹ˆå•èŠ‚ç‚¹ä¸è¡Œï¼Œä¼ ç»Ÿä¸€ä¸ª tomcat æ‰“å¤©ä¸‹æœ‰ä»€ä¹ˆæœ‰ç‚¹ï¼Œç¼ºç‚¹åˆæ˜¯ä»€ä¹ˆï¼Œå½“ä¸€ä¸ª tomcat æä¸å®šçš„æ—¶å€™ï¼Œåˆ†å¸ƒå¼çš„æ¶æ„å›¾åˆæ˜¯ä»€ä¹ˆæ ·çš„ï¼Œ</p><p>ä¼ ç»Ÿçš„å•èŠ‚ç‚¹æ¶æ„è‡ªç„¶æœ‰é—®é¢˜ï¼Œåˆ°äº†åˆ†å¸ƒå¼çš„æ¶æ„ä¸­ï¼Œé—®é¢˜è‚¯å®šä¹Ÿæœ‰ä¸å°‘ï¼Œè¿™äº›é—®é¢˜å°±æ˜¯æˆ‘ä»¬å­¦ä¹  ZK è¦è§£å†³çš„ï¼Œä½†å­¦ä¹ è¿™äº›è§£å†³æ–¹æ¡ˆä¹‹å‰ï¼Œè¿˜æ˜¯éœ€è¦æœ‰ç‚¹ç†è®ºåŸºç¡€ã€‚</p><p>æ¥ä¸‹æ¥å°±è¦äº†è§£ä¸‹ä»€ä¹ˆæ˜¯ zkï¼Œä¸ºä»€ä¹ˆå­¦ä¹  zkï¼Œzk åœ¨åˆ†å¸ƒå¼æ¶æ„ä¸­æ‰®æ¼”äº†ä»€ä¹ˆæ ·çš„è§’è‰²ã€‚ä»¥åŠé¢è¯•çš„æ—¶å€™ç»å¸¸ä¼šé—®åˆ°çš„é—®é¢˜ï¼Œå¿ƒé‡Œè¦æœ‰ä¸ªå¤§æ¦‚çš„äº†è§£ã€‚</p><h1 id="2-Zookeeper-åŸºç¡€"><a href="#2-Zookeeper-åŸºç¡€" class="headerlink" title="2 Zookeeper åŸºç¡€"></a>2 Zookeeper åŸºç¡€</h1><p>äº†è§£ zk æ˜¯ä»€ä¹ˆç©æ„åï¼Œæ¥ä¸‹æ¥å°±æŠŠ zk å®‰è£…å¥½ï¼Œå…ˆæ¥è®²è§£çš„æ˜¯ zk å•æœºéƒ¨ç½²ï¼Œè¿™ä¸ªéå¸¸å®¹æ˜“ï¼Œ è€Œä¸”åé¢ç»å¤§éƒ¨åˆ†çš„æ—¶é—´éƒ½æ˜¯ä½¿ç”¨å•èŠ‚ç‚¹æ¥ä½¿ç”¨çš„ï¼Œè‡³äºé›†ç¾¤çš„é…ç½®æ”¾åˆ°åé¢æ¥è®²ï¼Œæ­£åœ¨å·¥ä½œä¸­ï¼Œé›†ç¾¤çš„ç»´æŠ¤åº”è¯¥æ˜¯è¿ç»´æ¥åšï¼Œå“ªæ€•æ²¡æœ‰è¿ç»´ï¼Œåœ¨åé¢é€šè¿‡è¯¦ç»†çš„å­¦ä¹ é€šè¿‡ä¹Ÿèƒ½åœ¨ 20 åˆ†é’Ÿå†…å®Œå…¨æ­å»ºèµ·æ¥ï¼ŒåŒå­¦ä»¬ä¸ç”¨ç€æ€¥ã€‚</p><p>Zk çš„ç‰¹æ€§ï¼šè¿™å—æ˜¯é‡ç‚¹ä¹‹ä¸­çš„é‡ç‚¹ï¼Œåé¢å­¦ä¹ çš„ä¸€åˆ‡æ“ä½œï¼ŒåŒ…æ‹¬å®æˆ˜ï¼Œéƒ½æ˜¯å»ºç«‹åœ¨è¿™åŸºç¡€ä¹‹ä¸Šçš„ã€‚å…¶ä¸­æ•°æ®æ¨¡å‹å’Œ watch æœºåˆ¶åˆæ˜¯æœ€æœ€é‡è¦çš„ã€‚</p><h1 id="3-Zookeeper-è¿›é˜¶"><a href="#3-Zookeeper-è¿›é˜¶" class="headerlink" title="3 Zookeeper è¿›é˜¶"></a>3 Zookeeper è¿›é˜¶</h1><p>å®‰è£…å¥½äº†zk,å¯¹ zk åŸºç¡€æœ‰ä¸€å®šçš„äº†è§£åï¼Œæ¥ä¸‹æ¥å°±å­¦ä¹ æ€ä¹ˆæ“ä½œzk,é¦–å…ˆäº†è§£åŸºç¡€zkå®¢æˆ·ç«¯çš„ä½¿ç”¨ã€‚<br>å®¢æˆ·ç«¯çš„ç®€å•ä½¿ç”¨èƒ½è§£å†³ä¸€äº›é—®é¢˜ï¼Œæ–¹ä¾¿æŸ¥çœ‹ä¿¡æ¯ï¼Œç®€å•çœäº‹ï¼Œä½†çœŸæ­£å¯¹äºæˆ‘ä»¬javaæ¶æ„å¸ˆæ¥è¯´æœ€é‡è¦çš„æ˜¯javaå®¢æˆ·ç«¯ï¼ŒåŒ…æ‹¬åŸç”Ÿçš„ï¼Œzkclientä»¥åŠ curotorï¼ŒåŒå­¦ä»¬æœ€å°‘è¦ç†Ÿç»ƒä½¿ç”¨å…¶ä¸­çš„ä¸€ç§ï¼Œå¦å¤–çš„åœ¨å·¥ä½œä¸­ä¹Ÿè¦å¾ˆå¿«çš„ç™¾åº¦å¾—å‡ºæ¥ã€‚</p><h1 id="4-Zookeeper-é«˜çº§çŸ¥è¯†"><a href="#4-Zookeeper-é«˜çº§çŸ¥è¯†" class="headerlink" title="4 Zookeeper é«˜çº§çŸ¥è¯†"></a>4 Zookeeper é«˜çº§çŸ¥è¯†</h1><p>è¿™ä¸€å—ä¸éœ€è¦åŒå­¦å®Œå…¨å¬æ‡‚ï¼ŒæŒæ¡ 40%-50%å°±å¤Ÿäº†ï¼Œå·¥ä½œä¸­å¾ˆå°‘ç”¨åˆ°ï¼Œä½†ç¡®å®é¢è¯•çš„æ—¶å€™çš„åŠ åˆ†é¡¹ï¼Œ</p><h1 id="5-æ€»ç»“"><a href="#5-æ€»ç»“" class="headerlink" title="5 æ€»ç»“"></a>5 æ€»ç»“</h1><p>ä¸ç®¡æ€ä¹ˆæ ·ï¼Œå…¶ä¸­çš„zkåŸºç¡€ï¼Œzkè¿›é˜¶å®¢æˆ·ç«¯çš„ä½¿ç”¨ï¼Œä»¥åŠzké¡¹ç›®å®æˆ˜è¯·åŠ¡å¿…é‡è§†èµ·æ¥ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> Zookeeperå­¦ä¹  </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Zookeeper </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ã€Zookeeperå­¦ä¹ ã€‘2.ä¸€è‡´æ€§åè®®</title>
      <link href="/posts/1339151935.html"/>
      <url>/posts/1339151935.html</url>
      
        <content type="html"><![CDATA[<p>ä¸Šä¸€ç« ï¼Œæˆ‘ä»¬äº†è§£äº†åˆ†å¸ƒå¼äº‹åŠ¡çš„å®šä¹‰åŠç›¸å…³çš„ç†è®ºï¼Œä»ç†è®ºä¸Šæ¥çœ‹ï¼Œå¯ä»¥å¯¹åˆ†å¸ƒå¼äº‹åŠ¡åˆ†ä¸ºä¸¤ç±»ï¼š</p><ul><li><p>åˆšæ€§äº‹åŠ¡</p><blockquote><p>å¯¹äºæ»¡è¶³<code>CPæ¨¡å‹</code>çš„äº‹åŠ¡ï¼Œéµå¾ªACIDï¼Œå¯¹æ•°æ®è¦æ±‚å¼ºä¸€è‡´æ€§ã€‚<br>å®ç°æ–¹æ¡ˆï¼šåŸºäº<code>XAåè®®</code>çš„<code>2PC</code>ï¼Œ<code>3PC</code>ï¼›Javaäº‹åŠ¡è§„èŒƒçš„<code>JTA</code>ã€<code>JTS</code>ã€‚</p></blockquote></li><li><p>æŸ”æ€§äº‹åŠ¡</p><blockquote><p>å¯¹äºæ»¡è¶³<code>APæ¨¡å‹</code>çš„äº‹åŠ¡ï¼Œéµå¾ª<code>BASE</code>ï¼Œå…è®¸ä¸€å®šæ—¶é—´å†…ä¸åŒèŠ‚ç‚¹çš„æ•°æ®ä¸ä¸€è‡´ï¼Œä½†è¦æ±‚æœ€ç»ˆä¸€è‡´ã€‚<br>å®ç°æ–¹æ¡ˆï¼š<code>è¡¥å¿åè®®ï¼šTCCï¼ŒSAGA</code>ï¼›åŸºäº<code>æœ€ç»ˆä¸€è‡´æ€§</code>çš„<code>æœ¬åœ°æ¶ˆæ¯è¡¨</code>ï¼Œ<code>å¯é æ¶ˆæ¯</code>ï¼Œ<code>æœ€å¤§åŠªåŠ›é€šçŸ¥</code>ç­‰ã€‚</p></blockquote></li></ul><h1 id="1-åˆ†å¸ƒå¼åè®®"><a href="#1-åˆ†å¸ƒå¼åè®®" class="headerlink" title="1 åˆ†å¸ƒå¼åè®®"></a>1 åˆ†å¸ƒå¼åè®®</h1><p>ä¸ºäº†è§£å†³åˆ†å¸ƒå¼ä¸€è‡´æ€§é—®é¢˜ï¼Œæ¶Œç°äº†ä¸€å¤§æ‰¹ç»å…¸çš„ä¸€è‡´æ€§åè®®å’Œç®—æ³•ï¼Œæœ€æœ‰åçš„æœ‰<code>äºŒé˜¶æ®µæäº¤åè®®ï¼ˆ2PCï¼‰</code>ã€<code>ä¸‰é˜¶æ®µæäº¤åè®®ï¼ˆ3PCï¼‰</code>å’Œ<code>Paxosç®—æ³•</code>ã€‚</p><h2 id="1-1-XAåè®®"><a href="#1-1-XAåè®®" class="headerlink" title="1.1 XAåè®®"></a>1.1 XAåè®®</h2><p>å½“ä¸€ä¸ªäº‹åŠ¡æ“ä½œéœ€è¦è·¨è¶Šå¤šä¸ªåˆ†å¸ƒå¼èŠ‚ç‚¹æ—¶ï¼Œä¸ºäº†ä¿æŒäº‹åŠ¡å¤„ç†çš„ACIDç‰¹æ€§ï¼Œå°±éœ€è¦å¼•å…¥ä¸€ä¸ª<strong>â€œåè°ƒè€…â€</strong>çš„ç»„ä»¶æ¥ç»Ÿä¸€è°ƒåº¦æ‰€æœ‰åˆ†å¸ƒå¼èŠ‚ç‚¹çš„æ‰§è¡Œï¼Œè¿™äº›è¢«è°ƒåº¦çš„åˆ†å¸ƒå¼èŠ‚ç‚¹åˆ™ç§°ä¸º<strong>â€œå‚ä¸è€…â€</strong>ï¼Œåè°ƒè€…è´Ÿè´£è°ƒåº¦å‚ä¸è€…çš„è¡Œä¸ºï¼Œå¹¶æœ€ç»ˆå†³å®šè¿™äº›å‚ä¸è€…æ˜¯å¦è¦æŠŠäº‹åŠ¡çœŸæ­£æäº¤ã€‚</p><blockquote><p><strong>XA åè®®</strong>æ˜¯ç”± X&#x2F;Open ç»„ç»‡æå‡ºçš„åˆ†å¸ƒå¼äº‹åŠ¡å¤„ç†è§„èŒƒï¼Œä¸»è¦å®šä¹‰äº†<strong>äº‹åŠ¡ç®¡ç†å™¨TM</strong>å’Œ <strong>æœ¬åœ°ï¼ˆæˆ–å±€éƒ¨ï¼‰èµ„æºç®¡ç†å™¨ RM</strong>ä¹‹é—´çš„æ¥å£ã€‚</p></blockquote><blockquote><p>ç›®å‰ä¸»æµçš„æ•°æ®åº“ï¼Œæ¯”å¦‚ <code>oracle</code>ã€<code>DB2</code> éƒ½æ˜¯æ”¯æŒ XA åè®®çš„ã€‚<code>MySQL</code> ä» 5.0 ç‰ˆæœ¬å¼€å§‹ï¼Œ<code>innoDB</code> å­˜å‚¨å¼•æ“å·²ç»æ”¯æŒ XA åè®®ã€‚</p></blockquote><p>åœ¨è¿™ä¸ªåè®®é‡Œï¼Œæœ‰ä¸‰ä¸ªè§’è‰²ï¼š</p><ul><li>APï¼ˆApplicationï¼‰ï¼šåº”ç”¨ç³»ç»Ÿï¼ˆæœåŠ¡ï¼‰</li><li>TMï¼ˆTransaction Managerï¼‰ï¼šäº‹åŠ¡ç®¡ç†å™¨ï¼ˆå…¨å±€äº‹åŠ¡ç®¡ç†ï¼‰</li><li>RMï¼ˆResource Managerï¼‰ï¼šèµ„æºç®¡ç†å™¨ï¼ˆæ•°æ®åº“ï¼‰</li></ul><blockquote><p>åŸºäºè¿™ç§æ€æƒ³ï¼Œè¡ç”Ÿå‡ºäº†äºŒé˜¶æ®µå’Œä¸‰é˜¶æ®µæäº¤åè®®ã€‚</p></blockquote><h3 id="1-1-1-2PC"><a href="#1-1-1-2PC" class="headerlink" title="1.1.1 2PC"></a>1.1.1 2PC</h3><p>ä¸¤é˜¶æ®µæäº¤åè®®2PCæ˜¯<code>Two-Phase Commit</code>çš„ç¼©å†™ï¼Œç›®å‰ç»å¤§éƒ¨åˆ†çš„å…³ç³»å‹æ•°æ®åº“éƒ½æ˜¯é‡‡ç”¨äºŒé˜¶æ®µæäº¤åè®®æ¥å®Œæˆåˆ†å¸ƒå¼äº‹åŠ¡å¤„ç†çš„ã€‚</p><p>é¡¾åæ€ä¹‰ï¼ŒäºŒé˜¶æ®µæäº¤åè®®æ˜¯å°†äº‹åŠ¡çš„æäº¤è¿‡ç¨‹åˆ†æˆä¸¤ä¸ªé˜¶æ®µæ¥è¿›è¡Œå¤„ç†</p><ul><li><p>é˜¶æ®µä¸€ï¼šæäº¤äº‹åŠ¡è¯·æ±‚</p><blockquote><p>é˜¶æ®µä¸€ä¹Ÿè¢«ç§°ä¸ºâ€œæŠ•ç¥¨é˜¶æ®µâ€ã€‚å³å„å‚ä¸è€…æŠ•ç¥¨è¡¨æ˜æ˜¯å¦éœ€è¦ç»§ç»­æ‰§è¡Œæ¥ä¸‹å»çš„äº‹åŠ¡æäº¤æ“ä½œã€‚</p></blockquote></li><li><p>é˜¶æ®µäºŒï¼šæ‰§è¡Œäº‹åŠ¡æäº¤</p><blockquote><p>åœ¨é˜¶æ®µäºŒä¸­ï¼Œåè°ƒè€…ä¼šæ ¹æ®å„å‚ä¸è€…åé¦ˆçš„æƒ…å†µæ¥å†³å®šæœ€ç»ˆæ˜¯å¦è¿›è¡Œäº‹åŠ¡æäº¤ã€‚</p></blockquote></li></ul><p><img src="https://cdn.jsdelivr.net/gh/zyxelva/picgo@main/markdown/2PC.png" alt="2PC"></p><p><strong>ä¼˜ç‚¹</strong>ï¼š</p><ul><li>åŸç†ç®€å•ï¼Œå®ç°æ–¹ä¾¿</li></ul><p><strong>ç¼ºç‚¹</strong>ï¼š</p><ul><li>åŒæ­¥é˜»å¡<blockquote><p>å„å‚ä¸è€…éƒ½éœ€è¦ç­‰å¾…å…¶ä»–å‚ä¸è€…çš„å“åº”ï¼ŒæœŸé—´ä»€ä¹ˆéƒ½åšä¸äº†ã€‚</p></blockquote></li><li>å•ç‚¹é—®é¢˜<blockquote><p>åè°ƒè€…æœ‰æ˜æ˜¾çš„å•ç‚¹é—®é¢˜ã€‚</p></blockquote></li><li>æ•°æ®ä¸ä¸€è‡´<blockquote><p>åè°ƒè€…å‘é€éƒ¨åˆ†èŠ‚ç‚¹commitæŒ‡ä»¤åæŒ‚äº†ï¼Œæ•°æ®å‡ºç°ä¸ä¸€è‡´ã€‚</p></blockquote></li></ul><p><strong>æ³¨æ„</strong>ï¼š</p><blockquote><p>2PCåªé€‚ç”¨ä¸¤ä¸ªæ•°æ®åº“ï¼ˆæ•°æ®åº“å®ç°äº†XAåè®®ï¼‰ä¹‹é—´ï¼›<br>2PCæœ‰è¯¸å¤šé—®é¢˜å’Œä¸ä¾¿ï¼Œåœ¨å®è·µä¸­ä¸€èˆ¬å¾ˆå°‘ä½¿ç”¨ã€‚</p></blockquote><h3 id="1-1-2-3PC"><a href="#1-1-2-3PC" class="headerlink" title="1.1.2 3PC"></a>1.1.2 3PC</h3><p>2PCåœ¨è¿è¡Œä¸­å­˜åœ¨åŒæ­¥é˜»å¡ã€åè°ƒè€…å•ç‚¹é—®é¢˜ã€æ•°æ®ä¸ä¸€è‡´çš„é—®é¢˜ï¼Œå› æ­¤åœ¨å…¶åŸºç¡€ä¸Šè¿›è¡Œäº†æ”¹è¿›ï¼Œæå‡ºäº†ä¸‰é˜¶æ®µåè®®ã€‚</p><p>3PCï¼Œæ˜¯<code>Three-Phase Commit</code>çš„ç¼©å†™ï¼Œæ˜¯2PCçš„æ”¹è¿›ç‰ˆï¼Œå…¶å°†2PCé˜¶æ®µä¸€å†åˆ†ä¸ºä¸¤ä¸ªé˜¶æ®µï¼šè¯¢é—®ã€é¢„æäº¤ã€‚</p><ul><li><p>é˜¶æ®µä¸€ï¼š<code>CanCommit</code></p><ul><li><p>äº‹åŠ¡è¯¢é—®ï¼šåè°ƒè€…å‘æ‰€æœ‰å‚ä¸è€…å‘é€åŒ…å«äº‹åŠ¡å†…å®¹çš„canCommitçš„è¯·æ±‚ï¼Œè¯¢é—®æ˜¯å¦å¯ä»¥æ‰§è¡Œäº‹åŠ¡æäº¤ï¼Œå¹¶ç­‰å¾…åº”ç­”ï¼›</p></li><li><p>å„å‚ä¸è€…åé¦ˆäº‹åŠ¡è¯¢é—®ï¼šæ­£å¸¸æƒ…å†µä¸‹ï¼Œå¦‚æœå‚ä¸è€…è®¤ä¸ºå¯ä»¥é¡ºåˆ©æ‰§è¡Œäº‹åŠ¡ï¼Œåˆ™è¿”å›Yesï¼Œå¦åˆ™è¿”å›Noã€‚</p></li></ul></li><li><p>é˜¶æ®µäºŒï¼š<code>PreCommit</code></p><p>  åœ¨æœ¬é˜¶æ®µï¼Œåè°ƒè€…ä¼šæ ¹æ®ä¸Šä¸€é˜¶æ®µçš„åé¦ˆæƒ…å†µæ¥å†³å®šæ˜¯å¦å¯ä»¥æ‰§è¡Œäº‹åŠ¡çš„PreCommitæ“ä½œã€‚ä¸¤ç§ç»“æœï¼š</p><ul><li><p>æ‰§è¡Œäº‹åŠ¡æäº¤</p><ul><li><p>å‘é€é¢„æäº¤è¯·æ±‚ã€‚åè°ƒè€…å‘æ‰€æœ‰èŠ‚ç‚¹å‘å‡ºPreCommitè¯·æ±‚ï¼Œå¹¶è¿›å…¥preparedé˜¶æ®µï¼›</p></li><li><p>äº‹åŠ¡é¢„æäº¤ã€‚å‚ä¸è€…æ”¶åˆ°PreCommitè¯·æ±‚åï¼Œä¼šæ‰§è¡Œäº‹åŠ¡æ“ä½œï¼Œå¹¶å°†Undoå’ŒRedoæ—¥å¿—å†™å…¥æœ¬æœºäº‹åŠ¡æ—¥å¿—ï¼›</p></li><li><p>å„å‚ä¸è€…æˆåŠŸæ‰§è¡Œäº‹åŠ¡æ“ä½œï¼ŒåŒæ—¶å°†åé¦ˆä»¥Ackå“åº”å½¢å¼å‘é€ç»™åè°ƒè€…ï¼ŒåŒäº‹ç­‰å¾…æœ€ç»ˆçš„Commitæˆ–AbortæŒ‡ä»¤ã€‚</p></li></ul></li><li><p>ä¸­æ–­äº‹åŠ¡</p><ul><li><p>åŠ å…¥ä»»æ„ä¸€ä¸ªå‚ä¸è€…å‘åè°ƒè€…å‘é€Noå“åº”ï¼Œæˆ–è€…ç­‰å¾…è¶…æ—¶ï¼Œåè°ƒè€…åœ¨æ²¡æœ‰å¾—åˆ°æ‰€æœ‰å‚ä¸è€…å“åº”æ—¶ï¼Œå³å¯ä»¥ä¸­æ–­äº‹åŠ¡ï¼›</p></li><li><p>å‘é€ä¸­æ–­è¯·æ±‚ã€‚åè°ƒè€…å‘æ‰€æœ‰å‚ä¸è€…å‘é€Abortè¯·æ±‚ï¼›</p></li><li><p>ä¸­æ–­äº‹åŠ¡ã€‚æ— è®ºæ˜¯æ”¶åˆ°åè°ƒè€…çš„Abortè¯·æ±‚ï¼Œè¿˜æ˜¯ç­‰å¾…åè°ƒè€…è¯·æ±‚è¿‡ç¨‹ä¸­å‡ºç°è¶…æ—¶ï¼Œå‚ä¸è€…éƒ½ä¼šä¸­æ–­äº‹åŠ¡ã€‚</p></li></ul></li></ul></li><li><p>é˜¶æ®µä¸‰ï¼š<code>doCommit</code></p><p>  ä¸¤ç§ç»“æœï¼š</p><ul><li><p>æ‰§è¡Œæäº¤</p><ul><li><p>å‘é€æäº¤è¯·æ±‚ã€‚å‡å¦‚åè°ƒè€…æ”¶åˆ°äº†æ‰€æœ‰å‚ä¸è€…çš„Ackå“åº”ï¼Œé‚£ä¹ˆå°†ä»é¢„æäº¤è½¬æ¢åˆ°æäº¤çŠ¶æ€ï¼Œå¹¶å‘æ‰€æœ‰å‚ä¸è€…ï¼Œå‘é€doCommitè¯·æ±‚ï¼›</p></li><li><p>äº‹åŠ¡æäº¤ã€‚å‚ä¸è€…æ”¶åˆ°doCommitè¯·æ±‚åï¼Œä¼šæ­£å¼æ‰§è¡Œäº‹åŠ¡æäº¤æ“ä½œï¼Œå¹¶åœ¨å®Œæˆæäº¤æ“ä½œåé‡Šæ”¾å ç”¨èµ„æºï¼›</p></li><li><p>åé¦ˆäº‹åŠ¡æäº¤ç»“æœã€‚å‚ä¸è€…å°†åœ¨å®Œæˆäº‹åŠ¡æäº¤åï¼Œå‘åè°ƒè€…å‘é€Ackæ¶ˆæ¯ï¼›</p></li><li><p>å®Œæˆäº‹åŠ¡ã€‚åè°ƒè€…æ¥æ”¶åˆ°æ‰€æœ‰å‚ä¸è€…çš„Ackæ¶ˆæ¯åï¼Œå®Œæˆäº‹åŠ¡ã€‚</p></li></ul></li><li><p>ä¸­æ–­äº‹åŠ¡</p><ul><li><p>åœ¨è¯¥é˜¶æ®µï¼Œå‡è®¾æ­£å¸¸çŠ¶æ€çš„åè°ƒè€…æ¥æ”¶åˆ°ä»»ä¸€ä¸ªå‚ä¸è€…å‘é€çš„Noå“åº”ï¼Œæˆ–åœ¨è¶…æ—¶æ—¶é—´å†…ï¼Œä»æ—§æ²¡æ”¶åˆ°åé¦ˆæ¶ˆæ¯ï¼Œå°±ä¼šä¸­æ–­äº‹åŠ¡ï¼›</p></li><li><p>å‘é€ä¸­æ–­è¯·æ±‚ã€‚åè°ƒè€…å‘æ‰€æœ‰çš„å‚ä¸è€…å‘é€abortè¯·æ±‚ï¼›</p></li><li><p>äº‹åŠ¡å›æ»šã€‚å‚ä¸è€…æ”¶åˆ°abortè¯·æ±‚åï¼Œä¼šåˆ©ç”¨é˜¶æ®µäºŒä¸­çš„Undoæ¶ˆæ¯æ‰§è¡Œäº‹åŠ¡å›æ»šï¼Œå¹¶åœ¨å®Œæˆå›æ»šåé‡Šæ”¾å ç”¨èµ„æºï¼›</p></li><li><p>åé¦ˆäº‹åŠ¡å›æ»šç»“æœã€‚å‚ä¸è€…åœ¨å®Œæˆå›æ»šåå‘åè°ƒè€…å‘é€Ackæ¶ˆæ¯ï¼›</p></li><li><p>ä¸­æ–­äº‹åŠ¡ã€‚åè°ƒè€…æ¥æ”¶åˆ°æ‰€æœ‰å‚ä¸è€…åé¦ˆçš„Ackæ¶ˆæ¯åï¼Œå®Œæˆäº‹åŠ¡ä¸­æ–­ã€‚</p></li></ul></li></ul></li></ul><p><img src="https://cdn.jsdelivr.net/gh/zyxelva/picgo@main/markdown/3PC.png" alt="3PC"></p><p>ä¸ä¸¤é˜¶æ®µæäº¤ä¸åŒçš„æ˜¯ï¼Œä¸‰é˜¶æ®µæäº¤æœ‰ä¸¤ä¸ªæ”¹åŠ¨ç‚¹ï¼š</p><ul><li>å¼•å…¥è¶…æ—¶æœºåˆ¶ã€‚åŒæ—¶åœ¨åè°ƒè€…å’Œå‚ä¸è€…ä¸­éƒ½å¼•å…¥è¶…æ—¶æœºåˆ¶ã€‚</li><li>åœ¨ç¬¬ä¸€é˜¶æ®µå’Œç¬¬äºŒé˜¶æ®µä¸­æ’å…¥ä¸€ä¸ªå‡†å¤‡é˜¶æ®µã€‚ä¿è¯äº†åœ¨æœ€åæäº¤é˜¶æ®µä¹‹å‰å„å‚ä¸èŠ‚ç‚¹çš„çŠ¶æ€æ˜¯ä¸€è‡´çš„ã€‚<blockquote><p>ä¹Ÿå°±æ˜¯è¯´ï¼Œé™¤äº†å¼•å…¥è¶…æ—¶æœºåˆ¶ä¹‹å¤–ï¼Œ3PCæŠŠ2PCçš„å‡†å¤‡é˜¶æ®µå†æ¬¡ä¸€åˆ†ä¸ºäºŒï¼Œè¿™æ ·ä¸‰é˜¶æ®µæäº¤å°±æœ‰CanCommitã€PreCommitã€DoCommitä¸‰ä¸ªé˜¶æ®µã€‚</p></blockquote></li></ul><p> <strong>ä¼˜ç‚¹</strong>ï¼š</p><ul><li>åˆ©ç”¨è¶…æ—¶æœºåˆ¶è§£å†³äº†2PCçš„åŒæ­¥é˜»å¡é—®é¢˜</li></ul><p> <strong>ç¼ºç‚¹</strong>ï¼š</p><ul><li>ä»ç„¶å­˜åœ¨ä¸€è‡´æ€§é—®é¢˜<blockquote><p>å› ä¸ºç½‘ç»œåŸå› ï¼Œåè°ƒè€…å‘é€çš„abortå“åº”æ²¡æœ‰åŠæ—¶è¢«å‚ä¸è€…æ¥æ”¶åˆ°ï¼Œé‚£ä¹ˆå‚ä¸è€…åœ¨ç­‰å¾…è¶…æ—¶ä¹‹åæ‰§è¡Œäº†commitæ“ä½œã€‚è¿™æ ·å°±å’Œå…¶ä»–æ¥åˆ°abortå‘½ä»¤å¹¶æ‰§è¡Œå›æ»šçš„å‚ä¸è€…ä¹‹é—´å­˜åœ¨æ•°æ®ä¸ä¸€è‡´çš„æƒ…å†µ</p></blockquote></li></ul><p><strong>2PCå’Œ3PCåï¼Œä¸¤è€…éƒ½æ— æ³•å½»åº•è§£å†³åˆ†å¸ƒå¼ä¸€è‡´æ€§é—®é¢˜ã€‚</strong></p><h2 id="1-2-Javaäº‹åŠ¡è§„èŒƒ"><a href="#1-2-Javaäº‹åŠ¡è§„èŒƒ" class="headerlink" title="1.2 Javaäº‹åŠ¡è§„èŒƒ"></a>1.2 Javaäº‹åŠ¡è§„èŒƒ</h2><p><code>XAåè®®</code>æ˜¯ä¸€ç§é€šç”¨çš„è§„èŒƒï¼Œä½†å¯¹äºJAVAæ¥è¯´ï¼Œå…¶è§„èŒƒå°±æ˜¯<code>JTA</code>ã€<code>JTS</code>.</p><h3 id="1-2-1-JTA"><a href="#1-2-1-JTA" class="headerlink" title="1.2.1 JTA"></a>1.2.1 JTA</h3><p>Javaäº‹åŠ¡APIï¼ˆJava Transaction APIï¼‰æ˜¯ä¸€ä¸ªJavaä¼ä¸šç‰ˆçš„åº”ç”¨ç¨‹åºæ¥å£ï¼Œåœ¨Javaç¯å¢ƒä¸­ï¼Œå…è®¸å®Œæˆè·¨è¶Šå¤šä¸ªXAèµ„æºçš„åˆ†å¸ƒå¼äº‹åŠ¡ã€‚</p><h3 id="1-2-2-JTS"><a href="#1-2-2-JTS" class="headerlink" title="1.2.2 JTS"></a>1.2.2 JTS</h3><p>Javaäº‹åŠ¡æœåŠ¡ï¼ˆJava Transaction Serviceï¼‰æ˜¯J2EEå¹³å°æä¾›äº†åˆ†å¸ƒå¼äº‹åŠ¡æœåŠ¡çš„å…·ä½“å®ç°è§„èŒƒï¼Œj2eeæœåŠ¡å™¨æä¾›å•†æ ¹æ®JTSè§„èŒƒå®ç°äº‹åŠ¡å¹¶æä¾›JTAæ¥å£ã€‚</p><h2 id="1-3-è¡¥å¿åè®®"><a href="#1-3-è¡¥å¿åè®®" class="headerlink" title="1.3 è¡¥å¿åè®®"></a>1.3 è¡¥å¿åè®®</h2><h3 id="1-3-1-TCC"><a href="#1-3-1-TCC" class="headerlink" title="1.3.1 TCC"></a>1.3.1 TCC</h3><p><code>TCCï¼ˆTry-Confirm-Cancelï¼‰</code>åˆè¢«ç§°è¡¥å¿äº‹åŠ¡ã€‚</p><ul><li>ä¸€ç§æœåŠ¡å±‚é¢ä¸Šçš„2PC<ul><li>2PCæ˜¯åœ¨æ•°æ®åº“å±‚é¢ï¼ŒTCCæ˜¯åœ¨åº”ç”¨å±‚é¢</li><li>é”ç²’åº¦æ›´å°</li></ul></li><li>ç¼ºç‚¹<ul><li>å¯¹åº”ç”¨çš„ä¾µå…¥æ€§éå¸¸å¼º</li><li>ä¸šåŠ¡ç´§è€¦åˆ</li><li>å®ç°éš¾åº¦ä¹Ÿæ¯”è¾ƒå¤§</li></ul></li></ul><p><img src="https://cdn.jsdelivr.net/gh/zyxelva/picgo@main/markdown/TCC.png" alt="TCC"></p><h3 id="1-3-2-Saga"><a href="#1-3-2-Saga" class="headerlink" title="1.3.2 Saga"></a>1.3.2 Saga</h3><p>ä¸šåŠ¡æµç¨‹ä¸­æ¯ä¸ªå‚ä¸è€…éƒ½æäº¤æœ¬åœ°äº‹åŠ¡ï¼Œå½“å‡ºç°æŸä¸€ä¸ªå‚ä¸è€…å¤±è´¥åˆ™è¡¥å¿å‰é¢å·²ç»æˆåŠŸçš„å‚ä¸è€…ã€‚</p><p>å¦‚ä¸‹å†…å®¹ä¸»è¦æ¥æºäº<a href="https://blog.couchbase.com/saga-pattern-implement-business-transactions-using-microservices-part/">è¿™é‡Œ</a>ï¼Œç„¶åç”±flyingwwç¿»è¯‘æ•´ç†åœ¨<a href="https://zhuanlan.zhihu.com/p/95852045">çŸ¥ä¹</a>ã€‚</p><p>Sagaçš„å®ç°æœ‰å¾ˆå¤šç§æ–¹å¼ï¼Œå…¶ä¸­æœ€æµè¡Œçš„ä¸¤ç§æ–¹å¼æ˜¯ï¼š</p><ul><li><p><strong>åŸºäºäº‹ä»¶çš„æ–¹å¼</strong>ã€‚è¿™ç§æ–¹å¼æ²¡æœ‰åè°ƒä¸­å¿ƒï¼Œæ•´ä¸ªæ¨¡å¼çš„å·¥ä½œæ–¹å¼å°±åƒèˆè¹ˆä¸€æ ·ï¼Œå„ä¸ªèˆè¹ˆæ¼”å‘˜æŒ‰ç…§é¢„å…ˆç¼–æ’çš„åŠ¨ä½œå’Œèµ°ä½å„è‡ªè¡¨æ¼”ï¼Œæœ€ç»ˆå½¢æˆä¸€åªèˆè¹ˆã€‚å¤„äºå½“å‰Sagaä¸‹çš„å„ä¸ªæœåŠ¡ï¼Œä¼šäº§ç”ŸæŸç±»äº‹ä»¶ï¼Œæˆ–è€…ç›‘å¬å…¶å®ƒæœåŠ¡äº§ç”Ÿçš„äº‹ä»¶å¹¶å†³å®šæ˜¯å¦éœ€è¦é’ˆå¯¹ç›‘å¬åˆ°çš„äº‹ä»¶åšå‡ºå“åº”ã€‚</p></li><li><p><strong>åŸºäºå‘½ä»¤çš„æ–¹å¼</strong>ã€‚è¿™ç§æ–¹å¼çš„å·¥ä½œå½¢å¼å°±åƒä¸€åªä¹é˜Ÿï¼Œç”±ä¸€ä¸ªæŒ‡æŒ¥å®¶ï¼ˆåè°ƒä¸­å¿ƒï¼‰æ¥åè°ƒå¤§å®¶çš„å·¥ä½œã€‚åè°ƒä¸­å¿ƒæ¥å‘Šè¯‰Sagaçš„å‚ä¸æ–¹åº”è¯¥æ‰§è¡Œå“ªä¸€ä¸ªæœ¬åœ°äº‹åŠ¡ã€‚</p></li></ul><p>æˆ‘ä»¬ç»§ç»­ä»¥è®¢å•æµç¨‹ä¸ºä¾‹ï¼Œè¯´æ˜ä¸€ä¸‹è¯¥æ¨¡å¼ã€‚</p><p>å‡è®¾ä¸€ä¸ªå®Œæ•´çš„è®¢å•æµç¨‹åŒ…å«äº†å¦‚ä¸‹å‡ ä¸ªæœåŠ¡ï¼š</p><ul><li>Order Serviceï¼šè®¢å•æœåŠ¡</li><li>Payment Serviceï¼šæ”¯ä»˜æœåŠ¡</li><li>Stock Serviceï¼šåº“å­˜æœåŠ¡</li><li>Delivery Serviceï¼šç‰©æµæœåŠ¡</li></ul><p><img src="https://cdn.jsdelivr.net/gh/zyxelva/picgo@main/markdown/SAGA-EG.png" alt="a very high-level design a saga pattern implementation"></p><h4 id="1-3-2-1-åŸºäºäº‹ä»¶çš„æ–¹å¼"><a href="#1-3-2-1-åŸºäºäº‹ä»¶çš„æ–¹å¼" class="headerlink" title="1.3.2.1 åŸºäºäº‹ä»¶çš„æ–¹å¼"></a>1.3.2.1 åŸºäºäº‹ä»¶çš„æ–¹å¼</h4><p>åœ¨åŸºäºäº‹ä»¶çš„æ–¹å¼ä¸­ï¼Œç¬¬ä¸€ä¸ªæœåŠ¡æ‰§è¡Œå®Œæœ¬åœ°äº‹åŠ¡ä¹‹åï¼Œä¼šäº§ç”Ÿä¸€ä¸ªäº‹ä»¶ã€‚å…¶å®ƒæœåŠ¡ä¼šç›‘å¬è¿™ä¸ªäº‹ä»¶ï¼Œè§¦å‘è¯¥æœåŠ¡æœ¬åœ°äº‹åŠ¡çš„æ‰§è¡Œï¼Œå¹¶äº§ç”Ÿæ–°çš„äº‹ä»¶ã€‚</p><p>é‡‡ç”¨åŸºäºäº‹ä»¶çš„sagaæ¨¡å¼çš„è®¢å•å¤„ç†æµç¨‹å¦‚ä¸‹ï¼š</p><p><img src="https://cdn.jsdelivr.net/gh/zyxelva/picgo@main/markdown/SAGA-EVENT-BASED.png" alt="åŸºäºäº‹ä»¶çš„sagaæ¨¡å¼çš„è®¢å•å¤„ç†"></p><ul><li>è®¢å•æœåŠ¡åˆ›å»ºä¸€ç¬”æ–°è®¢å•ï¼Œå°†è®¢å•çŠ¶æ€è®¾ç½®ä¸ºâ€å¾…å¤„ç†â€ï¼Œäº§ç”Ÿäº‹ä»¶<code>ORDER_CREATED_EVENT</code>ã€‚</li><li>æ”¯ä»˜æœåŠ¡ç›‘å¬<code>ORDER_CREATED_EVENT</code>ï¼Œå®Œæˆæ‰£æ¬¾å¹¶äº§ç”Ÿäº‹ä»¶<code>BILLED_ORDER_EVENT</code>ã€‚</li><li>åº“å­˜æœåŠ¡ç›‘å¬<code>BILLED_ORDER_EVENT</code>ï¼Œå®Œæˆåº“å­˜æ‰£å‡å’Œå¤‡è´§ï¼Œäº§ç”Ÿäº‹ä»¶<code>ORDER_PREPARED_EVENT</code>ã€‚</li><li>ç‰©æµæœåŠ¡ç›‘å¬<code>ORDER_PREPARED_EVENT</code>ï¼Œå®Œæˆå•†å“é…é€ï¼Œäº§ç”Ÿäº‹ä»¶<code>ORDER_DELIVERED_EVENT</code>ã€‚</li><li>è®¢å•æœåŠ¡ç›‘å¬<code>ORDER_DELIVERED_EVENT</code>ï¼Œå°†è®¢å•çŠ¶æ€æ›´æ–°ä¸ºâ€å®Œæˆâ€ã€‚</li></ul><p>åœ¨è¿™ä¸ªæµç¨‹ä¸­ï¼Œè®¢å•æœåŠ¡å¾ˆå¯èƒ½è¿˜ä¼šç›‘å¬<code>BILLED_ORDER_EVENT</code>ï¼Œ<code>ORDER_PREPARED_EVENT</code>æ¥å®Œæˆè®¢å•çŠ¶æ€çš„å®æ—¶æ›´æ–°ã€‚å°†è®¢å•çŠ¶æ€åˆ†åˆ«æ›´æ–°ä¸º<code>&quot;å·²ç»æ”¯ä»˜&quot;</code>å’Œ<code>&quot;å·²ç»å‡ºåº“&quot;</code>ç­‰çŠ¶æ€æ¥åŠæ—¶åæ˜ è®¢å•çš„æœ€æ–°çŠ¶æ€ã€‚</p><blockquote><p>è¯¥æ¨¡å¼ä¸‹åˆ†å¸ƒå¼äº‹åŠ¡çš„å›æ»š</p></blockquote><p>ä¸ºäº†åœ¨å¼‚å¸¸æƒ…å†µä¸‹å›æ»šæ•´ä¸ªåˆ†å¸ƒå¼äº‹åŠ¡ï¼Œæˆ‘ä»¬éœ€è¦ä¸ºç›¸å…³æœåŠ¡æä¾›è¡¥å¿æ“ä½œæ¥å£ã€‚</p><p>å‡è®¾åº“å­˜æœåŠ¡ç”±äºåº“å­˜ä¸è¶³æ²¡èƒ½æ­£ç¡®å®Œæˆå¤‡è´§ï¼Œæˆ‘ä»¬å¯ä»¥æŒ‰ç…§ä¸‹é¢çš„æµç¨‹æ¥å›æ»šæ•´ä¸ªSagaäº‹åŠ¡ï¼š</p><ul><li><p>åº“å­˜æœåŠ¡äº§ç”Ÿäº‹ä»¶<code>PRODUCT_OUT_OF_STOCK_EVENT</code>ã€‚</p></li><li><p>è®¢å•æœåŠ¡å’Œæ”¯ä»˜æœåŠ¡éƒ½ä¼šç›‘å¬è¯¥äº‹ä»¶å¹¶åšå‡ºå“åº”ï¼š</p><ul><li>æ”¯ä»˜æœåŠ¡å®Œæˆé€€æ¬¾ã€‚</li><li>è®¢å•æœåŠ¡å°†è®¢å•çŠ¶æ€è®¾ç½®ä¸º<code>&quot;å¤±è´¥&quot;</code>ã€‚</li></ul></li></ul><blockquote><p>åŸºäºäº‹ä»¶æ–¹å¼çš„ä¼˜ç¼ºç‚¹</p></blockquote><p><strong>ä¼˜ç‚¹</strong>ï¼šç®€å•ä¸”å®¹æ˜“ç†è§£ã€‚å„å‚ä¸æ–¹ç›¸äº’ä¹‹é—´æ— ç›´æ¥æ²Ÿé€šï¼Œå®Œå…¨è§£è€¦ã€‚è¿™ç§æ–¹å¼æ¯”è¾ƒé€‚åˆæ•´ä¸ªåˆ†å¸ƒå¼äº‹åŠ¡åªæœ‰2-4ä¸ªæ­¥éª¤çš„æƒ…å½¢ã€‚</p><p><strong>ç¼ºç‚¹</strong>ï¼šè¿™ç§æ–¹å¼å¦‚æœæ¶‰åŠæ¯”è¾ƒå¤šçš„ä¸šåŠ¡å‚ä¸æ–¹ï¼Œåˆ™æ¯”è¾ƒå®¹æ˜“å¤±æ§ã€‚å„ä¸šåŠ¡å‚ä¸æ–¹å¯éšæ„ç›‘å¬å¯¹æ–¹çš„æ¶ˆæ¯ï¼Œä»¥è‡³äºæœ€åæ²¡äººçŸ¥é“åˆ°åº•æœ‰å“ªäº›ç³»ç»Ÿåœ¨ç›‘å¬å“ªäº›æ¶ˆæ¯ã€‚æ›´æ‚²å‚¬çš„æ˜¯ï¼Œè¿™ä¸ªæ¨¡å¼è¿˜å¯èƒ½äº§ç”Ÿç¯å½¢ç›‘å¬ï¼Œä¹Ÿå°±æ˜¯ä¸¤ä¸ªä¸šåŠ¡æ–¹ç›¸äº’ç›‘å¬å¯¹æ–¹æ‰€äº§ç”Ÿçš„äº‹ä»¶ã€‚</p><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°†ä»‹ç»å¦‚ä½•ä½¿ç”¨å‘½ä»¤çš„æ–¹å¼æ¥å…‹æœä¸Šé¢æåˆ°çš„ç¼ºç‚¹ã€‚</p><h4 id="1-3-2-2-åŸºäºå‘½ä»¤çš„æ–¹å¼"><a href="#1-3-2-2-åŸºäºå‘½ä»¤çš„æ–¹å¼" class="headerlink" title="1.3.2.2 åŸºäºå‘½ä»¤çš„æ–¹å¼"></a>1.3.2.2 åŸºäºå‘½ä»¤çš„æ–¹å¼</h4><p>åœ¨åŸºäºå‘½ä»¤çš„æ–¹å¼ä¸­ï¼Œæˆ‘ä»¬ä¼šå®šä¹‰ä¸€ä¸ªæ–°çš„æœåŠ¡ï¼Œè¿™ä¸ªæœåŠ¡æ‰®æ¼”çš„è§’è‰²å°±å’Œä¸€æ”¯äº¤å“ä¹ä¹é˜Ÿçš„æŒ‡æŒ¥ä¸€æ ·ï¼Œå‘Šè¯‰å„ä¸ªä¸šåŠ¡å‚ä¸æ–¹ï¼Œåœ¨ä»€ä¹ˆæ—¶å€™åšä»€ä¹ˆäº‹æƒ…ã€‚æˆ‘ä»¬ç®¡è¿™ä¸ªæ–°æœåŠ¡å«åš<strong>åè°ƒä¸­å¿ƒ</strong>ã€‚åè°ƒä¸­å¿ƒé€šè¿‡<code>å‘½ä»¤/å›å¤</code>çš„æ–¹å¼æ¥å’ŒSagaä¸­å…¶å®ƒæœåŠ¡è¿›è¡Œäº¤äº’ã€‚</p><p>æˆ‘ä»¬ç»§ç»­ä»¥ä¹‹å‰çš„è®¢å•æµç¨‹æ¥ä¸¾ä¾‹ã€‚ä¸‹å›¾ä¸­çš„<code>Order Saga Orchestrator</code>å°±æ˜¯æ–°å¼•å…¥çš„åè°ƒä¸­å¿ƒã€‚</p><p><img src="https://cdn.jsdelivr.net/gh/zyxelva/picgo@main/markdown/SAGA-ORDER-BASED.png" alt="åŸºäºå‘½ä»¤çš„sagaæ¨¡å¼çš„è®¢å•å¤„ç†"></p><ul><li>è®¢å•æœåŠ¡åˆ›å»ºä¸€ç¬”æ–°è®¢å•ï¼Œå°†è®¢å•çŠ¶æ€è®¾ç½®ä¸º<code>&quot;å¾…å¤„ç†&quot;</code>ï¼Œç„¶åè®©<code>Order Saga Orchestratorï¼ˆOSOï¼‰</code>å¼€å¯åˆ›å»ºè®¢å•äº‹åŠ¡ã€‚</li><li>OSOå‘é€ä¸€ä¸ª<code>&quot;æ”¯ä»˜å‘½ä»¤&quot;</code>ç»™æ”¯ä»˜æœåŠ¡ï¼Œæ”¯ä»˜æœåŠ¡å®Œæˆæ‰£æ¬¾å¹¶å›å¤<code>&quot;æ”¯ä»˜å®Œæˆ&quot;</code>æ¶ˆæ¯ã€‚</li><li>OSOå‘é€ä¸€ä¸ª<code>&quot;å¤‡è´§å‘½ä»¤&quot;</code>ç»™åº“å­˜æœåŠ¡ï¼Œåº“å­˜æœåŠ¡å®Œæˆåº“å­˜æ‰£å‡å’Œå¤‡è´§ï¼Œå¹¶å›å¤<code>&quot;å‡ºåº“&quot;</code>æ¶ˆæ¯ã€‚</li><li>OSOå‘é€ä¸€ä¸ª<code>&quot;é…é€å‘½ä»¤&quot;</code>ç»™ç‰©æµæœåŠ¡ï¼Œç‰©æµæœåŠ¡å®Œæˆé…é€ï¼Œå¹¶å›å¤â€é…é€å®Œæˆâ€æ¶ˆæ¯ã€‚</li></ul><p>åœ¨ä¸Šè¿°æƒ…å†µä¸‹ï¼Œ<code>Order Saga Orchestrator</code> çŸ¥é“æ‰§è¡Œ<code>â€œåˆ›å»ºè®¢å•â€</code>äº‹åŠ¡æ‰€éœ€çš„æµç¨‹æ˜¯ä»€ä¹ˆã€‚å¦‚æœæœ‰ä»»ä½•å¤±è´¥ï¼Œå®ƒè¿˜è´Ÿè´£é€šè¿‡å‘æ¯ä¸ªå‚ä¸è€…å‘é€å‘½ä»¤æ¥åè°ƒå›æ»šä»¥æ’¤æ¶ˆä¸Šä¸€ä¸ªæ“ä½œã€‚</p><p>å¯¹ Saga ä¸šåŠ¡æµç¨‹åè°ƒç¨‹åºè¿›è¡Œå»ºæ¨¡çš„æ ‡å‡†æ–¹æ³•æ˜¯<code>çŠ¶æ€æœº(Sate Machine)</code>ï¼Œå…¶ä¸­æ¯ä¸ªè½¬æ¢å¯¹åº”äºä¸€ä¸ªå‘½ä»¤æˆ–æ¶ˆæ¯ã€‚çŠ¶æ€æœºæ˜¯æ„å»ºå®šä¹‰è‰¯å¥½çš„è¡Œä¸ºçš„ç»ä½³æ¨¡å¼ï¼Œå› ä¸ºå®ƒä»¬æ˜“äºå®ç°ï¼Œç‰¹åˆ«é€‚åˆæµ‹è¯•ã€‚</p><blockquote><p>è¯¥æ¨¡å¼ä¸‹åˆ†å¸ƒå¼äº‹åŠ¡çš„å›æ»š</p></blockquote><p><img src="https://cdn.jsdelivr.net/gh/zyxelva/picgo@main/markdown/SAGA-ORDER-ROLLBACK.png" alt="äº‹åŠ¡çš„å›æ»š"></p><p>è¯¥æ¨¡å¼ä¸‹çš„å›æ»šæµç¨‹å¦‚ä¸‹ï¼š</p><ul><li>åº“å­˜æœåŠ¡å›å¤OSOä¸€ä¸ª<code>&quot;åº“å­˜ä¸è¶³&quot;</code>æ¶ˆæ¯ã€‚</li><li>OSOæ„è¯†åˆ°è¯¥åˆ†å¸ƒå¼äº‹åŠ¡å¤±è´¥äº†ï¼Œè§¦å‘å›æ»šæµç¨‹ï¼›</li><li>OSOå‘é€<code>&quot;é€€æ¬¾å‘½ä»¤&quot;</code>ç»™æ”¯ä»˜æœåŠ¡ï¼Œæ”¯ä»˜æœåŠ¡å®Œæˆé€€æ¬¾å¹¶å›å¤<code>&quot;é€€æ¬¾æˆåŠŸ&quot;</code>æ¶ˆæ¯ã€‚</li><li>OSOå‘è®¢å•æœåŠ¡å‘é€<code>&quot;å°†è®¢å•çŠ¶æ€æ”¹ä¸ºå¤±è´¥å‘½ä»¤&quot;</code>ï¼Œè®¢å•æœåŠ¡å°†è®¢å•çŠ¶æ€æ›´æ–°ä¸º<code>&quot;å¤±è´¥&quot;</code>ã€‚</li></ul><blockquote><p>åŸºäºå‘½ä»¤æ–¹å¼çš„ä¼˜ç¼ºç‚¹</p></blockquote><p><strong>ä¼˜ç‚¹</strong>ï¼š</p><ul><li>é¿å…äº†ä¸šåŠ¡æ–¹ä¹‹é—´çš„å¾ªç¯ä¾èµ–ã€‚</li><li>å°†åˆ†å¸ƒå¼äº‹åŠ¡çš„ç®¡ç†äº¤ç”±åè°ƒä¸­å¿ƒç®¡ç†ï¼Œåè°ƒä¸­å¿ƒå¯¹æ•´ä¸ªé€»è¾‘éå¸¸æ¸…æ¥šã€‚</li><li>å‡å°‘äº†ä¸šåŠ¡å‚ä¸æ–¹çš„å¤æ‚åº¦ã€‚è¿™äº›ä¸šåŠ¡å‚ä¸æ–¹ä¸å†éœ€è¦ç›‘å¬ä¸åŒçš„æ¶ˆæ¯ï¼Œåªæ˜¯éœ€è¦å“åº”å‘½ä»¤å¹¶å›å¤æ¶ˆæ¯ã€‚</li><li>æµ‹è¯•æ›´å®¹æ˜“ï¼ˆåˆ†å¸ƒå¼äº‹åŠ¡é€»è¾‘å­˜åœ¨äºåè°ƒä¸­å¿ƒï¼Œè€Œä¸æ˜¯åˆ†æ•£åœ¨å„ä¸šåŠ¡æ–¹ï¼‰ã€‚</li><li>å›æ»šä¹Ÿæ›´å®¹æ˜“ã€‚</li></ul><p><strong>ç¼ºç‚¹</strong>ï¼š</p><ul><li>ä¸€ä¸ªå¯èƒ½çš„ç¼ºç‚¹å°±æ˜¯éœ€è¦ç»´æŠ¤åè°ƒä¸­å¿ƒï¼Œè€Œè¿™ä¸ªåè°ƒä¸­å¿ƒå¹¶ä¸å±äºä»»ä½•ä¸šåŠ¡æ–¹ã€‚</li></ul><h4 id="1-3-2-3-Sagaæ¨¡å¼å»ºè®®"><a href="#1-3-2-3-Sagaæ¨¡å¼å»ºè®®" class="headerlink" title="1.3.2.3 Sagaæ¨¡å¼å»ºè®®"></a>1.3.2.3 Sagaæ¨¡å¼å»ºè®®</h4><ul><li>ç»™æ¯ä¸€ä¸ªåˆ†å¸ƒå¼äº‹åŠ¡åˆ›å»ºä¸€ä¸ªå”¯ä¸€çš„Tx idã€‚è¿™ä¸ªå”¯ä¸€çš„Tx idå¯ä»¥ç”¨æ¥åœ¨å„ä¸ªä¸šåŠ¡å‚ä¸æ–¹æ²Ÿé€šæ—¶ç²¾ç¡®å®šä½å“ªä¸€ç¬”åˆ†å¸ƒå¼äº‹åŠ¡ã€‚</li><li>å¯¹äºåŸºäºå‘½ä»¤çš„æ–¹å¼ï¼Œåœ¨å‘½ä»¤ä¸­æºå¸¦å›å¤åœ°å€ã€‚è¿™ç§æ–¹å¼å¯ä»¥è®©æœåŠ¡åŒæ—¶å“åº”å¤šä¸ªåè°ƒä¸­å¿ƒè¯·æ±‚ã€‚</li><li>å¹‚ç­‰æ€§ã€‚å¹‚ç­‰æ€§èƒ½å¤Ÿå¢åŠ ç³»ç»Ÿçš„å®¹é”™æ€§ï¼Œè®©å„ä¸ªä¸šåŠ¡å‚ä¸æ–¹æœåŠ¡æä¾›å¹‚ç­‰æ€§æ“ä½œï¼Œèƒ½å¤Ÿåœ¨é‡åˆ°å¼‚å¸¸æƒ…å†µä¸‹è¿›è¡Œé‡è¯•ã€‚</li><li>å°½é‡åœ¨å‘½ä»¤æˆ–è€…æ¶ˆæ¯ä¸­æºå¸¦ä¸‹æ¸¸å¤„ç†éœ€è¦çš„ä¸šåŠ¡æ•°æ®ï¼Œé¿å…ä¸‹æ¸¸å¤„ç†æ—¶éœ€è¦è°ƒç”¨æ¶ˆæ¯äº§ç”Ÿæ–¹æ¥å£è·å–æ›´å¤šæ•°æ®ã€‚å‡å°‘ç³»ç»Ÿä¹‹é—´çš„ç›¸äº’ä¾èµ–ã€‚</li></ul><h2 id="1-4-æœ€ç»ˆä¸€è‡´æ€§åè®®"><a href="#1-4-æœ€ç»ˆä¸€è‡´æ€§åè®®" class="headerlink" title="1.4 æœ€ç»ˆä¸€è‡´æ€§åè®®"></a>1.4 æœ€ç»ˆä¸€è‡´æ€§åè®®</h2><h3 id="1-4-1-æœ¬åœ°æ¶ˆæ¯è¡¨"><a href="#1-4-1-æœ¬åœ°æ¶ˆæ¯è¡¨" class="headerlink" title="1.4.1 æœ¬åœ°æ¶ˆæ¯è¡¨"></a>1.4.1 æœ¬åœ°æ¶ˆæ¯è¡¨</h3><p>æœ¬åœ°æ¶ˆæ¯è¡¨çš„æ–¹æ¡ˆæœ€åˆæ˜¯ç”± eBay æå‡ºï¼Œæ ¸å¿ƒæ€è·¯æ˜¯å°†åˆ†å¸ƒå¼äº‹åŠ¡æ‹†åˆ†æˆæœ¬åœ°äº‹åŠ¡è¿›è¡Œå¤„ç†ã€‚æ­¤ç« èŠ‚æ¥æºäºCSDNåšä¸»ä¸æ‰é™ˆæŸ<a href="https://blog.csdn.net/qq_34162294/article/details/120984951">è¿™é‡Œ</a>.</p><h3 id="1-4-2-å¯é æ¶ˆæ¯"><a href="#1-4-2-å¯é æ¶ˆæ¯" class="headerlink" title="1.4.2 å¯é æ¶ˆæ¯"></a>1.4.2 å¯é æ¶ˆæ¯</h3><p>å½“äº‹åŠ¡å‘èµ·æ–¹æ‰§è¡Œå®Œæˆæœ¬åœ°äº‹åŠ¡åå¹¶å‘å‡ºä¸€æ¡æ¶ˆæ¯ï¼Œäº‹åŠ¡å‚ä¸æ–¹(æ¶ˆæ¯æ¶ˆè´¹è€…)ä¸€å®šèƒ½ å¤Ÿæ¥æ”¶æ¶ˆæ¯å¹¶å¤„ç†äº‹åŠ¡æˆåŠŸï¼Œæ­¤æ–¹æ¡ˆå¼ºè°ƒçš„æ˜¯åªè¦æ¶ˆæ¯å‘ç»™äº‹åŠ¡å‚ä¸æ–¹æœ€ç»ˆäº‹åŠ¡è¦è¾¾åˆ°ä¸€è‡´ã€‚</p><blockquote><p>åŸºäº MQ çš„åˆ†å¸ƒå¼äº‹åŠ¡æ–¹æ¡ˆå…¶å®æ˜¯å¯¹æœ¬åœ°æ¶ˆæ¯è¡¨çš„å°è£…ï¼Œå°†æœ¬åœ°æ¶ˆæ¯è¡¨åŸºäº MQ å†…éƒ¨ï¼Œå…¶ä»–æ–¹é¢çš„åè®®åŸºæœ¬ä¸æœ¬åœ°æ¶ˆæ¯è¡¨ä¸€è‡´ã€‚</p></blockquote><ul><li><p>æ­£å¸¸æƒ…å†µï¼šäº‹åŠ¡ä¸»åŠ¨æ–¹å‘æ¶ˆæ¯</p><p>  <img src="https://cdn.jsdelivr.net/gh/zyxelva/picgo@main/markdown/Normal-MQ.png" alt="æ­£å¸¸æƒ…å†µ"></p></li><li><p>å¼‚å¸¸æƒ…å†µï¼šäº‹åŠ¡ä¸»åŠ¨æ–¹æ¶ˆæ¯æ¢å¤</p><p>  <img src="https://cdn.jsdelivr.net/gh/zyxelva/picgo@main/markdown/Innormal-MQ.png" alt="å¼‚å¸¸æƒ…å†µ"></p></li></ul><p><strong>ä¼˜ç‚¹</strong>ï¼š<br>ç›¸æ¯”æœ¬åœ°æ¶ˆæ¯è¡¨æ–¹æ¡ˆï¼ŒMQ äº‹åŠ¡æ–¹æ¡ˆä¼˜ç‚¹æ˜¯ï¼š</p><ul><li>æ¶ˆæ¯æ•°æ®ç‹¬ç«‹å­˜å‚¨ ï¼Œé™ä½ä¸šåŠ¡ç³»ç»Ÿä¸æ¶ˆæ¯ç³»ç»Ÿä¹‹é—´çš„è€¦åˆã€‚</li><li>ååé‡å¤§äºä½¿ç”¨æœ¬åœ°æ¶ˆæ¯è¡¨æ–¹æ¡ˆã€‚</li></ul><p><strong>ç¼ºç‚¹</strong>ï¼š</p><ul><li>ä¸€æ¬¡æ¶ˆæ¯å‘é€éœ€è¦<strong>ä¸¤æ¬¡</strong>ç½‘ç»œè¯·æ±‚(half æ¶ˆæ¯ + commit&#x2F;rollback æ¶ˆæ¯) ã€‚</li><li>ä¸šåŠ¡å¤„ç†æœåŠ¡éœ€è¦å®ç°æ¶ˆæ¯çŠ¶æ€å›æŸ¥æ¥å£ã€‚</li></ul><h3 id="1-4-3-æœ€å¤§åŠªåŠ›é€šçŸ¥"><a href="#1-4-3-æœ€å¤§åŠªåŠ›é€šçŸ¥" class="headerlink" title="1.4.3 æœ€å¤§åŠªåŠ›é€šçŸ¥"></a>1.4.3 æœ€å¤§åŠªåŠ›é€šçŸ¥</h3><blockquote><p>æœ€å¤§åŠªåŠ›é€šçŸ¥ä¹Ÿç§°ä¸ºå®šæœŸæ ¡å¯¹ï¼Œæ˜¯å¯¹MQäº‹åŠ¡æ–¹æ¡ˆçš„è¿›ä¸€æ­¥ä¼˜åŒ–ã€‚å®ƒåœ¨äº‹åŠ¡ä¸»åŠ¨æ–¹å¢åŠ äº†æ¶ˆæ¯æ ¡å¯¹çš„æ¥å£ï¼Œå¦‚æœäº‹åŠ¡è¢«åŠ¨æ–¹æ²¡æœ‰æ¥æ”¶åˆ°æ¶ˆæ¯ï¼Œæ­¤æ—¶å¯ä»¥è°ƒç”¨äº‹åŠ¡ä¸»åŠ¨æ–¹æä¾›çš„æ¶ˆæ¯æ ¡å¯¹çš„æ¥å£ä¸»åŠ¨è·å–ã€‚</p></blockquote><p>æœ€å¤§åŠªåŠ›é€šçŸ¥çš„æ•´ä½“æµç¨‹å¦‚ä¸‹å›¾ï¼š</p><p><img src="https://cdn.jsdelivr.net/gh/zyxelva/picgo@main/markdown/Best-effort-notification.png" alt="æœ€å¤§åŠªåŠ›é€šçŸ¥æ•´ä½“æµç¨‹"></p><h4 id="1-4-3-1-ç‰¹ç‚¹"><a href="#1-4-3-1-ç‰¹ç‚¹" class="headerlink" title="1.4.3.1 ç‰¹ç‚¹"></a>1.4.3.1 ç‰¹ç‚¹</h4><ul><li><p>ç”¨åˆ°çš„æœåŠ¡æ¨¡å¼ï¼šå¯æŸ¥è¯¢æ“ä½œã€å¹‚ç­‰ï¼ˆidempotentï¼‰æ“ä½œ</p></li><li><p>é€‚ç”¨äºå¯¹ä¸šåŠ¡æœ€ç»ˆä¸€è‡´æ€§çš„æ—¶é—´æ•æ„Ÿåº¦ä½çš„ç³»ç»Ÿ</p><blockquote><p>åˆ†å¸ƒå¼äº‹åŠ¡ä¸­å¯¹ä¸€è‡´æ€§è¦æ±‚æœ€ä½çš„ä¸€ç§,  </p></blockquote></li><li><p>é€‚åˆè·¨ä¼ä¸šçš„ç³»ç»Ÿé—´çš„æ“ä½œï¼Œæˆ–è€…ä¼ä¸šå†…éƒ¨æ¯”è¾ƒç‹¬ç«‹çš„ç³»ç»Ÿé—´çš„æ“ä½œï¼Œæ¯”å¦‚é“¶è¡Œé€šçŸ¥ã€å•†æˆ·é€šçŸ¥ç­‰</p></li><li><p><strong>ä¸å¯é æ¶ˆæ¯</strong>ï¼šä¸šåŠ¡æ´»åŠ¨ä¸»åŠ¨æ–¹ï¼Œåœ¨å®Œæˆä¸šåŠ¡å¤„ç†ä¹‹åï¼Œå‘ä¸šåŠ¡æ´»åŠ¨çš„è¢«åŠ¨æ–¹å‘é€æ¶ˆæ¯ï¼Œç›´åˆ°é€šçŸ¥<code>N</code>æ¬¡åä¸å†é€šçŸ¥ï¼Œå…è®¸æ¶ˆæ¯ä¸¢å¤±(ä¸å¯é æ¶ˆæ¯)</p></li><li><p><strong>å®šæœŸæ ¡å¯¹</strong>ï¼šä¸šåŠ¡æ´»åŠ¨çš„è¢«åŠ¨æ–¹ï¼Œæ ¹æ®å®šæ—¶ç­–ç•¥ï¼Œå‘ä¸šåŠ¡æ´»åŠ¨ä¸»åŠ¨æ–¹æŸ¥è¯¢(ä¸»åŠ¨æ–¹æä¾›æŸ¥è¯¢æ¥å£)ï¼Œæ¢å¤ä¸¢å¤±çš„ä¸šåŠ¡æ¶ˆæ¯ã€‚</p></li></ul><h4 id="1-4-3-2-é€‚ç”¨åœºæ™¯"><a href="#1-4-3-2-é€‚ç”¨åœºæ™¯" class="headerlink" title="1.4.3.2 é€‚ç”¨åœºæ™¯"></a>1.4.3.2 é€‚ç”¨åœºæ™¯</h4><p>å…¸å‹çš„ä½¿ç”¨åœºæ™¯ï¼šé“¶è¡Œé€šçŸ¥ã€æ”¯ä»˜ç»“æœé€šçŸ¥ç­‰ã€‚</p><h4 id="1-4-3-3-æ ¸å¿ƒåŠŸèƒ½ç‚¹"><a href="#1-4-3-3-æ ¸å¿ƒåŠŸèƒ½ç‚¹" class="headerlink" title="1.4.3.3 æ ¸å¿ƒåŠŸèƒ½ç‚¹"></a>1.4.3.3 æ ¸å¿ƒåŠŸèƒ½ç‚¹</h4><ul><li>æ¶ˆæ¯é‡å¤é€šçŸ¥æœºåˆ¶</li><li>æ¶ˆæ¯æ ¡å¯¹æœºåˆ¶</li></ul><h1 id="2-Paxosç®—æ³•"><a href="#2-Paxosç®—æ³•" class="headerlink" title="2 Paxosç®—æ³•"></a>2 Paxosç®—æ³•</h1><blockquote><p>There is only one consensus protocol, and thatâ€™s Paxos. All other approaches are just broken versions of Paxos.<br>â€“ Mike Burrows(Google Chubbyçš„ä½œè€…)</p></blockquote><p><code>Paxos ç®—æ³•</code>æ˜¯åˆ†å¸ƒå¼æŠ€æœ¯å¤§å¸ˆ<code>è±æ–¯åˆ©Â·å…°ä¼¯ç‰¹ Leslie Lamport</code> äº1990å¹´æå‡ºçš„ä¸€ç§åŸºäº<code>æ¶ˆæ¯ä¼ é€’</code>ä¸”å…·æœ‰<code>é«˜åº¦å®¹é”™ç‰¹æ€§</code>çš„<code>å…±è¯†ç®—æ³•</code>[^1] (PS: ç½‘ä¸Šæœ‰å¾ˆå¤šæ–‡ç« å†™æˆä¸€è‡´æ€§ç®—æ³•ï¼Œå’±è¦å°Šé‡ä½œè€…è€çˆ·å­çš„æ€æƒ³ï¼Œä¸ªäººæ‹™è§ï¼Œå…±è¯†æ˜¯æ‰‹æ®µï¼Œå°‘æ•°æœä»å¤šæ•°ï¼›ä¸€è‡´æ€§æ˜¯ç›®æ ‡å’Œç»“æœ)ï¼Œæ˜¯ç›®å‰å…¬è®¤çš„è§£å†³<code>åˆ†å¸ƒå¼ä¸€è‡´æ€§é—®é¢˜</code>æœ€æœ‰æ•ˆçš„ç®—æ³•ä¹‹ä¸€ã€‚å…¶è§£å†³çš„é—®é¢˜æ˜¯</p><blockquote><p>å¦‚ä½•åœ¨ä¸€ä¸ªå¯èƒ½å‘ç”Ÿå®•æœºæˆ–ç½‘ç»œå¼‚å¸¸ç­‰æƒ…å†µä¸‹çš„åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œå¿«é€Ÿä¸”æ­£ç¡®åœ°åœ¨é›†ç¾¤å†…éƒ¨å°±æŸä¸ªæ•°æ®çš„å€¼è¾¾æˆä¸€è‡´ï¼Œå¹¶ä¸”ä¿è¯ä¸è®ºå‘ç”Ÿä¸Šè¿°ä»»ä½•ä¸€ç§å¼‚å¸¸ï¼Œéƒ½ä¸ä¼šç ´åæ•´ä¸ªç³»ç»Ÿçš„ä¸€è‡´æ€§ã€‚</p></blockquote><p>åœ¨æ­¤ä¹‹å‰ï¼ŒLamportæå‡ºè¿‡è¿™æ ·ä¸€ä¸ªç»å…¸é—®é¢˜ï¼š</p><blockquote><p>æ‹œå åº­å¸å›½æœ‰è®¸å¤šæ”¯å†›é˜Ÿï¼Œä¸åŒå†›é˜Ÿçš„å°†å†›ä¹‹é—´å¿…é¡»åˆ¶è®¢ä¸€ä¸ªç»Ÿä¸€çš„è¡ŒåŠ¨è®¡åˆ’ï¼Œä»è€Œåšå‡ºè¿›æ”»æˆ–è€…æ’¤é€€çš„å†³å®šï¼ŒåŒæ—¶ï¼Œå„ä¸ªå°†å†›åœ¨åœ°ç†ä¸Šéƒ½æ˜¯è¢«åˆ†éš”å¼€æ¥çš„ï¼Œåªèƒ½ä¾é å†›é˜Ÿçš„é€šè®¯å‘˜æ¥è¿›è¡Œé€šè®¯ã€‚ç„¶è€Œï¼Œåœ¨æ‰€æœ‰çš„é€šè®¯å‘˜ä¸­å¯èƒ½ä¼šå­˜åœ¨å›å¾’ï¼Œè¿™äº›å›å¾’å¯ä»¥ä»»æ„ç¯¡æ”¹æ¶ˆæ¯ï¼Œä»è€Œè¾¾åˆ°æ¬ºéª—å°†å†›çš„ç›®çš„ã€‚</p></blockquote><p>è¿™å°±æ˜¯<code>æ‹œå åº­å°†å†›é—®é¢˜</code>[^2]ã€‚ä»ç†è®ºä¸Šè¯´ï¼Œåœ¨åˆ†å¸ƒå¼è®¡ç®—é¢†åŸŸï¼Œè¯•å›¾åœ¨<code>å¼‚æ­¥ç³»ç»Ÿ</code>å’Œ<code>ä¸å¯é </code>çš„é€šé“ä¸Šæ¥è¾¾åˆ°ä¸€è‡´æ€§çŠ¶æ€æ˜¯ä¸å¯èƒ½çš„ã€‚å› æ­¤åœ¨å¯¹ä¸€è‡´æ€§çš„ç ”ç©¶è¿‡ç¨‹ä¸­ï¼Œå¾€å¾€å‡è®¾<code>ä¿¡é“æ˜¯å¯é çš„</code>ã€‚äº‹å®ä¸Šï¼Œå¤§å¤šæ•°ç³»ç»Ÿéƒ½æ˜¯éƒ¨ç½²åœ¨åŒä¸€ä¸ªå±€åŸŸç½‘ä¸­çš„ï¼Œå› æ­¤æ¶ˆæ¯è¢«ç¯¡æ”¹çš„æƒ…å†µéå¸¸ç½•è§ï¼›å¦ä¸€æ–¹é¢ï¼Œç”±äºç¡¬ä»¶å’Œç½‘ç»œåŸå› è€Œé€ æˆçš„æ¶ˆæ¯ä¸å®Œæ•´é—®é¢˜ï¼Œåªéœ€ä¸€å¥—ç®€å•çš„æ ¡éªŒç®—æ³•å³å¯é¿å…â€”â€”å› æ­¤ï¼Œåœ¨å®é™…å·¥ç¨‹å®è·µä¸­ï¼Œå¯ä»¥å‡è®¾ä¸å­˜åœ¨æ‹œå åº­é—®é¢˜ï¼Œå³å‡è®¾<code>æ‰€æœ‰</code>æ¶ˆæ¯éƒ½æ˜¯<code>å®Œæ•´çš„</code>ï¼Œ<code>æ²¡æœ‰è¢«ç¯¡æ”¹çš„</code>ã€‚</p><p>Paxos ç®—æ³•çš„å‰ææ˜¯<code>ä¸å­˜åœ¨</code>æ‹œå åº­å°†å†›é—®é¢˜ï¼Œå³ä¿¡é“æ˜¯<code>å®‰å…¨çš„</code>ã€<code>å¯é çš„</code>ï¼Œé›†ç¾¤èŠ‚ç‚¹é—´ä¼ é€’çš„æ¶ˆæ¯æ˜¯<code>ä¸ä¼šè¢«ç¯¡æ”¹çš„</code>ã€‚</p><p>Lamporté‰´äºä¹‹å‰æˆåŠŸåœ°è¿ç”¨æ•…äº‹ç±»æ¯”ï¼ŒæŠŠ<code>æ‹œå åº­å°†å†›é—®é¢˜</code>é˜è¿°åœ°ç®€å•æ¸…æ™°æ˜äº†ï¼Œå› è€Œåœ¨æå‡ºPaxosç®—æ³•æ—¶ï¼ŒåŒæ ·ç»™å‡ºäº†ä¸€ä¸ªåœºæ™¯ï¼š</p><blockquote><p>åœ¨å¤å¸ƒè…Šæœ‰ä¸€ä¸ªå«åšPaxos çš„å°å²›ï¼Œå²›ä¸Šæ¥ç”¨è®®ä¼šçš„å½¢å¼æ¥é€šè¿‡æ³•ä»¤ï¼Œè®®ä¼šä¸­çš„è®®å‘˜é€šè¿‡ä¿¡ä½¿è¿›è¡Œæ¶ˆæ¯çš„ä¼ é€’ã€‚å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œè®®å‘˜å’Œä¿¡ä½¿éƒ½æ˜¯å…¼èŒçš„ï¼Œä»–ä»¬éšæ—¶æœ‰å¯èƒ½ä¼šç¦»å¼€è®®ä¼šå…ï¼Œå¹¶ä¸”ä¿¡ä½¿å¯èƒ½ä¼šé‡å¤çš„ä¼ é€’æ¶ˆæ¯ï¼Œä¹Ÿå¯èƒ½ä¸€å»ä¸å¤è¿”ã€‚å› æ­¤ï¼Œè®®ä¼šåè®®è¦ä¿è¯åœ¨è¿™ç§æƒ…å†µä¸‹æ³•ä»¤ä»ç„¶èƒ½å¤Ÿæ­£ç¡®çš„äº§ç”Ÿï¼Œå¹¶ä¸”ä¸ä¼šå‡ºç°å†²çªã€‚ </p></blockquote><p>è¿™ä¸ªç®—æ³•ä¹Ÿæ˜¯å› æ­¤è€Œå¾—å.</p><h2 id="2-1-ä¸»è¦è§’è‰²"><a href="#2-1-ä¸»è¦è§’è‰²" class="headerlink" title="2.1 ä¸»è¦è§’è‰²"></a>2.1 ä¸»è¦è§’è‰²</h2><ul><li>Proposerï¼ˆææ¡ˆè€…&#x2F;æè®®è€…ï¼‰ï¼šæè®®ä¸€ä¸ªå€¼ï¼Œç”¨äºè¢«æŠ•ç¥¨å†³è®®ã€‚</li><li>Acceptorï¼ˆé™„è®®è€…&#x2F;æ¥å—è€…ï¼‰ï¼šå¯¹æ¯ä¸ªæè®®è¿›è¡ŒæŠ•ç¥¨ã€‚</li><li>Learnerï¼ˆå­¦ä¹ è€…&#x2F;å‘ŠçŸ¥è€…ï¼‰ï¼šè¢«å‘ŠçŸ¥æŠ•ç¥¨çš„ç»“æœï¼Œä¸å‚ä¸æŠ•ç¥¨è¿‡ç¨‹ã€‚</li></ul><p><img src="https://pdai.tech/images/alg/alg-dst-paxos-1.jpg" alt="Paxosç®—æ³•è§’è‰²"></p><p>å¼•ç”¨@pdaiå¤§ç¥çš„è¯´æ³•ï¼š</p><blockquote><p>å¯ä»¥ç†è§£ä¸º<code>äººå¤§ä»£è¡¨(Proposer)</code>åœ¨<code>äººå¤§</code>å‘<code>å…¶å®ƒä»£è¡¨(Acceptors)</code><strong>ææ¡ˆ</strong>ï¼Œé€šè¿‡åè®©<code>è€ç™¾å§“(Learner)</code>è½å®ã€‚</p></blockquote><h2 id="2-2-ä¸‰é˜¶æ®µ"><a href="#2-2-ä¸‰é˜¶æ®µ" class="headerlink" title="2.2 ä¸‰é˜¶æ®µ"></a>2.2 ä¸‰é˜¶æ®µ</h2><p><img src="https://pdai.tech/images/alg/alg-dst-paxos-2.jpg" alt="ä¸‰é˜¶æ®µ"></p><ul><li><p>ç¬¬ä¸€é˜¶æ®µ: Prepareé˜¶æ®µ<br>Proposerå‘Acceptorså‘å‡ºPrepareè¯·æ±‚ï¼ŒAcceptorsé’ˆå¯¹æ”¶åˆ°çš„Prepareè¯·æ±‚è¿›è¡ŒPromiseæ‰¿è¯ºã€‚</p><ul><li><code>Prepare</code>: Proposerç”Ÿæˆå…¨å±€å”¯ä¸€ä¸”é€’å¢çš„Proposal ID (å¯ä½¿ç”¨æ—¶é—´æˆ³åŠ Server ID)ï¼Œå‘æ‰€æœ‰Acceptorså‘é€Prepareè¯·æ±‚ï¼Œè¿™é‡Œæ— éœ€æºå¸¦ææ¡ˆå†…å®¹ï¼Œåªæºå¸¦Proposal IDå³å¯ã€‚</li><li><code>Promise</code>: Acceptorsæ”¶åˆ°Prepareè¯·æ±‚åï¼Œåšå‡º<strong>â€œä¸¤ä¸ªæ‰¿è¯ºï¼Œä¸€ä¸ªåº”ç­”â€</strong>ã€‚<ul><li>æ‰¿è¯º1: ä¸å†æ¥å—Proposal IDå°äºç­‰äº(æ³¨æ„: è¿™é‡Œæ˜¯&lt;&#x3D; )å½“å‰è¯·æ±‚çš„Prepareè¯·æ±‚;</li><li>æ‰¿è¯º2: ä¸å†æ¥å—Proposal IDå°äº(æ³¨æ„: è¿™é‡Œæ˜¯&lt; )å½“å‰è¯·æ±‚çš„Proposeè¯·æ±‚;</li><li>åº”ç­”: ä¸è¿èƒŒä»¥å‰ä½œå‡ºçš„æ‰¿è¯ºä¸‹ï¼Œå›å¤å·²ç»Acceptè¿‡çš„ææ¡ˆä¸­Proposal IDæœ€å¤§çš„é‚£ä¸ªææ¡ˆçš„Valueå’ŒProposal IDï¼Œæ²¡æœ‰åˆ™è¿”å›ç©ºå€¼ã€‚</li></ul></li></ul></li><li><p>ç¬¬äºŒé˜¶æ®µ: Accepté˜¶æ®µ<br>Proposeræ”¶åˆ°å¤šæ•°Acceptorsæ‰¿è¯ºçš„Promiseåï¼Œå‘Acceptorså‘å‡ºProposeè¯·æ±‚ï¼ŒAcceptorsé’ˆå¯¹æ”¶åˆ°çš„Proposeè¯·æ±‚è¿›è¡ŒAcceptå¤„ç†ã€‚</p><ul><li><code>Propose</code>: Proposer æ”¶åˆ°å¤šæ•°Acceptorsçš„Promiseåº”ç­”åï¼Œä»åº”ç­”ä¸­é€‰æ‹©Proposal IDæœ€å¤§çš„ææ¡ˆçš„Valueï¼Œä½œä¸ºæœ¬æ¬¡è¦å‘èµ·çš„ææ¡ˆã€‚å¦‚æœæ‰€æœ‰åº”ç­”çš„ææ¡ˆValueå‡ä¸ºç©ºå€¼ï¼Œåˆ™å¯ä»¥è‡ªå·±éšæ„å†³å®šææ¡ˆValueã€‚ç„¶åæºå¸¦å½“å‰Proposal IDï¼Œå‘æ‰€æœ‰Acceptorså‘é€Proposeè¯·æ±‚ã€‚</li><li><code>Accept</code>: Acceptoræ”¶åˆ°Proposeè¯·æ±‚åï¼Œåœ¨ä¸è¿èƒŒè‡ªå·±ä¹‹å‰ä½œå‡ºçš„æ‰¿è¯ºä¸‹ï¼Œæ¥å—å¹¶æŒä¹…åŒ–å½“å‰Proposal IDå’Œææ¡ˆValueã€‚</li></ul></li><li><p>ç¬¬ä¸‰é˜¶æ®µ: Learné˜¶æ®µ<br>Proposeråœ¨æ”¶åˆ°å¤šæ•°Acceptorsçš„Acceptä¹‹åï¼Œæ ‡å¿—ç€æœ¬æ¬¡AcceptæˆåŠŸï¼Œå†³è®®å½¢æˆï¼Œå°†å½¢æˆçš„å†³è®®å‘é€ç»™æ‰€æœ‰Learnersã€‚</p></li></ul><p>å‚é˜…<a href="https://mp.weixin.qq.com/s/tzxNmlz1b0NzTEvig67HMg">æ¼«è°ˆåˆ†å¸ƒå¼ç³»ç»Ÿ(11) â€“ è¾¾æˆå…±è¯†å°±æ˜¯ä¸€è‡´</a><br><a href="https://mp.weixin.qq.com/s/wOVvSJO4HOz1rjAHvo9ifw">å¤§è¯åˆ†å¸ƒå¼ç†è®ºä¹‹äºŒâ€”â€”å…±è¯†ç®—æ³•ä¸ä¸€è‡´æ€§çš„åŒºåˆ«</a></p><p>ä¼ªä»£ç :<br><img src="https://pdai.tech/images/alg/alg-dst-paxos-3.jpg" alt="Basic Paxos"></p><h2 id="2-3-Paxosç®—æ³•æ¨å¯¼"><a href="#2-3-Paxosç®—æ³•æ¨å¯¼" class="headerlink" title="2.3 Paxosç®—æ³•æ¨å¯¼"></a>2.3 Paxosç®—æ³•æ¨å¯¼</h2><p>å‚é˜…<a href="https://blog.csdn.net/yeqiuzs/article/details/76862026">ç†è§£Paxosç®—æ³•çš„æ¨å¯¼è¿‡ç¨‹</a></p><h2 id="2-4-Paxosç®—æ³•æ‹“å±•"><a href="#2-4-Paxosç®—æ³•æ‹“å±•" class="headerlink" title="2.4 Paxosç®—æ³•æ‹“å±•"></a>2.4 Paxosç®—æ³•æ‹“å±•</h2><p>Googleçš„å¾ˆå¤šå¤§å‹åˆ†å¸ƒå¼ç³»ç»Ÿéƒ½é‡‡ç”¨äº†<code>Paxosç®—æ³•</code>æ¥è§£å†³<code>åˆ†å¸ƒå¼ä¸€è‡´æ€§é—®é¢˜</code>ï¼Œå¦‚<code>Chubby</code>ã€<code>Megastore</code>ä»¥åŠ<code>Spanner</code>ç­‰ã€‚å¼€æºçš„<code>ZooKeeper</code>ï¼Œä»¥åŠ<code>MySQL 5.7</code>æ¨å‡ºçš„ç”¨æ¥å–ä»£ä¼ ç»Ÿçš„ä¸»ä»å¤åˆ¶çš„<code>MySQL Group Replication</code>ç­‰çº·çº·é‡‡ç”¨Paxosç®—æ³•è§£å†³åˆ†å¸ƒå¼ä¸€è‡´æ€§é—®é¢˜ã€‚åç»­æ–‡ç« ä¼šè®²è®²<code>ZAB</code>ï¼Œ<code>RAFT</code>ï¼Œæ•¬è¯·æœŸå¾…ã€‚</p><ul><li>Multi-Paxos<br>ç”±äºPaxosæ¯æ¬¡æµç¨‹åªèƒ½æ”¯æŒä¸€ä¸ªææ¡ˆçš„è¾¾æˆï¼Œæ•ˆç‡è¾ƒä½ï¼Œäºæ˜¯åˆå‡ºç°äº†Multi-Paxosï¼Œæ”¯æŒä¸€æ¬¡åè°ƒè¾¾æˆä¸€æ½å­çš„ææ¡ˆã€‚</li><li>Raft<br>Raftæ˜¯å¯¹Muti-Paxosçš„ç²¾ç®€ï¼Œå¼ºè°ƒæ˜“ç†è§£ã€æ˜“å®ç°ã€‚</li><li>Multi-Raft<br>å½“ä¸‹å¾ˆå¤šåˆ†å¸ƒå¼æ•°æ®åº“å­˜åœ¨åˆ†ç‰‡ï¼Œä¸åŒåˆ†ç‰‡ä¹‹é—´çš„æ•°æ®&#x2F;ä¿¡æ¯åº”è¯¥æ˜¯éš”ç¦»çš„ï¼Œäºæ˜¯éœ€è¦å¤šä¸ªRaftæ¥æ”¯æŒåˆ†ç‰‡ï¼Œæ¯ä¸ªRaftå¯¹åº”ä¸€ä¸ªåˆ†ç‰‡ï¼Œè¿™å°±æ˜¯Multi-Raftã€‚</li><li>ZAB<br>ZABä¹Ÿæ˜¯å¯¹Multi-Paxosç®—æ³•çš„æ”¹è¿›ï¼Œæ˜¯Zookeeperä¸­çš„é€‰ä¸»æœºåˆ¶ï¼Œæ¯”Raftåè®®å‡ºç°çš„æ›´æ—©ã€‚</li></ul><h2 id="2-5-Paxos-ç®—æ³•çš„ä¸€è‡´æ€§"><a href="#2-5-Paxos-ç®—æ³•çš„ä¸€è‡´æ€§" class="headerlink" title="2.5 Paxos ç®—æ³•çš„ä¸€è‡´æ€§"></a>2.5 Paxos ç®—æ³•çš„ä¸€è‡´æ€§</h2><p>Paxos ç®—æ³•çš„ä¸€è‡´æ€§ä¸»è¦ä½“ç°åœ¨ä»¥ä¸‹å‡ ç‚¹ï¼š</p><ul><li>æ¯ä¸ªææ¡ˆè€…åœ¨æå‡ºææ¡ˆæ—¶éƒ½ä¼šé¦–å…ˆè·å–åˆ°ä¸€ä¸ªå…·æœ‰å…¨å±€å”¯ä¸€æ€§çš„ã€é€’å¢çš„ææ¡ˆç¼–å· Nï¼Œ å³åœ¨æ•´ä¸ªé›†ç¾¤ä¸­æ˜¯å”¯ä¸€çš„ç¼–å· Nï¼Œç„¶åå°†è¯¥ç¼–å·èµ‹äºˆå…¶è¦æå‡ºçš„ææ¡ˆã€‚</li><li>æ¯ä¸ªè¡¨å†³è€…åœ¨ accept æŸææ¡ˆåï¼Œä¼šå°†è¯¥ææ¡ˆçš„ç¼–å· N è®°å½•åœ¨æœ¬åœ°ï¼Œè¿™æ ·æ¯ä¸ªè¡¨å†³è€…ä¸­ä¿å­˜çš„å·²ç»è¢« accept çš„ææ¡ˆä¸­ä¼šå­˜åœ¨ä¸€ä¸ªç¼–å·æœ€å¤§çš„ææ¡ˆï¼Œå…¶ç¼–å·å‡è®¾ä¸º maxNã€‚æ¯ä¸ªè¡¨å†³è€…ä»…ä¼š accept ç¼–å·å¤§äºè‡ªå·±æœ¬åœ° maxN çš„ææ¡ˆã€‚</li><li>åœ¨ä¼—å¤šææ¡ˆä¸­æœ€ç»ˆåªèƒ½æœ‰ä¸€ä¸ªææ¡ˆè¢«é€‰å®šã€‚</li><li>ä¸€æ—¦ä¸€ä¸ªææ¡ˆè¢«é€‰å®šï¼Œåˆ™å…¶å®ƒæœåŠ¡å™¨ä¼šä¸»åŠ¨åŒæ­¥(Learn)è¯¥ææ¡ˆåˆ°æœ¬åœ°ã€‚</li><li>æ²¡æœ‰ææ¡ˆæå‡ºåˆ™ä¸ä¼šæœ‰ææ¡ˆè¢«é€‰å®šã€‚</li></ul><p><strong>å‚è€ƒæ–‡çŒ®</strong></p><ul><li>Lamport, Leslie. â€œThe part-time parliament.â€ ACM Transactions on Computer Systems (TOCS) 16.2 (1998): 133-169.</li><li>Lamport, Leslie. â€œPaxos made simple.â€ ACM Sigact News 32.4 (2001): 18-25.</li></ul><p>[^1]:<a href="https://www.microsoft.com/en-us/research/uploads/prod/2016/12/The-Part-Time-Parliament.pdf">ç¬¬ä¸€ç¯‡è®ºæ–‡</a>;<a href="https://www.microsoft.com/en-us/research/uploads/prod/2016/12/paxos-simple-Copy.pdf">ç¬¬äºŒç¯‡è®ºæ–‡</a>;<a href="https://research.microsoft.com/en-us/um/people/blampson/60-PaxosAlgorithm/Acrobat.pdf">Nancy Lynch</a><br>[^2]:<a href="https://www.andrew.cmu.edu/course/15-749/READINGS/required/resilience/lamport82.pdf">Byzantine Generals Problem</a></p>]]></content>
      
      
      <categories>
          
          <category> Zookeeperå­¦ä¹  </category>
          
          <category> åˆ†å¸ƒå¼ç³»ç»Ÿ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> åˆ†å¸ƒå¼ </tag>
            
            <tag> XAåè®® </tag>
            
            <tag> 2PC </tag>
            
            <tag> TCC </tag>
            
            <tag> SAGA </tag>
            
            <tag> å¯é æ¶ˆæ¯ </tag>
            
            <tag> æœ€å¤§åŠªåŠ›é€šçŸ¥ </tag>
            
            <tag> æœ¬åœ°æ¶ˆæ¯è¡¨ </tag>
            
            <tag> Paxosç®—æ³• </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ã€Zookeeperå­¦ä¹ ã€‘1.æ¶æ„æ¼”è¿›</title>
      <link href="/posts/1467106999.html"/>
      <url>/posts/1467106999.html</url>
      
        <content type="html"><![CDATA[<h1 id="1-é›†ä¸­å¼"><a href="#1-é›†ä¸­å¼" class="headerlink" title="1 é›†ä¸­å¼"></a>1 é›†ä¸­å¼</h1><h2 id="1-1-å®šä¹‰"><a href="#1-1-å®šä¹‰" class="headerlink" title="1.1 å®šä¹‰"></a>1.1 å®šä¹‰</h2><blockquote><p>ç”±ä¸€å°æˆ–å¤šå°ä¸»è®¡ç®—æœºç»„æˆä¸­å¿ƒèŠ‚ç‚¹ï¼Œæ•°æ®é›†ä¸­å­˜å‚¨äºè¯¥ä¸­å¿ƒèŠ‚ç‚¹ä¸­ï¼Œä¸”å…¶ä»–ç›¸å…³ä¸šåŠ¡å•å…ƒå…¨éƒ½é›†ä¸­éƒ¨ç½²åœ¨è¿™ä¸ªä¸­å¿ƒèŠ‚ç‚¹ä¸Šï¼Œæ±‡é›†ç³»ç»Ÿæ‰€æœ‰åŠŸèƒ½å¹¶ç”±å…¶é›†ä¸­å¤„ç†ã€‚</p></blockquote><h2 id="1-2-ä¼˜ç‚¹"><a href="#1-2-ä¼˜ç‚¹" class="headerlink" title="1.2 ä¼˜ç‚¹"></a>1.2 ä¼˜ç‚¹</h2><ul><li>æ€§èƒ½ä¼˜è¶Š<blockquote><p>æ­¤ç±»ç³»ç»ŸåŸºæœ¬éƒ¨ç½²åœ¨åŸºäºåº•å±‚æ€§èƒ½å“è¶Šçš„å¤§å‹ä¸»æœºä¹‹ä¸Š</p></blockquote></li><li>ç¨³å®šæ€§å¥½<blockquote><p>é’±èŠ±çš„å¤šå°±è¦åŠå¥½äº‹</p></blockquote></li></ul><h2 id="1-3-ç¼ºç‚¹"><a href="#1-3-ç¼ºç‚¹" class="headerlink" title="1.3 ç¼ºç‚¹"></a>1.3 ç¼ºç‚¹</h2><ul><li>æ˜‚è´µ</li><li>å•ç‚¹é—®é¢˜</li><li>ç»´æŠ¤å¤æ‚</li></ul><h1 id="2-åˆ†å¸ƒå¼"><a href="#2-åˆ†å¸ƒå¼" class="headerlink" title="2 åˆ†å¸ƒå¼"></a>2 åˆ†å¸ƒå¼</h1><h2 id="2-1-å®šä¹‰"><a href="#2-1-å®šä¹‰" class="headerlink" title="2.1 å®šä¹‰"></a>2.1 å®šä¹‰</h2><p>å¼•ç”¨ã€Šåˆ†å¸ƒå¼ç³»ç»Ÿæ¦‚å¿µä¸è®¾è®¡ã€‹ä¸€æ–‡å¯¹äºåˆ†å¸ƒå¼ç³»ç»Ÿçš„å®šä¹‰ï¼š</p><blockquote><p>åˆ†å¸ƒå¼ç³»ç»Ÿæ˜¯ä¸€ä¸ªç¡¬ä»¶æˆ–è½¯ä»¶ç»„ä»¶åˆ†å¸ƒåœ¨ä¸åŒçš„ç½‘ç»œè®¡ç®—æœºä¸Šï¼Œå½¼æ­¤ä¹‹é—´ä»…ä»…é€šè¿‡æ¶ˆæ¯ä¼ é€’è¿›è¡Œé€šä¿¡å’Œåè°ƒçš„ç³»ç»Ÿã€‚</p></blockquote><h2 id="2-2-ç‰¹ç‚¹"><a href="#2-2-ç‰¹ç‚¹" class="headerlink" title="2.2 ç‰¹ç‚¹"></a>2.2 ç‰¹ç‚¹</h2><ul><li>åˆ†å¸ƒæ€§</li><li>å¯¹ç­‰æ€§</li><li>å¹¶å‘æ€§</li><li>ç¼ºä¹å…¨å±€æ—¶é’Ÿ</li><li>æ•…éšœæ€»ä¼šå‘ç”Ÿ</li></ul><h2 id="2-3-åˆ†å¸ƒå¼å¸¦æ¥çš„é—®é¢˜"><a href="#2-3-åˆ†å¸ƒå¼å¸¦æ¥çš„é—®é¢˜" class="headerlink" title="2.3 åˆ†å¸ƒå¼å¸¦æ¥çš„é—®é¢˜"></a>2.3 åˆ†å¸ƒå¼å¸¦æ¥çš„é—®é¢˜</h2><ul><li>é€šä¿¡å¼‚å¸¸<blockquote><p>ç½‘ç»œç³»ç»Ÿæœ¬èº«æ˜¯ä¸å¯é çš„ï¼Œç”±äºåˆ†å¸ƒå¼ç³»ç»Ÿéœ€è¦é€šè¿‡ç½‘ç»œè¿›è¡Œæ•°æ®ä¼ è¾“ï¼Œç½‘ç»œå…‰çº¤ï¼Œè·¯ç”±å™¨ç­‰ç¡¬ä»¶éš¾å…å‡ºç°é—®é¢˜ã€‚åªè¦ç½‘ç»œå‡ºç°é—®é¢˜ï¼Œä¹Ÿå°±ä¼šå½±å“æ¶ˆæ¯çš„å‘é€ä¸æ¥å—è¿‡ç¨‹ï¼Œå› æ­¤æ•°æ®æ¶ˆæ¯çš„ä¸¢å¤±æˆ–è€…å»¶é•¿å°±ä¼šå˜å¾—éå¸¸æ™®éã€‚</p></blockquote></li><li>ç½‘ç»œåˆ†åŒº<blockquote><p>ç”±äºç½‘ç»œå»¶è¿Ÿå¯¼è‡´çš„åˆ†å¸ƒå¼èŠ‚ç‚¹ä¸­åªæœ‰éƒ¨åˆ†èƒ½å¤Ÿè¿›è¡Œæ­£å¸¸é€šä¿¡ï¼Œå¦ä¸€éƒ¨åˆ†åˆ™ä¸èƒ½ï¼Œæˆ‘ä»¬å°†è¿™ç§ç°è±¡å«åšç½‘ç»œåˆ†åŒºï¼Œä¿—ç§°â€œè„‘è£‚â€ï¼Œå½“ç½‘ç»œåˆ†åŒºå‡ºç°æ—¶ä¼šå­˜åœ¨å±€éƒ¨å°é›†ç¾¤ï¼Œå°é›†ç¾¤å®Œæˆäº†åŸæ¥éœ€è¦å…¨éƒ¨èŠ‚ç‚¹å‚ä¸çš„åˆ†å¸ƒå¼äº‹åŠ¡è¯·æ±‚ï¼Œè¿™å¯¹åˆ†å¸ƒå¼ä¸€è‡´æ€§æŒ‘æˆ˜å¾ˆå¤§ã€‚</p></blockquote></li><li>ä¸‰æ€<blockquote><p>æˆåŠŸã€å¤±è´¥ã€è¶…æ—¶ã€‚å½“å‡ºç°è¶…æ—¶ç°è±¡æ—¶ï¼Œå°±æ— æ³•ç¡®å®šè¯·æ±‚æ˜¯å¦è¢«å¤„ç†æˆåŠŸ</p></blockquote></li><li>èŠ‚ç‚¹æ•…éšœ<blockquote><p>èŠ‚ç‚¹æ•…éšœåœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸‹æ˜¯æ¯”è¾ƒå¸¸è§çš„é—®é¢˜ï¼ŒæŒ‡çš„æ˜¯ç»„æˆæœåŠ¡å™¨é›†ç¾¤çš„èŠ‚ç‚¹ä¼šå‡ºç°çš„å®•æœºæˆ–â€œåƒµæ­»â€çš„ç°è±¡ï¼Œè¿™ç§ç°è±¡ç»å¸¸ä¼šå‘ç”Ÿã€‚</p></blockquote></li></ul><h2 id="2-4-æ–¹æ³•è®º"><a href="#2-4-æ–¹æ³•è®º" class="headerlink" title="2.4 æ–¹æ³•è®º"></a>2.4 æ–¹æ³•è®º</h2><h3 id="2-4-1-äº‹åŠ¡"><a href="#2-4-1-äº‹åŠ¡" class="headerlink" title="2.4.1 äº‹åŠ¡"></a>2.4.1 äº‹åŠ¡</h3><blockquote><p>äº‹åŠ¡æ˜¯å¯¹æ•°æ®è¿›è¡Œè®¿é—®ä¸æ›´æ–°çš„æœ€å°æ‰§è¡Œé€»è¾‘å•å…ƒã€‚æ˜¯ä¿è¯æ•°æ®ä¸€è‡´æ€§çš„æ–¹æ³•ã€‚</p></blockquote><p>ç‹­ä¹‰ä¸Šï¼Œäº‹åŠ¡ç‰¹æŒ‡<strong>æ•°æ®åº“äº‹åŠ¡</strong>ã€‚</p><h3 id="2-4-2-äº‹åŠ¡ç‰¹æ€§"><a href="#2-4-2-äº‹åŠ¡ç‰¹æ€§" class="headerlink" title="2.4.2 äº‹åŠ¡ç‰¹æ€§"></a>2.4.2 äº‹åŠ¡ç‰¹æ€§</h3><ul><li><p>åŸå­æ€§ï¼ˆAtomicityï¼‰</p><blockquote><p>ä¸€ä¸ªäº‹åŠ¡å¿…é¡»è¢«è§†ä¸ºä¸€ä¸ªä¸å¯åˆ†å‰²çš„æœ€å°å•å…ƒï¼Œæ•´ä¸ªäº‹åŠ¡ä¸­çš„æ‰€æœ‰æ“ä½œè¦ä¹ˆå…¨éƒ¨æäº¤æˆåŠŸï¼Œè¦ä¹ˆå…¨éƒ¨å¤±è´¥ï¼Œå¯¹äºä¸€ä¸ªäº‹åŠ¡æ¥è¯´ï¼Œä¸èƒ½åªæ‰§è¡Œå…¶ä¸­çš„ä¸€éƒ¨åˆ†æ“ä½œã€‚</p></blockquote></li><li><p>ä¸€è‡´æ€§ï¼ˆConsistencyï¼‰</p><blockquote><p>äº‹åŠ¡å°†æ•°æ®åº“ä»<strong>ä¸€ç§ä¸€è‡´æ€§çŠ¶æ€</strong>è½¬æ¢åˆ°<strong>å¦å¤–ä¸€ç§ä¸€è‡´æ€§çŠ¶æ€</strong>ï¼Œåœ¨äº‹åŠ¡å¼€å§‹ä¹‹å‰å’Œäº‹åŠ¡ç»“æŸä¹‹åæ•°æ®åº“ä¸­æ•°æ®çš„å®Œæ•´æ€§æ²¡æœ‰è¢«ç ´åã€‚</p></blockquote></li><li><p>éš”ç¦»æ€§ï¼ˆIsolationï¼‰</p><blockquote><p>ä¸€ä¸ªäº‹åŠ¡çš„æ‰§è¡Œä¸èƒ½è¢«å…¶ä»–äº‹åŠ¡å¹²æ‰°ã€‚å³ä¸€ä¸ªäº‹åŠ¡å†…éƒ¨çš„æ“ä½œåŠä½¿ç”¨çš„æ•°æ®å¯¹å¹¶å‘çš„å…¶ä»–äº‹åŠ¡æ˜¯éš”ç¦»çš„ï¼Œå¹¶å‘æ‰§è¡Œçš„å„ä¸ªäº‹åŠ¡ä¹‹é—´ä¸èƒ½äº’ç›¸å¹²æ‰°ã€‚</p></blockquote></li><li><p>æŒä¹…æ€§ï¼ˆDurabilityï¼‰</p><blockquote><p>ä¸€æ—¦äº‹åŠ¡æäº¤ï¼Œåˆ™å…¶æ‰€åšçš„ä¿®æ”¹å°±ä¼šæ°¸ä¹…ä¿å­˜åˆ°æ•°æ®åº“ä¸­ã€‚æ­¤æ—¶å³ä½¿ç³»ç»Ÿå´©æºƒï¼Œå·²ç»æäº¤çš„ä¿®æ”¹æ•°æ®ä¹Ÿä¸ä¼šä¸¢å¤±ã€‚</p></blockquote></li></ul><h3 id="2-4-3-åˆ†å¸ƒå¼äº‹åŠ¡"><a href="#2-4-3-åˆ†å¸ƒå¼äº‹åŠ¡" class="headerlink" title="2.4.3 åˆ†å¸ƒå¼äº‹åŠ¡"></a>2.4.3 åˆ†å¸ƒå¼äº‹åŠ¡</h3><blockquote><p>åˆ†å¸ƒå¼äº‹åŠ¡æ˜¯æŒ‡<strong>äº‹åŠ¡çš„å‚ä¸è€…</strong>ã€<strong>æ”¯æŒäº‹åŠ¡çš„æœåŠ¡å™¨</strong>ã€<strong>èµ„æºæœåŠ¡å™¨</strong>ä»¥åŠ<strong>äº‹åŠ¡ç®¡ç†å™¨</strong>åˆ†åˆ«ä½äºä¸åŒçš„åˆ†å¸ƒå¼ç³»ç»Ÿçš„ä¸åŒèŠ‚ç‚¹ä¹‹ä¸Šã€‚</p></blockquote><p>å¯¹äºæœ¬åœ°äº‹åŠ¡æˆ–è€…é›†ä¸­å¼çš„äº‹åŠ¡å¤„ç†ç³»ç»Ÿï¼Œé€šè¿‡æˆç†Ÿçš„ACIDæ¨¡å‹å°±å¯ä»¥ä¿è¯æ•°æ®çš„ä¸€è‡´æ€§ã€‚ä½†åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œè‹¥é€šè¿‡ä¸€å¥—ä¸¥æ ¼æ»¡è¶³ACIDç‰¹æ€§çš„åˆ†å¸ƒå¼äº‹åŠ¡ï¼Œå¾ˆæœ‰å¯èƒ½å‡ºç°ç³»ç»Ÿçš„ä¸¥æ ¼ä¸€è‡´æ€§å’Œå¯ç”¨æ€§å†²çªï¼š</p><ul><li>å½“ç³»ç»Ÿéœ€è¦ä¸¥æ ¼ä¸€è‡´æ€§æ—¶ï¼Œå¿…å®šæ¶‰åŠåˆ°æ•°æ®åŒæ­¥ï¼Œè€ŒåŒæ­¥è¿‡ç¨‹ä¼šç‰ºç‰²æ‰ç³»ç»Ÿçš„å¯ç”¨æ€§ï¼›</li><li>å½“ç³»ç»Ÿéœ€è¦æ—¶åˆ»ä¿æŒå¯ç”¨ï¼Œåˆ™å¯¹äºä¸åŒèŠ‚ç‚¹çš„æ•°æ®å°±æ— æ³•ä¿è¯ä¸¥æ ¼ä¸€è‡´æ€§ã€‚</li></ul><h3 id="2-4-5-CAPç†è®º"><a href="#2-4-5-CAPç†è®º" class="headerlink" title="2.4.5 CAPç†è®º"></a>2.4.5 CAPç†è®º</h3><p>ä¸€è‡´æ€§(Consistency)ï¼Œå¯ç”¨æ€§(Availability)ï¼Œåˆ†åŒºå®¹é”™æ€§(Partition tolerance)è¿™ä¸‰ä¸ªè¯çš„ç¼©å†™ã€‚</p><ul><li><p>ä¸€è‡´æ€§</p><blockquote><p>å¯¹äºä¸€ä¸ªå°†æ•°æ®åˆ†å¸ƒåˆ°ä¸åŒçš„åˆ†å¸ƒå¼èŠ‚ç‚¹çš„ç³»ç»Ÿæ¥è¯´ï¼Œå½“ä½ æ›´æ–°ç¬¬ä¸€ä¸ªèŠ‚ç‚¹çš„æ—¶å€™ï¼Œè¦ä¿è¯ä¹Ÿèƒ½å¤Ÿæ›´æ–°ç¬¬äºŒä¸ªèŠ‚ç‚¹ï¼Œä¸èƒ½æ˜¯ç”¨æˆ·è¯»ç¬¬äºŒä¸ªèŠ‚ç‚¹æ—¶å‡ºç°è„è¯»ï¼Œè¿™æ ·çš„ç³»ç»Ÿæ‰æ˜¯ä¸¥æ ¼ä¸€è‡´æ€§çš„ã€‚</p></blockquote><ul><li><p>ä¸ACIDä¸­çš„Cï¼ˆä¸€è‡´æ€§ï¼‰åŒºåˆ«</p><blockquote><p>ACIDçš„Cï¼šé€»è¾‘ä¸Šçš„ä¸€è‡´æ€§ï¼Œå³æ‰€æœ‰æ“ä½œæ˜¯ç¬¦åˆç°å®å½“ä¸­çš„æœŸæœ›çš„ï¼Œäº‹åŠ¡æ‰§è¡Œåä¸ä¼šå‡ºç°ä»»ä½•æ— æ•ˆçš„æ•°æ®çŠ¶æ€ï¼Œå¼ºè°ƒæ•°æ®çš„å®Œæ•´æ€§ã€‚</p></blockquote><ul><li>æ¯”å¦‚ï¼šå¦‚æœå¸¦æœ‰ä¸€ä¸ªå¤–é”®çš„ä¸€è¡Œè®°å½•è¢«åˆ é™¤ï¼Œé‚£ä¹ˆå…¶å¤–é”®ç›¸å…³è®°å½•ä¹Ÿåº”è¯¥è¢«åˆ é™¤ï¼Œè¿™å°±æ˜¯ACIDä¸€è‡´æ€§æ„æ€ã€‚</li></ul><blockquote><p>CAPçš„Cï¼šç‰©ç†ä¸Šçš„ä¸€è‡´æ€§ï¼Œå¼ºè°ƒæ•°æ®çš„æ­£ç¡®æ€§ã€‚</p></blockquote><ul><li>åŒæ ·æ•°æ®åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­æ‰€æœ‰åœ°æ–¹éƒ½æ˜¯è¢«å¤åˆ¶æˆç›¸åŒã€‚</li></ul></li></ul></li><li><p>å¯ç”¨æ€§</p><blockquote><p>å¯¹äºç”¨æˆ·çš„æ¯ä¸€ä¸ªè¯·æ±‚ï¼Œéƒ½å¸Œæœ›åœ¨æœ‰é™çš„æ—¶é—´å†…è¿”å›ç»“æœï¼Œæœ‰é™çš„æ—¶é—´æŒ‡çš„æ˜¯ç³»ç»Ÿè®¾è®¡çš„å“åº”æ—¶é—´ï¼Œè¿”å›ç»“æœæ˜¯ä¸€ä¸ªæ­£å¸¸çš„è¦ä¹ˆæˆåŠŸè¦ä¹ˆå¤±è´¥çš„ç»“æœï¼Œè€Œä¸æ˜¯ä¸€ä¸ªç”¨æˆ·çœ‹ä¸æ‡‚çš„ç»“æœã€‚</p></blockquote></li><li><p>åˆ†åŒºå®¹é”™æ€§</p><blockquote><p>åœ¨é‡åˆ°ç½‘ç»œåˆ†åŒºçš„æ—¶å€™ï¼Œä»ç„¶éœ€è¦ä¿è¯æä¾›ä¸€è‡´æ€§çš„å¯ç”¨æœåŠ¡ã€‚</p></blockquote></li></ul><p><img src="https://cdn.jsdelivr.net/gh/zyxelva/picgo@main/markdown/CAP.png" alt="CAP"></p><p><strong>CAPç†è®ºå‘Šè¯‰æˆ‘ä»¬Cã€Aã€Pä¸‰è€…ä¸èƒ½åŒæ—¶æ»¡è¶³ï¼Œæœ€å¤šåªèƒ½æ»¡è¶³å…¶ä¸­ä¸¤ä¸ªã€‚</strong></p><p><img src="https://cdn.jsdelivr.net/gh/zyxelva/picgo@main/markdown/Non-CAP.png" alt="é±¼å’Œç†ŠæŒä¸å¯å…¼å¾—"></p><h3 id="2-4-6-BASEç†è®º"><a href="#2-4-6-BASEç†è®º" class="headerlink" title="2.4.6 BASEç†è®º"></a>2.4.6 BASEç†è®º</h3><p>å³ä½¿æ— æ³•åšåˆ°å¼ºä¸€è‡´æ€§ï¼Œä½†åˆ†å¸ƒå¼ç³»ç»Ÿå¯ä»¥æ ¹æ®è‡ªå·±çš„ä¸šåŠ¡ç‰¹ç‚¹ï¼Œé‡‡ç”¨é€‚å½“çš„æ–¹å¼æ¥ä½¿ç³»ç»Ÿè¾¾åˆ°<strong>æœ€ç»ˆçš„ä¸€è‡´æ€§</strong>ã€‚</p><ul><li><p>Basically Availableï¼ˆBAåŸºæœ¬å¯ç”¨ï¼‰</p><blockquote><p>å…è®¸æŸå¤±éƒ¨åˆ†å¯ç”¨æ€§ï¼Œä¸ç­‰ä»·äºç³»ç»Ÿä¸å¯ç”¨ã€‚å…·ä½“æŸå¤±è¡¨ç°åœ¨ï¼š</p></blockquote><ul><li>å“åº”æ—¶é—´ä¸Šçš„æŸå¤±ï¼Œ</li><li>åŠŸèƒ½ä¸Šçš„æŸå¤±ï¼ˆå³°å€¼å¹¶å‘æ—¶å¯èƒ½ä¼šå¼•å¯¼åˆ°ä¸€ä¸ªé™çº§çš„é¡µé¢ï¼‰</li></ul></li><li><p>Soft stateï¼ˆSè½¯çŠ¶æ€ï¼‰</p><blockquote><p>å…è®¸æ•°æ®å­˜åœ¨ä¸­é—´çŠ¶æ€ï¼Œå…è®¸æ•°æ®åœ¨ä¸åŒèŠ‚ç‚¹è¿›è¡Œæ•°æ®åŒæ­¥æ—¶å­˜åœ¨å»¶æ—¶ã€‚</p></blockquote></li><li><p>Eventually consistentï¼ˆEæœ€ç»ˆä¸€è‡´æ€§ï¼‰</p><blockquote><p>ç³»ç»Ÿé—´çš„æ‰€æœ‰æ•°æ®å‰¯æœ¬ï¼Œåœ¨ç»è¿‡ä¸€æ®µæ—¶é—´åŒæ­¥åï¼Œæœ€ç»ˆèƒ½å¤Ÿè¾¾åˆ°ä¸€è‡´æ€§ã€‚ä¸éœ€è¦å®æ—¶ä¸€è‡´æ€§ã€‚</p></blockquote></li></ul><p><img src="https://cdn.jsdelivr.net/gh/zyxelva/picgo@main/markdown/CAP2.png" alt="BASEç†è®º"></p><p>ä¸‹ä¸€ç« è®¨è®ºåˆ†å¸ƒå¼ä¸­çš„ä¸€è‡´æ€§åè®®ã€‚æ•¬è¯·æœŸå¾…ï¼</p>]]></content>
      
      
      <categories>
          
          <category> Zookeeperå­¦ä¹  </category>
          
      </categories>
      
      
        <tags>
            
            <tag> åˆ†å¸ƒå¼ </tag>
            
            <tag> CAP </tag>
            
            <tag> BASE </tag>
            
            <tag> ACID </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ã€LeetCodeã€‘300. æœ€é•¿é€’å¢å­åºåˆ—</title>
      <link href="/posts/1552474657.html"/>
      <url>/posts/1552474657.html</url>
      
        <content type="html"><![CDATA[<h1 id="1-é—®é¢˜"><a href="#1-é—®é¢˜" class="headerlink" title="1.é—®é¢˜"></a>1.é—®é¢˜</h1><p>ç»™ä½ ä¸€ä¸ªæ•´æ•°æ•°ç»„ nums ï¼Œæ‰¾åˆ°å…¶ä¸­æœ€é•¿ä¸¥æ ¼é€’å¢å­åºåˆ—çš„é•¿åº¦ã€‚</p><p>å­åºåˆ— æ˜¯ç”±æ•°ç»„æ´¾ç”Ÿè€Œæ¥çš„åºåˆ—ï¼Œåˆ é™¤ï¼ˆæˆ–ä¸åˆ é™¤ï¼‰æ•°ç»„ä¸­çš„å…ƒç´ è€Œä¸æ”¹å˜å…¶ä½™å…ƒç´ çš„é¡ºåºã€‚ä¾‹å¦‚ï¼Œ<code>[3,6,2,7]</code> æ˜¯æ•°ç»„ <code>[0,3,1,6,2,2,7]</code> çš„å­åºåˆ—ã€‚</p><h2 id="ç¤ºä¾‹-1"><a href="#ç¤ºä¾‹-1" class="headerlink" title="ç¤ºä¾‹ 1"></a>ç¤ºä¾‹ 1</h2><blockquote><p>è¾“å…¥ï¼šnums &#x3D; [10,9,2,5,3,7,101,18]<br>è¾“å‡ºï¼š4<br>è§£é‡Šï¼šæœ€é•¿é€’å¢å­åºåˆ—æ˜¯ [2,3,7,101]ï¼Œå› æ­¤é•¿åº¦ä¸º 4 ã€‚</p></blockquote><h2 id="ç¤ºä¾‹-2"><a href="#ç¤ºä¾‹-2" class="headerlink" title="ç¤ºä¾‹ 2"></a>ç¤ºä¾‹ 2</h2><blockquote><p>è¾“å…¥ï¼šnums &#x3D; [0,1,0,3,2,3]<br>è¾“å‡ºï¼š4</p></blockquote><h2 id="ç¤ºä¾‹-3"><a href="#ç¤ºä¾‹-3" class="headerlink" title="ç¤ºä¾‹ 3"></a>ç¤ºä¾‹ 3</h2><blockquote><p>è¾“å…¥ï¼šnums &#x3D; [7,7,7,7,7,7,7]<br>è¾“å‡ºï¼š1</p></blockquote><p><strong>æç¤º</strong>ï¼š</p><ul><li>1 &lt;&#x3D; nums.length &lt;&#x3D; 2500</li><li>-104 &lt;&#x3D; nums[i] &lt;&#x3D; 104</li></ul><p>è¿›é˜¶ï¼š</p><p>ä½ èƒ½å°†ç®—æ³•çš„æ—¶é—´å¤æ‚åº¦é™ä½åˆ° <code>O(nlog(n))</code> å—?</p><h1 id="2-è§£é¢˜æ€è·¯"><a href="#2-è§£é¢˜æ€è·¯" class="headerlink" title="2. è§£é¢˜æ€è·¯"></a>2. è§£é¢˜æ€è·¯</h1><h2 id="2-1-åŠ¨æ€è§„åˆ’"><a href="#2-1-åŠ¨æ€è§„åˆ’" class="headerlink" title="2.1 åŠ¨æ€è§„åˆ’"></a>2.1 åŠ¨æ€è§„åˆ’</h2><p>ç±»ä¼¼ <a href="https://blog.csdn.net/kezade/article/details/130509541">674. æœ€é•¿è¿ç»­é€’å¢åºåˆ—</a> ï¼Œæˆ‘ä»¬å®šä¹‰ï¼š<br><strong>$dp_i$</strong> ä¸ºä»¥<code>nums[i]</code>ç»“å°¾çš„æœ€é•¿é€’å¢å­åºåˆ—é•¿åº¦ï¼Œåˆ™åœ¨åŒºé—´<code>[0,i)</code>èŒƒå›´å†…ï¼Œä»»ä¸€<code>j</code>ï¼Œæœ‰ä»¥ä¸‹åˆ¤æ–­ï¼š</p><ul><li>å½“ <code>nums[i]&gt;nums[j]</code>æ—¶ï¼Œnums[i]æ¥åœ¨nums[j]åï¼Œéƒ½èƒ½ä½¿å¾—åºåˆ—é•¿åº¦åŠ 1ï¼Œå³ <strong>$dp_i$&#x3D; $dp_j$ + 1</strong>;</li><li>å¦åˆ™ï¼Œ<code>j++</code>ï¼Œç»§ç»­å¾ªç¯<code>j</code>ã€‚</li></ul><p>å› æ­¤å¾—å‡º çŠ¶æ€è½¬ç§»æ–¹ç¨‹ä¸ºï¼š</p><p><strong>$dp_i$ &#x3D; max($dp_i$ , $dp_j$ + 1)</strong> ï¼Œå…¶ä¸­ <code>jâˆˆ[0, i)</code>.</p><p>ç”±äºé¢˜ç›®å·²çŸ¥ï¼Œæ•°ç»„è‡³å°‘æœ‰ä¸€ä¸ªå…ƒç´ ï¼Œå› è€Œ$dp_{ij}$ è‡³å°‘ä¸º1ï¼Œåˆå§‹åŒ–æ—¶å…¨éƒ½ä¸º1.</p><p><strong>å¤æ‚åº¦åˆ†æ</strong>ï¼š</p><ul><li>æ—¶é—´å¤æ‚åº¦ O($N^2$)ï¼š éå†è®¡ç®— dp åˆ—è¡¨éœ€ O(N)ï¼Œè®¡ç®—æ¯ä¸ª $dp_i$ éœ€ O(N)ã€‚</li><li>ç©ºé—´å¤æ‚åº¦ O(N)ï¼š dp åˆ—è¡¨å ç”¨çº¿æ€§å¤§å°é¢å¤–ç©ºé—´ã€‚</li></ul><p>ä¸¾ä¾‹ï¼š<code>nums=[10,9,2,5,3,7,21,18]</code>.</p><ul><li><p>åˆå§‹çŠ¶æ€<br><img src="https://cdn.jsdelivr.net/gh/zyxelva/picgo@main/csdn/4859d6f4149e4ae0b78f234125226b0a.png"></p></li><li><p>$dp_1$ çš„å€¼<br><img src="https://cdn.jsdelivr.net/gh/zyxelva/picgo@main/csdn/f5be726f2a324e078ea97ba4172304a7.png"></p></li><li><p>$dp_2$ çš„å€¼<br><img src="https://cdn.jsdelivr.net/gh/zyxelva/picgo@main/csdn/95f43db5b5bf43fc9279494b180eec03.png"></p></li><li><p>$dp_3$ çš„å€¼<br><img src="https://cdn.jsdelivr.net/gh/zyxelva/picgo@main/csdn/5956d6fb71ad4eb5a7f3339ff3d30e4b.png"></p></li><li><p>$dp_4$ çš„å€¼<br><img src="https://cdn.jsdelivr.net/gh/zyxelva/picgo@main/csdn/1726b7db75cb425293ff5a2bb9a0cde0.png"></p></li><li><p>$dp_5$ çš„å€¼<br><img src="https://cdn.jsdelivr.net/gh/zyxelva/picgo@main/csdn/9182f7b175fc4b179ce43951862d16f5.png"></p></li><li><p>$dp_6$ çš„å€¼<br><img src="https://cdn.jsdelivr.net/gh/zyxelva/picgo@main/csdn/a3a43cebfc934daab6cc33bf2598b953.png"></p></li><li><p>$dp_7$ çš„å€¼<br><img src="https://cdn.jsdelivr.net/gh/zyxelva/picgo@main/csdn/05c22d4ae7154435a15d5d8d447669eb.png"></p></li><li><p>$dp_8$ çš„å€¼<br><img src="https://cdn.jsdelivr.net/gh/zyxelva/picgo@main/csdn/7a5a173ef8f3450bbdaf016ae1ddfe9e.png"></p></li><li><p>æ±‚max(dp)<br><img src="https://cdn.jsdelivr.net/gh/zyxelva/picgo@main/csdn/1554d9cc74214186af2bf48bda4025c5.png"></p></li></ul><h2 id="2-2-åŠ¨æ€è§„åˆ’-äºŒåˆ†æŸ¥æ‰¾"><a href="#2-2-åŠ¨æ€è§„åˆ’-äºŒåˆ†æŸ¥æ‰¾" class="headerlink" title="2.2 åŠ¨æ€è§„åˆ’+äºŒåˆ†æŸ¥æ‰¾"></a>2.2 åŠ¨æ€è§„åˆ’+äºŒåˆ†æŸ¥æ‰¾</h2><ul><li><p>çŠ¶æ€å®šä¹‰ï¼šä»¤ <code>tails[k]</code> çš„å€¼ä»£è¡¨<strong>é•¿åº¦ä¸º k+1 å­åºåˆ—</strong>çš„å°¾éƒ¨å…ƒç´ å€¼ã€‚</p></li><li><p>è½¬ç§»æ–¹ç¨‹ï¼š è®¾ res ä¸º tails å½“å‰é•¿åº¦ï¼Œä»£è¡¨ç›´åˆ°å½“å‰çš„æœ€é•¿ä¸Šå‡å­åºåˆ—é•¿åº¦ã€‚è®¾<code> jâˆˆ[0,res)</code>ï¼Œè€ƒè™‘æ¯è½®éå† nums[k] æ—¶ï¼Œé€šè¿‡äºŒåˆ†æ³•éå† <code>[0,res)</code> åˆ—è¡¨åŒºé—´ï¼Œæ‰¾å‡º nums[k] çš„å¤§å°åˆ†ç•Œç‚¹ï¼Œä¼šå‡ºç°ä¸¤ç§æƒ…å†µï¼š</p><ul><li>åŒºé—´ä¸­å­˜åœ¨ <code>tails[i]&gt;nums[k]</code> ï¼š å°†<strong>ç¬¬ä¸€ä¸ª</strong>æ»¡è¶³ <code>tails[i]&gt;nums[k]</code> æ‰§è¡Œ <code>tails[i]=nums[k]</code> ï¼›å› ä¸ºæ›´å°çš„ nums[k] åæ›´å¯èƒ½æ¥ä¸€ä¸ªæ¯”å®ƒå¤§çš„æ•°å­—ï¼ˆå‰é¢åˆ†æè¿‡ï¼‰ã€‚</li><li>åŒºé—´ä¸­ä¸å­˜åœ¨ <code>tails[i]&gt;nums[k]</code> ï¼š æ„å‘³ç€ nums[k] å¯ä»¥æ¥åœ¨å‰é¢æ‰€æœ‰é•¿åº¦çš„å­åºåˆ—ä¹‹åï¼Œå› æ­¤è‚¯å®šæ˜¯æ¥åˆ°æœ€é•¿çš„åé¢ï¼ˆé•¿åº¦ä¸º res ï¼‰ï¼Œæ–°å­åºåˆ—é•¿åº¦ä¸º res+1ã€‚</li></ul></li><li><p>åˆå§‹çŠ¶æ€ï¼šä»¤ tails åˆ—è¡¨æ‰€æœ‰å€¼ä¸º 0ã€‚</p></li><li><p>è¿”å›å€¼ï¼šè¿”å› res ï¼Œå³æœ€é•¿ä¸Šå‡å­å­åºåˆ—é•¿åº¦ã€‚</p></li></ul><p><strong>å¤æ‚åº¦åˆ†æ</strong>ï¼š</p><ul><li>æ—¶é—´å¤æ‚åº¦ O(NlogN)ï¼š éå† nums åˆ—è¡¨éœ€ O(N)ï¼Œåœ¨æ¯ä¸ª nums[i] äºŒåˆ†æ³•éœ€ O(logN)ã€‚</li><li>ç©ºé—´å¤æ‚åº¦ O(N) ï¼š tails åˆ—è¡¨å ç”¨çº¿æ€§å¤§å°é¢å¤–ç©ºé—´ã€‚</li></ul><p><strong>ç‰¹åˆ«æ³¨æ„</strong>ï¼šæœ¬æ–¹æ³•åªèƒ½ç”¨äºæ±‚æœ€é•¿é€’å¢å­åºåˆ—çš„é•¿åº¦ï¼Œè¾…åŠ©æ•°ç»„ä¸­çš„åºåˆ—<strong>ä¸æ˜¯</strong>æœ€é•¿é€’å¢å­åºåˆ—ï¼š</p><ul><li><p>ä¾‹ä¸€ï¼šåŸåºåˆ—ä¸º1ï¼Œ5ï¼Œ8ï¼Œ3ï¼Œ6ï¼Œ7<br>è¾…åŠ©æ•°ç»„ä¸º1ï¼Œ5ï¼Œ8ï¼Œæ­¤æ—¶è¯»åˆ°3ï¼Œç”¨3æ›¿æ¢5ï¼Œå¾—åˆ°1ï¼Œ3ï¼Œ8ï¼› å†è¯»6ï¼Œç”¨6æ›¿æ¢8ï¼Œå¾—åˆ°1ï¼Œ3ï¼Œ6ï¼›å†è¯»7ï¼Œå¾—åˆ°æœ€ç»ˆæ ˆä¸º1ï¼Œ3ï¼Œ6ï¼Œ7ã€‚æœ€é•¿é€’å¢å­åºåˆ—ä¸ºé•¿åº¦4ã€‚</p></li><li><p>ä¾‹äºŒï¼šåŸåºåˆ—ä¸º1ï¼Œ5ï¼Œ8ï¼Œ3<br>åˆ™æœ€æ ˆè¾…åŠ©æ•°ç»„ä¸º1ï¼Œ3ï¼Œ8ã€‚æ˜æ˜¾è¿™ä¸æ˜¯æœ€é•¿é€’å¢å­åºåˆ—ï¼</p></li></ul><p>å€Ÿç”¨çŸ¥ä¹å¤§ç¥ <a href="https://zhuanlan.zhihu.com/p/149911042">ä¼é¹…</a>çš„ä¸€ä¸ªä¾‹å­ï¼š</p><p><img src="https://cdn.jsdelivr.net/gh/zyxelva/picgo@main/csdn/5346d1d0ceeb49d9a83fc4dcb8fd7793.png"></p><h1 id="3-ä»£ç "><a href="#3-ä»£ç " class="headerlink" title="3. ä»£ç "></a>3. ä»£ç </h1><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">class</span> <span class="token class-name">Solution</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">lengthOfLIS2</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> nums<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">int</span> len<span class="token operator">=</span>nums<span class="token punctuation">.</span>length<span class="token punctuation">;</span>        <span class="token keyword">int</span> maxLen<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>        <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> dp<span class="token operator">=</span><span class="token keyword">new</span> <span class="token keyword">int</span><span class="token punctuation">[</span>len<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token comment">//åˆå§‹åŒ–</span>        <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">fill</span><span class="token punctuation">(</span>dp<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>len<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> j<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>j<span class="token operator">&lt;</span>i<span class="token punctuation">;</span>j<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            <span class="token comment">//ç¬¦åˆæ‹¼æ¥åœ¨åŸæœ‰åºåˆ—ä¹‹åçš„æ¡ä»¶ï¼Œåˆ™dp[j]+1,maxæ˜¯ä¸ºäº†ä¿è¯dp[i]æ°¸è¿œæ˜¯æœ€å¤§å€¼ï¼› å¦åˆ™ ç½®ä¸º1</span>                <span class="token keyword">if</span><span class="token punctuation">(</span>nums<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">></span>nums<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>                    dp<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">=</span><span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span>dp<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span>dp<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">&#125;</span>            <span class="token punctuation">&#125;</span>            <span class="token comment">//è®¡ç®—å½“å‰èŒƒå›´[0,i]çš„æœ€å¤§å€¼</span>            maxLen<span class="token operator">=</span><span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span>maxLen<span class="token punctuation">,</span> dp<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">return</span> maxLen<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token comment">//åŠ¨æ€è§„åˆ’+äºŒåˆ†æŸ¥æ‰¾</span>    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">lengthOfLIS</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> nums<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> tails <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">int</span><span class="token punctuation">[</span>nums<span class="token punctuation">.</span>length<span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token keyword">int</span> res <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> num <span class="token operator">:</span> nums<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> j <span class="token operator">=</span> res<span class="token punctuation">;</span>            <span class="token keyword">while</span><span class="token punctuation">(</span>i <span class="token operator">&lt;</span> j<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                <span class="token keyword">int</span> m <span class="token operator">=</span> <span class="token punctuation">(</span>i <span class="token operator">+</span> j<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">;</span>                <span class="token keyword">if</span><span class="token punctuation">(</span>tails<span class="token punctuation">[</span>m<span class="token punctuation">]</span> <span class="token operator">&lt;</span> num<span class="token punctuation">)</span> i <span class="token operator">=</span> m <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>                <span class="token keyword">else</span> j <span class="token operator">=</span> m<span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>            tails<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> num<span class="token punctuation">;</span>            <span class="token keyword">if</span><span class="token punctuation">(</span>res <span class="token operator">==</span> j<span class="token punctuation">)</span> res<span class="token operator">++</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">return</span> res<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token comment">// ä½œè€…ï¼šKrahets</span><span class="token comment">// é“¾æ¥ï¼šhttps://leetcode.cn/problems/longest-increasing-subsequence/solutions/24173/zui-chang-shang-sheng-zi-xu-lie-dong-tai-gui-hua-2/</span><span class="token comment">// æ¥æºï¼šåŠ›æ‰£ï¼ˆLeetCodeï¼‰</span><span class="token comment">// è‘—ä½œæƒå½’ä½œè€…æ‰€æœ‰ã€‚å•†ä¸šè½¬è½½è¯·è”ç³»ä½œè€…è·å¾—æˆæƒï¼Œéå•†ä¸šè½¬è½½è¯·æ³¨æ˜å‡ºå¤„ã€‚</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> ç®—æ³• </category>
          
      </categories>
      
      
        <tags>
            
            <tag> LeetCode </tag>
            
            <tag> åŠ¨æ€è§„åˆ’ </tag>
            
            <tag> äºŒåˆ†æŸ¥æ‰¾ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ã€LeetCodeã€‘674. æœ€é•¿è¿ç»­é€’å¢åºåˆ—</title>
      <link href="/posts/725693136.html"/>
      <url>/posts/725693136.html</url>
      
        <content type="html"><![CDATA[<h1 id="1-é—®é¢˜"><a href="#1-é—®é¢˜" class="headerlink" title="1. é—®é¢˜"></a>1. é—®é¢˜</h1><p>ç»™å®šä¸€ä¸ªæœªç»æ’åºçš„æ•´æ•°æ•°ç»„ï¼Œæ‰¾åˆ°<strong>æœ€é•¿</strong>ä¸”<strong>è¿ç»­é€’å¢çš„å­åºåˆ—</strong>ï¼Œå¹¶è¿”å›è¯¥åºåˆ—çš„é•¿åº¦ã€‚</p><p>è¿ç»­é€’å¢çš„å­åºåˆ— å¯ä»¥ç”±ä¸¤ä¸ªä¸‹æ ‡ l å’Œ rï¼ˆl &lt; rï¼‰ç¡®å®šï¼Œå¦‚æœå¯¹äºæ¯ä¸ª l &lt;&#x3D; i &lt; rï¼Œéƒ½æœ‰ nums[i] &lt; nums[i + 1] ï¼Œé‚£ä¹ˆå­åºåˆ— [nums[l], nums[l + 1], â€¦, nums[r - 1], nums[r]] å°±æ˜¯è¿ç»­é€’å¢å­åºåˆ—ã€‚</p><h2 id="ç¤ºä¾‹-1"><a href="#ç¤ºä¾‹-1" class="headerlink" title="ç¤ºä¾‹ 1"></a>ç¤ºä¾‹ 1</h2><blockquote><p>è¾“å…¥ï¼šnums &#x3D; [1,3,5,4,7]<br>è¾“å‡ºï¼š3<br>è§£é‡Šï¼šæœ€é•¿è¿ç»­é€’å¢åºåˆ—æ˜¯ [1,3,5], é•¿åº¦ä¸º3ã€‚ å°½ç®¡ [1,3,5,7] ä¹Ÿæ˜¯å‡åºçš„å­åºåˆ—, ä½†å®ƒä¸æ˜¯è¿ç»­çš„ï¼Œå› ä¸º 5 å’Œ 7 åœ¨åŸæ•°ç»„é‡Œè¢« 4 éš”å¼€ã€‚</p></blockquote><h2 id="ç¤ºä¾‹-2"><a href="#ç¤ºä¾‹-2" class="headerlink" title="ç¤ºä¾‹ 2"></a>ç¤ºä¾‹ 2</h2><blockquote><p>è¾“å…¥ï¼šnums &#x3D; [2,2,2,2,2]<br>è¾“å‡ºï¼š1<br>è§£é‡Šï¼šæœ€é•¿è¿ç»­é€’å¢åºåˆ—æ˜¯ [2], é•¿åº¦ä¸º1ã€‚</p></blockquote><p><strong>æç¤º</strong>ï¼š</p><ul><li>1 &lt;&#x3D; nums.length &lt;&#x3D; 104</li><li>-109 &lt;&#x3D; nums[i] &lt;&#x3D; 109</li></ul><h1 id="2-è§£é¢˜æ€è·¯"><a href="#2-è§£é¢˜æ€è·¯" class="headerlink" title="2. è§£é¢˜æ€è·¯"></a>2. è§£é¢˜æ€è·¯</h1><p>æœ¬é¢˜ä¸<a href="https://blog.csdn.net/kezade/article/details/130504356">300. æœ€é•¿é€’å¢å­åºåˆ—</a>åŒºåˆ«åœ¨äºå¤šäº†ä¸¤å­— <strong>è¿ç»­</strong>ï¼Œæ¯”è¾ƒçš„æ˜¯æŒ¨ç€çš„ä¸¤ä¸ªæ•°å€¼ã€‚</p><h2 id="2-1-åŒæŒ‡é’ˆï¼ˆæ»‘åŠ¨çª—å£ï¼‰"><a href="#2-1-åŒæŒ‡é’ˆï¼ˆæ»‘åŠ¨çª—å£ï¼‰" class="headerlink" title="2.1 åŒæŒ‡é’ˆï¼ˆæ»‘åŠ¨çª—å£ï¼‰"></a>2.1 åŒæŒ‡é’ˆï¼ˆæ»‘åŠ¨çª—å£ï¼‰</h2><ul><li>ä»¤æŒ‡é’ˆiæŒ‡å‘è¿ç»­é€’å¢åºåˆ—çš„å¼€å§‹ï¼ŒæŒ‡é’ˆjæŒ‡å‘æœ€åä¸€ä¸ªè¿ç»­é€’å¢åºåˆ—çš„æœ«å°¾</li><li>å½“<code>nums[j+1]&gt;nums[j]</code>æ—¶ï¼Œ<code>j++</code></li><li>å¦åˆ™ï¼Œè®¡ç®—å½“å‰è¿ç»­é€’å¢åºåˆ—çš„é•¿åº¦ï¼Œå¹¶ä¸å½“å‰çš„æœ€å¤§è¿ç»­é€’å¢åºåˆ—é•¿åº¦æ¯”è¾ƒï¼›å¤§ï¼Œåˆ™æ›¿æ¢æœ€å¤§å€¼ï¼›iæŒ‡å‘ <code>j+1ï¼Œj++</code>.</li></ul><p>è¯¦è§ä»£ç ä¸­æ–¹æ³• <code>findLengthOfLCIS3</code>ã€‚</p><h2 id="2-2-å•æŒ‡é’ˆ"><a href="#2-2-å•æŒ‡é’ˆ" class="headerlink" title="2.2 å•æŒ‡é’ˆ"></a>2.2 å•æŒ‡é’ˆ</h2><p>ä¸€ä¸ªæŒ‡é’ˆéå†æ•°ç»„ï¼Œåˆå§‹çŠ¶æ€ï¼Œå½“å‰æœ€å¤§é•¿åº¦<code>count=1</code>ï¼Œæœ€ç»ˆç»“æœ<code>ans=1</code>:</p><ul><li>ä» 0 ä½ç½®å¼€å§‹éå†ï¼Œéå†æ—¶æ ¹æ®å‰åå…ƒç´ çŠ¶æ€åˆ¤æ–­æ˜¯å¦é€’å¢ï¼Œé€’å¢åˆ™ <code>count++</code>ï¼Œé€’å‡åˆ™ <code>count=1</code></li><li>å¦‚æœ <code>count&gt;ans</code>ï¼Œåˆ™æ›´æ–° ansï¼Œç›´åˆ°å¾ªç¯ç»“æŸ<br>è¯¦è§ä»£ç ä¸­ï¼Œæ–¹æ³•ï¼š<code>findLengthOfLCIS2</code>ã€‚</li></ul><h2 id="2-3-åŠ¨æ€è§„åˆ’"><a href="#2-3-åŠ¨æ€è§„åˆ’" class="headerlink" title="2.3 åŠ¨æ€è§„åˆ’"></a>2.3 åŠ¨æ€è§„åˆ’</h2><ul><li>ä»¤dp<del>i</del> ä¸ºåŒ…å«nums[i]çš„æœ€é•¿è¿ç»­é€’å¢å­åºåˆ—</li><li>ç¡®å®šé€’æ¨å…¬å¼ï¼š <code>dp~i~ = Math.max(dp~i-1~ + 1, dp~i~)</code>;</li><li>dpæ•°ç»„å¦‚ä½•åˆå§‹åŒ–ï¼š <code>Arrays.fill(dp, 1)</code>;</li><li>ç¡®å®šéå†é¡ºåºï¼šä»å‰å¾€å</li></ul><p>è¯¦è§ä»£ç ä¸­æ–¹æ³•<code>findLengthOfLCIS</code>ã€‚è¿›ä¸€æ­¥ä¼˜åŒ–è§æ–¹æ³• <code>findLengthOfLCIS0</code>ã€‚</p><h1 id="3-ä»£ç "><a href="#3-ä»£ç " class="headerlink" title="3. ä»£ç "></a>3. ä»£ç </h1><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">class</span> <span class="token class-name">Solution</span> <span class="token punctuation">&#123;</span>    <span class="token comment">//åŒæŒ‡é’ˆï¼šiä¸ºé€’å¢åºåˆ—å¼€å§‹ï¼Œjä¸ºæœ€åä¸€ä¸ªè¿ç»­é€’å¢åºåˆ—ç»“å°¾ç´¢å¼•ï¼Œå½“å‰æœ€é•¿è¿ç»­é€’å¢åºåˆ—é•¿åº¦ä¸º j-i</span>    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">findLengthOfLCIS3</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> nums<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>        <span class="token keyword">int</span> j<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>        <span class="token comment">//å› ä¸ºnumsè‡³å°‘æœ‰ä¸€ä¸ªå…ƒç´ ï¼Œåˆ™è¿ç»­é€’å¢çš„æœ€å°å€¼ä¸º1</span>        <span class="token keyword">int</span> maxLen<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>        <span class="token keyword">int</span> len<span class="token operator">=</span>nums<span class="token punctuation">.</span>length<span class="token punctuation">;</span>        <span class="token keyword">while</span><span class="token punctuation">(</span>j<span class="token operator">&lt;</span>len<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            <span class="token keyword">if</span><span class="token punctuation">(</span>nums<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token operator">&lt;</span>nums<span class="token punctuation">[</span>j<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>                j<span class="token operator">++</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>            <span class="token comment">//å¦åˆ™ï¼Œè®¡ç®—å½“å‰åºåˆ—é•¿åº¦</span>            <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>                maxLen<span class="token operator">=</span><span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span>maxLen<span class="token punctuation">,</span> j<span class="token operator">-</span>i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment">//ä»ä¸è¿ç»­å¤„å¼€å§‹ï¼Œé‡æ–°éå†</span>                i<span class="token operator">=</span>j<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">;</span>                j<span class="token operator">++</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>        <span class="token comment">//å¯èƒ½æ­£åœ¨é€’å¢ï¼Œéå†ç»“æŸäº†</span>        maxLen<span class="token operator">=</span><span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span>maxLen<span class="token punctuation">,</span> j<span class="token operator">-</span>i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> maxLen<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">/**    æ”¹è¿›ä¸ºå•æŒ‡é’ˆï¼š     count ä¸ºå½“å‰å…ƒç´ å³°å€¼ï¼Œansä¸ºæœ€å¤§å³°å€¼    åˆå§‹åŒ– count = 1    ä» 0 ä½ç½®å¼€å§‹éå†ï¼Œéå†æ—¶æ ¹æ®å‰åå…ƒç´ çŠ¶æ€åˆ¤æ–­æ˜¯å¦é€’å¢ï¼Œé€’å¢åˆ™ count++ï¼Œé€’å‡åˆ™ count=1    å¦‚æœ count>ansï¼Œåˆ™æ›´æ–° ans    ç›´åˆ°å¾ªç¯ç»“æŸ    æ—¶é—´å¤æ‚åº¦ï¼šO(N)    */</span>    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">findLengthOfLCIS2</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> nums<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>nums<span class="token punctuation">.</span>length <span class="token operator">&lt;=</span> <span class="token number">1</span><span class="token punctuation">)</span>            <span class="token keyword">return</span> nums<span class="token punctuation">.</span>length<span class="token punctuation">;</span>        <span class="token keyword">int</span> ans <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>        <span class="token keyword">int</span> count <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>nums<span class="token punctuation">.</span>length<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">if</span><span class="token punctuation">(</span>nums<span class="token punctuation">[</span>i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">></span> nums<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                count<span class="token operator">++</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span> <span class="token comment">//è¿™é‡Œelseä¸­ ä¸ç›´æ¥è®¡ç®—ansï¼Œæ˜¯å› ä¸ºå¯¹äºè¿ç»­é€’å¢çš„åºåˆ— 1ï¼Œ2ï¼Œ3ï¼Œ4ï¼Œ5ï¼Œå°±ä¸ä¼šèµ°elseï¼›è‹¥ç›´æ¥å†™ans = count > ans ? count : ansï¼Œå¾ªç¯å®Œæ¯•ï¼Œå°±è¿˜è¦è®¡ç®—ä¸€é</span><span class="token keyword">else</span> <span class="token punctuation">&#123;</span>                  count <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>            ans <span class="token operator">=</span> count <span class="token operator">></span> ans <span class="token operator">?</span> count <span class="token operator">:</span> ans<span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">return</span> ans<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">/**        åŠ¨æ€è§„åˆ’ï¼š        1ã€ç¡®å®šdpæ•°ç»„åŠä¸‹æ ‡å«ä¹‰ï¼šåŒ…å«nums[i]çš„æœ€é•¿è¿ç»­é€’å¢å­åºåˆ—        2ã€ç¡®å®šé€’æ¨å…¬å¼ï¼š dp[i] = Math.max(dp[i - 1] + 1, dp[i]);        3ã€dpæ•°ç»„å¦‚ä½•åˆå§‹åŒ–ï¼š Arrays.fill(dp, 1);        4ã€ç¡®å®šéå†é¡ºåºï¼šä»å‰å¾€å        5ã€ä¸¾ä¾‹æ¨å¯¼ï¼šÂ·Â·Â·Â·Â·     */</span>     <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">findLengthOfLCIS</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> nums<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>         <span class="token keyword">int</span> maxLen<span class="token operator">=</span><span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token constant">MIN_VALUE</span><span class="token punctuation">;</span>         <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> dp<span class="token operator">=</span><span class="token keyword">new</span> <span class="token keyword">int</span><span class="token punctuation">[</span>nums<span class="token punctuation">.</span>length<span class="token punctuation">]</span><span class="token punctuation">;</span>         <span class="token comment">//å¡«å……åˆå§‹å€¼ï¼Œå‡ä¸º1</span>         <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">fill</span><span class="token punctuation">(</span>dp<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>         <span class="token comment">//éå†</span>         <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span>nums<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>             <span class="token keyword">if</span><span class="token punctuation">(</span>nums<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">></span>nums<span class="token punctuation">[</span>i<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>                 dp<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">=</span><span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span>dp<span class="token punctuation">[</span>i<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span> dp<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>             <span class="token punctuation">&#125;</span>         <span class="token punctuation">&#125;</span>         <span class="token comment">//æ‰¾åˆ°æœ€å¤§å€¼</span>         <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> n<span class="token operator">:</span>dp<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>             maxLen<span class="token operator">=</span><span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span>n<span class="token punctuation">,</span> maxLen<span class="token punctuation">)</span><span class="token punctuation">;</span>         <span class="token punctuation">&#125;</span>         <span class="token keyword">return</span> maxLen<span class="token punctuation">;</span>     <span class="token punctuation">&#125;</span><span class="token comment">//ä¼˜åŒ–</span><span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">findLengthOfLCIS0</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> nums<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>         <span class="token keyword">int</span> maxLen<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>         <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> dp<span class="token operator">=</span><span class="token keyword">new</span> <span class="token keyword">int</span><span class="token punctuation">[</span>nums<span class="token punctuation">.</span>length<span class="token punctuation">]</span><span class="token punctuation">;</span>         <span class="token comment">//å¡«å……åˆå§‹å€¼ï¼Œå‡ä¸º1</span>         <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">fill</span><span class="token punctuation">(</span>dp<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>         <span class="token comment">//éå†</span>         <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span>nums<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>             <span class="token keyword">if</span><span class="token punctuation">(</span>nums<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">></span>nums<span class="token punctuation">[</span>i<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>                 dp<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">=</span>dp<span class="token punctuation">[</span>i<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">;</span>             <span class="token punctuation">&#125;</span>             <span class="token keyword">if</span><span class="token punctuation">(</span>maxLen<span class="token operator">&lt;</span>dp<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>                 maxLen<span class="token operator">=</span>dp<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>             <span class="token punctuation">&#125;</span>         <span class="token punctuation">&#125;</span>         <span class="token keyword">return</span> maxLen<span class="token punctuation">;</span>     <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> ç®—æ³• </category>
          
      </categories>
      
      
        <tags>
            
            <tag> LeetCode </tag>
            
            <tag> åŠ¨æ€è§„åˆ’ </tag>
            
            <tag> æŒ‡é’ˆ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ã€LeetCodeã€‘1143. æœ€é•¿å…¬å…±å­åºåˆ—</title>
      <link href="/posts/3935977907.html"/>
      <url>/posts/3935977907.html</url>
      
        <content type="html"><![CDATA[<h1 id="1-é—®é¢˜"><a href="#1-é—®é¢˜" class="headerlink" title="1.é—®é¢˜"></a>1.é—®é¢˜</h1><p>ç»™å®šä¸¤ä¸ªå­—ç¬¦ä¸² text1 å’Œ text2ï¼Œè¿”å›è¿™ä¸¤ä¸ªå­—ç¬¦ä¸²çš„æœ€é•¿ å…¬å…±å­åºåˆ— çš„é•¿åº¦ã€‚å¦‚æœä¸å­˜åœ¨ å…¬å…±å­åºåˆ— ï¼Œè¿”å› 0 ã€‚</p><p>ä¸€ä¸ªå­—ç¬¦ä¸²çš„ å­åºåˆ— æ˜¯æŒ‡è¿™æ ·ä¸€ä¸ªæ–°çš„å­—ç¬¦ä¸²ï¼šå®ƒæ˜¯ç”±åŸå­—ç¬¦ä¸²åœ¨ä¸æ”¹å˜å­—ç¬¦çš„ç›¸å¯¹é¡ºåºçš„æƒ…å†µä¸‹åˆ é™¤æŸäº›å­—ç¬¦ï¼ˆä¹Ÿå¯ä»¥ä¸åˆ é™¤ä»»ä½•å­—ç¬¦ï¼‰åç»„æˆçš„æ–°å­—ç¬¦ä¸²ã€‚</p><p>ä¾‹å¦‚ï¼Œâ€aceâ€ æ˜¯ â€œabcdeâ€ çš„å­åºåˆ—ï¼Œä½† â€œaecâ€ ä¸æ˜¯ â€œabcdeâ€ çš„å­åºåˆ—ã€‚<br>ä¸¤ä¸ªå­—ç¬¦ä¸²çš„ å…¬å…±å­åºåˆ— æ˜¯è¿™ä¸¤ä¸ªå­—ç¬¦ä¸²æ‰€å…±åŒæ‹¥æœ‰çš„å­åºåˆ—ã€‚</p><h2 id="ç¤ºä¾‹-1"><a href="#ç¤ºä¾‹-1" class="headerlink" title="ç¤ºä¾‹ 1"></a>ç¤ºä¾‹ 1</h2><blockquote><p>è¾“å…¥ï¼štext1 &#x3D; â€œabcdeâ€, text2 &#x3D; â€œaceâ€<br>è¾“å‡ºï¼š3<br>è§£é‡Šï¼šæœ€é•¿å…¬å…±å­åºåˆ—æ˜¯ â€œaceâ€ ï¼Œå®ƒçš„é•¿åº¦ä¸º 3 ã€‚</p></blockquote><h2 id="ç¤ºä¾‹-2"><a href="#ç¤ºä¾‹-2" class="headerlink" title="ç¤ºä¾‹ 2"></a>ç¤ºä¾‹ 2</h2><blockquote><p>è¾“å…¥ï¼štext1 &#x3D; â€œabcâ€, text2 &#x3D; â€œabcâ€<br>è¾“å‡ºï¼š3<br>è§£é‡Šï¼šæœ€é•¿å…¬å…±å­åºåˆ—æ˜¯ â€œabcâ€ ï¼Œå®ƒçš„é•¿åº¦ä¸º 3 ã€‚</p></blockquote><h2 id="ç¤ºä¾‹-3"><a href="#ç¤ºä¾‹-3" class="headerlink" title="ç¤ºä¾‹ 3"></a>ç¤ºä¾‹ 3</h2><blockquote><p>è¾“å…¥ï¼štext1 &#x3D; â€œabcâ€, text2 &#x3D; â€œdefâ€<br>è¾“å‡ºï¼š0<br>è§£é‡Šï¼šä¸¤ä¸ªå­—ç¬¦ä¸²æ²¡æœ‰å…¬å…±å­åºåˆ—ï¼Œè¿”å› 0 ã€‚</p></blockquote><p><strong>æç¤º</strong>ï¼š</p><ul><li>1 &lt;&#x3D; text1.length, text2.length &lt;&#x3D; 1000</li><li>text1 å’Œ text2 ä»…ç”±å°å†™è‹±æ–‡å­—ç¬¦ç»„æˆã€‚</li></ul><h1 id="2-è§£é¢˜æ€è·¯"><a href="#2-è§£é¢˜æ€è·¯" class="headerlink" title="2.è§£é¢˜æ€è·¯"></a>2.è§£é¢˜æ€è·¯</h1><h2 id="2-1-åŠ¨æ€è§„åˆ’"><a href="#2-1-åŠ¨æ€è§„åˆ’" class="headerlink" title="2.1 åŠ¨æ€è§„åˆ’"></a>2.1 åŠ¨æ€è§„åˆ’</h2><p>å®šä¹‰<code>dp~ij~</code>è¡¨ç¤º<code>text~1~</code>çš„å‰<code>i-1</code>ä¸ªå­—ç¬¦å’Œ<code>text~2~ </code>çš„å‰<code>j-1</code>ä¸ªå­—ç¬¦æ‰€èƒ½å½¢æˆçš„æœ€é•¿å…¬å…±å­åºåˆ—çš„é•¿åº¦ã€‚<br>ä»¤<code>len1</code>ä¸º<code>text~1~</code> çš„æ€»é•¿ï¼Œ<code>len2</code>ä¸º<code>text~2~</code> çš„æ€»é•¿ï¼Œåˆ™<code>dp~len1,len2~</code> å³ä¸ºé¢˜ç›®æ‰€æ±‚ã€‚</p><ul><li><p>å½“ i&#x3D;0 æ—¶ï¼Œ<code>text~1~ [0:i]</code> ä¸ºç©ºï¼Œç©ºå­—ç¬¦ä¸²å’Œä»»ä½•å­—ç¬¦ä¸²çš„æœ€é•¿å…¬å…±å­åºåˆ—çš„é•¿åº¦éƒ½æ˜¯ 0ï¼Œå› æ­¤å¯¹ä»»æ„ <code>0â‰¤jâ‰¤len2</code>ï¼Œæœ‰ <code>dp~0,j~=0</code>ï¼›</p></li><li><p>å½“ j&#x3D;0 æ—¶ï¼Œ<code>text~2~[0:j]</code> ä¸ºç©ºï¼ŒåŒç†å¯å¾—ï¼Œå¯¹ä»»æ„ <code>0â‰¤iâ‰¤len1</code>ï¼Œæœ‰ <code>dp[i][0]=0</code>ã€‚</p></li></ul><p>å› æ­¤åŠ¨æ€è§„åˆ’çš„è¾¹ç•Œæƒ…å†µæ˜¯ï¼šå½“ i&#x3D;0 æˆ– j&#x3D;0 æ—¶ï¼Œ<code>dp~i,0~=0</code>ã€‚</p><ul><li><p>å½“ i&gt;0 ä¸” j&gt;0 æ—¶ï¼Œè€ƒè™‘ <code>dp~ij~</code>çš„è®¡ç®—ï¼š</p><ul><li><p>å½“ <code>text~1~[iâˆ’1] = text~2~[jâˆ’1]</code> æ—¶ï¼Œå°†è¿™ä¸¤ä¸ªç›¸åŒçš„å­—ç¬¦ç§°ä¸ºå…¬å…±å­—ç¬¦ï¼Œè€ƒè™‘ <code>text~1~[0:iâˆ’1]</code> å’Œ <code>text~2~[0:jâˆ’1]</code> çš„æœ€é•¿å…¬å…±å­åºåˆ—ï¼Œå†å¢åŠ ä¸€ä¸ªå­—ç¬¦ï¼ˆå³å…¬å…±å­—ç¬¦ï¼‰å³å¯å¾—åˆ° <code>text~1~[0:i]</code> å’Œ <code>text~2~[0:j]</code> çš„æœ€é•¿å…¬å…±å­åºåˆ—ï¼Œå› æ­¤ <code>dp~ij~=dp~i-1,j-1~+1</code>ã€‚</p></li><li><p>å½“ <code>text~1~[iâˆ’1]â‰ text~2~[jâˆ’1]</code> æ—¶ï¼Œè€ƒè™‘ä»¥ä¸‹ä¸¤é¡¹ï¼š</p><ul><li><p><code>text~1~[0:iâˆ’1]</code> å’Œ <code>text~2~[0:j]</code> çš„æœ€é•¿å…¬å…±å­åºåˆ—ï¼›</p></li><li><p><code>text~1~[0:i]</code> å’Œ <code>text~2~[0:jâˆ’1]</code> çš„æœ€é•¿å…¬å…±å­åºåˆ—ã€‚</p></li></ul><p>è¦å¾—åˆ° <code>text~1~[0:i]</code> å’Œ <code>text~2~[0:j]</code> çš„æœ€é•¿å…¬å…±å­åºåˆ—ï¼Œåº”å–ä¸¤é¡¹ä¸­çš„é•¿åº¦è¾ƒå¤§çš„ä¸€é¡¹ï¼Œå› æ­¤ <code>dp~ij~ == maxâ¡(dp~iâˆ’1,j~, dp~i,jâˆ’1~)</code>ã€‚</p></li></ul></li></ul><p>ç”±æ­¤å¯ä»¥å¾—åˆ°å¦‚ä¸‹çŠ¶æ€è½¬ç§»æ–¹ç¨‹ï¼š</p><ul><li>å½“<code>text~1~[0:i-1]=text~2~[0:j-1]</code>, <code>dp~i,j~ = dp~i-1,j-1~ +1</code>;</li><li>å¦åˆ™ï¼Œdp<del>i,j</del> &#x3D;max{dp<del>i,j-1</del> , dp<del>i-1,j</del> }</li></ul><p>æœ€ç»ˆï¼Œ<code>dp~len1,len2~</code> å³ä¸º<code>text~1~</code> å’Œ <code>text~2~</code> çš„æœ€é•¿å…¬å…±å­åºåˆ—ã€‚</p><p>ä¾‹å¦‚ï¼Œ<code>text~1~ =abcddab</code>, <code>text~2~ =bdcaba</code>ï¼Œåˆ™åŠ¨æ€è§„åˆ’çŸ©é˜µå¦‚ä¸‹å›¾ï¼š</p><p><img src="https://cdn.jsdelivr.net/gh/zyxelva/picgo@main/csdn/473d6bb69bfe4b2ea395e519fb43f8be.png"></p><h1 id="3-ä»£ç "><a href="#3-ä»£ç " class="headerlink" title="3.ä»£ç "></a>3.ä»£ç </h1><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">class</span> <span class="token class-name">Solution</span> <span class="token punctuation">&#123;</span>    <span class="token comment">/**åŠ¨æ€è§„åˆ’ï¼ˆåˆ©ç”¨åç§»ï¼‰ä¸Šè¿°ã€Œè¿½åŠ ç©ºæ ¼ã€çš„åšæ³•æ˜¯æˆ‘æ¯”è¾ƒä¹ æƒ¯çš„åšæ³• ğŸ¤£äº‹å®ä¸Šï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥é€šè¿‡ä¿®æ”¹ã€ŒçŠ¶æ€å®šä¹‰ã€æ¥å®ç°é€’æ¨ï¼šf[i][j] ä»£è¡¨è€ƒè™‘ s1 çš„å‰ iâˆ’1 ä¸ªå­—ç¬¦ã€è€ƒè™‘ s2 çš„å‰ jâˆ’1 çš„å­—ç¬¦ï¼Œå½¢æˆçš„æœ€é•¿å…¬å…±å­åºåˆ—é•¿åº¦ã€‚é‚£ä¹ˆæœ€ç»ˆçš„ f[n][m] å°±æ˜¯æˆ‘ä»¬çš„ç­”æ¡ˆï¼Œf[0][0] å½“åšæ— æ•ˆå€¼ï¼Œä¸å¤„ç†å³å¯ã€‚s1[i-1]==s2[j-1] : f[i][j]=f[iâˆ’1][jâˆ’1]+1ã€‚ä»£è¡¨ä½¿ç”¨ s1[iâˆ’1] ä¸ s2[jâˆ’1] å½¢æˆæœ€é•¿å…¬å…±å­åºåˆ—çš„é•¿åº¦ã€‚s1[i-1]!=s2[j-1] : f[i][j]=max(f[iâˆ’1][j],f[i][jâˆ’1])ã€‚ä»£è¡¨ä¸ä½¿ç”¨ s1[iâˆ’1] å½¢æˆæœ€é•¿å…¬å…±å­åºåˆ—çš„é•¿åº¦ã€ä¸ä½¿ç”¨ s2[jâˆ’1] å½¢æˆæœ€é•¿å…¬å…±å­åºåˆ—çš„é•¿åº¦ã€‚è¿™ä¸¤ç§æƒ…å†µä¸­çš„æœ€å¤§å€¼ã€‚ä½œè€…ï¼šå®«æ°´ä¸‰å¶é“¾æ¥ï¼šhttps://leetcode.cn/problems/longest-common-subsequence/solutions/697187/gong-shui-san-xie-zui-chang-gong-gong-zi-xq0h/æ¥æºï¼šåŠ›æ‰£ï¼ˆLeetCodeï¼‰è‘—ä½œæƒå½’ä½œè€…æ‰€æœ‰ã€‚å•†ä¸šè½¬è½½è¯·è”ç³»ä½œè€…è·å¾—æˆæƒï¼Œéå•†ä¸šè½¬è½½è¯·æ³¨æ˜å‡ºå¤„ã€‚    */</span>    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">longestCommonSubsequence</span><span class="token punctuation">(</span><span class="token class-name">String</span> text1<span class="token punctuation">,</span> <span class="token class-name">String</span> text2<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">char</span><span class="token punctuation">[</span><span class="token punctuation">]</span> t1 <span class="token operator">=</span> text1<span class="token punctuation">.</span><span class="token function">toCharArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">char</span><span class="token punctuation">[</span><span class="token punctuation">]</span> t2 <span class="token operator">=</span> text2<span class="token punctuation">.</span><span class="token function">toCharArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">int</span> length1 <span class="token operator">=</span> t1<span class="token punctuation">.</span>length<span class="token punctuation">;</span>        <span class="token keyword">int</span> length2 <span class="token operator">=</span> t2<span class="token punctuation">.</span>length<span class="token punctuation">;</span>        <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span> dp <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">int</span><span class="token punctuation">[</span>length1<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span>length2<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> length1 <span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> length2 <span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>t1<span class="token punctuation">[</span>i<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">==</span> t2<span class="token punctuation">[</span>j<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>                    <span class="token comment">// è¿™è¾¹æ‰¾åˆ°ä¸€ä¸ª lcs çš„å…ƒç´ ï¼Œç»§ç»­å¾€å‰æ‰¾</span>                    dp<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token operator">+</span> dp<span class="token punctuation">[</span>i<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>                <span class="token punctuation">&#125;</span><span class="token keyword">else</span> <span class="token punctuation">&#123;</span>                    <span class="token comment">//è°èƒ½è®© lcs æœ€é•¿ï¼Œå°±å¬è°çš„</span>                    dp<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span>dp<span class="token punctuation">[</span>i<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">,</span>dp<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">&#125;</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">return</span> dp<span class="token punctuation">[</span>length1<span class="token punctuation">]</span><span class="token punctuation">[</span>length2<span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> ç®—æ³• </category>
          
      </categories>
      
      
        <tags>
            
            <tag> LeetCode </tag>
            
            <tag> åŠ¨æ€è§„åˆ’ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ã€LeetCodeã€‘128. æœ€é•¿è¿ç»­åºåˆ—</title>
      <link href="/posts/377032133.html"/>
      <url>/posts/377032133.html</url>
      
        <content type="html"><![CDATA[<h1 id="1-é—®é¢˜"><a href="#1-é—®é¢˜" class="headerlink" title="1.é—®é¢˜"></a>1.é—®é¢˜</h1><p>ç»™å®šä¸€ä¸ªæœªæ’åºçš„æ•´æ•°æ•°ç»„ nums ï¼Œæ‰¾å‡ºæ•°å­—è¿ç»­çš„æœ€é•¿åºåˆ—ï¼ˆä¸è¦æ±‚åºåˆ—å…ƒç´ åœ¨åŸæ•°ç»„ä¸­è¿ç»­ï¼‰çš„é•¿åº¦ã€‚</p><p>è¯·ä½ è®¾è®¡å¹¶å®ç°æ—¶é—´å¤æ‚åº¦ä¸º O(n) çš„ç®—æ³•è§£å†³æ­¤é—®é¢˜ã€‚</p><h2 id="ç¤ºä¾‹-1"><a href="#ç¤ºä¾‹-1" class="headerlink" title="ç¤ºä¾‹ 1"></a>ç¤ºä¾‹ 1</h2><blockquote><p>è¾“å…¥ï¼šnums &#x3D; [100,4,200,1,3,2]<br>è¾“å‡ºï¼š4<br>è§£é‡Šï¼šæœ€é•¿æ•°å­—è¿ç»­åºåˆ—æ˜¯ [1, 2, 3, 4]ã€‚å®ƒçš„é•¿åº¦ä¸º 4ã€‚</p></blockquote><h2 id="ç¤ºä¾‹-2"><a href="#ç¤ºä¾‹-2" class="headerlink" title="ç¤ºä¾‹ 2"></a>ç¤ºä¾‹ 2</h2><blockquote><p>è¾“å…¥ï¼šnums &#x3D; [0,3,7,2,5,8,4,6,0,1]<br>è¾“å‡ºï¼š9</p></blockquote><p><strong>æç¤º</strong></p><ul><li>0 &lt;&#x3D; nums.length &lt;&#x3D; 105</li><li>-109 &lt;&#x3D; nums[i] &lt;&#x3D; 109</li></ul><h1 id="2-è§£é¢˜æ€è·¯"><a href="#2-è§£é¢˜æ€è·¯" class="headerlink" title="2.è§£é¢˜æ€è·¯"></a>2.è§£é¢˜æ€è·¯</h1><h2 id="2-1-å…ˆæ’åºåéå†å†åˆ¤æ–­"><a href="#2-1-å…ˆæ’åºåéå†å†åˆ¤æ–­" class="headerlink" title="2.1 å…ˆæ’åºåéå†å†åˆ¤æ–­"></a>2.1 å…ˆæ’åºåéå†å†åˆ¤æ–­</h2><p>å…ˆå¯¹æ•°ç»„è¿›è¡Œå‡åºæ’åˆ—ï¼Œåˆ™è‹¥å­˜åœ¨è¿ç»­åºåˆ—ï¼Œå½“éå†åˆ°æŸä¸€å€¼æ—¶ï¼Œå…¶å‰åä¹‹å·®åº”è¯¥ä¸º1ï¼Œåˆ™è¿›è¡Œæœ€é•¿åºåˆ—é•¿åº¦ç»Ÿè®¡ï¼›è‹¥ä¸ä¸º1ï¼Œå¦‚æœç›¸ç­‰ï¼Œåˆ™è·³è¿‡æ­¤å€¼ï¼Œè¿›è¡Œä¸‹ä¸€ä¸ªå¾ªç¯ï¼›å¦‚æœä¸ç­‰ï¼Œåˆ™ä¸è¿ç»­ï¼Œå½“å‰ç»Ÿè®¡çš„è¿ç»­åºåˆ—é•¿åº¦ç½®ä¸º1ã€‚è§æ–¹æ³•<code>longestConsecutive2</code>ã€‚<br>æ­¤æ–¹æ³•ï¼Œè™½ç„¶çœ‹ä¼¼æ—¶é—´å¤æ‚åº¦ä¸ºO(N)ï¼Œå…¶å®æ’åºå°±å ç”¨äº†è‡³å°‘O(N)ï¼Œè¿˜æ˜¯ä¸æ˜¯å¾ˆç†æƒ³çš„ç®—æ³•ã€‚</p><h2 id="2-2-å“ˆå¸Œè¡¨"><a href="#2-2-å“ˆå¸Œè¡¨" class="headerlink" title="2.2 å“ˆå¸Œè¡¨"></a>2.2 å“ˆå¸Œè¡¨</h2><p>å®šä¹‰ä¸€å“ˆå¸Œè¡¨ï¼Œkeyä¸ºæ•°ç»„ä¸­çš„å…ƒç´ ï¼Œvalueä¸ºå½“å‰å…ƒç´ æ‰€åœ¨è¿ç»­åºåˆ—çš„é•¿åº¦ã€‚<br>å¯¹äº<strong>ä¸å­˜åœ¨</strong>äºå“ˆå¸Œè¡¨ä¸­çš„å…ƒç´ ï¼š</p><ul><li>å–å‡ºå…¶å·¦å³ç›¸é‚»æ•°å·²æœ‰çš„è¿ç»­åŒºé—´é•¿åº¦ left å’Œ right</li><li>è®¡ç®—å½“å‰æ•°çš„åŒºé—´é•¿åº¦ä¸ºï¼š<code>cur_length = left + right + 1</code></li><li>æ ¹æ® cur_length æ›´æ–°æœ€å¤§é•¿åº¦ max_length çš„å€¼</li><li>æ›´æ–°åŒºé—´ä¸¤ç«¯ç‚¹çš„é•¿åº¦å€¼</li></ul><p>ä¾‹å¦‚ï¼Œkey &#x3D; 5ï¼Œ value &#x3D; 3ï¼Œæ„å‘³ç€å¯¹äº5æ¥è¯´ï¼Œæœ‰ä¸€ä¸ªé•¿åº¦ä¸º3çš„è¿ç»­åŒºé—´ï¼Œ5å±äºè¿™ä¸ªåŒºé—´(ä¸è¦çº ç»“5è¿™ä¸ªå…ƒç´ åˆ°åº•åœ¨è¯¥åŒºé—´çš„å“ªä¸ªä½ç½®) å…·ä½“æ¥è¯´ï¼Œè¿™ä¸ªè¿ç»­åŒºé—´å¯èƒ½æ˜¯[4, 6], [3, 5], [5,7]éƒ½æ˜¯æ»¡è¶³å®šä¹‰çš„ï¼Œå…·ä½“çœ‹numsé‡Œæœ‰å“ªäº›å…ƒç´ ã€‚</p><p>å¦‚æœå¯¹äºå…ƒç´  num&#x3D;5ï¼Œåœ¨åˆ¤æ–­ <code>!map.contains(num)</code> æ—¶ï¼Œå…¶ä¸å­˜åœ¨äºå“ˆå¸Œè¡¨ä¸­ï¼Œå³ç¬¬ä¸€æ¬¡éå†åˆ°5è¿™ä¸ªå…ƒç´ ï¼Œåˆ™å¯¹äºå¯èƒ½å­˜åœ¨çš„è¿ç»­åºåˆ—ï¼Œnum-1è‹¥å‡ºç°åœ¨åºåˆ—å½“ä¸­ï¼Œåˆ™å…¶èŒƒå›´åº”ä¸º<code>[num-value, num-1]</code>. æ¯”å¦‚ï¼šä¸Šè¿°å…ƒç´ 5ï¼Œåˆ™4æ‰€åœ¨èŒƒå›´åªèƒ½æ˜¯<code>[4-value, 4]</code>ï¼Œå¦‚æœä¸æ˜¯ï¼Œé‚£5å¿…åœ¨å…¶ä¸­ï¼Œä¸ç¬¦åˆæˆ‘ä»¬çš„å¾ªç¯æ¡ä»¶ã€‚è¿™é‡Œvalueè¡¨ç¤º4æ‰€å¯¹åº”çš„è¿ç»­åºåˆ—é•¿åº¦ã€‚</p><p>åŒæ ·é“ç†ï¼Œå¯¹äº6ï¼Œå…¶å‡ºç°çš„èŒƒå›´åªèƒ½æ˜¯<code>[6, 6+value]</code>ï¼›è¿™é‡Œvalueè¡¨ç¤º6æ‰€å¯¹åº”çš„è¿ç»­åºåˆ—é•¿åº¦ã€‚è¯¦è§ä»£ç ä¸­æ–¹æ³•<code>longestConsecutive</code>ã€‚</p><p>æ¥ç€éœ€è¦å°†ä¹‹å‰è®¡ç®—çš„åˆå¹¶é•¿åº¦è¿›è¡Œèµ‹å€¼ï¼Œå¹¶ä¸”åªè¦èµ‹å€¼ç»™ç«¯ç‚¹å°±è¡Œäº†ï¼Œè¿™æ˜¯å› ä¸ºæ•´ä¸ªå­åºåˆ— <code>[num-left, num+right]</code> ä¸­çš„å…ƒç´ éƒ½å·²ç»è¢«è®¿é—®è¿‡äº†æ‰€æœ‰çš„å€¼éƒ½å·²ç»å­˜å‚¨åˆ°äº†mapé‡Œé¢ï¼Œé‚£ä¹ˆå¦‚æœå…¶ä»–æ•°å­—æƒ³è¦é€šè¿‡è¿™ä¸ªåˆ¤æ–­ <code>!map.contains(num)</code> ï¼Œè¿™ä¸ªæ•°å­—åªå¯èƒ½åœ¨è¿™ä¸ªå­åºåˆ—çš„å·¦è¾¹æˆ–è€…å³è¾¹.</p><p>æˆ‘ä»¬è¿˜æ˜¯ä»¥å·¦è¾¹ä¸ºä¾‹ï¼Œå½“æˆ‘ä»¬æ”¾å…¥ç¬¬num-left-1ä¸ªæ•°å­—çš„æ—¶å€™å°±éœ€è¦çŸ¥é“æˆ‘ä»¬çš„å³è¾¹ç¬¬num-leftçš„å­åºåˆ—é•¿åº¦ï¼Œè€Œé€šè¿‡ä¹‹å‰çš„è®¡ç®— <code>map[num - left] = cur_length</code>æˆ‘ä»¬å¯ä»¥çŸ¥é“ç¬¬num-leftä¸ºå¼€å¤´çš„æœ€å¤§å­åºåˆ—é•¿åº¦ä¸ºcur_length, å¯ä»¥çœ‹å‡ºå·¦ç«¯ç‚¹ï¼ˆnum-leftï¼‰çš„å€¼åªæœ‰å…¶å·¦è¾¹çš„æ•°å­—ç”¨çš„ä¸Šï¼Œé‚£ä¹ˆä»–è‡ªå·±è‡ªç„¶åªéœ€è¦å­˜å³è¾¹çš„å­åºåˆ—é•¿åº¦å°±å¯ä»¥äº†ï¼Œå³è¾¹åŒç†ã€‚</p><h2 id="2-3-HashSet"><a href="#2-3-HashSet" class="headerlink" title="2.3 HashSet"></a>2.3 HashSet</h2><ul><li>é€šè¿‡HashSetå°†ä¸é‡å¤çš„å…ƒç´ å…¥åº“</li><li>éå†æ•°ç»„ï¼Œåˆ¤æ–­å½“å‰numå‡å»1çš„å…ƒç´ æ˜¯å¦å·²å­˜åœ¨ï¼š<ul><li>å¦‚æœä¸å­˜åœ¨ï¼Œå¹¶ä¸”num+å½“å‰è¿ç»­åºåˆ—æœ€å¤§é•¿åº¦çš„å€¼å­˜åœ¨äºHashSetä¸­ï¼Œç»Ÿè®¡è¿ç»­åºåˆ—é•¿åº¦</li><li>å¦åˆ™ï¼Œè·³è¿‡è¯¥å…ƒç´ ã€‚è¿™é‡Œå¾ªç¯çš„æ¡ä»¶ç›®çš„å°±æ˜¯æ‰¾åˆ°è¿ç»­åºåˆ—çš„èµ·å§‹å…ƒç´ ï¼Œæ‰¾åˆ°åï¼Œæ‰å¼€å§‹ç»Ÿè®¡æœ€å¤§çš„è¿ç»­åºåˆ—é•¿åº¦</li></ul></li></ul><p>è¯¦è§ä»£ç ä¸­æ–¹æ³•<code>longestConsecutive3</code>ã€‚ä¸è¿‡æ­¤ç®—æ³•ç”±äºç”¨åˆ°HashSetï¼Œå…¶æ—¶é—´å¤æ‚åº¦ä¸ç¬¦åˆé¢˜ç›®ä¸­æ‰€éœ€O(N)çš„æ¡ä»¶ã€‚</p><h1 id="3-ä»£ç "><a href="#3-ä»£ç " class="headerlink" title="3.ä»£ç "></a>3.ä»£ç </h1><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">class</span> <span class="token class-name">Solution</span> <span class="token punctuation">&#123;</span>    <span class="token comment">//1.å…ˆæ’åº</span>    <span class="token comment">//2.è¿ç»­åºåˆ—å·®å€¼ä¸º1ï¼Œç»Ÿè®¡è¿ç»­åºåˆ—é•¿åº¦</span>    <span class="token comment">//3.å¦åˆ™ï¼Œç›¸ç­‰çš„è¯ï¼Œç»§ç»­å¾ªç¯éå†ï¼›ä¸ç­‰ï¼Œé‡æ–°è®¡æ•°è¿ç»­åºåˆ—é•¿åº¦</span>    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">longestConsecutive2</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> nums<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token comment">//åˆ¤ç©º</span>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token operator">==</span>nums <span class="token operator">||</span> nums<span class="token punctuation">.</span>length<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token comment">//åªæœ‰ä¸€ä¸ª</span>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">==</span>nums<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token comment">//æ’åº</span>        <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span>nums<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">//ç»“æœ</span>        <span class="token keyword">int</span> maxLength<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>        <span class="token comment">//åˆå§‹æœ€é•¿è¿ç»­åºåˆ—é•¿åº¦</span>        <span class="token keyword">int</span> current<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>nums<span class="token punctuation">.</span>length<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            <span class="token comment">//æ˜¯å¦ç›¸å·®1</span>            <span class="token keyword">if</span><span class="token punctuation">(</span>nums<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">-</span>nums<span class="token punctuation">[</span>i<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">==</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>                current<span class="token operator">++</span><span class="token punctuation">;</span>                maxLength<span class="token operator">=</span><span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span>maxLength<span class="token punctuation">,</span> current<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>            <span class="token comment">//ç›¸ç­‰</span>            <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>nums<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">==</span>nums<span class="token punctuation">[</span>i<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>                <span class="token keyword">continue</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>            <span class="token comment">//ä¸ç­‰ï¼Œé‡æ–°ç»Ÿè®¡</span>            <span class="token keyword">else</span><span class="token punctuation">&#123;</span>                current<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">return</span> maxLength<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">longestConsecutive3</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> nums<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token comment">// éå†æ•°ç»„ï¼Œæ„é€ å“ˆå¸Œé›†åˆï¼Œå»é‡è®°å½•å‡ºç°è¿‡çš„æ•°å­—</span>        <span class="token class-name">HashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">></span></span> numSet <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> num <span class="token operator">:</span> nums<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            numSet<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>num<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">int</span> maxLength<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>        <span class="token keyword">int</span> currentLength<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> num <span class="token operator">:</span> nums<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            <span class="token comment">//å½“å‰æ•°å­—ä¸æ˜¯å…¶å¯èƒ½æ‰€åœ¨è¿ç»­åºåˆ—çš„æœ€å°å€¼ï¼Œåˆ™ç•¥è¿‡ï¼›å¦åˆ™å‘ä¸Šå¾ªç¯å¯»æ‰¾num+1ï¼Œè®°å½•é•¿åº¦</span>            <span class="token comment">//å¦‚æœå½“å‰num+å½“å‰æœ€å¤§é•¿åº¦ä¸åœ¨å“ˆå¸Œè¡¨é‡Œï¼Œé‚£è¿™æ¬¡å¾ªç¯å°±ä¸ç”¨çœ‹äº†</span>            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>numSet<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>num<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> numSet<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>num<span class="token operator">+</span>maxLength<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>                currentLength<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>                <span class="token keyword">while</span><span class="token punctuation">(</span>numSet<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>num<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>                    currentLength<span class="token operator">++</span><span class="token punctuation">;</span>                    num<span class="token operator">++</span><span class="token punctuation">;</span>                <span class="token punctuation">&#125;</span>                <span class="token keyword">if</span><span class="token punctuation">(</span>currentLength<span class="token operator">></span>maxLength<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>                    maxLength<span class="token operator">=</span>currentLength<span class="token punctuation">;</span>                <span class="token punctuation">&#125;</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">return</span> maxLength<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">longestConsecutive</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> nums<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token comment">//å®šä¹‰mapä¸ºnumåŠå…¶æ‰€åœ¨è¿ç»­åºåˆ—çš„é•¿åº¦</span>        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">></span></span> map<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">int</span> left<span class="token punctuation">;</span>        <span class="token keyword">int</span> right<span class="token punctuation">;</span>        <span class="token keyword">int</span> currentLength<span class="token punctuation">;</span>        <span class="token keyword">int</span> maxLength<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> num <span class="token operator">:</span> nums<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            <span class="token comment">//ä¸åŒ…å«num</span>            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>map<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>num<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>                <span class="token comment">//å¯¹äºç¬¬ä¸€æ¬¡å‡ºç°çš„num, num-1å‡ºç°çš„èŒƒå›´åªèƒ½æ˜¯[num-left, num-1]</span>                left<span class="token operator">=</span>map<span class="token punctuation">.</span><span class="token function">getOrDefault</span><span class="token punctuation">(</span>num<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment">//num+1å‡ºç°çš„èŒƒå›´åªèƒ½æ˜¯[num+1, num+right]</span>                right<span class="token operator">=</span>map<span class="token punctuation">.</span><span class="token function">getOrDefault</span><span class="token punctuation">(</span>num<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                currentLength<span class="token operator">=</span>left<span class="token operator">+</span>right<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">;</span>                <span class="token keyword">if</span><span class="token punctuation">(</span>currentLength<span class="token operator">></span>maxLength<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>                    maxLength<span class="token operator">=</span>currentLength<span class="token punctuation">;</span>                <span class="token punctuation">&#125;</span>                <span class="token comment">//æ—è¾¹çš„ä¸¤ä¸ªæ•° æˆ‘å·²ç»ç›¸å‘Šäº†ï¼Œè¿™é‡Œå¯¹numä¿å­˜çš„å€¼ä¸é‡è¦</span>                map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>num<span class="token punctuation">,</span> currentLength<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment">//å‘Šè¯‰å·¦è¾¹çš„æ•°å­—æˆ‘çš„å³è¾¹è¿ç»­å­åºåˆ—é•¿åº¦æ˜¯curLengthï¼ˆæˆ–è€…è¯´åªæœ‰ä»–å·¦è¾¹çš„æ•°å­—éœ€è¦ä»–ï¼‰</span>                map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>num<span class="token operator">-</span>left<span class="token punctuation">,</span> currentLength<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment">//å‘Šè¯‰å³è¾¹çš„æ•°å­—æˆ‘çš„å·¦è¾¹è¿ç»­å­åºåˆ—é•¿åº¦æ˜¯cur_length</span>                map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>num<span class="token operator">+</span>right<span class="token punctuation">,</span> currentLength<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">return</span> maxLength<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> ç®—æ³• </category>
          
      </categories>
      
      
        <tags>
            
            <tag> LeetCode </tag>
            
            <tag> ç®—æ³• </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ã€LeetCodeã€‘654. æœ€å¤§äºŒå‰æ ‘</title>
      <link href="/posts/155957645.html"/>
      <url>/posts/155957645.html</url>
      
        <content type="html"><![CDATA[<h1 id="1-é—®é¢˜"><a href="#1-é—®é¢˜" class="headerlink" title="1.é—®é¢˜"></a>1.é—®é¢˜</h1><p>ç»™å®šä¸€ä¸ªä¸é‡å¤çš„æ•´æ•°æ•°ç»„ nums ã€‚ æœ€å¤§äºŒå‰æ ‘ å¯ä»¥ç”¨ä¸‹é¢çš„ç®—æ³•ä» nums é€’å½’åœ°æ„å»º:</p><p>åˆ›å»ºä¸€ä¸ªæ ¹èŠ‚ç‚¹ï¼Œå…¶å€¼ä¸º nums ä¸­çš„æœ€å¤§å€¼ã€‚<br>é€’å½’åœ°åœ¨æœ€å¤§å€¼ å·¦è¾¹ çš„ å­æ•°ç»„å‰ç¼€ä¸Š æ„å»ºå·¦å­æ ‘ã€‚<br>é€’å½’åœ°åœ¨æœ€å¤§å€¼ å³è¾¹ çš„ å­æ•°ç»„åç¼€ä¸Š æ„å»ºå³å­æ ‘ã€‚<br>è¿”å› nums æ„å»ºçš„ æœ€å¤§äºŒå‰æ ‘ ã€‚</p><h2 id="ç¤ºä¾‹-1"><a href="#ç¤ºä¾‹-1" class="headerlink" title="ç¤ºä¾‹ 1"></a>ç¤ºä¾‹ 1</h2><p><img src="https://cdn.jsdelivr.net/gh/zyxelva/picgo@main/csdn/ae293e027bca4824803a7a13ed651f0c.png"></p><blockquote><p>è¾“å…¥ï¼šnums &#x3D; [3,2,1,6,0,5]<br>è¾“å‡ºï¼š[6,3,5,null,2,0,null,null,1] è§£é‡Šï¼šé€’å½’è°ƒç”¨å¦‚ä¸‹æ‰€ç¤ºï¼š</p><ul><li>[3,2,1,6,0,5] ä¸­çš„æœ€å¤§å€¼æ˜¯ 6 ï¼Œå·¦è¾¹éƒ¨åˆ†æ˜¯ [3,2,1] ï¼Œå³è¾¹éƒ¨åˆ†æ˜¯ [0,5] ã€‚<ul><li>[3,2,1] ä¸­çš„æœ€å¤§å€¼æ˜¯ 3 ï¼Œå·¦è¾¹éƒ¨åˆ†æ˜¯ [] ï¼Œå³è¾¹éƒ¨åˆ†æ˜¯ [2,1] ã€‚<ul><li>ç©ºæ•°ç»„ï¼Œæ— å­èŠ‚ç‚¹ã€‚</li><li>[2,1] ä¸­çš„æœ€å¤§å€¼æ˜¯ 2 ï¼Œå·¦è¾¹éƒ¨åˆ†æ˜¯ [] ï¼Œå³è¾¹éƒ¨åˆ†æ˜¯ [1] ã€‚<ul><li>ç©ºæ•°ç»„ï¼Œæ— å­èŠ‚ç‚¹ã€‚</li><li>åªæœ‰ä¸€ä¸ªå…ƒç´ ï¼Œæ‰€ä»¥å­èŠ‚ç‚¹æ˜¯ä¸€ä¸ªå€¼ä¸º 1 çš„èŠ‚ç‚¹ã€‚</li></ul></li></ul></li><li>[0,5] ä¸­çš„æœ€å¤§å€¼æ˜¯ 5 ï¼Œå·¦è¾¹éƒ¨åˆ†æ˜¯ [0] ï¼Œå³è¾¹éƒ¨åˆ†æ˜¯ [] ã€‚<ul><li>åªæœ‰ä¸€ä¸ªå…ƒç´ ï¼Œæ‰€ä»¥å­èŠ‚ç‚¹æ˜¯ä¸€ä¸ªå€¼ä¸º 0 çš„èŠ‚ç‚¹ã€‚</li><li>ç©ºæ•°ç»„ï¼Œæ— å­èŠ‚ç‚¹ã€‚</li></ul></li></ul></li></ul></blockquote><h2 id="ç¤ºä¾‹-2"><a href="#ç¤ºä¾‹-2" class="headerlink" title="ç¤ºä¾‹ 2"></a>ç¤ºä¾‹ 2</h2><blockquote><p>è¾“å…¥ï¼šnums &#x3D; [3,2,1]<br>è¾“å‡ºï¼š[3,null,2,null,1]</p></blockquote><p><strong>æç¤º</strong>ï¼š</p><ul><li>1 &lt;&#x3D; nums.length &lt;&#x3D; 1000</li><li>0 &lt;&#x3D; nums[i] &lt;&#x3D; 1000</li><li>nums ä¸­çš„æ‰€æœ‰æ•´æ•° äº’ä¸ç›¸åŒ</li></ul><h1 id="2-è§£é¢˜æ€è·¯"><a href="#2-è§£é¢˜æ€è·¯" class="headerlink" title="2.è§£é¢˜æ€è·¯"></a>2.è§£é¢˜æ€è·¯</h1><h2 id="2-1-é€’å½’"><a href="#2-1-é€’å½’" class="headerlink" title="2.1 é€’å½’"></a>2.1 é€’å½’</h2><ul><li>ç¡®å®šæœ€å¤§å€¼ä½ç½®ï¼Œå‡å®šä¸º index</li><li>æ„é€ èŠ‚ç‚¹rootï¼Œåˆ™root.leftå¯ä»¥é€’å½’æ„é€ ï¼ŒèŒƒå›´ä¸º[start, index-1]</li><li>root.righté€’å½’æ„é€ ï¼ŒèŒƒå›´ä¸º[index+1, end]</li><li>ç»ˆæ­¢æ¡ä»¶ start&gt;end</li></ul><p>è¯¦è§ä»£ç ã€‚</p><h2 id="2-2-å•è°ƒæ ˆ"><a href="#2-2-å•è°ƒæ ˆ" class="headerlink" title="2.2 å•è°ƒæ ˆ"></a>2.2 å•è°ƒæ ˆ</h2><p>ä»¥ [3,2,1,6,0,5] ä¸ºä¾‹ï¼š</p><ul><li>æ„é€ èŠ‚ç‚¹ 3ï¼Œå…¥æ ˆï¼›</li><li>æ„é€ èŠ‚ç‚¹ 2ï¼Œå®ƒæ¯”æ ˆé¡¶å…ƒç´  3 å°ï¼Œæ‰€ä»¥ï¼Œå®ƒæ˜¯ 3 çš„å³å­èŠ‚ç‚¹ï¼Œç›´æ¥å…¥æ ˆï¼›</li><li>æ„é€ èŠ‚ç‚¹ 1ï¼Œå®ƒæ¯”æ ˆé¡¶å…ƒç´  2 å°ï¼Œæ‰€ä»¥ï¼Œå®ƒæ˜¯ 2 çš„å³å­èŠ‚ç‚¹ï¼Œç›´æ¥å…¥æ ˆï¼›</li><li>æ„é€ èŠ‚ç‚¹ 6ï¼Œå®ƒæ¯”æ ˆé¡¶å…ƒç´  1 å¤§ï¼Œæ‰€ä»¥ï¼Œ1 æ˜¯å®ƒçš„å·¦å­èŠ‚ç‚¹ï¼Œå¼¹å‡º 1ï¼›åŒæ ·åœ°ï¼Œæ ˆ- é¡¶å…ƒç´  2 ä¹Ÿæ¯”å®ƒå°ï¼Œå¼¹å‡º 2 å¹¶åšä¸ºå®ƒçš„å·¦å­èŠ‚ç‚¹ï¼›æŠŠæ ˆé¡¶æ‰€æœ‰æ¯”å®ƒå°çš„å…ƒç´ éƒ½å¼¹å‡ºï¼Œæœ€åå¼¹å‡ºçš„æ˜¯ 3ï¼Œæ‰€ä»¥ï¼Œæœ€ç»ˆæ˜¯ 3 åšä¸º 6 çš„å·¦å­èŠ‚ç‚¹ï¼Œå¹¶æŠŠ 6 å…¥æ ˆï¼›</li><li>æ„é€ èŠ‚ç‚¹ 0ï¼Œå®ƒæ¯”æ ˆé¡¶å…ƒç´  6 å°ï¼Œæ‰€ä»¥ï¼Œå®ƒæ˜¯ 6 çš„å³å­èŠ‚ç‚¹ï¼Œç›´æ¥å…¥æ ˆï¼›</li><li>æ„é€ èŠ‚ç‚¹ 5ï¼Œå®ƒæ¯”æ ˆé¡¶å…ƒç´  0 å¤§ï¼Œæ‰€ä»¥ï¼Œ0 æ˜¯å®ƒçš„å·¦å­èŠ‚ç‚¹ï¼Œå¼¹å‡º 0ï¼›æ¥ç€æ¯”è¾ƒï¼Œå®ƒæ¯”æ ˆé¡¶å…ƒç´  6 å°ï¼Œæ‰€ä»¥ï¼Œå®ƒæ˜¯ 6 çš„å³å­èŠ‚ç‚¹ï¼Œå…¥æ ˆï¼›</li><li>æœ€åï¼Œæ ˆä¸­å…ƒç´ ä¸º [6,5]ï¼Œæ ˆåº•å…ƒç´ ä¸º 6ï¼Œæ˜¯æœ€ç»ˆçš„æ ¹èŠ‚ç‚¹ï¼›</li></ul><p>åŠ¨æ€å›¾æœ€ç›´è§‚ï¼Œå¯å‚è§<a href="https://b23.tv/ktZRYxI">Bç«™å¤§ç¥å½•åˆ¶çš„è§†é¢‘</a>ã€‚</p><h1 id="3-ä»£ç "><a href="#3-ä»£ç " class="headerlink" title="3.ä»£ç "></a>3.ä»£ç </h1><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/** * Definition for a binary tree node. * public class TreeNode &#123; *     int val; *     TreeNode left; *     TreeNode right; *     TreeNode() &#123;&#125; *     TreeNode(int val) &#123; this.val = val; &#125; *     TreeNode(int val, TreeNode left, TreeNode right) &#123; *         this.val = val; *         this.left = left; *         this.right = right; *     &#125; * &#125; */</span><span class="token keyword">class</span> <span class="token class-name">Solution</span> <span class="token punctuation">&#123;</span>    <span class="token comment">//é€’å½’æ„é€ </span>    <span class="token keyword">public</span> <span class="token class-name">TreeNode</span> <span class="token function">constructMaximumBinaryTree</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> nums<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">return</span> <span class="token function">build</span><span class="token punctuation">(</span>nums<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> nums<span class="token punctuation">.</span>length<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">private</span> <span class="token class-name">TreeNode</span> <span class="token function">build</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> nums<span class="token punctuation">,</span> <span class="token keyword">int</span> start<span class="token punctuation">,</span> <span class="token keyword">int</span> end<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>end<span class="token operator">&lt;</span>start<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token comment">//1.æ‰¾åˆ°æœ€å¤§å€¼</span>        <span class="token keyword">int</span> max<span class="token operator">=</span><span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token constant">MIN_VALUE</span><span class="token punctuation">;</span>        <span class="token comment">//æœ€å¤§å€¼ç´¢å¼•</span>        <span class="token keyword">int</span> index<span class="token operator">=</span>start<span class="token punctuation">;</span>        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span>start<span class="token punctuation">;</span>i<span class="token operator">&lt;=</span>end<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            <span class="token keyword">if</span><span class="token punctuation">(</span>max<span class="token operator">&lt;</span>nums<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>                max<span class="token operator">=</span>nums<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>                index<span class="token operator">=</span>i<span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>        <span class="token comment">//2.æ„é€ èŠ‚ç‚¹</span>        <span class="token class-name">TreeNode</span> root<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">TreeNode</span><span class="token punctuation">(</span>max<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">//3.å·¦å­æ ‘</span>        root<span class="token punctuation">.</span>left<span class="token operator">=</span><span class="token function">build</span><span class="token punctuation">(</span>nums<span class="token punctuation">,</span> start<span class="token punctuation">,</span> index<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">//4.å³å­æ ‘</span>        root<span class="token punctuation">.</span>right<span class="token operator">=</span><span class="token function">build</span><span class="token punctuation">(</span>nums<span class="token punctuation">,</span> index<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span> end<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> root<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">//å•è°ƒæ ˆ</span>    <span class="token keyword">public</span> <span class="token class-name">TreeNode</span> <span class="token function">constructMaximumBinaryTree2</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> nums<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token comment">//å•è°ƒæ ˆ</span>        <span class="token class-name">Deque</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TreeNode</span><span class="token punctuation">></span></span> stack<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">ArrayDeque</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">//éå†</span>        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> num<span class="token operator">:</span> nums<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            <span class="token comment">//æ„é€ èŠ‚ç‚¹</span>            <span class="token class-name">TreeNode</span> root<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">TreeNode</span><span class="token punctuation">(</span>num<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment">//æ¯”è¾ƒå½“å‰æ ˆé¡¶å…ƒç´ ï¼Œè‹¥å¤§äºnumï¼Œåˆ™å…¶ä¸ºæ ˆé¡¶å…ƒç´ çš„å³èŠ‚ç‚¹ï¼›</span>            <span class="token comment">//å¦åˆ™ï¼Œéå†åˆ°æ ˆåº•ï¼Œå°†æ ˆåº•èŠ‚ç‚¹ç½®ä¸ºrootçš„å·¦èŠ‚ç‚¹</span>            <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token operator">!</span>stack<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> num<span class="token operator">></span>stack<span class="token punctuation">.</span><span class="token function">peek</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>val<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>                root<span class="token punctuation">.</span>left<span class="token operator">=</span>stack<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>            <span class="token comment">//æ¯”æ ˆé¡¶å…ƒç´ å°çš„æƒ…å†µ</span>            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>stack<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>                stack<span class="token punctuation">.</span><span class="token function">peek</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>right<span class="token operator">=</span>root<span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>            <span class="token comment">//å…¥æ ˆ</span>            stack<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">return</span> stack<span class="token punctuation">.</span><span class="token function">peekLast</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> ç®—æ³• </category>
          
      </categories>
      
      
        <tags>
            
            <tag> LeetCode </tag>
            
            <tag> ç®—æ³• </tag>
            
            <tag> äºŒå‰æ ‘ </tag>
            
            <tag> æ•°æ®ç»“æ„ </tag>
            
            <tag> Java </tag>
            
            <tag> DFS </tag>
            
            <tag> å•è°ƒæ ˆ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ã€LeetCodeã€‘617. åˆå¹¶äºŒå‰æ ‘</title>
      <link href="/posts/3323994670.html"/>
      <url>/posts/3323994670.html</url>
      
        <content type="html"><![CDATA[<h1 id="1-é—®é¢˜"><a href="#1-é—®é¢˜" class="headerlink" title="1.é—®é¢˜"></a>1.é—®é¢˜</h1><p>ç»™ä½ ä¸¤æ£µäºŒå‰æ ‘ï¼š root1 å’Œ root2 ã€‚</p><p>æƒ³è±¡ä¸€ä¸‹ï¼Œå½“ä½ å°†å…¶ä¸­ä¸€æ£µè¦†ç›–åˆ°å¦ä¸€æ£µä¹‹ä¸Šæ—¶ï¼Œä¸¤æ£µæ ‘ä¸Šçš„ä¸€äº›èŠ‚ç‚¹å°†ä¼šé‡å ï¼ˆè€Œå¦ä¸€äº›ä¸ä¼šï¼‰ã€‚ä½ éœ€è¦å°†è¿™ä¸¤æ£µæ ‘åˆå¹¶æˆä¸€æ£µæ–°äºŒå‰æ ‘ã€‚åˆå¹¶çš„è§„åˆ™æ˜¯ï¼šå¦‚æœä¸¤ä¸ªèŠ‚ç‚¹é‡å ï¼Œé‚£ä¹ˆå°†è¿™ä¸¤ä¸ªèŠ‚ç‚¹çš„å€¼ç›¸åŠ ä½œä¸ºåˆå¹¶åèŠ‚ç‚¹çš„æ–°å€¼ï¼›å¦åˆ™ï¼Œä¸ä¸º null çš„èŠ‚ç‚¹å°†ç›´æ¥ä½œä¸ºæ–°äºŒå‰æ ‘çš„èŠ‚ç‚¹ã€‚</p><p>è¿”å›åˆå¹¶åçš„äºŒå‰æ ‘ã€‚</p><p>æ³¨æ„: åˆå¹¶è¿‡ç¨‹å¿…é¡»ä»ä¸¤ä¸ªæ ‘çš„æ ¹èŠ‚ç‚¹å¼€å§‹ã€‚</p><h2 id="ç¤ºä¾‹-1"><a href="#ç¤ºä¾‹-1" class="headerlink" title="ç¤ºä¾‹ 1"></a>ç¤ºä¾‹ 1</h2><p><img src="https://cdn.jsdelivr.net/gh/zyxelva/picgo@main/csdn/52418450d1a841768df44b5951166bcc.png"></p><blockquote><p>è¾“å…¥ï¼šroot1 &#x3D; [1,3,2,5], root2 &#x3D; [2,1,3,null,4,null,7]<br>è¾“å‡ºï¼š[3,4,5,5,4,null,7]</p></blockquote><h2 id="ç¤ºä¾‹-2"><a href="#ç¤ºä¾‹-2" class="headerlink" title="ç¤ºä¾‹ 2"></a>ç¤ºä¾‹ 2</h2><blockquote><p>è¾“å…¥ï¼šroot1 &#x3D; [1], root2 &#x3D; [1,2]<br>è¾“å‡ºï¼š[2,2]</p></blockquote><p><strong>æç¤º</strong>ï¼š</p><ul><li>ä¸¤æ£µæ ‘ä¸­çš„èŠ‚ç‚¹æ•°ç›®åœ¨èŒƒå›´ [0, 2000] å†…</li><li>-104 &lt;&#x3D; Node.val &lt;&#x3D; 104</li></ul><h1 id="2-è§£é¢˜æ€è·¯"><a href="#2-è§£é¢˜æ€è·¯" class="headerlink" title="2.è§£é¢˜æ€è·¯"></a>2.è§£é¢˜æ€è·¯</h1><h2 id="2-1-é€’å½’"><a href="#2-1-é€’å½’" class="headerlink" title="2.1 é€’å½’"></a>2.1 é€’å½’</h2><p>é‡‡ç”¨å‰åºéå†æ–¹å¼ï¼Œéå†ä¸¤é¢—æ ‘ï¼Œå¯¹äºå•ä¸ªèŠ‚ç‚¹ï¼Œå­˜åœ¨ä»¥ä¸‹ä¸‰ç§æƒ…å†µè¿›è¡Œåˆå¹¶å¤„ç†ï¼š</p><ul><li>å¦‚æœä¸¤ä¸ªäºŒå‰æ ‘çš„å¯¹åº”èŠ‚ç‚¹éƒ½ä¸ºç©ºï¼Œåˆ™åˆå¹¶åçš„äºŒå‰æ ‘çš„å¯¹åº”èŠ‚ç‚¹ä¹Ÿä¸ºç©ºï¼›</li><li>å¦‚æœä¸¤ä¸ªäºŒå‰æ ‘çš„å¯¹åº”èŠ‚ç‚¹åªæœ‰ä¸€ä¸ªä¸ºç©ºï¼Œåˆ™åˆå¹¶åçš„äºŒå‰æ ‘çš„å¯¹åº”èŠ‚ç‚¹ä¸ºå…¶ä¸­çš„éç©ºèŠ‚ç‚¹ï¼›</li><li>å¦‚æœä¸¤ä¸ªäºŒå‰æ ‘çš„å¯¹åº”èŠ‚ç‚¹éƒ½ä¸ä¸ºç©ºï¼Œåˆ™åˆå¹¶åçš„äºŒå‰æ ‘çš„å¯¹åº”èŠ‚ç‚¹çš„å€¼ä¸ºä¸¤ä¸ªäºŒå‰æ ‘çš„å¯¹åº”èŠ‚ç‚¹çš„å€¼ä¹‹å’Œï¼Œæ­¤æ—¶éœ€è¦æ˜¾æ€§åˆå¹¶ä¸¤ä¸ªèŠ‚ç‚¹</li></ul><p>å¤„ç†å®Œå•ä¸ªèŠ‚ç‚¹åï¼Œè¿˜è¦å¯¹èŠ‚ç‚¹çš„å·¦å³å­æ ‘è¿›è¡Œå¤„ç†ï¼Œå› è€Œé€’å½’ã€‚å¯ä»¥æ‹¿root1ä¸ºä¸»å¹²ã€‚å‚è€ƒä»£ç ä¸­é€’å½’ç®—æ³•çš„å®ç°ã€‚</p><p>å¤æ‚åº¦ï¼š</p><ul><li>æ—¶é—´å¤æ‚åº¦ï¼šO(N)</li><li>ç©ºé—´å¤æ‚åº¦ï¼šO(h)ï¼Œh æ˜¯æ ‘çš„é«˜åº¦</li></ul><h2 id="2-2-è¿­ä»£"><a href="#2-2-è¿­ä»£" class="headerlink" title="2.2 è¿­ä»£"></a>2.2 è¿­ä»£</h2><p>è¿˜æ˜¯ä»¥root1ä¸ºä¸»å¹²è¿›è¡Œåˆå¹¶ï¼Œåˆ©ç”¨å±‚æ¬¡éå†çš„æ–¹æ³•ï¼Œå¯¹äºåŒæ—¶éç©ºçš„å·¦èŠ‚ç‚¹æˆ–å³èŠ‚ç‚¹è¿›è¡Œåˆå¹¶ï¼Œè‹¥root1çš„leftä¸ºç©ºï¼Œåˆ™å°†root2.leftèµ‹å€¼ç»™root1.leftï¼›åŒç†ï¼Œè‹¥root1.rightä¸ºç©ºï¼Œåˆ™å°†root2.rightèµ‹å€¼ç»™å®ƒã€‚</p><p>å¤æ‚åº¦ï¼š</p><ul><li>æ—¶é—´å¤æ‚åº¦ï¼šO(N)</li><li>ç©ºé—´å¤æ‚åº¦ï¼šO(N)ï¼Œå¯¹äºæ»¡äºŒå‰æ ‘æ—¶ï¼Œè¦ä¿å­˜æ‰€æœ‰çš„å¶å­èŠ‚ç‚¹ï¼Œå³ N&#x2F;2 ä¸ªèŠ‚ç‚¹ã€‚</li></ul><h1 id="3-ä»£ç "><a href="#3-ä»£ç " class="headerlink" title="3.ä»£ç "></a>3.ä»£ç </h1><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/** * Definition for a binary tree node. * public class TreeNode &#123; *     int val; *     TreeNode left; *     TreeNode right; *     TreeNode() &#123;&#125; *     TreeNode(int val) &#123; this.val = val; &#125; *     TreeNode(int val, TreeNode left, TreeNode right) &#123; *         this.val = val; *         this.left = left; *         this.right = right; *     &#125; * &#125; */</span><span class="token keyword">class</span> <span class="token class-name">Solution</span> <span class="token punctuation">&#123;</span><span class="token comment">//é€’å½’è§£æ³•ï¼ˆDFSï¼‰</span>    <span class="token keyword">public</span> <span class="token class-name">TreeNode</span> <span class="token function">mergeTrees</span><span class="token punctuation">(</span><span class="token class-name">TreeNode</span> root1<span class="token punctuation">,</span> <span class="token class-name">TreeNode</span> root2<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token comment">//ç©ºèŠ‚ç‚¹å¤„ç†</span>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token operator">==</span>root1 <span class="token operator">||</span> <span class="token keyword">null</span><span class="token operator">==</span> root2<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token operator">!=</span>root2<span class="token operator">?</span>root2<span class="token operator">:</span>root1<span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        root1<span class="token punctuation">.</span>val<span class="token operator">+=</span>root2<span class="token punctuation">.</span>val<span class="token punctuation">;</span>        root1<span class="token punctuation">.</span>left<span class="token operator">=</span><span class="token function">mergeTrees</span><span class="token punctuation">(</span>root1<span class="token punctuation">.</span>left<span class="token punctuation">,</span> root2<span class="token punctuation">.</span>left<span class="token punctuation">)</span><span class="token punctuation">;</span>        root1<span class="token punctuation">.</span>right<span class="token operator">=</span><span class="token function">mergeTrees</span><span class="token punctuation">(</span>root1<span class="token punctuation">.</span>right<span class="token punctuation">,</span> root2<span class="token punctuation">.</span>right<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> root1<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token comment">//è¿­ä»£ï¼ˆBFSï¼‰</span><span class="token keyword">public</span> <span class="token class-name">TreeNode</span> <span class="token function">mergeTrees</span><span class="token punctuation">(</span><span class="token class-name">TreeNode</span> t1<span class="token punctuation">,</span> <span class="token class-name">TreeNode</span> t2<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">//å¦‚æœ t1å’Œt2ä¸­ï¼Œåªè¦æœ‰ä¸€ä¸ªæ˜¯nullï¼Œå‡½æ•°å°±ç›´æ¥è¿”å›</span><span class="token keyword">if</span><span class="token punctuation">(</span>t1<span class="token operator">==</span><span class="token keyword">null</span> <span class="token operator">||</span> t2<span class="token operator">==</span><span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">return</span> t1<span class="token operator">==</span><span class="token keyword">null</span><span class="token operator">?</span> t2 <span class="token operator">:</span> t1<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token class-name">Queue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TreeNode</span><span class="token punctuation">></span></span> queue <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TreeNode</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>queue<span class="token punctuation">.</span><span class="token function">offer</span><span class="token punctuation">(</span>t1<span class="token punctuation">)</span><span class="token punctuation">;</span>queue<span class="token punctuation">.</span><span class="token function">offer</span><span class="token punctuation">(</span>t2<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">while</span><span class="token punctuation">(</span>queue<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">></span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token class-name">TreeNode</span> r1 <span class="token operator">=</span> queue<span class="token punctuation">.</span><span class="token function">poll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">TreeNode</span> r2 <span class="token operator">=</span> queue<span class="token punctuation">.</span><span class="token function">poll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>r1<span class="token punctuation">.</span>val <span class="token operator">+=</span> r2<span class="token punctuation">.</span>val<span class="token punctuation">;</span><span class="token comment">//å¦‚æœr1å’Œr2çš„å·¦å­æ ‘éƒ½ä¸ä¸ºç©ºï¼Œå°±æ”¾åˆ°é˜Ÿåˆ—ä¸­</span><span class="token comment">//å¦‚æœr1çš„å·¦å­æ ‘ä¸ºç©ºï¼Œå°±æŠŠr2çš„å·¦å­æ ‘æŒ‚åˆ°r1çš„å·¦å­æ ‘ä¸Š</span><span class="token keyword">if</span><span class="token punctuation">(</span>r1<span class="token punctuation">.</span>left<span class="token operator">!=</span><span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> r2<span class="token punctuation">.</span>left<span class="token operator">!=</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>queue<span class="token punctuation">.</span><span class="token function">offer</span><span class="token punctuation">(</span>r1<span class="token punctuation">.</span>left<span class="token punctuation">)</span><span class="token punctuation">;</span>queue<span class="token punctuation">.</span><span class="token function">offer</span><span class="token punctuation">(</span>r2<span class="token punctuation">.</span>left<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>r1<span class="token punctuation">.</span>left<span class="token operator">==</span><span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>r1<span class="token punctuation">.</span>left <span class="token operator">=</span> r2<span class="token punctuation">.</span>left<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">//å¯¹äºå³å­æ ‘ä¹Ÿæ˜¯ä¸€æ ·çš„</span><span class="token keyword">if</span><span class="token punctuation">(</span>r1<span class="token punctuation">.</span>right<span class="token operator">!=</span><span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> r2<span class="token punctuation">.</span>right<span class="token operator">!=</span><span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>queue<span class="token punctuation">.</span><span class="token function">offer</span><span class="token punctuation">(</span>r1<span class="token punctuation">.</span>right<span class="token punctuation">)</span><span class="token punctuation">;</span>queue<span class="token punctuation">.</span><span class="token function">offer</span><span class="token punctuation">(</span>r2<span class="token punctuation">.</span>right<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>r1<span class="token punctuation">.</span>right<span class="token operator">==</span><span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>r1<span class="token punctuation">.</span>right <span class="token operator">=</span> r2<span class="token punctuation">.</span>right<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">return</span> t1<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> ç®—æ³• </category>
          
      </categories>
      
      
        <tags>
            
            <tag> LeetCode </tag>
            
            <tag> ç®—æ³• </tag>
            
            <tag> äºŒå‰æ ‘ </tag>
            
            <tag> æ•°æ®ç»“æ„ </tag>
            
            <tag> Java </tag>
            
            <tag> DFS </tag>
            
            <tag> BFS </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ã€LeetCodeã€‘235. äºŒå‰æœç´¢æ ‘çš„æœ€è¿‘å…¬å…±ç¥–å…ˆ</title>
      <link href="/posts/1796339359.html"/>
      <url>/posts/1796339359.html</url>
      
        <content type="html"><![CDATA[<h1 id="1-é—®é¢˜"><a href="#1-é—®é¢˜" class="headerlink" title="1. é—®é¢˜"></a>1. é—®é¢˜</h1><p>ç»™å®šä¸€ä¸ªäºŒå‰æœç´¢æ ‘, æ‰¾åˆ°è¯¥æ ‘ä¸­ä¸¤ä¸ªæŒ‡å®šèŠ‚ç‚¹çš„æœ€è¿‘å…¬å…±ç¥–å…ˆã€‚</p><p>ç™¾åº¦ç™¾ç§‘ä¸­æœ€è¿‘å…¬å…±ç¥–å…ˆçš„å®šä¹‰ä¸ºï¼šâ€œå¯¹äºæœ‰æ ¹æ ‘ T çš„ä¸¤ä¸ªç»“ç‚¹ pã€qï¼Œæœ€è¿‘å…¬å…±ç¥–å…ˆè¡¨ç¤ºä¸ºä¸€ä¸ªç»“ç‚¹ xï¼Œæ»¡è¶³ x æ˜¯ pã€q çš„ç¥–å…ˆä¸” x çš„æ·±åº¦å°½å¯èƒ½å¤§ï¼ˆä¸€ä¸ªèŠ‚ç‚¹ä¹Ÿå¯ä»¥æ˜¯å®ƒè‡ªå·±çš„ç¥–å…ˆï¼‰ã€‚â€</p><p>ä¾‹å¦‚ï¼Œç»™å®šå¦‚ä¸‹äºŒå‰æœç´¢æ ‘:  root &#x3D; [6,2,8,0,4,7,9,null,null,3,5]</p><p><img src="https://cdn.jsdelivr.net/gh/zyxelva/picgo@main/csdn/a49aa758be9b4857af28475131075783.png"></p><h2 id="ç¤ºä¾‹-1"><a href="#ç¤ºä¾‹-1" class="headerlink" title="ç¤ºä¾‹ 1"></a>ç¤ºä¾‹ 1</h2><blockquote><p>è¾“å…¥: root &#x3D; [6,2,8,0,4,7,9,null,null,3,5], p &#x3D; 2, q &#x3D; 8<br>è¾“å‡º: 6<br>è§£é‡Š: èŠ‚ç‚¹ 2 å’ŒèŠ‚ç‚¹ 8 çš„æœ€è¿‘å…¬å…±ç¥–å…ˆæ˜¯ 6ã€‚</p></blockquote><h2 id="ç¤ºä¾‹-2"><a href="#ç¤ºä¾‹-2" class="headerlink" title="ç¤ºä¾‹ 2"></a>ç¤ºä¾‹ 2</h2><blockquote><p>è¾“å…¥: root &#x3D; [6,2,8,0,4,7,9,null,null,3,5], p &#x3D; 2, q &#x3D; 4<br>è¾“å‡º: 2<br>è§£é‡Š: èŠ‚ç‚¹ 2 å’ŒèŠ‚ç‚¹ 4 çš„æœ€è¿‘å…¬å…±ç¥–å…ˆæ˜¯ 2, å› ä¸ºæ ¹æ®å®šä¹‰æœ€è¿‘å…¬å…±ç¥–å…ˆèŠ‚ç‚¹å¯ä»¥ä¸ºèŠ‚ç‚¹æœ¬èº«ã€‚</p></blockquote><p><strong>è¯´æ˜</strong>:</p><ul><li>æ‰€æœ‰èŠ‚ç‚¹çš„å€¼éƒ½æ˜¯å”¯ä¸€çš„ã€‚</li><li>pã€q ä¸ºä¸åŒèŠ‚ç‚¹ä¸”å‡å­˜åœ¨äºç»™å®šçš„äºŒå‰æœç´¢æ ‘ä¸­ã€‚</li></ul><h1 id="2-è§£é¢˜æ€è·¯"><a href="#2-è§£é¢˜æ€è·¯" class="headerlink" title="2.è§£é¢˜æ€è·¯"></a>2.è§£é¢˜æ€è·¯</h1><p>æœ¬ç« ä¸<a href="https://blog.csdn.net/kezade/article/details/130430120">äºŒå‰æ ‘çš„æœ€è¿‘å…¬å…±ç¥–å…ˆ</a> ç±»ä¼¼ï¼Œå¯ä»¥é‡‡ç”¨å®ƒçš„ç®—æ³•ï¼Œä½†äºŒå‰æœç´¢æ ‘å…·æœ‰å¾ˆæ˜æ˜¾çš„æ’åºåŠŸèƒ½ã€‚å¯¹äºäºŒå‰æœç´¢æ ‘ä¸­çš„èŠ‚ç‚¹p,qï¼Œåªä¼šå­˜åœ¨ä¸¤ç§åˆ†å¸ƒæƒ…å†µï¼š</p><ul><li>pã€qä½äºrootçš„åŒä¾§ï¼Œåˆ™åªè¦é€’å½’æŸ¥æ‰¾rootçš„å·¦æˆ–å³å­æ ‘å³å¯</li><li>pã€qä½äºrootçš„ä¸¤ä¾§ï¼Œç›´æ¥è¿”å›root</li></ul><h1 id="3-ä»£ç "><a href="#3-ä»£ç " class="headerlink" title="3.ä»£ç "></a>3.ä»£ç </h1><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/** * Definition for a binary tree node. * public class TreeNode &#123; *     int val; *     TreeNode left; *     TreeNode right; *     TreeNode(int x) &#123; val = x; &#125; * &#125; */</span><span class="token comment">/*** èŠ‚ç‚¹på’ŒèŠ‚ç‚¹qåªæœ‰ä¸¤ç§å…³ç³»:çˆ¶å­å…³ç³» å…„å¼Ÿå…³ç³»* çˆ¶å­å…³ç³»: *       1.èŠ‚ç‚¹pæ˜¯èŠ‚ç‚¹qçš„å­å­™èŠ‚ç‚¹,å³èŠ‚ç‚¹på‡ºç°åœ¨èŠ‚ç‚¹qçš„å·¦æˆ–å³å­æ ‘ä¸­;è¿”å›qå³å¯;*       2.èŠ‚ç‚¹qæ˜¯èŠ‚ç‚¹pçš„å­å­™èŠ‚ç‚¹,å³èŠ‚ç‚¹qå‡ºç°åœ¨èŠ‚ç‚¹pçš„å·¦æˆ–å³å­æ ‘ä¸­;è¿”å›på³å¯;* å…„å¼Ÿå…³ç³»:*       èŠ‚ç‚¹p,qåˆ†åˆ«å‡ºç°åœ¨æŸèŠ‚ç‚¹çš„å·¦å­æ ‘æˆ–å³å­æ ‘ä¸­;è¿”å›è¯¥èŠ‚ç‚¹å³å¯;**/</span><span class="token keyword">class</span> <span class="token class-name">Solution</span> <span class="token punctuation">&#123;</span>    <span class="token comment">//æ™®é€šäºŒå‰æ ‘è§£æ³•</span>    <span class="token keyword">public</span> <span class="token class-name">TreeNode</span> <span class="token function">lowestCommonAncestor2</span><span class="token punctuation">(</span><span class="token class-name">TreeNode</span> root<span class="token punctuation">,</span> <span class="token class-name">TreeNode</span> p<span class="token punctuation">,</span> <span class="token class-name">TreeNode</span> q<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token comment">//æ ¹èŠ‚ç‚¹</span>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">==</span> root <span class="token operator">||</span> p <span class="token operator">==</span> root <span class="token operator">||</span> q <span class="token operator">==</span> root<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            <span class="token keyword">return</span> root<span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token class-name">TreeNode</span> leftNode<span class="token operator">=</span><span class="token function">lowestCommonAncestor</span><span class="token punctuation">(</span>root<span class="token punctuation">.</span>left<span class="token punctuation">,</span> p <span class="token punctuation">,</span>q<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">TreeNode</span> rightNode<span class="token operator">=</span><span class="token function">lowestCommonAncestor</span><span class="token punctuation">(</span>root<span class="token punctuation">.</span>right<span class="token punctuation">,</span> p<span class="token punctuation">,</span> q<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">//è‹¥p,qåˆ†åˆ«åœ¨rootçš„å·¦å³å­æ ‘ä¸­ï¼Œè¿”å›æ ¹èŠ‚ç‚¹</span>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">!=</span> leftNode <span class="token operator">&amp;&amp;</span> <span class="token keyword">null</span> <span class="token operator">!=</span> rightNode<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            <span class="token keyword">return</span> root<span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token comment">//å¦åˆ™ï¼Œè¿”å›ä¸ä¸ºç©ºçš„é‚£ä¸ªå­æ ‘èŠ‚ç‚¹</span>        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token operator">==</span>leftNode<span class="token operator">?</span>rightNode<span class="token operator">:</span>leftNode<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">public</span> <span class="token class-name">TreeNode</span> <span class="token function">lowestCommonAncestor</span><span class="token punctuation">(</span><span class="token class-name">TreeNode</span> root<span class="token punctuation">,</span> <span class="token class-name">TreeNode</span> p<span class="token punctuation">,</span> <span class="token class-name">TreeNode</span> q<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token comment">//æ ¹èŠ‚ç‚¹</span>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">==</span> root <span class="token operator">||</span> p <span class="token operator">==</span> root <span class="token operator">||</span> q <span class="token operator">==</span> root<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            <span class="token keyword">return</span> root<span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token comment">//pï¼Œqåœ¨åŒä¸€è¾¹</span>        <span class="token comment">//åŒåœ¨å·¦å­æ ‘</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>root<span class="token punctuation">.</span>val<span class="token operator">>=</span>p<span class="token punctuation">.</span>val <span class="token operator">&amp;&amp;</span> root<span class="token punctuation">.</span>val<span class="token operator">>=</span>q<span class="token punctuation">.</span>val<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            <span class="token keyword">return</span> <span class="token function">lowestCommonAncestor</span><span class="token punctuation">(</span>root<span class="token punctuation">.</span>left<span class="token punctuation">,</span> p<span class="token punctuation">,</span> q<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token comment">//åŒåœ¨å³å­æ ‘</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>root<span class="token punctuation">.</span>val<span class="token operator">&lt;=</span>p<span class="token punctuation">.</span>val <span class="token operator">&amp;&amp;</span> root<span class="token punctuation">.</span>val<span class="token operator">&lt;=</span>q<span class="token punctuation">.</span>val<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            <span class="token keyword">return</span> <span class="token function">lowestCommonAncestor</span><span class="token punctuation">(</span>root<span class="token punctuation">.</span>right<span class="token punctuation">,</span> p<span class="token punctuation">,</span> q<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token comment">//ä¸åœ¨åŒä¸€è¾¹</span>        <span class="token keyword">return</span> root<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> ç®—æ³• </category>
          
      </categories>
      
      
        <tags>
            
            <tag> LeetCode </tag>
            
            <tag> ç®—æ³• </tag>
            
            <tag> äºŒå‰æ ‘ </tag>
            
            <tag> æ•°æ®ç»“æ„ </tag>
            
            <tag> Java </tag>
            
            <tag> DFS </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ã€LeetCodeã€‘236. äºŒå‰æ ‘çš„æœ€è¿‘å…¬å…±ç¥–å…ˆ</title>
      <link href="/posts/3195241813.html"/>
      <url>/posts/3195241813.html</url>
      
        <content type="html"><![CDATA[<h1 id="1-é—®é¢˜"><a href="#1-é—®é¢˜" class="headerlink" title="1.é—®é¢˜"></a>1.é—®é¢˜</h1><p>ç»™å®šä¸€ä¸ªäºŒå‰æ ‘, æ‰¾åˆ°è¯¥æ ‘ä¸­ä¸¤ä¸ªæŒ‡å®šèŠ‚ç‚¹çš„æœ€è¿‘å…¬å…±ç¥–å…ˆã€‚</p><p>ç™¾åº¦ç™¾ç§‘ä¸­æœ€è¿‘å…¬å…±ç¥–å…ˆçš„å®šä¹‰ä¸ºï¼šâ€œå¯¹äºæœ‰æ ¹æ ‘ T çš„ä¸¤ä¸ªèŠ‚ç‚¹ pã€qï¼Œæœ€è¿‘å…¬å…±ç¥–å…ˆè¡¨ç¤ºä¸ºä¸€ä¸ªèŠ‚ç‚¹ xï¼Œæ»¡è¶³ x æ˜¯ pã€q çš„ç¥–å…ˆä¸” x çš„æ·±åº¦å°½å¯èƒ½å¤§ï¼ˆä¸€ä¸ªèŠ‚ç‚¹ä¹Ÿå¯ä»¥æ˜¯å®ƒè‡ªå·±çš„ç¥–å…ˆï¼‰ã€‚â€</p><h2 id="ç¤ºä¾‹-1"><a href="#ç¤ºä¾‹-1" class="headerlink" title="ç¤ºä¾‹ 1"></a>ç¤ºä¾‹ 1</h2><p> <img src="https://cdn.jsdelivr.net/gh/zyxelva/picgo@main/csdn/868208add5b347d0837c787d0f7e82be.png"></p><blockquote><p>è¾“å…¥ï¼šroot &#x3D; [3,5,1,6,2,0,8,null,null,7,4], p &#x3D; 5, q &#x3D; 1<br>è¾“å‡ºï¼š3<br>è§£é‡Šï¼šèŠ‚ç‚¹ 5 å’ŒèŠ‚ç‚¹ 1 çš„æœ€è¿‘å…¬å…±ç¥–å…ˆæ˜¯èŠ‚ç‚¹ 3 ã€‚</p></blockquote><h2 id="ç¤ºä¾‹-2"><a href="#ç¤ºä¾‹-2" class="headerlink" title="ç¤ºä¾‹ 2"></a>ç¤ºä¾‹ 2</h2><p><img src="https://cdn.jsdelivr.net/gh/zyxelva/picgo@main/csdn/5b57549b34a04b51963ea207b0323194.png"></p><blockquote><p>è¾“å…¥ï¼šroot &#x3D; [3,5,1,6,2,0,8,null,null,7,4], p &#x3D; 5, q &#x3D; 4<br>è¾“å‡ºï¼š5<br>è§£é‡Šï¼šèŠ‚ç‚¹ 5 å’ŒèŠ‚ç‚¹ 4 çš„æœ€è¿‘å…¬å…±ç¥–å…ˆæ˜¯èŠ‚ç‚¹ 5 ã€‚å› ä¸ºæ ¹æ®å®šä¹‰æœ€è¿‘å…¬å…±ç¥–å…ˆèŠ‚ç‚¹å¯ä»¥ä¸ºèŠ‚ç‚¹æœ¬èº«ã€‚</p></blockquote><h2 id="ç¤ºä¾‹-3"><a href="#ç¤ºä¾‹-3" class="headerlink" title="ç¤ºä¾‹ 3"></a>ç¤ºä¾‹ 3</h2><blockquote><p>è¾“å…¥ï¼šroot &#x3D; [1,2], p &#x3D; 1, q &#x3D; 2<br>è¾“å‡ºï¼š1</p></blockquote><p><strong>æç¤º</strong>ï¼š</p><ul><li>æ ‘ä¸­èŠ‚ç‚¹æ•°ç›®åœ¨èŒƒå›´ [2, 105] å†…ã€‚</li><li>-109 &lt;&#x3D; Node.val &lt;&#x3D; 109</li><li>æ‰€æœ‰ Node.val äº’ä¸ç›¸åŒ ã€‚</li><li>p !&#x3D; q</li><li>p å’Œ q å‡å­˜åœ¨äºç»™å®šçš„äºŒå‰æ ‘ä¸­ã€‚</li></ul><h1 id="2-è§£é¢˜æ€è·¯"><a href="#2-è§£é¢˜æ€è·¯" class="headerlink" title="2.è§£é¢˜æ€è·¯"></a>2.è§£é¢˜æ€è·¯</h1><h2 id="2-1-ç¥–å…ˆçš„å®šä¹‰"><a href="#2-1-ç¥–å…ˆçš„å®šä¹‰" class="headerlink" title="2.1 ç¥–å…ˆçš„å®šä¹‰"></a>2.1 ç¥–å…ˆçš„å®šä¹‰</h2><p>è‹¥èŠ‚ç‚¹pä½äºrootæ ¹èŠ‚ç‚¹çš„å·¦æˆ–å³å­æ ‘ï¼Œæˆ–è€…på°±æ˜¯rootï¼Œåˆ™rootä¸ºpçš„ç¥–å…ˆã€‚</p><h2 id="2-2-æœ€è¿‘å…¬å…±ç¥–å…ˆ"><a href="#2-2-æœ€è¿‘å…¬å…±ç¥–å…ˆ" class="headerlink" title="2.2 æœ€è¿‘å…¬å…±ç¥–å…ˆ"></a>2.2 æœ€è¿‘å…¬å…±ç¥–å…ˆ</h2><p>è®¾èŠ‚ç‚¹ root ä¸ºèŠ‚ç‚¹ p,q çš„æŸå…¬å…±ç¥–å…ˆï¼Œè‹¥å…¶å·¦å­èŠ‚ç‚¹ root.left å’Œå³å­èŠ‚ç‚¹ root.right éƒ½ä¸æ˜¯ p,q çš„å…¬å…±ç¥–å…ˆï¼Œåˆ™ç§° root æ˜¯ â€œæœ€è¿‘çš„å…¬å…±ç¥–å…ˆâ€ ã€‚</p><p>å¯¹äºäºŒå‰æ ‘ä¸­çš„èŠ‚ç‚¹p,qï¼Œåªå¯èƒ½å­˜åœ¨ä¸¤ç§å…³ç³»ï¼š</p><ul><li>çˆ¶å­ï¼ˆæˆ–ç¥–å­™ï¼‰å…³ç³»</li><li>å…„å¼Ÿå…³ç³»</li></ul><h2 id="2-3-çˆ¶å­å…³ç³»"><a href="#2-3-çˆ¶å­å…³ç³»" class="headerlink" title="2.3 çˆ¶å­å…³ç³»"></a>2.3 çˆ¶å­å…³ç³»</h2><p>å¯¹äºå…·æœ‰çˆ¶å­å…³ç³»çš„èŠ‚ç‚¹p,qï¼Œå­˜åœ¨ä¸¤ç§æƒ…å†µï¼š</p><ul><li>èŠ‚ç‚¹pæ˜¯èŠ‚ç‚¹qçš„å­å­™èŠ‚ç‚¹ï¼Œå³èŠ‚ç‚¹på‡ºç°åœ¨èŠ‚ç‚¹qçš„å·¦æˆ–å³å­æ ‘ä¸­ï¼Œè¿”å›qå³å¯</li><li>èŠ‚ç‚¹qæ˜¯èŠ‚ç‚¹pçš„å­å­™èŠ‚ç‚¹ï¼Œå³èŠ‚ç‚¹qå‡ºç°åœ¨èŠ‚ç‚¹pçš„å·¦æˆ–å³å­æ ‘ä¸­ï¼Œè¿”å›på³å¯</li></ul><h2 id="2-4-å…„å¼Ÿå…³ç³»"><a href="#2-4-å…„å¼Ÿå…³ç³»" class="headerlink" title="2.4 å…„å¼Ÿå…³ç³»"></a>2.4 å…„å¼Ÿå…³ç³»</h2><p>èŠ‚ç‚¹p,qåˆ†åˆ«å‡ºç°åœ¨æŸèŠ‚ç‚¹çš„å·¦å­æ ‘æˆ–å³å­æ ‘ä¸­ï¼Œè¿”å›è¯¥èŠ‚ç‚¹å³å¯</p><h1 id="3-ä»£ç "><a href="#3-ä»£ç " class="headerlink" title="3.ä»£ç "></a>3.ä»£ç </h1><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/** * Definition for a binary tree node. * public class TreeNode &#123; *     int val; *     TreeNode left; *     TreeNode right; *     TreeNode(int x) &#123; val = x; &#125; * &#125; */</span><span class="token keyword">class</span> <span class="token class-name">Solution</span> <span class="token punctuation">&#123;</span>    <span class="token comment">/**     * èŠ‚ç‚¹på’ŒèŠ‚ç‚¹qåªæœ‰ä¸¤ç§å…³ç³»:çˆ¶å­å…³ç³» å…„å¼Ÿå…³ç³»     * çˆ¶å­å…³ç³»:      *       1.èŠ‚ç‚¹pæ˜¯èŠ‚ç‚¹qçš„å­å­™èŠ‚ç‚¹,å³èŠ‚ç‚¹på‡ºç°åœ¨èŠ‚ç‚¹qçš„å·¦æˆ–å³å­æ ‘ä¸­;è¿”å›qå³å¯;     *       2.èŠ‚ç‚¹qæ˜¯èŠ‚ç‚¹pçš„å­å­™èŠ‚ç‚¹,å³èŠ‚ç‚¹qå‡ºç°åœ¨èŠ‚ç‚¹pçš„å·¦æˆ–å³å­æ ‘ä¸­;è¿”å›på³å¯;     * å…„å¼Ÿå…³ç³»:     *       èŠ‚ç‚¹p,qåˆ†åˆ«å‡ºç°åœ¨æŸèŠ‚ç‚¹çš„å·¦å­æ ‘æˆ–å³å­æ ‘ä¸­;è¿”å›è¯¥èŠ‚ç‚¹å³å¯;     *     */</span>    <span class="token keyword">public</span> <span class="token class-name">TreeNode</span> <span class="token function">lowestCommonAncestor</span><span class="token punctuation">(</span><span class="token class-name">TreeNode</span> root<span class="token punctuation">,</span> <span class="token class-name">TreeNode</span> p<span class="token punctuation">,</span> <span class="token class-name">TreeNode</span> q<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>root<span class="token operator">==</span><span class="token keyword">null</span><span class="token operator">||</span>root<span class="token operator">==</span>p<span class="token operator">||</span>root<span class="token operator">==</span>q<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            <span class="token keyword">return</span> root<span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token class-name">TreeNode</span> leftRes<span class="token operator">=</span><span class="token function">lowestCommonAncestor</span><span class="token punctuation">(</span>root<span class="token punctuation">.</span>left<span class="token punctuation">,</span>p<span class="token punctuation">,</span>q<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">TreeNode</span> rightRes<span class="token operator">=</span><span class="token function">lowestCommonAncestor</span><span class="token punctuation">(</span>root<span class="token punctuation">.</span>right<span class="token punctuation">,</span>p<span class="token punctuation">,</span>q<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">//p,qåœ¨æŸèŠ‚ç‚¹å·¦å­æ ‘å’Œå³å­æ ‘ä¸­,è¿”å›æ ¹èŠ‚ç‚¹</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>leftRes<span class="token operator">!=</span><span class="token keyword">null</span><span class="token operator">&amp;&amp;</span>rightRes<span class="token operator">!=</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            <span class="token keyword">return</span> root<span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">return</span> leftRes<span class="token operator">==</span><span class="token keyword">null</span><span class="token operator">?</span>rightRes<span class="token operator">:</span>leftRes<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> ç®—æ³• </category>
          
      </categories>
      
      
        <tags>
            
            <tag> LeetCode </tag>
            
            <tag> ç®—æ³• </tag>
            
            <tag> äºŒå‰æ ‘ </tag>
            
            <tag> æ•°æ®ç»“æ„ </tag>
            
            <tag> Java </tag>
            
            <tag> DFS </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ã€LeetCodeã€‘637. äºŒå‰æ ‘çš„å±‚å¹³å‡å€¼</title>
      <link href="/posts/3513331422.html"/>
      <url>/posts/3513331422.html</url>
      
        <content type="html"><![CDATA[<h1 id="1-é—®é¢˜"><a href="#1-é—®é¢˜" class="headerlink" title="1.é—®é¢˜"></a>1.é—®é¢˜</h1><p>ç»™å®šä¸€ä¸ªéç©ºäºŒå‰æ ‘çš„æ ¹èŠ‚ç‚¹ root , ä»¥æ•°ç»„çš„å½¢å¼è¿”å›æ¯ä¸€å±‚èŠ‚ç‚¹çš„å¹³å‡å€¼ã€‚ä¸å®é™…ç­”æ¡ˆç›¸å·® 10-5 ä»¥å†…çš„ç­”æ¡ˆå¯ä»¥è¢«æ¥å—ã€‚</p><h2 id="ç¤ºä¾‹-1"><a href="#ç¤ºä¾‹-1" class="headerlink" title="ç¤ºä¾‹ 1"></a>ç¤ºä¾‹ 1</h2><p><img src="https://cdn.jsdelivr.net/gh/zyxelva/picgo@main/csdn/572cf85465494ddaad64571044fcaa83.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p><blockquote><p>è¾“å…¥ï¼šroot &#x3D; [3,9,20,null,null,15,7]<br>è¾“å‡ºï¼š[3.00000,14.50000,11.00000]<br>è§£é‡Šï¼šç¬¬ 0 å±‚çš„å¹³å‡å€¼ä¸º 3,ç¬¬ 1 å±‚çš„å¹³å‡å€¼ä¸º 14.5,ç¬¬ 2 å±‚çš„å¹³å‡å€¼ä¸º 11 ã€‚å› æ­¤è¿”å› [3, 14.5, 11] ã€‚</p></blockquote><h2 id="ç¤ºä¾‹-2"><a href="#ç¤ºä¾‹-2" class="headerlink" title="ç¤ºä¾‹ 2"></a>ç¤ºä¾‹ 2</h2><p><img src="https://cdn.jsdelivr.net/gh/zyxelva/picgo@main/csdn/af4eaf4f503149238b33e223bc4b999e.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p><blockquote><p>è¾“å…¥ï¼šroot &#x3D; [3,9,20,15,7]<br>è¾“å‡ºï¼š[3.00000,14.50000,11.00000]</p></blockquote><p><strong>æç¤º</strong>ï¼š</p><ul><li>æ ‘ä¸­èŠ‚ç‚¹æ•°é‡åœ¨ [1, 104] èŒƒå›´å†…</li><li>-231 &lt;&#x3D; Node.val &lt;&#x3D; 231 - 1</li></ul><h1 id="2-è§£é¢˜æ€è·¯"><a href="#2-è§£é¢˜æ€è·¯" class="headerlink" title="2.è§£é¢˜æ€è·¯"></a>2.è§£é¢˜æ€è·¯</h1><p>å±‚åºéå†æ–¹æ³•å‚è§<a href="https://zyxelva.github.io/posts/2462725929.html">102.äºŒå‰æ ‘çš„å±‚åºéå†</a> ä¸€æ–‡ï¼Œæœ¬ç« ä¸ç”¨å±‚æ ‡è¯†ï¼Œå¯¹äºåˆ©ç”¨å¹¿åº¦ä¼˜å…ˆç®—æ³•ï¼Œä¸é‡‡ç”¨å±‚æ ‡è¯†ï¼Œéå†åˆ°æ–°çš„ä¸€å±‚ï¼Œå¾ªç¯å‡ºé˜Ÿï¼Œè®¡ç®—è¯¥å±‚çš„æ€»å’Œã€‚</p><h1 id="3-ä»£ç "><a href="#3-ä»£ç " class="headerlink" title="3.ä»£ç "></a>3.ä»£ç </h1><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/** * Definition for a binary tree node. * public class TreeNode &#123; *     int val; *     TreeNode left; *     TreeNode right; *     TreeNode() &#123;&#125; *     TreeNode(int val) &#123; this.val = val; &#125; *     TreeNode(int val, TreeNode left, TreeNode right) &#123; *         this.val = val; *         this.left = left; *         this.right = right; *     &#125; * &#125; */</span><span class="token keyword">class</span> <span class="token class-name">Solution</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Double</span><span class="token punctuation">></span></span> <span class="token function">averageOfLevels</span><span class="token punctuation">(</span><span class="token class-name">TreeNode</span> root<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token comment">//å±‚æ¬¡éå† é˜Ÿåˆ—</span>        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Double</span><span class="token punctuation">></span></span> res<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">//é˜Ÿåˆ—</span>        <span class="token class-name">Queue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TreeNode</span><span class="token punctuation">></span></span> q<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">LinkedList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">//ä¸´æ—¶èŠ‚ç‚¹</span>        <span class="token class-name">TreeNode</span> tmp<span class="token punctuation">;</span>        <span class="token comment">//å’Œ</span>        <span class="token keyword">double</span> sum<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>        <span class="token comment">//ä¸ªæ•°</span>        <span class="token keyword">int</span> cnt<span class="token punctuation">;</span>        <span class="token comment">//å…¥é˜Ÿ</span>        q<span class="token punctuation">.</span><span class="token function">offer</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token operator">!</span>q<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            <span class="token keyword">int</span> size<span class="token operator">=</span>q<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            cnt<span class="token operator">=</span>size<span class="token punctuation">;</span>            <span class="token comment">//å¾ªç¯å‡ºé˜Ÿï¼Œéå†å®Œè¯¥å±‚æ‰€æœ‰çš„èŠ‚ç‚¹</span>            <span class="token keyword">while</span><span class="token punctuation">(</span>size<span class="token operator">--</span><span class="token operator">></span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>                <span class="token comment">//å‡ºé˜Ÿ</span>                tmp<span class="token operator">=</span>q<span class="token punctuation">.</span><span class="token function">poll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                sum<span class="token operator">+=</span>tmp<span class="token punctuation">.</span>val<span class="token punctuation">;</span>                <span class="token comment">//å·¦å³å­æ ‘å…¥é˜Ÿ</span>                <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token operator">!=</span>tmp<span class="token punctuation">.</span>left<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>                    q<span class="token punctuation">.</span><span class="token function">offer</span><span class="token punctuation">(</span>tmp<span class="token punctuation">.</span>left<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">&#125;</span>                <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token operator">!=</span>tmp<span class="token punctuation">.</span>right<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>                    q<span class="token punctuation">.</span><span class="token function">offer</span><span class="token punctuation">(</span>tmp<span class="token punctuation">.</span>right<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">&#125;</span>            <span class="token punctuation">&#125;</span>            <span class="token comment">//è¯¥å±‚éå†ã€è®¡ç®—å®Œæ¯•</span>            res<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>sum<span class="token operator">*</span><span class="token number">1.0</span><span class="token operator">/</span>cnt<span class="token punctuation">)</span><span class="token punctuation">;</span>            sum<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">return</span> res<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> ç®—æ³• </category>
          
      </categories>
      
      
        <tags>
            
            <tag> LeetCode </tag>
            
            <tag> ç®—æ³• </tag>
            
            <tag> äºŒå‰æ ‘ </tag>
            
            <tag> æ•°æ®ç»“æ„ </tag>
            
            <tag> Java </tag>
            
            <tag> DFS </tag>
            
            <tag> BFS </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ã€LeetCodeã€‘297. äºŒå‰æ ‘çš„åºåˆ—åŒ–ä¸ååºåˆ—åŒ–</title>
      <link href="/posts/61042.html"/>
      <url>/posts/61042.html</url>
      
        <content type="html"><![CDATA[<h1 id="1-é—®é¢˜"><a href="#1-é—®é¢˜" class="headerlink" title="1.é—®é¢˜"></a>1.é—®é¢˜</h1><p><strong>åºåˆ—åŒ–</strong>æ˜¯å°†ä¸€ä¸ªæ•°æ®ç»“æ„æˆ–è€…å¯¹è±¡è½¬æ¢ä¸ºè¿ç»­çš„æ¯”ç‰¹ä½çš„æ“ä½œï¼Œè¿›è€Œå¯ä»¥å°†è½¬æ¢åçš„æ•°æ®å­˜å‚¨åœ¨ä¸€ä¸ªæ–‡ä»¶æˆ–è€…å†…å­˜ä¸­ï¼ŒåŒæ—¶ä¹Ÿå¯ä»¥é€šè¿‡ç½‘ç»œä¼ è¾“åˆ°å¦ä¸€ä¸ªè®¡ç®—æœºç¯å¢ƒï¼Œé‡‡å–ç›¸åæ–¹å¼é‡æ„å¾—åˆ°åŸæ•°æ®ã€‚</p><p>è¯·è®¾è®¡ä¸€ä¸ªç®—æ³•æ¥å®ç°äºŒå‰æ ‘çš„åºåˆ—åŒ–ä¸ååºåˆ—åŒ–ã€‚è¿™é‡Œä¸é™å®šä½ çš„åºåˆ— &#x2F; ååºåˆ—åŒ–ç®—æ³•æ‰§è¡Œé€»è¾‘ï¼Œä½ åªéœ€è¦ä¿è¯ä¸€ä¸ªäºŒå‰æ ‘å¯ä»¥è¢«åºåˆ—åŒ–ä¸ºä¸€ä¸ªå­—ç¬¦ä¸²å¹¶ä¸”å°†è¿™ä¸ªå­—ç¬¦ä¸²ååºåˆ—åŒ–ä¸ºåŸå§‹çš„æ ‘ç»“æ„ã€‚</p><p>æç¤º: è¾“å…¥è¾“å‡ºæ ¼å¼ä¸ LeetCode ç›®å‰ä½¿ç”¨çš„æ–¹å¼ä¸€è‡´ï¼Œè¯¦æƒ…è¯·å‚é˜… LeetCode åºåˆ—åŒ–äºŒå‰æ ‘çš„æ ¼å¼ã€‚ä½ å¹¶éå¿…é¡»é‡‡å–è¿™ç§æ–¹å¼ï¼Œä½ ä¹Ÿå¯ä»¥é‡‡ç”¨å…¶ä»–çš„æ–¹æ³•è§£å†³è¿™ä¸ªé—®é¢˜ã€‚</p><h2 id="ç¤ºä¾‹-1"><a href="#ç¤ºä¾‹-1" class="headerlink" title="ç¤ºä¾‹ 1"></a>ç¤ºä¾‹ 1</h2><p><img src="https://cdn.jsdelivr.net/gh/zyxelva/picgo@main/csdn/c5186c114299495ebabab7a28745e79f.png"></p><blockquote><p>è¾“å…¥ï¼šroot &#x3D; [1,2,3,null,null,4,5]<br>è¾“å‡ºï¼š[1,2,3,null,null,4,5]</p></blockquote><h2 id="ç¤ºä¾‹-2"><a href="#ç¤ºä¾‹-2" class="headerlink" title="ç¤ºä¾‹ 2"></a>ç¤ºä¾‹ 2</h2><blockquote><p>è¾“å…¥ï¼šroot &#x3D; []<br>è¾“å‡ºï¼š[]</p></blockquote><h2 id="ç¤ºä¾‹-3"><a href="#ç¤ºä¾‹-3" class="headerlink" title="ç¤ºä¾‹ 3"></a>ç¤ºä¾‹ 3</h2><blockquote><p>è¾“å…¥ï¼šroot &#x3D; [1]<br>è¾“å‡ºï¼š[1]</p></blockquote><h2 id="ç¤ºä¾‹-4"><a href="#ç¤ºä¾‹-4" class="headerlink" title="ç¤ºä¾‹ 4"></a>ç¤ºä¾‹ 4</h2><blockquote><p>è¾“å…¥ï¼šroot &#x3D; [1,2]<br>è¾“å‡ºï¼š[1,2]</p></blockquote><p><strong>æç¤º</strong>ï¼š</p><ul><li>æ ‘ä¸­ç»“ç‚¹æ•°åœ¨èŒƒå›´ [0, 104] å†…</li><li>-1000 &lt;&#x3D; Node.val &lt;&#x3D; 1000</li></ul><h1 id="2-è§£é¢˜æ€è·¯"><a href="#2-è§£é¢˜æ€è·¯" class="headerlink" title="2.è§£é¢˜æ€è·¯"></a>2.è§£é¢˜æ€è·¯</h1><p>äºŒå‰æ ‘æœ‰å¾ˆå¤šç§éå†æ€è·¯ï¼Œå¦‚è¦è§£å†³æœ¬é¢˜ï¼Œå¯ä»¥å‚è€ƒä»¥ä¸‹äºŒå‰æ ‘çš„éå†ç®—æ³•ï¼Œåºåˆ—åŒ–ä¸ç”¨å¤šè¯´ï¼Œååºåˆ—åŒ–å°±æ˜¯é€†å‘æ€è€ƒä¹‹å‰æ˜¯æ€ä¹ˆåºåˆ—åŒ–çš„ã€‚æœ¬ç« ä¸»è¦è®²è§£æ€ä¹ˆåˆ©ç”¨å±‚åºéå†çš„æ€æƒ³è§£å†³ååºåˆ—åŒ–é—®é¢˜ã€‚</p><h2 id="äºŒå‰æ ‘éå†ç³»åˆ—"><a href="#äºŒå‰æ ‘éå†ç³»åˆ—" class="headerlink" title="äºŒå‰æ ‘éå†ç³»åˆ—"></a>äºŒå‰æ ‘éå†ç³»åˆ—</h2><ul><li><a href="https://zyxelva.github.io/posts/60831.html">144.äºŒå‰æ ‘çš„å‰åºéå†</a></li><li><a href="https://zyxelva.github.io/posts/41115.html">94.äºŒå‰æ ‘çš„ä¸­åºéå†</a></li><li><a href="https://zyxelva.github.io/posts/61239.html">145.äºŒå‰æ ‘çš„åç»­éå†</a></li><li><a href="https://zyxelva.github.io/posts/46738.html">102.äºŒå‰æ ‘çš„å±‚åºéå†</a></li><li><a href="https://zyxelva.github.io/posts/45075.html">107.äºŒå‰æ ‘çš„å±‚åºéå†II</a></li><li><a href="https://zyxelva.github.io/posts/637.html">103.äºŒå‰æ ‘çš„é”¯é½¿å½¢å±‚åºéå†ï¼ˆä¹‹å­—å½¢éå†ï¼‰</a></li><li><a href="https://zyxelva.github.io/posts/26388.html">199.äºŒå‰æ ‘çš„å³è§†å›¾</a></li></ul><hr><h2 id="2-1-BFS"><a href="#2-1-BFS" class="headerlink" title="2.1 BFS"></a>2.1 BFS</h2><p>åœ¨<a href="https://zyxelva.github.io/posts/46738.html">102.äºŒå‰æ ‘çš„å±‚åºéå†</a> ä¸€æ–‡ä¸­ï¼Œæˆ‘ä»¬åˆ©ç”¨é˜Ÿåˆ—çš„æ€§è´¨å¯¹äºŒå‰æ ‘è¿›è¡Œäº†å±‚åºéå†ï¼Œæœ¬ç« ï¼Œåœ¨åºåˆ—åŒ–æ—¶æˆ‘ä»¬ä¹Ÿå¯ä»¥ç”¨é˜Ÿåˆ—ï¼Œåªæ˜¯ä¸éœ€è¦åˆ†å±‚æ ‡è¯†ï¼Œæ¯”å¦‚æˆ‘ä»¬å¯ä»¥æŠŠå®ƒçœ‹æˆæ˜¯è¿™æ ·ï¼š<br><img src="https://cdn.jsdelivr.net/gh/zyxelva/picgo@main/csdn/2d1b08b2f4e749fbbd5283931f47847a.png"><br>æˆ‘ä»¬å®šä¹‰ä¸€ä¸ªç©ºèŠ‚ç‚¹ï¼Œç”¨ä»¥æ ‡è¯†æŸä¸ªèŠ‚ç‚¹æ— å·¦æˆ–å³å­èŠ‚ç‚¹ã€‚ç”¨ä¸‹åˆ’çº¿åˆ†å‰²å„ä¸ªèŠ‚ç‚¹çš„å€¼ã€‚</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">int</span> <span class="token constant">INF</span> <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">2000</span><span class="token punctuation">;</span><span class="token class-name">TreeNode</span> emptyNode <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TreeNode</span><span class="token punctuation">(</span><span class="token constant">INF</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>åˆ™åºåˆ—åŒ–åçš„ç»“æœä¸ºï¼š<code>1_2_3_-2000_-2000_4_5_-2000_-2000_-2000_-2000</code>;<br>ååºåˆ—åŒ–æ—¶ï¼Œåˆ©ç”¨é˜Ÿåˆ—ï¼Œå¼¹å‡ºå¤´ç»“ç‚¹ï¼ŒåŒ…è£…æˆäºŒå‰æ ‘èŠ‚ç‚¹ï¼Œå¯¹äºåºåˆ—åŒ–çš„åºåˆ—ï¼Œå–å‡ºä¸¤ä¸ªèŠ‚ç‚¹ï¼Œåªè¦å€¼ä¸æ˜¯-2000ï¼Œå°±å¯ä»¥å°†çˆ¶å­èŠ‚ç‚¹è¿›è¡Œå…³è”ï¼Œå†å…¥é˜Ÿï¼Œä¾æ¬¡å¾ªç¯ã€‚</p><h2 id="2-2-é€’å½’"><a href="#2-2-é€’å½’" class="headerlink" title="2.2 é€’å½’"></a>2.2 é€’å½’</h2><p>è¿™é‡Œä»¥å‰åºéå†æ€æƒ³ä¸ºä¾‹ï¼Œå…¶ä»–ä¸­åºã€ååºéå†ç±»ä¼¼ã€‚<br>åŒæ ·ï¼Œåˆ©ç”¨ä¸Šè¿°2.1èŠ‚ä¸­çš„è‡ªå®šä¹‰ç©ºèŠ‚ç‚¹æ ‡è¯†äºŒå‰æ ‘çš„ç©ºå­èŠ‚ç‚¹ã€‚åºåˆ—åŒ–ä¼ªä»£ç å¤§è‡´å¦‚ä¸‹ï¼š</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">String</span> <span class="token function">serialize</span><span class="token punctuation">(</span><span class="token class-name">TreeNode</span> root<span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>root <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">return</span> <span class="token constant">INF</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">//å·¦èŠ‚ç‚¹</span><span class="token class-name">String</span> left<span class="token operator">=</span><span class="token function">serialize</span><span class="token punctuation">(</span>root<span class="token punctuation">.</span>left<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//å³èŠ‚ç‚¹</span><span class="token class-name">String</span> right<span class="token operator">=</span><span class="token function">serialize</span><span class="token punctuation">(</span>root<span class="token punctuation">.</span>right<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">return</span> root<span class="token punctuation">.</span>val<span class="token operator">+</span><span class="token string">"_"</span><span class="token operator">+</span>left<span class="token punctuation">.</span>val<span class="token operator">+</span><span class="token string">"_"</span><span class="token operator">+</span>right<span class="token punctuation">.</span>val<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ååºåˆ—åŒ–</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">TreeNode</span> <span class="token function">deserialize</span><span class="token punctuation">(</span><span class="token class-name">String</span> str<span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token comment">//åˆ†ç¦»èŠ‚ç‚¹å€¼</span>ss<span class="token operator">=</span>str<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">"_"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//é€’å½’ååºåˆ—åŒ–</span><span class="token keyword">return</span> <span class="token function">buildTree</span><span class="token punctuation">(</span>ss<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token class-name">TreeNode</span> <span class="token function">buildTree</span><span class="token punctuation">(</span>ss<span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token comment">//å¼¹å‡ºç¬¬ä¸€ä¸ªvalue</span>value<span class="token operator">=</span>ss<span class="token punctuation">.</span><span class="token function">poll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//éè‡ªå®šä¹‰ç©ºèŠ‚ç‚¹ é€’å½’</span><span class="token keyword">if</span><span class="token punctuation">(</span>value<span class="token operator">==</span><span class="token constant">INF</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">//æ„é€ èŠ‚ç‚¹</span><span class="token class-name">TreeNode</span> root<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">TreeNode</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>root<span class="token punctuation">.</span>left<span class="token operator">=</span><span class="token function">buildTree</span><span class="token punctuation">(</span>ss<span class="token punctuation">)</span><span class="token punctuation">;</span>root<span class="token punctuation">.</span>right<span class="token operator">=</span><span class="token function">buildTree</span><span class="token punctuation">(</span>ss<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">return</span> root<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h1 id="3-ä»£ç "><a href="#3-ä»£ç " class="headerlink" title="3.ä»£ç "></a>3.ä»£ç </h1><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">ArrayDeque</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Deque</span></span><span class="token punctuation">;</span><span class="token comment">/*public class TreeNode &#123;    int val = 0;    TreeNode left = null;    TreeNode right = null;    public TreeNode(int val) &#123;        this.val = val;    &#125;&#125;*/</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Solution</span> <span class="token punctuation">&#123;</span><span class="token comment">//å®šä¹‰ç©ºèŠ‚ç‚¹çš„å€¼</span>    <span class="token keyword">int</span> <span class="token constant">INF</span> <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">2000</span><span class="token punctuation">;</span>    <span class="token class-name">TreeNode</span> emptyNode <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TreeNode</span><span class="token punctuation">(</span><span class="token constant">INF</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//BFS</span>    <span class="token class-name">String</span> <span class="token class-name">Serialize</span><span class="token punctuation">(</span><span class="token class-name">TreeNode</span> root<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>root <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">return</span> <span class="token string">""</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span><span class="token comment">//åºåˆ—åŒ–çš„ä¸´æ—¶ç»“æœ</span>        <span class="token class-name">StringBuilder</span> sb <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">Deque</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TreeNode</span><span class="token punctuation">></span></span> d <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayDeque</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        d<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>d<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token comment">//å¼¹å‡ºä¸€ä¸ªèŠ‚ç‚¹ï¼Œç¬¬ä¸€ä¸ªæ˜¯root</span>            <span class="token class-name">TreeNode</span> poll <span class="token operator">=</span> d<span class="token punctuation">.</span><span class="token function">pollFirst</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment">//åºåˆ—åŒ–çš„å€¼ä»¥ä¸‹åˆ’çº¿åˆ†å‰²</span>            sb<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>poll<span class="token punctuation">.</span>val <span class="token operator">+</span> <span class="token string">"_"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment">//éè‡ªå®šä¹‰çš„ç©ºèŠ‚ç‚¹å…³è”çˆ¶èŠ‚ç‚¹</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>poll<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>emptyNode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                d<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span>poll<span class="token punctuation">.</span>left <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> poll<span class="token punctuation">.</span>left <span class="token operator">:</span> emptyNode<span class="token punctuation">)</span><span class="token punctuation">;</span>                d<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span>poll<span class="token punctuation">.</span>right <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> poll<span class="token punctuation">.</span>right <span class="token operator">:</span> emptyNode<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>sb<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> sb<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">//BFS</span>    <span class="token class-name">TreeNode</span> <span class="token class-name">Deserialize</span><span class="token punctuation">(</span><span class="token class-name">String</span> data<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>data<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> ss <span class="token operator">=</span> data<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">"_"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">int</span> n <span class="token operator">=</span> ss<span class="token punctuation">.</span>length<span class="token punctuation">;</span>        <span class="token comment">//æ ¹èŠ‚ç‚¹</span>        <span class="token class-name">TreeNode</span> root <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TreeNode</span><span class="token punctuation">(</span><span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">parseInt</span><span class="token punctuation">(</span>ss<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">Deque</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TreeNode</span><span class="token punctuation">></span></span> d <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayDeque</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        d<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> n <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">+=</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token class-name">TreeNode</span> poll <span class="token operator">=</span> d<span class="token punctuation">.</span><span class="token function">pollFirst</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">int</span> a <span class="token operator">=</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">parseInt</span><span class="token punctuation">(</span>ss<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">int</span> b <span class="token operator">=</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">parseInt</span><span class="token punctuation">(</span>ss<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment">//éè‡ªå®šä¹‰ç©ºèŠ‚ç‚¹çš„å€¼ï¼ŒåŒ…è£…æˆäºŒå‰æ ‘çš„èŠ‚ç‚¹ï¼Œå…³è”ä¸Šçˆ¶èŠ‚ç‚¹</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>a <span class="token operator">!=</span> <span class="token constant">INF</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                poll<span class="token punctuation">.</span>left <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TreeNode</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>                d<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span>poll<span class="token punctuation">.</span>left<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>b <span class="token operator">!=</span> <span class="token constant">INF</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                poll<span class="token punctuation">.</span>right <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TreeNode</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span>                d<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span>poll<span class="token punctuation">.</span>right<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">return</span> root<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token comment">//é€’å½’åºåˆ—åŒ–å’Œååºåˆ—åŒ–</span><span class="token comment">//å‰åºéå†</span>    <span class="token class-name">String</span> <span class="token class-name">Serialize2</span><span class="token punctuation">(</span><span class="token class-name">TreeNode</span> root<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">==</span> root<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">return</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span><span class="token constant">INF</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token class-name">StringBuilder</span> sb <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        sb<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>root<span class="token punctuation">.</span>val<span class="token punctuation">)</span>        <span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">"_"</span><span class="token punctuation">)</span>        <span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token class-name">Serialize</span><span class="token punctuation">(</span>root<span class="token punctuation">.</span>left<span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">"_"</span><span class="token punctuation">)</span>        <span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token class-name">Serialize</span><span class="token punctuation">(</span>root<span class="token punctuation">.</span>right<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">return</span> sb<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token class-name">TreeNode</span> <span class="token class-name">Deserialize2</span><span class="token punctuation">(</span><span class="token class-name">String</span> str<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">==</span> str <span class="token operator">||</span> <span class="token string">""</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token comment">//å°†èŠ‚ç‚¹å…ƒç´ å€¼åˆ†ç¦»</span>        <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> s <span class="token operator">=</span> str<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">"_"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> list <span class="token operator">=</span> <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">TreeNode</span> root <span class="token operator">=</span> <span class="token function">buildTree</span><span class="token punctuation">(</span>list<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> root<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">private</span> <span class="token class-name">TreeNode</span> <span class="token function">buildTree</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> list<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">int</span> rootValue <span class="token operator">=</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">parseInt</span><span class="token punctuation">(</span>list<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span> rootValue <span class="token operator">==</span> <span class="token constant">INF</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token class-name">TreeNode</span> root <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TreeNode</span><span class="token punctuation">(</span>rootValue<span class="token punctuation">)</span><span class="token punctuation">;</span>        root<span class="token punctuation">.</span>left <span class="token operator">=</span> <span class="token function">buildTree</span><span class="token punctuation">(</span>list<span class="token punctuation">)</span><span class="token punctuation">;</span>        root<span class="token punctuation">.</span>right <span class="token operator">=</span> <span class="token function">buildTree</span><span class="token punctuation">(</span>list<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> root<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> ç®—æ³• </category>
          
      </categories>
      
      
        <tags>
            
            <tag> LeetCode </tag>
            
            <tag> ç®—æ³• </tag>
            
            <tag> äºŒå‰æ ‘ </tag>
            
            <tag> æ•°æ®ç»“æ„ </tag>
            
            <tag> Java </tag>
            
            <tag> DFS </tag>
            
            <tag> BFS </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ã€LeetCodeã€‘106. ä»ä¸­åºä¸ååºéå†åºåˆ—æ„é€ äºŒå‰æ ‘</title>
      <link href="/posts/16791.html"/>
      <url>/posts/16791.html</url>
      
        <content type="html"><![CDATA[<h1 id="1-é—®é¢˜"><a href="#1-é—®é¢˜" class="headerlink" title="1.é—®é¢˜"></a>1.é—®é¢˜</h1><p>ç»™å®šä¸¤ä¸ªæ•´æ•°æ•°ç»„ inorder å’Œ postorder ï¼Œå…¶ä¸­ inorder æ˜¯äºŒå‰æ ‘çš„ä¸­åºéå†ï¼Œ postorder æ˜¯åŒä¸€æ£µæ ‘çš„ååºéå†ï¼Œè¯·ä½ æ„é€ å¹¶è¿”å›è¿™é¢— äºŒå‰æ ‘ ã€‚</p><h2 id="ç¤ºä¾‹-1"><a href="#ç¤ºä¾‹-1" class="headerlink" title="ç¤ºä¾‹ 1"></a>ç¤ºä¾‹ 1</h2><p><img src="https://cdn.jsdelivr.net/gh/zyxelva/picgo@main/csdn/6684f6a9297c3ddb9a65007d5a25bd0d.jpeg"></p><blockquote><p>è¾“å…¥ï¼šinorder &#x3D; [9,3,15,20,7], postorder &#x3D; [9,15,7,20,3]<br>è¾“å‡ºï¼š[3,9,20,null,null,15,7]</p></blockquote><h2 id="ç¤ºä¾‹-2"><a href="#ç¤ºä¾‹-2" class="headerlink" title="ç¤ºä¾‹ 2"></a>ç¤ºä¾‹ 2</h2><blockquote><p>è¾“å…¥ï¼šinorder &#x3D; [-1], postorder &#x3D; [-1]<br>è¾“å‡ºï¼š[-1]</p></blockquote><p><strong>æç¤º</strong>:</p><ul><li>1 &lt;&#x3D; inorder.length &lt;&#x3D; 3000</li><li>postorder.length &#x3D;&#x3D; inorder.length</li><li>-3000 &lt;&#x3D; inorder[i], postorder[i] &lt;&#x3D; 3000</li><li>inorder å’Œ postorder éƒ½ç”± ä¸åŒ çš„å€¼ç»„æˆ</li><li>postorder ä¸­æ¯ä¸€ä¸ªå€¼éƒ½åœ¨ inorder ä¸­</li><li>inorder ä¿è¯æ˜¯æ ‘çš„ä¸­åºéå†</li><li>postorder ä¿è¯æ˜¯æ ‘çš„ååºéå†</li></ul><h1 id="2-è§£é¢˜æ€è·¯"><a href="#2-è§£é¢˜æ€è·¯" class="headerlink" title="2.è§£é¢˜æ€è·¯"></a>2.è§£é¢˜æ€è·¯</h1><p>å¯ä»¥å€Ÿé‰´<a href="https://zyxelva.github.io/posts/7980.html">ä»å‰åºä¸ä¸­åºéå†åºåˆ—æ„é€ äºŒå‰æ ‘</a>çš„æ€æƒ³ã€‚<br>åŒæ ·éœ€è¦å°†ä¸­åºçš„å€¼-ç´¢å¼•å…ˆå­˜å‚¨ã€‚<br>ç¬¬ä¸€ä¸ªèŠ‚ç‚¹ï¼ˆæ ¹èŠ‚ç‚¹ï¼‰åœ¨ååºåºåˆ—ä¸­ä¸º<code>postorder[postorder.length-1]</code>ï¼Œä»¤å…¶äºŒå‰æ ‘èŠ‚ç‚¹ä¸ºrootï¼Œindexä¸ºå…¶å€¼åœ¨ä¸­åºåºåˆ—çš„ç´¢å¼•ï¼Œåˆ™root.leftåœ¨ä¸­åºåºåˆ—çš„èŒƒå›´ï¼š<code>[inStart, index-1]</code>ï¼Œåœ¨ååºåºåˆ—çš„èŒƒå›´ï¼š<code>[postStart, postStart+index-inStart-1]</code>ï¼›è€Œroot.rightåœ¨ä¸­åºåºåˆ—çš„èŒƒå›´ï¼š<code>[index+1, inEnd]</code>ï¼Œåœ¨ååºåºåˆ—çš„èŒƒå›´ï¼š<code>[postStart+index-inStart, postEnd-1]</code>. å¦‚å›¾æ‰€ç¤ºï¼š<br><img src="https://cdn.jsdelivr.net/gh/zyxelva/picgo@main/csdn/a691e7e51145423980b265de5ddb4b20.png"><br>å…¶ä¸­leftSizeä¸º index-inStart.</p><p><img src="https://cdn.jsdelivr.net/gh/zyxelva/picgo@main/csdn/f28c407641fd4c4cb5f48511ecce78bd.png"></p><h1 id="3-ä»£ç "><a href="#3-ä»£ç " class="headerlink" title="3.ä»£ç "></a>3.ä»£ç </h1><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/** * Definition for a binary tree node. * public class TreeNode &#123; *     int val; *     TreeNode left; *     TreeNode right; *     TreeNode() &#123;&#125; *     TreeNode(int val) &#123; this.val = val; &#125; *     TreeNode(int val, TreeNode left, TreeNode right) &#123; *         this.val = val; *         this.left = left; *         this.right = right; *     &#125; * &#125; */</span><span class="token keyword">class</span> <span class="token class-name">Solution</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">private</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">></span></span> elementIndexMap<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token class-name">TreeNode</span> <span class="token function">buildTree</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> inorder<span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> postorder<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token operator">==</span>inorder<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token comment">//é¦–æ¬¡å…ˆéå†ä¸‹ä¸­åºï¼Œè®°å½•å„ä¸ªå…ƒç´ çš„ä½ç½®ï¼Œæ–¹ä¾¿å®šä½ååºæ•°ç»„ä¸­çš„å…ƒç´ åœ¨ä¸­åºæ•°æ®ä¸­çš„ä½ç½®ï¼ŒåŒºåˆ†å·¦å³å­æ ‘</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>elementIndexMap<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>inorder<span class="token punctuation">.</span>length<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>                elementIndexMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>inorder<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>        <span class="token comment">//ä»¥ä¸­åºåºåˆ—ä¸ºä¸»ï¼Œå°†æ ¹èŠ‚ç‚¹ä»ååºåºåˆ—æœ€åä¸€ä¸ªèŠ‚ç‚¹å–å‡ºï¼Œç¡®å®šå…¶åœ¨ä¸­åºä¸­çš„å®šä½ï¼Œç„¶ååˆ†ä¸ºå‰åä¸¤èŠ‚ç‚¹æ ‘ï¼Œæ ¹èŠ‚ç‚¹å‰ä¸ºå·¦å­æ ‘ï¼Œå…¶åä¸ºå³å­æ ‘</span>        <span class="token keyword">return</span> <span class="token function">buildTree2</span><span class="token punctuation">(</span>inorder<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>inorder<span class="token punctuation">.</span>length<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>postorder<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>postorder<span class="token punctuation">.</span>length<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">/**        inStart ä¸­åºå¼€å§‹ä¸‹æ ‡        inEnd ä¸­åºç»“æŸä¸‹æ ‡        postEnd ååºç»“æŸä¸‹æ ‡ï¼ˆæ ¹èŠ‚ç‚¹ï¼‰     */</span>    <span class="token keyword">private</span> <span class="token class-name">TreeNode</span> <span class="token function">buildTree2</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> inorder<span class="token punctuation">,</span><span class="token keyword">int</span> inStart<span class="token punctuation">,</span><span class="token keyword">int</span> inEnd<span class="token punctuation">,</span><span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> postorder<span class="token punctuation">,</span><span class="token keyword">int</span> postStart<span class="token punctuation">,</span> <span class="token keyword">int</span> postEnd<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>inStart<span class="token operator">></span>inEnd<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">int</span> rootValue<span class="token operator">=</span>postorder<span class="token punctuation">[</span>postEnd<span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token class-name">TreeNode</span> root<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">TreeNode</span><span class="token punctuation">(</span>rootValue<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">int</span> index<span class="token operator">=</span>elementIndexMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>rootValue<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">int</span> offset<span class="token operator">=</span>index<span class="token operator">-</span>inStart<span class="token punctuation">;</span>        <span class="token comment">//å·¦å­æ ‘-ä¸­åºæ•°ç»„ is = inStart, ie = index - 1</span>        <span class="token comment">//å·¦å­æ ‘-ååºæ•°ç»„ ps = postStart, pe = postStart + offset - 1</span>        root<span class="token punctuation">.</span>left<span class="token operator">=</span><span class="token function">buildTree2</span><span class="token punctuation">(</span>inorder<span class="token punctuation">,</span>inStart<span class="token punctuation">,</span> index<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> postorder<span class="token punctuation">,</span> postStart<span class="token punctuation">,</span> postStart<span class="token operator">+</span>offset<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">//å³å­æ ‘-ä¸­åºæ•°ç»„ is = index+1, ie = inEnd</span>        <span class="token comment">//å³å­æ ‘-ååºæ•°ç»„ ps = postStart+offset, pe = postEnd - 1</span>        root<span class="token punctuation">.</span>right<span class="token operator">=</span><span class="token function">buildTree2</span><span class="token punctuation">(</span>inorder<span class="token punctuation">,</span>index<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span>inEnd<span class="token punctuation">,</span>postorder<span class="token punctuation">,</span> postStart<span class="token operator">+</span>offset<span class="token punctuation">,</span>postEnd<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> root<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> ç®—æ³• </category>
          
      </categories>
      
      
        <tags>
            
            <tag> LeetCode </tag>
            
            <tag> ç®—æ³• </tag>
            
            <tag> äºŒå‰æ ‘ </tag>
            
            <tag> æ•°æ®ç»“æ„ </tag>
            
            <tag> Java </tag>
            
            <tag> DFS </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ã€LeetCodeã€‘105. ä»å‰åºä¸ä¸­åºéå†åºåˆ—æ„é€ äºŒå‰æ ‘</title>
      <link href="/posts/7980.html"/>
      <url>/posts/7980.html</url>
      
        <content type="html"><![CDATA[<h1 id="1-é—®é¢˜"><a href="#1-é—®é¢˜" class="headerlink" title="1.é—®é¢˜"></a>1.é—®é¢˜</h1><p>ç»™å®šä¸¤ä¸ªæ•´æ•°æ•°ç»„ preorder å’Œ inorder ï¼Œå…¶ä¸­ preorder æ˜¯äºŒå‰æ ‘çš„å…ˆåºéå†ï¼Œ inorder æ˜¯åŒä¸€æ£µæ ‘çš„ä¸­åºéå†ï¼Œè¯·æ„é€ äºŒå‰æ ‘å¹¶è¿”å›å…¶æ ¹èŠ‚ç‚¹ã€‚</p><h2 id="ç¤ºä¾‹-1"><a href="#ç¤ºä¾‹-1" class="headerlink" title="ç¤ºä¾‹ 1"></a>ç¤ºä¾‹ 1</h2><p><img src="https://cdn.jsdelivr.net/gh/zyxelva/picgo@main/csdn/27dd53a0ee432768036d5aa0547dc126.jpeg" alt="ç¤ºä¾‹ 1"></p><blockquote><p>è¾“å…¥: preorder &#x3D; [3,9,20,15,7], inorder &#x3D; [9,3,15,20,7]<br>è¾“å‡º: [3,9,20,null,null,15,7]</p></blockquote><p>ç¤ºä¾‹ 2:</p><blockquote><p>è¾“å…¥: preorder &#x3D; [-1], inorder &#x3D; [-1]<br>è¾“å‡º: [-1]</p></blockquote><p><strong>æç¤º</strong>:</p><ul><li>1 &lt;&#x3D; preorder.length &lt;&#x3D; 3000</li><li>inorder.length &#x3D;&#x3D; preorder.length</li><li>-3000 &lt;&#x3D; preorder[i], inorder[i] &lt;&#x3D; 3000</li><li>preorder å’Œ inorder å‡ æ— é‡å¤ å…ƒç´ </li><li>inorder å‡å‡ºç°åœ¨ preorder</li><li>preorder ä¿è¯ ä¸ºäºŒå‰æ ‘çš„å‰åºéå†åºåˆ—</li><li>inorder ä¿è¯ ä¸ºäºŒå‰æ ‘çš„ä¸­åºéå†åºåˆ—</li></ul><h1 id="2-è§£é¢˜æ€è·¯"><a href="#2-è§£é¢˜æ€è·¯" class="headerlink" title="2.è§£é¢˜æ€è·¯"></a>2.è§£é¢˜æ€è·¯</h1><p>ä»¥å‰åºåºåˆ—[1,2,5,4,6,7,3,8,9]ï¼Œä¸­åºåºåˆ—[5,2,6,4,7,4,3,8,9]ä¸ºä¾‹ï¼Œå…ˆè§‚å¯Ÿå„è‡ªåºåˆ—çš„ç‰¹å¾ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š<br><img src="https://cdn.jsdelivr.net/gh/zyxelva/picgo@main/csdn/18c55fed555c47d2f76dbbed87d615bc.png"><br>ä»¤indexä¸ºæ ¹èŠ‚ç‚¹rootåœ¨ä¸­åºåºåˆ—ä¸­çš„ç´¢å¼•ä½ç½®ï¼Œåˆ™root.leftåœ¨å‰åºåºåˆ—çš„èŒƒå›´ä¸ºï¼š[preStart+1, preStart+index-inStart]ï¼Œåœ¨ä¸­åºåºåˆ—çš„èŒƒå›´ä¸ºï¼š[inStart, index-1]ï¼›è€Œroot.rightåœ¨å‰åºä¸­çš„èŒƒå›´ä¸ºï¼š[preStart+index-inStart+1, preEnd] ï¼Œåœ¨ä¸­åºåºåˆ—çš„èŒƒå›´ä¸ºï¼š[index+1, inEnd].<br><img src="https://cdn.jsdelivr.net/gh/zyxelva/picgo@main/csdn/4dbe56291c5c4e7cc2a12cb042025497.png"><br>è€Œåœ¨ç®—æ³•å¼€å§‹å‰ï¼Œéœ€è¦éå†ä¸­åºåºåˆ—ï¼Œå­˜å‚¨å„ä¸ªèŠ‚ç‚¹åœ¨ä¸­åºåºåˆ—çš„ç´¢å¼•ï¼Œæ–¹ä¾¿åç»­æ ¹èŠ‚ç‚¹å®šä½ä»¥åŠåç§»é‡çš„è®¡ç®—ã€‚<br>å› è€Œï¼Œåˆ©ç”¨é€’å½’æ€æƒ³ï¼Œå°±å¯ä»¥æ„é€ å‡ºæ‰€éœ€çš„äºŒå‰æ ‘ã€‚</p><p><strong>å¤æ‚åº¦åˆ†æ</strong></p><ul><li><p>æ—¶é—´å¤æ‚åº¦ï¼šO(n)ï¼Œå…¶ä¸­ n æ˜¯æ ‘ä¸­çš„èŠ‚ç‚¹ä¸ªæ•°ã€‚</p></li><li><p>ç©ºé—´å¤æ‚åº¦ï¼šO(n)ï¼Œé™¤å»è¿”å›çš„ç­”æ¡ˆéœ€è¦çš„ O(n) ç©ºé—´ä¹‹å¤–ï¼Œè¿˜éœ€è¦ä½¿ç”¨ O(n) çš„ç©ºé—´å­˜å‚¨å“ˆå¸Œæ˜ å°„ï¼Œä»¥åŠ O(h)ï¼ˆå…¶ä¸­ h æ˜¯æ ‘çš„é«˜åº¦ï¼‰çš„ç©ºé—´è¡¨ç¤ºé€’å½’æ—¶æ ˆç©ºé—´ã€‚è¿™é‡Œ h&lt;nï¼Œæ‰€ä»¥æ€»ç©ºé—´å¤æ‚åº¦ä¸º O(n)ã€‚</p></li></ul><h1 id="3-ä»£ç "><a href="#3-ä»£ç " class="headerlink" title="3.ä»£ç "></a>3.ä»£ç </h1><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/** * Definition for a binary tree node. * public class TreeNode &#123; *     int val; *     TreeNode left; *     TreeNode right; *     TreeNode() &#123;&#125; *     TreeNode(int val) &#123; this.val = val; &#125; *     TreeNode(int val, TreeNode left, TreeNode right) &#123; *         this.val = val; *         this.left = left; *         this.right = right; *     &#125; * &#125; */</span><span class="token keyword">class</span> <span class="token class-name">Solution</span> <span class="token punctuation">&#123;</span>    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">></span></span> valueIndexMap<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token class-name">TreeNode</span> <span class="token function">buildTree</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> preorder<span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> inorder<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token comment">//è®°å½•ä¸­åºä¸­ å„å…ƒç´ å€¼ä¸ç´¢å¼•çš„æ˜ å°„å…³ç³»</span>        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>inorder<span class="token punctuation">.</span>length<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            valueIndexMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>inorder<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">return</span> <span class="token function">build</span><span class="token punctuation">(</span>preorder<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> preorder<span class="token punctuation">.</span>length<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> inorder<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> inorder<span class="token punctuation">.</span>length<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">private</span> <span class="token class-name">TreeNode</span> <span class="token function">build</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> preorder<span class="token punctuation">,</span> <span class="token keyword">int</span> preStart<span class="token punctuation">,</span> <span class="token keyword">int</span> preEnd<span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> inorder<span class="token punctuation">,</span> <span class="token keyword">int</span> inStart<span class="token punctuation">,</span> <span class="token keyword">int</span> inEnd<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>inStart<span class="token operator">></span>inEnd <span class="token operator">||</span> preStart<span class="token operator">></span>preEnd<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token comment">//æ ¹èŠ‚ç‚¹</span>        <span class="token class-name">TreeNode</span> root<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">TreeNode</span><span class="token punctuation">(</span>preorder<span class="token punctuation">[</span>preStart<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">//æ ¹èŠ‚ç‚¹åœ¨ä¸­åºä¸­çš„ä½ç½®</span>        <span class="token keyword">int</span> rootIndex<span class="token operator">=</span>valueIndexMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>root<span class="token punctuation">.</span>val<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">//åç§»é‡</span>        <span class="token keyword">int</span> offset<span class="token operator">=</span>rootIndex<span class="token operator">-</span>inStart<span class="token punctuation">;</span>        <span class="token comment">//å·¦å­æ ‘</span>        root<span class="token punctuation">.</span>left<span class="token operator">=</span><span class="token function">build</span><span class="token punctuation">(</span>preorder<span class="token punctuation">,</span> preStart<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span> preStart<span class="token operator">+</span>offset<span class="token punctuation">,</span> inorder<span class="token punctuation">,</span> inStart<span class="token punctuation">,</span> rootIndex<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">//å³å­æ ‘</span>        root<span class="token punctuation">.</span>right<span class="token operator">=</span><span class="token function">build</span><span class="token punctuation">(</span>preorder<span class="token punctuation">,</span> preStart<span class="token operator">+</span>offset<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span> preEnd<span class="token punctuation">,</span> inorder<span class="token punctuation">,</span> rootIndex<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span> inEnd<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> root<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> ç®—æ³• </category>
          
      </categories>
      
      
        <tags>
            
            <tag> LeetCode </tag>
            
            <tag> ç®—æ³• </tag>
            
            <tag> äºŒå‰æ ‘ </tag>
            
            <tag> æ•°æ®ç»“æ„ </tag>
            
            <tag> Java </tag>
            
            <tag> DFS </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ã€Hexoã€‘åŸºäºFluidä¸»é¢˜çš„Hexoå¢åŠ ç›¸å†ŒåŠŸèƒ½å®è·µ</title>
      <link href="/posts/45280.html"/>
      <url>/posts/45280.html</url>
      
        <content type="html"><![CDATA[<p>æœ¬æ–‡æ˜¯åŸºäºHexo 6.3.0, Fluid 1.9.4è¿›è¡Œå¼€å‘ï¼Œä¸»è¦å€Ÿé‰´äº<a href="https://gishai.top/blog/posts/798ba833.html">hexoçš„fluidä¸»é¢˜æ·»åŠ ç€‘å¸ƒæµæ‡’åŠ è½½ç›¸å†ŒåŠŸèƒ½</a>ï¼Œå…¶ä¸­åŸºäº<a href="https://zhuanlan.zhihu.com/p/346643522">jsDelivr+Github å®ç°å…è´¹CDNåŠ é€Ÿ</a>å¯ä»¥å‚è€ƒè¿™ç¯‡æ–‡ç« æ­å»ºè‡ªå·±çš„CDNã€‚</p><h1 id="1-åˆ›å»ºç›¸å†Œé¡µé¢"><a href="#1-åˆ›å»ºç›¸å†Œé¡µé¢" class="headerlink" title="1.åˆ›å»ºç›¸å†Œé¡µé¢"></a>1.åˆ›å»ºç›¸å†Œé¡µé¢</h1><ul><li>åœ¨è‡ªå·±çš„åšå®¢é¡¹ç›®ä¸‹ï¼Œæ–°å»ºç›¸å†Œé¡µ<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">hexo new page photos<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li><li>ç¼–è¾‘ &#x2F;source&#x2F;photos&#x2F;index.mdï¼Œè¾“å…¥ä»¥ä¸‹å†…å®¹<pre class="line-numbers language-markdown" data-language="markdown"><code class="language-markdown"><span class="token front-matter-block"><span class="token punctuation">---</span><span class="token front-matter yaml language-yaml"><span class="token key atrule">title</span><span class="token punctuation">:</span> photos<span class="token key atrule">date</span><span class="token punctuation">:</span> <span class="token datetime number">2020-12-30 19:04:03</span><span class="token key atrule">layout</span><span class="token punctuation">:</span> photo</span><span class="token punctuation">---</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>style</span><span class="token punctuation">></span></span><span class="token style"><span class="token language-css"><span class="token selector">.ImageGrid</span> <span class="token punctuation">&#123;</span>  <span class="token property">width</span><span class="token punctuation">:</span> 100%<span class="token punctuation">;</span>  <span class="token property">max-width</span><span class="token punctuation">:</span> 1040px<span class="token punctuation">;</span>  <span class="token property">margin</span><span class="token punctuation">:</span> 0 auto<span class="token punctuation">;</span>  <span class="token property">text-align</span><span class="token punctuation">:</span> center<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token selector">.card</span> <span class="token punctuation">&#123;</span>  <span class="token property">overflow</span><span class="token punctuation">:</span> hidden<span class="token punctuation">;</span>  <span class="token property">transition</span><span class="token punctuation">:</span> .3s ease-in-out<span class="token punctuation">;</span>  <span class="token property">border-radius</span><span class="token punctuation">:</span> 8px<span class="token punctuation">;</span>  <span class="token property">background-color</span><span class="token punctuation">:</span> #efefef<span class="token punctuation">;</span>  <span class="token property">padding</span><span class="token punctuation">:</span> 1.4px<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token selector">.ImageInCard img</span> <span class="token punctuation">&#123;</span>  <span class="token property">padding</span><span class="token punctuation">:</span> 0<span class="token punctuation">;</span>  <span class="token property">border-radius</span><span class="token punctuation">:</span> 8px<span class="token punctuation">;</span>  <span class="token property">width</span><span class="token punctuation">:</span>100%<span class="token punctuation">;</span>  <span class="token property">height</span><span class="token punctuation">:</span>100%<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token atrule"><span class="token rule">@media</span> <span class="token punctuation">(</span><span class="token property">prefers-color-scheme</span><span class="token punctuation">:</span> dark<span class="token punctuation">)</span></span> <span class="token punctuation">&#123;</span>  <span class="token selector">.card</span> <span class="token punctuation">&#123;</span><span class="token property">background-color</span><span class="token punctuation">:</span> #333<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>style</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>imageTab<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>ImageGrid<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ul><h1 id="2-å¤„ç†å›¾ç‰‡ä¿¡æ¯"><a href="#2-å¤„ç†å›¾ç‰‡ä¿¡æ¯" class="headerlink" title="2.å¤„ç†å›¾ç‰‡ä¿¡æ¯"></a>2.å¤„ç†å›¾ç‰‡ä¿¡æ¯</h1><p>è¿™é‡Œéœ€è¦åˆ›å»ºè‡ªå·±çš„githubç›¸å†Œï¼Œå¯å‚è€ƒè¿™ç¯‡æ–‡ç« <a href="https://zhuanlan.zhihu.com/p/346643522">jsDelivr+Github å®ç°å…è´¹CDNåŠ é€Ÿ</a>ã€‚</p><p>è¿™é‡Œä¸»è¦æ˜¯ä¸ºäº†åŠ å¿«å›¾ç‰‡çš„åŠ è½½é€Ÿåº¦, åˆ©ç”¨GitHub +jsDelivrçš„æ–¹å¼ï¼Œæ­¤å¤„ä¸å†æ¼”ç¤ºã€‚æ–‡ä»¶å¤¹ç»“æ„å¦‚å›¾:</p><p><img src="https://gishai.top/blog/posts/798ba833/image-20210110205814315.png"></p><p>è¿™é‡Œæ²¡æœ‰å®‰è£… image-sizeï¼Œéœ€è¦npmå®‰è£…ä¸‹</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">npm</span> i <span class="token parameter variable">-S</span> image-size<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>åœ¨githubç›¸å†Œç›®å½•ä¸‹ï¼Œæ‰§è¡Œcreatejsï¼Œè„šæœ¬å¦‚ä¸‹ï¼š</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs-extra'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">const</span> imageSize <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'image-size'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">const</span> rootPath<span class="token operator">=</span><span class="token string">"gallery/"</span>   <span class="token comment">//ç›¸å†Œç›¸å¯¹è·¯å¾„ï¼Œä¹Ÿå¯å¡«ç»å¯¹è·¯å¾„ï¼ŒæŒ‡å‘ç›¸å†Œçš„ç›®å½•ï¼Œç›®çš„ä¸ºäº†ç”Ÿæˆjson</span><span class="token keyword">class</span> <span class="token class-name">PhotoExtension</span> <span class="token punctuation">&#123;</span>    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>size <span class="token operator">=</span> <span class="token number">64</span><span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>offset <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">class</span> <span class="token class-name">Photo</span> <span class="token punctuation">&#123;</span>    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>dirName <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>fileName <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>iconID <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>extension <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PhotoExtension</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">class</span> <span class="token class-name">PhotoGroup</span> <span class="token punctuation">&#123;</span>    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>children <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">function</span> <span class="token function">createPlotIconsData</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">let</span> allPlots <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token keyword">let</span> allPlotGroups <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token keyword">const</span> plotJsonFile <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'./photosInfo.json'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">const</span> plotGroupJsonFile <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'./photos.json'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>fs<span class="token punctuation">.</span><span class="token function">existsSync</span><span class="token punctuation">(</span>plotJsonFile<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        allPlots <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span>plotJsonFile<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>fs<span class="token punctuation">.</span><span class="token function">existsSync</span><span class="token punctuation">(</span>plotGroupJsonFile<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        allPlotGroups <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span>plotGroupJsonFile<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    fs<span class="token punctuation">.</span><span class="token function">readdirSync</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">dirName</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">const</span> stats <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">statSync</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> dirName<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">const</span> isDir <span class="token operator">=</span> stats<span class="token punctuation">.</span><span class="token function">isDirectory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>isDir<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">const</span> subfiles <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">readdirSync</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> dirName<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            subfiles<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">subfileName</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                <span class="token comment">// å¦‚æœå·²ç»å­˜åœ¨ åˆ™ä¸å†å¤„ç†</span>                <span class="token comment">// if (allPlots.find(o => o.fileName === subfileName &amp;&amp; o.dirName === dirName)) &#123;</span>                <span class="token comment">//     return;</span>                <span class="token comment">// &#125;</span>                <span class="token comment">// æ–°å¢æ ‡</span>                <span class="token keyword">const</span> plot <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Photo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                plot<span class="token punctuation">.</span>dirName <span class="token operator">=</span> dirName<span class="token punctuation">;</span>                plot<span class="token punctuation">.</span>fileName <span class="token operator">=</span> subfileName<span class="token punctuation">;</span>                <span class="token keyword">const</span> imageInfo <span class="token operator">=</span> <span class="token function">imageSize</span><span class="token punctuation">(</span>rootPath<span class="token operator">+</span>dirName <span class="token operator">+</span> <span class="token string">"/"</span> <span class="token operator">+</span> subfileName<span class="token punctuation">)</span><span class="token punctuation">;</span>                plot<span class="token punctuation">.</span>iconID <span class="token operator">=</span> imageInfo<span class="token punctuation">.</span>width <span class="token operator">+</span> <span class="token string">'.'</span> <span class="token operator">+</span> imageInfo<span class="token punctuation">.</span>height <span class="token operator">+</span> <span class="token string">' '</span> <span class="token operator">+</span> subfileName<span class="token punctuation">;</span>                allPlots<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>plot<span class="token punctuation">)</span><span class="token punctuation">;</span>                console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">RD: createPlotIconsData -> new plot</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> plot<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment">// ä¸ºæ–°å¢æ ‡æ·»åŠ åˆ†ç»„ æš‚æ—¶ä»¥å®ƒæ‰€å¤„çš„æ–‡ä»¶å¤¹ä¸ºåˆ†ç»„</span>                <span class="token keyword">let</span> group <span class="token operator">=</span> allPlotGroups<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token parameter">o</span> <span class="token operator">=></span> o<span class="token punctuation">.</span>name <span class="token operator">===</span> dirName<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>group<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                    group <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PhotoGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    group<span class="token punctuation">.</span>name <span class="token operator">=</span> dirName<span class="token punctuation">;</span>                    allPlotGroups<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>group<span class="token punctuation">)</span><span class="token punctuation">;</span>                    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">RD: createPlotIconsData -> new group</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> group<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">&#125;</span>                group<span class="token punctuation">.</span>children<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>plot<span class="token punctuation">.</span>iconID<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    fs<span class="token punctuation">.</span><span class="token function">writeJSONSync</span><span class="token punctuation">(</span>plotJsonFile<span class="token punctuation">,</span> allPlots<span class="token punctuation">)</span><span class="token punctuation">;</span>    fs<span class="token punctuation">.</span><span class="token function">writeJSONSync</span><span class="token punctuation">(</span>plotGroupJsonFile<span class="token punctuation">,</span> allPlotGroups<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token function">createPlotIconsData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å°†photos.jsonæ‹·è´åˆ°åšå®¢ç›®å½•ä¸‹çš„photos<br><img src="https://gishai.top/blog/posts/798ba833/image-20210110210639345.png"></p><h1 id="3-åŠ è½½-jså’Œcssæ–‡ä»¶"><a href="#3-åŠ è½½-jså’Œcssæ–‡ä»¶" class="headerlink" title="3.åŠ è½½ jså’Œcssæ–‡ä»¶"></a>3.åŠ è½½ jså’Œcssæ–‡ä»¶</h1><p>åœ¨ &#x2F;source&#x2F;js&#x2F; ç›®å½•ä¸‹åˆ›å»º photoWall.js</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">var</span> imgDataPath <span class="token operator">=</span> <span class="token string">"/blog/photos/photos.json"</span><span class="token punctuation">;</span> <span class="token comment">//å›¾ç‰‡åç§°é«˜å®½ä¿¡æ¯jsonæ–‡ä»¶è·¯å¾„</span><span class="token keyword">var</span> imgPath <span class="token operator">=</span> <span class="token string">"https://cdn.jsdelivr.net/gh/Cenergy/images/gallery/"</span><span class="token punctuation">;</span> <span class="token comment">//å›¾ç‰‡è®¿é—®è·¯å¾„, è¿™é‡Œå‚è€ƒæ–‡ç« å¼€å¤´æåˆ°çš„CDNåŠ é€Ÿ</span><span class="token keyword">var</span> imgMaxNum <span class="token operator">=</span> <span class="token number">50</span><span class="token punctuation">;</span> <span class="token comment">//å›¾ç‰‡æ˜¾ç¤ºæ•°é‡</span><span class="token keyword">var</span> windowWidth <span class="token operator">=</span>  window<span class="token punctuation">.</span>innerWidth <span class="token operator">||</span>  document<span class="token punctuation">.</span>documentElement<span class="token punctuation">.</span>clientWidth <span class="token operator">||</span>  document<span class="token punctuation">.</span>body<span class="token punctuation">.</span>clientWidth<span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>windowWidth <span class="token operator">&lt;</span> <span class="token number">768</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">var</span> imageWidth <span class="token operator">=</span> <span class="token number">145</span><span class="token punctuation">;</span> <span class="token comment">//å›¾ç‰‡æ˜¾ç¤ºå®½åº¦(æ‰‹æœºç«¯)</span><span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">var</span> imageWidth <span class="token operator">=</span> <span class="token number">250</span><span class="token punctuation">;</span> <span class="token comment">//å›¾ç‰‡æ˜¾ç¤ºå®½åº¦</span><span class="token punctuation">&#125;</span><span class="token keyword">const</span> photo <span class="token operator">=</span> <span class="token punctuation">&#123;</span>  <span class="token literal-property property">page</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>  <span class="token literal-property property">offset</span><span class="token operator">:</span> imgMaxNum<span class="token punctuation">,</span>  <span class="token function-variable function">init</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">var</span> that <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>    $<span class="token punctuation">.</span><span class="token function">getJSON</span><span class="token punctuation">(</span>imgDataPath<span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      that<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span>that<span class="token punctuation">.</span>page<span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment">//that.scroll(data);</span>      that<span class="token punctuation">.</span><span class="token function">eventListen</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>  <span class="token function">constructHtml</span><span class="token punctuation">(</span><span class="token parameter">options</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">const</span> <span class="token punctuation">&#123;</span>      imageWidth<span class="token punctuation">,</span>      imageX<span class="token punctuation">,</span>      imageY<span class="token punctuation">,</span>      name<span class="token punctuation">,</span>      imgPath<span class="token punctuation">,</span>      imgName<span class="token punctuation">,</span>      imgNameWithPattern<span class="token punctuation">,</span>    <span class="token punctuation">&#125;</span> <span class="token operator">=</span> options<span class="token punctuation">;</span>    <span class="token keyword">const</span> htmlEle <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;div class="card lozad" style="width:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>imageWidth<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">px">                  &lt;div class="ImageInCard" style="height:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>                    <span class="token punctuation">(</span>imageWidth <span class="token operator">*</span> imageY<span class="token punctuation">)</span> <span class="token operator">/</span> imageX                  <span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">px">                    &lt;a data-fancybox="gallery" href="</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>imgPath<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>name<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>imgNameWithPattern<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">"                          data-caption="</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>imgName<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">" title="</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>imgName<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">">                            &lt;img  class="lazyload" data-src="</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>imgPath<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>name<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>imgNameWithPattern<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">"                            src="data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="                            onload="lzld(this)"                            lazyload="auto">                        &lt;/a>                  &lt;/div>                &lt;/div></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>    <span class="token keyword">return</span> htmlEle<span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>  <span class="token function-variable function">render</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">page<span class="token punctuation">,</span> data <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span></span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>data <span class="token operator">=</span> data<span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>data<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>    <span class="token keyword">var</span> html<span class="token punctuation">,</span>      imgNameWithPattern<span class="token punctuation">,</span>      imgName<span class="token punctuation">,</span>      imageSize<span class="token punctuation">,</span>      imageX<span class="token punctuation">,</span>      imageY<span class="token punctuation">,</span>      li <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span>    <span class="token keyword">let</span> liHtml <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span>    <span class="token keyword">let</span> contentHtml <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span>    data<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item<span class="token punctuation">,</span> index</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>      <span class="token keyword">const</span> activeClass <span class="token operator">=</span> index <span class="token operator">===</span> <span class="token number">0</span> <span class="token operator">?</span> <span class="token string">"active"</span> <span class="token operator">:</span> <span class="token string">""</span><span class="token punctuation">;</span>      liHtml <span class="token operator">+=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;li class="nav-item" role="presentation">          &lt;a class="nav-link </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>activeClass<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string"> photo-tab" id="home-tab" photo-uuid="</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>item<span class="token punctuation">.</span>name<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">" data-toggle="tab" href="#</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>item<span class="token punctuation">.</span>name<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">"  role="tab" aria-controls="</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>item<span class="token punctuation">.</span>name<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">" aria-selected="true"></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>item<span class="token punctuation">.</span>name<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">&lt;/a>        &lt;/li></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">const</span> <span class="token punctuation">[</span>initData <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">]</span> <span class="token operator">=</span> data<span class="token punctuation">;</span>    <span class="token keyword">const</span> <span class="token punctuation">&#123;</span> children <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>name <span class="token punctuation">&#125;</span> <span class="token operator">=</span> initData<span class="token punctuation">;</span>    children<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item<span class="token punctuation">,</span> index</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>      imgNameWithPattern <span class="token operator">=</span> item<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">" "</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>      imgName <span class="token operator">=</span> imgNameWithPattern<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">"."</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>      imageSize <span class="token operator">=</span> item<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">" "</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>      imageX <span class="token operator">=</span> imageSize<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">"."</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>      imageY <span class="token operator">=</span> imageSize<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">"."</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>      <span class="token keyword">let</span> imgOptions <span class="token operator">=</span> <span class="token punctuation">&#123;</span>        imageWidth<span class="token punctuation">,</span>        imageX<span class="token punctuation">,</span>        imageY<span class="token punctuation">,</span>        name<span class="token punctuation">,</span>        imgName<span class="token punctuation">,</span>        imgPath<span class="token punctuation">,</span>        imgNameWithPattern<span class="token punctuation">,</span>      <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>      li <span class="token operator">+=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">constructHtml</span><span class="token punctuation">(</span>imgOptions<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    contentHtml <span class="token operator">+=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string"> &lt;div class="tab-pane fade show active"  role="tabpanel" aria-labelledby="home-tab"></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>li<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">&lt;/div></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>    <span class="token keyword">const</span> ulHtml <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;ul class="nav nav-tabs" id="myTab" role="tablist"></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>liHtml<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">&lt;/ul></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>    <span class="token keyword">const</span> tabContent <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;div class="tab-content" id="myTabContent"></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>contentHtml<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">&lt;/div></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>    <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">"#imageTab"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>ulHtml<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">".ImageGrid"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>tabContent<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">minigrid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>  <span class="token function-variable function">eventListen</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">let</span> self <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>    <span class="token keyword">var</span> html<span class="token punctuation">,</span>      imgNameWithPattern<span class="token punctuation">,</span>      imgName<span class="token punctuation">,</span>      imageSize<span class="token punctuation">,</span>      imageX<span class="token punctuation">,</span>      imageY<span class="token punctuation">,</span>      li <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span>    <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'a[data-toggle="tab"]'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">"shown.bs.tab"</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">".ImageGrid"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">const</span> selectId <span class="token operator">=</span> <span class="token function">$</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>target<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">attr</span><span class="token punctuation">(</span><span class="token string">"photo-uuid"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">const</span> selectedData <span class="token operator">=</span> data<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token operator">=></span> data<span class="token punctuation">.</span>name <span class="token operator">===</span> selectId<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>      <span class="token keyword">const</span> <span class="token punctuation">&#123;</span> children<span class="token punctuation">,</span>name <span class="token punctuation">&#125;</span> <span class="token operator">=</span> selectedData<span class="token punctuation">;</span>      <span class="token keyword">let</span> li <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span>      children<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item<span class="token punctuation">,</span> index</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>        imgNameWithPattern <span class="token operator">=</span> item<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">" "</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>        imgName <span class="token operator">=</span> imgNameWithPattern<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">"."</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>        imageSize <span class="token operator">=</span> item<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">" "</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>        imageX <span class="token operator">=</span> imageSize<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">"."</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>        imageY <span class="token operator">=</span> imageSize<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">"."</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token keyword">let</span> imgOptions <span class="token operator">=</span> <span class="token punctuation">&#123;</span>          imageWidth<span class="token punctuation">,</span>          imageX<span class="token punctuation">,</span>          imageY<span class="token punctuation">,</span>          name<span class="token punctuation">,</span>          imgName<span class="token punctuation">,</span>          imgPath<span class="token punctuation">,</span>          imgNameWithPattern<span class="token punctuation">,</span>        <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>        li <span class="token operator">+=</span> self<span class="token punctuation">.</span><span class="token function">constructHtml</span><span class="token punctuation">(</span>imgOptions<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">".ImageGrid"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>li<span class="token punctuation">)</span><span class="token punctuation">;</span>      self<span class="token punctuation">.</span><span class="token function">minigrid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>  <span class="token function-variable function">minigrid</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">var</span> grid <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Minigrid</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>      <span class="token literal-property property">container</span><span class="token operator">:</span> <span class="token string">".ImageGrid"</span><span class="token punctuation">,</span>      <span class="token literal-property property">item</span><span class="token operator">:</span> <span class="token string">".card"</span><span class="token punctuation">,</span>      <span class="token literal-property property">gutter</span><span class="token operator">:</span> <span class="token number">12</span><span class="token punctuation">,</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    grid<span class="token punctuation">.</span><span class="token function">mount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">$</span><span class="token punctuation">(</span>window<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">resize</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      grid<span class="token punctuation">.</span><span class="token function">mount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>photo<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ç„¶åä½¿ç”¨æ³¨å†Œå™¨å°†éœ€è¦çš„js,cssæ³¨å…¥,åœ¨scripts&#x2F;injector.js(å¦‚æ²¡æœ‰,åˆ™åˆ›å»º)ä¸­è¾“å…¥ä»¥ä¸‹å†…å®¹</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">root</span><span class="token operator">:</span> siteRoot <span class="token operator">=</span> <span class="token string">"/"</span> <span class="token punctuation">&#125;</span> <span class="token operator">=</span> hexo<span class="token punctuation">.</span>config<span class="token punctuation">;</span><span class="token comment">// layoutä¸ºphotoçš„æ—¶å€™å¯¼å…¥è¿™äº›jsä¸css</span>hexo<span class="token punctuation">.</span>extend<span class="token punctuation">.</span>injector<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span>  <span class="token string">"body_end"</span><span class="token punctuation">,</span>  <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">  &lt;link rel="stylesheet" href="https://cdn.staticfile.org/fancybox/3.5.7/jquery.fancybox.min.css">  &lt;script src="//cdn.jsdelivr.net/npm/minigrid@3.1.1/dist/minigrid.min.js">&lt;/script>  &lt;script src="https://cdn.staticfile.org/fancybox/3.5.7/jquery.fancybox.min.js">&lt;/script>&lt;script src="https://cdn.bootcdn.net/ajax/libs/lazyloadjs/3.2.2/lazyload.js">&lt;/script>    &lt;script defer src="</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>siteRoot<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">js/photoWall.js">&lt;/script></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>  <span class="token string">"photo"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æœ€å hexo clean &amp;&amp; hexo g &amp;&amp; hexo sï¼Œæœ¬åœ°éƒ¨ç½²çœ‹çœ‹æ•ˆæœã€‚</p><p><strong>æç¤º</strong>ï¼š<br>GitHub +jsDelivr æœŸåˆåŠ è½½æœ‰ç‚¹æ…¢ï¼Œè¦ç­‰å¥½å‡ åˆ†é’Ÿï¼Œæ‰€æœ‰å›¾æ‰æœ‰åŠ é€Ÿï¼Œä¸è¦è¯¯ä»¥ä¸ºæ˜¯å…¶ä»–é—®é¢˜ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> Hexoä¸»é¢˜ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Hexo </tag>
            
            <tag> Fluid </tag>
            
            <tag> ç›¸å†Œ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ã€Hexoã€‘HexoåŸºäºFluidä¸»é¢˜å›ºå®šèƒŒæ™¯å›¾ç‰‡</title>
      <link href="/posts/5155.html"/>
      <url>/posts/5155.html</url>
      
        <content type="html"><![CDATA[<p>æœ¬æ–‡åŸºäºFluidä¸»é¢˜ï¼Œè®¾ç½®å›ºå®šèƒŒæ™¯ã€‚</p><p>åšå®¢çš„æ ¹ç›®å½•ä¸º <code>~/blog</code>ï¼Œä¸»é¢˜è§£å‹ä½ç½®ä¸º <code>~/blog/themes/fluid</code></p><p>æ¥ä¸‹æ¥åˆ›å»ºä¸‰ä¸ªæ–‡ä»¶</p><h1 id="ä¸€ã€åˆ›å»º-injector-js-æ–‡ä»¶"><a href="#ä¸€ã€åˆ›å»º-injector-js-æ–‡ä»¶" class="headerlink" title="ä¸€ã€åˆ›å»º injector.js æ–‡ä»¶"></a>ä¸€ã€åˆ›å»º <code>injector.js</code> æ–‡ä»¶</h1><p>è¿›å…¥ <code>~/blog/themes/fluid/scripts</code> åˆ›å»º <code>injector.js</code> æ–‡ä»¶</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// å…¨å±èƒŒæ™¯çš„éœ€è¦å¯¼å…¥è¿™äº›js</span><span class="token keyword">const</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">root</span><span class="token operator">:</span> siteRoot <span class="token operator">=</span> <span class="token string">"/themes/fluid/source/"</span> <span class="token punctuation">&#125;</span> <span class="token operator">=</span> hexo<span class="token punctuation">.</span>config<span class="token punctuation">;</span>hexo<span class="token punctuation">.</span>extend<span class="token punctuation">.</span>injector<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span><span class="token string">"body_begin"</span><span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;div id="web_bg">&lt;/div></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>hexo<span class="token punctuation">.</span>extend<span class="token punctuation">.</span>injector<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span>  <span class="token string">"body_end"</span><span class="token punctuation">,</span>  <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;script src="</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>siteRoot<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">js/backgroundize.js">&lt;/script>  &lt;link defer rel="stylesheet" href="</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>siteRoot<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">css/backgroundize.css" />  </span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h1 id="äºŒã€åˆ›å»º-backgroundize-js-æ–‡ä»¶"><a href="#äºŒã€åˆ›å»º-backgroundize-js-æ–‡ä»¶" class="headerlink" title="äºŒã€åˆ›å»º backgroundize.js æ–‡ä»¶"></a>äºŒã€åˆ›å»º <code>backgroundize.js</code> æ–‡ä»¶</h1><p>è¿›å…¥ <code>~/blog/themes/fluid/source/js</code> åˆ›å»º <code>backgroundize.js</code> æ–‡ä»¶</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> bannerContainer <span class="token operator">=</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">"#banner"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">const</span> viewBg <span class="token operator">=</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">"#web_bg"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">const</span> bannerMask <span class="token operator">=</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">"#banner .mask"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">const</span> bg <span class="token operator">=</span> <span class="token function">$</span><span class="token punctuation">(</span>bannerContainer<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">css</span><span class="token punctuation">(</span><span class="token string">"background-image"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">$</span><span class="token punctuation">(</span>viewBg<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">css</span><span class="token punctuation">(</span><span class="token string">"background-image"</span><span class="token punctuation">,</span> bg<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">$</span><span class="token punctuation">(</span>bannerContainer<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">css</span><span class="token punctuation">(</span><span class="token string">"background-image"</span><span class="token punctuation">,</span> <span class="token string">"url()"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">const</span> color <span class="token operator">=</span> <span class="token function">$</span><span class="token punctuation">(</span>bannerMask<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">css</span><span class="token punctuation">(</span><span class="token string">"background-color"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">$</span><span class="token punctuation">(</span>bannerMask<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">css</span><span class="token punctuation">(</span><span class="token string">"background-color"</span><span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">rgba(0,0,0,0)</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">$</span><span class="token punctuation">(</span>viewBg<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">css</span><span class="token punctuation">(</span><span class="token string">"background-color"</span><span class="token punctuation">,</span> color<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h1 id="ä¸‰ã€åˆ›å»º-backgroundize-css-æ–‡ä»¶"><a href="#ä¸‰ã€åˆ›å»º-backgroundize-css-æ–‡ä»¶" class="headerlink" title="ä¸‰ã€åˆ›å»º backgroundize.css æ–‡ä»¶"></a>ä¸‰ã€åˆ›å»º <code>backgroundize.css</code> æ–‡ä»¶</h1><p>è¿›å…¥ <code>~/blog/themes/fluid/source/css</code> åˆ›å»º <code>backgroundize.css</code> æ–‡ä»¶</p><pre class="line-numbers language-css" data-language="css"><code class="language-css"><span class="token selector">#web_bg</span> <span class="token punctuation">&#123;</span>    <span class="token property">position</span><span class="token punctuation">:</span> fixed<span class="token punctuation">;</span>    <span class="token property">z-index</span><span class="token punctuation">:</span> -999<span class="token punctuation">;</span>    <span class="token property">width</span><span class="token punctuation">:</span> 100%<span class="token punctuation">;</span>    <span class="token property">height</span><span class="token punctuation">:</span> 100%<span class="token punctuation">;</span>    <span class="token property">background-attachment</span><span class="token punctuation">:</span> local<span class="token punctuation">;</span>    <span class="token property">background-position</span><span class="token punctuation">:</span> center<span class="token punctuation">;</span>    <span class="token property">-webkit-background-size</span><span class="token punctuation">:</span> cover<span class="token punctuation">;</span>    <span class="token property">-moz-background-size</span><span class="token punctuation">:</span> cover<span class="token punctuation">;</span>    <span class="token property">background-size</span><span class="token punctuation">:</span> cover<span class="token punctuation">;</span>    <span class="token property">background-repeat</span><span class="token punctuation">:</span> repeat<span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h1 id="å››ã€æ¸…ç†ç¼“å­˜ã€éƒ¨ç½²"><a href="#å››ã€æ¸…ç†ç¼“å­˜ã€éƒ¨ç½²" class="headerlink" title="å››ã€æ¸…ç†ç¼“å­˜ã€éƒ¨ç½²"></a>å››ã€æ¸…ç†ç¼“å­˜ã€éƒ¨ç½²</h1><p>ä¹‹åæ‰§è¡Œ <code>hexo clean</code> å’Œ <code>hexo server</code> æŸ¥çœ‹æ•ˆæœå§ã€‚æ»¡è¶³é¢„æœŸï¼Œå³å¯æ¨é€è‡³æœåŠ¡å™¨éƒ¨ç½²ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> Hexoä¸»é¢˜ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Hexo </tag>
            
            <tag> Fluid </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ã€å¤šçº¿ç¨‹ã€‘ThreadPoolExcutorçº¿ç¨‹æ± </title>
      <link href="/posts/24507.html"/>
      <url>/posts/24507.html</url>
      
        <content type="html"><![CDATA[<h1 id="ä¸€ã€Executorsåˆ›å»ºçº¿ç¨‹æ± "><a href="#ä¸€ã€Executorsåˆ›å»ºçº¿ç¨‹æ± " class="headerlink" title="ä¸€ã€Executorsåˆ›å»ºçº¿ç¨‹æ± "></a>ä¸€ã€Executorsåˆ›å»ºçº¿ç¨‹æ± </h1><h2 id="1-newFixedThreadPool"><a href="#1-newFixedThreadPool" class="headerlink" title="1.newFixedThreadPool"></a>1.newFixedThreadPool</h2><p>å…ˆæ¥çœ‹çœ‹æºç ä¸­æ˜¯æ€ä¹ˆæ„é€ çš„ï¼š</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">ExecutorService</span> <span class="token function">newFixedThreadPool</span><span class="token punctuation">(</span><span class="token keyword">int</span> nThreads<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ThreadPoolExecutor</span><span class="token punctuation">(</span>nThreads<span class="token punctuation">,</span>   nThreads<span class="token punctuation">,</span>                                <span class="token number">0L</span><span class="token punctuation">,</span>                                 <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">MILLISECONDS</span><span class="token punctuation">,</span>                                <span class="token keyword">new</span> <span class="token class-name">LinkedBlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Runnable</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æ ¸å¿ƒçº¿ç¨‹æ•°å’Œæœ€å¤§çº¿ç¨‹æ•°æ˜¯ä¸€æ ·çš„ï¼Œä¸”é˜»å¡é˜Ÿåˆ—ä¸º<code>LinkedBlockingQueue</code>ï¼Œæœ€å¤§é•¿åº¦ä¸º$2^{31}$-1&#x3D;2147483647ï¼Œå¯ä»¥çœ‹çœ‹å®ƒçš„æ„é€ æ–¹æ³•ï¼š</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token class-name">LinkedBlockingQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">this</span><span class="token punctuation">(</span><span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token constant">MAX_VALUE</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">public</span> <span class="token class-name">LinkedBlockingQueue</span><span class="token punctuation">(</span><span class="token keyword">int</span> capacity<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>capacity <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>capacity <span class="token operator">=</span> capacity<span class="token punctuation">;</span>    last <span class="token operator">=</span> head <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="2-newSingleThreadExecutor"><a href="#2-newSingleThreadExecutor" class="headerlink" title="2.newSingleThreadExecutor"></a>2.newSingleThreadExecutor</h2><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">ExecutorService</span> <span class="token function">newSingleThreadExecutor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>     <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">FinalizableDelegatedExecutorService</span>         <span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ThreadPoolExecutor</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span>                                 <span class="token number">0L</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">MILLISECONDS</span><span class="token punctuation">,</span>                                 <span class="token keyword">new</span> <span class="token class-name">LinkedBlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Runnable</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å¯ä»¥çœ‹å‡ºï¼Œä¸<code>newFixedThreadPool</code>ç±»ä¼¼ï¼Œè¿™é‡Œæ ¸å¿ƒçº¿ç¨‹æ•°å’Œæœ€å¤§çº¿ç¨‹æ•°å‡ä¸º1.<br>ä¹Ÿå¾ˆæ˜æ˜¾ï¼Œå¦‚æœç”¨<code>newFixedThreadPool</code>ã€<code>newSingleThreadExecutor</code>ï¼Œ<strong>ä¸»è¦é—®é¢˜ä¼šå‡ºç°åœ¨é˜»å¡é˜Ÿåˆ—è¿‡é•¿ï¼Œå †ç§¯çš„è¯·æ±‚å¤„ç†é˜Ÿåˆ—å¯èƒ½ä¼šè€—è´¹éå¸¸å¤§çš„å†…å­˜ï¼Œç”šè‡³OOM</strong>ã€‚</p><h2 id="3-newCachedThreadPool"><a href="#3-newCachedThreadPool" class="headerlink" title="3.newCachedThreadPool"></a>3.newCachedThreadPool</h2><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">ExecutorService</span> <span class="token function">newCachedThreadPool</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ThreadPoolExecutor</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token constant">MAX_VALUE</span><span class="token punctuation">,</span>                                  <span class="token number">60L</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">,</span>                                  <span class="token keyword">new</span> <span class="token class-name">SynchronousQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Runnable</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="4-newScheduledThreadPool"><a href="#4-newScheduledThreadPool" class="headerlink" title="4.newScheduledThreadPool"></a>4.newScheduledThreadPool</h2><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">ScheduledExecutorService</span> <span class="token function">newScheduledThreadPool</span><span class="token punctuation">(</span><span class="token keyword">int</span> corePoolSize<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ScheduledThreadPoolExecutor</span><span class="token punctuation">(</span>corePoolSize<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">public</span> <span class="token class-name">ScheduledThreadPoolExecutor</span><span class="token punctuation">(</span><span class="token keyword">int</span> corePoolSize<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">super</span><span class="token punctuation">(</span>corePoolSize<span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token constant">MAX_VALUE</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token constant">NANOSECONDS</span><span class="token punctuation">,</span>          <span class="token keyword">new</span> <span class="token class-name">DelayedWorkQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><code>newCachedThreadPool</code>ã€<code>newScheduledThreadPool</code>ä¼šå‡ºé—®é¢˜ä½“ç°åœ¨<strong>æœ€å¤§æ ¸å¿ƒçº¿ç¨‹æ•°éƒ½æ˜¯<code>Integer.MAX_VALUE</code>ï¼Œå¯èƒ½ä¼šåˆ›å»ºæ•°é‡éå¸¸å¤šçš„çº¿ç¨‹ï¼Œç”šè‡³OOM</strong>ã€‚</p><h1 id="äºŒã€ThreadPoolExcutoræ˜¾ç¤ºåˆ›å»ºçº¿ç¨‹æ± "><a href="#äºŒã€ThreadPoolExcutoræ˜¾ç¤ºåˆ›å»ºçº¿ç¨‹æ± " class="headerlink" title="äºŒã€ThreadPoolExcutoræ˜¾ç¤ºåˆ›å»ºçº¿ç¨‹æ± "></a>äºŒã€ThreadPoolExcutoræ˜¾ç¤ºåˆ›å»ºçº¿ç¨‹æ± </h1><h2 id="1-å…¥å‚è¯´æ˜"><a href="#1-å…¥å‚è¯´æ˜" class="headerlink" title="1.å…¥å‚è¯´æ˜"></a>1.å…¥å‚è¯´æ˜</h2><p>å…ˆçœ‹çœ‹æ„é€ æ–¹æ³•ï¼š</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token class-name">ThreadPoolExecutor</span><span class="token punctuation">(</span><span class="token keyword">int</span> corePoolSize<span class="token punctuation">,</span>                              <span class="token keyword">int</span> maximumPoolSize<span class="token punctuation">,</span>                              <span class="token keyword">long</span> keepAliveTime<span class="token punctuation">,</span>                              <span class="token class-name">TimeUnit</span> unit<span class="token punctuation">,</span>                              <span class="token class-name">BlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Runnable</span><span class="token punctuation">></span></span> workQueue<span class="token punctuation">,</span>                              <span class="token class-name">ThreadFactory</span> threadFactory<span class="token punctuation">,</span>                              <span class="token class-name">RejectedExecutionHandler</span> handler<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li><p><code>corePoolSize</code>ï¼šæ ¸å¿ƒçº¿ç¨‹æ•°ã€‚çº¿ç¨‹æ± ç»´æŠ¤çº¿ç¨‹çš„æœ€å°‘æ•°é‡ã€‚åœ¨æ²¡æœ‰ä»»åŠ¡æ‰§è¡Œæ—¶çº¿ç¨‹æ± çš„å¤§å°ã€‚ï¼ˆps: åœ¨åˆ›å»ºThreadPoolExecutoråˆæœŸï¼Œçº¿ç¨‹å¹¶ä¸ä¼šç«‹å³å¯åŠ¨ï¼Œè€Œæ˜¯ç­‰åˆ°æœ‰ä»»åŠ¡æäº¤æ—¶æ‰ä¼šå¯åŠ¨ï¼Œé™¤éè°ƒç”¨<code>prestartAllCoreThreads</code>ï¼‰</p></li><li><p><code>maximumPoolSize</code>ï¼šçº¿ç¨‹æ± ç»´æŠ¤çº¿ç¨‹çš„æœ€å¤§æ•°é‡ã€‚</p></li><li><p><code>keepAliveTime</code>ï¼šçº¿ç¨‹æ± ç»´æŠ¤çº¿ç¨‹æ‰€å…è®¸çš„ç©ºé—²æ—¶é—´ã€‚åªæœ‰å½“<strong>çº¿ç¨‹æ± çš„çº¿ç¨‹æ•° &gt; corePoolSize</strong> æ—¶ï¼Œ<code>keepAliveTime</code> æ‰ä¼šèµ·ä½œç”¨ã€‚ä½†å½“ <code>ThreadPoolExecutor</code> çš„ <code>allowCoreThreadTimeOut</code> å˜é‡è®¾ç½®ä¸º <code>true</code> æ—¶ï¼Œæ ¸å¿ƒçº¿ç¨‹è¶…æ—¶åä¼šè¢«å›æ”¶ã€‚</p></li><li><p><code>unit</code>ï¼šçº¿ç¨‹æ± ç»´æŠ¤çº¿ç¨‹æ‰€å…è®¸çš„ç©ºé—²æ—¶é—´çš„<strong>å•ä½</strong>ã€‚</p></li><li><p><code>workQueue</code>ï¼šé˜»å¡é˜Ÿåˆ—ã€‚å½“<code>å½“å‰çº¿ç¨‹æ•°&gt;corePoolSize</code>ï¼Œæ–°è¿›æ¥çš„ä»»åŠ¡ä¼šæ”¾ç½®åœ¨æ­¤ã€‚å¸¸è§çš„æœ‰ä»¥ä¸‹å‡ ç§ï¼š</p><ul><li><code>ArrayBlockingQueue</code>ï¼šæ˜¯ä¸€ä¸ªæœ‰è¾¹ç•Œçš„é˜»å¡é˜Ÿåˆ—ï¼Œå®ƒçš„å†…éƒ¨å®ç°æ˜¯ä¸€ä¸ªæ•°ç»„ã€‚å®ƒçš„å®¹é‡åœ¨åˆå§‹åŒ–æ—¶å°±ç¡®å®šä¸å˜ã€‚</li><li><code>LinkedBlockingQueue</code>ï¼šé˜»å¡é˜Ÿåˆ—å¤§å°çš„é…ç½®æ˜¯å¯é€‰çš„ï¼Œå…¶å†…éƒ¨å®ç°æ˜¯ä¸€ä¸ªé“¾è¡¨ã€‚</li><li><code>PriorityBlockingQueue</code>ï¼šæ˜¯ä¸€ä¸ªæ²¡æœ‰è¾¹ç•Œçš„é˜Ÿåˆ—ï¼Œæ‰€æœ‰æ’å…¥åˆ°<code>PriorityBlockingQueue</code>çš„å¯¹è±¡å¿…é¡»å®ç°<code>java.lang.Comparable</code>æ¥å£ï¼Œé˜Ÿåˆ—ä¼˜å…ˆçº§çš„æ’åºå°±æ˜¯æŒ‰ç…§æˆ‘ä»¬å¯¹è¿™ä¸ªæ¥å£çš„å®ç°æ¥å®šä¹‰çš„ã€‚</li><li><code>SynchronousQueue</code>ï¼šé˜Ÿåˆ—å†…éƒ¨ä»…å…è®¸å®¹çº³ä¸€ä¸ªå…ƒç´ ã€‚å½“ä¸€ä¸ªçº¿ç¨‹æ’å…¥ä¸€ä¸ªå…ƒç´ åä¼šè¢«é˜»å¡ï¼Œé™¤éè¿™ä¸ªå…ƒç´ è¢«å¦ä¸€ä¸ªçº¿ç¨‹æ¶ˆè´¹ã€‚</li></ul></li><li><p><code>threadFactory</code>ï¼šçº¿ç¨‹å·¥å‚ï¼Œä¸»è¦ç”¨æ¥åˆ›å»ºçº¿ç¨‹ã€‚</p></li><li><p><code>handler</code>ï¼šå½“çº¿ç¨‹æ•°è¾¾åˆ°æœ€å¤§æ—¶ï¼Œæ–°çš„ä»»åŠ¡çš„æ‹’ç»ç­–ç•¥ï¼ŒåŒ…æ‹¬: </p><ul><li><code>ThreadPoolExecutor.AbortPolicy</code>:ä¸¢å¼ƒä»»åŠ¡å¹¶æŠ›å‡º<code>RejectedExecutionException</code>å¼‚å¸¸ã€‚</li><li><code>ThreadPoolExecutor.DiscardPolicy</code>ï¼šä¹Ÿæ˜¯ä¸¢å¼ƒä»»åŠ¡ï¼Œä½†æ˜¯ä¸æŠ›å‡ºå¼‚å¸¸ã€‚</li><li><code>ThreadPoolExecutor.DiscardOldestPolicy</code>ï¼šä¸¢å¼ƒé˜Ÿåˆ—æœ€å‰é¢çš„ä»»åŠ¡ï¼Œç„¶åé‡æ–°å°è¯•æ‰§è¡Œä»»åŠ¡ï¼ˆé‡å¤æ­¤è¿‡ç¨‹ï¼‰</li><li><code>ThreadPoolExecutor.CallerRunsPolicy</code>ï¼šåªè¦çº¿ç¨‹æ± ä¸å…³é—­ï¼Œè¯¥ç­–ç•¥ç›´æ¥åœ¨è°ƒç”¨è€…çº¿ç¨‹ä¸­ï¼Œè¿è¡Œå½“å‰è¢«ä¸¢å¼ƒçš„ä»»åŠ¡ï¼›</li></ul><p>  å¯ä»¥è‡ªå®šä¹‰å®ç°<code>RejectedExecutionHandler</code>ã€‚</p></li></ul><h2 id="2-å†…éƒ¨æ‰§è¡Œæµç¨‹"><a href="#2-å†…éƒ¨æ‰§è¡Œæµç¨‹" class="headerlink" title="2.å†…éƒ¨æ‰§è¡Œæµç¨‹"></a>2.å†…éƒ¨æ‰§è¡Œæµç¨‹</h2><p><img src="https://cdn.jsdelivr.net/gh/zyxelva/picgo@main/csdn/2021040121195681.png" alt="å†…éƒ¨æ‰§è¡Œæµç¨‹"></p><p>1). çº¿ç¨‹æ± åˆšåˆ›å»ºæ—¶ï¼Œé‡Œé¢æ²¡æœ‰ä¸€ä¸ªçº¿ç¨‹ã€‚ä»»åŠ¡é˜Ÿåˆ—æ˜¯ä½œä¸ºå‚æ•°ä¼ è¿›æ¥çš„ã€‚ä¸è¿‡ï¼Œå°±ç®—é˜Ÿåˆ—é‡Œé¢æœ‰ä»»åŠ¡ï¼Œçº¿ç¨‹æ± ä¹Ÿä¸ä¼šé©¬ä¸Šæ‰§è¡Œå®ƒä»¬ã€‚</p><p>2). å½“è°ƒç”¨<code>execute()</code>æ–¹æ³•æ·»åŠ ä¸€ä¸ªä»»åŠ¡æ—¶ï¼Œçº¿ç¨‹æ± ä¼šåšå¦‚ä¸‹åˆ¤æ–­ï¼š</p><ul><li>å¦‚æœ<strong>æ­£åœ¨è¿è¡Œçš„çº¿ç¨‹æ•°å°äºcorePoolSize</strong>ï¼Œé‚£ä¹ˆé©¬ä¸Šåˆ›å»ºçº¿ç¨‹è¿è¡Œè¿™ä¸ªä»»åŠ¡ã€‚</li><li>å¦‚æœ<strong>æ­£åœ¨è¿è¡Œçš„çº¿ç¨‹æ•°å¤§äºæˆ–è€…ç­‰äºcorePoolSize</strong>,é‚£ä¹ˆå°†è¿™ä¸ªä»»åŠ¡æ”¾å…¥é˜Ÿåˆ—ã€‚</li><li>å¦‚æœè¿™ä¸ªæ—¶å€™<strong>é˜Ÿåˆ—æ»¡äº†</strong>ï¼Œè€Œä¸”<strong>æ­£åœ¨è¿è¡Œçš„çº¿ç¨‹æ•°é‡å°äºmaximumPoolSize</strong>,é‚£ä¹ˆè¿˜æ˜¯è¦åˆ›å»ºçº¿ç¨‹è¿è¡Œè¿™ä¸ªä»»åŠ¡ã€‚</li><li>å¦‚æœ<strong>é˜Ÿåˆ—æ»¡äº†</strong>ï¼Œè€Œä¸”<strong>æ­£åœ¨è¿è¡Œçš„çº¿ç¨‹æ•°é‡å¤§äºæˆ–ç­‰äº maximumPoolSize</strong>ï¼Œé€šè¿‡ <code>handler</code>æ‰€æŒ‡å®šçš„ç­–ç•¥æ¥å¤„ç†æ­¤ä»»åŠ¡ã€‚</li></ul><p>3). å½“ä¸€ä¸ªçº¿ç¨‹å®Œæˆä»»åŠ¡æ—¶ï¼Œå®ƒä¼šä»é˜Ÿåˆ—ä¸­å–ä¸‹ä¸€ä¸ªä»»åŠ¡æ¥æ‰§è¡Œã€‚</p><p>4). å½“ä¸€ä¸ªçº¿ç¨‹æ— äº‹å¯åšï¼Œè¶…è¿‡ä¸€å®šçš„æ—¶é—´ï¼ˆ<code>keepAliveTime</code>ï¼‰æ—¶ï¼Œçº¿ç¨‹æ± ä¼šåˆ¤æ–­ï¼Œå¦‚æœ<strong>å½“å‰è¿è¡Œçš„çº¿ç¨‹æ•°å¤§äºcorePoolSize</strong>æ—¶ï¼Œé‚£ä¹ˆè¿™ä¸ªçº¿ç¨‹ä¼šè¢«åœç”¨æ‰ï¼Œæ‰€ä»¥çº¿ç¨‹æ± çš„æ‰€æœ‰ä»»åŠ¡å®Œæˆåï¼Œå®ƒæœ€ç»ˆä¼šæ”¶ç¼©åˆ°<code>corePoolSize</code>çš„å¤§å°ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> å¹¶å‘ç¼–ç¨‹ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> å¤šçº¿ç¨‹ </tag>
            
            <tag> çº¿ç¨‹æ±  </tag>
            
            <tag> ThreadPoolExcutor </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ã€Springæºç å­¦ä¹ ã€‘FactoryBean ç±»å‹çš„æ¥å£</title>
      <link href="/posts/41623.html"/>
      <url>/posts/41623.html</url>
      
        <content type="html"><![CDATA[<h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><p>åœ¨<a href="https://zyxelva.github.io/posts/9980.html">ã€Springæºç å­¦ä¹ ã€‘Spring Beanå®ä¾‹åŒ–è¿‡ç¨‹-åˆ›å»ºBeanå®ä¾‹</a> ä¸€æ–‡ä¸­ï¼Œå®ä¾‹åœ¨çœŸæ­£åˆ›å»ºå®Œæˆ(å®Œæˆäº†åˆ›å»ºã€ä¾èµ–å±æ€§æ³¨å…¥ã€åˆå§‹åŒ–)åï¼Œä¼šæœ‰FactoryBeançš„æ¥å£è°ƒç”¨ï¼Œæˆ‘ä»¬å…ˆå®šä½åˆ°è¿™æ®µä»£ç æ¥çœ‹çœ‹ï¼Œæœ¬ç« ä¹Ÿä¸»è¦è·Ÿä¸€ä¸‹è¿™ä¸ªè°ƒç”¨çš„æµç¨‹ã€‚</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">//AbstractBeanFactory</span><span class="token keyword">protected</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> <span class="token class-name">T</span> <span class="token function">doGetBean</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> requiredType<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">,</span> <span class="token keyword">boolean</span> typeCheckOnly<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">BeansException</span> <span class="token punctuation">&#123;</span><span class="token comment">// è·å–ä¸€ä¸ªbeanNameï¼Œå¤„ç†ä¸¤ç§æƒ…å†µï¼Œä¸€ä¸ªæ˜¯å‰é¢è¯´çš„ FactoryBean (å‰é¢å¸¦ '&amp;')ï¼Œ</span><span class="token comment">// ä¸€ä¸ªæ˜¯åˆ«åé—®é¢˜ï¼Œå› ä¸ºè¿™ä¸ªæ–¹æ³•æ˜¯ getBeanï¼Œè·å– Bean ç”¨çš„ï¼Œä½ è¦æ˜¯ä¼ ä¸€ä¸ªåˆ«åè¿›æ¥ï¼Œæ˜¯å®Œå…¨å¯ä»¥çš„</span><span class="token class-name">String</span> beanName <span class="token operator">=</span> <span class="token function">transformedBeanName</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">Object</span> bean<span class="token punctuation">;</span><span class="token comment">/* * Description : æ£€æŸ¥ç¼“å­˜ä¸­æˆ–è€…å®ä¾‹å·¥å‚ä¸­æ˜¯å¦æœ‰å¯¹åº”çš„å®ä¾‹ * å› ä¸ºåœ¨åˆ›å»ºå•ä¾‹ beançš„æ—¶å€™ä¼šå­˜åœ¨ä¾èµ–æ³¨å…¥ï¼Œè€Œåœ¨åˆ›å»ºä¾èµ–çš„æ—¶å€™ä¸ºäº†é¿å…å¾ªç¯ä¾èµ–ï¼Œ * springåˆ›å»ºbeançš„åŸåˆ™æ˜¯ï¼šä¸ç­‰ bean åˆ›å»ºå®Œæˆå°±å°†åˆ›å»ºbeançš„ ObjectFactory ææ—©æ›å…‰ï¼Œ *  æ¢å¥è¯è¯´ï¼Œä¹Ÿå°±æ˜¯å°† ObjectFactory åŠ å…¥åˆ°ç¼“å­˜ä¸­ï¼Œä¸€æ—¦ä¸‹ä¸€ä¸ªbeanåˆ›å»ºçš„æ—¶å€™éœ€è¦ä¾èµ–ä¸Š *  ä¸€ä¸ªbeanåˆ™ç›´æ¥ä½¿ç”¨ ObjectFactory * *  ç¬¬ä¸€æ¬¡getSingleton(beanName) */</span><span class="token comment">// Eagerly check singleton cache for manually registered singletons.</span><span class="token class-name">Object</span> sharedInstance <span class="token operator">=</span> <span class="token function">getSingleton</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//å¦‚æœç¼“å­˜é‡Œé¢èƒ½æ‹¿åˆ°å®ä¾‹,ä½†ç¬¬ä¸€æ¬¡ç¼“å­˜ä¸­æ˜¯æ²¡æœ‰çš„ï¼Œæ‰€ä»¥ç¬¬ä¸€æ¬¡ä¸ä¼šè¿›å…¥è¿™ä¸ªif</span><span class="token keyword">if</span> <span class="token punctuation">(</span>sharedInstance <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> args <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isTraceEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isSingletonCurrentlyInCreation</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>logger<span class="token punctuation">.</span><span class="token function">trace</span><span class="token punctuation">(</span><span class="token string">"Returning eagerly cached instance of singleton bean '"</span> <span class="token operator">+</span> beanName <span class="token operator">+</span><span class="token string">"' that is not fully initialized yet - a consequence of a circular reference"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">else</span> <span class="token punctuation">&#123;</span>logger<span class="token punctuation">.</span><span class="token function">trace</span><span class="token punctuation">(</span><span class="token string">"Returning cached instance of singleton bean '"</span> <span class="token operator">+</span> beanName <span class="token operator">+</span> <span class="token string">"'"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token comment">// è¯¥æ–¹æ³•æ˜¯ FactoryBean æ¥å£çš„è°ƒç”¨å…¥å£</span><span class="token comment">// å¦‚æœæ˜¯æ™®é€š Bean çš„è¯ï¼Œç›´æ¥è¿”å› sharedInstanceï¼ˆç›´æ¥è¿”å›å¯¹è±¡æœ¬èº«ï¼‰</span><span class="token comment">// å¦‚æœæ˜¯ FactoryBean çš„è¯ï¼Œè¿”å›å®ƒåˆ›å»ºçš„é‚£ä¸ªå®ä¾‹å¯¹è±¡(è¿”å›æŒ‡å®šæ–¹æ³•è¿”å›çš„å®ä¾‹)</span>bean <span class="token operator">=</span> <span class="token function">getObjectForBeanInstance</span><span class="token punctuation">(</span>sharedInstance<span class="token punctuation">,</span> name<span class="token punctuation">,</span> beanName<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">//å¦‚æœsingletonObjectsç¼“å­˜é‡Œé¢æ²¡æœ‰ï¼Œåˆ™èµ°ä¸‹æ¥</span><span class="token keyword">else</span> <span class="token punctuation">&#123;</span><span class="token comment">//å¦‚æœæ˜¯scope æ˜¯Prototypeçš„ï¼Œæ ¡éªŒæ˜¯å¦æœ‰å‡ºç°å¾ªç¯ä¾èµ–ï¼Œå¦‚æœæœ‰åˆ™ç›´æ¥æŠ¥é”™</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isPrototypeCurrentlyInCreation</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BeanCurrentlyInCreationException</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">// Check if bean definition exists in this factory.</span><span class="token comment">//æ£€æŸ¥ä¸€ä¸‹è¿™ä¸ª BeanDefinition åœ¨å®¹å™¨ä¸­æ˜¯å¦å­˜åœ¨</span><span class="token class-name">BeanFactory</span> parentBeanFactory <span class="token operator">=</span> <span class="token function">getParentBeanFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//......çœç•¥éƒ¨åˆ†ä»£ç </span><span class="token comment">//è¦å¼€å§‹åˆ›å»ºbeanäº†ï¼Œåˆ†ä¸¤ç§æƒ…å†µï¼šä¸€ç§æ˜¯é’ˆå¯¹å•ä¾‹çš„ï¼ˆsingletonï¼‰ï¼Œä¸€ç§æ˜¯é’ˆå¯¹å¤šä¾‹çš„ï¼ˆprototypeï¼‰ï¼Œä¸€ç§æ˜¯è‡ªå®šä¹‰scopeçš„</span><span class="token keyword">try</span> <span class="token punctuation">&#123;</span><span class="token comment">//çˆ¶å­BeanDefinitionåˆå¹¶</span><span class="token class-name">RootBeanDefinition</span> mbd <span class="token operator">=</span> <span class="token function">getMergedLocalBeanDefinition</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">checkMergedBeanDefinition</span><span class="token punctuation">(</span>mbd<span class="token punctuation">,</span> beanName<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//è·å–ä¾èµ–å¯¹è±¡å±æ€§ï¼Œä¾èµ–å¯¹è±¡è¦å…ˆå®ä¾‹åŒ–</span><span class="token comment">// Guarantee initialization of beans that the current bean depends on.</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> dependsOn <span class="token operator">=</span> mbd<span class="token punctuation">.</span><span class="token function">getDependsOn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//......çœç•¥éƒ¨åˆ†ä»£ç </span><span class="token comment">//å•ä¾‹æƒ…å†µsingletonï¼Œç€é‡çœ‹ï¼Œå¤§éƒ¨åˆ†æ˜¯å•ä¾‹çš„æƒ…å†µ</span><span class="token comment">// Create bean instance.</span><span class="token keyword">if</span> <span class="token punctuation">(</span>mbd<span class="token punctuation">.</span><span class="token function">isSingleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>sharedInstance <span class="token operator">=</span> <span class="token function">getSingleton</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token punctuation">&#123;</span><span class="token keyword">try</span> <span class="token punctuation">&#123;</span><span class="token keyword">return</span> <span class="token function">createBean</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> mbd<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">BeansException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token function">destroySingleton</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">throw</span> ex<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//è¯¥æ–¹æ³•æ˜¯FactoryBeanæ¥å£çš„è°ƒç”¨å…¥å£</span>bean <span class="token operator">=</span> <span class="token function">getObjectForBeanInstance</span><span class="token punctuation">(</span>sharedInstance<span class="token punctuation">,</span> name<span class="token punctuation">,</span> beanName<span class="token punctuation">,</span> mbd<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">//å¤šä¾‹æƒ…å†µprototype</span><span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>mbd<span class="token punctuation">.</span><span class="token function">isPrototype</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">// It's a prototype -> create a new instance.</span><span class="token class-name">Object</span> prototypeInstance <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span><span class="token keyword">try</span> <span class="token punctuation">&#123;</span><span class="token function">beforePrototypeCreation</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>prototypeInstance <span class="token operator">=</span> <span class="token function">createBean</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> mbd<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">finally</span> <span class="token punctuation">&#123;</span><span class="token function">afterPrototypeCreation</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">//è¯¥æ–¹æ³•æ˜¯FactoryBeanæ¥å£çš„è°ƒç”¨å…¥å£</span>bean <span class="token operator">=</span> <span class="token function">getObjectForBeanInstance</span><span class="token punctuation">(</span>prototypeInstance<span class="token punctuation">,</span> name<span class="token punctuation">,</span> beanName<span class="token punctuation">,</span> mbd<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">// å¦‚æœä¸æ˜¯ singleton å’Œ prototype çš„è¯ï¼Œéœ€è¦å§”æ‰˜ç»™ç›¸åº”çš„å®ç°ç±»æ¥å¤„ç†</span><span class="token keyword">else</span> <span class="token punctuation">&#123;</span><span class="token class-name">String</span> scopeName <span class="token operator">=</span> mbd<span class="token punctuation">.</span><span class="token function">getScope</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">hasLength</span><span class="token punctuation">(</span>scopeName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">"No scope name defined for bean Â´"</span> <span class="token operator">+</span> beanName <span class="token operator">+</span> <span class="token string">"'"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token class-name">Scope</span> scope <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>scopes<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>scopeName<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>scope <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">"No Scope registered for scope name '"</span> <span class="token operator">+</span> scopeName <span class="token operator">+</span> <span class="token string">"'"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">try</span> <span class="token punctuation">&#123;</span><span class="token class-name">Object</span> scopedInstance <span class="token operator">=</span> scope<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token punctuation">&#123;</span><span class="token function">beforePrototypeCreation</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">try</span> <span class="token punctuation">&#123;</span><span class="token keyword">return</span> <span class="token function">createBean</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> mbd<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">finally</span> <span class="token punctuation">&#123;</span><span class="token function">afterPrototypeCreation</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>bean <span class="token operator">=</span> <span class="token function">getObjectForBeanInstance</span><span class="token punctuation">(</span>scopedInstance<span class="token punctuation">,</span> name<span class="token punctuation">,</span> beanName<span class="token punctuation">,</span> mbd<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IllegalStateException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BeanCreationException</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span><span class="token string">"Scope '"</span> <span class="token operator">+</span> scopeName <span class="token operator">+</span> <span class="token string">"' is not active for the current thread; consider "</span> <span class="token operator">+</span><span class="token string">"defining a scoped proxy for this bean if you intend to refer to it from a singleton"</span><span class="token punctuation">,</span>ex<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">BeansException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token function">cleanupAfterBeanCreationFailure</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">throw</span> ex<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token comment">//......çœç•¥éƒ¨åˆ†ä»£ç </span><span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token class-name">T</span><span class="token punctuation">)</span> bean<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>bean &#x3D; getObjectForBeanInstance()æ–¹æ³•å°±æ˜¯FactoryBeanæ¥å£çš„è°ƒç”¨å…¥å£äº†ã€‚è€Œè¿™ä¸ªæ¥å£é¦–æ¬¡è°ƒç”¨åˆ™æ˜¯åœ¨åˆ›å»ºå®Œæˆä¸€ä¸ªå¯ç”¨çš„beanä¹‹åï¼Œä¹Ÿå°±æ˜¯åœ¨ä¸‹é¢è¿™ä¸ªä»£ç é‡Œé¦–æ¬¡è°ƒç”¨çš„(<strong>æœ¬ç« ä¸»è¦é’ˆå¯¹å•ä¾‹ï¼Œå…¶ä»–å¤šä¾‹ã€è‡ªå®šä¹‰scopeç±»ä¼¼</strong>)</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">if</span> <span class="token punctuation">(</span>mbd<span class="token punctuation">.</span><span class="token function">isSingleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>sharedInstance <span class="token operator">=</span> <span class="token function">getSingleton</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token punctuation">&#123;</span><span class="token keyword">try</span> <span class="token punctuation">&#123;</span><span class="token keyword">return</span> <span class="token function">createBean</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> mbd<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">BeansException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">// Explicitly remove instance from singleton cache: It might have been put there</span><span class="token comment">// eagerly by the creation process, to allow for circular reference resolution.</span><span class="token comment">// Also remove any beans that received a temporary reference to the bean.</span><span class="token function">destroySingleton</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">throw</span> ex<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//è¯¥æ–¹æ³•æ˜¯FactoryBeanæ¥å£çš„è°ƒç”¨å…¥å£</span>bean <span class="token operator">=</span> <span class="token function">getObjectForBeanInstance</span><span class="token punctuation">(</span>sharedInstance<span class="token punctuation">,</span> name<span class="token punctuation">,</span> beanName<span class="token punctuation">,</span> mbd<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h1 id="ä¸€ã€FactoryBeanæ¥å£çš„è°ƒç”¨"><a href="#ä¸€ã€FactoryBeanæ¥å£çš„è°ƒç”¨" class="headerlink" title="ä¸€ã€FactoryBeanæ¥å£çš„è°ƒç”¨"></a>ä¸€ã€FactoryBeanæ¥å£çš„è°ƒç”¨</h1><h2 id="1-getObjectForBeanInstance"><a href="#1-getObjectForBeanInstance" class="headerlink" title="1.getObjectForBeanInstance()"></a>1.getObjectForBeanInstance()</h2><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">protected</span> <span class="token class-name">Object</span> <span class="token function">getObjectForBeanInstance</span><span class="token punctuation">(</span><span class="token class-name">Object</span> beanInstance<span class="token punctuation">,</span> <span class="token class-name">String</span> name<span class="token punctuation">,</span> <span class="token class-name">String</span> beanName<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">RootBeanDefinition</span> mbd<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">// Don't let calling code try to dereference the factory if the bean isn't a factory.</span><span class="token comment">//ä»¥&amp;å¼€å¤´ï¼Œé’ˆå¯¹æœ¬èº«å°±æ˜¯FactoryBeançš„åˆ¤æ–­</span><span class="token comment">//å¦‚æœè¦è·å–åˆ°FactoryBean ç±»æœ¬èº«ï¼Œå°±å¿…é¡»åŠ ä¸Šâ€&amp;â€ç¬¦å·ï¼Œæ¯”å¦‚beanFactory.getBean(â€œ&amp;beanNameâ€),</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">BeanFactoryUtils</span><span class="token punctuation">.</span><span class="token function">isFactoryDereference</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>beanInstance <span class="token keyword">instanceof</span> <span class="token class-name">NullBean</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">return</span> beanInstance<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>beanInstance <span class="token keyword">instanceof</span> <span class="token class-name">FactoryBean</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BeanIsNotAFactoryException</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> beanInstance<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>mbd <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>mbd<span class="token punctuation">.</span>isFactoryBean <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">return</span> beanInstance<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">// Now we have the bean instance, which may be a normal bean or a FactoryBean.</span><span class="token comment">// If it's a FactoryBean, we use it to create a bean instance, unless the</span><span class="token comment">// caller actually wants a reference to the factory.</span><span class="token comment">//å¦‚æœå®ä¾‹ä¸æ˜¯FactoryBeanç±»å‹çš„</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>beanInstance <span class="token keyword">instanceof</span> <span class="token class-name">FactoryBean</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">return</span> beanInstance<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">//å¦‚æœä»£ç èƒ½èµ°ä¸‹æ¥ï¼Œåˆ™è¯´æ˜ beanNameä¸æ˜¯ä»¥&amp;å¼€å¤´ï¼Œå¹¶ä¸”beanInstanceæ˜¯FactoryBeanç±»å‹çš„</span><span class="token class-name">Object</span> object <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>mbd <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>mbd<span class="token punctuation">.</span>isFactoryBean <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">else</span> <span class="token punctuation">&#123;</span><span class="token comment">//ä»ç¼“å­˜é‡Œé¢æ‹¿FactoryBeanç±»å‹çš„å®ä¾‹</span>object <span class="token operator">=</span> <span class="token function">getCachedObjectForFactoryBean</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>object <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">// Return bean instance from factory.</span><span class="token class-name">FactoryBean</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span> factory <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">FactoryBean</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span><span class="token punctuation">)</span> beanInstance<span class="token punctuation">;</span><span class="token comment">// Caches object obtained from FactoryBean if it is a singleton.</span><span class="token keyword">if</span> <span class="token punctuation">(</span>mbd <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token function">containsBeanDefinition</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>mbd <span class="token operator">=</span> <span class="token function">getMergedLocalBeanDefinition</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">boolean</span> synthetic <span class="token operator">=</span> <span class="token punctuation">(</span>mbd <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> mbd<span class="token punctuation">.</span><span class="token function">isSynthetic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//é‡ç‚¹çœ‹</span>object <span class="token operator">=</span> <span class="token function">getObjectFromFactoryBean</span><span class="token punctuation">(</span>factory<span class="token punctuation">,</span> beanName<span class="token punctuation">,</span> <span class="token operator">!</span>synthetic<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">return</span> object<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è¿™é‡Œæœ‰ä¸¤ç§æƒ…å†µä¸‹çš„è¿”å›</p><ul><li>ç›´æ¥è¿”å›åŸå¯¹è±¡ï¼šé’ˆå¯¹beanå®ä¾‹æœ¬èº«å°±æ˜¯FactoryBeanç±»å‹æˆ–è€…beanNameæ˜¯ä»¥&amp;å¼€å¤´çš„æƒ…å†µ</li><li>è¿”å›factoryBeanï¼šbeanNameä¸æ˜¯ä»¥&amp;å¼€å¤´ï¼Œå¹¶ä¸”beanInstanceæ˜¯FactoryBeanç±»å‹çš„ï¼Œè¿™é‡Œåˆåˆ†æƒ…å†µï¼š<ul><li>ä»factoryBeanObjectCacheç¼“å­˜ä¸­è·å–</li><li>ç¼“å­˜ä¸­ä¸å­˜åœ¨è¯¥beanï¼Œåˆ™è°ƒç”¨factoryçš„getObject()æ–¹æ³•ï¼Œå¹¶ä¸”åˆ¤æ–­ä¸€çº§ç¼“å­˜ä¸­å¦‚æœå­˜åœ¨è¯¥bean å®ä¾‹æŠŠå®ä¾‹ç¼“å­˜åˆ°factoryBeanObjectCache å¯¹åº”çš„map ä¸­ï¼Œè¿™ä¸ªæ˜¯å•ç‹¬ç¼“å­˜FactoryBean ç±»å‹å®ä¾‹çš„map</li></ul></li></ul><h2 id="2-getObjectFromFactoryBean-doGetObjectFromFactoryBean"><a href="#2-getObjectFromFactoryBean-doGetObjectFromFactoryBean" class="headerlink" title="2.getObjectFromFactoryBean(),doGetObjectFromFactoryBean()"></a>2.getObjectFromFactoryBean(),doGetObjectFromFactoryBean()</h2><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">//FactoryBeanRegistrySupport</span><span class="token keyword">protected</span> <span class="token class-name">Object</span> <span class="token function">getObjectFromFactoryBean</span><span class="token punctuation">(</span><span class="token class-name">FactoryBean</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span> factory<span class="token punctuation">,</span> <span class="token class-name">String</span> beanName<span class="token punctuation">,</span> <span class="token keyword">boolean</span> shouldPostProcess<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">//factoryæ˜¯å•ä¾‹ä¸”ä¸€çº§ç¼“å­˜ä¸­å­˜åœ¨</span><span class="token keyword">if</span> <span class="token punctuation">(</span>factory<span class="token punctuation">.</span><span class="token function">isSingleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">containsSingleton</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token function">getSingletonMutex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token class-name">Object</span> object <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>factoryBeanObjectCache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>object <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">//è°ƒç”¨getObjectæ–¹æ³•</span>object <span class="token operator">=</span> <span class="token function">doGetObjectFromFactoryBean</span><span class="token punctuation">(</span>factory<span class="token punctuation">,</span> beanName<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// Only post-process and store if not put there already during getObject() call above</span><span class="token comment">// (e.g. because of circular reference processing triggered by custom getBean calls)</span><span class="token class-name">Object</span> alreadyThere <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>factoryBeanObjectCache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>alreadyThere <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>object <span class="token operator">=</span> alreadyThere<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">else</span> <span class="token punctuation">&#123;</span><span class="token comment">//åç½®å¤„ç†</span><span class="token keyword">if</span> <span class="token punctuation">(</span>shouldPostProcess<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isSingletonCurrentlyInCreation</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">// Temporarily return non-post-processed object, not storing it yet..</span><span class="token keyword">return</span> object<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token function">beforeSingletonCreation</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">try</span> <span class="token punctuation">&#123;</span>object <span class="token operator">=</span> <span class="token function">postProcessObjectFromFactoryBean</span><span class="token punctuation">(</span>object<span class="token punctuation">,</span> beanName<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> ex<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BeanCreationException</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span><span class="token string">"Post-processing of FactoryBean's singleton object failed"</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">finally</span> <span class="token punctuation">&#123;</span><span class="token function">afterSingletonCreation</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">containsSingleton</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">//æŠŠå®ä¾‹ç¼“å­˜åˆ°factoryBeanObjectCache mapä¸­ï¼Œè¿™ä¸ªæ˜¯å•ç‹¬ç¼“å­˜FactoryBeanç±»å‹å®ä¾‹çš„map</span><span class="token keyword">this</span><span class="token punctuation">.</span>factoryBeanObjectCache<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> object<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">return</span> object<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">else</span> <span class="token punctuation">&#123;</span><span class="token class-name">Object</span> object <span class="token operator">=</span> <span class="token function">doGetObjectFromFactoryBean</span><span class="token punctuation">(</span>factory<span class="token punctuation">,</span> beanName<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>shouldPostProcess<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">try</span> <span class="token punctuation">&#123;</span>object <span class="token operator">=</span> <span class="token function">postProcessObjectFromFactoryBean</span><span class="token punctuation">(</span>object<span class="token punctuation">,</span> beanName<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> ex<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BeanCreationException</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> <span class="token string">"Post-processing of FactoryBean's object failed"</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">return</span> object<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">private</span> <span class="token class-name">Object</span> <span class="token function">doGetObjectFromFactoryBean</span><span class="token punctuation">(</span><span class="token class-name">FactoryBean</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span> factory<span class="token punctuation">,</span> <span class="token class-name">String</span> beanName<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">BeanCreationException</span> <span class="token punctuation">&#123;</span><span class="token class-name">Object</span> object<span class="token punctuation">;</span><span class="token keyword">try</span> <span class="token punctuation">&#123;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">getSecurityManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token class-name">AccessControlContext</span> acc <span class="token operator">=</span> <span class="token function">getAccessControlContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">try</span> <span class="token punctuation">&#123;</span>object <span class="token operator">=</span> <span class="token class-name">AccessController</span><span class="token punctuation">.</span><span class="token function">doPrivileged</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">PrivilegedExceptionAction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">></span></span><span class="token punctuation">)</span> factory<span class="token operator">::</span><span class="token function">getObject</span><span class="token punctuation">,</span> acc<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">PrivilegedActionException</span> pae<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">throw</span> pae<span class="token punctuation">.</span><span class="token function">getException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">else</span> <span class="token punctuation">&#123;</span><span class="token comment">//è°ƒç”¨getObjectæ–¹æ³•</span>object <span class="token operator">=</span> factory<span class="token punctuation">.</span><span class="token function">getObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">FactoryBeanNotInitializedException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BeanCurrentlyInCreationException</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> ex<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> ex<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BeanCreationException</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> <span class="token string">"FactoryBean threw exception on object creation"</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">// Do not accept a null value for a FactoryBean that's not fully</span><span class="token comment">// initialized yet: Many FactoryBeans just return null then.</span><span class="token keyword">if</span> <span class="token punctuation">(</span>object <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isSingletonCurrentlyInCreation</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BeanCurrentlyInCreationException</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> <span class="token string">"FactoryBean which is currently in creation returned null from getObject"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span>object <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NullBean</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">return</span> object<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>BeanFactory.getBean(â€œbeanNameâ€)åªèƒ½è·å–åˆ°getObject()æ–¹æ³•è¿”å›çš„å®ä¾‹ã€‚getObject æ–¹æ³•è¿”å›çš„å®ä¾‹ä¼šæœ‰å•ç‹¬çš„ç¼“å­˜å­˜å‚¨ï¼Œè·Ÿå…¶ä»–å®ä¾‹ä¸æ˜¯åŒä¸€ä¸ªç¼“å­˜ï¼Œå¯¹åº”çš„ç¼“å­˜æ˜¯ï¼šfactoryBeanObjectCacheã€‚</p><h1 id="äºŒã€æ€»ç»“"><a href="#äºŒã€æ€»ç»“" class="headerlink" title="äºŒã€æ€»ç»“"></a>äºŒã€æ€»ç»“</h1><ul><li>FactoryBean æ¥å£çš„é¦–æ¬¡è°ƒç”¨å…¥å£åœ¨å®ä¾‹åŒ–ã€IOC&#x2F;DI ä»¥åŠåˆå§‹åŒ–åšå®Œåï¼Œå°±ä¼šè°ƒç”¨FactoryBean ç±»å‹çš„æ¥å£</li><li>å¦‚æœè¦è·å–åˆ°FactoryBean ç±»æœ¬èº«ï¼Œå°±å¿…é¡»åŠ ä¸Šâ€&amp;â€ç¬¦å·ï¼Œæ¯”å¦‚beanFactory.getBean(â€œ&amp;beanNameâ€)</li><li>factoryBeanæœ‰å•ç‹¬çš„ç¼“å­˜factoryBeanObjectCacheï¼Œè·Ÿå…¶ä»–å®ä¾‹ä¸æ˜¯åŒä¸€ä¸ª</li></ul><p>æœ‰å…³FactoryBeançš„ä½œç”¨å’Œä¾‹å­å¯ä»¥å‚è€ƒè¿™ä½å¤§ä½¬å†™çš„ä¾‹å­-<a href="https://bestcxx.blog.csdn.net/article/details/103242240?utm_medium=distribute.pc_relevant.none-task-blog-2~default~BlogCommendFromMachineLearnPai2~default-4.vipsorttest&depth_1-utm_source=distribute.pc_relevant.none-task-blog-2~default~BlogCommendFromMachineLearnPai2~default-4.vipsorttest">Spring æºç å­¦ä¹  FactoryBean</a></p>]]></content>
      
      
      <categories>
          
          <category> Springæºç å­¦ä¹  </category>
          
      </categories>
      
      
        <tags>
            
            <tag> æºç  </tag>
            
            <tag> Spring </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ã€Springæºç å­¦ä¹ ã€‘BeanPostProccessorçš„ç†è§£</title>
      <link href="/posts/37029.html"/>
      <url>/posts/37029.html</url>
      
        <content type="html"><![CDATA[<p>BeanPostProcessor æ¥å£ç±»å‹å®ä¾‹æ˜¯é’ˆå¯¹æŸç§ç‰¹å®šåŠŸèƒ½çš„åŸ‹ç‚¹ï¼Œåœ¨è¿™ä¸ªç‚¹ä¼šæ ¹æ®æ¥å£ç±»å‹æ¥è¿‡æ»¤æ‰ä¸å…³æ³¨è¿™ä¸ªç‚¹çš„å…¶ä»–ç±»ï¼Œåªæœ‰çœŸæ­£å…³æ³¨çš„ç±»æ‰ä¼šåœ¨è¿™ä¸ªç‚¹è¿›è¡Œç›¸åº”çš„åŠŸèƒ½å®ç°ã€‚</p><h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><h2 id="Spring-åˆå§‹åŒ–æ ¸å¿ƒæµç¨‹"><a href="#Spring-åˆå§‹åŒ–æ ¸å¿ƒæµç¨‹" class="headerlink" title="Spring åˆå§‹åŒ–æ ¸å¿ƒæµç¨‹"></a>Spring åˆå§‹åŒ–æ ¸å¿ƒæµç¨‹</h2><p>springå®¹å™¨åˆå§‹åŒ–çš„æ ¸å¿ƒæ–¹æ³•AbstractApplicationContext#refreshï¼Œ</p><ul><li>refresh Spring åˆå§‹åŒ–æ ¸å¿ƒæµç¨‹å…¥å£<ul><li>prepareRefresh â‘  å‡†å¤‡æ­¤ä¸Šä¸‹æ–‡ç”¨äºåˆ·æ–°ï¼Œè®¾ç½®å¯åŠ¨æ—¶é—´å’Œactiveæ ‡å¿—ï¼Œåˆå§‹åŒ–å±æ€§</li><li>obtainFreshBeanFactory â‘¡ åˆ›å»º BeanFactory å·²ç»è·Ÿè¸ªè¿‡çš„æºç æµç¨‹</li><li>prepareBeanFactory â‘¢ è®¾ç½® BeanFactory çš„åŸºæœ¬å±æ€§</li><li>postProcessBeanFactory â‘£ å­ç±»å¤„ç†è‡ªå®šä¹‰çš„BeanFactoryPostProcess</li><li>invokeBeanFactoryPostProcessors â‘¤ è°ƒç”¨æ‰€æœ‰çš„BeanFactoryPostProcessor <strong>æœ¬èŠ‚ä¸»è¦è·Ÿè¸ªçš„æºç æµç¨‹</strong></li><li>registerBeanPostProcessors â‘¥ æ³¨å†Œï¼ŒæŠŠå®ç°äº†BeanPostProcessoræ¥å£çš„ç±»å®ä¾‹åŒ–ï¼ŒåŠ åˆ°BeanFactory <strong>æœ¬èŠ‚ä¸»è¦è·Ÿè¸ªçš„æºç æµç¨‹</strong></li><li>initMessageSource â‘¦ åˆå§‹åŒ–ä¸Šä¸‹æ–‡ä¸­çš„èµ„æºæ–‡ä»¶ï¼Œå¦‚å›½é™…åŒ–æ–‡ä»¶çš„å¤„ç†ç­‰</li><li>initApplicationEventMulticaster â‘§ åˆå§‹åŒ–ä¸Šä¸‹æ–‡çš„äº‹ä»¶ä¼ æ’­å™¨</li><li>onRefresh â‘¨ ç»™å­ç±»æ‰©å±•åˆå§‹åŒ–å…¶ä»–Beanï¼Œspringboot ä¸­ç”¨æ¥åšå†…åµŒ tomcat å¯åŠ¨</li><li>registerListeners â‘© åœ¨æ‰€æœ‰beanä¸­æŸ¥æ‰¾ç›‘å¬ beanï¼Œç„¶åæ³¨å†Œåˆ°å¹¿æ’­å™¨ä¸­</li><li>finishBeanFactoryInitialization â‘ª åˆå§‹åŒ–æ‰€æœ‰çš„å•ä¾‹Beanã€iocã€BeanPostProcessorçš„æ‰§è¡Œã€Aopå…¥å£</li><li>finishRefresh â‘« å®Œæˆåˆ·æ–°è¿‡ç¨‹ï¼Œå‘å¸ƒç›¸åº”çš„äº‹ä»¶</li></ul></li></ul><h1 id="ä¸€ã€invokeBeanFactoryPostProcessors"><a href="#ä¸€ã€invokeBeanFactoryPostProcessors" class="headerlink" title="ä¸€ã€invokeBeanFactoryPostProcessors()"></a>ä¸€ã€invokeBeanFactoryPostProcessors()</h1><h2 id="1-ä½œç”¨"><a href="#1-ä½œç”¨" class="headerlink" title="1.ä½œç”¨"></a>1.ä½œç”¨</h2><p>invokeBeanFactoryPostProcessorsæ–¹æ³•ï¼Œè´Ÿè´£æ¿€æ´»å„ç§ BeanFactory å¤„ç†å™¨ï¼Œä»¥åŠä¸¤ä¸ªæ ¸å¿ƒæ¥å£çš„è°ƒç”¨ï¼š</p><ul><li><p>BeanDefinitionRegistryPostProcessor<br>å®é™…å®Œæˆäº†å¯¹å…¶å®ç°ç±»ä¸­postProcessBeanDefinitionRegistryæ–¹æ³•çš„è°ƒç”¨ï¼Œå®Œæˆå¯¹BeanDefinitionçš„æ–°å¢ã€ä¿®æ”¹</p></li><li><p>BeanFactoryPostProcessor<br>å®é™…å®Œæˆäº†å¯¹å…¶å®ç°ç±»ä¸­postProcessBeanFactoryæ–¹æ³•çš„è°ƒç”¨ï¼›</p></li></ul><h2 id="2-æºç è·Ÿè¸ª"><a href="#2-æºç è·Ÿè¸ª" class="headerlink" title="2.æºç è·Ÿè¸ª"></a>2.æºç è·Ÿè¸ª</h2><h3 id="2-1-AbstractApplicationContext-invokeBeanFactoryPostProcessors"><a href="#2-1-AbstractApplicationContext-invokeBeanFactoryPostProcessors" class="headerlink" title="2.1.AbstractApplicationContext.invokeBeanFactoryPostProcessors()"></a>2.1.AbstractApplicationContext.invokeBeanFactoryPostProcessors()</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">//AbstractApplicationContext</span><span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">invokeBeanFactoryPostProcessors</span><span class="token punctuation">(</span><span class="token class-name">ConfigurableListableBeanFactory</span> beanFactory<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">//å§”æ´¾ç»™PostProcessorRegistrationDelegateå»å¤„ç†</span><span class="token class-name">PostProcessorRegistrationDelegate</span><span class="token punctuation">.</span><span class="token function">invokeBeanFactoryPostProcessors</span><span class="token punctuation">(</span>beanFactory<span class="token punctuation">,</span> <span class="token function">getBeanFactoryPostProcessors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// Detect a LoadTimeWeaver and prepare for weaving, if found in the meantime</span><span class="token comment">// (e.g. through an @Bean method registered by ConfigurationClassPostProcessor)</span><span class="token keyword">if</span> <span class="token punctuation">(</span>beanFactory<span class="token punctuation">.</span><span class="token function">getTempClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> beanFactory<span class="token punctuation">.</span><span class="token function">containsBean</span><span class="token punctuation">(</span><span class="token constant">LOAD_TIME_WEAVER_BEAN_NAME</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>beanFactory<span class="token punctuation">.</span><span class="token function">addBeanPostProcessor</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">LoadTimeWeaverAwareProcessor</span><span class="token punctuation">(</span>beanFactory<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>beanFactory<span class="token punctuation">.</span><span class="token function">setTempClassLoader</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ContextTypeMatchClassLoader</span><span class="token punctuation">(</span>beanFactory<span class="token punctuation">.</span><span class="token function">getBeanClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="2-2-PostProcessorRegistrationDelegate-invokeBeanFactoryPostProcessors"><a href="#2-2-PostProcessorRegistrationDelegate-invokeBeanFactoryPostProcessors" class="headerlink" title="2.2.PostProcessorRegistrationDelegate.invokeBeanFactoryPostProcessors()"></a>2.2.PostProcessorRegistrationDelegate.invokeBeanFactoryPostProcessors()</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">invokeBeanFactoryPostProcessors</span><span class="token punctuation">(</span><span class="token class-name">ConfigurableListableBeanFactory</span> beanFactory<span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">BeanFactoryPostProcessor</span><span class="token punctuation">></span></span> beanFactoryPostProcessors<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">// Invoke BeanDefinitionRegistryPostProcessors first, if any.</span><span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> processedBeans <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>beanFactory <span class="token keyword">instanceof</span> <span class="token class-name">BeanDefinitionRegistry</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token class-name">BeanDefinitionRegistry</span> registry <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">BeanDefinitionRegistry</span><span class="token punctuation">)</span> beanFactory<span class="token punctuation">;</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">BeanFactoryPostProcessor</span><span class="token punctuation">></span></span> regularPostProcessors <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">BeanDefinitionRegistryPostProcessor</span><span class="token punctuation">></span></span> registryProcessors <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">BeanFactoryPostProcessor</span> postProcessor <span class="token operator">:</span> beanFactoryPostProcessors<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>postProcessor <span class="token keyword">instanceof</span> <span class="token class-name">BeanDefinitionRegistryPostProcessor</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token class-name">BeanDefinitionRegistryPostProcessor</span> registryProcessor <span class="token operator">=</span><span class="token punctuation">(</span><span class="token class-name">BeanDefinitionRegistryPostProcessor</span><span class="token punctuation">)</span> postProcessor<span class="token punctuation">;</span>registryProcessor<span class="token punctuation">.</span><span class="token function">postProcessBeanDefinitionRegistry</span><span class="token punctuation">(</span>registry<span class="token punctuation">)</span><span class="token punctuation">;</span>registryProcessors<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>registryProcessor<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">else</span> <span class="token punctuation">&#123;</span>regularPostProcessors<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>postProcessor<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token comment">// Do not initialize FactoryBeans here: We need to leave all regular beans</span><span class="token comment">// uninitialized to let the bean factory post-processors apply to them!</span><span class="token comment">// Separate between BeanDefinitionRegistryPostProcessors that implement</span><span class="token comment">// PriorityOrdered, Ordered, and the rest.</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">BeanDefinitionRegistryPostProcessor</span><span class="token punctuation">></span></span> currentRegistryProcessors <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//è·å–å®ç°äº†BeanDefinitionRegistryPostProcessoræ¥å£çš„æ‰€æœ‰ç±»çš„BeanDefinitionå¯¹è±¡çš„beanName</span><span class="token comment">// 1ã€æœ€å…ˆè°ƒç”¨çš„æ˜¯å®ç°äº† PriorityOrdered æ¥å£çš„æ‰€æœ‰BeanDefinitionRegistryPostProcessor</span><span class="token comment">// ä¸­çš„ postProcessBeanDefinitionRegistryçš„æ–¹æ³•</span><span class="token comment">// First, invoke the BeanDefinitionRegistryPostProcessors that implement PriorityOrdered.</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> postProcessorNames <span class="token operator">=</span>beanFactory<span class="token punctuation">.</span><span class="token function">getBeanNamesForType</span><span class="token punctuation">(</span><span class="token class-name">BeanDefinitionRegistryPostProcessor</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> ppName <span class="token operator">:</span> postProcessorNames<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">// åˆ¤æ–­æ˜¯å¦å®ç°äº†æ’åºæ¥å£ PriorityOrdered</span><span class="token keyword">if</span> <span class="token punctuation">(</span>beanFactory<span class="token punctuation">.</span><span class="token function">isTypeMatch</span><span class="token punctuation">(</span>ppName<span class="token punctuation">,</span> <span class="token class-name">PriorityOrdered</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>currentRegistryProcessors<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>beanFactory<span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span>ppName<span class="token punctuation">,</span> <span class="token class-name">BeanDefinitionRegistryPostProcessor</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>processedBeans<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>ppName<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token comment">//æ’åº</span><span class="token function">sortPostProcessors</span><span class="token punctuation">(</span>currentRegistryProcessors<span class="token punctuation">,</span> beanFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>registryProcessors<span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span>currentRegistryProcessors<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//è°ƒç”¨è¿‡ç¨‹</span><span class="token function">invokeBeanDefinitionRegistryPostProcessors</span><span class="token punctuation">(</span>currentRegistryProcessors<span class="token punctuation">,</span> registry<span class="token punctuation">)</span><span class="token punctuation">;</span>currentRegistryProcessors<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 2ã€å…¶æ¬¡è°ƒç”¨çš„æ˜¯å®ç°äº† Ordered æ¥å£çš„æ‰€æœ‰BeanDefinitionRegistryPostProcessor</span><span class="token comment">// ä¸­çš„ postProcessBeanDefinitionRegistryçš„æ–¹æ³•</span><span class="token comment">// Next, invoke the BeanDefinitionRegistryPostProcessors that implement Ordered.</span>postProcessorNames <span class="token operator">=</span> beanFactory<span class="token punctuation">.</span><span class="token function">getBeanNamesForType</span><span class="token punctuation">(</span><span class="token class-name">BeanDefinitionRegistryPostProcessor</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> ppName <span class="token operator">:</span> postProcessorNames<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">//åˆ¤æ–­æ˜¯å¦æ˜¯å®ç°çš„Orderedæ¥å£</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>processedBeans<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>ppName<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> beanFactory<span class="token punctuation">.</span><span class="token function">isTypeMatch</span><span class="token punctuation">(</span>ppName<span class="token punctuation">,</span> <span class="token class-name">Ordered</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>currentRegistryProcessors<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>beanFactory<span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span>ppName<span class="token punctuation">,</span> <span class="token class-name">BeanDefinitionRegistryPostProcessor</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>processedBeans<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>ppName<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token function">sortPostProcessors</span><span class="token punctuation">(</span>currentRegistryProcessors<span class="token punctuation">,</span> beanFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>registryProcessors<span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span>currentRegistryProcessors<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">invokeBeanDefinitionRegistryPostProcessors</span><span class="token punctuation">(</span>currentRegistryProcessors<span class="token punctuation">,</span> registry<span class="token punctuation">)</span><span class="token punctuation">;</span>currentRegistryProcessors<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 3ã€æœ€åè°ƒç”¨çš„æ˜¯æ²¡å®ç°æ’åºæ¥å£çš„æ‰€æœ‰å®ç°BeanDefinitionRegistryPostProcessoræ¥å£</span><span class="token comment">// ä¸­çš„ postProcessBeanDefinitionRegistryçš„æ–¹æ³•</span><span class="token comment">// Finally, invoke all other BeanDefinitionRegistryPostProcessors until no further ones appear.</span><span class="token keyword">boolean</span> reiterate <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span><span class="token keyword">while</span> <span class="token punctuation">(</span>reiterate<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>reiterate <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>postProcessorNames <span class="token operator">=</span> beanFactory<span class="token punctuation">.</span><span class="token function">getBeanNamesForType</span><span class="token punctuation">(</span><span class="token class-name">BeanDefinitionRegistryPostProcessor</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> ppName <span class="token operator">:</span> postProcessorNames<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>processedBeans<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>ppName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>currentRegistryProcessors<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>beanFactory<span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span>ppName<span class="token punctuation">,</span> <span class="token class-name">BeanDefinitionRegistryPostProcessor</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>processedBeans<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>ppName<span class="token punctuation">)</span><span class="token punctuation">;</span>reiterate <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token function">sortPostProcessors</span><span class="token punctuation">(</span>currentRegistryProcessors<span class="token punctuation">,</span> beanFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>registryProcessors<span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span>currentRegistryProcessors<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">invokeBeanDefinitionRegistryPostProcessors</span><span class="token punctuation">(</span>currentRegistryProcessors<span class="token punctuation">,</span> registry<span class="token punctuation">)</span><span class="token punctuation">;</span>currentRegistryProcessors<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">//è°ƒç”¨postProcessBeanFactoryæ–¹æ³•</span><span class="token comment">// Now, invoke the postProcessBeanFactory callback of all processors handled so far.</span><span class="token function">invokeBeanFactoryPostProcessors</span><span class="token punctuation">(</span>registryProcessors<span class="token punctuation">,</span> beanFactory<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">invokeBeanFactoryPostProcessors</span><span class="token punctuation">(</span>regularPostProcessors<span class="token punctuation">,</span> beanFactory<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">else</span> <span class="token punctuation">&#123;</span><span class="token comment">// Invoke factory processors registered with the context instance.</span><span class="token function">invokeBeanFactoryPostProcessors</span><span class="token punctuation">(</span>beanFactoryPostProcessors<span class="token punctuation">,</span> beanFactory<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">//è·å–å®ç°äº†BeanFactoryPostProcessoræ¥å£çš„ç±»ï¼Œè·å–beanDefinitionçš„åç§°</span><span class="token comment">// Do not initialize FactoryBeans here: We need to leave all regular beans</span><span class="token comment">// uninitialized to let the bean factory post-processors apply to them!</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> postProcessorNames <span class="token operator">=</span>beanFactory<span class="token punctuation">.</span><span class="token function">getBeanNamesForType</span><span class="token punctuation">(</span><span class="token class-name">BeanFactoryPostProcessor</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// Separate between BeanFactoryPostProcessors that implement PriorityOrdered,</span><span class="token comment">// Ordered, and the rest.</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">BeanFactoryPostProcessor</span><span class="token punctuation">></span></span> priorityOrderedPostProcessors <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> orderedPostProcessorNames <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> nonOrderedPostProcessorNames <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> ppName <span class="token operator">:</span> postProcessorNames<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>processedBeans<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>ppName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">// skip - already processed in first phase above</span><span class="token punctuation">&#125;</span><span class="token comment">//å®ç°äº†PriorityOrderedæ¥å£çš„</span><span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>beanFactory<span class="token punctuation">.</span><span class="token function">isTypeMatch</span><span class="token punctuation">(</span>ppName<span class="token punctuation">,</span> <span class="token class-name">PriorityOrdered</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>priorityOrderedPostProcessors<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>beanFactory<span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span>ppName<span class="token punctuation">,</span> <span class="token class-name">BeanFactoryPostProcessor</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">//å®ç°äº†Orderedæ¥å£çš„</span><span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>beanFactory<span class="token punctuation">.</span><span class="token function">isTypeMatch</span><span class="token punctuation">(</span>ppName<span class="token punctuation">,</span> <span class="token class-name">Ordered</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>orderedPostProcessorNames<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>ppName<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">else</span> <span class="token punctuation">&#123;</span><span class="token comment">//æ²¡å®ç°æ¥å£çš„</span>nonOrderedPostProcessorNames<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>ppName<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token comment">//æ’åº</span><span class="token comment">// First, invoke the BeanFactoryPostProcessors that implement PriorityOrdered.</span><span class="token function">sortPostProcessors</span><span class="token punctuation">(</span>priorityOrderedPostProcessors<span class="token punctuation">,</span> beanFactory<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//è°ƒç”¨</span><span class="token function">invokeBeanFactoryPostProcessors</span><span class="token punctuation">(</span>priorityOrderedPostProcessors<span class="token punctuation">,</span> beanFactory<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// Next, invoke the BeanFactoryPostProcessors that implement Ordered.</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">BeanFactoryPostProcessor</span><span class="token punctuation">></span></span> orderedPostProcessors <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span>orderedPostProcessorNames<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> postProcessorName <span class="token operator">:</span> orderedPostProcessorNames<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>orderedPostProcessors<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>beanFactory<span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span>postProcessorName<span class="token punctuation">,</span> <span class="token class-name">BeanFactoryPostProcessor</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token function">sortPostProcessors</span><span class="token punctuation">(</span>orderedPostProcessors<span class="token punctuation">,</span> beanFactory<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">invokeBeanFactoryPostProcessors</span><span class="token punctuation">(</span>orderedPostProcessors<span class="token punctuation">,</span> beanFactory<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// Finally, invoke all other BeanFactoryPostProcessors.</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">BeanFactoryPostProcessor</span><span class="token punctuation">></span></span> nonOrderedPostProcessors <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span>nonOrderedPostProcessorNames<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> postProcessorName <span class="token operator">:</span> nonOrderedPostProcessorNames<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>nonOrderedPostProcessors<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>beanFactory<span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span>postProcessorName<span class="token punctuation">,</span> <span class="token class-name">BeanFactoryPostProcessor</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token function">invokeBeanFactoryPostProcessors</span><span class="token punctuation">(</span>nonOrderedPostProcessors<span class="token punctuation">,</span> beanFactory<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// Clear cached merged bean definitions since the post-processors might have</span><span class="token comment">// modified the original metadata, e.g. replacing placeholders in values...</span>beanFactory<span class="token punctuation">.</span><span class="token function">clearMetadataCache</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="2-3-invokeBeanDefinitionRegistryPostProcessors"><a href="#2-3-invokeBeanDefinitionRegistryPostProcessors" class="headerlink" title="2.3.invokeBeanDefinitionRegistryPostProcessors()"></a>2.3.invokeBeanDefinitionRegistryPostProcessors()</h3><p>è°ƒç”¨BeanDefinitionRegistryPostProcessorçš„postProcessBeanDefinitionRegistry()æ–¹æ³•ï¼Œå®Œæˆå¯¹BeanDefinitionçš„æ–°å¢ã€ä¿®æ”¹</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">invokeBeanDefinitionRegistryPostProcessors</span><span class="token punctuation">(</span><span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">BeanDefinitionRegistryPostProcessor</span><span class="token punctuation">></span></span> postProcessors<span class="token punctuation">,</span> <span class="token class-name">BeanDefinitionRegistry</span> registry<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">BeanDefinitionRegistryPostProcessor</span> postProcessor <span class="token operator">:</span> postProcessors<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>postProcessor<span class="token punctuation">.</span><span class="token function">postProcessBeanDefinitionRegistry</span><span class="token punctuation">(</span>registry<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="2-4-invokeBeanFactoryPostProcessors"><a href="#2-4-invokeBeanFactoryPostProcessors" class="headerlink" title="2.4.invokeBeanFactoryPostProcessors()"></a>2.4.invokeBeanFactoryPostProcessors()</h3><p>è°ƒç”¨BeanFactoryPostProcessorçš„postProcessBeanFactory()æ–¹æ³•ï¼Œå®Œæˆå¯¹BeanFactoryçš„ä¿®æ”¹</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">invokeBeanFactoryPostProcessors</span><span class="token punctuation">(</span><span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">BeanFactoryPostProcessor</span><span class="token punctuation">></span></span> postProcessors<span class="token punctuation">,</span> <span class="token class-name">ConfigurableListableBeanFactory</span> beanFactory<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">BeanFactoryPostProcessor</span> postProcessor <span class="token operator">:</span> postProcessors<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>postProcessor<span class="token punctuation">.</span><span class="token function">postProcessBeanFactory</span><span class="token punctuation">(</span>beanFactory<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h1 id="äºŒã€registerBeanPostProcessors"><a href="#äºŒã€registerBeanPostProcessors" class="headerlink" title="äºŒã€registerBeanPostProcessors()"></a>äºŒã€registerBeanPostProcessors()</h1><p>registerBeanPostProcessorsæ–¹æ³•ä¸»è¦æŠŠå®ç°äº†BeanPostProcessoræ¥å£çš„ç±»å®ä¾‹åŒ–ï¼Œå¹¶ä¸”åŠ å…¥åˆ°BeanFactoryä¸­</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">registerBeanPostProcessors</span><span class="token punctuation">(</span><span class="token class-name">ConfigurableListableBeanFactory</span> beanFactory<span class="token punctuation">,</span> <span class="token class-name">AbstractApplicationContext</span> applicationContext<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">//æ‹¿åˆ°å·¥ç¨‹é‡Œé¢æ‰€æœ‰å®ç°äº†BeanPostProcessoræ¥å£çš„ç±»ï¼Œè·å–åˆ°BeanDefinitionçš„åç§°</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> postProcessorNames <span class="token operator">=</span> beanFactory<span class="token punctuation">.</span><span class="token function">getBeanNamesForType</span><span class="token punctuation">(</span><span class="token class-name">BeanPostProcessor</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// Register BeanPostProcessorChecker that logs an info message when</span><span class="token comment">// a bean is created during BeanPostProcessor instantiation, i.e. when</span><span class="token comment">// a bean is not eligible for getting processed by all BeanPostProcessors.</span><span class="token comment">//beanFactory.getBeanPostProcessorCount()ä¼šå¾—åˆ°é»˜è®¤å®¹å™¨ä¸­æ³¨å†Œçš„ BeanPostProcessor ä¸ªæ•°ï¼Œå®é™…å°±æ˜¯è°ƒç”¨ List&lt;BeanPostProcessor> beanPostProcessors = new CopyOnWriteArrayList&lt;>()çš„size()æ–¹æ³•ï¼Œé»˜è®¤çš„å®¹å™¨æ³¨å†Œçš„ BeanPostProcessor æœ‰ï¼š</span><span class="token comment">//ApplicationContextAwarePostProcessor</span><span class="token comment">//ApplicationListenerDetector</span><span class="token comment">//ConfigurationClassPostProcessor</span><span class="token comment">//PostProcessorRegistrationDelegate</span><span class="token keyword">int</span> beanProcessorTargetCount <span class="token operator">=</span> beanFactory<span class="token punctuation">.</span><span class="token function">getBeanPostProcessorCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span> <span class="token operator">+</span> postProcessorNames<span class="token punctuation">.</span>length<span class="token punctuation">;</span>beanFactory<span class="token punctuation">.</span><span class="token function">addBeanPostProcessor</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BeanPostProcessorChecker</span><span class="token punctuation">(</span>beanFactory<span class="token punctuation">,</span> beanProcessorTargetCount<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// Separate between BeanPostProcessors that implement PriorityOrdered,</span><span class="token comment">// Ordered, and the rest.</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">BeanPostProcessor</span><span class="token punctuation">></span></span> priorityOrderedPostProcessors <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">BeanPostProcessor</span><span class="token punctuation">></span></span> internalPostProcessors <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> orderedPostProcessorNames <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> nonOrderedPostProcessorNames <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//æå‰å®ä¾‹åŒ–BeanPostProcessorç±»å‹çš„beanï¼Œç„¶åbeanè¿›è¡Œæ’åº</span><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> ppName <span class="token operator">:</span> postProcessorNames<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>beanFactory<span class="token punctuation">.</span><span class="token function">isTypeMatch</span><span class="token punctuation">(</span>ppName<span class="token punctuation">,</span> <span class="token class-name">PriorityOrdered</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">//getBeanæ˜¯å®ä¾‹åŒ–æ–¹æ³•ï¼Œåé¢æˆ‘ä»¬åœ¨è®²beanå®ä¾‹åŒ–è¿‡ç¨‹æ˜¯ä¼šç€é‡è®²åˆ°</span><span class="token class-name">BeanPostProcessor</span> pp <span class="token operator">=</span> beanFactory<span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span>ppName<span class="token punctuation">,</span> <span class="token class-name">BeanPostProcessor</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>priorityOrderedPostProcessors<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>pp<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//åˆ¤æ–­ç±»å‹æ˜¯å¦æ˜¯MergedBeanDefinitionPostProcessorï¼Œå¦‚æœæ˜¯åˆ™ä»£ç æ˜¯å†…éƒ¨ä½¿ç”¨çš„</span><span class="token keyword">if</span> <span class="token punctuation">(</span>pp <span class="token keyword">instanceof</span> <span class="token class-name">MergedBeanDefinitionPostProcessor</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>internalPostProcessors<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>pp<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>beanFactory<span class="token punctuation">.</span><span class="token function">isTypeMatch</span><span class="token punctuation">(</span>ppName<span class="token punctuation">,</span> <span class="token class-name">Ordered</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>orderedPostProcessorNames<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>ppName<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">else</span> <span class="token punctuation">&#123;</span>nonOrderedPostProcessorNames<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>ppName<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token comment">// First, register the BeanPostProcessors that implement PriorityOrdered.</span><span class="token function">sortPostProcessors</span><span class="token punctuation">(</span>priorityOrderedPostProcessors<span class="token punctuation">,</span> beanFactory<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//æ³¨å†Œåˆ°BeanFactoryä¸­</span><span class="token function">registerBeanPostProcessors</span><span class="token punctuation">(</span>beanFactory<span class="token punctuation">,</span> priorityOrderedPostProcessors<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// Next, register the BeanPostProcessors that implement Ordered.</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">BeanPostProcessor</span><span class="token punctuation">></span></span> orderedPostProcessors <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span>orderedPostProcessorNames<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> ppName <span class="token operator">:</span> orderedPostProcessorNames<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token class-name">BeanPostProcessor</span> pp <span class="token operator">=</span> beanFactory<span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span>ppName<span class="token punctuation">,</span> <span class="token class-name">BeanPostProcessor</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>orderedPostProcessors<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>pp<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>pp <span class="token keyword">instanceof</span> <span class="token class-name">MergedBeanDefinitionPostProcessor</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>internalPostProcessors<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>pp<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token function">sortPostProcessors</span><span class="token punctuation">(</span>orderedPostProcessors<span class="token punctuation">,</span> beanFactory<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">registerBeanPostProcessors</span><span class="token punctuation">(</span>beanFactory<span class="token punctuation">,</span> orderedPostProcessors<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// Now, register all regular BeanPostProcessors.</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">BeanPostProcessor</span><span class="token punctuation">></span></span> nonOrderedPostProcessors <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span>nonOrderedPostProcessorNames<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> ppName <span class="token operator">:</span> nonOrderedPostProcessorNames<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token class-name">BeanPostProcessor</span> pp <span class="token operator">=</span> beanFactory<span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span>ppName<span class="token punctuation">,</span> <span class="token class-name">BeanPostProcessor</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>nonOrderedPostProcessors<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>pp<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>pp <span class="token keyword">instanceof</span> <span class="token class-name">MergedBeanDefinitionPostProcessor</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>internalPostProcessors<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>pp<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token function">registerBeanPostProcessors</span><span class="token punctuation">(</span>beanFactory<span class="token punctuation">,</span> nonOrderedPostProcessors<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// Finally, re-register all internal BeanPostProcessors.</span><span class="token function">sortPostProcessors</span><span class="token punctuation">(</span>internalPostProcessors<span class="token punctuation">,</span> beanFactory<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">registerBeanPostProcessors</span><span class="token punctuation">(</span>beanFactory<span class="token punctuation">,</span> internalPostProcessors<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// Re-register post-processor for detecting inner beans as ApplicationListeners,</span><span class="token comment">// moving it to the end of the processor chain (for picking up proxies etc).</span>beanFactory<span class="token punctuation">.</span><span class="token function">addBeanPostProcessor</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ApplicationListenerDetector</span><span class="token punctuation">(</span>applicationContext<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è¿›å…¥registerBeanPostProcessors()æ–¹æ³•ï¼Œæ³¨å†Œè¿‡ç¨‹</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/** * æ³¨å†Œå½“å‰çš„ BeanPostProcessor*/</span><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">registerBeanPostProcessors</span><span class="token punctuation">(</span><span class="token class-name">ConfigurableListableBeanFactory</span> beanFactory<span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">BeanPostProcessor</span><span class="token punctuation">></span></span> postProcessors<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">BeanPostProcessor</span> postProcessor <span class="token operator">:</span> postProcessors<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">// æ·»åŠ åˆ°List&lt;BeanPostProcessor> beanPostProcessors</span>beanFactory<span class="token punctuation">.</span><span class="token function">addBeanPostProcessor</span><span class="token punctuation">(</span>postProcessor<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h1 id="ä¸‰ã€æ€»ç»“"><a href="#ä¸‰ã€æ€»ç»“" class="headerlink" title="ä¸‰ã€æ€»ç»“"></a>ä¸‰ã€æ€»ç»“</h1><p>invokeBeanFactoryPostProcessorså’ŒregisterBeanPostProcessorsä¸¤ä¸ªæ–¹æ³•çš„å¤„ç†æµç¨‹åŸºæœ¬ä¸€è‡´ï¼Œéƒ½åˆ†åˆ«å¯¹å®ç°æ¥å£çš„ç±»å®ä¾‹åŒ–è°ƒç”¨ï¼š</p><ul><li>é¦–å…ˆå¯¹å®ç° PriorityOrdered æ¥å£çš„ beanPostProcessors æ’åºè°ƒç”¨</li><li>å…¶æ¬¡å¯¹å®ç° Ordered æ¥å£çš„ beanPostProcessors æ’åºè°ƒç”¨</li><li>æœ€åå¯¹æ²¡æœ‰å®ç°æ’åºæ¥å£çš„ beanPostProcessors è°ƒç”¨</li></ul><h2 id="1-BeanPostProcessor"><a href="#1-BeanPostProcessor" class="headerlink" title="1.BeanPostProcessor"></a>1.BeanPostProcessor</h2><p>BeanPostProcessoræœ‰ä¸¤ä¸ªæ–¹æ³•ï¼Œ</p><ul><li>postProcessBeforeInitialization</li><li>postProcessAfterInitializationã€‚</li></ul><p>å®ƒä»¬åˆ†åˆ«åœ¨ä»»ä½•beanåˆå§‹åŒ–å›è°ƒä¹‹å‰æˆ–ä¹‹åæ‰§è¡Œï¼ˆä¾‹å¦‚InitializingBeançš„afterPropertiesSetæ–¹æ³•æˆ–è‡ªå®šä¹‰init-methodæ–¹æ³•ä¹‹å‰æˆ–è€…ä¹‹åï¼‰ï¼Œ åœ¨è¿™ä¸ªæ—¶å€™è¯¥beançš„å±æ€§å€¼å·²ç»å¡«å……å®Œæˆäº†ï¼Œå¹¶ä¸”æˆ‘ä»¬è¿”å›çš„beanå®ä¾‹å¯èƒ½å·²ç»æ˜¯åŸå§‹å®ä¾‹çš„åŒ…è£…ç±»å‹äº†ã€‚ä¾‹å¦‚è¿”å›ä¸€ä¸ªFactoryBeanã€‚</p><p>åœ¨æœ¬ç« å¼€å¤´ï¼Œæˆ‘ä»¬ä¹Ÿè¯´è¿‡ï¼ŒBeanPostProcessor æ¥å£ç±»å‹çš„å®ä¾‹æ˜¯é’ˆå¯¹æŸç§ç‰¹å®šåŠŸèƒ½çš„åŸ‹ç‚¹ï¼Œåœ¨è¿™ä¸ªç‚¹ä¼šæ ¹æ®æ¥å£ç±»å‹æ¥è¿‡æ»¤æ‰ä¸å…³æ³¨è¿™ä¸ªç‚¹çš„å…¶ä»–ç±»ï¼Œåªæœ‰çœŸæ­£å…³æ³¨çš„ç±»æ‰ä¼šåœ¨è¿™ä¸ªç‚¹è¿›è¡Œç›¸åº”çš„åŠŸèƒ½å®ç°ã€‚ç°åœ¨æ¥æ€»ç»“ä¸‹è¿™äº›åŸ‹ç‚¹ã€‚</p><h3 id="1-1-è·å–æœ‰-Autowired-æ³¨è§£çš„æ„é€ å‡½æ•°åŸ‹ç‚¹"><a href="#1-1-è·å–æœ‰-Autowired-æ³¨è§£çš„æ„é€ å‡½æ•°åŸ‹ç‚¹" class="headerlink" title="1.1.è·å–æœ‰@Autowired æ³¨è§£çš„æ„é€ å‡½æ•°åŸ‹ç‚¹"></a>1.1.è·å–æœ‰@Autowired æ³¨è§£çš„æ„é€ å‡½æ•°åŸ‹ç‚¹</h3><ul><li>è¿‡æ»¤çš„æ¥å£ç±»å‹æ˜¯ï¼šSmartInstantiationAwareBeanPostProcessor</li><li>è°ƒç”¨çš„æ–¹æ³•æ˜¯ï¼šdetermineCandidateConstructors</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">//AbstractAutowireCapableBeanFactory</span><span class="token keyword">protected</span> <span class="token class-name">BeanWrapper</span> <span class="token function">createBeanInstance</span><span class="token punctuation">(</span><span class="token class-name">String</span> beanName<span class="token punctuation">,</span> <span class="token class-name">RootBeanDefinition</span> mbd<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">//......çœç•¥éƒ¨åˆ†ä»£ç </span><span class="token comment">//å¯»æ‰¾å½“å‰æ­£åœ¨å®ä¾‹åŒ–çš„beanä¸­æœ‰@Autowiredæ³¨è§£çš„æ„é€ å‡½æ•°</span><span class="token class-name">Constructor</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> ctors <span class="token operator">=</span> <span class="token function">determineConstructorsFromBeanPostProcessors</span><span class="token punctuation">(</span>beanClass<span class="token punctuation">,</span> beanName<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>ctors <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">||</span> mbd<span class="token punctuation">.</span><span class="token function">getResolvedAutowireMode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token constant">AUTOWIRE_CONSTRUCTOR</span> <span class="token operator">||</span>mbd<span class="token punctuation">.</span><span class="token function">hasConstructorArgumentValues</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token operator">!</span><span class="token class-name">ObjectUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">//å¦‚æœctorsä¸ä¸ºç©ºï¼Œå°±è¯´æ˜æ„é€ å‡½æ•°ä¸Šæœ‰@Autowiredæ³¨è§£</span><span class="token keyword">return</span> <span class="token function">autowireConstructor</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> mbd<span class="token punctuation">,</span> ctors<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">//......çœç•¥éƒ¨åˆ†ä»£ç </span><span class="token punctuation">&#125;</span><span class="token keyword">protected</span> <span class="token class-name">Constructor</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">determineConstructorsFromBeanPostProcessors</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Nullable</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span> beanClass<span class="token punctuation">,</span> <span class="token class-name">String</span> beanName<span class="token punctuation">)</span><span class="token keyword">throws</span> <span class="token class-name">BeansException</span> <span class="token punctuation">&#123;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>beanClass <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token function">hasInstantiationAwareBeanPostProcessors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">// æ‹¿åˆ° BeanPostProcessor çš„æ‰€æœ‰æ¥å£ï¼Œéå†</span><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">BeanPostProcessor</span> bp <span class="token operator">:</span> <span class="token function">getBeanPostProcessors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>bp <span class="token keyword">instanceof</span> <span class="token class-name">SmartInstantiationAwareBeanPostProcessor</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token class-name">SmartInstantiationAwareBeanPostProcessor</span> ibp <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">SmartInstantiationAwareBeanPostProcessor</span><span class="token punctuation">)</span> bp<span class="token punctuation">;</span><span class="token comment">// è·å–åˆ°æœ‰@Autowiredæ³¨è§£ä¿¡æ¯çš„æ„é€ å‡½æ•°</span><span class="token class-name">Constructor</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> ctors <span class="token operator">=</span> ibp<span class="token punctuation">.</span><span class="token function">determineCandidateConstructors</span><span class="token punctuation">(</span>beanClass<span class="token punctuation">,</span> beanName<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>ctors <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">return</span> ctors<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è€Œè¿™ä¸ªSmartInstantiationAwareBeanPostProcessoræ™ºèƒ½å®ä¾‹åŒ–Beançš„åå¤„ç†å™¨ï¼Œä¸»è¦æä¾›äº†ä¸‰ä¸ªæ–¹æ³•ï¼š</p><ul><li>predictBeanTypeï¼šé¢„æµ‹ä»æ­¤å¤„ç†å™¨çš„postProcessBeforeInstantiationå›è°ƒæœ€ç»ˆè¿”å›çš„beançš„ç±»å‹ã€‚</li><li>determineCandidateConstructorsï¼šç¡®å®šåˆé€‚çš„å®ä¾‹åŒ–Beançš„æ„é€ å‡½æ•°ã€‚</li><li>getEarlyBeanReferenceï¼šè·å–ææ—©æš´éœ²çš„Beançš„å¼•ç”¨ï¼Œææ—©æš´éœ²çš„Beanå°±æ˜¯åªå®Œæˆäº†å®ä¾‹åŒ–ï¼Œè¿˜æœªå®Œæˆå±æ€§èµ‹å€¼å’Œåˆå§‹åŒ–çš„Beanã€‚</li></ul><h3 id="1-2-æ”¶é›†-Resource-Autowired-Value-PostConstructï¼Œ-PreDestroy-æ³¨è§£çš„æ–¹æ³•å’Œå±æ€§åŸ‹ç‚¹"><a href="#1-2-æ”¶é›†-Resource-Autowired-Value-PostConstructï¼Œ-PreDestroy-æ³¨è§£çš„æ–¹æ³•å’Œå±æ€§åŸ‹ç‚¹" class="headerlink" title="1.2.æ”¶é›†@Resource@Autowired@Value@PostConstructï¼Œ@PreDestroy æ³¨è§£çš„æ–¹æ³•å’Œå±æ€§åŸ‹ç‚¹"></a>1.2.æ”¶é›†@Resource@Autowired@Value@PostConstructï¼Œ@PreDestroy æ³¨è§£çš„æ–¹æ³•å’Œå±æ€§åŸ‹ç‚¹</h3><ul><li>è¿‡æ»¤çš„æ¥å£ç±»å‹æ˜¯ï¼šMergedBeanDefinitionPostProcessor</li><li>è°ƒç”¨çš„æ–¹æ³•æ˜¯ï¼špostProcessMergedBeanDefinition</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">//AbstractAutowireCapableBeanFactory</span><span class="token keyword">protected</span> <span class="token class-name">Object</span> <span class="token function">doCreateBean</span><span class="token punctuation">(</span><span class="token class-name">String</span> beanName<span class="token punctuation">,</span> <span class="token class-name">RootBeanDefinition</span> mbd<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">BeanCreationException</span> <span class="token punctuation">&#123;</span><span class="token comment">//......çœç•¥éƒ¨åˆ†ä»£ç </span><span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mbd<span class="token punctuation">.</span>postProcessingLock<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mbd<span class="token punctuation">.</span>postProcessed<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">try</span> <span class="token punctuation">&#123;</span><span class="token comment">//CommonAnnotationBeanPostProcessor  æ”¯æŒäº†@PostConstructï¼Œ@PreDestroy,@Resourceæ³¨è§£</span><span class="token comment">//AutowiredAnnotationBeanPostProcessor æ”¯æŒ @Autowired,@Valueæ³¨è§£</span><span class="token comment">//BeanPostProcessoræ¥å£çš„å…¸å‹è¿ç”¨ï¼Œè¿™é‡Œè¦ç†è§£è¿™ä¸ªæ¥å£</span><span class="token comment">//å¯¹ç±»ä¸­æ³¨è§£çš„è£…é…è¿‡ç¨‹</span><span class="token comment">//é‡è¦ç¨‹åº¦5ï¼Œå¿…é¡»çœ‹</span><span class="token function">applyMergedBeanDefinitionPostProcessors</span><span class="token punctuation">(</span>mbd<span class="token punctuation">,</span> beanType<span class="token punctuation">,</span> beanName<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> ex<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BeanCreationException</span><span class="token punctuation">(</span>mbd<span class="token punctuation">.</span><span class="token function">getResourceDescription</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> beanName<span class="token punctuation">,</span><span class="token string">"Post-processing of merged bean definition failed"</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span>mbd<span class="token punctuation">.</span>postProcessed <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token comment">//......çœç•¥éƒ¨åˆ†ä»£ç </span><span class="token punctuation">&#125;</span><span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">applyMergedBeanDefinitionPostProcessors</span><span class="token punctuation">(</span><span class="token class-name">RootBeanDefinition</span> mbd<span class="token punctuation">,</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span> beanType<span class="token punctuation">,</span> <span class="token class-name">String</span> beanName<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">BeanPostProcessor</span> bp <span class="token operator">:</span> <span class="token function">getBeanPostProcessors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>bp <span class="token keyword">instanceof</span> <span class="token class-name">MergedBeanDefinitionPostProcessor</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token class-name">MergedBeanDefinitionPostProcessor</span> bdp <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">MergedBeanDefinitionPostProcessor</span><span class="token punctuation">)</span> bp<span class="token punctuation">;</span>bdp<span class="token punctuation">.</span><span class="token function">postProcessMergedBeanDefinition</span><span class="token punctuation">(</span>mbd<span class="token punctuation">,</span> beanType<span class="token punctuation">,</span> beanName<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="1-3-å¾ªç¯ä¾èµ–è§£å†³ä¸­bean-çš„æå‰æš´éœ²åŸ‹ç‚¹"><a href="#1-3-å¾ªç¯ä¾èµ–è§£å†³ä¸­bean-çš„æå‰æš´éœ²åŸ‹ç‚¹" class="headerlink" title="1.3.å¾ªç¯ä¾èµ–è§£å†³ä¸­bean çš„æå‰æš´éœ²åŸ‹ç‚¹"></a>1.3.å¾ªç¯ä¾èµ–è§£å†³ä¸­bean çš„æå‰æš´éœ²åŸ‹ç‚¹</h3><ul><li>è¿‡æ»¤çš„æ¥å£ç±»å‹æ˜¯ï¼šSmartInstantiationAwareBeanPostProcessor</li><li>è°ƒç”¨çš„æ–¹æ³•æ˜¯ï¼šgetEarlyBeanReference</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">protected</span> <span class="token class-name">Object</span> <span class="token function">getEarlyBeanReference</span><span class="token punctuation">(</span><span class="token class-name">String</span> beanName<span class="token punctuation">,</span> <span class="token class-name">RootBeanDefinition</span> mbd<span class="token punctuation">,</span> <span class="token class-name">Object</span> bean<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token class-name">Object</span> exposedObject <span class="token operator">=</span> bean<span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mbd<span class="token punctuation">.</span><span class="token function">isSynthetic</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">hasInstantiationAwareBeanPostProcessors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">BeanPostProcessor</span> bp <span class="token operator">:</span> <span class="token function">getBeanPostProcessors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>bp <span class="token keyword">instanceof</span> <span class="token class-name">SmartInstantiationAwareBeanPostProcessor</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token class-name">SmartInstantiationAwareBeanPostProcessor</span> ibp <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">SmartInstantiationAwareBeanPostProcessor</span><span class="token punctuation">)</span> bp<span class="token punctuation">;</span>exposedObject <span class="token operator">=</span> ibp<span class="token punctuation">.</span><span class="token function">getEarlyBeanReference</span><span class="token punctuation">(</span>exposedObject<span class="token punctuation">,</span> beanName<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">return</span> exposedObject<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="1-4-é˜»æ­¢ä¾èµ–æ³¨å…¥åŸ‹ç‚¹"><a href="#1-4-é˜»æ­¢ä¾èµ–æ³¨å…¥åŸ‹ç‚¹" class="headerlink" title="1.4.é˜»æ­¢ä¾èµ–æ³¨å…¥åŸ‹ç‚¹"></a>1.4.é˜»æ­¢ä¾èµ–æ³¨å…¥åŸ‹ç‚¹</h3><ul><li>è¿‡æ»¤çš„æ¥å£ç±»å‹æ˜¯ï¼šInstantiationAwareBeanPostProcessor</li><li>è°ƒç”¨çš„æ–¹æ³•æ˜¯ï¼špostProcessAfterInstantiation</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">//AbstractAutowireCapableBeanFactory</span><span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">populateBean</span><span class="token punctuation">(</span><span class="token class-name">String</span> beanName<span class="token punctuation">,</span> <span class="token class-name">RootBeanDefinition</span> mbd<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">BeanWrapper</span> bw<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">//......çœç•¥éƒ¨åˆ†ä»£ç </span><span class="token comment">//è¿™é‡Œå¾ˆæœ‰æ„æ€ï¼Œå†™æ¥å£å¯ä»¥è®©æ‰€æœ‰ç±»éƒ½ä¸èƒ½ä¾èµ–æ³¨å…¥</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mbd<span class="token punctuation">.</span><span class="token function">isSynthetic</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">hasInstantiationAwareBeanPostProcessors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">BeanPostProcessor</span> bp <span class="token operator">:</span> <span class="token function">getBeanPostProcessors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>bp <span class="token keyword">instanceof</span> <span class="token class-name">InstantiationAwareBeanPostProcessor</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token class-name">InstantiationAwareBeanPostProcessor</span> ibp <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">InstantiationAwareBeanPostProcessor</span><span class="token punctuation">)</span> bp<span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ibp<span class="token punctuation">.</span><span class="token function">postProcessAfterInstantiation</span><span class="token punctuation">(</span>bw<span class="token punctuation">.</span><span class="token function">getWrappedInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> beanName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">return</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token comment">//......çœç•¥éƒ¨åˆ†ä»£ç </span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="1-5-IOC-x2F-DI-ä¾èµ–æ³¨å…¥åŸ‹ç‚¹"><a href="#1-5-IOC-x2F-DI-ä¾èµ–æ³¨å…¥åŸ‹ç‚¹" class="headerlink" title="1.5.IOC&#x2F;DI ä¾èµ–æ³¨å…¥åŸ‹ç‚¹"></a>1.5.IOC&#x2F;DI ä¾èµ–æ³¨å…¥åŸ‹ç‚¹</h3><ul><li>è¿‡æ»¤çš„æ¥å£ç±»å‹æ˜¯ï¼šInstantiationAwareBeanPostProcessor</li><li>è°ƒç”¨çš„æ–¹æ³•æ˜¯ï¼špostProcessProperties(æ–°ç‰ˆæœ¬)</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">//AbstractAutowireCapableBeanFactory</span><span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">populateBean</span><span class="token punctuation">(</span><span class="token class-name">String</span> beanName<span class="token punctuation">,</span> <span class="token class-name">RootBeanDefinition</span> mbd<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">BeanWrapper</span> bw<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">//......çœç•¥éƒ¨åˆ†ä»£ç </span><span class="token comment">//é‡ç‚¹çœ‹è¿™ä¸ªifä»£ç å—ï¼Œé‡è¦ç¨‹åº¦ 5</span><span class="token keyword">if</span> <span class="token punctuation">(</span>hasInstAwareBpps<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>pvs <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>pvs <span class="token operator">=</span> mbd<span class="token punctuation">.</span><span class="token function">getPropertyValues</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">BeanPostProcessor</span> bp <span class="token operator">:</span> <span class="token function">getBeanPostProcessors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>bp <span class="token keyword">instanceof</span> <span class="token class-name">InstantiationAwareBeanPostProcessor</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token class-name">InstantiationAwareBeanPostProcessor</span> ibp <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">InstantiationAwareBeanPostProcessor</span><span class="token punctuation">)</span> bp<span class="token punctuation">;</span><span class="token comment">//ä¾èµ–æ³¨å…¥è¿‡ç¨‹ï¼Œ@Resource @Autowiredçš„æ”¯æŒ</span><span class="token class-name">PropertyValues</span> pvsToUse <span class="token operator">=</span> ibp<span class="token punctuation">.</span><span class="token function">postProcessProperties</span><span class="token punctuation">(</span>pvs<span class="token punctuation">,</span> bw<span class="token punctuation">.</span><span class="token function">getWrappedInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> beanName<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>pvsToUse <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>filteredPds <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>filteredPds <span class="token operator">=</span> <span class="token function">filterPropertyDescriptorsForDependencyCheck</span><span class="token punctuation">(</span>bw<span class="token punctuation">,</span> mbd<span class="token punctuation">.</span>allowCaching<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">//è€ç‰ˆæœ¬ç”¨è¿™ä¸ªå®Œæˆä¾èµ–æ³¨å…¥è¿‡ç¨‹ï¼Œ@Autowiredçš„æ”¯æŒ</span>pvsToUse <span class="token operator">=</span> ibp<span class="token punctuation">.</span><span class="token function">postProcessPropertyValues</span><span class="token punctuation">(</span>pvs<span class="token punctuation">,</span> filteredPds<span class="token punctuation">,</span> bw<span class="token punctuation">.</span><span class="token function">getWrappedInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> beanName<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>pvsToUse <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">return</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>pvs <span class="token operator">=</span> pvsToUse<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token comment">//......çœç•¥éƒ¨åˆ†ä»£ç </span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> Springæºç å­¦ä¹  </category>
          
      </categories>
      
      
        <tags>
            
            <tag> æºç  </tag>
            
            <tag> Spring </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ã€Springæºç å­¦ä¹ ã€‘Spring Beançš„é”€æ¯</title>
      <link href="/posts/2421.html"/>
      <url>/posts/2421.html</url>
      
        <content type="html"><![CDATA[<p>ä¸Šä¸€ç« èŠ‚ä¸­ï¼Œæˆ‘ä»¬è·Ÿå®Œäº†beançš„åˆ›å»ºæµç¨‹ï¼Œè€Œåœ¨åˆ›å»ºå®Œæˆä»¥åï¼Œbeanè¿˜ä¼šæ³¨å†Œé”€æ¯ç›¸å…³çš„ç±»ï¼Œä»¥ä¾¿äºåƒtomcatç­‰å®¹å™¨å…³é—­æ—¶ç›¸å…³çš„è°ƒç”¨ï¼Œæœ¬ç« æˆ‘å°±èŠè¿™ä¸ªã€‚</p><h1 id="ä¸€ã€æ³¨å†Œbeané”€æ¯çš„ç±»"><a href="#ä¸€ã€æ³¨å†Œbeané”€æ¯çš„ç±»" class="headerlink" title="ä¸€ã€æ³¨å†Œbeané”€æ¯çš„ç±»"></a>ä¸€ã€æ³¨å†Œbeané”€æ¯çš„ç±»</h1><p>å…ˆå®šä½åˆ°ç±»AbstractAutowireCapableBeanFactoryçš„doCreateBean()æ–¹æ³•</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">// Register bean as disposable.</span><span class="token keyword">try</span> <span class="token punctuation">&#123;</span><span class="token comment">//æ³¨å†Œbeané”€æ¯æ—¶çš„ç±»DisposableBeanAdapter</span><span class="token function">registerDisposableBeanIfNecessary</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> bean<span class="token punctuation">,</span> mbd<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">BeanDefinitionValidationException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BeanCreationException</span><span class="token punctuation">(</span>mbd<span class="token punctuation">.</span><span class="token function">getResourceDescription</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> beanName<span class="token punctuation">,</span> <span class="token string">"Invalid destruction signature"</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="1-registerDisposableBeanIfNecessary"><a href="#1-registerDisposableBeanIfNecessary" class="headerlink" title="1.registerDisposableBeanIfNecessary()"></a>1.registerDisposableBeanIfNecessary()</h2><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">registerDisposableBeanIfNecessary</span><span class="token punctuation">(</span><span class="token class-name">String</span> beanName<span class="token punctuation">,</span> <span class="token class-name">Object</span> bean<span class="token punctuation">,</span> <span class="token class-name">RootBeanDefinition</span> mbd<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token class-name">AccessControlContext</span> acc <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">getSecurityManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token function">getAccessControlContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//éå¤šä¾‹ä½œç”¨åŸŸå¹¶ä¸”è¦ä¹ˆæœ‰é…ç½®destroy-methodæˆ–è€…è¦ä¹ˆæœ‰å¯ç”¨çš„DestructionAwareBeanPostProcessorsåç½®å¤„ç†å™¨æ‰ä¼šæ³¨å†Œ</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mbd<span class="token punctuation">.</span><span class="token function">isPrototype</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">requiresDestruction</span><span class="token punctuation">(</span>bean<span class="token punctuation">,</span> mbd<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>mbd<span class="token punctuation">.</span><span class="token function">isSingleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">// Register a DisposableBean implementation that performs all destruction</span><span class="token comment">// work for the given bean: DestructionAwareBeanPostProcessors,</span><span class="token comment">// DisposableBean interface, custom destroy method.</span><span class="token comment">//DisposableBeanAdapter å¯¹è±¡å°±æ˜¯è´Ÿè´£bean é”€æ¯çš„ç±»ã€‚</span><span class="token comment">// è¿™ä¸ªç±»ä¸­æ”¶é›†bean æ˜¯å¦å®ç°äº†DisposableBean æ¥å£</span><span class="token function">registerDisposableBean</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span><span class="token keyword">new</span> <span class="token class-name">DisposableBeanAdapter</span><span class="token punctuation">(</span>bean<span class="token punctuation">,</span> beanName<span class="token punctuation">,</span> mbd<span class="token punctuation">,</span> <span class="token function">getBeanPostProcessors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> acc<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">else</span> <span class="token punctuation">&#123;</span><span class="token comment">// A bean with a custom scope...</span><span class="token class-name">Scope</span> scope <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>scopes<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>mbd<span class="token punctuation">.</span><span class="token function">getScope</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>scope <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">"No Scope registered for scope name '"</span> <span class="token operator">+</span> mbd<span class="token punctuation">.</span><span class="token function">getScope</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"'"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span>scope<span class="token punctuation">.</span><span class="token function">registerDestructionCallback</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span><span class="token keyword">new</span> <span class="token class-name">DisposableBeanAdapter</span><span class="token punctuation">(</span>bean<span class="token punctuation">,</span> beanName<span class="token punctuation">,</span> mbd<span class="token punctuation">,</span> <span class="token function">getBeanPostProcessors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> acc<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="2-DisposableBeanAdapter"><a href="#2-DisposableBeanAdapter" class="headerlink" title="2.DisposableBeanAdapter"></a>2.DisposableBeanAdapter</h2><p>è¯¥ç±»å°±æ˜¯è´Ÿè´£é”€æ¯beançš„ç±»ï¼Œçœ‹ä¸‹å®ƒçš„æ„é€ æ–¹æ³•</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token class-name">DisposableBeanAdapter</span><span class="token punctuation">(</span><span class="token class-name">Object</span> bean<span class="token punctuation">,</span> <span class="token class-name">String</span> beanName<span class="token punctuation">,</span> <span class="token class-name">RootBeanDefinition</span> beanDefinition<span class="token punctuation">,</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">BeanPostProcessor</span><span class="token punctuation">></span></span> postProcessors<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">AccessControlContext</span> acc<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">notNull</span><span class="token punctuation">(</span>bean<span class="token punctuation">,</span> <span class="token string">"Disposable bean must not be null"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">this</span><span class="token punctuation">.</span>bean <span class="token operator">=</span> bean<span class="token punctuation">;</span><span class="token keyword">this</span><span class="token punctuation">.</span>beanName <span class="token operator">=</span> beanName<span class="token punctuation">;</span><span class="token keyword">this</span><span class="token punctuation">.</span>invokeDisposableBean <span class="token operator">=</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>bean <span class="token keyword">instanceof</span> <span class="token class-name">DisposableBean</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>beanDefinition<span class="token punctuation">.</span><span class="token function">isExternallyManagedDestroyMethod</span><span class="token punctuation">(</span><span class="token string">"destroy"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">this</span><span class="token punctuation">.</span>nonPublicAccessAllowed <span class="token operator">=</span> beanDefinition<span class="token punctuation">.</span><span class="token function">isNonPublicAccessAllowed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">this</span><span class="token punctuation">.</span>acc <span class="token operator">=</span> acc<span class="token punctuation">;</span><span class="token class-name">String</span> destroyMethodName <span class="token operator">=</span> <span class="token function">inferDestroyMethodIfNecessary</span><span class="token punctuation">(</span>bean<span class="token punctuation">,</span> beanDefinition<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>destroyMethodName <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>invokeDisposableBean <span class="token operator">&amp;&amp;</span> <span class="token string">"destroy"</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>destroyMethodName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span><span class="token operator">!</span>beanDefinition<span class="token punctuation">.</span><span class="token function">isExternallyManagedDestroyMethod</span><span class="token punctuation">(</span>destroyMethodName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">this</span><span class="token punctuation">.</span>destroyMethodName <span class="token operator">=</span> destroyMethodName<span class="token punctuation">;</span><span class="token class-name">Method</span> destroyMethod <span class="token operator">=</span> <span class="token function">determineDestroyMethod</span><span class="token punctuation">(</span>destroyMethodName<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>destroyMethod <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>beanDefinition<span class="token punctuation">.</span><span class="token function">isEnforceDestroyMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BeanDefinitionValidationException</span><span class="token punctuation">(</span><span class="token string">"Could not find a destroy method named '"</span> <span class="token operator">+</span>destroyMethodName <span class="token operator">+</span> <span class="token string">"' on bean with name '"</span> <span class="token operator">+</span> beanName <span class="token operator">+</span> <span class="token string">"'"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">else</span> <span class="token punctuation">&#123;</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> paramTypes <span class="token operator">=</span> destroyMethod<span class="token punctuation">.</span><span class="token function">getParameterTypes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>paramTypes<span class="token punctuation">.</span>length <span class="token operator">></span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BeanDefinitionValidationException</span><span class="token punctuation">(</span><span class="token string">"Method '"</span> <span class="token operator">+</span> destroyMethodName <span class="token operator">+</span> <span class="token string">"' of bean '"</span> <span class="token operator">+</span>beanName <span class="token operator">+</span> <span class="token string">"' has more than one parameter - not supported as destroy method"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>paramTypes<span class="token punctuation">.</span>length <span class="token operator">==</span> <span class="token number">1</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">boolean</span><span class="token punctuation">.</span><span class="token keyword">class</span> <span class="token operator">!=</span> paramTypes<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BeanDefinitionValidationException</span><span class="token punctuation">(</span><span class="token string">"Method '"</span> <span class="token operator">+</span> destroyMethodName <span class="token operator">+</span> <span class="token string">"' of bean '"</span> <span class="token operator">+</span>beanName <span class="token operator">+</span> <span class="token string">"' has a non-boolean parameter - not supported as destroy method"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span>destroyMethod <span class="token operator">=</span> <span class="token class-name">ClassUtils</span><span class="token punctuation">.</span><span class="token function">getInterfaceMethodIfPossible</span><span class="token punctuation">(</span>destroyMethod<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">this</span><span class="token punctuation">.</span>destroyMethod <span class="token operator">=</span> destroyMethod<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">//è¿‡æ»¤äº†DestructionAwareBeanPostProcessor ç±»å‹çš„æ¥å£</span><span class="token keyword">this</span><span class="token punctuation">.</span>beanPostProcessors <span class="token operator">=</span> <span class="token function">filterPostProcessors</span><span class="token punctuation">(</span>postProcessors<span class="token punctuation">,</span> bean<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æœ€ä¸»è¦å¹²çš„äº‹å„¿å°±æ˜¯æœ€åä¸€æ­¥ï¼Œæ”¶é›†DestructionAwareBeanPostProcessor ç±»å‹ï¼Œæ”¾å…¥åˆ—è¡¨å½“ä¸­</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">DestructionAwareBeanPostProcessor</span><span class="token punctuation">></span></span> <span class="token function">filterPostProcessors</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">BeanPostProcessor</span><span class="token punctuation">></span></span> processors<span class="token punctuation">,</span> <span class="token class-name">Object</span> bean<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">DestructionAwareBeanPostProcessor</span><span class="token punctuation">></span></span> filteredPostProcessors <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">CollectionUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>processors<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>filteredPostProcessors <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span>processors<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">BeanPostProcessor</span> processor <span class="token operator">:</span> processors<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">//è¿‡æ»¤äº†DestructionAwareBeanPostProcessor ç±»å‹çš„æ¥å£</span><span class="token keyword">if</span> <span class="token punctuation">(</span>processor <span class="token keyword">instanceof</span> <span class="token class-name">DestructionAwareBeanPostProcessor</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token class-name">DestructionAwareBeanPostProcessor</span> dabpp <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">DestructionAwareBeanPostProcessor</span><span class="token punctuation">)</span> processor<span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>dabpp<span class="token punctuation">.</span><span class="token function">requiresDestruction</span><span class="token punctuation">(</span>bean<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>filteredPostProcessors<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>dabpp<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">return</span> filteredPostProcessors<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h1 id="äºŒã€è°ƒç”¨è¿‡ç¨‹"><a href="#äºŒã€è°ƒç”¨è¿‡ç¨‹" class="headerlink" title="äºŒã€è°ƒç”¨è¿‡ç¨‹"></a>äºŒã€è°ƒç”¨è¿‡ç¨‹</h1><p>ç›®å‰ä¸»æµæœåŠ¡ç«¯è¿è¡Œçš„javaç¨‹åºå‡ä¸ºServletï¼Œå¹¶ä¸”é€šå¸¸éƒ½æ˜¯åœ¨tomcatä¸­ï¼Œé‚£beançš„é”€æ¯é€šå¸¸ä¸tomcatçš„å…³é—­æœ‰å…³ã€‚æˆ‘ä»¬çŸ¥é“servletçš„ç”Ÿå‘½å‘¨æœŸæœ‰ä¸‰å¤§æ­¥éª¤ï¼š</p><ul><li>init(): åˆå§‹åŒ–é˜¶æ®µ</li><li>service(): å¤„ç†å®¢æˆ·ç«¯è¯·æ±‚é˜¶æ®µ</li><li>destroy(): ç»ˆæ­¢é˜¶æ®µ</li></ul><p>destroy()é˜¶æ®µï¼Œç›¸å…³ç›‘å¬ç›‘æµ‹åˆ°é”€æ¯äº‹ä»¶ï¼Œç„¶åå‘èµ·ææ„ã€‚å®šä½åˆ°ContextLoaderListenerç±»ä¸­çš„contextDestroyed()æ–¹æ³•ï¼Œçœ‹çœ‹æ˜¯æ€ä¹ˆä¸€ä¸ªè¿‡ç¨‹ã€‚</p><h2 id="1-contextDestroyed"><a href="#1-contextDestroyed" class="headerlink" title="1.contextDestroyed()"></a>1.contextDestroyed()</h2><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">contextDestroyed</span><span class="token punctuation">(</span><span class="token class-name">ServletContextEvent</span> event<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">//å¼€å§‹å‡†å¤‡å…³é—­WebApplicationContext</span><span class="token function">closeWebApplicationContext</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span><span class="token function">getServletContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">ContextCleanupListener</span><span class="token punctuation">.</span><span class="token function">cleanupAttributes</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span><span class="token function">getServletContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="2-closeWebApplicationContext"><a href="#2-closeWebApplicationContext" class="headerlink" title="2.closeWebApplicationContext()"></a>2.closeWebApplicationContext()</h2><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">//ContextLoader</span><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">closeWebApplicationContext</span><span class="token punctuation">(</span><span class="token class-name">ServletContext</span> servletContext<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>servletContext<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"Closing Spring root WebApplicationContext"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">try</span> <span class="token punctuation">&#123;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>context <span class="token keyword">instanceof</span> <span class="token class-name">ConfigurableWebApplicationContext</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">//å¼€å§‹å‡†å¤‡å…³é—­WebApplicationContext</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">ConfigurableWebApplicationContext</span><span class="token punctuation">)</span> <span class="token keyword">this</span><span class="token punctuation">.</span>context<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">finally</span> <span class="token punctuation">&#123;</span><span class="token class-name">ClassLoader</span> ccl <span class="token operator">=</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getContextClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>ccl <span class="token operator">==</span> <span class="token class-name">ContextLoader</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>currentContext <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>ccl <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>currentContextPerThread<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>ccl<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span>servletContext<span class="token punctuation">.</span><span class="token function">removeAttribute</span><span class="token punctuation">(</span><span class="token class-name">WebApplicationContext</span><span class="token punctuation">.</span><span class="token constant">ROOT_WEB_APPLICATION_CONTEXT_ATTRIBUTE</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ç‚¹è¿›å»çœ‹çœ‹close()æ–¹æ³•ï¼Œè°ƒç”¨çš„æ˜¯AbstractApplicationContextçš„close()æ–¹æ³•ã€‚</p><h2 id="3-close-doClose"><a href="#3-close-doClose" class="headerlink" title="3.close(), doClose()"></a>3.close(), doClose()</h2><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>startupShutdownMonitor<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token function">doClose</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// If we registered a JVM shutdown hook, we don't need it anymore now:</span><span class="token comment">// We've already explicitly closed the context.</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>shutdownHook <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">try</span> <span class="token punctuation">&#123;</span><span class="token class-name">Runtime</span><span class="token punctuation">.</span><span class="token function">getRuntime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">removeShutdownHook</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>shutdownHook<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IllegalStateException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">// ignore - VM is already shutting down</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">doClose</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">// Check whether an actual close attempt is necessary...</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>active<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>closed<span class="token punctuation">.</span><span class="token function">compareAndSet</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"Closing "</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token class-name">LiveBeansView</span><span class="token punctuation">.</span><span class="token function">unregisterApplicationContext</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">try</span> <span class="token punctuation">&#123;</span><span class="token comment">// Publish shutdown event.</span><span class="token function">publishEvent</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ContextClosedEvent</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> ex<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>logger<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">"Exception thrown from ApplicationListener handling ContextClosedEvent"</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">// Stop all Lifecycle beans, to avoid delays during individual destruction.</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>lifecycleProcessor <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">try</span> <span class="token punctuation">&#123;</span><span class="token keyword">this</span><span class="token punctuation">.</span>lifecycleProcessor<span class="token punctuation">.</span><span class="token function">onClose</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> ex<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>logger<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">"Exception thrown from LifecycleProcessor on context close"</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token comment">// Destroy all cached singletons in the context's BeanFactory.</span><span class="token comment">//å¼€å§‹å‘èµ·è°ƒç”¨é”€æ¯æµç¨‹äº†</span><span class="token function">destroyBeans</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// Close the state of this context itself.</span><span class="token function">closeBeanFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// Let subclasses do some final clean-up if they wish...</span><span class="token function">onClose</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// Reset local application listeners to pre-refresh state.</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>earlyApplicationListeners <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">this</span><span class="token punctuation">.</span>applicationListeners<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">this</span><span class="token punctuation">.</span>applicationListeners<span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>earlyApplicationListeners<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">// Switch to inactive.</span><span class="token keyword">this</span><span class="token punctuation">.</span>active<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">destroyBeans</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token function">getBeanFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">destroySingletons</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è€ŒdestroySingletons()å®ç°ç±»ä¸ºDefaultSingletonBeanRegistryï¼Œç‚¹è¿›å»çœ‹çœ‹</p><h2 id="4-destroySingletons"><a href="#4-destroySingletons" class="headerlink" title="4.destroySingletons()"></a>4.destroySingletons()</h2><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">destroySingletons</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isTraceEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>logger<span class="token punctuation">.</span><span class="token function">trace</span><span class="token punctuation">(</span><span class="token string">"Destroying singletons in "</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>singletonObjects<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">this</span><span class="token punctuation">.</span>singletonsCurrentlyInDestruction <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> disposableBeanNames<span class="token punctuation">;</span><span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>disposableBeans<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>disposableBeanNames <span class="token operator">=</span> <span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">toStringArray</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>disposableBeans<span class="token punctuation">.</span><span class="token function">keySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> disposableBeanNames<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">//å°±æ˜¯è¿™é‡Œäº†</span><span class="token function">destroySingleton</span><span class="token punctuation">(</span>disposableBeanNames<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">this</span><span class="token punctuation">.</span>containedBeanMap<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">this</span><span class="token punctuation">.</span>dependentBeanMap<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">this</span><span class="token punctuation">.</span>dependenciesForBeanMap<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">clearSingletonCache</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">destroySingleton</span><span class="token punctuation">(</span><span class="token class-name">String</span> beanName<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">// Remove a registered singleton of the given name, if any.</span><span class="token function">removeSingleton</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// Destroy the corresponding DisposableBean instance.</span><span class="token class-name">DisposableBean</span> disposableBean<span class="token punctuation">;</span><span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>disposableBeans<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>disposableBean <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">DisposableBean</span><span class="token punctuation">)</span> <span class="token keyword">this</span><span class="token punctuation">.</span>disposableBeans<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token function">destroyBean</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> disposableBean<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="5-destroyBean"><a href="#5-destroyBean" class="headerlink" title="5.destroyBean()"></a>5.destroyBean()</h2><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">destroyBean</span><span class="token punctuation">(</span><span class="token class-name">String</span> beanName<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">DisposableBean</span> bean<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">// Trigger destruction of dependent beans first...</span><span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> dependencies<span class="token punctuation">;</span><span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>dependentBeanMap<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">// Within full synchronization in order to guarantee a disconnected Set</span>dependencies <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>dependentBeanMap<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>dependencies <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isTraceEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>logger<span class="token punctuation">.</span><span class="token function">trace</span><span class="token punctuation">(</span><span class="token string">"Retrieved dependent beans for bean '"</span> <span class="token operator">+</span> beanName <span class="token operator">+</span> <span class="token string">"': "</span> <span class="token operator">+</span> dependencies<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> dependentBeanName <span class="token operator">:</span> dependencies<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token function">destroySingleton</span><span class="token punctuation">(</span>dependentBeanName<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token comment">// Actually destroy the bean now...</span><span class="token keyword">if</span> <span class="token punctuation">(</span>bean <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">try</span> <span class="token punctuation">&#123;</span><span class="token comment">//çœŸæ­£é”€æ¯çš„åœ°æ–¹ï¼Œä¼šè°ƒç”¨åˆ°DisposableBeanAdapterä¸­çš„destroy()æ–¹æ³•</span>bean<span class="token punctuation">.</span><span class="token function">destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> ex<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isWarnEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>logger<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">"Destruction of bean with name '"</span> <span class="token operator">+</span> beanName <span class="token operator">+</span> <span class="token string">"' threw an exception"</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token comment">// Trigger destruction of contained beans...</span><span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> containedBeans<span class="token punctuation">;</span><span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>containedBeanMap<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">// Within full synchronization in order to guarantee a disconnected Set</span>containedBeans <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>containedBeanMap<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>containedBeans <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> containedBeanName <span class="token operator">:</span> containedBeans<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token function">destroySingleton</span><span class="token punctuation">(</span>containedBeanName<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token comment">// Remove destroyed bean from other beans' dependencies.</span><span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>dependentBeanMap<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Iterator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Map<span class="token punctuation">.</span>Entry</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Set</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span><span class="token punctuation">></span><span class="token punctuation">></span></span> it <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>dependentBeanMap<span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> it<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token class-name">Map<span class="token punctuation">.</span>Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Set</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span><span class="token punctuation">></span></span> entry <span class="token operator">=</span> it<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> dependenciesToClean <span class="token operator">=</span> entry<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>dependenciesToClean<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>dependenciesToClean<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>it<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token comment">// Remove destroyed bean's prepared dependency information.</span><span class="token keyword">this</span><span class="token punctuation">.</span>dependenciesForBeanMap<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="6-destroy"><a href="#6-destroy" class="headerlink" title="6.destroy()"></a>6.destroy()</h2><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">CollectionUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>beanPostProcessors<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">DestructionAwareBeanPostProcessor</span> processor <span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>beanPostProcessors<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>processor<span class="token punctuation">.</span><span class="token function">postProcessBeforeDestruction</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>bean<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>invokeDisposableBean<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isTraceEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>logger<span class="token punctuation">.</span><span class="token function">trace</span><span class="token punctuation">(</span><span class="token string">"Invoking destroy() on bean with name '"</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>beanName <span class="token operator">+</span> <span class="token string">"'"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">try</span> <span class="token punctuation">&#123;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">getSecurityManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token class-name">AccessController</span><span class="token punctuation">.</span><span class="token function">doPrivileged</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">PrivilegedExceptionAction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">></span></span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token punctuation">&#123;</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">DisposableBean</span><span class="token punctuation">)</span> <span class="token keyword">this</span><span class="token punctuation">.</span>bean<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>acc<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">else</span> <span class="token punctuation">&#123;</span><span class="token comment">//å¼€å§‹é”€æ¯äº†</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">DisposableBean</span><span class="token punctuation">)</span> <span class="token keyword">this</span><span class="token punctuation">.</span>bean<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> ex<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token class-name">String</span> msg <span class="token operator">=</span> <span class="token string">"Invocation of destroy method failed on bean with name '"</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>beanName <span class="token operator">+</span> <span class="token string">"'"</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>logger<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">else</span> <span class="token punctuation">&#123;</span>logger<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span>msg <span class="token operator">+</span> <span class="token string">": "</span> <span class="token operator">+</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>destroyMethod <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token function">invokeCustomDestroyMethod</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>destroyMethod<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>destroyMethodName <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token class-name">Method</span> methodToInvoke <span class="token operator">=</span> <span class="token function">determineDestroyMethod</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>destroyMethodName<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>methodToInvoke <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token function">invokeCustomDestroyMethod</span><span class="token punctuation">(</span><span class="token class-name">ClassUtils</span><span class="token punctuation">.</span><span class="token function">getInterfaceMethodIfPossible</span><span class="token punctuation">(</span>methodToInvoke<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> Springæºç å­¦ä¹  </category>
          
      </categories>
      
      
        <tags>
            
            <tag> æºç  </tag>
            
            <tag> Spring </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ã€Springæºç å­¦ä¹ ã€‘Spring Beanå®ä¾‹åŒ–-å¾ªç¯ä¾èµ–</title>
      <link href="/posts/5018.html"/>
      <url>/posts/5018.html</url>
      
        <content type="html"><![CDATA[<h1 id="ä¸€ã€ä»€ä¹ˆæ˜¯å¾ªç¯ä¾èµ–"><a href="#ä¸€ã€ä»€ä¹ˆæ˜¯å¾ªç¯ä¾èµ–" class="headerlink" title="ä¸€ã€ä»€ä¹ˆæ˜¯å¾ªç¯ä¾èµ–"></a>ä¸€ã€ä»€ä¹ˆæ˜¯å¾ªç¯ä¾èµ–</h1><p>å¦‚æœç±»Aå­˜åœ¨å±æ€§ç±»Bï¼Œè€Œç±»Bä¹Ÿæœ‰å±æ€§ç±»Aï¼Œé‚£ä¹ˆå½“è¿›è¡Œå±æ€§çš„ä¾èµ–æ³¨å…¥æ—¶ï¼Œå°±ä¼šå‡ºç°Aè¿˜æœªå®Œæˆåˆ›å»ºï¼Œåˆç”±äºåœ¨åˆ›å»ºBçš„è¿‡ç¨‹ä¸­åˆå‘ç”Ÿåˆ›å»ºAçš„è¿‡ç¨‹ï¼Œé€ æˆäº†æ­»å¾ªç¯ï¼Œæœ€ç»ˆå¯¼è‡´<strong>å¾ªç¯ä¾èµ–</strong>ã€‚ç±»ä¼¼ä»£ç å¦‚ä¸‹ï¼š</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">A</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">private</span> <span class="token class-name">B</span> b<span class="token punctuation">;</span><span class="token punctuation">&#125;</span> <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">B</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">private</span> <span class="token class-name">A</span> a<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>å¾ªç¯ä¾èµ–åªä¼šå‡ºç°åœ¨å•ä¾‹å®ä¾‹æ— å‚æ„é€ å‡½æ•°å®ä¾‹åŒ–æƒ…å†µä¸‹</strong>ã€‚æœ‰å‚æ„é€ å‡½æ•°çš„åŠ @Autowired çš„æ–¹å¼å¾ªç¯ä¾èµ–æ˜¯ç›´æ¥æŠ¥é”™çš„ï¼Œå¤šä¾‹çš„å¾ªç¯ä¾èµ–ä¹Ÿæ˜¯ç›´æ¥æŠ¥é”™çš„ã€‚æ¥ä¸‹æ¥æˆ‘ä¼šé€šè¿‡æºä»£ç ä¸€ä¸€è¯´æ˜ã€‚</p><h1 id="äºŒã€å¾ªç¯ä¾èµ–çš„æ­¥éª¤"><a href="#äºŒã€å¾ªç¯ä¾èµ–çš„æ­¥éª¤" class="headerlink" title="äºŒã€å¾ªç¯ä¾èµ–çš„æ­¥éª¤"></a>äºŒã€å¾ªç¯ä¾èµ–çš„æ­¥éª¤</h1><p>å‰é¢å‡ ç« ä¸­ï¼Œæˆ‘é‡ç‚¹è·Ÿäº†Spring Beançš„å®ä¾‹åŒ–æºç è¿‡ç¨‹ï¼Œæ€»ç»“ä¸€ä¸‹å°±æ˜¯ï¼š</p><ul><li><a href="https://zyxelva.github.io/posts/9980.html">åˆ›å»ºBeanå®ä¾‹</a></li><li><a href="https://zyxelva.github.io/posts/40022.html">ä¾èµ–å±æ€§æ³¨å…¥</a></li><li><a href="https://zyxelva.github.io/posts/54230.html">åˆå§‹åŒ–</a></li></ul><p>å¾ªç¯ä¾èµ–æ­¥éª¤ï¼š</p><ul><li>A ç±»æ— å‚æ„é€ å‡½æ•°å®ä¾‹åŒ–åï¼Œè®¾ç½®ä¸‰çº§ç¼“å­˜</li><li>A ç±»populateBean è¿›è¡Œä¾èµ–æ³¨å…¥ï¼Œè¿™é‡Œè§¦å‘äº†B ç±»å±æ€§çš„getBean æ“ä½œ</li><li>B ç±»æ— å‚æ„é€ å‡½æ•°å®ä¾‹åŒ–åï¼Œè®¾ç½®ä¸‰çº§ç¼“å­˜</li><li>B ç±»populateBean è¿›è¡Œä¾èµ–æ³¨å…¥ï¼Œè¿™é‡Œè§¦å‘äº†A ç±»å±æ€§çš„getBean æ“ä½œ</li><li>A ç±»ä¹‹å‰æ­£åœ¨å®ä¾‹åŒ–ï¼ŒsingletonsCurrentlyInCreation é›†åˆä¸­æœ‰å·²ç»æœ‰è¿™ä¸ªA ç±»äº†ï¼Œä¸‰çº§ç¼“å­˜é‡Œé¢ä¹Ÿæœ‰äº†ï¼Œæ‰€ä»¥è¿™æ—¶å€™æ˜¯ä»ä¸‰çº§ç¼“å­˜ä¸­æ‹¿åˆ°çš„æå‰æš´éœ²çš„A å®ä¾‹ï¼Œè¯¥å®ä¾‹è¿˜æ²¡æœ‰è¿›è¡ŒB ç±»å±æ€§çš„ä¾èµ–æ³¨å…¥çš„ï¼ŒB ç±»å±æ€§ä¸ºç©ºï¼Œå…·ä½“é€šè¿‡  <pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">Object</span> sharedInstance <span class="token operator">=</span> <span class="token function">getSingleton</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>è¿™ä¸ªæ–¹æ³•(å…ˆä»ä¸€çº§ç¼“å­˜ä¸­æ‹¿ï¼Œå†ä»äºŒçº§ç¼“å­˜ä¸­æ‹¿ï¼Œå¦‚æœè¿˜æ‹¿ä¸åˆ°ï¼Œå¹¶ä¸”å…è®¸beanæå‰æš´éœ²åˆ™ä»ä¸‰çº§ç¼“å­˜ä¸­æ‹¿åˆ°å¯¹è±¡å·¥å‚ï¼Œä»å·¥å‚ä¸­æ‹¿åˆ°å¯¹è±¡æˆåŠŸåï¼Œå‡çº§åˆ°äºŒçº§ç¼“å­˜ï¼Œå¹¶åˆ é™¤ä¸‰çº§ç¼“å­˜ã€‚å†æœ‰åˆ«çš„ç±»å¼•ç”¨çš„è¯ï¼Œå°±ä»äºŒçº§ç¼“å­˜ä¸­è¿›è¡Œå–)</li><li>B ç±»æ‹¿åˆ°äº†A çš„æå‰æš´éœ²å®ä¾‹æ³¨å…¥åˆ°A ç±»å±æ€§ä¸­äº†</li><li>B ç±»å®ä¾‹åŒ–å·²ç»å®Œæˆï¼ŒB ç±»çš„å®ä¾‹åŒ–æ˜¯ç”±A ç±»å®ä¾‹åŒ–ä¸­B å±æ€§çš„ä¾èµ–æ³¨å…¥è§¦å‘çš„getBean æ“ä½œè¿›è¡Œçš„ï¼Œç°åœ¨Bå·²ç»å®ä¾‹åŒ–ï¼Œæ‰€ä»¥A ç±»ä¸­B å±æ€§å°±å¯ä»¥å®Œæˆä¾èµ–æ³¨å…¥äº†ï¼Œè¿™æ—¶å€™A ç±»B å±æ€§å·²ç»æœ‰å€¼äº†ã€‚</li><li>B ç±»A å±æ€§æŒ‡å‘çš„å°±æ˜¯A ç±»å®ä¾‹å †ç©ºé—´ï¼Œæ‰€ä»¥è¿™æ—¶å€™B ç±»A å±æ€§ä¹Ÿä¼šæœ‰å€¼äº†ã€‚</li></ul><h1 id="ä¸‰ã€ä¸ºä»€ä¹ˆæœ‰å‚æ„é€ å‡½æ•°çš„åŠ -Autowired-çš„æ–¹å¼å¾ªç¯ä¾èµ–æ˜¯ç›´æ¥æŠ¥é”™çš„ï¼Ÿ"><a href="#ä¸‰ã€ä¸ºä»€ä¹ˆæœ‰å‚æ„é€ å‡½æ•°çš„åŠ -Autowired-çš„æ–¹å¼å¾ªç¯ä¾èµ–æ˜¯ç›´æ¥æŠ¥é”™çš„ï¼Ÿ" class="headerlink" title="ä¸‰ã€ä¸ºä»€ä¹ˆæœ‰å‚æ„é€ å‡½æ•°çš„åŠ @Autowired çš„æ–¹å¼å¾ªç¯ä¾èµ–æ˜¯ç›´æ¥æŠ¥é”™çš„ï¼Ÿ"></a>ä¸‰ã€ä¸ºä»€ä¹ˆæœ‰å‚æ„é€ å‡½æ•°çš„åŠ @Autowired çš„æ–¹å¼å¾ªç¯ä¾èµ–æ˜¯ç›´æ¥æŠ¥é”™çš„ï¼Ÿ</h1><p>é¦–å…ˆè¯´æ˜ä¸€ç‚¹ï¼Œæ„é€ æ–¹æ³•çš„æ‰§è¡Œé¡ºåºæ˜¯åœ¨ä¾èµ–æ³¨å…¥å±æ€§ä¹‹å‰çš„ã€‚</p><ol><li><p>åˆ›å»ºbean çš„å®ä¾‹æ˜¯åœ¨æ–¹æ³•createBeanInstance(beanName, mbd, args)ä¸­é€šè¿‡æ— å‚æˆ–æ³¨è§£@Autowired æœ‰å‚æ„é€ å‡½æ•°å®ä¾‹åŒ–è¿›è¡Œçš„ã€‚</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">//AbstractAutowireCapableBeanFactory</span><span class="token keyword">protected</span> <span class="token class-name">Object</span> <span class="token function">doCreateBean</span><span class="token punctuation">(</span><span class="token class-name">String</span> beanName<span class="token punctuation">,</span> <span class="token class-name">RootBeanDefinition</span> mbd<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span><span class="token keyword">throws</span> <span class="token class-name">BeanCreationException</span> <span class="token punctuation">&#123;</span><span class="token comment">// Instantiate the bean.</span><span class="token class-name">BeanWrapper</span> instanceWrapper <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>mbd<span class="token punctuation">.</span><span class="token function">isSingleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>instanceWrapper <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>factoryBeanInstanceCache<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>instanceWrapper <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">//åˆ›å»ºå®ä¾‹,,é‡ç‚¹çœ‹ï¼Œé‡è¦ç¨‹åº¦ï¼š5</span>instanceWrapper <span class="token operator">=</span> <span class="token function">createBeanInstance</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> mbd<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token class-name">Object</span> bean <span class="token operator">=</span> instanceWrapper<span class="token punctuation">.</span><span class="token function">getWrappedInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span> beanType <span class="token operator">=</span> instanceWrapper<span class="token punctuation">.</span><span class="token function">getWrappedClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>beanType <span class="token operator">!=</span> <span class="token class-name">NullBean</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>mbd<span class="token punctuation">.</span>resolvedTargetType <span class="token operator">=</span> beanType<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">// Allow post-processors to modify the merged bean definition.</span><span class="token comment">//......çœç•¥éƒ¨åˆ†ä»£ç </span><span class="token comment">// Eagerly cache singletons to be able to resolve circular references</span><span class="token comment">// even when triggered by lifecycle interfaces like BeanFactoryAware.</span><span class="token comment">//æ˜¯å¦å•ä¾‹beanæå‰æš´éœ²</span><span class="token keyword">boolean</span> earlySingletonExposure <span class="token operator">=</span> <span class="token punctuation">(</span>mbd<span class="token punctuation">.</span><span class="token function">isSingleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>allowCircularReferences <span class="token operator">&amp;&amp;</span><span class="token function">isSingletonCurrentlyInCreation</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>earlySingletonExposure<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isTraceEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>logger<span class="token punctuation">.</span><span class="token function">trace</span><span class="token punctuation">(</span><span class="token string">"Eagerly caching bean '"</span> <span class="token operator">+</span> beanName <span class="token operator">+</span><span class="token string">"' to allow for resolving potential circular references"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">//è¿™é‡Œç€é‡ç†è§£ï¼Œå¯¹ç†è§£å¾ªç¯ä¾èµ–å¸®åŠ©éå¸¸å¤§ï¼Œé‡è¦ç¨‹åº¦ 5   æ·»åŠ ä¸‰çº§ç¼“å­˜</span><span class="token function">addSingletonFactory</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token function">getEarlyBeanReference</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> mbd<span class="token punctuation">,</span> bean<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">// Initialize the bean instance.</span><span class="token class-name">Object</span> exposedObject <span class="token operator">=</span> bean<span class="token punctuation">;</span><span class="token keyword">try</span> <span class="token punctuation">&#123;</span><span class="token comment">//ioc diï¼Œä¾èµ–æ³¨å…¥çš„æ ¸å¿ƒæ–¹æ³•ï¼Œè¯¥æ–¹æ³•å¿…é¡»çœ‹ï¼Œé‡è¦ç¨‹åº¦ï¼š5</span><span class="token function">populateBean</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> mbd<span class="token punctuation">,</span> instanceWrapper<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//bean å®ä¾‹åŒ–+iocä¾èµ–æ³¨å…¥å®Œä»¥åçš„è°ƒç”¨ï¼Œéå¸¸é‡è¦ï¼Œé‡è¦ç¨‹åº¦ï¼š5</span>exposedObject <span class="token operator">=</span> <span class="token function">initializeBean</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> exposedObject<span class="token punctuation">,</span> mbd<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">//......çœç•¥éƒ¨åˆ†ä»£ç </span><span class="token comment">// Register bean as disposable.</span><span class="token keyword">try</span> <span class="token punctuation">&#123;</span><span class="token comment">//æ³¨å†Œbeané”€æ¯æ—¶çš„ç±»DisposableBeanAdapter</span><span class="token function">registerDisposableBeanIfNecessary</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> bean<span class="token punctuation">,</span> mbd<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">BeanDefinitionValidationException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BeanCreationException</span><span class="token punctuation">(</span>mbd<span class="token punctuation">.</span><span class="token function">getResourceDescription</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> beanName<span class="token punctuation">,</span> <span class="token string">"Invalid destruction signature"</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">return</span> exposedObject<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>createBeanInstance æ–¹æ³•æ‰§è¡Œå®Œæ¯•ä¹‹åæ‰ä¼šåˆ¤æ–­æ˜¯å¦æ˜¯å•ä¾‹bean æå‰æš´æ¼ä»è€Œä¸ºå®ä¾‹åŒ–çš„bean æ·»åŠ ä¸‰çº§ç¼“å­˜singletonFactories</p></li></ol><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">//æ˜¯å¦å•ä¾‹beanæå‰æš´éœ²:å•ä¾‹ã€æ”¯æŒå¾ªç¯ä¾èµ–ã€æ˜¯æ­£åœ¨åˆ›å»ºçš„å®ä¾‹</span><span class="token keyword">boolean</span> earlySingletonExposure <span class="token operator">=</span> <span class="token punctuation">(</span>mbd<span class="token punctuation">.</span><span class="token function">isSingleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>allowCircularReferences <span class="token operator">&amp;&amp;</span><span class="token function">isSingletonCurrentlyInCreation</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>earlySingletonExposure<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isTraceEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>logger<span class="token punctuation">.</span><span class="token function">trace</span><span class="token punctuation">(</span><span class="token string">"Eagerly caching bean '"</span> <span class="token operator">+</span> beanName <span class="token operator">+</span><span class="token string">"' to allow for resolving potential circular references"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">//è¿™é‡Œç€é‡ç†è§£ï¼Œå¯¹ç†è§£å¾ªç¯ä¾èµ–å¸®åŠ©éå¸¸å¤§ï¼Œé‡è¦ç¨‹åº¦ 5   æ·»åŠ ä¸‰çº§ç¼“å­˜</span><span class="token function">addSingletonFactory</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token function">getEarlyBeanReference</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> mbd<span class="token punctuation">,</span> bean<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>é»˜è®¤æƒ…å†µä¸‹ï¼Œæ”¯æŒå¾ªç¯ä¾èµ–ï¼Œé»˜è®¤éƒ½æ˜¯å•ä¾‹ï¼Œè€Œæ­£åœ¨åˆ›å»ºçš„å®ä¾‹æ¡ä»¶æ˜¯åœ¨AbstractAutowireCapableBeanFactory.doCreateBean()çš„è°ƒç”¨æ–¹ï¼ŒAbstractBeanFactory.deGetBean()å‘èµ·çš„</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">if</span> <span class="token punctuation">(</span>mbd<span class="token punctuation">.</span><span class="token function">isSingleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>sharedInstance <span class="token operator">=</span> <span class="token function">getSingleton</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token punctuation">&#123;</span><span class="token keyword">try</span> <span class="token punctuation">&#123;</span><span class="token keyword">return</span> <span class="token function">createBean</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> mbd<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">BeansException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">// Explicitly remove instance from singleton cache: It might have been put there</span><span class="token comment">// eagerly by the creation process, to allow for circular reference resolution.</span><span class="token comment">// Also remove any beans that received a temporary reference to the bean.</span><span class="token function">destroySingleton</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">throw</span> ex<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//è¯¥æ–¹æ³•æ˜¯FactoryBeanæ¥å£çš„è°ƒç”¨å…¥å£</span>bean <span class="token operator">=</span> <span class="token function">getObjectForBeanInstance</span><span class="token punctuation">(</span>sharedInstance<span class="token punctuation">,</span> name<span class="token punctuation">,</span> beanName<span class="token punctuation">,</span> mbd<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ç‚¹è¿›å»çœ‹çœ‹getSingleton().<br><img src="https://cdn.jsdelivr.net/gh/zyxelva/picgo@main/csdn/20210420120240865.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">beforeSingletonCreation</span><span class="token punctuation">(</span><span class="token class-name">String</span> beanName<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">//æŠŠbeanNameæ·»åŠ åˆ°singletonsCurrentlyInCreation Setå®¹å™¨ä¸­ï¼Œåœ¨è¿™ä¸ªé›†åˆé‡Œé¢çš„beanéƒ½æ˜¯æ­£åœ¨å®ä¾‹åŒ–çš„bean</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>inCreationCheckExclusions<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>singletonsCurrentlyInCreation<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BeanCurrentlyInCreationException</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>åˆ›å»ºå®Œæ¯•åï¼Œä¼šæŠŠæå‰æš´éœ²çš„å®ä¾‹å­˜æ”¾è‡³ä¸‰çº§ç¼“å­˜ä¸­</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">//DefaultSingletonBeanRegistry</span><span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">addSingletonFactory</span><span class="token punctuation">(</span><span class="token class-name">String</span> beanName<span class="token punctuation">,</span> <span class="token class-name">ObjectFactory</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span> singletonFactory<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">notNull</span><span class="token punctuation">(</span>singletonFactory<span class="token punctuation">,</span> <span class="token string">"Singleton factory must not be null"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>singletonObjects<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">//å¦‚æœä¸€çº§ç¼“å­˜ä¸å­˜åœ¨</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>singletonObjects<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">//è®¾ç½®ä¸‰çº§ç¼“å­˜</span><span class="token keyword">this</span><span class="token punctuation">.</span>singletonFactories<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> singletonFactory<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//åˆ é™¤äºŒçº§ç¼“å­˜</span><span class="token keyword">this</span><span class="token punctuation">.</span>earlySingletonObjects<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">this</span><span class="token punctuation">.</span>registeredSingletons<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å¦‚æœæœ‰å‚æ„é€ å‡½æ•°çš„æœ‰@Autowired ï¼Œé‚£ä¹ˆåœ¨æ‰§è¡ŒcreateBeanInstance æ–¹æ³•æ—¶ï¼Œå‚æ•°ä¸ºå¼•ç”¨ç±»å‹ä¼šå†æ¬¡è§¦å‘getBeanæ“ä½œã€‚ç”±äºä¹‹å‰çš„bean çš„å®ä¾‹åŒ–å°šæœªå®Œæˆï¼Œä¸‰çº§ç¼“å­˜ä¸­ä¹Ÿæ²¡æ³•è·å–åˆ°ï¼Œæ‰€ä»¥å°±ç»§ç»­èµ°ä¹‹å‰ç¬¬ä¸€æ¬¡å®ä¾‹åŒ–è¿›å…¥çš„getSingleton æ–¹æ³•ï¼Œæ­¤æ–¹æ³•ä¸­çš„beforeSingletonCreation ä¼šæ ¡éªŒè¯¥bean æ˜¯å¦æ­£åœ¨å®ä¾‹åŒ–ã€‚å¦‚æœæ˜¯æœ‰å‚æ„é€ å‡½æ•°çš„æœ‰@Autowiredçš„å¾ªç¯ä¾èµ–çš„è¯ï¼Œåˆ™è¿™é‡Œçš„ç¬¬äºŒä¸ªåˆ¤æ–­ä¸ºfalseï¼Œå› ä¸ºç¬¬ä¸€æ¬¡ç±»Aå·²ç»åœ¨é‡Œé¢äº†ï¼Œå°±ä¼šæŠ›å¼‚å¸¸ã€‚</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">beforeSingletonCreation</span><span class="token punctuation">(</span><span class="token class-name">String</span> beanName<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">//æŠŠbeanNameæ·»åŠ åˆ°singletonsCurrentlyInCreation Setå®¹å™¨ä¸­ï¼Œåœ¨è¿™ä¸ªé›†åˆé‡Œé¢çš„beanéƒ½æ˜¯æ­£åœ¨å®ä¾‹åŒ–çš„bean</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>inCreationCheckExclusions<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>singletonsCurrentlyInCreation<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BeanCurrentlyInCreationException</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">public</span> <span class="token class-name">BeanCurrentlyInCreationException</span><span class="token punctuation">(</span><span class="token class-name">String</span> beanName<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">super</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span><span class="token string">"Requested bean is currently in creation: Is there an unresolvable circular reference?"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è€Œå¯¹äºå¤šä¾‹çš„å¾ªç¯ä¾èµ–é—®é¢˜ï¼Œåœ¨è¿™é‡Œå°±ä¼šæŠ›å¼‚å¸¸äº†</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">//AbstractBeanFactory</span><span class="token comment">//å¦‚æœæ˜¯scope æ˜¯Prototypeçš„ï¼Œæ ¡éªŒæ˜¯å¦æœ‰å‡ºç°å¾ªç¯ä¾èµ–ï¼Œå¦‚æœæœ‰åˆ™ç›´æ¥æŠ¥é”™</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isPrototypeCurrentlyInCreation</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BeanCurrentlyInCreationException</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å¦‚æœæ˜¯é€šè¿‡å±æ€§åŠ @Autowired æ–¹å¼è¿›è¡Œå¾ªç¯ä¾èµ–ï¼Œåœ¨è¿›è¡ŒpopulateBean å±æ€§ä¾èµ–æ³¨å…¥ä¹‹å‰å°±ä¼šæŠŠbean æ”¾å…¥ä¸‰çº§ç¼“å­˜ä¸­ï¼Œä»è€Œè¿›è¡ŒpopulateBean æ“ä½œæ—¶è§¦å‘getBean æ—¶å°±å¯ä»¥ç›´æ¥ä»ä¸‰çº§ç¼“å­˜ä¸­å–å°±å¯ä»¥äº†ã€‚</p><p>æ€»ç»“ä¸‹ä¸‰çº§ç¼“å­˜å„è‡ªçš„åŠŸèƒ½ï¼š</p><table><thead><tr><th align="left">ç¼“å­˜</th><th align="left">è¯´æ˜</th></tr></thead><tbody><tr><td align="left">singletonObjects</td><td align="left">ç¬¬ä¸€çº§ç¼“å­˜ï¼Œå­˜æ”¾å¯ç”¨çš„æˆå“Beanã€‚</td></tr><tr><td align="left">earlySingletonObjects</td><td align="left">ç¬¬äºŒçº§ç¼“å­˜ï¼Œå­˜æ”¾åŠæˆå“çš„Beanï¼ŒåŠæˆå“çš„Beanæ˜¯å·²åˆ›å»ºå¯¹è±¡ï¼Œä½†æ˜¯æœªæ³¨å…¥å±æ€§å’Œåˆå§‹åŒ–ã€‚ç”¨ä»¥è§£å†³å¾ªç¯ä¾èµ–ã€‚</td></tr><tr><td align="left">singletonFactories</td><td align="left">ç¬¬ä¸‰çº§ç¼“å­˜ï¼Œå­˜çš„æ˜¯Beanå·¥å‚å¯¹è±¡ï¼Œç”¨æ¥ç”ŸæˆåŠæˆå“çš„Beanå¹¶æ”¾å…¥åˆ°äºŒçº§ç¼“å­˜ä¸­ã€‚ç”¨ä»¥è§£å†³å¾ªç¯ä¾èµ–ã€‚</td></tr></tbody></table><h1 id="å››ã€äºŒçº§ç¼“å­˜èƒ½å¦è§£å†³å¾ªç¯ä¾èµ–"><a href="#å››ã€äºŒçº§ç¼“å­˜èƒ½å¦è§£å†³å¾ªç¯ä¾èµ–" class="headerlink" title="å››ã€äºŒçº§ç¼“å­˜èƒ½å¦è§£å†³å¾ªç¯ä¾èµ–"></a>å››ã€äºŒçº§ç¼“å­˜èƒ½å¦è§£å†³å¾ªç¯ä¾èµ–</h1><ol><li>è‹¥æ²¡æœ‰ç¬¬äºŒçº§ç¼“å­˜ï¼Œè‹¥æœ‰å¤šæ¬¡ä¾èµ–æŸä¸€å¯¹è±¡ï¼Œåˆ™æ¯æ¬¡éƒ½éœ€è¦ä»ä¸‰çº§ç¼“å­˜ä¸­åˆ›å»ºè¯¥å¯¹è±¡ï¼Œå¤±å»äº†å•ä¾‹çš„æ„ä¹‰ã€‚ï¼ˆæˆ‘è¦çš„å°±æ˜¯å•ä¾‹ï¼Œä½ ç»™æˆ‘æ¥å¤šä¾‹ï¼Œé€—æˆ‘å‘¢ï¼Ÿï¼‰</li><li>è‹¥æ²¡æœ‰ç¬¬ä¸‰çº§ç¼“å­˜ï¼Œå¯¹äºä¸€èˆ¬çš„å¯¹è±¡å¾ªç¯ä¾èµ–é—®é¢˜å¯ä»¥å¾—åˆ°è§£å†³ã€‚é‚£ä¹ˆå°±å¾—å»æ”¹å†™ AbstractAutowireCapableBeanFactory çš„ doCreateBean çš„æ–¹æ³•äº†ã€‚</li></ol><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">//æ·»åŠ åˆ°ä¸‰çº§ç¼“å­˜</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>earlySingletonExposure<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>   <span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isTraceEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    logger<span class="token punctuation">.</span><span class="token function">trace</span><span class="token punctuation">(</span><span class="token string">"Eagerly caching bean '"</span> <span class="token operator">+</span> beanName <span class="token operator">+</span>      <span class="token string">"' to allow for resolving potential circular references"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token punctuation">&#125;</span>   <span class="token function">addSingletonFactory</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token function">getEarlyBeanReference</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> mbd<span class="token punctuation">,</span> bean<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">//ä»ä¸‰çº§ç¼“å­˜ä¸­å–å‡ºç«‹åˆ»æ”¾å…¥äºŒçº§ç¼“å­˜</span>   <span class="token function">getSingleton</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ä½†æ˜¯ï¼Œå¯¹äºAOPä»£ç†å¯¹è±¡çš„ç”Ÿæˆï¼Œä¼šè¿èƒŒSpringæ€»ä½“å®ä¾‹åŒ–å¯¹è±¡çš„æµç¨‹ï¼Œå› ä¸ºä»£ç†å¯¹è±¡æ˜¯åœ¨åˆå§‹åŒ–beanå®Œå…¨ä¹‹åï¼Œè¿›è¡Œè¯¥beançš„ä»£ç†ã€‚å³ï¼š<br>Springç»“åˆAOPè·ŸBeançš„ç”Ÿå‘½å‘¨æœŸï¼Œæ˜¯åœ¨Beanåˆ›å»ºå®Œå…¨ä¹‹åé€šè¿‡AnnotationAwareAspectJAutoProxyCreatorè¿™ä¸ªåç½®å¤„ç†å™¨æ¥å®Œæˆçš„ï¼Œåœ¨è¿™ä¸ªåç½®å¤„ç†çš„postProcessAfterInitializationæ–¹æ³•ä¸­å¯¹åˆå§‹åŒ–åçš„Beanå®ŒæˆAOPä»£ç†ã€‚</p><p>è‹¥æ²¡æœ‰ç¬¬ä¸‰çº§ç¼“å­˜ï¼Œåˆ™åˆ›å»ºå®Œbeanï¼Œå°±å¾—ç«‹é©¬åˆ›å»ºä»£ç†å¯¹è±¡ï¼Œè¿èƒŒäº†Springè®¾è®¡åŸåˆ™ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> Springæºç å­¦ä¹  </category>
          
      </categories>
      
      
        <tags>
            
            <tag> æºç  </tag>
            
            <tag> Spring </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ã€Springæºç å­¦ä¹ ã€‘Spring Beanå®ä¾‹åŒ–è¿‡ç¨‹-åˆå§‹åŒ–</title>
      <link href="/posts/54230.html"/>
      <url>/posts/54230.html</url>
      
        <content type="html"><![CDATA[<p>ä¸Šä¸€ç« è®²å®Œäº†populateBeançš„è¿‡ç¨‹ï¼Œè¿™ä¸€ç« ï¼Œæˆ‘ä»¬æ¥è·Ÿä¸€ä¸‹beanåˆå§‹åŒ–çš„æµç¨‹ï¼Œä¸»è¦åˆ†ä¸ºè¿™ä¹ˆå‡ ä¸ªæ­¥éª¤ï¼š</p><ul><li>è°ƒç”¨Awareæ–¹æ³•</li><li>InitializingBeanæ¥å£ï¼ŒafterPropertiesSetï¼Œinit-methodå±æ€§è°ƒç”¨</li></ul><h1 id="ä¸€ã€è°ƒç”¨Awareæ–¹æ³•"><a href="#ä¸€ã€è°ƒç”¨Awareæ–¹æ³•" class="headerlink" title="ä¸€ã€è°ƒç”¨Awareæ–¹æ³•"></a>ä¸€ã€è°ƒç”¨Awareæ–¹æ³•</h1><h2 id="1-InitializeBean"><a href="#1-InitializeBean" class="headerlink" title="1.InitializeBean()"></a>1.InitializeBean()</h2><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">protected</span> <span class="token class-name">Object</span> <span class="token function">initializeBean</span><span class="token punctuation">(</span><span class="token class-name">String</span> beanName<span class="token punctuation">,</span> <span class="token class-name">Object</span> bean<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">RootBeanDefinition</span> mbd<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">getSecurityManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token class-name">AccessController</span><span class="token punctuation">.</span><span class="token function">doPrivileged</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">PrivilegedAction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">></span></span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token punctuation">&#123;</span><span class="token function">invokeAwareMethods</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> bean<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token function">getAccessControlContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">else</span> <span class="token punctuation">&#123;</span><span class="token comment">//1.è°ƒç”¨Awareæ–¹æ³•</span><span class="token function">invokeAwareMethods</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> bean<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token class-name">Object</span> wrappedBean <span class="token operator">=</span> bean<span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>mbd <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> <span class="token operator">!</span>mbd<span class="token punctuation">.</span><span class="token function">isSynthetic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">//å‰ç½®å¤„ç†</span><span class="token comment">//å¯¹ç±»ä¸­æŸäº›ç‰¹æ®Šæ–¹æ³•çš„è°ƒç”¨ï¼Œæ¯”å¦‚@PostConstructï¼ŒAwareæ¥å£ï¼Œéå¸¸é‡è¦ é‡è¦ç¨‹åº¦ ï¼š5</span><span class="token comment">//ApplicationContextAwareProcessor å¯¹Awareæ¥å£çš„è°ƒç”¨å¦‚ï¼š</span><span class="token comment">//EnvironmentAware EmbeddedValueResolverAware  ResourceLoaderAware ApplicationEventPublisherAware MessageSourceAware  ApplicationContextAware</span><span class="token comment">//ImportAwareBeanPostProcessor å¯¹ImportAwareçš„æ”¯æŒ</span>wrappedBean <span class="token operator">=</span> <span class="token function">applyBeanPostProcessorsBeforeInitialization</span><span class="token punctuation">(</span>wrappedBean<span class="token punctuation">,</span> beanName<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">try</span> <span class="token punctuation">&#123;</span><span class="token comment">//2.InitializingBeanæ¥å£ï¼ŒafterPropertiesSetï¼Œinit-methodå±æ€§è°ƒç”¨,éå¸¸é‡è¦ï¼Œé‡è¦ç¨‹åº¦ï¼š5</span><span class="token function">invokeInitMethods</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> wrappedBean<span class="token punctuation">,</span> mbd<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> ex<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BeanCreationException</span><span class="token punctuation">(</span><span class="token punctuation">(</span>mbd <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> mbd<span class="token punctuation">.</span><span class="token function">getResourceDescription</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">,</span>beanName<span class="token punctuation">,</span> <span class="token string">"Invocation of init method failed"</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>mbd <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> <span class="token operator">!</span>mbd<span class="token punctuation">.</span><span class="token function">isSynthetic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">//3.åç½®å¤„ç†ï¼Œè¿™ä¸ªåœ°æ–¹å¯èƒ½ç”Ÿå‡ºä»£ç†å®ä¾‹ï¼Œæ˜¯aopçš„å…¥å£</span>wrappedBean <span class="token operator">=</span> <span class="token function">applyBeanPostProcessorsAfterInitialization</span><span class="token punctuation">(</span>wrappedBean<span class="token punctuation">,</span> beanName<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">return</span> wrappedBean<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="2-invokeAwareMethods"><a href="#2-invokeAwareMethods" class="headerlink" title="2.invokeAwareMethods()"></a>2.invokeAwareMethods()</h2><p>è¿™ä¸ªæ–¹æ³•ä¸»è¦æ˜¯è®¾ç½®beanNameï¼ŒbeanClassLoaderï¼ŒbeanFactoryï¼Œä½†å‰ææ˜¯è¿™ä¸ªbeanå®ç°äº†å¯¹åº”Awareçš„æ¥å£</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">invokeAwareMethods</span><span class="token punctuation">(</span><span class="token class-name">String</span> beanName<span class="token punctuation">,</span> <span class="token class-name">Object</span> bean<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>bean <span class="token keyword">instanceof</span> <span class="token class-name">Aware</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>bean <span class="token keyword">instanceof</span> <span class="token class-name">BeanNameAware</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">BeanNameAware</span><span class="token punctuation">)</span> bean<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setBeanName</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>bean <span class="token keyword">instanceof</span> <span class="token class-name">BeanClassLoaderAware</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token class-name">ClassLoader</span> bcl <span class="token operator">=</span> <span class="token function">getBeanClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>bcl <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">BeanClassLoaderAware</span><span class="token punctuation">)</span> bean<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setBeanClassLoader</span><span class="token punctuation">(</span>bcl<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>bean <span class="token keyword">instanceof</span> <span class="token class-name">BeanFactoryAware</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">BeanFactoryAware</span><span class="token punctuation">)</span> bean<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setBeanFactory</span><span class="token punctuation">(</span><span class="token class-name">AbstractAutowireCapableBeanFactory</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h1 id="äºŒã€InitializingBeanæ¥å£ï¼ŒafterPropertiesSetï¼Œinit-methodå±æ€§è°ƒç”¨"><a href="#äºŒã€InitializingBeanæ¥å£ï¼ŒafterPropertiesSetï¼Œinit-methodå±æ€§è°ƒç”¨" class="headerlink" title="äºŒã€InitializingBeanæ¥å£ï¼ŒafterPropertiesSetï¼Œinit-methodå±æ€§è°ƒç”¨"></a>äºŒã€InitializingBeanæ¥å£ï¼ŒafterPropertiesSetï¼Œinit-methodå±æ€§è°ƒç”¨</h1><p>åˆå§‹åŒ–çš„è°ƒç”¨åˆå¯åˆ†ä¸ºä¸‰ä¸ªæ­¥éª¤ï¼š</p><ul><li>åˆå§‹åŒ–å‰ç½®å¤„ç†ï¼šapplyBeanPostProcessorsBeforeInitialization()</li><li>åˆå§‹åŒ–ï¼šafterPropertiesSetï¼Œinit-methodå±æ€§è°ƒç”¨</li><li>åˆå§‹åŒ–åç½®å¤„ç†ï¼šapplyBeanPostProcessorsAfterInitialization()</li></ul><h2 id="1-åˆå§‹åŒ–å‰ç½®å¤„ç†"><a href="#1-åˆå§‹åŒ–å‰ç½®å¤„ç†" class="headerlink" title="1.åˆå§‹åŒ–å‰ç½®å¤„ç†"></a>1.åˆå§‹åŒ–å‰ç½®å¤„ç†</h2><p>åœ¨<a href="https://zyxelva.github.io/posts/9980.html">ã€Springæºç å­¦ä¹ ã€‘Spring Beanå®ä¾‹åŒ–è¿‡ç¨‹-åˆ›å»ºBeanå®ä¾‹</a>6.2.1èŠ‚ï¼Œæˆ‘ä»¬å·²ç»å®Œæˆäº†@PostConstructæ³¨è§£æ‰«æï¼Œè¿™ä¸€æ­¥å°±æ˜¯è°ƒç”¨ç›¸å…³çš„è¿‡ç¨‹äº†ï¼Œä¾ç„¶é‡‡ç”¨beanPostProcessorè°ƒç”¨çš„æ–¹å¼ã€‚å½“ç„¶ä¸æ­¢è¿™äº›æ³¨è§£ï¼Œè¿˜åŒ…æ‹¬Awareæ¥å£çš„è°ƒç”¨ï¼ŒImportAwareçš„æ”¯æŒå¤„ç†ç­‰ã€‚</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">applyBeanPostProcessorsBeforeInitialization</span><span class="token punctuation">(</span><span class="token class-name">Object</span> existingBean<span class="token punctuation">,</span> <span class="token class-name">String</span> beanName<span class="token punctuation">)</span><span class="token keyword">throws</span> <span class="token class-name">BeansException</span> <span class="token punctuation">&#123;</span><span class="token class-name">Object</span> result <span class="token operator">=</span> existingBean<span class="token punctuation">;</span><span class="token comment">//å¾ªç¯å¤„ç†</span><span class="token comment">/**ç€é‡çœ‹è¿™å‡ ä¸ªï¼š* 1.ApplicationContextAwareProcessor å¯¹æŸä¸ªAwareæ¥å£æ–¹æ³•çš„è°ƒç”¨* 2.InitDestroyAnnotationBeanPostProcessor @PostConstructæ³¨è§£æ–¹æ³•çš„è°ƒç”¨* 3.ImportAwareBeanPostProcessor å¯¹ImportAwareç±»å‹å®ä¾‹setImportMetadata è°ƒç”¨ï¼ˆSpringBootï¼‰*/</span><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">BeanPostProcessor</span> processor <span class="token operator">:</span> <span class="token function">getBeanPostProcessors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token class-name">Object</span> current <span class="token operator">=</span> processor<span class="token punctuation">.</span><span class="token function">postProcessBeforeInitialization</span><span class="token punctuation">(</span>result<span class="token punctuation">,</span> beanName<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>current <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">return</span> result<span class="token punctuation">;</span><span class="token punctuation">&#125;</span>result <span class="token operator">=</span> current<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">return</span> result<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="1-1-Awareæ¥å£æ–¹æ³•çš„è°ƒç”¨"><a href="#1-1-Awareæ¥å£æ–¹æ³•çš„è°ƒç”¨" class="headerlink" title="1.1.Awareæ¥å£æ–¹æ³•çš„è°ƒç”¨"></a>1.1.Awareæ¥å£æ–¹æ³•çš„è°ƒç”¨</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">postProcessBeforeInitialization</span><span class="token punctuation">(</span><span class="token class-name">Object</span> bean<span class="token punctuation">,</span> <span class="token class-name">String</span> beanName<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">BeansException</span> <span class="token punctuation">&#123;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>bean <span class="token keyword">instanceof</span> <span class="token class-name">EnvironmentAware</span> <span class="token operator">||</span> bean <span class="token keyword">instanceof</span> <span class="token class-name">EmbeddedValueResolverAware</span> <span class="token operator">||</span>bean <span class="token keyword">instanceof</span> <span class="token class-name">ResourceLoaderAware</span> <span class="token operator">||</span> bean <span class="token keyword">instanceof</span> <span class="token class-name">ApplicationEventPublisherAware</span> <span class="token operator">||</span>bean <span class="token keyword">instanceof</span> <span class="token class-name">MessageSourceAware</span> <span class="token operator">||</span> bean <span class="token keyword">instanceof</span> <span class="token class-name">ApplicationContextAware</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token keyword">return</span> bean<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token class-name">AccessControlContext</span> acc <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">getSecurityManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>acc <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>applicationContext<span class="token punctuation">.</span><span class="token function">getBeanFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAccessControlContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>acc <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token class-name">AccessController</span><span class="token punctuation">.</span><span class="token function">doPrivileged</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">PrivilegedAction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">></span></span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token punctuation">&#123;</span><span class="token function">invokeAwareInterfaces</span><span class="token punctuation">(</span>bean<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> acc<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">else</span> <span class="token punctuation">&#123;</span><span class="token function">invokeAwareInterfaces</span><span class="token punctuation">(</span>bean<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">return</span> bean<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="1-2-PostConstructæ³¨è§£æ–¹æ³•è°ƒç”¨"><a href="#1-2-PostConstructæ³¨è§£æ–¹æ³•è°ƒç”¨" class="headerlink" title="1.2.@PostConstructæ³¨è§£æ–¹æ³•è°ƒç”¨"></a>1.2.@PostConstructæ³¨è§£æ–¹æ³•è°ƒç”¨</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">//InitDestroyAnnotationBeanPostProcessor</span><span class="token annotation punctuation">@Override</span><span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">postProcessBeforeInitialization</span><span class="token punctuation">(</span><span class="token class-name">Object</span> bean<span class="token punctuation">,</span> <span class="token class-name">String</span> beanName<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">BeansException</span> <span class="token punctuation">&#123;</span><span class="token class-name">LifecycleMetadata</span> metadata <span class="token operator">=</span> <span class="token function">findLifecycleMetadata</span><span class="token punctuation">(</span>bean<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">try</span> <span class="token punctuation">&#123;</span><span class="token comment">//è°ƒç”¨@PostConstructæ³¨è§£çš„æ–¹æ³•</span>metadata<span class="token punctuation">.</span><span class="token function">invokeInitMethods</span><span class="token punctuation">(</span>bean<span class="token punctuation">,</span> beanName<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InvocationTargetException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BeanCreationException</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> <span class="token string">"Invocation of init method failed"</span><span class="token punctuation">,</span> ex<span class="token punctuation">.</span><span class="token function">getTargetException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> ex<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BeanCreationException</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> <span class="token string">"Failed to invoke init method"</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">return</span> bean<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="2-åˆå§‹åŒ–"><a href="#2-åˆå§‹åŒ–" class="headerlink" title="2.åˆå§‹åŒ–"></a>2.åˆå§‹åŒ–</h2><p>å‰ç½®å¤„ç†å®Œæ¯•ï¼Œæ¥ä¸‹æ¥å°±æ˜¯InitializingBean æ¥å£å’Œinit-method å±æ€§è°ƒç”¨è¿‡ç¨‹ï¼Œå®ç°äº†InitializingBean æ¥å£çš„ç±»å°±å¿…ç„¶ä¼šè°ƒç”¨åˆ°afterPropertiesSet æ–¹æ³•ï¼Œè€ŒInit-method å±æ€§è°ƒç”¨æ˜¯åœ¨afterPropertiesSet ä¹‹åï¼Œå¯¹åº”çš„æ–¹æ³•ä¸ºinvokeCustomInitMethodã€‚</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">invokeInitMethods</span><span class="token punctuation">(</span><span class="token class-name">String</span> beanName<span class="token punctuation">,</span> <span class="token class-name">Object</span> bean<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">RootBeanDefinition</span> mbd<span class="token punctuation">)</span><span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">&#123;</span><span class="token comment">//æ˜¯å¦æ˜¯å®ç°äº†InitializingBeançš„ç±»</span><span class="token keyword">boolean</span> isInitializingBean <span class="token operator">=</span> <span class="token punctuation">(</span>bean <span class="token keyword">instanceof</span> <span class="token class-name">InitializingBean</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>isInitializingBean <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>mbd <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> <span class="token operator">!</span>mbd<span class="token punctuation">.</span><span class="token function">isExternallyManagedInitMethod</span><span class="token punctuation">(</span><span class="token string">"afterPropertiesSet"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isTraceEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>logger<span class="token punctuation">.</span><span class="token function">trace</span><span class="token punctuation">(</span><span class="token string">"Invoking afterPropertiesSet() on bean with name '"</span> <span class="token operator">+</span> beanName <span class="token operator">+</span> <span class="token string">"'"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">getSecurityManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">try</span> <span class="token punctuation">&#123;</span><span class="token class-name">AccessController</span><span class="token punctuation">.</span><span class="token function">doPrivileged</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">PrivilegedExceptionAction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">></span></span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token punctuation">&#123;</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">InitializingBean</span><span class="token punctuation">)</span> bean<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">afterPropertiesSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token function">getAccessControlContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">PrivilegedActionException</span> pae<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">throw</span> pae<span class="token punctuation">.</span><span class="token function">getException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">else</span> <span class="token punctuation">&#123;</span><span class="token comment">//è°ƒç”¨å®ç°äº†InitializingBeanæ¥å£çš„æ–¹æ³•</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">InitializingBean</span><span class="token punctuation">)</span> bean<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">afterPropertiesSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token comment">//init-methodåå°„è°ƒç”¨</span><span class="token keyword">if</span> <span class="token punctuation">(</span>mbd <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> bean<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token class-name">NullBean</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token class-name">String</span> initMethodName <span class="token operator">=</span> mbd<span class="token punctuation">.</span><span class="token function">getInitMethodName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">hasLength</span><span class="token punctuation">(</span>initMethodName<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span><span class="token operator">!</span><span class="token punctuation">(</span>isInitializingBean <span class="token operator">&amp;&amp;</span> <span class="token string">"afterPropertiesSet"</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>initMethodName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span><span class="token operator">!</span>mbd<span class="token punctuation">.</span><span class="token function">isExternallyManagedInitMethod</span><span class="token punctuation">(</span>initMethodName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">//è°ƒç”¨init-methodé…ç½®çš„æ–¹æ³•</span><span class="token function">invokeCustomInitMethod</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> bean<span class="token punctuation">,</span> mbd<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>afterPropertiesSet å’ŒInit-method å’Œæœ‰@PostConstruct æ³¨è§£çš„æ–¹æ³•å…¶å®æ ¸å¿ƒåŠŸèƒ½éƒ½æ˜¯ä¸€æ ·çš„ï¼Œåªæ˜¯è°ƒç”¨<br>æ—¶åºä¸ä¸€æ ·è€Œå·²ï¼Œéƒ½æ˜¯åœ¨è¯¥ç±»å®ä¾‹åŒ–å’ŒIOC åšå®Œåè°ƒç”¨çš„ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨è¿™äº›æ–¹æ³•ä¸­åšä¸€äº›åœ¨spring æˆ–è€…servlet å®¹å™¨å¯åŠ¨çš„æ—¶å€™çš„åˆå§‹åŒ–å·¥ä½œã€‚æ¯”å¦‚ç¼“å­˜é¢„çƒ­ï¼Œæ¯”å¦‚ç¼“å­˜æ•°æ®åŠ è½½åˆ°å†…å­˜ï¼Œæ¯”å¦‚é…ç½®è§£æï¼Œç­‰ç­‰åˆå§‹åŒ–å·¥ä½œè°ƒç”¨é¡ºåºä¸ºå…ˆè°ƒç”¨@PostConstruct(æ³¨è§£ä½¿ç”¨)ã€ç„¶åæ˜¯afterPropertiesSetã€InitMethod(xml é…ç½®)æ–¹æ³•ã€‚</p><h2 id="3-åˆå§‹åŒ–åç½®å¤„ç†"><a href="#3-åˆå§‹åŒ–åç½®å¤„ç†" class="headerlink" title="3.åˆå§‹åŒ–åç½®å¤„ç†"></a>3.åˆå§‹åŒ–åç½®å¤„ç†</h2><p>beanå¯¹è±¡åˆå§‹åŒ–åï¼Œè¿˜ä¼šè¿›è¡Œä¸€äº›åç½®å¤„ç†ï¼Œæ¯”å¦‚åç»­æˆ‘ä»¬å°†è¦é‡ç‚¹è·Ÿè¸ªçš„AOPåŠ¨æ€ä»£ç†ï¼Œè¿™é‡Œåšä¸ªé¢„çƒ­ã€‚æˆ‘ä»¬å…ˆçœ‹çœ‹åŠ¨æ€ä»£ç†çš„åˆå§‹åŒ–åç½®å¤„ç†æ˜¯æ€æ ·çš„ï¼Œçœ‹ä¸ªå¤§æ¦‚ï¼Œä¸åšæ·±å…¥è®¨è®ºã€‚</p><h3 id="3-1-ä»£ç†å®ä¾‹æ³¨å…¥"><a href="#3-1-ä»£ç†å®ä¾‹æ³¨å…¥" class="headerlink" title="3.1.ä»£ç†å®ä¾‹æ³¨å…¥"></a>3.1.ä»£ç†å®ä¾‹æ³¨å…¥</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">//AbstractAutoProxyCreator</span><span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">postProcessAfterInitialization</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Nullable</span> <span class="token class-name">Object</span> bean<span class="token punctuation">,</span> <span class="token class-name">String</span> beanName<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>bean <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token class-name">Object</span> cacheKey <span class="token operator">=</span> <span class="token function">getCacheKey</span><span class="token punctuation">(</span>bean<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> beanName<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//ä¸Šä¸€ç« èŠ‚ï¼Œæåˆ°è¿‡è¿™ä¸ªç¼“å­˜å®¹å™¨ï¼Œè¿˜æœ‰å°è±¡å’©?</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>earlyProxyReferences<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>cacheKey<span class="token punctuation">)</span> <span class="token operator">!=</span> bean<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">return</span> <span class="token function">wrapIfNecessary</span><span class="token punctuation">(</span>bean<span class="token punctuation">,</span> beanName<span class="token punctuation">,</span> cacheKey<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">return</span> bean<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">protected</span> <span class="token class-name">Object</span> <span class="token function">wrapIfNecessary</span><span class="token punctuation">(</span><span class="token class-name">Object</span> bean<span class="token punctuation">,</span> <span class="token class-name">String</span> beanName<span class="token punctuation">,</span> <span class="token class-name">Object</span> cacheKey<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">hasLength</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>targetSourcedBeans<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">return</span> bean<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Boolean</span><span class="token punctuation">.</span><span class="token constant">FALSE</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>advisedBeans<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>cacheKey<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">return</span> bean<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isInfrastructureClass</span><span class="token punctuation">(</span>bean<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token function">shouldSkip</span><span class="token punctuation">(</span>bean<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> beanName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">this</span><span class="token punctuation">.</span>advisedBeans<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>cacheKey<span class="token punctuation">,</span> <span class="token class-name">Boolean</span><span class="token punctuation">.</span><span class="token constant">FALSE</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">return</span> bean<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">//åˆ›å»ºå½“å‰beançš„ä»£ç†ï¼Œå¦‚æœè¿™ä¸ªbeanæœ‰adviceçš„è¯ï¼Œé‡ç‚¹çœ‹ï¼Œé‡è¦ç¨‹åº¦5</span><span class="token comment">// Create proxy if we have advice.</span><span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> specificInterceptors <span class="token operator">=</span> <span class="token function">getAdvicesAndAdvisorsForBean</span><span class="token punctuation">(</span>bean<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> beanName<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//å¦‚æœæœ‰åˆ‡é¢ï¼Œåˆ™ç”Ÿæˆè¯¥beançš„ä»£ç†</span><span class="token keyword">if</span> <span class="token punctuation">(</span>specificInterceptors <span class="token operator">!=</span> <span class="token constant">DO_NOT_PROXY</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">this</span><span class="token punctuation">.</span>advisedBeans<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>cacheKey<span class="token punctuation">,</span> <span class="token class-name">Boolean</span><span class="token punctuation">.</span><span class="token constant">TRUE</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//æŠŠè¢«ä»£ç†å¯¹è±¡beanå®ä¾‹å°è£…åˆ°SingletonTargetSourceå¯¹è±¡ä¸­</span><span class="token class-name">Object</span> proxy <span class="token operator">=</span> <span class="token function">createProxy</span><span class="token punctuation">(</span>bean<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> beanName<span class="token punctuation">,</span> specificInterceptors<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">SingletonTargetSource</span><span class="token punctuation">(</span>bean<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">this</span><span class="token punctuation">.</span>proxyTypes<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>cacheKey<span class="token punctuation">,</span> proxy<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">return</span> proxy<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">this</span><span class="token punctuation">.</span>advisedBeans<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>cacheKey<span class="token punctuation">,</span> <span class="token class-name">Boolean</span><span class="token punctuation">.</span><span class="token constant">FALSE</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">return</span> bean<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>beançš„åˆ›å»ºè¿‡ç¨‹è·Ÿç©å’¯ï¼Œä¼‘æ¯ä¸€ä¸‹ï¼Œåé¢ç®€å•è·Ÿä¸‹beané”€æ¯çš„æ³¨å†Œè¿‡ç¨‹ã€‚^_^</p>]]></content>
      
      
      <categories>
          
          <category> Springæºç å­¦ä¹  </category>
          
      </categories>
      
      
        <tags>
            
            <tag> æºç  </tag>
            
            <tag> Spring </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ã€Springæºç å­¦ä¹ ã€‘Spring Beanå®ä¾‹åŒ–è¿‡ç¨‹-ä¾èµ–å±æ€§æ³¨å…¥</title>
      <link href="/posts/40022.html"/>
      <url>/posts/40022.html</url>
      
        <content type="html"><![CDATA[<h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><p>å‰é¢ä¸€ç« <a href="https://zyxelva.github.io/posts/9980.html">ã€Springæºç å­¦ä¹ ã€‘Spring Beanå®ä¾‹åŒ–è¿‡ç¨‹-åˆ›å»ºBeanå®ä¾‹</a>ï¼Œæˆ‘ä»¬ç€é‡è·Ÿè¸ªäº†beanå®ä¾‹çš„åˆ›å»ºè¿‡ç¨‹ï¼Œæœ¬ç« ï¼Œæˆ‘ä»¬ä¸»è¦è·Ÿä¸€ä¸‹beanå®ä¾‹åŒ–åçš„ä¾èµ–å±æ€§æ³¨å…¥çš„è¿‡ç¨‹ã€‚å…ˆæŠŠä»£ç å®šä½åˆ°ç±»AbstractAutowireCapableBeanFactoryä¸­çš„doCreateBean()æ–¹æ³•</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">protected</span> <span class="token class-name">Object</span> <span class="token function">doCreateBean</span><span class="token punctuation">(</span><span class="token class-name">String</span> beanName<span class="token punctuation">,</span> <span class="token class-name">RootBeanDefinition</span> mbd<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span><span class="token keyword">throws</span> <span class="token class-name">BeanCreationException</span> <span class="token punctuation">&#123;</span><span class="token comment">// Instantiate the bean.</span><span class="token class-name">BeanWrapper</span> instanceWrapper <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>mbd<span class="token punctuation">.</span><span class="token function">isSingleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>instanceWrapper <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>factoryBeanInstanceCache<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>instanceWrapper <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">//åˆ›å»ºå®ä¾‹,,é‡ç‚¹çœ‹ï¼Œé‡è¦ç¨‹åº¦ï¼š5</span>instanceWrapper <span class="token operator">=</span> <span class="token function">createBeanInstance</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> mbd<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token class-name">Object</span> bean <span class="token operator">=</span> instanceWrapper<span class="token punctuation">.</span><span class="token function">getWrappedInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span> beanType <span class="token operator">=</span> instanceWrapper<span class="token punctuation">.</span><span class="token function">getWrappedClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>beanType <span class="token operator">!=</span> <span class="token class-name">NullBean</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>mbd<span class="token punctuation">.</span>resolvedTargetType <span class="token operator">=</span> beanType<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">// Allow post-processors to modify the merged bean definition.</span><span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mbd<span class="token punctuation">.</span>postProcessingLock<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mbd<span class="token punctuation">.</span>postProcessed<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">try</span> <span class="token punctuation">&#123;</span><span class="token comment">//CommonAnnotationBeanPostProcessor  æ”¯æŒäº†@PostConstructï¼Œ@PreDestroy,@Resourceæ³¨è§£</span><span class="token comment">//AutowiredAnnotationBeanPostProcessor æ”¯æŒ @Autowired,@Valueæ³¨è§£</span><span class="token comment">//BeanPostProcessoræ¥å£çš„å…¸å‹è¿ç”¨ï¼Œè¿™é‡Œè¦ç†è§£è¿™ä¸ªæ¥å£</span><span class="token comment">//å¯¹ç±»ä¸­æ³¨è§£çš„è£…é…è¿‡ç¨‹</span><span class="token comment">//é‡è¦ç¨‹åº¦5ï¼Œå¿…é¡»çœ‹</span><span class="token function">applyMergedBeanDefinitionPostProcessors</span><span class="token punctuation">(</span>mbd<span class="token punctuation">,</span> beanType<span class="token punctuation">,</span> beanName<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> ex<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BeanCreationException</span><span class="token punctuation">(</span>mbd<span class="token punctuation">.</span><span class="token function">getResourceDescription</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> beanName<span class="token punctuation">,</span><span class="token string">"Post-processing of merged bean definition failed"</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span>mbd<span class="token punctuation">.</span>postProcessed <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token comment">// Eagerly cache singletons to be able to resolve circular references</span><span class="token comment">// even when triggered by lifecycle interfaces like BeanFactoryAware.</span><span class="token comment">//æ˜¯å¦å•ä¾‹beanæå‰æš´éœ²</span><span class="token keyword">boolean</span> earlySingletonExposure <span class="token operator">=</span> <span class="token punctuation">(</span>mbd<span class="token punctuation">.</span><span class="token function">isSingleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>allowCircularReferences <span class="token operator">&amp;&amp;</span><span class="token function">isSingletonCurrentlyInCreation</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>earlySingletonExposure<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isTraceEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>logger<span class="token punctuation">.</span><span class="token function">trace</span><span class="token punctuation">(</span><span class="token string">"Eagerly caching bean '"</span> <span class="token operator">+</span> beanName <span class="token operator">+</span><span class="token string">"' to allow for resolving potential circular references"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">//è¿™é‡Œç€é‡ç†è§£ï¼Œå¯¹ç†è§£å¾ªç¯ä¾èµ–å¸®åŠ©éå¸¸å¤§ï¼Œé‡è¦ç¨‹åº¦ 5   æ·»åŠ ä¸‰çº§ç¼“å­˜</span><span class="token function">addSingletonFactory</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token function">getEarlyBeanReference</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> mbd<span class="token punctuation">,</span> bean<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">// Initialize the bean instance.</span><span class="token class-name">Object</span> exposedObject <span class="token operator">=</span> bean<span class="token punctuation">;</span><span class="token keyword">try</span> <span class="token punctuation">&#123;</span><span class="token comment">//ioc diï¼Œä¾èµ–æ³¨å…¥çš„æ ¸å¿ƒæ–¹æ³•ï¼Œè¯¥æ–¹æ³•å¿…é¡»çœ‹ï¼Œé‡è¦ç¨‹åº¦ï¼š5</span><span class="token function">populateBean</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> mbd<span class="token punctuation">,</span> instanceWrapper<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//bean å®ä¾‹åŒ–+iocä¾èµ–æ³¨å…¥å®Œä»¥åçš„è°ƒç”¨ï¼Œéå¸¸é‡è¦ï¼Œé‡è¦ç¨‹åº¦ï¼š5</span>exposedObject <span class="token operator">=</span> <span class="token function">initializeBean</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> exposedObject<span class="token punctuation">,</span> mbd<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> ex<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>ex <span class="token keyword">instanceof</span> <span class="token class-name">BeanCreationException</span> <span class="token operator">&amp;&amp;</span> beanName<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">BeanCreationException</span><span class="token punctuation">)</span> ex<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBeanName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">throw</span> <span class="token punctuation">(</span><span class="token class-name">BeanCreationException</span><span class="token punctuation">)</span> ex<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">else</span> <span class="token punctuation">&#123;</span><span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BeanCreationException</span><span class="token punctuation">(</span>mbd<span class="token punctuation">.</span><span class="token function">getResourceDescription</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> beanName<span class="token punctuation">,</span> <span class="token string">"Initialization of bean failed"</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token comment">//çœç•¥ä¸€äº›ä»£ç </span><span class="token comment">// Register bean as disposable.</span><span class="token keyword">try</span> <span class="token punctuation">&#123;</span><span class="token comment">//æ³¨å†Œbeané”€æ¯æ—¶çš„ç±»DisposableBeanAdapter</span><span class="token function">registerDisposableBeanIfNecessary</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> bean<span class="token punctuation">,</span> mbd<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">BeanDefinitionValidationException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BeanCreationException</span><span class="token punctuation">(</span>mbd<span class="token punctuation">.</span><span class="token function">getResourceDescription</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> beanName<span class="token punctuation">,</span> <span class="token string">"Invalid destruction signature"</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">return</span> exposedObject<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="1-addSingletonFactory"><a href="#1-addSingletonFactory" class="headerlink" title="1.addSingletonFactory()"></a>1.addSingletonFactory()</h2><p>å…ˆçœ‹çœ‹addSingletonFactory()æ–¹æ³•ã€‚è¿™ä¸ªæ–¹æ³•ä¸»è¦ä½œç”¨å°±æ˜¯é’ˆå¯¹å•ä¾‹çš„ã€æ”¯æŒæå‰æš´éœ²å¼•ç”¨çš„ä¸”æ˜¯æ­£åœ¨åˆ›å»ºçš„å¯¹è±¡çš„å·¥å‚æ–¹æ³•æ”¾å…¥ä¸‰çº§ç¼“å­˜ä¸­ï¼Œè¿™é‡Œå¯¹äºç†è§£<strong>å¾ªç¯ä¾èµ–</strong>å¸®åŠ©éå¸¸å¤§ï¼Œå°¤å…¶æ˜¯<strong>AOPä»£ç†</strong>ã€‚</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">//DefaultSingletonBeanRegistry</span><span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">addSingletonFactory</span><span class="token punctuation">(</span><span class="token class-name">String</span> beanName<span class="token punctuation">,</span> <span class="token class-name">ObjectFactory</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span> singletonFactory<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">notNull</span><span class="token punctuation">(</span>singletonFactory<span class="token punctuation">,</span> <span class="token string">"Singleton factory must not be null"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>singletonObjects<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">//å¦‚æœä¸€çº§ç¼“å­˜ä¸å­˜åœ¨</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>singletonObjects<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">//è®¾ç½®ä¸‰çº§ç¼“å­˜</span><span class="token keyword">this</span><span class="token punctuation">.</span>singletonFactories<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> singletonFactory<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//åˆ é™¤äºŒçº§ç¼“å­˜</span><span class="token keyword">this</span><span class="token punctuation">.</span>earlySingletonObjects<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">this</span><span class="token punctuation">.</span>registeredSingletons<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å…¶ä¸­ï¼Œ() -&gt; getEarlyBeanReference(beanName, mbd, bean)è¿”å›çš„æ˜¯ä¸€ä¸ªObjectFactoryåŒ¿åå¯¹è±¡ï¼ŒObjectFactoryä¸­getObject()çš„æ–¹æ³•æ˜¯getEarlyBeanReference(beanName, mbd, bean)æ–¹æ³•çš„è°ƒç”¨ï¼Œæå‰æš´éœ²äº†å¯¹è±¡çš„å¼•ç”¨ã€‚</p><h2 id="2-getEarlyBeanReference"><a href="#2-getEarlyBeanReference" class="headerlink" title="2.getEarlyBeanReference()"></a>2.getEarlyBeanReference()</h2><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/** * Obtain a reference for early access to the specified bean, * typically for the purpose of resolving a circular reference. * @param beanName the name of the bean (for error handling purposes) * @param mbd the merged bean definition for the bean * @param bean the raw bean instance * @return the object to expose as bean reference * ä¸‰çº§ç¼“å­˜å¯¹è±¡å·¥å‚ ObjectFactory.getObject()è°ƒç”¨åˆ°è¿™ä¸ªæ–¹æ³• */</span><span class="token keyword">protected</span> <span class="token class-name">Object</span> <span class="token function">getEarlyBeanReference</span><span class="token punctuation">(</span><span class="token class-name">String</span> beanName<span class="token punctuation">,</span> <span class="token class-name">RootBeanDefinition</span> mbd<span class="token punctuation">,</span> <span class="token class-name">Object</span> bean<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token class-name">Object</span> exposedObject <span class="token operator">=</span> bean<span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mbd<span class="token punctuation">.</span><span class="token function">isSynthetic</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">hasInstantiationAwareBeanPostProcessors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">BeanPostProcessor</span> bp <span class="token operator">:</span> <span class="token function">getBeanPostProcessors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>bp <span class="token keyword">instanceof</span> <span class="token class-name">SmartInstantiationAwareBeanPostProcessor</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token class-name">SmartInstantiationAwareBeanPostProcessor</span> ibp <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">SmartInstantiationAwareBeanPostProcessor</span><span class="token punctuation">)</span> bp<span class="token punctuation">;</span>exposedObject <span class="token operator">=</span> ibp<span class="token punctuation">.</span><span class="token function">getEarlyBeanReference</span><span class="token punctuation">(</span>exposedObject<span class="token punctuation">,</span> beanName<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">return</span> exposedObject<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ä¸»è¦çœ‹AbstractAutoProxyCreatorçš„getEarlyBeanReferenceæ–¹æ³•</p><h2 id="3-getEarlyBeanReference"><a href="#3-getEarlyBeanReference" class="headerlink" title="3.getEarlyBeanReference()"></a>3.getEarlyBeanReference()</h2><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">getEarlyBeanReference</span><span class="token punctuation">(</span><span class="token class-name">Object</span> bean<span class="token punctuation">,</span> <span class="token class-name">String</span> beanName<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">//ç¼“å­˜çš„key</span><span class="token class-name">Object</span> cacheKey <span class="token operator">=</span> <span class="token function">getCacheKey</span><span class="token punctuation">(</span>bean<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> beanName<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//è¿™ä¸ªç¼“å­˜ä¼šåœ¨åé¢åˆå§‹åŒ–çš„åç½®å¤„ç†ä¸­ç”¨åˆ°ï¼Œä¸»è¦æ˜¯AOPä»£ç†ç±»ç”Ÿæˆçš„æ—¶å€™ç”¨åˆ°</span><span class="token keyword">this</span><span class="token punctuation">.</span>earlyProxyReferences<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>cacheKey<span class="token punctuation">,</span> bean<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">return</span> <span class="token function">wrapIfNecessary</span><span class="token punctuation">(</span>bean<span class="token punctuation">,</span> beanName<span class="token punctuation">,</span> cacheKey<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">/** * Wrap the given bean if necessary, i.e. if it is eligible for being proxied. * @param bean the raw bean instance * @param beanName the name of the bean * @param cacheKey the cache key for metadata access * @return a proxy wrapping the bean, or the raw bean instance as-is */</span><span class="token keyword">protected</span> <span class="token class-name">Object</span> <span class="token function">wrapIfNecessary</span><span class="token punctuation">(</span><span class="token class-name">Object</span> bean<span class="token punctuation">,</span> <span class="token class-name">String</span> beanName<span class="token punctuation">,</span> <span class="token class-name">Object</span> cacheKey<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">hasLength</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>targetSourcedBeans<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">return</span> bean<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Boolean</span><span class="token punctuation">.</span><span class="token constant">FALSE</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>advisedBeans<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>cacheKey<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">return</span> bean<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isInfrastructureClass</span><span class="token punctuation">(</span>bean<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token function">shouldSkip</span><span class="token punctuation">(</span>bean<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> beanName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">this</span><span class="token punctuation">.</span>advisedBeans<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>cacheKey<span class="token punctuation">,</span> <span class="token class-name">Boolean</span><span class="token punctuation">.</span><span class="token constant">FALSE</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">return</span> bean<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">//åˆ›å»ºå½“å‰beançš„ä»£ç†ï¼Œå¦‚æœè¿™ä¸ªbeanæœ‰adviceçš„è¯ï¼Œé‡ç‚¹çœ‹ï¼Œé‡è¦ç¨‹åº¦5</span><span class="token comment">// Create proxy if we have advice.</span><span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> specificInterceptors <span class="token operator">=</span> <span class="token function">getAdvicesAndAdvisorsForBean</span><span class="token punctuation">(</span>bean<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> beanName<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//å¦‚æœæœ‰åˆ‡é¢ï¼Œåˆ™ç”Ÿæˆè¯¥beançš„ä»£ç†</span><span class="token keyword">if</span> <span class="token punctuation">(</span>specificInterceptors <span class="token operator">!=</span> <span class="token constant">DO_NOT_PROXY</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">this</span><span class="token punctuation">.</span>advisedBeans<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>cacheKey<span class="token punctuation">,</span> <span class="token class-name">Boolean</span><span class="token punctuation">.</span><span class="token constant">TRUE</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//æŠŠè¢«ä»£ç†å¯¹è±¡beanå®ä¾‹å°è£…åˆ°SingletonTargetSourceå¯¹è±¡ä¸­</span><span class="token class-name">Object</span> proxy <span class="token operator">=</span> <span class="token function">createProxy</span><span class="token punctuation">(</span>bean<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> beanName<span class="token punctuation">,</span> specificInterceptors<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">SingletonTargetSource</span><span class="token punctuation">(</span>bean<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">this</span><span class="token punctuation">.</span>proxyTypes<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>cacheKey<span class="token punctuation">,</span> proxy<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">return</span> proxy<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">this</span><span class="token punctuation">.</span>advisedBeans<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>cacheKey<span class="token punctuation">,</span> <span class="token class-name">Boolean</span><span class="token punctuation">.</span><span class="token constant">FALSE</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">return</span> bean<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è¿™é‡Œä¸ç»§ç»­å±•å¼€äº†ï¼Œåé¢å°†åŠ¨æ€ä»£ç†çš„æ—¶å€™ä¼šè¯¦ç»†è·Ÿä¸€ä¸‹è¿™é‡Œçš„é€»è¾‘</p><h1 id="ä¸€ã€ä¾èµ–å±æ€§æ³¨å…¥"><a href="#ä¸€ã€ä¾èµ–å±æ€§æ³¨å…¥" class="headerlink" title="ä¸€ã€ä¾èµ–å±æ€§æ³¨å…¥"></a>ä¸€ã€ä¾èµ–å±æ€§æ³¨å…¥</h1><p>å®šä½åˆ°AbstractAutowireCapableBeanFactoryä¸­çš„doCreateBean()çš„populateBean(beanName, mbd, instanceWrapper)æ–¹æ³•</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">try</span> <span class="token punctuation">&#123;</span><span class="token comment">//ioc diï¼Œä¾èµ–æ³¨å…¥çš„æ ¸å¿ƒæ–¹æ³•ï¼Œè¯¥æ–¹æ³•å¿…é¡»çœ‹ï¼Œé‡è¦ç¨‹åº¦ï¼š5</span><span class="token function">populateBean</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> mbd<span class="token punctuation">,</span> instanceWrapper<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//bean å®ä¾‹åŒ–+iocä¾èµ–æ³¨å…¥å®Œä»¥åçš„è°ƒç”¨ï¼Œéå¸¸é‡è¦ï¼Œé‡è¦ç¨‹åº¦ï¼š5</span>exposedObject <span class="token operator">=</span> <span class="token function">initializeBean</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> exposedObject<span class="token punctuation">,</span> mbd<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="1-populateBean"><a href="#1-populateBean" class="headerlink" title="1.populateBean()"></a>1.populateBean()</h2><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">populateBean</span><span class="token punctuation">(</span><span class="token class-name">String</span> beanName<span class="token punctuation">,</span> <span class="token class-name">RootBeanDefinition</span> mbd<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">BeanWrapper</span> bw<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>bw <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>mbd<span class="token punctuation">.</span><span class="token function">hasPropertyValues</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BeanCreationException</span><span class="token punctuation">(</span>mbd<span class="token punctuation">.</span><span class="token function">getResourceDescription</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> beanName<span class="token punctuation">,</span> <span class="token string">"Cannot apply property values to null instance"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">else</span> <span class="token punctuation">&#123;</span><span class="token comment">// Skip property population phase for null instance.</span><span class="token keyword">return</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token comment">// Give any InstantiationAwareBeanPostProcessors the opportunity to modify the</span><span class="token comment">// state of the bean before properties are set. This can be used, for example,</span><span class="token comment">// to support styles of field injection.</span><span class="token comment">//è¿™é‡Œå¾ˆæœ‰æ„æ€ï¼Œå†™æ¥å£å¯ä»¥è®©æ‰€æœ‰ç±»éƒ½ä¸èƒ½ä¾èµ–æ³¨å…¥</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mbd<span class="token punctuation">.</span><span class="token function">isSynthetic</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">hasInstantiationAwareBeanPostProcessors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">BeanPostProcessor</span> bp <span class="token operator">:</span> <span class="token function">getBeanPostProcessors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>bp <span class="token keyword">instanceof</span> <span class="token class-name">InstantiationAwareBeanPostProcessor</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token class-name">InstantiationAwareBeanPostProcessor</span> ibp <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">InstantiationAwareBeanPostProcessor</span><span class="token punctuation">)</span> bp<span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ibp<span class="token punctuation">.</span><span class="token function">postProcessAfterInstantiation</span><span class="token punctuation">(</span>bw<span class="token punctuation">.</span><span class="token function">getWrappedInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> beanName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">return</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token class-name">PropertyValues</span> pvs <span class="token operator">=</span> <span class="token punctuation">(</span>mbd<span class="token punctuation">.</span><span class="token function">hasPropertyValues</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">?</span> mbd<span class="token punctuation">.</span><span class="token function">getPropertyValues</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//......çœç•¥ä¸€äº›ä»£ç </span><span class="token keyword">boolean</span> hasInstAwareBpps <span class="token operator">=</span> <span class="token function">hasInstantiationAwareBeanPostProcessors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">boolean</span> needsDepCheck <span class="token operator">=</span> <span class="token punctuation">(</span>mbd<span class="token punctuation">.</span><span class="token function">getDependencyCheck</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token class-name">AbstractBeanDefinition</span><span class="token punctuation">.</span><span class="token constant">DEPENDENCY_CHECK_NONE</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">PropertyDescriptor</span><span class="token punctuation">[</span><span class="token punctuation">]</span> filteredPds <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span><span class="token comment">//é‡ç‚¹çœ‹è¿™ä¸ªifä»£ç å—ï¼Œé‡è¦ç¨‹åº¦ 5</span><span class="token keyword">if</span> <span class="token punctuation">(</span>hasInstAwareBpps<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>pvs <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>pvs <span class="token operator">=</span> mbd<span class="token punctuation">.</span><span class="token function">getPropertyValues</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">BeanPostProcessor</span> bp <span class="token operator">:</span> <span class="token function">getBeanPostProcessors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>bp <span class="token keyword">instanceof</span> <span class="token class-name">InstantiationAwareBeanPostProcessor</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token class-name">InstantiationAwareBeanPostProcessor</span> ibp <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">InstantiationAwareBeanPostProcessor</span><span class="token punctuation">)</span> bp<span class="token punctuation">;</span><span class="token comment">//ä¾èµ–æ³¨å…¥è¿‡ç¨‹ï¼Œ@Autowiredçš„æ”¯æŒ</span><span class="token class-name">PropertyValues</span> pvsToUse <span class="token operator">=</span> ibp<span class="token punctuation">.</span><span class="token function">postProcessProperties</span><span class="token punctuation">(</span>pvs<span class="token punctuation">,</span> bw<span class="token punctuation">.</span><span class="token function">getWrappedInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> beanName<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>pvsToUse <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>filteredPds <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>filteredPds <span class="token operator">=</span> <span class="token function">filterPropertyDescriptorsForDependencyCheck</span><span class="token punctuation">(</span>bw<span class="token punctuation">,</span> mbd<span class="token punctuation">.</span>allowCaching<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">//è€ç‰ˆæœ¬ç”¨è¿™ä¸ªå®Œæˆä¾èµ–æ³¨å…¥è¿‡ç¨‹ï¼Œ@Autowiredçš„æ”¯æŒ</span>pvsToUse <span class="token operator">=</span> ibp<span class="token punctuation">.</span><span class="token function">postProcessPropertyValues</span><span class="token punctuation">(</span>pvs<span class="token punctuation">,</span> filteredPds<span class="token punctuation">,</span> bw<span class="token punctuation">.</span><span class="token function">getWrappedInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> beanName<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>pvsToUse <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">return</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>pvs <span class="token operator">=</span> pvsToUse<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>needsDepCheck<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>filteredPds <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>filteredPds <span class="token operator">=</span> <span class="token function">filterPropertyDescriptorsForDependencyCheck</span><span class="token punctuation">(</span>bw<span class="token punctuation">,</span> mbd<span class="token punctuation">.</span>allowCaching<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token function">checkDependencies</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> mbd<span class="token punctuation">,</span> filteredPds<span class="token punctuation">,</span> pvs<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">//è¿™ä¸ªæ–¹æ³•å¾ˆé¸¡è‚‹äº†ï¼Œå»ºè®®ä¸çœ‹ï¼Œæ˜¯è€ç‰ˆæœ¬ç”¨&lt;property name="username" value="Jack"/></span><span class="token comment">//æ ‡ç­¾åšä¾èµ–æ³¨å…¥çš„ä»£ç å®ç°ï¼Œå¤æ‚ä¸”æ— ç”¨</span><span class="token keyword">if</span> <span class="token punctuation">(</span>pvs <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token function">applyPropertyValues</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> mbd<span class="token punctuation">,</span> bw<span class="token punctuation">,</span> pvs<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ä¾èµ–æ³¨å…¥æ ¸å¿ƒçš„åœ°æ–¹å°±åœ¨è¿™é‡Œäº†</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">//ä¾èµ–æ³¨å…¥è¿‡ç¨‹ï¼Œ@Autowiredçš„æ”¯æŒ</span><span class="token class-name">PropertyValues</span> pvsToUse <span class="token operator">=</span> ibp<span class="token punctuation">.</span><span class="token function">postProcessProperties</span><span class="token punctuation">(</span>pvs<span class="token punctuation">,</span> bw<span class="token punctuation">.</span><span class="token function">getWrappedInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> beanName<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>ä¸Šä¸€ç« èŠ‚ä¸­ï¼Œæˆ‘ä»¬å·²ç»è¯´åˆ°äº†@Resource@Autowired æ³¨è§£çš„æ”¶é›†ï¼Œé‚£ä¹ˆè¿™ä¸ªæ–¹æ³•å°±æ˜¯<br>æ ¹æ®æ”¶é›†åˆ°çš„æ³¨è§£è¿›è¡Œ<strong>åå°„è°ƒç”¨</strong>ï¼Œè¿™é‡Œä»¥@Autowired æ³¨è§£çš„å±æ€§ä¸ºä¾‹ï¼Œæ³¨è§£çš„æ–¹æ³•ç±»ä¼¼ã€‚</p><h3 id="1-1-postProcessProperties"><a href="#1-1-postProcessProperties" class="headerlink" title="1.1.postProcessProperties()"></a>1.1.postProcessProperties()</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">//AutowiredAnnotationBeanPostProcessor</span><span class="token keyword">public</span> <span class="token class-name">PropertyValues</span> <span class="token function">postProcessProperties</span><span class="token punctuation">(</span><span class="token class-name">PropertyValues</span> pvs<span class="token punctuation">,</span> <span class="token class-name">Object</span> bean<span class="token punctuation">,</span> <span class="token class-name">String</span> beanName<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token class-name">InjectionMetadata</span> metadata <span class="token operator">=</span> <span class="token function">findAutowiringMetadata</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> bean<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> pvs<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">try</span> <span class="token punctuation">&#123;</span>metadata<span class="token punctuation">.</span><span class="token function">inject</span><span class="token punctuation">(</span>bean<span class="token punctuation">,</span> beanName<span class="token punctuation">,</span> pvs<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">BeanCreationException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">throw</span> ex<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> ex<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BeanCreationException</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> <span class="token string">"Injection of autowired dependencies failed"</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">return</span> pvs<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æ ¸å¿ƒæ–¹æ³•metadata.inject å¾ªç¯æ”¶é›†åˆ°çš„metaData ä¸­çš„list å¯¹è±¡ï¼Œç„¶åæŒ¨ä¸ªè°ƒç”¨é‡Œé¢çš„InjectedElement çš„<br>inject æ–¹æ³•å®Œæˆä¾èµ–æ³¨å…¥ã€‚</p><h3 id="1-2-inject"><a href="#1-2-inject" class="headerlink" title="1.2.inject()"></a>1.2.inject()</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">//InjectionMetadata</span><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">inject</span><span class="token punctuation">(</span><span class="token class-name">Object</span> target<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">String</span> beanName<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">PropertyValues</span> pvs<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">&#123;</span><span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">InjectedElement</span><span class="token punctuation">></span></span> checkedElements <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>checkedElements<span class="token punctuation">;</span><span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">InjectedElement</span><span class="token punctuation">></span></span> elementsToIterate <span class="token operator">=</span><span class="token punctuation">(</span>checkedElements <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> checkedElements <span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>injectedElements<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>elementsToIterate<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">InjectedElement</span> element <span class="token operator">:</span> elementsToIterate<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isTraceEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>logger<span class="token punctuation">.</span><span class="token function">trace</span><span class="token punctuation">(</span><span class="token string">"Processing injected element of bean '"</span> <span class="token operator">+</span> beanName <span class="token operator">+</span> <span class="token string">"': "</span> <span class="token operator">+</span> element<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">//é€šè¿‡åå°„æ¥å®Œæˆä¾èµ–æ³¨å…¥è°ƒç”¨</span>element<span class="token punctuation">.</span><span class="token function">inject</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> beanName<span class="token punctuation">,</span> pvs<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">inject</span><span class="token punctuation">(</span><span class="token class-name">Object</span> target<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">String</span> requestingBeanName<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">PropertyValues</span> pvs<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">&#123;</span><span class="token comment">//å±æ€§æ³¨å…¥</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>isField<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token class-name">Field</span> field <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Field</span><span class="token punctuation">)</span> <span class="token keyword">this</span><span class="token punctuation">.</span>member<span class="token punctuation">;</span><span class="token class-name">ReflectionUtils</span><span class="token punctuation">.</span><span class="token function">makeAccessible</span><span class="token punctuation">(</span>field<span class="token punctuation">)</span><span class="token punctuation">;</span>field<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> <span class="token function">getResourceToInject</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> requestingBeanName<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">//æ–¹æ³•åå°„è°ƒç”¨</span><span class="token keyword">else</span> <span class="token punctuation">&#123;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">checkPropertySkipping</span><span class="token punctuation">(</span>pvs<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">return</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">try</span> <span class="token punctuation">&#123;</span><span class="token class-name">Method</span> method <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Method</span><span class="token punctuation">)</span> <span class="token keyword">this</span><span class="token punctuation">.</span>member<span class="token punctuation">;</span><span class="token class-name">ReflectionUtils</span><span class="token punctuation">.</span><span class="token function">makeAccessible</span><span class="token punctuation">(</span>method<span class="token punctuation">)</span><span class="token punctuation">;</span>method<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> <span class="token function">getResourceToInject</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> requestingBeanName<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InvocationTargetException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">throw</span> ex<span class="token punctuation">.</span><span class="token function">getTargetException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>é€šè¿‡ä¸Šè¿°è¿‡ç¨‹å¯¹@Autowired å’Œ@Resource ä»¥åŠ@Value æ³¨è§£ä¿®é¥°çš„Field å’Œæ–¹æ³•ç­‰å®Œæˆä¾èµ–æ³¨å…¥ã€‚å…¶ä¸­value å€¼çš„è·å–ï¼Œå¦‚æœä¾èµ–çš„å±æ€§æ˜¯ä¸€ä¸ªå¼•ç”¨ç±»å‹å¿…å®šä¼šè§¦å‘è¯¥å±æ€§çš„BeanFactory.getBean æ“ä½œï¼Œä»è€Œä»spring å®¹å™¨ä¸­è·å–åˆ°å¯¹åº”çš„å®ä¾‹ã€‚æ–¹æ³•çš„ä¾èµ–æ³¨å…¥ç±»ä¼¼è¿™é‡Œå°±ä¸å†èµ˜è¿°ï¼Œæ¥ç€ä¸Šé¢ç»§ç»­çœ‹ä¸‹getResourceToInject()æ–¹æ³•ã€‚</p><h3 id="1-3-getResourceToInject-autowireResource"><a href="#1-3-getResourceToInject-autowireResource" class="headerlink" title="1.3.getResourceToInject(), autowireResource()"></a>1.3.getResourceToInject(), autowireResource()</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">protected</span> <span class="token class-name">Object</span> <span class="token function">getResourceToInject</span><span class="token punctuation">(</span><span class="token class-name">Object</span> target<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">String</span> requestingBeanName<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>lazyLookup <span class="token operator">?</span> <span class="token function">buildLazyResourceProxy</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> requestingBeanName<span class="token punctuation">)</span> <span class="token operator">:</span><span class="token function">getResource</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> requestingBeanName<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">protected</span> <span class="token class-name">Object</span> <span class="token function">getResource</span><span class="token punctuation">(</span><span class="token class-name">LookupElement</span> element<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">String</span> requestingBeanName<span class="token punctuation">)</span><span class="token keyword">throws</span> <span class="token class-name">NoSuchBeanDefinitionException</span> <span class="token punctuation">&#123;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">hasLength</span><span class="token punctuation">(</span>element<span class="token punctuation">.</span>mappedName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>jndiFactory<span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span>element<span class="token punctuation">.</span>mappedName<span class="token punctuation">,</span> element<span class="token punctuation">.</span>lookupType<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>alwaysUseJndiLookup<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>jndiFactory<span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span>element<span class="token punctuation">.</span>name<span class="token punctuation">,</span> element<span class="token punctuation">.</span>lookupType<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>resourceFactory <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NoSuchBeanDefinitionException</span><span class="token punctuation">(</span>element<span class="token punctuation">.</span>lookupType<span class="token punctuation">,</span><span class="token string">"No resource factory configured - specify the 'resourceFactory' property"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">//å…³æ³¨è¿™ä¸ªæ–¹æ³•</span><span class="token keyword">return</span> <span class="token function">autowireResource</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>resourceFactory<span class="token punctuation">,</span> element<span class="token punctuation">,</span> requestingBeanName<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">protected</span> <span class="token class-name">Object</span> <span class="token function">autowireResource</span><span class="token punctuation">(</span><span class="token class-name">BeanFactory</span> factory<span class="token punctuation">,</span> <span class="token class-name">LookupElement</span> element<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">String</span> requestingBeanName<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">NoSuchBeanDefinitionException</span> <span class="token punctuation">&#123;</span><span class="token class-name">Object</span> resource<span class="token punctuation">;</span><span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> autowiredBeanNames<span class="token punctuation">;</span><span class="token class-name">String</span> name <span class="token operator">=</span> element<span class="token punctuation">.</span>name<span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>factory <span class="token keyword">instanceof</span> <span class="token class-name">AutowireCapableBeanFactory</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token class-name">AutowireCapableBeanFactory</span> beanFactory <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">AutowireCapableBeanFactory</span><span class="token punctuation">)</span> factory<span class="token punctuation">;</span><span class="token class-name">DependencyDescriptor</span> descriptor <span class="token operator">=</span> element<span class="token punctuation">.</span><span class="token function">getDependencyDescriptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>fallbackToDefaultTypeMatch <span class="token operator">&amp;&amp;</span> element<span class="token punctuation">.</span>isDefaultName <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>factory<span class="token punctuation">.</span><span class="token function">containsBean</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>autowiredBeanNames <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedHashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>resource <span class="token operator">=</span> beanFactory<span class="token punctuation">.</span><span class="token function">resolveDependency</span><span class="token punctuation">(</span>descriptor<span class="token punctuation">,</span> requestingBeanName<span class="token punctuation">,</span> autowiredBeanNames<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>resource <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NoSuchBeanDefinitionException</span><span class="token punctuation">(</span>element<span class="token punctuation">.</span><span class="token function">getLookupType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"No resolvable resource object"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">else</span> <span class="token punctuation">&#123;</span>resource <span class="token operator">=</span> beanFactory<span class="token punctuation">.</span><span class="token function">resolveBeanByName</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> descriptor<span class="token punctuation">)</span><span class="token punctuation">;</span>autowiredBeanNames <span class="token operator">=</span> <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">singleton</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">else</span> <span class="token punctuation">&#123;</span><span class="token comment">//é‡ç‚¹åœ¨è¿™é‡Œï¼Œé€šè¿‡getBean()æ–¹å¼è·å–ä¾èµ–æ‰€éœ€è¦çš„bean</span>resource <span class="token operator">=</span> factory<span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> element<span class="token punctuation">.</span>lookupType<span class="token punctuation">)</span><span class="token punctuation">;</span>autowiredBeanNames <span class="token operator">=</span> <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">singleton</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>factory <span class="token keyword">instanceof</span> <span class="token class-name">ConfigurableBeanFactory</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token class-name">ConfigurableBeanFactory</span> beanFactory <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">ConfigurableBeanFactory</span><span class="token punctuation">)</span> factory<span class="token punctuation">;</span><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> autowiredBeanName <span class="token operator">:</span> autowiredBeanNames<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>requestingBeanName <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> beanFactory<span class="token punctuation">.</span><span class="token function">containsBean</span><span class="token punctuation">(</span>autowiredBeanName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>beanFactory<span class="token punctuation">.</span><span class="token function">registerDependentBean</span><span class="token punctuation">(</span>autowiredBeanName<span class="token punctuation">,</span> requestingBeanName<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">return</span> resource<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>åˆ°æ­¤ï¼ŒpopulateBean()å…³äºbeançš„ä¾èµ–å±æ€§æ³¨å…¥æµç¨‹è·Ÿè¸ªå®Œæ¯•ï¼Œä¸‹ä¸€ç« ï¼Œæˆ‘ä»¬å»è·Ÿä¸€ä¸‹beançš„åˆå§‹åŒ–æµç¨‹ï¼Œæ•¬è¯·æœŸå¾…å“¦ï¼^_^</p>]]></content>
      
      
      <categories>
          
          <category> Springæºç å­¦ä¹  </category>
          
      </categories>
      
      
        <tags>
            
            <tag> æºç  </tag>
            
            <tag> Spring </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ã€Springæºç å­¦ä¹ ã€‘Spring Beanå®ä¾‹åŒ–è¿‡ç¨‹-åˆ›å»ºBeanå®ä¾‹</title>
      <link href="/posts/9980.html"/>
      <url>/posts/9980.html</url>
      
        <content type="html"><![CDATA[<h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><h2 id="Spring-åˆå§‹åŒ–æ ¸å¿ƒæµç¨‹"><a href="#Spring-åˆå§‹åŒ–æ ¸å¿ƒæµç¨‹" class="headerlink" title="Spring åˆå§‹åŒ–æ ¸å¿ƒæµç¨‹"></a>Spring åˆå§‹åŒ–æ ¸å¿ƒæµç¨‹</h2><p>springå®¹å™¨åˆå§‹åŒ–çš„æ ¸å¿ƒæ–¹æ³•AbstractApplicationContext#refreshï¼Œ</p><ul><li>refresh Spring åˆå§‹åŒ–æ ¸å¿ƒæµç¨‹å…¥å£<ul><li>prepareRefresh â‘  å‡†å¤‡æ­¤ä¸Šä¸‹æ–‡ç”¨äºåˆ·æ–°ï¼Œè®¾ç½®å¯åŠ¨æ—¶é—´å’Œactiveæ ‡å¿—ï¼Œåˆå§‹åŒ–å±æ€§</li><li>obtainFreshBeanFactory â‘¡ åˆ›å»º BeanFactory å·²ç»è·Ÿè¸ªè¿‡çš„æºç æµç¨‹</li><li>prepareBeanFactory â‘¢ è®¾ç½® BeanFactory çš„åŸºæœ¬å±æ€§</li><li>postProcessBeanFactory â‘£ å­ç±»å¤„ç†è‡ªå®šä¹‰çš„BeanFactoryPostProcess</li><li>invokeBeanFactoryPostProcessors â‘¤ è°ƒç”¨æ‰€æœ‰çš„BeanFactoryPostProcessor</li><li>registerBeanPostProcessors â‘¥ æ³¨å†Œï¼ŒæŠŠå®ç°äº†BeanPostProcessoræ¥å£çš„ç±»å®ä¾‹åŒ–ï¼ŒåŠ åˆ°BeanFactory</li><li>initMessageSource â‘¦ åˆå§‹åŒ–ä¸Šä¸‹æ–‡ä¸­çš„èµ„æºæ–‡ä»¶ï¼Œå¦‚å›½é™…åŒ–æ–‡ä»¶çš„å¤„ç†ç­‰</li><li>initApplicationEventMulticaster â‘§ åˆå§‹åŒ–ä¸Šä¸‹æ–‡çš„äº‹ä»¶ä¼ æ’­å™¨</li><li>onRefresh â‘¨ ç»™å­ç±»æ‰©å±•åˆå§‹åŒ–å…¶ä»–Beanï¼Œspringboot ä¸­ç”¨æ¥åšå†…åµŒ tomcat å¯åŠ¨</li><li>registerListeners â‘© åœ¨æ‰€æœ‰beanä¸­æŸ¥æ‰¾ç›‘å¬ beanï¼Œç„¶åæ³¨å†Œåˆ°å¹¿æ’­å™¨ä¸­</li><li>finishBeanFactoryInitialization <strong>â‘ª æœ¬èŠ‚ä¸»è¦è·Ÿè¸ªçš„æºç æµç¨‹</strong></li><li>finishRefresh â‘« å®Œæˆåˆ·æ–°è¿‡ç¨‹ï¼Œå‘å¸ƒç›¸åº”çš„äº‹ä»¶</li></ul></li></ul><h1 id="ä¸€ã€Beanå®ä¾‹åŒ–æµç¨‹"><a href="#ä¸€ã€Beanå®ä¾‹åŒ–æµç¨‹" class="headerlink" title="ä¸€ã€Beanå®ä¾‹åŒ–æµç¨‹"></a>ä¸€ã€Beanå®ä¾‹åŒ–æµç¨‹</h1><p>æ€»ä½“ä¸Šï¼ŒBeanå®ä¾‹åŒ–æµç¨‹ä¸»è¦æœ‰ä¸‰ä¸ªæ­¥éª¤ï¼š</p><ul><li>åˆ›å»ºBeanå®ä¾‹</li><li>å±æ€§æ³¨å…¥</li><li>Beanåˆå§‹åŒ–</li></ul><p>æœ¬ç« ä¸»è¦æ˜¯è®²åˆ›å»ºBeanå®ä¾‹çš„è¿‡ç¨‹ï¼Œæˆ‘åˆ†ä¸ºä¸¤ä¸ªéƒ¨åˆ†ï¼šä¸€æ˜¯æ„é€ å‡½æ•°çš„é€‰å–ï¼ŒäºŒæ˜¯ä¾èµ–æ³¨å…¥ç›¸å…³çš„æ³¨è§£æ‰«æ.</p><h1 id="äºŒã€æ—¶åºå›¾"><a href="#äºŒã€æ—¶åºå›¾" class="headerlink" title="äºŒã€æ—¶åºå›¾"></a>äºŒã€æ—¶åºå›¾</h1><p><img src="https://cdn.jsdelivr.net/gh/zyxelva/picgo@main/csdn/20210411112559829.png"></p><h1 id="ä¸‰ã€æºç è·Ÿè¸ª"><a href="#ä¸‰ã€æºç è·Ÿè¸ª" class="headerlink" title="ä¸‰ã€æºç è·Ÿè¸ª"></a>ä¸‰ã€æºç è·Ÿè¸ª</h1><h2 id="1-finishBeanFactoryInitialization"><a href="#1-finishBeanFactoryInitialization" class="headerlink" title="1.finishBeanFactoryInitialization()"></a>1.finishBeanFactoryInitialization()</h2><p>ç‚¹è¿›å»çœ‹çœ‹finishBeanFactoryInitialization()æ–¹æ³•</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/** * è¿™ä¸ªæ–¹æ³•æ˜¯springä¸­æœ€é‡è¦çš„æ–¹æ³•ï¼Œæ²¡æœ‰ä¹‹ä¸€ * æ‰€ä»¥è¿™ä¸ªæ–¹æ³•ä¸€å®šè¦ç†è§£è¦å…·ä½“çœ‹ * 1ã€beanå®ä¾‹åŒ–è¿‡ç¨‹ * 2ã€ioc * 3ã€æ³¨è§£æ”¯æŒ * 4ã€BeanPostProcessorçš„æ‰§è¡Œ * 5ã€Aopçš„å…¥å£ * */</span><span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">finishBeanFactoryInitialization</span><span class="token punctuation">(</span><span class="token class-name">ConfigurableListableBeanFactory</span> beanFactory<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">// Initialize conversion service for this context.</span><span class="token comment">//è®¾ç½®ç±»å‹è½¬æ¢å™¨</span><span class="token keyword">if</span> <span class="token punctuation">(</span>beanFactory<span class="token punctuation">.</span><span class="token function">containsBean</span><span class="token punctuation">(</span><span class="token constant">CONVERSION_SERVICE_BEAN_NAME</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>beanFactory<span class="token punctuation">.</span><span class="token function">isTypeMatch</span><span class="token punctuation">(</span><span class="token constant">CONVERSION_SERVICE_BEAN_NAME</span><span class="token punctuation">,</span> <span class="token class-name">ConversionService</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>beanFactory<span class="token punctuation">.</span><span class="token function">setConversionService</span><span class="token punctuation">(</span>beanFactory<span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span><span class="token constant">CONVERSION_SERVICE_BEAN_NAME</span><span class="token punctuation">,</span> <span class="token class-name">ConversionService</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">// Register a default embedded value resolver if no bean post-processor</span><span class="token comment">// (such as a PropertyPlaceholderConfigurer bean) registered any before:</span><span class="token comment">// at this point, primarily for resolution in annotation attribute values.</span><span class="token comment">//æš‚æ—¶ä¸è¦çœ‹</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>beanFactory<span class="token punctuation">.</span><span class="token function">hasEmbeddedValueResolver</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>beanFactory<span class="token punctuation">.</span><span class="token function">addEmbeddedValueResolver</span><span class="token punctuation">(</span>strVal <span class="token operator">-></span> <span class="token function">getEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">resolvePlaceholders</span><span class="token punctuation">(</span>strVal<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">// Initialize LoadTimeWeaverAware beans early to allow for registering their transformers early.</span><span class="token comment">//æš‚æ—¶ä¸çœ‹</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> weaverAwareNames <span class="token operator">=</span> beanFactory<span class="token punctuation">.</span><span class="token function">getBeanNamesForType</span><span class="token punctuation">(</span><span class="token class-name">LoadTimeWeaverAware</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> weaverAwareName <span class="token operator">:</span> weaverAwareNames<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token function">getBean</span><span class="token punctuation">(</span>weaverAwareName<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">// Stop using the temporary ClassLoader for type matching.</span>beanFactory<span class="token punctuation">.</span><span class="token function">setTempClassLoader</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// Allow for caching all bean definition metadata, not expecting further changes.</span>beanFactory<span class="token punctuation">.</span><span class="token function">freezeConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//é‡ç‚¹çœ‹è¿™ä¸ªæ–¹æ³•ï¼Œé‡è¦ç¨‹åº¦ï¼š5</span><span class="token comment">// Instantiate all remaining (non-lazy-init) singletons.</span>beanFactory<span class="token punctuation">.</span><span class="token function">preInstantiateSingletons</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>é‡ç‚¹å…³æ³¨è¿™ä¸ªæ–¹æ³•çš„å¤„ç†beanFactory.preInstantiateSingletons()</p><h2 id="2-preInstantiateSingletons"><a href="#2-preInstantiateSingletons" class="headerlink" title="2.preInstantiateSingletons()"></a>2.preInstantiateSingletons()</h2><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/* * å…·ä½“å®ä¾‹åŒ–è¿‡ç¨‹ * */</span><span class="token annotation punctuation">@Override</span><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">preInstantiateSingletons</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">BeansException</span> <span class="token punctuation">&#123;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isTraceEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>logger<span class="token punctuation">.</span><span class="token function">trace</span><span class="token punctuation">(</span><span class="token string">"Pre-instantiating singletons in "</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">// Iterate over a copy to allow for init methods which in turn register new bean definitions.</span><span class="token comment">// While this may not be part of the regular factory bootstrap, it does otherwise work fine.</span><span class="token comment">//xmlè§£ææ—¶ï¼Œè®²è¿‡ï¼ŒæŠŠæ‰€æœ‰beanNameéƒ½ç¼“å­˜åˆ°beanDefinitionNamesäº†</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> beanNames <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>beanDefinitionNames<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// Trigger initialization of all non-lazy singleton beans...</span><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> beanName <span class="token operator">:</span> beanNames<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">//æŠŠçˆ¶BeanDefinitioné‡Œé¢çš„å±æ€§æ‹¿åˆ°å­BeanDefinitionä¸­</span><span class="token class-name">RootBeanDefinition</span> bd <span class="token operator">=</span> <span class="token function">getMergedLocalBeanDefinition</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//å¦‚æœä¸æ˜¯æŠ½è±¡çš„ï¼Œå•ä¾‹çš„ï¼Œéæ‡’åŠ è½½çš„å°±å®ä¾‹åŒ–</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>bd<span class="token punctuation">.</span><span class="token function">isAbstract</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> bd<span class="token punctuation">.</span><span class="token function">isSingleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>bd<span class="token punctuation">.</span><span class="token function">isLazyInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">//åˆ¤æ–­beanæ˜¯å¦å®ç°äº†FactoryBeanæ¥å£ï¼Œè¿™é‡Œå¯ä»¥ä¸çœ‹  &amp;factoryBeanDemo</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isFactoryBean</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token class-name">Object</span> bean <span class="token operator">=</span> <span class="token function">getBean</span><span class="token punctuation">(</span><span class="token constant">FACTORY_BEAN_PREFIX</span> <span class="token operator">+</span> beanName<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>bean <span class="token keyword">instanceof</span> <span class="token class-name">FactoryBean</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token class-name">FactoryBean</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span> factory <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">FactoryBean</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span><span class="token punctuation">)</span> bean<span class="token punctuation">;</span><span class="token keyword">boolean</span> isEagerInit<span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">getSecurityManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> factory <span class="token keyword">instanceof</span> <span class="token class-name">SmartFactoryBean</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>isEagerInit <span class="token operator">=</span> <span class="token class-name">AccessController</span><span class="token punctuation">.</span><span class="token function">doPrivileged</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">PrivilegedAction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Boolean</span><span class="token punctuation">></span></span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">SmartFactoryBean</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span><span class="token punctuation">)</span> factory<span class="token punctuation">)</span><span class="token operator">::</span><span class="token function">isEagerInit</span><span class="token punctuation">,</span><span class="token function">getAccessControlContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">else</span> <span class="token punctuation">&#123;</span>isEagerInit <span class="token operator">=</span> <span class="token punctuation">(</span>factory <span class="token keyword">instanceof</span> <span class="token class-name">SmartFactoryBean</span> <span class="token operator">&amp;&amp;</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">SmartFactoryBean</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span><span class="token punctuation">)</span> factory<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isEagerInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>isEagerInit<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token function">getBean</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">else</span> <span class="token punctuation">&#123;</span><span class="token comment">//ä¸»è¦ä»è¿™é‡Œè¿›å…¥ï¼Œçœ‹çœ‹å®ä¾‹åŒ–è¿‡ç¨‹</span><span class="token function">getBean</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token comment">// Trigger post-initialization callback for all applicable beans...</span><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> beanName <span class="token operator">:</span> beanNames<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token class-name">Object</span> singletonInstance <span class="token operator">=</span> <span class="token function">getSingleton</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>singletonInstance <span class="token keyword">instanceof</span> <span class="token class-name">SmartInitializingSingleton</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token class-name">SmartInitializingSingleton</span> smartSingleton <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">SmartInitializingSingleton</span><span class="token punctuation">)</span> singletonInstance<span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">getSecurityManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token class-name">AccessController</span><span class="token punctuation">.</span><span class="token function">doPrivileged</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">PrivilegedAction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">></span></span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token punctuation">&#123;</span>smartSingleton<span class="token punctuation">.</span><span class="token function">afterSingletonsInstantiated</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token function">getAccessControlContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">else</span> <span class="token punctuation">&#123;</span>smartSingleton<span class="token punctuation">.</span><span class="token function">afterSingletonsInstantiated</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="3-getBean-doGetBean"><a href="#3-getBean-doGetBean" class="headerlink" title="3.getBean(),doGetBean()"></a>3.getBean(),doGetBean()</h2><p>è¿™é‡Œä¸çœ‹factoryBeançš„å®ä¾‹åŒ–ï¼Œæˆ‘è¿™é‡Œå…³æ³¨getBean(beanname)æ–¹æ³•ï¼Œå¦å¤–å…ˆæ³¨æ„ä¸€ä¸‹beanå®ä¾‹åŒ–çš„æ¡ä»¶</p><ul><li>ä¸æ˜¯æŠ½è±¡çš„</li><li>å•ä¾‹çš„</li><li>éæ‡’åŠ è½½çš„</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">//AbstractBeanFactory</span><span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">getBean</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">BeansException</span> <span class="token punctuation">&#123;</span><span class="token keyword">return</span> <span class="token function">doGetBean</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">protected</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> <span class="token class-name">T</span> <span class="token function">doGetBean</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> requiredType<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">,</span> <span class="token keyword">boolean</span> typeCheckOnly<span class="token punctuation">)</span><span class="token keyword">throws</span> <span class="token class-name">BeansException</span> <span class="token punctuation">&#123;</span><span class="token comment">// è·å–ä¸€ä¸ªbeanNameï¼Œå¤„ç†ä¸¤ç§æƒ…å†µï¼Œä¸€ä¸ªæ˜¯å‰é¢è¯´çš„ FactoryBean (å‰é¢å¸¦ '&amp;')ï¼Œ</span><span class="token comment">// ä¸€ä¸ªæ˜¯åˆ«åé—®é¢˜ï¼Œå› ä¸ºè¿™ä¸ªæ–¹æ³•æ˜¯ getBeanï¼Œè·å– Bean ç”¨çš„ï¼Œä½ è¦æ˜¯ä¼ ä¸€ä¸ªåˆ«åè¿›æ¥ï¼Œæ˜¯å®Œå…¨å¯ä»¥çš„</span><span class="token class-name">String</span> beanName <span class="token operator">=</span> <span class="token function">transformedBeanName</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">Object</span> bean<span class="token punctuation">;</span><span class="token comment">/* * Description : æ£€æŸ¥ç¼“å­˜ä¸­æˆ–è€…å®ä¾‹å·¥å‚ä¸­æ˜¯å¦æœ‰å¯¹åº”çš„å®ä¾‹ * å› ä¸ºåœ¨åˆ›å»ºå•ä¾‹ beançš„æ—¶å€™ä¼šå­˜åœ¨ä¾èµ–æ³¨å…¥ï¼Œè€Œåœ¨åˆ›å»ºä¾èµ–çš„æ—¶å€™ä¸ºäº†é¿å…å¾ªç¯ä¾èµ–ï¼Œ * springåˆ›å»ºbeançš„åŸåˆ™æ˜¯ï¼šä¸ç­‰ bean åˆ›å»ºå®Œæˆå°±å°†åˆ›å»ºbeançš„ ObjectFactory ææ—©æ›å…‰ï¼Œ *  æ¢å¥è¯è¯´ï¼Œä¹Ÿå°±æ˜¯å°† ObjectFactory åŠ å…¥åˆ°ç¼“å­˜ä¸­ï¼Œä¸€æ—¦ä¸‹ä¸€ä¸ªbeanåˆ›å»ºçš„æ—¶å€™éœ€è¦ä¾èµ–ä¸Š *  ä¸€ä¸ªbeanåˆ™ç›´æ¥ä½¿ç”¨ ObjectFactory * *  ç¬¬ä¸€æ¬¡getSingleton(beanName) */</span><span class="token comment">// Eagerly check singleton cache for manually registered singletons.</span><span class="token class-name">Object</span> sharedInstance <span class="token operator">=</span> <span class="token function">getSingleton</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//å¦‚æœç¼“å­˜é‡Œé¢èƒ½æ‹¿åˆ°å®ä¾‹</span><span class="token keyword">if</span> <span class="token punctuation">(</span>sharedInstance <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> args <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isTraceEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isSingletonCurrentlyInCreation</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>logger<span class="token punctuation">.</span><span class="token function">trace</span><span class="token punctuation">(</span><span class="token string">"Returning eagerly cached instance of singleton bean '"</span> <span class="token operator">+</span> beanName <span class="token operator">+</span><span class="token string">"' that is not fully initialized yet - a consequence of a circular reference"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">else</span> <span class="token punctuation">&#123;</span>logger<span class="token punctuation">.</span><span class="token function">trace</span><span class="token punctuation">(</span><span class="token string">"Returning cached instance of singleton bean '"</span> <span class="token operator">+</span> beanName <span class="token operator">+</span> <span class="token string">"'"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token comment">// è¯¥æ–¹æ³•æ˜¯ FactoryBean æ¥å£çš„è°ƒç”¨å…¥å£</span><span class="token comment">// å¦‚æœæ˜¯æ™®é€š Bean çš„è¯ï¼Œç›´æ¥è¿”å› sharedInstanceï¼ˆç›´æ¥è¿”å›å¯¹è±¡æœ¬èº«ï¼‰</span><span class="token comment">// å¦‚æœæ˜¯ FactoryBean çš„è¯ï¼Œè¿”å›å®ƒåˆ›å»ºçš„é‚£ä¸ªå®ä¾‹å¯¹è±¡(è¿”å›æŒ‡å®šæ–¹æ³•è¿”å›çš„å®ä¾‹)</span>bean <span class="token operator">=</span> <span class="token function">getObjectForBeanInstance</span><span class="token punctuation">(</span>sharedInstance<span class="token punctuation">,</span> name<span class="token punctuation">,</span> beanName<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">else</span> <span class="token punctuation">&#123;</span><span class="token comment">//å¦‚æœsingletonObjectsç¼“å­˜é‡Œé¢æ²¡æœ‰ï¼Œåˆ™èµ°ä¸‹æ¥</span><span class="token comment">// Fail if we're already creating this bean instance:</span><span class="token comment">// We're assembly within a circular reference.</span><span class="token comment">//å¦‚æœæ˜¯scope æ˜¯Prototypeçš„ï¼Œæ ¡éªŒæ˜¯å¦æœ‰å‡ºç°å¾ªç¯ä¾èµ–ï¼Œå¦‚æœæœ‰åˆ™ç›´æ¥æŠ¥é”™</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isPrototypeCurrentlyInCreation</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BeanCurrentlyInCreationException</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">// Check if bean definition exists in this factory.</span><span class="token comment">//æ£€æŸ¥ä¸€ä¸‹è¿™ä¸ª BeanDefinition åœ¨å®¹å™¨ä¸­æ˜¯å¦å­˜åœ¨</span><span class="token class-name">BeanFactory</span> parentBeanFactory <span class="token operator">=</span> <span class="token function">getParentBeanFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>parentBeanFactory <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">containsBeanDefinition</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">// Not found -> check parent.</span><span class="token comment">// å¦‚æœå½“å‰å®¹å™¨ä¸å­˜åœ¨è¿™ä¸ª BeanDefinitionï¼Œè¯•è¯•çˆ¶å®¹å™¨ä¸­æœ‰æ²¡æœ‰</span><span class="token class-name">String</span> nameToLookup <span class="token operator">=</span> <span class="token function">originalBeanName</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>parentBeanFactory <span class="token keyword">instanceof</span> <span class="token class-name">AbstractBeanFactory</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">AbstractBeanFactory</span><span class="token punctuation">)</span> parentBeanFactory<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">doGetBean</span><span class="token punctuation">(</span>nameToLookup<span class="token punctuation">,</span> requiredType<span class="token punctuation">,</span> args<span class="token punctuation">,</span> typeCheckOnly<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>args <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">// Delegation to parent with explicit args.</span><span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token class-name">T</span><span class="token punctuation">)</span> parentBeanFactory<span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span>nameToLookup<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>requiredType <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">// No args -> delegate to standard getBean method.</span><span class="token keyword">return</span> parentBeanFactory<span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span>nameToLookup<span class="token punctuation">,</span> requiredType<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">else</span> <span class="token punctuation">&#123;</span><span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token class-name">T</span><span class="token punctuation">)</span> parentBeanFactory<span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span>nameToLookup<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token comment">// typeCheckOnly ä¸º falseï¼Œå°†å½“å‰ beanName æ”¾å…¥ä¸€ä¸ª alreadyCreated çš„ Set é›†åˆä¸­ã€‚</span><span class="token comment">// å¦‚æœä¸æ˜¯ä»…ä»…åšç±»å‹æ£€æŸ¥è€Œæ˜¯åˆ›å»ºbeanï¼Œåˆ™è¿›è¡Œè®°å½•</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>typeCheckOnly<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token function">markBeanAsCreated</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">//è¦å¼€å§‹åˆ›å»ºbeanäº†ï¼Œåˆ†ä¸¤ç§æƒ…å†µï¼šä¸€ç§æ˜¯é’ˆå¯¹å•ä¾‹çš„ï¼ˆsingletonï¼‰ï¼Œä¸€ç§æ˜¯é’ˆå¯¹å¤šä¾‹çš„ï¼ˆprototypeï¼‰ï¼Œä¸€ç§æ˜¯è‡ªå®šä¹‰scopeçš„</span><span class="token keyword">try</span> <span class="token punctuation">&#123;</span><span class="token comment">//çˆ¶å­BeanDefinitionåˆå¹¶</span><span class="token class-name">RootBeanDefinition</span> mbd <span class="token operator">=</span> <span class="token function">getMergedLocalBeanDefinition</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">checkMergedBeanDefinition</span><span class="token punctuation">(</span>mbd<span class="token punctuation">,</span> beanName<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//è·å–ä¾èµ–å¯¹è±¡å±æ€§ï¼Œä¾èµ–å¯¹è±¡è¦å…ˆå®ä¾‹åŒ–</span><span class="token comment">// Guarantee initialization of beans that the current bean depends on.</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> dependsOn <span class="token operator">=</span> mbd<span class="token punctuation">.</span><span class="token function">getDependsOn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>dependsOn <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> dep <span class="token operator">:</span> dependsOn<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDependent</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> dep<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BeanCreationException</span><span class="token punctuation">(</span>mbd<span class="token punctuation">.</span><span class="token function">getResourceDescription</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> beanName<span class="token punctuation">,</span><span class="token string">"Circular depends-on relationship between '"</span> <span class="token operator">+</span> beanName <span class="token operator">+</span> <span class="token string">"' and '"</span> <span class="token operator">+</span> dep <span class="token operator">+</span> <span class="token string">"'"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token function">registerDependentBean</span><span class="token punctuation">(</span>dep<span class="token punctuation">,</span> beanName<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">try</span> <span class="token punctuation">&#123;</span><span class="token comment">//å®ä¾‹åŒ–</span><span class="token function">getBean</span><span class="token punctuation">(</span>dep<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">NoSuchBeanDefinitionException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BeanCreationException</span><span class="token punctuation">(</span>mbd<span class="token punctuation">.</span><span class="token function">getResourceDescription</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> beanName<span class="token punctuation">,</span><span class="token string">"'"</span> <span class="token operator">+</span> beanName <span class="token operator">+</span> <span class="token string">"' depends on missing bean '"</span> <span class="token operator">+</span> dep <span class="token operator">+</span> <span class="token string">"'"</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token comment">//å•ä¾‹æƒ…å†µsingletonï¼Œç€é‡çœ‹ï¼Œå¤§éƒ¨åˆ†æ˜¯å•ä¾‹çš„æƒ…å†µ</span><span class="token comment">// Create bean instance.</span><span class="token keyword">if</span> <span class="token punctuation">(</span>mbd<span class="token punctuation">.</span><span class="token function">isSingleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">//ç¬¬äºŒæ¬¡getSingleton(beanName, singletonFactory)</span>sharedInstance <span class="token operator">=</span> <span class="token function">getSingleton</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token punctuation">&#123;</span><span class="token keyword">try</span> <span class="token punctuation">&#123;</span><span class="token keyword">return</span> <span class="token function">createBean</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> mbd<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">BeansException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">// Explicitly remove instance from singleton cache: It might have been put there</span><span class="token comment">// eagerly by the creation process, to allow for circular reference resolution.</span><span class="token comment">// Also remove any beans that received a temporary reference to the bean.</span><span class="token function">destroySingleton</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">throw</span> ex<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//è¯¥æ–¹æ³•æ˜¯FactoryBeanæ¥å£çš„è°ƒç”¨å…¥å£</span>bean <span class="token operator">=</span> <span class="token function">getObjectForBeanInstance</span><span class="token punctuation">(</span>sharedInstance<span class="token punctuation">,</span> name<span class="token punctuation">,</span> beanName<span class="token punctuation">,</span> mbd<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">//å¤šä¾‹æƒ…å†µprototype</span><span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>mbd<span class="token punctuation">.</span><span class="token function">isPrototype</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">// It's a prototype -> create a new instance.</span><span class="token class-name">Object</span> prototypeInstance <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span><span class="token keyword">try</span> <span class="token punctuation">&#123;</span><span class="token function">beforePrototypeCreation</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>prototypeInstance <span class="token operator">=</span> <span class="token function">createBean</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> mbd<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">finally</span> <span class="token punctuation">&#123;</span><span class="token function">afterPrototypeCreation</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">//è¯¥æ–¹æ³•æ˜¯FactoryBeanæ¥å£çš„è°ƒç”¨å…¥å£</span>bean <span class="token operator">=</span> <span class="token function">getObjectForBeanInstance</span><span class="token punctuation">(</span>prototypeInstance<span class="token punctuation">,</span> name<span class="token punctuation">,</span> beanName<span class="token punctuation">,</span> mbd<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">// å¦‚æœä¸æ˜¯ singleton å’Œ prototype çš„è¯ï¼Œéœ€è¦å§”æ‰˜ç»™ç›¸åº”çš„å®ç°ç±»æ¥å¤„ç†</span><span class="token keyword">else</span> <span class="token punctuation">&#123;</span><span class="token class-name">String</span> scopeName <span class="token operator">=</span> mbd<span class="token punctuation">.</span><span class="token function">getScope</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">hasLength</span><span class="token punctuation">(</span>scopeName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">"No scope name defined for bean Â´"</span> <span class="token operator">+</span> beanName <span class="token operator">+</span> <span class="token string">"'"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token class-name">Scope</span> scope <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>scopes<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>scopeName<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>scope <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">"No Scope registered for scope name '"</span> <span class="token operator">+</span> scopeName <span class="token operator">+</span> <span class="token string">"'"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">try</span> <span class="token punctuation">&#123;</span><span class="token class-name">Object</span> scopedInstance <span class="token operator">=</span> scope<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token punctuation">&#123;</span><span class="token function">beforePrototypeCreation</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">try</span> <span class="token punctuation">&#123;</span><span class="token keyword">return</span> <span class="token function">createBean</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> mbd<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">finally</span> <span class="token punctuation">&#123;</span><span class="token function">afterPrototypeCreation</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>bean <span class="token operator">=</span> <span class="token function">getObjectForBeanInstance</span><span class="token punctuation">(</span>scopedInstance<span class="token punctuation">,</span> name<span class="token punctuation">,</span> beanName<span class="token punctuation">,</span> mbd<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IllegalStateException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BeanCreationException</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span><span class="token string">"Scope '"</span> <span class="token operator">+</span> scopeName <span class="token operator">+</span> <span class="token string">"' is not active for the current thread; consider "</span> <span class="token operator">+</span><span class="token string">"defining a scoped proxy for this bean if you intend to refer to it from a singleton"</span><span class="token punctuation">,</span>ex<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">BeansException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token function">cleanupAfterBeanCreationFailure</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">throw</span> ex<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token comment">// Check if required type matches the type of the actual bean instance.</span><span class="token comment">// æœ€åï¼Œæ£€æŸ¥ä¸€ä¸‹ç±»å‹å¯¹ä¸å¯¹ï¼Œä¸å¯¹çš„è¯å°±æŠ›å¼‚å¸¸ï¼Œå¯¹çš„è¯å°±è¿”å›</span><span class="token keyword">if</span> <span class="token punctuation">(</span>requiredType <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>requiredType<span class="token punctuation">.</span><span class="token function">isInstance</span><span class="token punctuation">(</span>bean<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">try</span> <span class="token punctuation">&#123;</span><span class="token class-name">T</span> convertedBean <span class="token operator">=</span> <span class="token function">getTypeConverter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">convertIfNecessary</span><span class="token punctuation">(</span>bean<span class="token punctuation">,</span> requiredType<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>convertedBean <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BeanNotOfRequiredTypeException</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> requiredType<span class="token punctuation">,</span> bean<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">return</span> convertedBean<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">TypeMismatchException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isTraceEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>logger<span class="token punctuation">.</span><span class="token function">trace</span><span class="token punctuation">(</span><span class="token string">"Failed to convert bean '"</span> <span class="token operator">+</span> name <span class="token operator">+</span> <span class="token string">"' to required type '"</span> <span class="token operator">+</span><span class="token class-name">ClassUtils</span><span class="token punctuation">.</span><span class="token function">getQualifiedName</span><span class="token punctuation">(</span>requiredType<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"'"</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BeanNotOfRequiredTypeException</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> requiredType<span class="token punctuation">,</span> bean<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token class-name">T</span><span class="token punctuation">)</span> bean<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="4-getSingleton"><a href="#4-getSingleton" class="headerlink" title="4.getSingleton()"></a>4.getSingleton()</h2><p>æˆ‘ä»¬å…ˆçœ‹çœ‹ä¸¤æ¬¡è°ƒç”¨getSingleton()çš„ä¸¤ä¸ªé‡è½½æ–¹æ³•<br>ç¬¬ä¸€æ¬¡è°ƒç”¨</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">getSingleton</span><span class="token punctuation">(</span><span class="token class-name">String</span> beanName<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">return</span> <span class="token function">getSingleton</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">protected</span> <span class="token class-name">Object</span> <span class="token function">getSingleton</span><span class="token punctuation">(</span><span class="token class-name">String</span> beanName<span class="token punctuation">,</span> <span class="token keyword">boolean</span> allowEarlyReference<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">//æ ¹æ®beanNameä»ç¼“å­˜ä¸­æ‹¿å®ä¾‹</span><span class="token comment">//å…ˆä»ä¸€çº§ç¼“å­˜æ‹¿</span><span class="token class-name">Object</span> singletonObject <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>singletonObjects<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//å¦‚æœbeanè¿˜æ­£åœ¨åˆ›å»ºï¼Œè¿˜æ²¡åˆ›å»ºå®Œæˆï¼Œå…¶å®å°±æ˜¯å †å†…å­˜æœ‰äº†ï¼Œå±æ€§è¿˜æ²¡æœ‰DIä¾èµ–æ³¨å…¥</span><span class="token keyword">if</span> <span class="token punctuation">(</span>singletonObject <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isSingletonCurrentlyInCreation</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>singletonObjects<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">//ä»äºŒçº§ç¼“å­˜ä¸­æ‹¿</span>singletonObject <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>earlySingletonObjects<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//å¦‚æœè¿˜æ‹¿ä¸åˆ°ï¼Œå¹¶ä¸”å…è®¸beanæå‰æš´éœ²</span><span class="token keyword">if</span> <span class="token punctuation">(</span>singletonObject <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> allowEarlyReference<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">//ä»ä¸‰çº§ç¼“å­˜ä¸­æ‹¿åˆ°å¯¹è±¡å·¥å‚</span><span class="token class-name">ObjectFactory</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span> singletonFactory <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>singletonFactories<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>singletonFactory <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">//ä»å·¥å‚ä¸­æ‹¿åˆ°å¯¹è±¡</span>singletonObject <span class="token operator">=</span> singletonFactory<span class="token punctuation">.</span><span class="token function">getObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//å‡çº§åˆ°äºŒçº§ç¼“å­˜</span><span class="token keyword">this</span><span class="token punctuation">.</span>earlySingletonObjects<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> singletonObject<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//åˆ é™¤ä¸‰çº§ç¼“å­˜</span><span class="token keyword">this</span><span class="token punctuation">.</span>singletonFactories<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">return</span> singletonObject<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è¿™æ¬¡çš„è°ƒç”¨ç¼“å­˜é‡Œéƒ½æ˜¯æ²¡æœ‰çš„ï¼Œä¸‰çº§ç¼“å­˜çš„è®¾è®¡æ˜¯ä¸ºäº†è§£å†³å¾ªç¯ä¾èµ–å’ŒAOPä»£ç†çš„é—®é¢˜ï¼Œè¿™ä¸ªåœ¨åé¢è¯¦è¯´ã€‚<br>ç¬¬äºŒæ¬¡è°ƒç”¨</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">getSingleton</span><span class="token punctuation">(</span><span class="token class-name">String</span> beanName<span class="token punctuation">,</span> <span class="token class-name">ObjectFactory</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span> singletonFactory<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">notNull</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> <span class="token string">"Bean name must not be null"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>singletonObjects<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">//å¦‚æœç¼“å­˜ä¸­æœ‰ï¼Œåˆ™ç›´æ¥è¿”å›</span><span class="token class-name">Object</span> singletonObject <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>singletonObjects<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>singletonObject <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>singletonsCurrentlyInDestruction<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BeanCreationNotAllowedException</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span><span class="token string">"Singleton bean creation not allowed while singletons of this factory are in destruction "</span> <span class="token operator">+</span><span class="token string">"(Do not request a bean from a BeanFactory in a destroy method implementation!)"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"Creating shared instance of singleton bean '"</span> <span class="token operator">+</span> beanName <span class="token operator">+</span> <span class="token string">"'"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">//æŠŠbeanNameæ·»åŠ åˆ°singletonsCurrentlyInCreation Setå®¹å™¨ä¸­ï¼Œåœ¨è¿™ä¸ªé›†åˆé‡Œé¢çš„beanéƒ½æ˜¯æ­£åœ¨å®ä¾‹åŒ–çš„bean</span><span class="token function">beforeSingletonCreation</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">boolean</span> newSingleton <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span><span class="token keyword">boolean</span> recordSuppressedExceptions <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>suppressedExceptions <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>recordSuppressedExceptions<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">this</span><span class="token punctuation">.</span>suppressedExceptions <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedHashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">try</span> <span class="token punctuation">&#123;</span><span class="token comment">//å¦‚æœè¿™é‡Œæœ‰è¿”å›å€¼ï¼Œå°±ä»£è¡¨è¿™ä¸ªbeanå·²ç»ç»“æŸåˆ›å»ºäº†ï¼Œå·²ç»å®Œå…¨åˆ›å»ºæˆåŠŸ</span>singletonObject <span class="token operator">=</span> singletonFactory<span class="token punctuation">.</span><span class="token function">getObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>newSingleton <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IllegalStateException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">// Has the singleton object implicitly appeared in the meantime -></span><span class="token comment">// if yes, proceed with it since the exception indicates that state.</span>singletonObject <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>singletonObjects<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>singletonObject <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">throw</span> ex<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">BeanCreationException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>recordSuppressedExceptions<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> suppressedException <span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>suppressedExceptions<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>ex<span class="token punctuation">.</span><span class="token function">addRelatedCause</span><span class="token punctuation">(</span>suppressedException<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">throw</span> ex<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">finally</span> <span class="token punctuation">&#123;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>recordSuppressedExceptions<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">this</span><span class="token punctuation">.</span>suppressedExceptions <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">//beanåˆ›å»ºå®ŒæˆåsingletonsCurrentlyInCreationè¦åˆ é™¤è¯¥bean</span><span class="token function">afterSingletonCreation</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>newSingleton<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">//åˆ›å»ºå¯¹è±¡æˆåŠŸæ—¶ï¼ŒæŠŠå¯¹è±¡ç¼“å­˜åˆ°singletonObjectsç¼“å­˜ä¸­,beanåˆ›å»ºå®Œæˆæ—¶æ”¾å…¥ä¸€çº§ç¼“å­˜</span><span class="token function">addSingleton</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> singletonObject<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">return</span> singletonObject<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è¿™é‡Œæ€»ç»“ä¸€ä¸‹æµç¨‹</p><ul><li>æŠŠbeanNameæ·»åŠ åˆ°singletonsCurrentlyInCreation Setå®¹å™¨ä¸­ï¼ˆå…¶ä¸­è¿™ä¸ªåœ¨å¾ªç¯ä¾èµ–æ—¶ä¸‰çº§ç¼“å­˜ä¼šç”¨åˆ°ï¼‰</li><li>singletonFactory.getObject()ï¼šè¿™ä¸ªå°±ä¼šè°ƒç”¨åˆ°å¤–å±‚Lambdaè¡¨è¾¾å¼ä¸­å®ç°getObject()çš„ä¸šåŠ¡æ–¹æ³•ï¼Œå³createBean()æ–¹æ³•ï¼Œå°±æ˜¯è¿™ä¸ª<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token punctuation">&#123;</span><span class="token keyword">try</span> <span class="token punctuation">&#123;</span><span class="token keyword">return</span> <span class="token function">createBean</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> mbd<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>æ­¤å¤„çœç•¥ä¸€ä¸‡å­—çš„ä»£ç ã€‚<span class="token operator">^</span>_<span class="token operator">^</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li>beanåˆ›å»ºæˆåŠŸï¼ˆå®Œæ•´çš„beanï¼‰ï¼Œä»singletonsCurrentlyInCreationåˆ é™¤</li><li>å°†beanæ·»åŠ è‡³ä¸€çº§ç¼“å­˜ä¸­</li></ul><h2 id="5-createBean"><a href="#5-createBean" class="headerlink" title="5.createBean()"></a>5.createBean()</h2><p>å¥½ï¼Œè¿›å»çœ‹çœ‹createBeanæ–¹æ³•</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">protected</span> <span class="token class-name">Object</span> <span class="token function">createBean</span><span class="token punctuation">(</span><span class="token class-name">String</span> beanName<span class="token punctuation">,</span> <span class="token class-name">RootBeanDefinition</span> mbd<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span><span class="token keyword">throws</span> <span class="token class-name">BeanCreationException</span> <span class="token punctuation">&#123;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isTraceEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>logger<span class="token punctuation">.</span><span class="token function">trace</span><span class="token punctuation">(</span><span class="token string">"Creating instance of bean '"</span> <span class="token operator">+</span> beanName <span class="token operator">+</span> <span class="token string">"'"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token class-name">RootBeanDefinition</span> mbdToUse <span class="token operator">=</span> mbd<span class="token punctuation">;</span><span class="token comment">// Make sure bean class is actually resolved at this point, and</span><span class="token comment">// clone the bean definition in case of a dynamically resolved Class</span><span class="token comment">// which cannot be stored in the shared merged bean definition.</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span> resolvedClass <span class="token operator">=</span> <span class="token function">resolveBeanClass</span><span class="token punctuation">(</span>mbd<span class="token punctuation">,</span> beanName<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>resolvedClass <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>mbd<span class="token punctuation">.</span><span class="token function">hasBeanClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> mbd<span class="token punctuation">.</span><span class="token function">getBeanClassName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>mbdToUse <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RootBeanDefinition</span><span class="token punctuation">(</span>mbd<span class="token punctuation">)</span><span class="token punctuation">;</span>mbdToUse<span class="token punctuation">.</span><span class="token function">setBeanClass</span><span class="token punctuation">(</span>resolvedClass<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">// Prepare method overrides.</span><span class="token keyword">try</span> <span class="token punctuation">&#123;</span>mbdToUse<span class="token punctuation">.</span><span class="token function">prepareMethodOverrides</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">BeanDefinitionValidationException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BeanDefinitionStoreException</span><span class="token punctuation">(</span>mbdToUse<span class="token punctuation">.</span><span class="token function">getResourceDescription</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>beanName<span class="token punctuation">,</span> <span class="token string">"Validation of method overrides failed"</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">try</span> <span class="token punctuation">&#123;</span><span class="token comment">/* * TargetSourceæ¥å£çš„è¿ç”¨ï¼Œå¯ä»¥åœ¨ç”¨æ”¹ä¸€ä¸ªç±»å®ç°è¯¥æ¥å£ï¼Œç„¶ååœ¨é‡Œé¢å®šä¹‰å®ä¾‹åŒ–å¯¹è±¡çš„æ–¹å¼ï¼Œç„¶åè¿”å› * ä¹Ÿå°±æ˜¯è¯´ä¸éœ€è¦springå¸®åŠ©æˆ‘ä»¬å®ä¾‹åŒ–å¯¹è±¡ * * * è¿™é‡Œå¯ä»¥ç›´æ¥è¿”å›å®ä¾‹æœ¬èº« * * è¿™ä¸ªä»£ç ä¸ç”¨çœ‹ï¼Œå®é™…å¼€å‘è¿‡ç¨‹ä¸­ç”¨ä¸åˆ°ï¼Œæˆ‘ä¼šåšä¸ºä¸€ä¸ªç”œç‚¹åˆ†äº« * */</span><span class="token comment">// Give BeanPostProcessors a chance to return a proxy instead of the target bean instance.</span><span class="token class-name">Object</span> bean <span class="token operator">=</span> <span class="token function">resolveBeforeInstantiation</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> mbdToUse<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>bean <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">return</span> bean<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> ex<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BeanCreationException</span><span class="token punctuation">(</span>mbdToUse<span class="token punctuation">.</span><span class="token function">getResourceDescription</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> beanName<span class="token punctuation">,</span><span class="token string">"BeanPostProcessor before instantiation of bean failed"</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">try</span> <span class="token punctuation">&#123;</span><span class="token comment">//ä¸»è¦çœ‹è¿™ä¸ªæ–¹æ³•ï¼Œé‡è¦ç¨‹åº¦ 5</span><span class="token class-name">Object</span> beanInstance <span class="token operator">=</span> <span class="token function">doCreateBean</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> mbdToUse<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isTraceEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>logger<span class="token punctuation">.</span><span class="token function">trace</span><span class="token punctuation">(</span><span class="token string">"Finished creating instance of bean '"</span> <span class="token operator">+</span> beanName <span class="token operator">+</span> <span class="token string">"'"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">return</span> beanInstance<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">BeanCreationException</span> <span class="token operator">|</span> <span class="token class-name">ImplicitlyAppearedSingletonException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">// A previously detected exception with proper bean creation context already,</span><span class="token comment">// or illegal singleton state to be communicated up to DefaultSingletonBeanRegistry.</span><span class="token keyword">throw</span> ex<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> ex<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BeanCreationException</span><span class="token punctuation">(</span>mbdToUse<span class="token punctuation">.</span><span class="token function">getResourceDescription</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> beanName<span class="token punctuation">,</span> <span class="token string">"Unexpected exception during bean creation"</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å…³é”®çœ‹doCreateBean()</p><h2 id="6-doCreateBean"><a href="#6-doCreateBean" class="headerlink" title="6.doCreateBean()"></a>6.doCreateBean()</h2><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/** * Description: åˆ›å»ºbeanå®ä¾‹çš„æ ¸å¿ƒæ–¹æ³• */</span><span class="token keyword">protected</span> <span class="token class-name">Object</span> <span class="token function">doCreateBean</span><span class="token punctuation">(</span><span class="token class-name">String</span> beanName<span class="token punctuation">,</span> <span class="token class-name">RootBeanDefinition</span> mbd<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span><span class="token keyword">throws</span> <span class="token class-name">BeanCreationException</span> <span class="token punctuation">&#123;</span><span class="token comment">// Instantiate the bean.</span><span class="token class-name">BeanWrapper</span> instanceWrapper <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>mbd<span class="token punctuation">.</span><span class="token function">isSingleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>instanceWrapper <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>factoryBeanInstanceCache<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>instanceWrapper <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">//åˆ›å»ºå®ä¾‹,,é‡ç‚¹çœ‹ï¼Œé‡è¦ç¨‹åº¦ï¼š5</span>instanceWrapper <span class="token operator">=</span> <span class="token function">createBeanInstance</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> mbd<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token class-name">Object</span> bean <span class="token operator">=</span> instanceWrapper<span class="token punctuation">.</span><span class="token function">getWrappedInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span> beanType <span class="token operator">=</span> instanceWrapper<span class="token punctuation">.</span><span class="token function">getWrappedClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>beanType <span class="token operator">!=</span> <span class="token class-name">NullBean</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>mbd<span class="token punctuation">.</span>resolvedTargetType <span class="token operator">=</span> beanType<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">// Allow post-processors to modify the merged bean definition.</span><span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mbd<span class="token punctuation">.</span>postProcessingLock<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mbd<span class="token punctuation">.</span>postProcessed<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">try</span> <span class="token punctuation">&#123;</span><span class="token comment">//CommonAnnotationBeanPostProcessor  æ”¯æŒäº†@PostConstructï¼Œ@PreDestroy,@Resourceæ³¨è§£</span><span class="token comment">//AutowiredAnnotationBeanPostProcessor æ”¯æŒ @Autowired,@Valueæ³¨è§£</span><span class="token comment">//BeanPostProcessoræ¥å£çš„å…¸å‹è¿ç”¨ï¼Œè¿™é‡Œè¦ç†è§£è¿™ä¸ªæ¥å£</span><span class="token comment">//å¯¹ç±»ä¸­æ³¨è§£çš„è£…é…è¿‡ç¨‹</span><span class="token comment">//é‡è¦ç¨‹åº¦5ï¼Œå¿…é¡»çœ‹</span><span class="token function">applyMergedBeanDefinitionPostProcessors</span><span class="token punctuation">(</span>mbd<span class="token punctuation">,</span> beanType<span class="token punctuation">,</span> beanName<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> ex<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BeanCreationException</span><span class="token punctuation">(</span>mbd<span class="token punctuation">.</span><span class="token function">getResourceDescription</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> beanName<span class="token punctuation">,</span><span class="token string">"Post-processing of merged bean definition failed"</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span>mbd<span class="token punctuation">.</span>postProcessed <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token comment">// Eagerly cache singletons to be able to resolve circular references</span><span class="token comment">// even when triggered by lifecycle interfaces like BeanFactoryAware.</span><span class="token comment">//æ˜¯å¦å•ä¾‹beanæå‰æš´éœ²</span><span class="token keyword">boolean</span> earlySingletonExposure <span class="token operator">=</span> <span class="token punctuation">(</span>mbd<span class="token punctuation">.</span><span class="token function">isSingleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>allowCircularReferences <span class="token operator">&amp;&amp;</span><span class="token function">isSingletonCurrentlyInCreation</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>earlySingletonExposure<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isTraceEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>logger<span class="token punctuation">.</span><span class="token function">trace</span><span class="token punctuation">(</span><span class="token string">"Eagerly caching bean '"</span> <span class="token operator">+</span> beanName <span class="token operator">+</span><span class="token string">"' to allow for resolving potential circular references"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">//è¿™é‡Œç€é‡ç†è§£ï¼Œå¯¹ç†è§£å¾ªç¯ä¾èµ–å¸®åŠ©éå¸¸å¤§ï¼Œé‡è¦ç¨‹åº¦ 5   æ·»åŠ ä¸‰çº§ç¼“å­˜</span><span class="token function">addSingletonFactory</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token function">getEarlyBeanReference</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> mbd<span class="token punctuation">,</span> bean<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">// Initialize the bean instance.</span><span class="token class-name">Object</span> exposedObject <span class="token operator">=</span> bean<span class="token punctuation">;</span><span class="token keyword">try</span> <span class="token punctuation">&#123;</span><span class="token comment">//ioc diï¼Œä¾èµ–æ³¨å…¥çš„æ ¸å¿ƒæ–¹æ³•ï¼Œè¯¥æ–¹æ³•å¿…é¡»çœ‹ï¼Œé‡è¦ç¨‹åº¦ï¼š5</span><span class="token function">populateBean</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> mbd<span class="token punctuation">,</span> instanceWrapper<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//bean å®ä¾‹åŒ–+iocä¾èµ–æ³¨å…¥å®Œä»¥åçš„è°ƒç”¨ï¼Œéå¸¸é‡è¦ï¼Œé‡è¦ç¨‹åº¦ï¼š5</span>exposedObject <span class="token operator">=</span> <span class="token function">initializeBean</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> exposedObject<span class="token punctuation">,</span> mbd<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> ex<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>ex <span class="token keyword">instanceof</span> <span class="token class-name">BeanCreationException</span> <span class="token operator">&amp;&amp;</span> beanName<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">BeanCreationException</span><span class="token punctuation">)</span> ex<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBeanName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">throw</span> <span class="token punctuation">(</span><span class="token class-name">BeanCreationException</span><span class="token punctuation">)</span> ex<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">else</span> <span class="token punctuation">&#123;</span><span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BeanCreationException</span><span class="token punctuation">(</span>mbd<span class="token punctuation">.</span><span class="token function">getResourceDescription</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> beanName<span class="token punctuation">,</span> <span class="token string">"Initialization of bean failed"</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>earlySingletonExposure<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token class-name">Object</span> earlySingletonReference <span class="token operator">=</span> <span class="token function">getSingleton</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>earlySingletonReference <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>exposedObject <span class="token operator">==</span> bean<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>exposedObject <span class="token operator">=</span> earlySingletonReference<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>allowRawInjectionDespiteWrapping <span class="token operator">&amp;&amp;</span> <span class="token function">hasDependentBean</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> dependentBeans <span class="token operator">=</span> <span class="token function">getDependentBeans</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> actualDependentBeans <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedHashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span>dependentBeans<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> dependentBean <span class="token operator">:</span> dependentBeans<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">removeSingletonIfCreatedForTypeCheckOnly</span><span class="token punctuation">(</span>dependentBean<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>actualDependentBeans<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>dependentBean<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>actualDependentBeans<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BeanCurrentlyInCreationException</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span><span class="token string">"Bean with name '"</span> <span class="token operator">+</span> beanName <span class="token operator">+</span> <span class="token string">"' has been injected into other beans ["</span> <span class="token operator">+</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">collectionToCommaDelimitedString</span><span class="token punctuation">(</span>actualDependentBeans<span class="token punctuation">)</span> <span class="token operator">+</span><span class="token string">"] in its raw version as part of a circular reference, but has eventually been "</span> <span class="token operator">+</span><span class="token string">"wrapped. This means that said other beans do not use the final version of the "</span> <span class="token operator">+</span><span class="token string">"bean. This is often the result of over-eager type matching - consider using "</span> <span class="token operator">+</span><span class="token string">"'getBeanNamesForType' with the 'allowEagerInit' flag turned off, for example."</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token comment">// Register bean as disposable.</span><span class="token keyword">try</span> <span class="token punctuation">&#123;</span><span class="token comment">//æ³¨å†Œbeané”€æ¯æ—¶çš„ç±»DisposableBeanAdapter</span><span class="token function">registerDisposableBeanIfNecessary</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> bean<span class="token punctuation">,</span> mbd<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">BeanDefinitionValidationException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BeanCreationException</span><span class="token punctuation">(</span>mbd<span class="token punctuation">.</span><span class="token function">getResourceDescription</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> beanName<span class="token punctuation">,</span> <span class="token string">"Invalid destruction signature"</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">return</span> exposedObject<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è¿™ä¸ªæ–¹æ³•å°±æ˜¯æ ¸å¿ƒåˆ›å»ºbeançš„ã€‚<br>ä¸€ä¸ªä¸ªæ¥ï¼Œå…ˆçœ‹åˆ›å»ºä¸€ä¸ªåŸå§‹çš„å®ä¾‹æ–¹æ³•createBeanInstance()</p><h3 id="6-1-createBeanInstance"><a href="#6-1-createBeanInstance" class="headerlink" title="6.1.createBeanInstance()"></a>6.1.createBeanInstance()</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">protected</span> <span class="token class-name">BeanWrapper</span> <span class="token function">createBeanInstance</span><span class="token punctuation">(</span><span class="token class-name">String</span> beanName<span class="token punctuation">,</span> <span class="token class-name">RootBeanDefinition</span> mbd<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">// Make sure bean class is actually resolved at this point.</span><span class="token comment">// 1. å¾—åˆ°beançš„classï¼Œå¹¶éªŒè¯classçš„è®¿é—®æƒé™æ˜¯ä¸æ˜¯public</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span> beanClass <span class="token operator">=</span> <span class="token function">resolveBeanClass</span><span class="token punctuation">(</span>mbd<span class="token punctuation">,</span> beanName<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>beanClass <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token class-name">Modifier</span><span class="token punctuation">.</span><span class="token function">isPublic</span><span class="token punctuation">(</span>beanClass<span class="token punctuation">.</span><span class="token function">getModifiers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>mbd<span class="token punctuation">.</span><span class="token function">isNonPublicAccessAllowed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BeanCreationException</span><span class="token punctuation">(</span>mbd<span class="token punctuation">.</span><span class="token function">getResourceDescription</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> beanName<span class="token punctuation">,</span><span class="token string">"Bean class isn't public, and non-public access not allowed: "</span> <span class="token operator">+</span> beanClass<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token class-name">Supplier</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span> instanceSupplier <span class="token operator">=</span> mbd<span class="token punctuation">.</span><span class="token function">getInstanceSupplier</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>instanceSupplier <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">return</span> <span class="token function">obtainFromSupplier</span><span class="token punctuation">(</span>instanceSupplier<span class="token punctuation">,</span> beanName<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">//å¦‚æœæœ‰FactoryMethodNameå±æ€§ @Bean</span><span class="token keyword">if</span> <span class="token punctuation">(</span>mbd<span class="token punctuation">.</span><span class="token function">getFactoryMethodName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">// åå°„çš„æ–¹å¼è°ƒç”¨FactoryMethod</span><span class="token keyword">return</span> <span class="token function">instantiateUsingFactoryMethod</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> mbd<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">// Shortcut when re-creating the same bean...</span><span class="token keyword">boolean</span> resolved <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span><span class="token keyword">boolean</span> autowireNecessary <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>args <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mbd<span class="token punctuation">.</span>constructorArgumentLock<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>mbd<span class="token punctuation">.</span>resolvedConstructorOrFactoryMethod <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>resolved <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>autowireNecessary <span class="token operator">=</span> mbd<span class="token punctuation">.</span>constructorArgumentsResolved<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>resolved<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>autowireNecessary<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">return</span> <span class="token function">autowireConstructor</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> mbd<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">else</span> <span class="token punctuation">&#123;</span><span class="token keyword">return</span> <span class="token function">instantiateBean</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> mbd<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token comment">// Candidate constructors for autowiring?</span><span class="token comment">//å¯»æ‰¾å½“å‰æ­£åœ¨å®ä¾‹åŒ–çš„beanä¸­æœ‰@Autowiredæ³¨è§£çš„æ„é€ å‡½æ•°</span><span class="token class-name">Constructor</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> ctors <span class="token operator">=</span> <span class="token function">determineConstructorsFromBeanPostProcessors</span><span class="token punctuation">(</span>beanClass<span class="token punctuation">,</span> beanName<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//ç¬¬ä¸€æ¬¡æ¨æ–­æ„é€ å‡½æ•°</span><span class="token keyword">if</span> <span class="token punctuation">(</span>ctors <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">||</span> mbd<span class="token punctuation">.</span><span class="token function">getResolvedAutowireMode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token constant">AUTOWIRE_CONSTRUCTOR</span> <span class="token operator">||</span>mbd<span class="token punctuation">.</span><span class="token function">hasConstructorArgumentValues</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token operator">!</span><span class="token class-name">ObjectUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">//å¦‚æœctorsä¸ä¸ºç©ºï¼Œå°±è¯´æ˜æ„é€ å‡½æ•°ä¸Šæœ‰@Autowiredæ³¨è§£</span><span class="token comment">//ç¬¬äºŒæ¬¡æ¨æ–­æ„é€ å‡½æ•°</span><span class="token keyword">return</span> <span class="token function">autowireConstructor</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> mbd<span class="token punctuation">,</span> ctors<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">// Preferred constructors for default construction?</span><span class="token comment">//å¦‚æœé¦–é€‰çš„æ„é€ å™¨ä¸ä¸ºç©ºï¼Œ åˆ™ä½¿ç”¨é¦–é€‰çš„æ„é€ å™¨è¿›è¡Œå®ä¾‹åŒ–ï¼Œä»¥åŠè¿›è¡Œä»¥æ¥æ³¨å…¥</span>ctors <span class="token operator">=</span> mbd<span class="token punctuation">.</span><span class="token function">getPreferredConstructors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>ctors <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">return</span> <span class="token function">autowireConstructor</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> mbd<span class="token punctuation">,</span> ctors<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">//æ— å‚æ„é€ å‡½æ•°çš„å®ä¾‹åŒ–,å¤§éƒ¨åˆ†çš„å®ä¾‹æ˜¯é‡‡ç”¨çš„æ— å‚æ„é€ å‡½æ•°çš„æ–¹å¼å®ä¾‹åŒ–</span><span class="token comment">// No special handling: simply use no-arg constructor.</span><span class="token keyword">return</span> <span class="token function">instantiateBean</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> mbd<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å°±æ˜¯å¹²ä¸€ä»¶äº‹ï¼Œç”¨å“ªç§æ„é€ å‡½æ•°æ¥åˆ›å»ºå®ä¾‹</p><ul><li>å¦‚æœbeané…ç½®äº†factory-methodï¼Œåˆ™åå°„å®ä¾‹åŒ–ä¸€ä¸ªå¯¹è±¡</li><li>å¦‚æœæ²¡æœ‰é…ç½®factory-methodï¼Œå¹¶ä¸”æ›¾ç»åˆ›å»ºè¿‡ï¼Œé‚£å°±æŒ‰ç…§åŸæ¥çš„æ–¹å¼å†åˆ›å»º</li><li>ä¸Šè¿°ä¸¤ç§æƒ…å†µéƒ½ä¸æ˜¯ï¼Œåˆ™å…ˆå»å½“å‰æ­£åœ¨å®ä¾‹åŒ–çš„beanä¸­æŸ¥å‡ºæœ‰@Autowiredæ³¨è§£çš„æ„é€ å‡½æ•°ï¼Œè€Œè¿™ä¸ªåŠ¨ä½œæ˜¯äº¤ç»™AutowiredAnnotationBeanPostProcessorä¸­çš„determineCandidateConstructorsæ–¹æ³•æ¥å®Œæˆçš„</li><li>å¦‚æœä¸Šè¿°æ‰«æå‡ºæ¥çš„æœ‰@Autowiredæ³¨è§£çš„æ„é€ å‡½æ•°ä¸ä¸ºç©ºï¼Œåˆ™é€‰æ‹©autowireConstructoræ¥è¿›è¡Œ</li><li>å¦‚æœé¦–é€‰çš„æ„é€ å™¨ä¸ä¸ºç©ºï¼Œ åˆ™ä½¿ç”¨é¦–é€‰çš„æ„é€ å™¨è¿›è¡Œå®ä¾‹åŒ–ï¼Œä»¥åŠè¿›è¡Œä¾èµ–æ³¨å…¥</li><li>å¦åˆ™ï¼Œæ— å‚æ„é€ å‡½æ•°å®ä¾‹åŒ–</li></ul><p>ç‚¹è¿›å»çœ‹çœ‹determineConstructorsFromBeanPostProcessors()</p><h4 id="6-1-1-æ„é€ å‡½æ•°çš„é€‰å–ä¹‹determineConstructorsFromBeanPostProcessors"><a href="#6-1-1-æ„é€ å‡½æ•°çš„é€‰å–ä¹‹determineConstructorsFromBeanPostProcessors" class="headerlink" title="6.1.1.æ„é€ å‡½æ•°çš„é€‰å–ä¹‹determineConstructorsFromBeanPostProcessors()"></a>6.1.1.æ„é€ å‡½æ•°çš„é€‰å–ä¹‹determineConstructorsFromBeanPostProcessors()</h4><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">protected</span> <span class="token class-name">Constructor</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">determineConstructorsFromBeanPostProcessors</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Nullable</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span> beanClass<span class="token punctuation">,</span> <span class="token class-name">String</span> beanName<span class="token punctuation">)</span><span class="token keyword">throws</span> <span class="token class-name">BeansException</span> <span class="token punctuation">&#123;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>beanClass <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token function">hasInstantiationAwareBeanPostProcessors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">// æ‹¿åˆ° BeanPostProcessor çš„æ‰€æœ‰æ¥å£ï¼Œéå†</span><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">BeanPostProcessor</span> bp <span class="token operator">:</span> <span class="token function">getBeanPostProcessors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>bp <span class="token keyword">instanceof</span> <span class="token class-name">SmartInstantiationAwareBeanPostProcessor</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token class-name">SmartInstantiationAwareBeanPostProcessor</span> ibp <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">SmartInstantiationAwareBeanPostProcessor</span><span class="token punctuation">)</span> bp<span class="token punctuation">;</span><span class="token comment">// è·å–åˆ°æœ‰@Autowiredæ³¨è§£ä¿¡æ¯çš„æ„é€ å‡½æ•°</span><span class="token class-name">Constructor</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> ctors <span class="token operator">=</span> ibp<span class="token punctuation">.</span><span class="token function">determineCandidateConstructors</span><span class="token punctuation">(</span>beanClass<span class="token punctuation">,</span> beanName<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>ctors <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">return</span> ctors<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å…¶ä¸­ï¼Œ</p><ul><li>getBeanPostProcessors()æ–¹æ³•ï¼Œè·å–æ‰€æœ‰BeanPostProcessoræ¥å£ï¼Œæ˜¯AbstractBeanFactoryç±»ä¸­çš„ä¸€ä¸ªList&lt;BeanPostProcessor&gt; beanPostProcessors &#x3D; new CopyOnWriteArrayList&lt;&gt;()å®¹å™¨ï¼Œè£…è½½äº†ä¸Šä¸‹æ–‡ä¸­æ‰€æœ‰çš„BeanPostProcessorç±»çš„å®ä¾‹ã€‚</li><li>SmartInstantiationAwareBeanPostProcessorç±»ä¸­çš„determineCandidateConstructorsæ–¹æ³•ï¼Œä¼šè°ƒç”¨å…¶å­ç±» AutowiredAnnotationBeanPostProcessor ä¸­çš„determineCandidateConstructorsæ–¹æ³•ï¼Œæ¥è·å–åˆ°æœ‰@Autowiredæ³¨è§£ä¿¡æ¯çš„æ„é€ å‡½æ•°ã€‚AutowiredAnnotationBeanPostProcessorç±»ä¼šå®Œæˆ@Autowiredå’Œ@valueä¸¤ä¸ªæ³¨è§£çš„æ‰«æã€‚</li><li>AutowiredAnnotationBeanPostProcessor ä¸­çš„determineCandidateConstructorsæ–¹æ³•è¿”å›æ„é€ æ–¹æ³•æ•°ç»„ï¼Œä»¥ä¸‹ä¸¤ç§æƒ…å†µè¿”å›å€¼ä¸ä¸ºnull:<ul><li>æœ‰ä¸”ä»…æœ‰ä¸€ä¸ªå¸¦å‚æ„é€ æ–¹æ³•ï¼Œè¿”å›é‚£ä¸ªæ„é€ æ–¹æ³•</li><li>æœ‰å¤šä¸ª@Autowired(required &#x3D; false)æ³¨è§£çš„æ„é€ æ–¹æ³•ï¼Œè¿”å›è¿™äº›æ„é€ æ–¹æ³•</li></ul></li></ul><p>å»çœ‹çœ‹AutowiredAnnotationBeanPostProcessor ä¸­çš„determineCandidateConstructorsæ–¹æ³•</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token class-name">Constructor</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">determineCandidateConstructors</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span> beanClass<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">String</span> beanName<span class="token punctuation">)</span><span class="token keyword">throws</span> <span class="token class-name">BeanCreationException</span> <span class="token punctuation">&#123;</span><span class="token comment">// åœ¨å®ä¾‹åŒ–æŸä¸ªå¯¹è±¡çš„è¿‡ç¨‹ä¸­ä¼šè°ƒç”¨è¿™ä¸ªæ–¹æ³•ï¼Œå¾—åˆ°å€™é€‰æ„é€ æ–¹æ³•</span><span class="token comment">// Let's check for lookup methods here...</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>lookupMethodsChecked<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">AnnotationUtils</span><span class="token punctuation">.</span><span class="token function">isCandidateClass</span><span class="token punctuation">(</span>beanClass<span class="token punctuation">,</span> <span class="token class-name">Lookup</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">try</span> <span class="token punctuation">&#123;</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span> targetClass <span class="token operator">=</span> beanClass<span class="token punctuation">;</span><span class="token keyword">do</span> <span class="token punctuation">&#123;</span><span class="token comment">// éå†å½“å‰beanClassä¸­æ‰€æœ‰åŠ äº†Lookupæ³¨è§£çš„æ–¹æ³•ï¼Œå¹¶ä¸”æŠŠè¿™äº›æ–¹æ³•çš„ä¿¡æ¯å°è£…ä¸ºLookupOverrideå¯¹è±¡åŠ è½½mbdä¸­</span><span class="token class-name">ReflectionUtils</span><span class="token punctuation">.</span><span class="token function">doWithLocalMethods</span><span class="token punctuation">(</span>targetClass<span class="token punctuation">,</span> method <span class="token operator">-></span> <span class="token punctuation">&#123;</span><span class="token comment">//å¯¹æ³¨è§£Lookupçš„æ”¯æŒ</span><span class="token class-name">Lookup</span> lookup <span class="token operator">=</span> method<span class="token punctuation">.</span><span class="token function">getAnnotation</span><span class="token punctuation">(</span><span class="token class-name">Lookup</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>lookup <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">state</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>beanFactory <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token string">"No BeanFactory available"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">LookupOverride</span> override <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LookupOverride</span><span class="token punctuation">(</span>method<span class="token punctuation">,</span> lookup<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">try</span> <span class="token punctuation">&#123;</span><span class="token class-name">RootBeanDefinition</span> mbd <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">RootBeanDefinition</span><span class="token punctuation">)</span><span class="token keyword">this</span><span class="token punctuation">.</span>beanFactory<span class="token punctuation">.</span><span class="token function">getMergedBeanDefinition</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>mbd<span class="token punctuation">.</span><span class="token function">getMethodOverrides</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addOverride</span><span class="token punctuation">(</span>override<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">NoSuchBeanDefinitionException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BeanCreationException</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span><span class="token string">"Cannot apply @Lookup to beans without corresponding bean definition"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>targetClass <span class="token operator">=</span> targetClass<span class="token punctuation">.</span><span class="token function">getSuperclass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">while</span> <span class="token punctuation">(</span>targetClass <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> targetClass <span class="token operator">!=</span> <span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IllegalStateException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BeanCreationException</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> <span class="token string">"Lookup method resolution failed"</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token comment">// lookupMethodsCheckedæ˜¯ä¸€ä¸ªsetï¼Œç”¨æ¥è®°å½•å“ªäº›beançš„@lookupæ³¨è§£è¢«è§£æäº†ï¼Œä¸‹ä¸€æ¬¡å°±ä¸ç”¨è§£æäº†</span><span class="token keyword">this</span><span class="token punctuation">.</span>lookupMethodsChecked<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">// å…ˆæ£€æŸ¥candidateConstructorsCacheä¸­æ˜¯å¦ç¼“å­˜äº†å½“å‰beanä¸­å¯ç”¨çš„æ„é€ æ–¹æ³•</span><span class="token comment">// Quick check on the concurrent map first, with minimal locking.</span><span class="token class-name">Constructor</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> candidateConstructors <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>candidateConstructorsCache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>beanClass<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>candidateConstructors <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">// Fully synchronized resolution now...</span><span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>candidateConstructorsCache<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>candidateConstructors <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>candidateConstructorsCache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>beanClass<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// å¦‚æœæ²¡æœ‰ç­›é€‰è¿‡æ„é€ æ–¹æ³•ï¼Œå°±å¼€å§‹ç­›é€‰</span><span class="token keyword">if</span> <span class="token punctuation">(</span>candidateConstructors <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token class-name">Constructor</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> rawCandidates<span class="token punctuation">;</span><span class="token keyword">try</span> <span class="token punctuation">&#123;</span><span class="token comment">// æ‹¿åˆ°å½“å‰ç±»æ‰€æœ‰çš„æ„é€ æ–¹æ³•ï¼Œå¦‚æœæ²¡æœ‰å†™ä»»ä½•æ„é€ æ–¹æ³•ï¼Œè¿™é‡Œä¼šè¿”å›ä¸€ä¸ªæ— å‚çš„æ„é€ æ–¹æ³•</span>rawCandidates <span class="token operator">=</span> beanClass<span class="token punctuation">.</span><span class="token function">getDeclaredConstructors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> ex<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BeanCreationException</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span><span class="token string">"Resolution of declared constructors on bean Class ["</span> <span class="token operator">+</span> beanClass<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span><span class="token string">"] from ClassLoader ["</span> <span class="token operator">+</span> beanClass<span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"] failed"</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">// candidates å°±æ˜¯ç”¨æ¥å­˜å‚¨æ‰€æœ‰è¢«ç­›é€‰å‡ºæ¥çš„æ„é€ æ–¹æ³•,å…¶å®å¯ä»¥è®¤ä¸º, å°±æ˜¯æŠŠæ‰€æœ‰@Autowiredæ³¨è§£æ ‡æ³¨çš„æ–¹æ³•æ”¾åˆ°é‡Œé¢,</span><span class="token comment">// ä½†æ˜¯è¿˜å¤šæ”¾äº†ä¸€ä¸ªé»˜è®¤æ„é€ æ–¹æ³•</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Constructor</span><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span><span class="token punctuation">></span></span> candidates <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span>rawCandidates<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// requiredConstructorè¡¨ç¤º@Autowiredæ ‡æ³¨å¹¶ä¸”requiredä¸ºtrueçš„æ„é€ æ–¹æ³•, å› ä¸ºåªå…è®¸å‡ºç°ä¸€ä¸ªè¿™æ ·çš„æ„é€ æ–¹æ³•,</span><span class="token comment">//æ‰€ä»¥å½“è¿™ä¸ªå˜é‡å­˜åœ¨å€¼å, åˆå‡ºç°äº†ä¸€ä¸ªç›¸åŒæƒ…å†µçš„æ„é€ æ–¹æ³•çš„è¯, Springå°±ä¼šæŠ›å‡ºä¸€ä¸ªé”™è¯¯</span><span class="token class-name">Constructor</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span> requiredConstructor <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span><span class="token comment">// defaultConstructorç”¨æ¥ä¿å­˜é»˜è®¤æ„é€ æ–¹æ³•</span><span class="token class-name">Constructor</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span> defaultConstructor <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span><span class="token comment">// å¦‚æœæ˜¯kotlinçš„ç±»æ‰èµ·æ•ˆï¼Œå¦‚æœæ˜¯javaä¸­çš„ç±»åˆ™ç›´æ¥è¿”å›null</span><span class="token class-name">Constructor</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span> primaryConstructor <span class="token operator">=</span> <span class="token class-name">BeanUtils</span><span class="token punctuation">.</span><span class="token function">findPrimaryConstructor</span><span class="token punctuation">(</span>beanClass<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">int</span> nonSyntheticConstructors <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">// éå†æ‰€æœ‰çš„æ„é€ æ–¹æ³•</span><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Constructor</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span> candidate <span class="token operator">:</span> rawCandidates<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>candidate<span class="token punctuation">.</span><span class="token function">isSynthetic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>nonSyntheticConstructors<span class="token operator">++</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>primaryConstructor <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">continue</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">// æŸ¥çœ‹è¯¥æ„é€ æ–¹æ³•ä¸Šæ˜¯å¦å­˜åœ¨@Autowiredæ³¨è§£ï¼Œæˆ–è€…çœ‹ä»£ç†ç±»çš„çˆ¶ç±»ä¸­å¯¹åº”çš„æ„é€ æ–¹æ³•ä¸Šæ˜¯å¦å­˜åœ¨@Autowiredæ³¨è§£</span><span class="token comment">//è·å–åˆ°æ„é€ å‡½æ•°ä¸Šçš„@Autowiredæ³¨è§£ä¿¡æ¯,è¿™ä¸ªæ–¹æ³•å¯ä»¥ä¸çœ‹</span><span class="token class-name">MergedAnnotation</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span> ann <span class="token operator">=</span> <span class="token function">findAutowiredAnnotation</span><span class="token punctuation">(</span>candidate<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>ann <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">// å¦‚æœå½“å‰ç±»æ˜¯cglibç”Ÿæˆçš„ä»£ç†ç±»ï¼Œåˆ™è·å–å…¶çˆ¶ç±»</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span> userClass <span class="token operator">=</span> <span class="token class-name">ClassUtils</span><span class="token punctuation">.</span><span class="token function">getUserClass</span><span class="token punctuation">(</span>beanClass<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>userClass <span class="token operator">!=</span> beanClass<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">try</span> <span class="token punctuation">&#123;</span><span class="token class-name">Constructor</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span> superCtor <span class="token operator">=</span>userClass<span class="token punctuation">.</span><span class="token function">getDeclaredConstructor</span><span class="token punctuation">(</span>candidate<span class="token punctuation">.</span><span class="token function">getParameterTypes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>ann <span class="token operator">=</span> <span class="token function">findAutowiredAnnotation</span><span class="token punctuation">(</span>superCtor<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">NoSuchMethodException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">// Simply proceed, no equivalent superclass constructor found...</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token comment">// å¦‚æœæ„é€ æ–¹æ³•ä¸Šå­˜åœ¨@Autowiredæ³¨è§£</span><span class="token keyword">if</span> <span class="token punctuation">(</span>ann <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">// requiredConstructorè¡¨ç¤ºç¨‹åºå‘˜æ‰‹åŠ¨æŒ‡æ˜çš„è¦ä½¿ç”¨çš„å“ªä¸ªæ„é€ æ–¹æ³•</span><span class="token comment">// æ‰€ä»¥å¦‚æœæœ‰å¤šä¸ªæ„é€ æ–¹æ³•ä¸Šéƒ½å†™äº†@Autowiredæ³¨è§£å°±ä¼šæŠ¥é”™ï¼Œrequiredä½trueçš„æƒ…å†µä¸‹</span><span class="token comment">// å› ä¸ºä½œä¸ºç¨‹åºå‘˜ä½ å¦‚æœå‘Šè¯‰Springå¤šä¸ªæ„é€ æ–¹æ³•ï¼Œé‚£Springä¹Ÿå°±ä¸çŸ¥é“åˆ°åº•è¦ä½¿ç”¨å“ªä¸€ä¸ªäº†</span><span class="token keyword">if</span> <span class="token punctuation">(</span>requiredConstructor <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BeanCreationException</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span><span class="token string">"Invalid autowire-marked constructor: "</span> <span class="token operator">+</span> candidate <span class="token operator">+</span><span class="token string">". Found constructor with 'required' Autowired annotation already: "</span> <span class="token operator">+</span>requiredConstructor<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">//è·å–åˆ°@Autowiredé‡Œé¢çš„requiredçš„å€¼ï¼Œé»˜è®¤ true</span><span class="token keyword">boolean</span> required <span class="token operator">=</span> <span class="token function">determineRequiredStatus</span><span class="token punctuation">(</span>ann<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>required<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>candidates<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BeanCreationException</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span><span class="token string">"Invalid autowire-marked constructors: "</span> <span class="token operator">+</span> candidates <span class="token operator">+</span><span class="token string">". Found constructor with 'required' Autowired annotation: "</span> <span class="token operator">+</span>candidate<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span>requiredConstructor <span class="token operator">=</span> candidate<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">// candidatesä¸­å­˜çš„æ˜¯åŠ äº†@Autowiredæ³¨è§£çš„æ„é€ æ–¹æ³•</span>candidates<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>candidate<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">// å¦‚æœå½“å‰æ„é€ æ–¹æ³•ä¸Šä¸å­˜åœ¨@Autowiredï¼Œå¹¶ä¸”æ˜¯æ— å‚æ„é€ æ–¹æ³•ï¼Œåˆ™è®°å½•ä¸€ä¸‹è¯¥æ— å‚æ„é€ æ–¹æ³•</span><span class="token comment">// æ‰€ä»¥æˆ‘ä»¬å¯ä»¥åœ¨éå†æ„é€ æ–¹æ³•æ—¶ï¼Œåªå…³å¿ƒæ— å‚æ„é€ æ–¹æ³•å’ŒåŠ äº†@Autowiredæ³¨è§£çš„æ„é€ æ–¹æ³•</span><span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>candidate<span class="token punctuation">.</span><span class="token function">getParameterCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>defaultConstructor <span class="token operator">=</span> candidate<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token comment">// å¦‚æœå­˜åœ¨æ·»åŠ äº†@Autowiredçš„æ„é€ æ–¹æ³•</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>candidates<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">// Add default constructor to list of optional constructors, as fallback.</span><span class="token comment">// åˆ†ä¸ºä¸¤ç§è¯·æ±‚ï¼Œè¦ä¹ˆcandidatesä¸­åŒ…å«ä¸€ä¸ªrequiredç­‰äºtrueçš„æ„é€ æ–¹æ³•</span><span class="token comment">// è¦ä¹ˆcandidatesä¸­åŒ…å«ä¸€ä¸ªæˆ–å¤šä¸ªrequiredç­‰äºfalseçš„æ„é€ æ–¹æ³•</span><span class="token comment">// å¦‚æœæ²¡æœ‰æŒ‡å®šrequiredä¸ºtrueçš„æ„é€ æ–¹æ³•ï¼Œé‚£ä¹ˆå°±æŠŠæ„é€ æ–¹æ³•æ·»åŠ åˆ°candidatesä¸­å»ï¼Œåç»­ä¸€èµ·è¿›è¡Œæ¨æ–­</span><span class="token keyword">if</span> <span class="token punctuation">(</span>requiredConstructor <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>defaultConstructor <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">// æŠŠæ— å‚çš„æ„é€ æ–¹æ³•ä¹Ÿæ·»åŠ è¿›å»</span>candidates<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>defaultConstructor<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">// å¦‚æœæ²¡æœ‰æŒ‡å®šrequiredä¸ºtrueçš„æ„é€ æ–¹æ³•ï¼Œå¹¶ä¸”ä¹Ÿæ²¡æœ‰æ— å‚çš„æ„é€ æ–¹æ³•ï¼Œå¹¶ä¸”åªæœ‰ä¸€ä¸ªæ„é€ æ–¹æ³•</span><span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>candidates<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span> <span class="token operator">&amp;&amp;</span> logger<span class="token punctuation">.</span><span class="token function">isInfoEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">// ç»™ä¸€ä¸ªæç¤ºï¼Œæ²¡æœ‰æ— å‚çš„æ„é€ æ–¹æ³•ï¼Œç„¶ååˆåªæœ‰ä¸€ä¸ª@Autowired(required=false)çš„æ„é€ æ–¹æ³•</span><span class="token comment">// æ‰€ä»¥å…¶å®ä¸€å®šä¼šç”¨è¿™ä¸ªæ„é€ æ–¹æ³•ï¼Œæ‰€ä»¥æ‰“å°ä¸€ä¸ªæ—¥å¿—ï¼Œå‘Šè¯‰ç¨‹åºå‘˜ï¼Œä½ å…¶å®å¯ä»¥æŠŠrequiredæ”¹ä¸ºtrue</span>logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"Inconsistent constructor declaration on bean with name '"</span> <span class="token operator">+</span> beanName <span class="token operator">+</span><span class="token string">"': single autowire-marked constructor flagged as optional - "</span> <span class="token operator">+</span><span class="token string">"this constructor is effectively required since there is no "</span> <span class="token operator">+</span><span class="token string">"default constructor to fall back to: "</span> <span class="token operator">+</span> candidates<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token comment">// candidateConstructorså°±æ˜¯å½“å‰æ–¹æ³•çš„è¿”å›å€¼</span><span class="token comment">// æŠŠcandidatesæ–¹æ³•ï¼Œä¸¤ç§æƒ…å†µï¼Œè¦ä¹ˆåªæœ‰ä¸€ä¸ª@Autowired(required=true)çš„æ„é€ æ–¹æ³•ï¼Œè¦ä¹ˆå¤šä¸ª@Autowired(required=false)+ä¸€ä¸ªæ— å‚æ„é€ æ–¹æ³•</span>candidateConstructors <span class="token operator">=</span> candidates<span class="token punctuation">.</span><span class="token function">toArray</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Constructor</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">// æ²¡æœ‰åŠ äº†@Autowiredæ³¨è§£çš„æ„é€ æ–¹æ³•ï¼Œé‚£ä¹ˆåˆ™åˆ¤æ–­æ˜¯ä¸æ˜¯åªæœ‰ä¸€ä¸ªæœ‰å‚çš„æ„é€ æ–¹æ³•ï¼Œå¦‚æœæ˜¯åˆ™è¿”å›</span><span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>rawCandidates<span class="token punctuation">.</span>length <span class="token operator">==</span> <span class="token number">1</span> <span class="token operator">&amp;&amp;</span> rawCandidates<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">getParameterCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>candidateConstructors <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Constructor</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">&#123;</span>rawCandidates<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">// primaryConstructor != null ä¸ç®¡</span><span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>nonSyntheticConstructors <span class="token operator">==</span> <span class="token number">2</span> <span class="token operator">&amp;&amp;</span> primaryConstructor <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span>defaultConstructor <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>primaryConstructor<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>defaultConstructor<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>candidateConstructors <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Constructor</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">&#123;</span>primaryConstructor<span class="token punctuation">,</span> defaultConstructor<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>nonSyntheticConstructors <span class="token operator">==</span> <span class="token number">1</span> <span class="token operator">&amp;&amp;</span> primaryConstructor <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>candidateConstructors <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Constructor</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">&#123;</span>primaryConstructor<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">// å¦‚æœæ²¡æœ‰æ„é€ æ–¹æ³•ä¸Šæ·»åŠ äº†@Autowiredæ³¨è§£ï¼Œå¹¶ä¸”æœ‰å¤šä¸ªæ„é€ æ–¹æ³•ï¼Œå¹¶ä¸”æ²¡æœ‰primaryConstructor</span><span class="token keyword">else</span> <span class="token punctuation">&#123;</span><span class="token comment">// è¿”å›ä¸€ä¸ªç©ºçš„Constructoræ•°ç»„ï¼Œè¡¨ç¤ºæ²¡æœ‰æ¨æ–­å‡ºæ¥æ„é€ æ–¹æ³•</span>candidateConstructors <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Constructor</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">this</span><span class="token punctuation">.</span>candidateConstructorsCache<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>beanClass<span class="token punctuation">,</span> candidateConstructors<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token comment">// è¦ä¹ˆè¿”å›ä¸€ä¸ªrequired=trueçš„æ„é€ æ–¹æ³•</span><span class="token comment">// è¦ä¹ˆè¿”å›å¤šä¸ªrequired=false+æ— å‚çš„æ„é€ æ–¹æ³•</span><span class="token comment">// è¦ä¹ˆè¿”å›å”¯ä¸€çš„ä¸€ä¸ªæœ‰å‚çš„æ„é€ æ–¹æ³•</span><span class="token comment">// å¦‚æœåªæœ‰ä¸€ä¸ªæ— å‚çš„æ„é€ æ–¹æ³•ï¼Œè¿™é‡Œä¼šè¿”å›nullï¼Œå¤–å±‚é€»è¾‘ä¼šé»˜è®¤ä½¿ç”¨æ— å‚æ„é€ æ–¹æ³•è¿›è¡Œå®ä¾‹åŒ–</span><span class="token keyword">return</span> <span class="token punctuation">(</span>candidateConstructors<span class="token punctuation">.</span>length <span class="token operator">></span> <span class="token number">0</span> <span class="token operator">?</span> candidateConstructors <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è¿™ä¸ªæ–¹æ³•æ‰§è¡Œå®Œæ¯•åï¼Œæˆ‘ä»¬å°±å¯ä»¥è¿›è¡Œç¬¬ä¸€æ¬¡æ¨æ–­æ„é€ å‡½æ•°äº†ï¼Œå›åˆ°6.1.createBeanInstance()ä¸­çš„determineConstructorsFromBeanPostProcessorsã€‚æˆ‘ä»¬å†çœ‹çœ‹ç¬¬äºŒæ¬¡æ¨æ–­æ„é€ å‡½æ•°çš„è¿‡ç¨‹</p><h4 id="6-1-2-æ„é€ å‡½æ•°çš„é€‰å–ä¹‹autowireConstructor"><a href="#6-1-2-æ„é€ å‡½æ•°çš„é€‰å–ä¹‹autowireConstructor" class="headerlink" title="6.1.2.æ„é€ å‡½æ•°çš„é€‰å–ä¹‹autowireConstructor()"></a>6.1.2.æ„é€ å‡½æ•°çš„é€‰å–ä¹‹autowireConstructor()</h4><p>è°ƒç”¨çš„ä¸ºConstructorResolverçš„autowireConstructor()</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">protected</span> <span class="token class-name">BeanWrapper</span> <span class="token function">autowireConstructor</span><span class="token punctuation">(</span><span class="token class-name">String</span> beanName<span class="token punctuation">,</span> <span class="token class-name">RootBeanDefinition</span> mbd<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">Constructor</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> ctors<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> explicitArgs<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ConstructorResolver</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">autowireConstructor</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> mbd<span class="token punctuation">,</span> ctors<span class="token punctuation">,</span> explicitArgs<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>ç‚¹è¿›å»autowireConstructorï¼Œå‚è€ƒè¿™ä½å¤§ç¥ç”»çš„æµç¨‹<a href="https://blog.csdn.net/qq_39404258/article/details/109769278">springæºç è§£æï¼ˆå››ï¼‰ æ¨æ–­æ„é€ æ–¹æ³•</a></p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token class-name">BeanWrapper</span> <span class="token function">autowireConstructor</span><span class="token punctuation">(</span><span class="token class-name">String</span> beanName<span class="token punctuation">,</span> <span class="token class-name">RootBeanDefinition</span> mbd<span class="token punctuation">,</span><span class="token annotation punctuation">@Nullable</span> <span class="token class-name">Constructor</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> chosenCtors<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> explicitArgs<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token class-name">BeanWrapperImpl</span> bw <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BeanWrapperImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">this</span><span class="token punctuation">.</span>beanFactory<span class="token punctuation">.</span><span class="token function">initBeanWrapper</span><span class="token punctuation">(</span>bw<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">Constructor</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span> constructorToUse <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span><span class="token class-name">ArgumentsHolder</span> argsHolderToUse <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span><span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> argsToUse <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span><span class="token comment">// æ˜¯å¦é€šè¿‡getBean()æ–¹æ³•æŒ‡å®šäº†æ„é€ æ–¹æ³•å‚æ•°å€¼</span><span class="token keyword">if</span> <span class="token punctuation">(</span>explicitArgs <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>argsToUse <span class="token operator">=</span> explicitArgs<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">else</span> <span class="token punctuation">&#123;</span><span class="token comment">// ä»ç¼“å­˜ä¸­è·å–æ„é€ æ–¹æ³•å’Œæ„é€ æ–¹æ³•å‚æ•°å€¼</span><span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> argsToResolve <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span><span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mbd<span class="token punctuation">.</span>constructorArgumentLock<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>constructorToUse <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Constructor</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span><span class="token punctuation">)</span> mbd<span class="token punctuation">.</span>resolvedConstructorOrFactoryMethod<span class="token punctuation">;</span><span class="token comment">// æ‰¾åˆ°äº†mbdä¸­ç¼“å­˜çš„æ„é€ æ–¹æ³•</span><span class="token keyword">if</span> <span class="token punctuation">(</span>constructorToUse <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> mbd<span class="token punctuation">.</span>constructorArgumentsResolved<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">// Found a cached constructor...</span>argsToUse <span class="token operator">=</span> mbd<span class="token punctuation">.</span>resolvedConstructorArguments<span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>argsToUse <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>argsToResolve <span class="token operator">=</span> mbd<span class="token punctuation">.</span>preparedConstructorArguments<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token comment">// å¦‚æœå­˜åœ¨æ„é€ æ–¹æ³•å‚æ•°å€¼ï¼Œé‚£ä¹ˆåˆ™å¯¹å‚æ•°å€¼è¿›è¡Œç±»å‹è½¬åŒ–</span><span class="token keyword">if</span> <span class="token punctuation">(</span>argsToResolve <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>argsToUse <span class="token operator">=</span> <span class="token function">resolvePreparedArguments</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> mbd<span class="token punctuation">,</span> bw<span class="token punctuation">,</span> constructorToUse<span class="token punctuation">,</span> argsToResolve<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token comment">// å¦‚æœå¾…ä½¿ç”¨çš„æ„é€ æ–¹æ³•ä¸ºnullï¼Œæˆ–å¾…ä½¿ç”¨çš„æ„é€ æ–¹æ³•å‚æ•°ä¸ºnull</span><span class="token keyword">if</span> <span class="token punctuation">(</span>constructorToUse <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> argsToUse <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">// Take specified constructors, if any.</span><span class="token comment">// chosenCtorsè¡¨ç¤ºæ‰€æŒ‡å®šçš„æ„é€ æ–¹æ³•ï¼Œæ²¡æœ‰æŒ‡å®šåˆ™è·å–beanClassä¸­çš„æ‰€æœ‰çš„æ„é€ æ–¹æ³•ä½œä¸ºå€™é€‰è€…ï¼Œä»è¿™äº›æ„é€ æ–¹æ³•ä¸­é€‰æ‹©ä¸€ä¸ªæ„é€ æ–¹æ³•</span><span class="token class-name">Constructor</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> candidates <span class="token operator">=</span> chosenCtors<span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>candidates <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span> beanClass <span class="token operator">=</span> mbd<span class="token punctuation">.</span><span class="token function">getBeanClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">try</span> <span class="token punctuation">&#123;</span>candidates <span class="token operator">=</span> <span class="token punctuation">(</span>mbd<span class="token punctuation">.</span><span class="token function">isNonPublicAccessAllowed</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">?</span>beanClass<span class="token punctuation">.</span><span class="token function">getDeclaredConstructors</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> beanClass<span class="token punctuation">.</span><span class="token function">getConstructors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> ex<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BeanCreationException</span><span class="token punctuation">(</span>mbd<span class="token punctuation">.</span><span class="token function">getResourceDescription</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> beanName<span class="token punctuation">,</span><span class="token string">"Resolution of declared constructors on bean Class ["</span> <span class="token operator">+</span> beanClass<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span><span class="token string">"] from ClassLoader ["</span> <span class="token operator">+</span> beanClass<span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"] failed"</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token comment">// æœ‰äº†æ„é€ æ–¹æ³•ä¹‹åï¼Œåˆ™è¿›è¡Œè‡ªåŠ¨æ¨æ–­</span><span class="token comment">// å¦‚æœåªæœ‰ä¸€ä¸ªæ„é€ æ–¹æ³•ï¼Œå¹¶ä¸”æ²¡æœ‰æŒ‡å®šæ„é€ æ–¹æ³•å‚æ•°å€¼ï¼Œåˆ™éœ€è¦åˆ¤æ–­æ˜¯ä¸æ˜¯æ— å‚æ„é€ æ–¹æ³•ï¼Œå¦‚æœæ˜¯åˆ™å¯ä»¥ä½¿ç”¨æ— å‚æ„é€ æ–¹æ³•è¿›è¡Œå®ä¾‹åŒ–</span><span class="token keyword">if</span> <span class="token punctuation">(</span>candidates<span class="token punctuation">.</span>length <span class="token operator">==</span> <span class="token number">1</span> <span class="token operator">&amp;&amp;</span> explicitArgs <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>mbd<span class="token punctuation">.</span><span class="token function">hasConstructorArgumentValues</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token class-name">Constructor</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span> uniqueCandidate <span class="token operator">=</span> candidates<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>uniqueCandidate<span class="token punctuation">.</span><span class="token function">getParameterCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mbd<span class="token punctuation">.</span>constructorArgumentLock<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">// ç¡®å®šäº†æ„é€ æ–¹æ³•ä¹‹åè¿›è¡Œç¼“å­˜</span>mbd<span class="token punctuation">.</span>resolvedConstructorOrFactoryMethod <span class="token operator">=</span> uniqueCandidate<span class="token punctuation">;</span>mbd<span class="token punctuation">.</span>constructorArgumentsResolved <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>mbd<span class="token punctuation">.</span>resolvedConstructorArguments <span class="token operator">=</span> <span class="token constant">EMPTY_ARGS</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span>bw<span class="token punctuation">.</span><span class="token function">setBeanInstance</span><span class="token punctuation">(</span><span class="token function">instantiate</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> mbd<span class="token punctuation">,</span> uniqueCandidate<span class="token punctuation">,</span> <span class="token constant">EMPTY_ARGS</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">return</span> bw<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token comment">// å¦‚æœæŒ‡å®šäº†å¤šä¸ªæ„é€ æ–¹æ³•ï¼Œæˆ–è€…autowireModeæ˜¯æ„é€ æ–¹æ³•è‡ªåŠ¨æ³¨å…¥ï¼Œåˆ™è¦è‡ªåŠ¨é€‰æ‹©æ„é€ æ–¹æ³•</span><span class="token comment">// Need to resolve the constructor.</span><span class="token keyword">boolean</span> autowiring <span class="token operator">=</span> <span class="token punctuation">(</span>chosenCtors <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">||</span>mbd<span class="token punctuation">.</span><span class="token function">getResolvedAutowireMode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">AutowireCapableBeanFactory</span><span class="token punctuation">.</span><span class="token constant">AUTOWIRE_CONSTRUCTOR</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">ConstructorArgumentValues</span> resolvedValues <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span><span class="token comment">// è¡¨ç¤ºæ‰€æœ‰æ„é€ æ–¹æ³•ä¸­ï¼Œå‚æ•°ä¸ªæ•°æœ€å°‘çš„æ„é€ æ–¹æ³•çš„å‚æ•°ä¸ªæ•°æ˜¯å¤šå°‘</span><span class="token keyword">int</span> minNrOfArgs<span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>explicitArgs <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>minNrOfArgs <span class="token operator">=</span> explicitArgs<span class="token punctuation">.</span>length<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">else</span> <span class="token punctuation">&#123;</span><span class="token comment">// ä»BeanDefinitionä¸­è·å–æ‰€è®¾ç½®çš„æ„é€ æ–¹æ³•å‚æ•°å€¼</span><span class="token class-name">ConstructorArgumentValues</span> cargs <span class="token operator">=</span> mbd<span class="token punctuation">.</span><span class="token function">getConstructorArgumentValues</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// è®°å½•è§£æåçš„æ„é€ æ–¹æ³•å‚æ•°å€¼</span>resolvedValues <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConstructorArgumentValues</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// è§£æBeanDefinitionä¸­æ‰€è®¾ç½®çš„æ„é€ æ–¹æ³•å‚æ•°å€¼ï¼ˆindexè·³è·ƒï¼‰</span>minNrOfArgs <span class="token operator">=</span> <span class="token function">resolveConstructorArguments</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> mbd<span class="token punctuation">,</span> bw<span class="token punctuation">,</span> cargs<span class="token punctuation">,</span> resolvedValues<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">// æŒ‰æ„é€ æ–¹æ³•çš„å‚æ•°ä¸ªæ•°é™åºæ’åºï¼Œå‚æ•°ä¸ªæ•°å¤šçš„åœ¨å‰</span><span class="token class-name">AutowireUtils</span><span class="token punctuation">.</span><span class="token function">sortConstructors</span><span class="token punctuation">(</span>candidates<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">int</span> minTypeDiffWeight <span class="token operator">=</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token constant">MAX_VALUE</span><span class="token punctuation">;</span><span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Constructor</span><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span><span class="token punctuation">></span></span> ambiguousConstructors <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span><span class="token class-name">LinkedList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">UnsatisfiedDependencyException</span><span class="token punctuation">></span></span> causes <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span><span class="token comment">// éå†æ„é€ æ–¹æ³•ï¼Œæ‰¾åˆ°ä¸€ä¸ªæœ€åˆé€‚çš„(è´ªå©ª)</span><span class="token comment">// å…ˆçœ‹å‚æ•°åˆ—è¡¨æœ€é•¿çš„æ„é€ æ–¹æ³•ï¼Œæ ¹æ®æ¯ä¸ªå‚æ•°çš„å‚æ•°ç±»å‹å’Œå‚æ•°åå»æ‰¾bean</span><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Constructor</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span> candidate <span class="token operator">:</span> candidates<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">// å½“å‰æ„é€ æ–¹æ³•çš„å‚æ•°ä¸ªæ•°</span><span class="token keyword">int</span> parameterCount <span class="token operator">=</span> candidate<span class="token punctuation">.</span><span class="token function">getParameterCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//å¦‚æœä¹‹å‰çš„æ„é€ å™¨å·²ç»æœ‰ä¸€ä¸ªè¢«å¤„ç†è¿‡ä¸”è¯¥å‚æ•°ä¸ªæ•°å¤§äºå½“å‰éå†çš„ï¼Œåˆ™åé¢çš„æ„é€ å™¨å°±ä¸ç”¨å¤„ç†äº†</span><span class="token keyword">if</span> <span class="token punctuation">(</span>constructorToUse <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> argsToUse <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> argsToUse<span class="token punctuation">.</span>length <span class="token operator">></span> parameterCount<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">// Already found greedy constructor that can be satisfied -></span><span class="token comment">// do not look any further, there are only less greedy constructors left.</span><span class="token keyword">break</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">// åœ¨éå†æŸä¸ªæ„é€ æ–¹æ³•æ—¶ï¼Œå¦‚æœå‚æ•°ä¸ªæ•°å°äºç”¨äºæ‰€æŒ‡å®šçš„å‚æ•°ä¸ªæ•°ï¼Œåˆ™å¿½ç•¥è¯¥æ„é€ æ–¹æ³•</span><span class="token keyword">if</span> <span class="token punctuation">(</span>parameterCount <span class="token operator">&lt;</span> minNrOfArgs<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">continue</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token class-name">ArgumentsHolder</span> argsHolder<span class="token punctuation">;</span><span class="token comment">// å½“å‰éå†åˆ°çš„æŸä¸ªæ„é€ æ–¹æ³•çš„å‚æ•°ç±»å‹</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> paramTypes <span class="token operator">=</span> candidate<span class="token punctuation">.</span><span class="token function">getParameterTypes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// æ²¡æœ‰é€šè¿‡getBean()æ–¹æ³•æŒ‡å®šæ„é€ æ–¹æ³•å‚æ•°å€¼</span><span class="token keyword">if</span> <span class="token punctuation">(</span>resolvedValues <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">try</span> <span class="token punctuation">&#123;</span><span class="token comment">// è·å–å‚æ•°å</span><span class="token comment">// æŸ¥çœ‹æ˜¯å¦åœ¨æ„é€ æ–¹æ³•ä¸Šä½¿ç”¨@ConstructorPropertiesæ³¨è§£æ¥å®šä¹‰æ„é€ æ–¹æ³•å‚æ•°çš„åå­—</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> paramNames <span class="token operator">=</span> <span class="token class-name">ConstructorPropertiesChecker</span><span class="token punctuation">.</span><span class="token function">evaluate</span><span class="token punctuation">(</span>candidate<span class="token punctuation">,</span> parameterCount<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>paramNames <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token class-name">ParameterNameDiscoverer</span> pnd <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>beanFactory<span class="token punctuation">.</span><span class="token function">getParameterNameDiscoverer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>pnd <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>paramNames <span class="token operator">=</span> pnd<span class="token punctuation">.</span><span class="token function">getParameterNames</span><span class="token punctuation">(</span>candidate<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token comment">//è¿™é‡Œä¼šè§¦å‘æ„é€ å‡½æ•°ä¸­å‚æ•°çš„getBeanæ“ä½œï¼Œä¼šå®ä¾‹åŒ–å‚æ•°çš„å€¼</span><span class="token comment">// æ ¹æ®å½“å‰æ„é€ æ–¹æ³•çš„å‚æ•°ç±»å‹å’Œå‚æ•°åä»beanFactoryä¸­å¾—åˆ°beanä½œä¸ºå‚æ•°å€¼</span><span class="token comment">// resolvedValues, è¡¨ç¤ºæ‰€æŒ‡å®šçš„æ„é€ æ–¹æ³•å‚æ•°å€¼</span><span class="token comment">// paramTypesï¼Œå½“å‰æ„é€ æ–¹æ³•çš„å‚æ•°ç±»å‹åˆ—è¡¨</span><span class="token comment">// paramNamesï¼Œå½“å‰æ„é€ æ–¹æ³•çš„å‚æ•°å€¼åˆ—è¡¨</span><span class="token comment">// getUserDeclaredConstructor(candidate)è·å–çˆ¶ç±»ä¸­è¢«é‡å†™çš„æ„é€ æ–¹æ³•</span>argsHolder <span class="token operator">=</span> <span class="token function">createArgumentArray</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> mbd<span class="token punctuation">,</span> resolvedValues<span class="token punctuation">,</span> bw<span class="token punctuation">,</span> paramTypes<span class="token punctuation">,</span> paramNames<span class="token punctuation">,</span><span class="token function">getUserDeclaredConstructor</span><span class="token punctuation">(</span>candidate<span class="token punctuation">)</span><span class="token punctuation">,</span> autowiring<span class="token punctuation">,</span> candidates<span class="token punctuation">.</span>length <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">UnsatisfiedDependencyException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">// å¦‚æœæ‰¾ä¸åˆ°å¯¹åº”çš„beanï¼Œä¹Ÿä¸ä¼šç›´æ¥æŠ¥é”™ï¼Œåªèƒ½è¯æ˜å½“å‰éå†åˆ°çš„æ„é€ æ–¹æ³•ä¸èƒ½ç”¨</span><span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isTraceEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>logger<span class="token punctuation">.</span><span class="token function">trace</span><span class="token punctuation">(</span><span class="token string">"Ignoring constructor ["</span> <span class="token operator">+</span> candidate <span class="token operator">+</span> <span class="token string">"] of bean '"</span> <span class="token operator">+</span> beanName <span class="token operator">+</span> <span class="token string">"': "</span> <span class="token operator">+</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">// Swallow and try next constructor.</span><span class="token keyword">if</span> <span class="token punctuation">(</span>causes <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>causes <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span>causes<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>ex<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">continue</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">else</span> <span class="token punctuation">&#123;</span><span class="token comment">// é€šè¿‡getBean()æ–¹æ³•æŒ‡å®šäº†æ„é€ æ–¹æ³•å‚æ•°å€¼</span><span class="token comment">// Explicit arguments given -> arguments length must match exactly.</span><span class="token keyword">if</span> <span class="token punctuation">(</span>parameterCount <span class="token operator">!=</span> explicitArgs<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">continue</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">// å¦‚æœå‚æ•°ä¸ªæ•°åŒ¹é…ï¼Œåˆ™æŠŠæ‰€æœ‰å‚æ•°å€¼å°è£…ä¸ºä¸€ä¸ªArgumentsHolderå¯¹è±¡</span>argsHolder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArgumentsHolder</span><span class="token punctuation">(</span>explicitArgs<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">// æ‰§è¡Œåˆ°è¿™é‡Œï¼Œè¡¨ç¤ºå½“å‰æ„é€ æ–¹æ³•å¯ç”¨ï¼Œå¹¶ä¸”ä¹Ÿæ‰¾åˆ°äº†å¯¹åº”çš„æ„é€ æ–¹æ³•å‚æ•°å€¼</span><span class="token comment">// ä½†æ˜¯è¿˜éœ€è¦åˆ¤æ–­ï¼Œå½“å‰æ„é€ æ–¹æ³•æ˜¯ä¸æ˜¯æœ€åˆé€‚çš„ï¼Œä¹Ÿè®¸è¿˜æœ‰å¦å¤–çš„æ„é€ æ–¹æ³•æ›´åˆé€‚</span><span class="token comment">// æ ¹æ®å‚æ•°ç±»å‹å’Œå‚æ•°å€¼è®¡ç®—æƒé‡</span><span class="token comment">// Lenientå®½æ¾ï¼Œé»˜è®¤å®½æ¾æ¨¡å¼æ˜¯å¼€å¯çš„</span><span class="token comment">// åœ¨å®½æ¾æ¨¡å¼ä¸‹ï¼Œä¼šåˆ¤æ–­æ¯ä¸ªå‚æ•°å€¼çš„ç±»å‹å’Œå½“å‰æ„é€ æ–¹æ³•çš„å‚æ•°ç±»å‹çš„è·ç¦»</span><span class="token comment">// åœ¨éå®½æ¾æ¨¡å¼ä¸‹ï¼Œä¼šå¿½ç•¥æ¯ä¸ªå‚æ•°å€¼çš„ç±»å‹å’Œå½“å‰æ„é€ æ–¹æ³•çš„å‚æ•°ç±»å‹çš„è·ç¦»ï¼Œåªè¦æ˜¯çˆ¶å­å…³ç³»è·ç¦»æ˜¯ä¸€æ ·çš„</span><span class="token keyword">int</span> typeDiffWeight <span class="token operator">=</span> <span class="token punctuation">(</span>mbd<span class="token punctuation">.</span><span class="token function">isLenientConstructorResolution</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">?</span>argsHolder<span class="token punctuation">.</span><span class="token function">getTypeDifferenceWeight</span><span class="token punctuation">(</span>paramTypes<span class="token punctuation">)</span> <span class="token operator">:</span> argsHolder<span class="token punctuation">.</span><span class="token function">getAssignabilityWeight</span><span class="token punctuation">(</span>paramTypes<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// Choose this constructor if it represents the closest match.</span><span class="token comment">// å¦‚æœå½“å‰æ„é€ æ–¹æ³•çš„æƒé‡æ¯”è¾ƒå°ï¼Œåˆ™è¡¨ç¤ºå½“å‰æ„é€ æ–¹æ³•æ›´åˆé€‚ï¼Œå°†å½“å‰æ„é€ æ–¹æ³•å’Œæ‰€æ‰¾åˆ°å‚æ•°å€¼ä½œä¸ºå¾…ä½¿ç”¨çš„ï¼Œéå†ä¸‹ä¸€ä¸ªæ„é€ æ–¹æ³•</span><span class="token keyword">if</span> <span class="token punctuation">(</span>typeDiffWeight <span class="token operator">&lt;</span> minTypeDiffWeight<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>constructorToUse <span class="token operator">=</span> candidate<span class="token punctuation">;</span>argsHolderToUse <span class="token operator">=</span> argsHolder<span class="token punctuation">;</span>argsToUse <span class="token operator">=</span> argsHolder<span class="token punctuation">.</span>arguments<span class="token punctuation">;</span>minTypeDiffWeight <span class="token operator">=</span> typeDiffWeight<span class="token punctuation">;</span>ambiguousConstructors <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>constructorToUse <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> typeDiffWeight <span class="token operator">==</span> minTypeDiffWeight<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">// å¦‚æœæƒé‡ä¸€æ ·ï¼Œåˆ™è®°å½•åœ¨ambiguousConstructorsä¸­ï¼Œç»§ç»­éå†ä¸‹ä¸€ä¸ªæ„é€ æ–¹æ³•</span><span class="token keyword">if</span> <span class="token punctuation">(</span>ambiguousConstructors <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>ambiguousConstructors <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedHashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>ambiguousConstructors<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>constructorToUse<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span>ambiguousConstructors<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>candidate<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token comment">//end of for</span><span class="token comment">// éå†å®Œæ‰€æœ‰æ„é€ æ–¹æ³•åï¼Œæ²¡æœ‰æ‰¾åˆ°åˆé€‚çš„æ„é€ æ–¹æ³•ï¼Œåˆ™æŠ¥é”™</span><span class="token keyword">if</span> <span class="token punctuation">(</span>constructorToUse <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>causes <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token class-name">UnsatisfiedDependencyException</span> ex <span class="token operator">=</span> causes<span class="token punctuation">.</span><span class="token function">removeLast</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> cause <span class="token operator">:</span> causes<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">this</span><span class="token punctuation">.</span>beanFactory<span class="token punctuation">.</span><span class="token function">onSuppressedException</span><span class="token punctuation">(</span>cause<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">throw</span> ex<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BeanCreationException</span><span class="token punctuation">(</span>mbd<span class="token punctuation">.</span><span class="token function">getResourceDescription</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> beanName<span class="token punctuation">,</span><span class="token string">"Could not resolve matching constructor "</span> <span class="token operator">+</span><span class="token string">"(hint: specify index/type/name arguments for simple parameters to avoid type ambiguities)"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">// å¦‚æœå­˜åœ¨æƒé‡ä¸€æ ·çš„æ„é€ æ–¹æ³•å¹¶ä¸”ä¸æ˜¯å®½æ¾æ¨¡å¼ï¼Œä¹ŸæŠ¥é”™ï¼Œå› ä¸ºæƒé‡ä¸€æ ·ï¼ŒSpringä¸çŸ¥é“è¯¥ç”¨å“ªä¸ª</span><span class="token comment">// å¦‚æœæ˜¯å®½æ¾æ¨¡å¼åˆ™ä¸ä¼šæŠ¥é”™ï¼ŒSpringä¼šç”¨æ‰¾åˆ°çš„ç¬¬ä¸€ä¸ª</span><span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>ambiguousConstructors <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>mbd<span class="token punctuation">.</span><span class="token function">isLenientConstructorResolution</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BeanCreationException</span><span class="token punctuation">(</span>mbd<span class="token punctuation">.</span><span class="token function">getResourceDescription</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> beanName<span class="token punctuation">,</span><span class="token string">"Ambiguous constructor matches found in bean '"</span> <span class="token operator">+</span> beanName <span class="token operator">+</span> <span class="token string">"' "</span> <span class="token operator">+</span><span class="token string">"(hint: specify index/type/name arguments for simple parameters to avoid type ambiguities): "</span> <span class="token operator">+</span>ambiguousConstructors<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">// å¦‚æœä¸æ˜¯é€šè¿‡getBean()æ–¹æ³•æŒ‡å®šçš„å‚æ•°ï¼Œé‚£ä¹ˆå°±æŠŠæ‰¾åˆ°çš„æ„é€ æ–¹æ³•å‚æ•°è¿›è¡Œç¼“å­˜</span><span class="token keyword">if</span> <span class="token punctuation">(</span>explicitArgs <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> argsHolderToUse <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>argsHolderToUse<span class="token punctuation">.</span><span class="token function">storeCache</span><span class="token punctuation">(</span>mbd<span class="token punctuation">,</span> constructorToUse<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token comment">// å¾—åˆ°äº†æ„é€ æ–¹æ³•å’Œæ„é€ æ–¹æ³•çš„å‚æ•°å€¼ä¹‹åï¼Œå°±å¯ä»¥è¿›è¡Œå®ä¾‹åŒ–äº†</span><span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">state</span><span class="token punctuation">(</span>argsToUse <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token string">"Unresolved constructor arguments"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>bw<span class="token punctuation">.</span><span class="token function">setBeanInstance</span><span class="token punctuation">(</span><span class="token function">instantiate</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> mbd<span class="token punctuation">,</span> constructorToUse<span class="token punctuation">,</span> argsToUse<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">return</span> bw<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æ€»ç»“ä¸‹ï¼š</p><ul><li><p>æ‰‹åŠ¨è£…é…</p><ul><li>æ²¡æœ‰æ˜¾å¼æä¾›æ„é€ æ–¹æ³•ï¼šä½¿ç”¨é»˜è®¤æ„é€ æ–¹æ³•</li><li>æä¾›ä¸€ä¸ªæ„é€ æ–¹æ³•ï¼šä½¿ç”¨è¯¥æ„é€ æ–¹æ³•</li><li>æä¾›å¤šä¸ªæ„é€ æ–¹æ³•ï¼ŒåŒ…å«é»˜è®¤æ„é€ æ–¹æ³•ï¼šä½¿ç”¨é»˜è®¤æ„é€ æ–¹æ³•</li><li>æä¾›å¤šä¸ªæ„é€ æ–¹æ³•ï¼Œä¸åŒ…å«é»˜è®¤æ„é€ æ–¹æ³•ï¼šæŠ¥é”™</li><li>æä¾›å¤šä¸ªæ„é€ æ–¹æ³•ï¼Œæœ‰ä¸€ä¸ª@Autowired(required &#x3D; true)çš„æ„é€ æ–¹æ³•ï¼šä½¿ç”¨æœ‰@Autowired(required &#x3D; true)çš„æ„é€ æ–¹æ³•</li><li>æä¾›å¤šä¸ªæ„é€ æ–¹æ³•ï¼Œæœ‰å¤šä¸ª@Autowired(required &#x3D; true)çš„æ„é€ æ–¹æ³•ï¼šæŠ¥é”™</li><li>æä¾›å¤šä¸ªæ„é€ æ–¹æ³•ï¼Œæœ‰ä¸€ä¸ª@Autowired(required &#x3D; true)çš„æ„é€ æ–¹æ³•å’Œå¤šä¸ª@Autowired(required &#x3D; false)çš„æ„é€ æ–¹æ³•ï¼šæŠ¥é”™</li><li>æä¾›å¤šä¸ªæ„é€ æ–¹æ³•ï¼Œæœ‰å¤šä¸ª@Autowired(required &#x3D; false)çš„æ„é€ æ–¹æ³•ï¼šä½¿ç”¨ç¬¦åˆæ¡ä»¶çš„&amp;å‚æ•°æœ€å¤šçš„æ„é€ æ–¹æ³•</li></ul></li><li><p>ä½¿ç”¨æ„é€ æ–¹æ³•è‡ªåŠ¨è£…é…ï¼šä½¿ç”¨ç¬¦åˆæ¡ä»¶çš„&amp;å‚æ•°æœ€å¤šçš„æ„é€ æ–¹æ³•</p></li></ul><p>å¦‚æœä¸¤æ¬¡æ¨æ–­æ„é€ å‡½æ•°å‡æœªæœï¼Œåˆ™ä½¿ç”¨æ— å‚æ„é€ å‡½æ•°çš„å®ä¾‹åŒ–,å¤§éƒ¨åˆ†çš„å®ä¾‹æ˜¯é‡‡ç”¨çš„æ— å‚æ„é€ å‡½æ•°çš„æ–¹å¼å®ä¾‹åŒ–ï¼Œè¿™é‡Œä¸ç»§ç»­è·Ÿäº†ã€‚å›åˆ°6.doCreateBean()ï¼Œå†å»çœ‹çœ‹applyMergedBeanDefinitionPostProcessors</p><h3 id="6-2-æ³¨è§£æ‰«æapplyMergedBeanDefinitionPostProcessors"><a href="#6-2-æ³¨è§£æ‰«æapplyMergedBeanDefinitionPostProcessors" class="headerlink" title="6.2.æ³¨è§£æ‰«æapplyMergedBeanDefinitionPostProcessors()"></a>6.2.æ³¨è§£æ‰«æapplyMergedBeanDefinitionPostProcessors()</h3><p>è¿™ä¸ªæ–¹æ³•ä¸»è¦åŠŸèƒ½ä¸ºï¼š<strong>æ”¶é›†@Resourceã€@PostConstructã€@PreDestoryã€@Autowired å’Œ@Valueæ³¨è§£çš„æ–¹æ³•æˆ–å±æ€§ï¼Œå°è£…æˆå¯¹åº”çš„å¯¹è±¡ï¼Œæ–¹ä¾¿åç»­ä¾èµ–æ³¨å…¥æ—¶ä½¿ç”¨</strong>ã€‚å…¶ä¸­</p><ul><li>CommonAnnotationBeanPostProcessor  æ”¯æŒ@PostConstructï¼Œ@PreDestroyå’Œ@Resourceæ³¨è§£</li><li>AutowiredAnnotationBeanPostProcessor æ”¯æŒ@Autowiredå’Œ@Valueæ³¨è§£</li></ul><p>è¿™ä¸¤ä¸ªç±»éƒ½æ˜¯MergedBeanDefinitionPostProcessorçš„å®ç°ç±»ã€‚æˆ‘ä»¬å…ˆç‚¹è¿›å»çœ‹çœ‹applyMergedBeanDefinitionPostProcessors()æ–¹æ³•</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">applyMergedBeanDefinitionPostProcessors</span><span class="token punctuation">(</span><span class="token class-name">RootBeanDefinition</span> mbd<span class="token punctuation">,</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span> beanType<span class="token punctuation">,</span> <span class="token class-name">String</span> beanName<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">//ä»æ‰€æœ‰BeanPostProcessorä¸­è¿‡æ»¤å‡ºMergedBeanDefinitionPostProcessorçš„ç±»ï¼Œå¾ªç¯æ‰«æ</span><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">BeanPostProcessor</span> bp <span class="token operator">:</span> <span class="token function">getBeanPostProcessors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>bp <span class="token keyword">instanceof</span> <span class="token class-name">MergedBeanDefinitionPostProcessor</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token class-name">MergedBeanDefinitionPostProcessor</span> bdp <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">MergedBeanDefinitionPostProcessor</span><span class="token punctuation">)</span> bp<span class="token punctuation">;</span>bdp<span class="token punctuation">.</span><span class="token function">postProcessMergedBeanDefinition</span><span class="token punctuation">(</span>mbd<span class="token punctuation">,</span> beanType<span class="token punctuation">,</span> beanName<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æˆ‘ä»¬å…ˆçœ‹çœ‹CommonAnnotationBeanPostProcessorçš„postProcessMergedBeanDefinition()æ–¹æ³•</p><h4 id="6-2-1-PostConstructï¼Œ-PreDestroyå’Œ-Resourceæ³¨è§£æ‰«æ"><a href="#6-2-1-PostConstructï¼Œ-PreDestroyå’Œ-Resourceæ³¨è§£æ‰«æ" class="headerlink" title="6.2.1.@PostConstructï¼Œ@PreDestroyå’Œ@Resourceæ³¨è§£æ‰«æ"></a>6.2.1.@PostConstructï¼Œ@PreDestroyå’Œ@Resourceæ³¨è§£æ‰«æ</h4><p>CommonAnnotationBeanPostProcessorçš„postProcessMergedBeanDefinition()</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">postProcessMergedBeanDefinition</span><span class="token punctuation">(</span><span class="token class-name">RootBeanDefinition</span> beanDefinition<span class="token punctuation">,</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span> beanType<span class="token punctuation">,</span> <span class="token class-name">String</span> beanName<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">//1.æ‰«æ@PostConstructï¼Œ@PreDestroy</span><span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">postProcessMergedBeanDefinition</span><span class="token punctuation">(</span>beanDefinition<span class="token punctuation">,</span> beanType<span class="token punctuation">,</span> beanName<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//2.@Resourceæ³¨è§£çš„å±æ€§æˆ–è€…æ–¹æ³•çš„æ”¶é›†</span><span class="token class-name">InjectionMetadata</span> metadata <span class="token operator">=</span> <span class="token function">findResourceMetadata</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> beanType<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>metadata<span class="token punctuation">.</span><span class="token function">checkConfigMembers</span><span class="token punctuation">(</span>beanDefinition<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>åˆ†æˆä¸¤æ­¥å®Œæˆç›¸åº”æ³¨è§£çš„æ‰«æï¼š</p><ol><li><p>æ”¶é›†è¢«@PostConstruct å’Œ@PreDestroy æ³¨è§£æ ‡æ³¨çš„æ–¹æ³•<br> 1ï¼‰CommonAnnotationBeanPostProcessorçš„æ„é€ å‡½æ•°å…ˆè®¾ç½®éœ€è¦æ‰«æçš„æ³¨è§£ç±»å‹ï¼Œå†å»çˆ¶ç±»InitDestroyAnnotationBeanPostProcessorä¸­å»æ‰«æ</p> <pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token class-name">CommonAnnotationBeanPostProcessor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token function">setOrder</span><span class="token punctuation">(</span><span class="token class-name">Ordered</span><span class="token punctuation">.</span><span class="token constant">LOWEST_PRECEDENCE</span> <span class="token operator">-</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//åœ¨æ­¤å¤„è¿›è¡Œè®¾ç½®ï¼Œåˆ°çˆ¶ç±»ä¸­å»è·å–æ ‡è®°äº†è¿™äº›æ³¨è§£çš„ç±»</span><span class="token function">setInitAnnotationType</span><span class="token punctuation">(</span><span class="token class-name">PostConstruct</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">setDestroyAnnotationType</span><span class="token punctuation">(</span><span class="token class-name">PreDestroy</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">ignoreResourceType</span><span class="token punctuation">(</span><span class="token string">"javax.xml.ws.WebServiceContext"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p> 2ï¼‰å…ˆçœ‹ç¼“å­˜ä¸­æ˜¯å¦æœ‰ï¼Œæ²¡æœ‰åˆ™é‡æ–°å»æ‰«æ</p> <pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">postProcessMergedBeanDefinition</span><span class="token punctuation">(</span><span class="token class-name">RootBeanDefinition</span> beanDefinition<span class="token punctuation">,</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span> beanType<span class="token punctuation">,</span> <span class="token class-name">String</span> beanName<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token class-name">LifecycleMetadata</span> metadata <span class="token operator">=</span> <span class="token function">findLifecycleMetadata</span><span class="token punctuation">(</span>beanType<span class="token punctuation">)</span><span class="token punctuation">;</span>metadata<span class="token punctuation">.</span><span class="token function">checkConfigMembers</span><span class="token punctuation">(</span>beanDefinition<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">private</span> <span class="token class-name">LifecycleMetadata</span> <span class="token function">findLifecycleMetadata</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span> clazz<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>lifecycleMetadataCache <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">// ç¼“å­˜æ²¡æœ‰</span><span class="token keyword">return</span> <span class="token function">buildLifecycleMetadata</span><span class="token punctuation">(</span>clazz<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">// Quick check on the concurrent map first, with minimal locking.</span><span class="token class-name">LifecycleMetadata</span> metadata <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>lifecycleMetadataCache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>clazz<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>metadata <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>lifecycleMetadataCache<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>metadata <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>lifecycleMetadataCache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>clazz<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>metadata <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>metadata <span class="token operator">=</span> <span class="token function">buildLifecycleMetadata</span><span class="token punctuation">(</span>clazz<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">this</span><span class="token punctuation">.</span>lifecycleMetadataCache<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>clazz<span class="token punctuation">,</span> metadata<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">return</span> metadata<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">return</span> metadata<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">private</span> <span class="token class-name">LifecycleMetadata</span> <span class="token function">buildLifecycleMetadata</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span> clazz<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">AnnotationUtils</span><span class="token punctuation">.</span><span class="token function">isCandidateClass</span><span class="token punctuation">(</span>clazz<span class="token punctuation">,</span> <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>initAnnotationType<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>destroyAnnotationType<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>emptyLifecycleMetadata<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">//@PostConstruct æ ‡è®°çš„æ–¹æ³•</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">LifecycleElement</span><span class="token punctuation">></span></span> initMethods <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//@PreDestroy æ ‡è®°çš„æ–¹æ³•</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">LifecycleElement</span><span class="token punctuation">></span></span> destroyMethods <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span> targetClass <span class="token operator">=</span> clazz<span class="token punctuation">;</span><span class="token keyword">do</span> <span class="token punctuation">&#123;</span><span class="token keyword">final</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">LifecycleElement</span><span class="token punctuation">></span></span> currInitMethods <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">final</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">LifecycleElement</span><span class="token punctuation">></span></span> currDestroyMethods <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//å¾ªç¯éå†ç±»ä¸­æ‰€æœ‰çš„åˆå§‹åŒ–å’Œé”€æ¯çš„æ–¹æ³•</span><span class="token class-name">ReflectionUtils</span><span class="token punctuation">.</span><span class="token function">doWithLocalMethods</span><span class="token punctuation">(</span>targetClass<span class="token punctuation">,</span> method <span class="token operator">-></span> <span class="token punctuation">&#123;</span><span class="token comment">//æ”¶é›†@PostConstruct æ ‡è®°çš„æ–¹æ³•</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>initAnnotationType <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> method<span class="token punctuation">.</span><span class="token function">isAnnotationPresent</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>initAnnotationType<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token class-name">LifecycleElement</span> element <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LifecycleElement</span><span class="token punctuation">(</span>method<span class="token punctuation">)</span><span class="token punctuation">;</span>currInitMethods<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isTraceEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>logger<span class="token punctuation">.</span><span class="token function">trace</span><span class="token punctuation">(</span><span class="token string">"Found init method on class ["</span> <span class="token operator">+</span> clazz<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"]: "</span> <span class="token operator">+</span> method<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token comment">//æ”¶é›†@PreDestroy æ ‡è®°çš„æ–¹æ³•</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>destroyAnnotationType <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> method<span class="token punctuation">.</span><span class="token function">isAnnotationPresent</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>destroyAnnotationType<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>currDestroyMethods<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">LifecycleElement</span><span class="token punctuation">(</span>method<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isTraceEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>logger<span class="token punctuation">.</span><span class="token function">trace</span><span class="token punctuation">(</span><span class="token string">"Found destroy method on class ["</span> <span class="token operator">+</span> clazz<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"]: "</span> <span class="token operator">+</span> method<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>initMethods<span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> currInitMethods<span class="token punctuation">)</span><span class="token punctuation">;</span>destroyMethods<span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span>currDestroyMethods<span class="token punctuation">)</span><span class="token punctuation">;</span>targetClass <span class="token operator">=</span> targetClass<span class="token punctuation">.</span><span class="token function">getSuperclass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">while</span> <span class="token punctuation">(</span>targetClass <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> targetClass <span class="token operator">!=</span> <span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">return</span> <span class="token punctuation">(</span>initMethods<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> destroyMethods<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token keyword">this</span><span class="token punctuation">.</span>emptyLifecycleMetadata <span class="token operator">:</span><span class="token keyword">new</span> <span class="token class-name">LifecycleMetadata</span><span class="token punctuation">(</span>clazz<span class="token punctuation">,</span> initMethods<span class="token punctuation">,</span> destroyMethods<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>æ”¶é›†è¢«@Resource æ³¨è§£çš„æ ‡æ³¨çš„æ–¹æ³•å’Œå±æ€§<br> 1ï¼‰å…ˆçœ‹ç¼“å­˜ä¸­æ˜¯å¦æœ‰InjectionMetadata </p> <pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">private</span> <span class="token class-name">InjectionMetadata</span> <span class="token function">findResourceMetadata</span><span class="token punctuation">(</span><span class="token class-name">String</span> beanName<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span> clazz<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">PropertyValues</span> pvs<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">// Fall back to class name as cache key, for backwards compatibility with custom callers.</span><span class="token class-name">String</span> cacheKey <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">hasLength</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span> <span class="token operator">?</span> beanName <span class="token operator">:</span> clazz<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// Quick check on the concurrent map first, with minimal locking.</span><span class="token class-name">InjectionMetadata</span> metadata <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>injectionMetadataCache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>cacheKey<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//ç¼“å­˜ä¸­ä¸å­˜åœ¨</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">InjectionMetadata</span><span class="token punctuation">.</span><span class="token function">needsRefresh</span><span class="token punctuation">(</span>metadata<span class="token punctuation">,</span> clazz<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>injectionMetadataCache<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>metadata <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>injectionMetadataCache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>cacheKey<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">InjectionMetadata</span><span class="token punctuation">.</span><span class="token function">needsRefresh</span><span class="token punctuation">(</span>metadata<span class="token punctuation">,</span> clazz<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>metadata <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>metadata<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span>pvs<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span>metadata <span class="token operator">=</span> <span class="token function">buildResourceMetadata</span><span class="token punctuation">(</span>clazz<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">this</span><span class="token punctuation">.</span>injectionMetadataCache<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>cacheKey<span class="token punctuation">,</span> metadata<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">return</span> metadata<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p> 2ï¼‰åˆ†åˆ«è·å–è¢«@Resourceæ³¨è§£çš„å±æ€§å’Œæ–¹æ³•(è¿™é‡Œæˆ‘ä»¬åªå…³æ³¨@Resourceæ³¨è§£çš„å±æ€§å’Œæ–¹æ³•)</p></li></ol><p> <img src="https://cdn.jsdelivr.net/gh/zyxelva/picgo@main/csdn/20210413105919770.png"></p><pre><code>3ï¼‰æœ€ç»ˆæŠŠä¸¤ä¸ªfield å’ŒMethod å°è£…çš„å¯¹è±¡é›†åˆå°è£…åˆ°InjectionMetadata å¯¹è±¡ä¸­</code></pre><h4 id="6-2-2-Autowiredå’Œ-Valueæ³¨è§£æ‰«æ"><a href="#6-2-2-Autowiredå’Œ-Valueæ³¨è§£æ‰«æ" class="headerlink" title="6.2.2.@Autowiredå’Œ@Valueæ³¨è§£æ‰«æ"></a>6.2.2.@Autowiredå’Œ@Valueæ³¨è§£æ‰«æ</h4><p>AutowiredAnnotationBeanPostProcessorçš„postProcessMergedBeanDefinition()<br>AutowiredAnnotationBeanPostProcessor ç±»æ˜¯å¯¹@Autowired å’Œ@Value æ³¨è§£çš„å±æ€§å’Œæ–¹æ³•çš„æ”¶é›†ï¼Œæ”¶é›†<br>æ”¯æŒçš„æ³¨è§£ç±»å‹å¯ä»¥åœ¨æ„é€ å‡½æ•°æˆ–è€…Static é™æ€å—ä¸­æ‰¾ã€‚æ”¶é›†è¿‡ç¨‹åŸºæœ¬ä¸Šè·Ÿ@Resource æ³¨è§£çš„æ”¶é›†å·®ä¸å¤šã€‚</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token class-name">AutowiredAnnotationBeanPostProcessor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">this</span><span class="token punctuation">.</span>autowiredAnnotationTypes<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">Autowired</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">this</span><span class="token punctuation">.</span>autowiredAnnotationTypes<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">Value</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">try</span> <span class="token punctuation">&#123;</span><span class="token keyword">this</span><span class="token punctuation">.</span>autowiredAnnotationTypes<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">Annotation</span><span class="token punctuation">></span></span><span class="token punctuation">)</span><span class="token class-name">ClassUtils</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span><span class="token string">"javax.inject.Inject"</span><span class="token punctuation">,</span> <span class="token class-name">AutowiredAnnotationBeanPostProcessor</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>logger<span class="token punctuation">.</span><span class="token function">trace</span><span class="token punctuation">(</span><span class="token string">"JSR-330 'javax.inject.Inject' annotation found and supported for autowiring"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ClassNotFoundException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">// JSR-330 API not available - simply skip.</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æ”¶é›†è¿‡ç¨‹è·Ÿä¸Šè¿°@Resource æ”¶é›†ï¼Œè°ƒç”¨çš„éƒ½æ˜¯ReflectionUtilså·¥å…·ç±»ä¸­çš„æ–¹æ³•ï¼Œä¹Ÿæ˜¯æ”¶é›†Field å’ŒMethod ä¸Šé¢çš„æ³¨è§£ï¼Œç„¶åæ”¾åˆ°InjectionMetadataå¯¹è±¡ä¸­ã€‚</p><p>æ”¶é›†@Resourceã€@PostConstructã€@PreDestoryã€@Autowired å’Œ@Valueæ³¨è§£çš„æ–¹æ³•æˆ–å±æ€§çš„è¿‡ç¨‹ç»“æŸã€‚<br>ä¸‹ä¸€ç« ï¼Œæˆ‘ä»¬è®²è®²ä¾èµ–æ³¨å…¥çš„è¿‡ç¨‹ï¼Œæ•¬è¯·æœŸå¾…ã€‚^_^</p>]]></content>
      
      
      <categories>
          
          <category> Springæºç å­¦ä¹  </category>
          
      </categories>
      
      
        <tags>
            
            <tag> æºç  </tag>
            
            <tag> Spring </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ã€Springæºç å­¦ä¹ ã€‘Springåˆå§‹åŒ–æœºåˆ¶(xmlå½¢å¼)</title>
      <link href="/posts/43548.html"/>
      <url>/posts/43548.html</url>
      
        <content type="html"><![CDATA[<h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><h2 id="Spring-å®¹å™¨åŠ è½½æ–¹å¼"><a href="#Spring-å®¹å™¨åŠ è½½æ–¹å¼" class="headerlink" title="Spring å®¹å™¨åŠ è½½æ–¹å¼"></a>Spring å®¹å™¨åŠ è½½æ–¹å¼</h2><ul><li><p>ç±»è·¯å¾„è·å–é…ç½®æ–‡ä»¶</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">ApplicationContext</span> applicationContext<span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ClassPathXmlApplicationContext</span><span class="token punctuation">(</span><span class="token string">"spring.xml"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li><li><p>æ–‡ä»¶ç³»ç»Ÿè·¯å¾„è·å–é…ç½®æ–‡ä»¶[ç»å¯¹è·¯å¾„]</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">ApplicationContext</span> applicationContext <span class="token operator">=</span> <span class="token keyword">new</span><span class="token class-name">FileSystemXmlApplicationContext</span><span class="token punctuation">(</span><span class="token string">"E:\\idea\\springdemo\\spring.xml"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></li><li><p>æ—  é… ç½® æ–‡ ä»¶ åŠ  è½½ å®¹ å™¨</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">ApplicationContext</span> applicationContext <span class="token operator">=</span> <span class="token keyword">new</span><span class="token class-name">AnnotationConfigApplicationContext</span><span class="token punctuation">(</span><span class="token string">"com.xx.jack"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></li><li><p>Spring Boot åŠ è½½å®¹å™¨</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">ApplicationContext</span> applicationContext <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">EmbeddedWebApplicationContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li></ul><h2 id="Spring-åˆå§‹åŒ–æ ¸å¿ƒæµç¨‹"><a href="#Spring-åˆå§‹åŒ–æ ¸å¿ƒæµç¨‹" class="headerlink" title="Spring åˆå§‹åŒ–æ ¸å¿ƒæµç¨‹"></a>Spring åˆå§‹åŒ–æ ¸å¿ƒæµç¨‹</h2><p><strong>AbstractApplicationContext.refresh()</strong> æ–¹æ³•æ˜¯ spring å®¹å™¨å¯åŠ¨è¿‡ç¨‹ä¸­çš„æ ¸å¿ƒæ–¹æ³•ï¼Œspring å®¹å™¨è¦åŠ è½½å¿…é¡»æ‰§è¡Œè¯¥æ–¹æ³•ã€‚</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">refresh</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">BeansException</span><span class="token punctuation">,</span> <span class="token class-name">IllegalStateException</span> <span class="token punctuation">&#123;</span><span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>startupShutdownMonitor<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">//ä¸ºå®¹å™¨åˆå§‹åŒ–åšå‡†å¤‡ï¼Œé‡è¦ç¨‹åº¦ï¼š0</span><span class="token comment">// Prepare this context for refreshing.</span><span class="token function">prepareRefresh</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// æœ¬ç« ä¸»è¦è·Ÿè¸ªçš„å†…å®¹</span><span class="token class-name">ConfigurableListableBeanFactory</span> beanFactory <span class="token operator">=</span> <span class="token function">obtainFreshBeanFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">/* * ç»™beanFactoryè®¾ç½®ä¸€äº›å±æ€§å€¼ï¼Œå¯ä»¥ä¸çœ‹ * */</span><span class="token comment">// Prepare the bean factory for use in this context.</span><span class="token function">prepareBeanFactory</span><span class="token punctuation">(</span>beanFactory<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">try</span> <span class="token punctuation">&#123;</span><span class="token comment">// Allows post-processing of the bean factory in context subclasses.</span><span class="token function">postProcessBeanFactory</span><span class="token punctuation">(</span>beanFactory<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">/* * BeanDefinitionRegistryPostProcessor * BeanFactoryPostProcessor * å®Œæˆå¯¹è¿™ä¸¤ä¸ªæ¥å£çš„è°ƒç”¨ * */</span><span class="token comment">// Invoke factory processors registered as beans in the context.</span><span class="token function">invokeBeanFactoryPostProcessors</span><span class="token punctuation">(</span>beanFactory<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">/* * æŠŠå®ç°äº†BeanPostProcessoræ¥å£çš„ç±»å®ä¾‹åŒ–ï¼Œå¹¶ä¸”åŠ å…¥åˆ°BeanFactoryä¸­ * */</span><span class="token comment">// Register bean processors that intercept bean creation.</span><span class="token function">registerBeanPostProcessors</span><span class="token punctuation">(</span>beanFactory<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">/* * å›½é™…åŒ–,é‡è¦ç¨‹åº¦2 * */</span><span class="token comment">// Initialize message source for this context.</span><span class="token function">initMessageSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//åˆå§‹åŒ–äº‹ä»¶ç®¡ç†ç±»</span><span class="token comment">// Initialize event multicaster for this context.</span><span class="token function">initApplicationEventMulticaster</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//è¿™ä¸ªæ–¹æ³•ç€é‡ç†è§£æ¨¡æ¿è®¾è®¡æ¨¡å¼ï¼Œå› ä¸ºåœ¨springbootä¸­ï¼Œè¿™ä¸ªæ–¹æ³•æ˜¯ç”¨æ¥åšå†…åµŒtomcatå¯åŠ¨çš„</span><span class="token comment">// Initialize other special beans in specific context subclasses.</span><span class="token function">onRefresh</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">/* * å¾€äº‹ä»¶ç®¡ç†ç±»ä¸­æ³¨å†Œäº‹ä»¶ç±» * */</span><span class="token comment">// Check for listener beans and register them.</span><span class="token function">registerListeners</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">/* * è¿™ä¸ªæ–¹æ³•æ˜¯springä¸­æœ€é‡è¦çš„æ–¹æ³•ï¼Œæ²¡æœ‰ä¹‹ä¸€ * æ‰€ä»¥è¿™ä¸ªæ–¹æ³•ä¸€å®šè¦ç†è§£è¦å…·ä½“çœ‹ * 1ã€beanå®ä¾‹åŒ–è¿‡ç¨‹ * 2ã€ioc * 3ã€æ³¨è§£æ”¯æŒ * 4ã€BeanPostProcessorçš„æ‰§è¡Œ * 5ã€Aopçš„å…¥å£ * */</span><span class="token comment">// Instantiate all remaining (non-lazy-init) singletons.</span><span class="token function">finishBeanFactoryInitialization</span><span class="token punctuation">(</span>beanFactory<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// Last step: publish corresponding event.</span><span class="token function">finishRefresh</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">BeansException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isWarnEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>logger<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">"Exception encountered during context initialization - "</span> <span class="token operator">+</span><span class="token string">"cancelling refresh attempt: "</span> <span class="token operator">+</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">// Destroy already created singletons to avoid dangling resources.</span><span class="token function">destroyBeans</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// Reset 'active' flag.</span><span class="token function">cancelRefresh</span><span class="token punctuation">(</span>ex<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// Propagate exception to caller.</span><span class="token keyword">throw</span> ex<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">finally</span> <span class="token punctuation">&#123;</span><span class="token comment">// Reset common introspection caches in Spring's core, since we</span><span class="token comment">// might not ever need metadata for singleton beans anymore...</span><span class="token function">resetCommonCaches</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æœ¬èŠ‚ä¸»è¦è·Ÿè¿›spring.xmlæ ¸å¿ƒé…ç½®ç±»çš„è§£æè¿‡ç¨‹ï¼Œè¯¥æµç¨‹ä¸»è¦åŒ…æ‹¬ï¼š</p><ul><li>åˆ›å»ºBeanFactoryå¯¹è±¡</li><li>xmlè§£æ</li><li>å°è£…æˆBeanDefinitionå¯¹è±¡</li></ul><h1 id="ä¸€ã€è‡ªå®šä¹‰æ ‡ç­¾è§£æ"><a href="#ä¸€ã€è‡ªå®šä¹‰æ ‡ç­¾è§£æ" class="headerlink" title="ä¸€ã€è‡ªå®šä¹‰æ ‡ç­¾è§£æ"></a>ä¸€ã€è‡ªå®šä¹‰æ ‡ç­¾è§£æ</h1><p>æ€»ç»“ä¸€ä¸‹xmlè§£æçš„ä¸»è¦æµç¨‹ï¼š</p><ul><li>æ ¹æ®å½“å‰è§£æçš„æ ‡ç­¾å¤´ä¿¡æ¯ï¼Œæ‰¾åˆ°å¯¹åº”çš„namespaceUri</li><li>åŠ è½½Springæ‰€æœ‰jarä¸­çš„META-INF&#x2F;spring.handlersæ–‡ä»¶ï¼Œå¹¶å»ºç«‹æ˜ å°„å…³ç³»</li><li>æ ¹æ®namespaceUriä»æ˜ å°„å…³ç³»ä¸­æ‰¾åˆ°å¯¹åº”çš„å®ç°äº†NamespaceHandleræ¥å£çš„ç±»</li><li>è°ƒç”¨è¯¥ç±»çš„init()æ–¹æ³•ï¼Œæ³¨å†Œå„ç§æ ‡ç­¾åŒ…æ‹¬è‡ªå®šä¹‰æ ‡ç­¾çš„è§£æç±»</li><li>æ ¹æ®namespaceUriæ‰¾åˆ°çš„å¯¹åº”çš„è§£æç±»ï¼Œè°ƒç”¨parse()æ–¹æ³•å®Œæˆæ ‡ç­¾çš„è§£æ</li></ul><h1 id="äºŒã€Springæ ‡ç­¾è§£ææµç¨‹"><a href="#äºŒã€Springæ ‡ç­¾è§£ææµç¨‹" class="headerlink" title="äºŒã€Springæ ‡ç­¾è§£ææµç¨‹"></a>äºŒã€Springæ ‡ç­¾è§£ææµç¨‹</h1><p>å…ˆç»™å‡ºä¸€ä¸ªæˆ‘è‡ªå·±ç”»çš„æ—¶åºå›¾<br><img src="https://cdn.jsdelivr.net/gh/zyxelva/picgo@main/csdn/20210409181752149.png" alt="å›¾1"></p><h1 id="ä¸‰ã€æºç è·Ÿè¸ª"><a href="#ä¸‰ã€æºç è·Ÿè¸ª" class="headerlink" title="ä¸‰ã€æºç è·Ÿè¸ª"></a>ä¸‰ã€æºç è·Ÿè¸ª</h1><p>å…¥å£</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">ConfigurableListableBeanFactory</span> beanFactory <span class="token operator">=</span> <span class="token function">obtainFreshBeanFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h2 id="1-obtainFreshBeanFactory"><a href="#1-obtainFreshBeanFactory" class="headerlink" title="1.obtainFreshBeanFactory()"></a>1.obtainFreshBeanFactory()</h2><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">protected</span> <span class="token class-name">ConfigurableListableBeanFactory</span> <span class="token function">obtainFreshBeanFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">//æ ¸å¿ƒæ–¹æ³•ï¼Œå¿…é¡»è¯»ï¼Œé‡è¦ç¨‹åº¦ï¼š5</span><span class="token comment">//æ¨¡æ¿æ¨¡å¼ï¼Œå­ç±»å®ç°é’©å­æ–¹æ³•</span><span class="token function">refreshBeanFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">return</span> <span class="token function">getBeanFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">protected</span> <span class="token keyword">abstract</span> <span class="token keyword">void</span> <span class="token function">refreshBeanFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">BeansException</span><span class="token punctuation">,</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="2-refreshBeanFactory"><a href="#2-refreshBeanFactory" class="headerlink" title="2.refreshBeanFactory()"></a>2.refreshBeanFactory()</h2><p>refreshBeanFactory()å®ç°ç±»ä¸ºAbstractRefreshableApplicationContext</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">protected</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">refreshBeanFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">BeansException</span> <span class="token punctuation">&#123;</span><span class="token comment">//1.å¦‚æœBeanFactoryä¸ä¸ºç©ºï¼Œåˆ™æ¸…é™¤BeanFactoryå’Œé‡Œé¢çš„å®ä¾‹</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">hasBeanFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token function">destroyBeans</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">closeBeanFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">try</span> <span class="token punctuation">&#123;</span><span class="token comment">//2.åˆ›å»ºBeanFactoryå®ä¾‹å·¥å‚</span><span class="token class-name">DefaultListableBeanFactory</span> beanFactory <span class="token operator">=</span> <span class="token function">createBeanFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>beanFactory<span class="token punctuation">.</span><span class="token function">setSerializationId</span><span class="token punctuation">(</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//3.1è®¾ç½®æ˜¯å¦å¯ä»¥å¾ªç¯ä¾èµ– allowCircularReferencesï¼Œé»˜è®¤å…è®¸</span><span class="token comment">//3.2æ˜¯å¦å…è®¸ä½¿ç”¨ç›¸åŒåç§°é‡æ–°æ³¨å†Œä¸åŒçš„beanå®ç°.</span><span class="token function">customizeBeanFactory</span><span class="token punctuation">(</span>beanFactory<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//4.è§£æxmlï¼Œå¹¶æŠŠxmlä¸­çš„æ ‡ç­¾å°è£…æˆBeanDefinitionå¯¹è±¡</span><span class="token function">loadBeanDefinitions</span><span class="token punctuation">(</span>beanFactory<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">this</span><span class="token punctuation">.</span>beanFactory <span class="token operator">=</span> beanFactory<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ApplicationContextException</span><span class="token punctuation">(</span><span class="token string">"I/O error parsing bean definition source for "</span> <span class="token operator">+</span> <span class="token function">getDisplayName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>æ³¨æ„</strong><br>customizeBeanFactory(beanFactory)ä¸­å…³äºè®¾ç½®æ˜¯å¦å¾ªç¯ä¾èµ–å’Œæ˜¯å¦å¯ä»¥è¦†ç›–beanå®šä¹‰åç§°ï¼Œå¯ä»¥é€šè¿‡applicationContextä¸Šä¸‹æ–‡æ¥ä¿®æ”¹ï¼Œä¿®æ”¹åå¿…é¡»è¦refresh()é‡æ–°åŠ è½½ã€‚å»ºè®®ä¸ä¿®æ”¹ï¼Œæ²¡æœ‰æ„ä¹‰ã€‚</p><pre class="line-numbers language-java" data-language="java"><code class="language-java">applicationContext<span class="token punctuation">.</span><span class="token function">setAllowBeanDefinitionOverriding</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>applicationContext<span class="token punctuation">.</span><span class="token function">setAllowCircularReferences</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>applicationContext<span class="token punctuation">.</span><span class="token function">refresh</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>è¿›å…¥loadBeanDefinitions()æ–¹æ³•</p><h2 id="3-loadBeanDefinitions"><a href="#3-loadBeanDefinitions" class="headerlink" title="3.loadBeanDefinitions()"></a>3.loadBeanDefinitions()</h2><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">//AbstractXmlApplicationContext</span><span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">loadBeanDefinitions</span><span class="token punctuation">(</span><span class="token class-name">DefaultListableBeanFactory</span> beanFactory<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">BeansException</span><span class="token punctuation">,</span> <span class="token class-name">IOException</span> <span class="token punctuation">&#123;</span><span class="token comment">// Create a new XmlBeanDefinitionReader for the given BeanFactory.</span><span class="token comment">//åˆ›å»ºxmlçš„è§£æå™¨ï¼Œè¿™é‡Œæ˜¯ä¸€ä¸ªå§”æ‰˜æ¨¡å¼</span><span class="token class-name">XmlBeanDefinitionReader</span> beanDefinitionReader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">XmlBeanDefinitionReader</span><span class="token punctuation">(</span>beanFactory<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// Configure the bean definition reader with this context's</span><span class="token comment">// resource loading environment.</span>beanDefinitionReader<span class="token punctuation">.</span><span class="token function">setEnvironment</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//è¿™é‡Œä¼ ä¸€ä¸ªthisè¿›å»ï¼Œå› ä¸ºApplicationContextæ˜¯å®ç°äº†ResourceLoaderæ¥å£çš„</span>beanDefinitionReader<span class="token punctuation">.</span><span class="token function">setResourceLoader</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>beanDefinitionReader<span class="token punctuation">.</span><span class="token function">setEntityResolver</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ResourceEntityResolver</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// Allow a subclass to provide custom initialization of the reader,</span><span class="token comment">// then proceed with actually loading the bean definitions.</span><span class="token function">initBeanDefinitionReader</span><span class="token punctuation">(</span>beanDefinitionReader<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//ä¸»è¦çœ‹è¿™ä¸ªæ–¹æ³•  é‡è¦ç¨‹åº¦ 5</span><span class="token function">loadBeanDefinitions</span><span class="token punctuation">(</span>beanDefinitionReader<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">/*** å§”æ‰˜ç»™XmlBeanDefinitionReaderè§£æxmlæ–‡ä»¶*/</span><span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">loadBeanDefinitions</span><span class="token punctuation">(</span><span class="token class-name">XmlBeanDefinitionReader</span> reader<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">BeansException</span><span class="token punctuation">,</span> <span class="token class-name">IOException</span> <span class="token punctuation">&#123;</span><span class="token class-name">Resource</span><span class="token punctuation">[</span><span class="token punctuation">]</span> configResources <span class="token operator">=</span> <span class="token function">getConfigResources</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>configResources <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>reader<span class="token punctuation">.</span><span class="token function">loadBeanDefinitions</span><span class="token punctuation">(</span>configResources<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">//è·å–éœ€è¦åŠ è½½çš„xmlé…ç½®æ–‡ä»¶</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> configLocations <span class="token operator">=</span> <span class="token function">getConfigLocations</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>configLocations <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>reader<span class="token punctuation">.</span><span class="token function">loadBeanDefinitions</span><span class="token punctuation">(</span>configLocations<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è¿›å…¥AbstractBeanDefinitionReader.loadBeanDefinitionsçš„é‡è½½æ–¹æ³•</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">loadBeanDefinitions</span><span class="token punctuation">(</span><span class="token class-name">String</span> location<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Resource</span><span class="token punctuation">></span></span> actualResources<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">BeanDefinitionStoreException</span> <span class="token punctuation">&#123;</span><span class="token class-name">ResourceLoader</span> resourceLoader <span class="token operator">=</span> <span class="token function">getResourceLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>resourceLoader <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BeanDefinitionStoreException</span><span class="token punctuation">(</span><span class="token string">"Cannot load bean definitions from location ["</span> <span class="token operator">+</span> location <span class="token operator">+</span> <span class="token string">"]: no ResourceLoader available"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>resourceLoader <span class="token keyword">instanceof</span> <span class="token class-name">ResourcePatternResolver</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">// Resource pattern matching available.</span><span class="token keyword">try</span> <span class="token punctuation">&#123;</span><span class="token comment">//æŠŠå­—ç¬¦ä¸²ç±»å‹çš„xmlæ–‡ä»¶è·¯å¾„ï¼Œå½¢å¦‚ï¼šclasspath*:user/**/*-context.xml,è½¬æ¢æˆResourceå¯¹è±¡ç±»å‹ï¼Œå…¶å®å°±æ˜¯ç”¨æµ</span><span class="token comment">//çš„æ–¹å¼åŠ è½½é…ç½®æ–‡ä»¶ï¼Œç„¶åå°è£…æˆResourceå¯¹è±¡ï¼Œä¸é‡è¦ï¼Œå¯ä»¥ä¸çœ‹</span><span class="token class-name">Resource</span><span class="token punctuation">[</span><span class="token punctuation">]</span> resources <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">ResourcePatternResolver</span><span class="token punctuation">)</span> resourceLoader<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getResources</span><span class="token punctuation">(</span>location<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//ä¸»è¦çœ‹è¿™ä¸ªæ–¹æ³• ** é‡è¦ç¨‹åº¦ 5</span><span class="token keyword">int</span> count <span class="token operator">=</span> <span class="token function">loadBeanDefinitions</span><span class="token punctuation">(</span>resources<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>actualResources <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span>actualResources<span class="token punctuation">,</span> resources<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isTraceEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>logger<span class="token punctuation">.</span><span class="token function">trace</span><span class="token punctuation">(</span><span class="token string">"Loaded "</span> <span class="token operator">+</span> count <span class="token operator">+</span> <span class="token string">" bean definitions from location pattern ["</span> <span class="token operator">+</span> location <span class="token operator">+</span> <span class="token string">"]"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">return</span> count<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BeanDefinitionStoreException</span><span class="token punctuation">(</span><span class="token string">"Could not resolve bean definition resource pattern ["</span> <span class="token operator">+</span> location <span class="token operator">+</span> <span class="token string">"]"</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">else</span> <span class="token punctuation">&#123;</span><span class="token comment">// Can only load single resources by absolute URL.</span><span class="token class-name">Resource</span> resource <span class="token operator">=</span> resourceLoader<span class="token punctuation">.</span><span class="token function">getResource</span><span class="token punctuation">(</span>location<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">int</span> count <span class="token operator">=</span> <span class="token function">loadBeanDefinitions</span><span class="token punctuation">(</span>resource<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>actualResources <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>actualResources<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>resource<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isTraceEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>logger<span class="token punctuation">.</span><span class="token function">trace</span><span class="token punctuation">(</span><span class="token string">"Loaded "</span> <span class="token operator">+</span> count <span class="token operator">+</span> <span class="token string">" bean definitions from location ["</span> <span class="token operator">+</span> location <span class="token operator">+</span> <span class="token string">"]"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">return</span> count<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ç„¶åè¿›å…¥</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Override</span><span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">loadBeanDefinitions</span><span class="token punctuation">(</span><span class="token class-name">Resource</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> resources<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">BeanDefinitionStoreException</span> <span class="token punctuation">&#123;</span><span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">notNull</span><span class="token punctuation">(</span>resources<span class="token punctuation">,</span> <span class="token string">"Resource array must not be null"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">int</span> count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Resource</span> resource <span class="token operator">:</span> resources<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">//æ¨¡æ¿è®¾è®¡æ¨¡å¼ï¼Œè°ƒç”¨åˆ°å­ç±»ä¸­çš„æ–¹æ³•</span>count <span class="token operator">+=</span> <span class="token function">loadBeanDefinitions</span><span class="token punctuation">(</span>resource<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">return</span> count<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è°ƒç”¨çš„æ˜¯å­ç±»XmlBeanDefinitionReaderçš„å®ç°æ–¹æ³•</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Override</span><span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">loadBeanDefinitions</span><span class="token punctuation">(</span><span class="token class-name">Resource</span> resource<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">BeanDefinitionStoreException</span> <span class="token punctuation">&#123;</span><span class="token comment">//EncodedResourceå¸¦ç¼–ç çš„å¯¹Resourceå¯¹è±¡çš„å°è£…</span><span class="token keyword">return</span> <span class="token function">loadBeanDefinitions</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">EncodedResource</span><span class="token punctuation">(</span>resource<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">loadBeanDefinitions</span><span class="token punctuation">(</span><span class="token class-name">EncodedResource</span> encodedResource<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">BeanDefinitionStoreException</span> <span class="token punctuation">&#123;</span><span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">notNull</span><span class="token punctuation">(</span>encodedResource<span class="token punctuation">,</span> <span class="token string">"EncodedResource must not be null"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isTraceEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>logger<span class="token punctuation">.</span><span class="token function">trace</span><span class="token punctuation">(</span><span class="token string">"Loading XML bean definitions from "</span> <span class="token operator">+</span> encodedResource<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">EncodedResource</span><span class="token punctuation">></span></span> currentResources <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>resourcesCurrentlyBeingLoaded<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>currentResources<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>encodedResource<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BeanDefinitionStoreException</span><span class="token punctuation">(</span><span class="token string">"Detected cyclic loading of "</span> <span class="token operator">+</span> encodedResource <span class="token operator">+</span> <span class="token string">" - check your import definitions!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">//è·å–Resourceå¯¹è±¡ä¸­çš„xmlæ–‡ä»¶æµå¯¹è±¡</span><span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token class-name">InputStream</span> inputStream <span class="token operator">=</span> encodedResource<span class="token punctuation">.</span><span class="token function">getResource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getInputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">//InputSourceæ˜¯jdkä¸­çš„sax xmlæ–‡ä»¶è§£æå¯¹è±¡</span><span class="token class-name">InputSource</span> inputSource <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">InputSource</span><span class="token punctuation">(</span>inputStream<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>encodedResource<span class="token punctuation">.</span><span class="token function">getEncoding</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>inputSource<span class="token punctuation">.</span><span class="token function">setEncoding</span><span class="token punctuation">(</span>encodedResource<span class="token punctuation">.</span><span class="token function">getEncoding</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">//ä¸»è¦çœ‹è¿™ä¸ªæ–¹æ³• **  é‡è¦ç¨‹åº¦ 5</span><span class="token keyword">return</span> <span class="token function">doLoadBeanDefinitions</span><span class="token punctuation">(</span>inputSource<span class="token punctuation">,</span> encodedResource<span class="token punctuation">.</span><span class="token function">getResource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BeanDefinitionStoreException</span><span class="token punctuation">(</span><span class="token string">"IOException parsing XML document from "</span> <span class="token operator">+</span> encodedResource<span class="token punctuation">.</span><span class="token function">getResource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">finally</span> <span class="token punctuation">&#123;</span>currentResources<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>encodedResource<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>currentResources<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">this</span><span class="token punctuation">.</span>resourcesCurrentlyBeingLoaded<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="4-doLoadBeanDefinitions"><a href="#4-doLoadBeanDefinitions" class="headerlink" title="4.doLoadBeanDefinitions()"></a>4.doLoadBeanDefinitions()</h2><p>å®Œæˆä¸¤ä¸ªåŠ¨ä½œ</p><ul><li>æŠŠinputSourceå°è£…æˆDocumentæ–‡ä»¶å¯¹è±¡</li><li>æ ¹æ®è§£æå‡ºæ¥çš„documentå¯¹è±¡ï¼Œæ‹¿åˆ°é‡Œé¢çš„æ ‡ç­¾å…ƒç´ å°è£…æˆBeanDefinition<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">protected</span> <span class="token keyword">int</span> <span class="token function">doLoadBeanDefinitions</span><span class="token punctuation">(</span><span class="token class-name">InputSource</span> inputSource<span class="token punctuation">,</span> <span class="token class-name">Resource</span> resource<span class="token punctuation">)</span><span class="token keyword">throws</span> <span class="token class-name">BeanDefinitionStoreException</span> <span class="token punctuation">&#123;</span><span class="token keyword">try</span> <span class="token punctuation">&#123;</span><span class="token comment">//æŠŠinputSource å°è£…æˆDocumentæ–‡ä»¶å¯¹è±¡ï¼Œè¿™æ˜¯jdkçš„API</span><span class="token class-name">Document</span> doc <span class="token operator">=</span> <span class="token function">doLoadDocument</span><span class="token punctuation">(</span>inputSource<span class="token punctuation">,</span> resource<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//ä¸»è¦çœ‹è¿™ä¸ªæ–¹æ³•ï¼Œæ ¹æ®è§£æå‡ºæ¥çš„documentå¯¹è±¡ï¼Œæ‹¿åˆ°é‡Œé¢çš„æ ‡ç­¾å…ƒç´ å°è£…æˆBeanDefinition</span><span class="token keyword">int</span> count <span class="token operator">=</span> <span class="token function">registerBeanDefinitions</span><span class="token punctuation">(</span>doc<span class="token punctuation">,</span> resource<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"Loaded "</span> <span class="token operator">+</span> count <span class="token operator">+</span> <span class="token string">" bean definitions from "</span> <span class="token operator">+</span> resource<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">return</span> count<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">BeanDefinitionStoreException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">throw</span> ex<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">SAXParseException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">XmlBeanDefinitionStoreException</span><span class="token punctuation">(</span>resource<span class="token punctuation">.</span><span class="token function">getDescription</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">"Line "</span> <span class="token operator">+</span> ex<span class="token punctuation">.</span><span class="token function">getLineNumber</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" in XML document from "</span> <span class="token operator">+</span> resource <span class="token operator">+</span> <span class="token string">" is invalid"</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">SAXException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">XmlBeanDefinitionStoreException</span><span class="token punctuation">(</span>resource<span class="token punctuation">.</span><span class="token function">getDescription</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">"XML document from "</span> <span class="token operator">+</span> resource <span class="token operator">+</span> <span class="token string">" is invalid"</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ParserConfigurationException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BeanDefinitionStoreException</span><span class="token punctuation">(</span>resource<span class="token punctuation">.</span><span class="token function">getDescription</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">"Parser configuration exception parsing XML from "</span> <span class="token operator">+</span> resource<span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BeanDefinitionStoreException</span><span class="token punctuation">(</span>resource<span class="token punctuation">.</span><span class="token function">getDescription</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">"IOException parsing XML document from "</span> <span class="token operator">+</span> resource<span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> ex<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BeanDefinitionStoreException</span><span class="token punctuation">(</span>resource<span class="token punctuation">.</span><span class="token function">getDescription</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">"Unexpected exception parsing XML document from "</span> <span class="token operator">+</span> resource<span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ul><h2 id="5-registerBeanDefinitions"><a href="#5-registerBeanDefinitions" class="headerlink" title="5.registerBeanDefinitions()"></a>5.registerBeanDefinitions()</h2><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">registerBeanDefinitions</span><span class="token punctuation">(</span><span class="token class-name">Document</span> doc<span class="token punctuation">,</span> <span class="token class-name">Resource</span> resource<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">BeanDefinitionStoreException</span> <span class="token punctuation">&#123;</span><span class="token comment">//åˆæ¥ä¸€è®°å§”æ‰˜æ¨¡å¼ï¼ŒBeanDefinitionDocumentReaderå§”æ‰˜è¿™ä¸ªç±»è¿›è¡Œdocumentçš„è§£æ</span><span class="token class-name">BeanDefinitionDocumentReader</span> documentReader <span class="token operator">=</span> <span class="token function">createBeanDefinitionDocumentReader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">int</span> countBefore <span class="token operator">=</span> <span class="token function">getRegistry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBeanDefinitionCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//ä¸»è¦çœ‹è¿™ä¸ªæ–¹æ³•ï¼ŒcreateReaderContext(resource) XmlReaderContextä¸Šä¸‹æ–‡ï¼Œå°è£…äº†XmlBeanDefinitionReaderå¯¹è±¡</span>documentReader<span class="token punctuation">.</span><span class="token function">registerBeanDefinitions</span><span class="token punctuation">(</span>doc<span class="token punctuation">,</span> <span class="token function">createReaderContext</span><span class="token punctuation">(</span>resource<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">return</span> <span class="token function">getRegistry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBeanDefinitionCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> countBefore<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>äº¤ç”±DefaultBeanDefinitionDocumentReader.registerBeanDefinitions()å¤„ç†</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">registerBeanDefinitions</span><span class="token punctuation">(</span><span class="token class-name">Document</span> doc<span class="token punctuation">,</span> <span class="token class-name">XmlReaderContext</span> readerContext<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">this</span><span class="token punctuation">.</span>readerContext <span class="token operator">=</span> readerContext<span class="token punctuation">;</span><span class="token comment">//ä¸»è¦çœ‹è¿™ä¸ªæ–¹æ³•ï¼ŒæŠŠrootèŠ‚ç‚¹ä¼ è¿›å»</span><span class="token function">doRegisterBeanDefinitions</span><span class="token punctuation">(</span>doc<span class="token punctuation">.</span><span class="token function">getDocumentElement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">doRegisterBeanDefinitions</span><span class="token punctuation">(</span><span class="token class-name">Element</span> root<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token class-name">BeanDefinitionParserDelegate</span> parent <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>delegate<span class="token punctuation">;</span><span class="token keyword">this</span><span class="token punctuation">.</span>delegate <span class="token operator">=</span> <span class="token function">createDelegate</span><span class="token punctuation">(</span><span class="token function">getReaderContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> root<span class="token punctuation">,</span> parent<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>delegate<span class="token punctuation">.</span><span class="token function">isDefaultNamespace</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token class-name">String</span> profileSpec <span class="token operator">=</span> root<span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span><span class="token constant">PROFILE_ATTRIBUTE</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">hasText</span><span class="token punctuation">(</span>profileSpec<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> specifiedProfiles <span class="token operator">=</span> <span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">tokenizeToStringArray</span><span class="token punctuation">(</span>profileSpec<span class="token punctuation">,</span> <span class="token class-name">BeanDefinitionParserDelegate</span><span class="token punctuation">.</span><span class="token constant">MULTI_VALUE_ATTRIBUTE_DELIMITERS</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// We cannot use Profiles.of(...) since profile expressions are not supported</span><span class="token comment">// in XML config. See SPR-12458 for details.</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">getReaderContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">acceptsProfiles</span><span class="token punctuation">(</span>specifiedProfiles<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"Skipped XML bean definition file due to specified profiles ["</span> <span class="token operator">+</span> profileSpec <span class="token operator">+</span><span class="token string">"] not matching: "</span> <span class="token operator">+</span> <span class="token function">getReaderContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getResource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">return</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token function">preProcessXml</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//ä¸»è¦çœ‹è¿™ä¸ªæ–¹æ³•ï¼Œæ ‡ç­¾å…·ä½“è§£æè¿‡ç¨‹</span><span class="token function">parseBeanDefinitions</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>delegate<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">postProcessXml</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">this</span><span class="token punctuation">.</span>delegate <span class="token operator">=</span> parent<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">parseBeanDefinitions</span><span class="token punctuation">(</span><span class="token class-name">Element</span> root<span class="token punctuation">,</span> <span class="token class-name">BeanDefinitionParserDelegate</span> delegate<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>delegate<span class="token punctuation">.</span><span class="token function">isDefaultNamespace</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token class-name">NodeList</span> nl <span class="token operator">=</span> root<span class="token punctuation">.</span><span class="token function">getChildNodes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> nl<span class="token punctuation">.</span><span class="token function">getLength</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token class-name">Node</span> node <span class="token operator">=</span> nl<span class="token punctuation">.</span><span class="token function">item</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>node <span class="token keyword">instanceof</span> <span class="token class-name">Element</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token class-name">Element</span> ele <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Element</span><span class="token punctuation">)</span> node<span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>delegate<span class="token punctuation">.</span><span class="token function">isDefaultNamespace</span><span class="token punctuation">(</span>ele<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">//é»˜è®¤æ ‡ç­¾è§£æ</span><span class="token function">parseDefaultElement</span><span class="token punctuation">(</span>ele<span class="token punctuation">,</span> delegate<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">else</span> <span class="token punctuation">&#123;</span><span class="token comment">//è‡ªå®šä¹‰æ ‡ç­¾è§£æ</span>delegate<span class="token punctuation">.</span><span class="token function">parseCustomElement</span><span class="token punctuation">(</span>ele<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">else</span> <span class="token punctuation">&#123;</span>delegate<span class="token punctuation">.</span><span class="token function">parseCustomElement</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å¯ä»¥çœ‹å‡ºæœ‰ä¸¤ç§è§£æçš„ç±»å‹ï¼š</p><ul><li>Springé»˜è®¤æ ‡ç­¾</li><li>è‡ªå®šä¹‰æ ‡ç­¾</li></ul><p>æˆ‘ä»¬å…ˆçœ‹é»˜è®¤æ ‡ç­¾æ˜¯æ€ä¹ˆè§£æçš„ã€‚</p><h2 id="6-parseDefaultElement"><a href="#6-parseDefaultElement" class="headerlink" title="6.parseDefaultElement()"></a>6.parseDefaultElement()</h2><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">parseDefaultElement</span><span class="token punctuation">(</span><span class="token class-name">Element</span> ele<span class="token punctuation">,</span> <span class="token class-name">BeanDefinitionParserDelegate</span> delegate<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">//importæ ‡ç­¾è§£æ  é‡è¦ç¨‹åº¦ 1 ï¼Œå¯çœ‹å¯ä¸çœ‹</span><span class="token keyword">if</span> <span class="token punctuation">(</span>delegate<span class="token punctuation">.</span><span class="token function">nodeNameEquals</span><span class="token punctuation">(</span>ele<span class="token punctuation">,</span> <span class="token constant">IMPORT_ELEMENT</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token function">importBeanDefinitionResource</span><span class="token punctuation">(</span>ele<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">//aliasæ ‡ç­¾è§£æ åˆ«åæ ‡ç­¾  é‡è¦ç¨‹åº¦ 1 ï¼Œå¯çœ‹å¯ä¸çœ‹</span><span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>delegate<span class="token punctuation">.</span><span class="token function">nodeNameEquals</span><span class="token punctuation">(</span>ele<span class="token punctuation">,</span> <span class="token constant">ALIAS_ELEMENT</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token function">processAliasRegistration</span><span class="token punctuation">(</span>ele<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">//beanæ ‡ç­¾ï¼Œé‡è¦ç¨‹åº¦  5ï¼Œå¿…é¡»çœ‹</span><span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>delegate<span class="token punctuation">.</span><span class="token function">nodeNameEquals</span><span class="token punctuation">(</span>ele<span class="token punctuation">,</span> <span class="token constant">BEAN_ELEMENT</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token function">processBeanDefinition</span><span class="token punctuation">(</span>ele<span class="token punctuation">,</span> delegate<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>delegate<span class="token punctuation">.</span><span class="token function">nodeNameEquals</span><span class="token punctuation">(</span>ele<span class="token punctuation">,</span> <span class="token constant">NESTED_BEANS_ELEMENT</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">// recurse</span><span class="token function">doRegisterBeanDefinitions</span><span class="token punctuation">(</span>ele<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>é»˜è®¤æ ‡ç­¾ä¸»è¦è§£æ</p><ul><li>import</li><li>alias</li><li>bean</li><li>beans</li></ul><p>è¿™é‡Œæˆ‘ä¸»è¦è·Ÿè¸ªbeanæ ‡ç­¾çš„è§£æè¿‡ç¨‹ï¼š</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">processBeanDefinition</span><span class="token punctuation">(</span><span class="token class-name">Element</span> ele<span class="token punctuation">,</span> <span class="token class-name">BeanDefinitionParserDelegate</span> delegate<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">//é‡ç‚¹çœ‹è¿™ä¸ªæ–¹æ³•ï¼Œé‡è¦ç¨‹åº¦ 5 ï¼Œè§£ædocumentï¼Œå°è£…æˆBeanDefinition</span><span class="token class-name">BeanDefinitionHolder</span> bdHolder <span class="token operator">=</span> delegate<span class="token punctuation">.</span><span class="token function">parseBeanDefinitionElement</span><span class="token punctuation">(</span>ele<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>bdHolder <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">//è¯¥æ–¹æ³•åŠŸèƒ½ä¸é‡è¦ï¼Œè®¾è®¡æ¨¡å¼é‡ç‚¹çœ‹ä¸€ä¸‹ï¼Œè£…é¥°è€…è®¾è®¡æ¨¡å¼ï¼ŒåŠ ä¸ŠSPIè®¾è®¡æ€æƒ³</span>bdHolder <span class="token operator">=</span> delegate<span class="token punctuation">.</span><span class="token function">decorateBeanDefinitionIfRequired</span><span class="token punctuation">(</span>ele<span class="token punctuation">,</span> bdHolder<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">try</span> <span class="token punctuation">&#123;</span><span class="token comment">//å®Œæˆdocumentåˆ°BeanDefinitionå¯¹è±¡è½¬æ¢åï¼Œå¯¹BeanDefinitionå¯¹è±¡è¿›è¡Œç¼“å­˜æ³¨å†Œ</span><span class="token comment">// Register the final decorated instance.</span><span class="token class-name">BeanDefinitionReaderUtils</span><span class="token punctuation">.</span><span class="token function">registerBeanDefinition</span><span class="token punctuation">(</span>bdHolder<span class="token punctuation">,</span> <span class="token function">getReaderContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getRegistry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">BeanDefinitionStoreException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token function">getReaderContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"Failed to register bean definition with name '"</span> <span class="token operator">+</span>bdHolder<span class="token punctuation">.</span><span class="token function">getBeanName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"'"</span><span class="token punctuation">,</span> ele<span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">// Send registration event.</span><span class="token function">getReaderContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">fireComponentRegistered</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BeanComponentDefinition</span><span class="token punctuation">(</span>bdHolder<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>BeanDefinitionHolderè¿™ä¸ªç±»æœ‰ä¸¤ä¸ªå¾ˆé‡è¦çš„å±æ€§ï¼šbeanDefinitionå’ŒbeanName</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">BeanDefinitionHolder</span> <span class="token keyword">implements</span> <span class="token class-name">BeanMetadataElement</span> <span class="token punctuation">&#123;</span><span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">BeanDefinition</span> beanDefinition<span class="token punctuation">;</span><span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">String</span> beanName<span class="token punctuation">;</span><span class="token comment">//aliasesä½œç”¨ï¼šé€šè¿‡aliasesæ‰¾åˆ°beanNameï¼Œæ ¹æ®beanNameæ‹¿åˆ°beanDefinitionå¯¹è±¡ã€‚</span><span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> aliases<span class="token punctuation">;</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/*** BeanDefinitionParserDelegate* Description: è§£æElementå¹¶è¿”å› BeanDefinitionHolder*/</span><span class="token keyword">public</span> <span class="token class-name">BeanDefinitionHolder</span> <span class="token function">parseBeanDefinitionElement</span><span class="token punctuation">(</span><span class="token class-name">Element</span> ele<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">BeanDefinition</span> containingBean<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token class-name">String</span> id <span class="token operator">=</span> ele<span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span><span class="token constant">ID_ATTRIBUTE</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">String</span> nameAttr <span class="token operator">=</span> ele<span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span><span class="token constant">NAME_ATTRIBUTE</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> aliases <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">hasLength</span><span class="token punctuation">(</span>nameAttr<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> nameArr <span class="token operator">=</span> <span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">tokenizeToStringArray</span><span class="token punctuation">(</span>nameAttr<span class="token punctuation">,</span> <span class="token constant">MULTI_VALUE_ATTRIBUTE_DELIMITERS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>aliases<span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span><span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span>nameArr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token class-name">String</span> beanName <span class="token operator">=</span> id<span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">hasText</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>aliases<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>beanName <span class="token operator">=</span> aliases<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isTraceEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>logger<span class="token punctuation">.</span><span class="token function">trace</span><span class="token punctuation">(</span><span class="token string">"No XML 'id' specified - using '"</span> <span class="token operator">+</span> beanName <span class="token operator">+</span><span class="token string">"' as bean name and "</span> <span class="token operator">+</span> aliases <span class="token operator">+</span> <span class="token string">" as aliases"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token comment">// æ£€æŸ¥ beanName æ˜¯å¦é‡å¤</span><span class="token keyword">if</span> <span class="token punctuation">(</span>containingBean <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token function">checkNameUniqueness</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> aliases<span class="token punctuation">,</span> ele<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">// é‡ç‚¹ï¼Œè§£æBeanDefinitionElement</span><span class="token class-name">AbstractBeanDefinition</span> beanDefinition <span class="token operator">=</span> <span class="token function">parseBeanDefinitionElement</span><span class="token punctuation">(</span>ele<span class="token punctuation">,</span> beanName<span class="token punctuation">,</span> containingBean<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// æ­¤å¤„çœç•¥æ²¡ç”¨çš„ä»£ç </span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> aliasesArray <span class="token operator">=</span> <span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">toStringArray</span><span class="token punctuation">(</span>aliases<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">BeanDefinitionHolder</span><span class="token punctuation">(</span>beanDefinition<span class="token punctuation">,</span> beanName<span class="token punctuation">,</span> aliasesArray<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è¿›å…¥BeanDefinitionParserDelegate.parseBeanDefinitionElement()æ–¹æ³•</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token class-name">AbstractBeanDefinition</span> <span class="token function">parseBeanDefinitionElement</span><span class="token punctuation">(</span><span class="token class-name">Element</span> ele<span class="token punctuation">,</span> <span class="token class-name">String</span> beanName<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">BeanDefinition</span> containingBean<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">this</span><span class="token punctuation">.</span>parseState<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BeanEntry</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">String</span> className <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>ele<span class="token punctuation">.</span><span class="token function">hasAttribute</span><span class="token punctuation">(</span><span class="token constant">CLASS_ATTRIBUTE</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>className <span class="token operator">=</span> ele<span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span><span class="token constant">CLASS_ATTRIBUTE</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token class-name">String</span> parent <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>ele<span class="token punctuation">.</span><span class="token function">hasAttribute</span><span class="token punctuation">(</span><span class="token constant">PARENT_ATTRIBUTE</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>parent <span class="token operator">=</span> ele<span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span><span class="token constant">PARENT_ATTRIBUTE</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">try</span> <span class="token punctuation">&#123;</span><span class="token comment">//åˆ›å»ºGenericBeanDefinitionå¯¹è±¡</span><span class="token class-name">AbstractBeanDefinition</span> bd <span class="token operator">=</span> <span class="token function">createBeanDefinition</span><span class="token punctuation">(</span>className<span class="token punctuation">,</span> parent<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//è§£æbeanæ ‡ç­¾çš„å±æ€§ï¼Œå¹¶æŠŠè§£æå‡ºæ¥çš„å±æ€§è®¾ç½®åˆ°BeanDefinitionå¯¹è±¡ä¸­</span><span class="token function">parseBeanDefinitionAttributes</span><span class="token punctuation">(</span>ele<span class="token punctuation">,</span> beanName<span class="token punctuation">,</span> containingBean<span class="token punctuation">,</span> bd<span class="token punctuation">)</span><span class="token punctuation">;</span>bd<span class="token punctuation">.</span><span class="token function">setDescription</span><span class="token punctuation">(</span><span class="token class-name">DomUtils</span><span class="token punctuation">.</span><span class="token function">getChildElementValueByTagName</span><span class="token punctuation">(</span>ele<span class="token punctuation">,</span> <span class="token constant">DESCRIPTION_ELEMENT</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//è§£æbeanä¸­çš„metaæ ‡ç­¾</span><span class="token function">parseMetaElements</span><span class="token punctuation">(</span>ele<span class="token punctuation">,</span> bd<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//è§£æbeanä¸­çš„lookup-methodæ ‡ç­¾  é‡è¦ç¨‹åº¦ï¼š2ï¼Œå¯çœ‹å¯ä¸çœ‹</span><span class="token function">parseLookupOverrideSubElements</span><span class="token punctuation">(</span>ele<span class="token punctuation">,</span> bd<span class="token punctuation">.</span><span class="token function">getMethodOverrides</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//è§£æbeanä¸­çš„replaced-methodæ ‡ç­¾  é‡è¦ç¨‹åº¦ï¼š2ï¼Œå¯çœ‹å¯ä¸çœ‹</span><span class="token function">parseReplacedMethodSubElements</span><span class="token punctuation">(</span>ele<span class="token punctuation">,</span> bd<span class="token punctuation">.</span><span class="token function">getMethodOverrides</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//è§£æbeanä¸­çš„constructor-argæ ‡ç­¾  é‡è¦ç¨‹åº¦ï¼š2ï¼Œå¯çœ‹å¯ä¸çœ‹</span><span class="token function">parseConstructorArgElements</span><span class="token punctuation">(</span>ele<span class="token punctuation">,</span> bd<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//è§£æbeanä¸­çš„propertyæ ‡ç­¾  é‡è¦ç¨‹åº¦ï¼š2ï¼Œå¯çœ‹å¯ä¸çœ‹</span><span class="token function">parsePropertyElements</span><span class="token punctuation">(</span>ele<span class="token punctuation">,</span> bd<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//å¯ä»¥ä¸çœ‹ï¼Œç”¨ä¸åˆ°</span><span class="token function">parseQualifierElements</span><span class="token punctuation">(</span>ele<span class="token punctuation">,</span> bd<span class="token punctuation">)</span><span class="token punctuation">;</span>bd<span class="token punctuation">.</span><span class="token function">setResource</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>readerContext<span class="token punctuation">.</span><span class="token function">getResource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>bd<span class="token punctuation">.</span><span class="token function">setSource</span><span class="token punctuation">(</span><span class="token function">extractSource</span><span class="token punctuation">(</span>ele<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">return</span> bd<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ClassNotFoundException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"Bean class ["</span> <span class="token operator">+</span> className <span class="token operator">+</span> <span class="token string">"] not found"</span><span class="token punctuation">,</span> ele<span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">NoClassDefFoundError</span> err<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"Class that bean class ["</span> <span class="token operator">+</span> className <span class="token operator">+</span> <span class="token string">"] depends on not found"</span><span class="token punctuation">,</span> ele<span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> ex<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"Unexpected failure during bean definition parsing"</span><span class="token punctuation">,</span> ele<span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">finally</span> <span class="token punctuation">&#123;</span><span class="token keyword">this</span><span class="token punctuation">.</span>parseState<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å…¶ä¸­ï¼Œ</p><ul><li>parseBeanDefinitionAttributesï¼šè´Ÿè´£è§£æ&lt;bean&gt;å±æ€§ï¼Œå½¢å¦‚ï¼š<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>com.enjoy.jack.bean.Student<span class="token punctuation">"</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>student2<span class="token punctuation">"</span></span> <span class="token attr-name"><span class="token namespace">p:</span>username</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>1234<span class="token punctuation">"</span></span> <span class="token attr-name">factory-bean</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token punctuation">"</span></span> <span class="token attr-name">factory-method</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token punctuation">"</span></span> <span class="token attr-name">init-method</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token punctuation">"</span></span> <span class="token attr-name">abstract</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span> <span class="token attr-name">parent</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token punctuation">"</span></span> <span class="token attr-name">lazy-init</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span> <span class="token attr-name">primary</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li>parseMetaElementsï¼šè´Ÿè´£è§£æbeanæ ‡ç­¾ä¸‹çš„&lt;meta&gt;æ ‡ç­¾ï¼Œå½¢å¦‚ï¼š<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>com.enjoy.jack.bean.Student<span class="token punctuation">"</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>student2<span class="token punctuation">"</span></span> <span class="token attr-name"><span class="token namespace">p:</span>username</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>1234<span class="token punctuation">"</span></span> <span class="token attr-name">factory-bean</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token punctuation">"</span></span> <span class="token attr-name">factory-method</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token punctuation">"</span></span> <span class="token attr-name">init-method</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token punctuation">"</span></span> <span class="token attr-name">abstract</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span> <span class="token attr-name">parent</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token punctuation">"</span></span> <span class="token attr-name">lazy-init</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span> <span class="token attr-name">primary</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>description</span><span class="token punctuation">></span></span>è¿™ä¸ªæ˜¯student<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>description</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">key</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>name1<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Jack<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">key</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>name2<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Dafei<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li>parseLookupOverrideSubElementsï¼šè´Ÿè´£è§£æ&lt;lookup-method&gt;ï¼Œå½¢å¦‚ï¼š<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>people<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>com.enjoy.jack.bean.ShowSixClass<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>lookup-method</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>getPeople<span class="token punctuation">"</span></span> <span class="token attr-name">bean</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>woman<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>lookup-method</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre></li><li>parseReplacedMethodSubElementsï¼šè´Ÿè´£è§£æ&lt;replaced-method&gt;ï¼Œå½¢å¦‚ï¼š<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>originClass<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>com.enjoy.jack.bean.OriginClass<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>replaced-method</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>method<span class="token punctuation">"</span></span> <span class="token attr-name">replacer</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>repalceClass<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>arg-type</span> <span class="token attr-name">match</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>java.lang.String<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>replaced-method</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li>parseConstructorArgElementsï¼šè´Ÿè´£è§£æ&lt;constructor-arg&gt;ï¼Œå½¢å¦‚ï¼š<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>com.enjoy.jack.bean.ConstructorArgBean<span class="token punctuation">"</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>constructorArgBean<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>constructor-arg</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>username<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Jack<span class="token punctuation">"</span></span> <span class="token attr-name">index</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>0<span class="token punctuation">"</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>java.lang.String<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>constructor-arg</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>password<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>123<span class="token punctuation">"</span></span> <span class="token attr-name">index</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>1<span class="token punctuation">"</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>java.lang.String<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre></li><li>parsePropertyElementsï¼šè´Ÿè´£è§£æ&lt;property&gt;ï¼Œå½¢å¦‚ï¼š<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>com.enjoy.jack.bean.PropertyBean<span class="token punctuation">"</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>propertyBean<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>username<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Jack<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>password<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>123<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>å¦å¤–ï¼Œæ³¨æ„è¿™å‡ ç‚¹ï¼š</li><li>&lt;bean&gt;æ ‡ç­¾è§£æå®Œæˆï¼Œä¼šç»Ÿä¸€æ”¾åˆ°BeanDefinitionä¸­ã€‚</li><li>&lt;lookup-method&gt;ã€&lt;replaced-method&gt;ã€&lt;property&gt;è¿™ç§å­æ ‡ç­¾ä¼šæ”¾åˆ°MutablePropertyValues ç±»ä¸­ã€‚</li><li>&lt;constructor-arg&gt;å­æ ‡ç­¾ä¼šæ”¾åˆ° ConstructorArgumentValues ç±»ä¸­ã€‚<br>åé¢ä¸¤ç‚¹å¯ä»¥åœ¨processBeanDefinition()æ–¹æ³•ä¸­ï¼Œåœ¨å®Œæˆbeanæ ‡ç­¾è§£æå®Œåçš„è£…é¥°æ–¹æ³•<pre class="line-numbers language-java" data-language="java"><code class="language-java">bdHolder <span class="token operator">=</span> delegate<span class="token punctuation">.</span><span class="token function">decorateBeanDefinitionIfRequired</span><span class="token punctuation">(</span>ele<span class="token punctuation">,</span> bdHolder<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>å¯ä»¥è¿½æº¯åˆ°ã€‚è¿™é‡Œä¸åšè·Ÿè¸ªã€‚æˆ‘è¿™é‡Œé‡ç‚¹çœ‹çœ‹&lt;bean&gt;æ ‡ç­¾çš„è§£ææ–¹æ³•parseBeanDefinitionAttributes():<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token class-name">AbstractBeanDefinition</span> <span class="token function">parseBeanDefinitionAttributes</span><span class="token punctuation">(</span><span class="token class-name">Element</span> ele<span class="token punctuation">,</span> <span class="token class-name">String</span> beanName<span class="token punctuation">,</span><span class="token annotation punctuation">@Nullable</span> <span class="token class-name">BeanDefinition</span> containingBean<span class="token punctuation">,</span> <span class="token class-name">AbstractBeanDefinition</span> bd<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>ele<span class="token punctuation">.</span><span class="token function">hasAttribute</span><span class="token punctuation">(</span><span class="token constant">SINGLETON_ATTRIBUTE</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"Old 1.x 'singleton' attribute in use - upgrade to 'scope' declaration"</span><span class="token punctuation">,</span> ele<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>ele<span class="token punctuation">.</span><span class="token function">hasAttribute</span><span class="token punctuation">(</span><span class="token constant">SCOPE_ATTRIBUTE</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>bd<span class="token punctuation">.</span><span class="token function">setScope</span><span class="token punctuation">(</span>ele<span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span><span class="token constant">SCOPE_ATTRIBUTE</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>containingBean <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">// Take default from containing bean in case of an inner bean definition.</span>bd<span class="token punctuation">.</span><span class="token function">setScope</span><span class="token punctuation">(</span>containingBean<span class="token punctuation">.</span><span class="token function">getScope</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>ele<span class="token punctuation">.</span><span class="token function">hasAttribute</span><span class="token punctuation">(</span><span class="token constant">ABSTRACT_ATTRIBUTE</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>bd<span class="token punctuation">.</span><span class="token function">setAbstract</span><span class="token punctuation">(</span><span class="token constant">TRUE_VALUE</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>ele<span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span><span class="token constant">ABSTRACT_ATTRIBUTE</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token class-name">String</span> lazyInit <span class="token operator">=</span> ele<span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span><span class="token constant">LAZY_INIT_ATTRIBUTE</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDefaultValue</span><span class="token punctuation">(</span>lazyInit<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>lazyInit <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>defaults<span class="token punctuation">.</span><span class="token function">getLazyInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span>bd<span class="token punctuation">.</span><span class="token function">setLazyInit</span><span class="token punctuation">(</span><span class="token constant">TRUE_VALUE</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>lazyInit<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">String</span> autowire <span class="token operator">=</span> ele<span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span><span class="token constant">AUTOWIRE_ATTRIBUTE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>bd<span class="token punctuation">.</span><span class="token function">setAutowireMode</span><span class="token punctuation">(</span><span class="token function">getAutowireMode</span><span class="token punctuation">(</span>autowire<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>ele<span class="token punctuation">.</span><span class="token function">hasAttribute</span><span class="token punctuation">(</span><span class="token constant">DEPENDS_ON_ATTRIBUTE</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token class-name">String</span> dependsOn <span class="token operator">=</span> ele<span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span><span class="token constant">DEPENDS_ON_ATTRIBUTE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>bd<span class="token punctuation">.</span><span class="token function">setDependsOn</span><span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">tokenizeToStringArray</span><span class="token punctuation">(</span>dependsOn<span class="token punctuation">,</span> <span class="token constant">MULTI_VALUE_ATTRIBUTE_DELIMITERS</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token class-name">String</span> autowireCandidate <span class="token operator">=</span> ele<span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span><span class="token constant">AUTOWIRE_CANDIDATE_ATTRIBUTE</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDefaultValue</span><span class="token punctuation">(</span>autowireCandidate<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token class-name">String</span> candidatePattern <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>defaults<span class="token punctuation">.</span><span class="token function">getAutowireCandidates</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>candidatePattern <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> patterns <span class="token operator">=</span> <span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">commaDelimitedListToStringArray</span><span class="token punctuation">(</span>candidatePattern<span class="token punctuation">)</span><span class="token punctuation">;</span>bd<span class="token punctuation">.</span><span class="token function">setAutowireCandidate</span><span class="token punctuation">(</span><span class="token class-name">PatternMatchUtils</span><span class="token punctuation">.</span><span class="token function">simpleMatch</span><span class="token punctuation">(</span>patterns<span class="token punctuation">,</span> beanName<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">else</span> <span class="token punctuation">&#123;</span>bd<span class="token punctuation">.</span><span class="token function">setAutowireCandidate</span><span class="token punctuation">(</span><span class="token constant">TRUE_VALUE</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>autowireCandidate<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>ele<span class="token punctuation">.</span><span class="token function">hasAttribute</span><span class="token punctuation">(</span><span class="token constant">PRIMARY_ATTRIBUTE</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>bd<span class="token punctuation">.</span><span class="token function">setPrimary</span><span class="token punctuation">(</span><span class="token constant">TRUE_VALUE</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>ele<span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span><span class="token constant">PRIMARY_ATTRIBUTE</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>ele<span class="token punctuation">.</span><span class="token function">hasAttribute</span><span class="token punctuation">(</span><span class="token constant">INIT_METHOD_ATTRIBUTE</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token class-name">String</span> initMethodName <span class="token operator">=</span> ele<span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span><span class="token constant">INIT_METHOD_ATTRIBUTE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>bd<span class="token punctuation">.</span><span class="token function">setInitMethodName</span><span class="token punctuation">(</span>initMethodName<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>defaults<span class="token punctuation">.</span><span class="token function">getInitMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>bd<span class="token punctuation">.</span><span class="token function">setInitMethodName</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>defaults<span class="token punctuation">.</span><span class="token function">getInitMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>bd<span class="token punctuation">.</span><span class="token function">setEnforceInitMethod</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>ele<span class="token punctuation">.</span><span class="token function">hasAttribute</span><span class="token punctuation">(</span><span class="token constant">DESTROY_METHOD_ATTRIBUTE</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token class-name">String</span> destroyMethodName <span class="token operator">=</span> ele<span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span><span class="token constant">DESTROY_METHOD_ATTRIBUTE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>bd<span class="token punctuation">.</span><span class="token function">setDestroyMethodName</span><span class="token punctuation">(</span>destroyMethodName<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>defaults<span class="token punctuation">.</span><span class="token function">getDestroyMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>bd<span class="token punctuation">.</span><span class="token function">setDestroyMethodName</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>defaults<span class="token punctuation">.</span><span class="token function">getDestroyMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>bd<span class="token punctuation">.</span><span class="token function">setEnforceDestroyMethod</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>ele<span class="token punctuation">.</span><span class="token function">hasAttribute</span><span class="token punctuation">(</span><span class="token constant">FACTORY_METHOD_ATTRIBUTE</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>bd<span class="token punctuation">.</span><span class="token function">setFactoryMethodName</span><span class="token punctuation">(</span>ele<span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span><span class="token constant">FACTORY_METHOD_ATTRIBUTE</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>ele<span class="token punctuation">.</span><span class="token function">hasAttribute</span><span class="token punctuation">(</span><span class="token constant">FACTORY_BEAN_ATTRIBUTE</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>bd<span class="token punctuation">.</span><span class="token function">setFactoryBeanName</span><span class="token punctuation">(</span>ele<span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span><span class="token constant">FACTORY_BEAN_ATTRIBUTE</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">return</span> bd<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>å¯ä»¥å¯¹åº”ä¸Šxml:<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>com.enjoy.jack.bean.Student<span class="token punctuation">"</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>student2<span class="token punctuation">"</span></span> <span class="token attr-name"><span class="token namespace">p:</span>username</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>1234<span class="token punctuation">"</span></span> <span class="token attr-name">factory-bean</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token punctuation">"</span></span> <span class="token attr-name">factory-method</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token punctuation">"</span></span> <span class="token attr-name">init-method</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token punctuation">"</span></span> <span class="token attr-name">abstract</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span> <span class="token attr-name">parent</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token punctuation">"</span></span> <span class="token attr-name">lazy-init</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span> <span class="token attr-name">primary</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>&lt;bean&gt;æ ‡ç­¾è§£æè¿‡ç¨‹çš„ä»£ç è·Ÿè¸ªåˆ°è¿™é‡Œï¼Œå›åˆ°DefaultBeanDefinitionDocumentReaderçš„ processBeanDefinition() æ–¹æ³•ç»§ç»­å¾€ä¸‹èµ°ï¼Œç¬¬ä¸€æ­¥å·²ç»å¯¹BeanDefinitionå±æ€§è§£æå®Œæˆï¼Œè¿”å› BeanDefinitionHolder å¯¹è±¡ã€‚ç¬¬äºŒæ­¥è£…é¥°çš„è¿‡ç¨‹è¿™é‡Œä¸è·Ÿäº†ã€‚æ¥ä¸‹æ¥è·Ÿä¸‹æ³¨å†Œ registerBeanDefinitionçš„è¿‡ç¨‹ï¼ˆç¬¬ä¸‰æ­¥ï¼‰ã€‚<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">processBeanDefinition</span><span class="token punctuation">(</span><span class="token class-name">Element</span> ele<span class="token punctuation">,</span> <span class="token class-name">BeanDefinitionParserDelegate</span> delegate<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">//1.é‡ç‚¹çœ‹è¿™ä¸ªæ–¹æ³•ï¼Œé‡è¦ç¨‹åº¦ 5 ï¼Œè§£ædocumentï¼Œå°è£…æˆBeanDefinition</span><span class="token class-name">BeanDefinitionHolder</span> bdHolder <span class="token operator">=</span> delegate<span class="token punctuation">.</span><span class="token function">parseBeanDefinitionElement</span><span class="token punctuation">(</span>ele<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>bdHolder <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">//2.è¯¥æ–¹æ³•åŠŸèƒ½ä¸é‡è¦ï¼Œè®¾è®¡æ¨¡å¼é‡ç‚¹çœ‹ä¸€ä¸‹ï¼Œè£…é¥°è€…è®¾è®¡æ¨¡å¼ï¼ŒåŠ ä¸ŠSPIè®¾è®¡æ€æƒ³</span>bdHolder <span class="token operator">=</span> delegate<span class="token punctuation">.</span><span class="token function">decorateBeanDefinitionIfRequired</span><span class="token punctuation">(</span>ele<span class="token punctuation">,</span> bdHolder<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">try</span> <span class="token punctuation">&#123;</span><span class="token comment">//3.å®Œæˆdocumentåˆ°BeanDefinitionå¯¹è±¡è½¬æ¢åï¼Œå¯¹BeanDefinitionå¯¹è±¡è¿›è¡Œç¼“å­˜æ³¨å†Œ</span><span class="token comment">// Register the final decorated instance.</span><span class="token class-name">BeanDefinitionReaderUtils</span><span class="token punctuation">.</span><span class="token function">registerBeanDefinition</span><span class="token punctuation">(</span>bdHolder<span class="token punctuation">,</span> <span class="token function">getReaderContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getRegistry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">BeanDefinitionStoreException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token function">getReaderContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"Failed to register bean definition with name '"</span> <span class="token operator">+</span>bdHolder<span class="token punctuation">.</span><span class="token function">getBeanName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"'"</span><span class="token punctuation">,</span> ele<span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">// 4.Send registration event.</span><span class="token function">getReaderContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">fireComponentRegistered</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BeanComponentDefinition</span><span class="token punctuation">(</span>bdHolder<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>è°ƒç”¨çš„æ˜¯å·¥å…·ç±»BeanDefinitionReaderUtilsçš„æ–¹æ³•registerBeanDefinition()ï¼š<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">registerBeanDefinition</span><span class="token punctuation">(</span><span class="token class-name">BeanDefinitionHolder</span> definitionHolder<span class="token punctuation">,</span> <span class="token class-name">BeanDefinitionRegistry</span> registry<span class="token punctuation">)</span><span class="token keyword">throws</span> <span class="token class-name">BeanDefinitionStoreException</span> <span class="token punctuation">&#123;</span><span class="token comment">// Register bean definition under primary name.</span><span class="token class-name">String</span> beanName <span class="token operator">=</span> definitionHolder<span class="token punctuation">.</span><span class="token function">getBeanName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//å®ŒæˆBeanDefinitionçš„æ³¨å†Œï¼Œé‡ç‚¹çœ‹ï¼Œé‡è¦ç¨‹åº¦ 5</span>registry<span class="token punctuation">.</span><span class="token function">registerBeanDefinition</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> definitionHolder<span class="token punctuation">.</span><span class="token function">getBeanDefinition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//å»ºç«‹åˆ«åå’Œ idçš„æ˜ å°„ï¼Œè¿™æ ·å°±å¯ä»¥æ ¹æ®åˆ«åè·å–åˆ°id</span><span class="token comment">// Register aliases for bean name, if any.</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> aliases <span class="token operator">=</span> definitionHolder<span class="token punctuation">.</span><span class="token function">getAliases</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>aliases <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> alias <span class="token operator">:</span> aliases<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>registry<span class="token punctuation">.</span><span class="token function">registerAlias</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> alias<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>DefaultListableBeanFactory.registerBeanDefinition()æ–¹æ³•ï¼Œæœ€ç»ˆå®Œæˆé»˜è®¤æ ‡ç­¾çš„æ³¨å†Œã€‚<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">registerBeanDefinition</span><span class="token punctuation">(</span><span class="token class-name">String</span> beanName<span class="token punctuation">,</span> <span class="token class-name">BeanDefinition</span> beanDefinition<span class="token punctuation">)</span><span class="token keyword">throws</span> <span class="token class-name">BeanDefinitionStoreException</span> <span class="token punctuation">&#123;</span><span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">hasText</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> <span class="token string">"Bean name must not be empty"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">notNull</span><span class="token punctuation">(</span>beanDefinition<span class="token punctuation">,</span> <span class="token string">"BeanDefinition must not be null"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>beanDefinition <span class="token keyword">instanceof</span> <span class="token class-name">AbstractBeanDefinition</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">try</span> <span class="token punctuation">&#123;</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">AbstractBeanDefinition</span><span class="token punctuation">)</span> beanDefinition<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">validate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">BeanDefinitionValidationException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BeanDefinitionStoreException</span><span class="token punctuation">(</span>beanDefinition<span class="token punctuation">.</span><span class="token function">getResourceDescription</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> beanName<span class="token punctuation">,</span><span class="token string">"Validation of bean definition failed"</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token comment">//å…ˆåˆ¤æ–­BeanDefinitionæ˜¯å¦å·²ç»æ³¨å†Œ</span><span class="token class-name">BeanDefinition</span> existingDefinition <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>beanDefinitionMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>existingDefinition <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isAllowBeanDefinitionOverriding</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BeanDefinitionOverrideException</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> beanDefinition<span class="token punctuation">,</span> existingDefinition<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>existingDefinition<span class="token punctuation">.</span><span class="token function">getRole</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> beanDefinition<span class="token punctuation">.</span><span class="token function">getRole</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">// e.g. was ROLE_APPLICATION, now overriding with ROLE_SUPPORT or ROLE_INFRASTRUCTURE</span><span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isInfoEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"Overriding user-defined bean definition for bean '"</span> <span class="token operator">+</span> beanName <span class="token operator">+</span><span class="token string">"' with a framework-generated bean definition: replacing ["</span> <span class="token operator">+</span>existingDefinition <span class="token operator">+</span> <span class="token string">"] with ["</span> <span class="token operator">+</span> beanDefinition <span class="token operator">+</span> <span class="token string">"]"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>beanDefinition<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>existingDefinition<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"Overriding bean definition for bean '"</span> <span class="token operator">+</span> beanName <span class="token operator">+</span><span class="token string">"' with a different definition: replacing ["</span> <span class="token operator">+</span> existingDefinition <span class="token operator">+</span><span class="token string">"] with ["</span> <span class="token operator">+</span> beanDefinition <span class="token operator">+</span> <span class="token string">"]"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">else</span> <span class="token punctuation">&#123;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isTraceEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>logger<span class="token punctuation">.</span><span class="token function">trace</span><span class="token punctuation">(</span><span class="token string">"Overriding bean definition for bean '"</span> <span class="token operator">+</span> beanName <span class="token operator">+</span><span class="token string">"' with an equivalent definition: replacing ["</span> <span class="token operator">+</span> existingDefinition <span class="token operator">+</span><span class="token string">"] with ["</span> <span class="token operator">+</span> beanDefinition <span class="token operator">+</span> <span class="token string">"]"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">this</span><span class="token punctuation">.</span>beanDefinitionMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> beanDefinition<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">else</span> <span class="token punctuation">&#123;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">hasBeanCreationStarted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">// Cannot modify startup-time collection elements anymore (for stable iteration)</span><span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>beanDefinitionMap<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">this</span><span class="token punctuation">.</span>beanDefinitionMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> beanDefinition<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> updatedDefinitions <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>beanDefinitionNames<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>updatedDefinitions<span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>beanDefinitionNames<span class="token punctuation">)</span><span class="token punctuation">;</span>updatedDefinitions<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">this</span><span class="token punctuation">.</span>beanDefinitionNames <span class="token operator">=</span> updatedDefinitions<span class="token punctuation">;</span><span class="token function">removeManualSingletonName</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">else</span> <span class="token punctuation">&#123;</span><span class="token comment">//æŠŠbeanDefinitionç¼“å­˜åˆ°mapä¸­</span><span class="token comment">// Still in startup registration phase</span><span class="token keyword">this</span><span class="token punctuation">.</span>beanDefinitionMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> beanDefinition<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//æŠŠbeanNameæ”¾åˆ°beanDefinitionNames listä¸­ï¼Œè¿™ä¸ªlistç€é‡è®°ä½ï¼Œbeanå®ä¾‹åŒ–çš„æ—¶å€™éœ€è¦ç”¨åˆ°</span><span class="token keyword">this</span><span class="token punctuation">.</span>beanDefinitionNames<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">removeManualSingletonName</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">this</span><span class="token punctuation">.</span>frozenBeanDefinitionNames <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>existingDefinition <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">||</span> <span class="token function">containsSingleton</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token function">resetBeanDefinition</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isConfigurationFrozen</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token function">clearByTypeCache</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>æ€»ç»“ä¸‹DefaultListableBeanFactory.registerBeanDefinition()æ–¹æ³•çš„åŠŸèƒ½ï¼š</li><li>æŠŠbeanåç§°å’ŒbeanDefinitionæ”¾åˆ° Map&lt;String, BeanDefinition&gt; beanDefinitionMap &#x3D; new ConcurrentHashMap&lt;&gt;(256)çš„ å®¹å™¨ä¸­</li><li>æŠŠbeanåç§°æ”¾åˆ°List<String> beanDefinitionNames &#x3D; new ArrayList&lt;&gt;(256) çš„ listå®¹å™¨ä¸­ç¼“å­˜èµ·æ¥</String></li></ul><p>beançš„å®ä¾‹åŒ–è¿‡ç¨‹ä¸­ä¼šç”¨åˆ°è¿™ä¸¤ä¸ªä¸œä¸œã€‚<br>åˆ°è¿™å„¿ï¼ŒSpringé»˜è®¤æ ‡ç­¾è§£æå®Œæˆä»£ç è¿½è¸ªäº†ï¼Œæ¥ä¸‹æ¥è·Ÿè·Ÿè‡ªå®šä¹‰æ ‡ç­¾çš„è§£æè¿‡ç¨‹ã€‚</p><h2 id="7-parseCustomElement"><a href="#7-parseCustomElement" class="headerlink" title="7.parseCustomElement()"></a>7.parseCustomElement()</h2><p>è°ƒç”¨æµç¨‹è¿˜æ˜¯å’Œç›®å½•ä¸€ä¸­æè¿°çš„ä¸€æ ·ã€‚Talk is cheap, show me the code.</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/*** BeanDefinitionParserDelegate* Description: è‡ªå®šä¹‰æ ‡ç­¾äº¤ç»™BeanDefinitionParserDelegate å§”æ‰˜ç±»æ¥è§£æ*/</span><span class="token keyword">public</span> <span class="token class-name">BeanDefinition</span> <span class="token function">parseCustomElement</span><span class="token punctuation">(</span><span class="token class-name">Element</span> ele<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">BeanDefinition</span> containingBd<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">// è·å–å‘½åç©ºé—´çš„URI</span><span class="token class-name">String</span> namespaceUri <span class="token operator">=</span> <span class="token function">getNamespaceURI</span><span class="token punctuation">(</span>ele<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>namespaceUri <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">// SPIè®¾è®¡ï¼Œè·å–/META-INF/spring.handersä¸­URIå¯¹åº”çš„Handerå¤„ç†ç±»</span><span class="token comment">//å…·ä½“è§£æå†…å®¹å¦‚ä¸‹ï¼š</span><span class="token comment">//è·å–springä¸­æ‰€æœ‰jaråŒ…é‡Œé¢çš„META-INF/spring.handlersæ–‡ä»¶ï¼Œå¹¶ä¸”å»ºç«‹æ˜ å°„å…³ç³»ã€‚</span><span class="token comment">//æ ¹æ®namespaceUriè·å–åˆ°è¿™ä¸ªå‘½åç©ºé—´çš„å¤„ç†ç±»ã€‚</span><span class="token comment">//è°ƒç”¨å¤„ç†ç±»çš„init()æ–¹æ³•ï¼Œåœ¨init()æ–¹æ³•ä¸­å®Œæˆæ ‡ç­¾å…ƒç´ è§£æç±»çš„æ³¨å†Œã€‚</span><span class="token class-name">NamespaceHandler</span> handler <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>readerContext<span class="token punctuation">.</span><span class="token function">getNamespaceHandlerResolver</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>namespaceUri<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>handler <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"Unable to locate Spring NamespaceHandler for XML schema namespace ["</span> <span class="token operator">+</span> namespaceUri <span class="token operator">+</span> <span class="token string">"]"</span><span class="token punctuation">,</span> ele<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">// æ‰§è¡Œ å®ç°ç±»NamespaceHandlerSupport ä¸­çš„parse æ–¹æ³•</span><span class="token keyword">return</span> handler<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>ele<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">ParserContext</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>readerContext<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">,</span> containingBd<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å…ˆçœ‹çœ‹resolveæ–¹æ³•</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token class-name">NamespaceHandler</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token class-name">String</span> namespaceUri<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">//è·å–springä¸­æ‰€æœ‰jaråŒ…é‡Œé¢çš„ "META-INF/spring.handlers"æ–‡ä»¶ï¼Œå¹¶ä¸”å»ºç«‹æ˜ å°„å…³ç³»</span><span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">></span></span> handlerMappings <span class="token operator">=</span> <span class="token function">getHandlerMappings</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//æ ¹æ®namespaceUriï¼šhttp://www.springframework.org/schema/contextï¼Œè·å–åˆ°è¿™ä¸ªå‘½åç©ºé—´çš„å¤„ç†ç±»</span><span class="token class-name">Object</span> handlerOrClassName <span class="token operator">=</span> handlerMappings<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>namespaceUri<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>handlerOrClassName <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>handlerOrClassName <span class="token keyword">instanceof</span> <span class="token class-name">NamespaceHandler</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token class-name">NamespaceHandler</span><span class="token punctuation">)</span> handlerOrClassName<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">else</span> <span class="token punctuation">&#123;</span><span class="token class-name">String</span> className <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span> handlerOrClassName<span class="token punctuation">;</span><span class="token keyword">try</span> <span class="token punctuation">&#123;</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span> handlerClass <span class="token operator">=</span> <span class="token class-name">ClassUtils</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span>className<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>classLoader<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">NamespaceHandler</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">isAssignableFrom</span><span class="token punctuation">(</span>handlerClass<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">FatalBeanException</span><span class="token punctuation">(</span><span class="token string">"Class ["</span> <span class="token operator">+</span> className <span class="token operator">+</span> <span class="token string">"] for namespace ["</span> <span class="token operator">+</span> namespaceUri <span class="token operator">+</span><span class="token string">"] does not implement the ["</span> <span class="token operator">+</span> <span class="token class-name">NamespaceHandler</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"] interface"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token class-name">NamespaceHandler</span> namespaceHandler <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">NamespaceHandler</span><span class="token punctuation">)</span> <span class="token class-name">BeanUtils</span><span class="token punctuation">.</span><span class="token function">instantiateClass</span><span class="token punctuation">(</span>handlerClass<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//è°ƒç”¨å¤„ç†ç±»çš„initæ–¹æ³•ï¼Œåœ¨initæ–¹æ³•ä¸­å®Œæˆæ ‡ç­¾å…ƒç´ è§£æç±»çš„æ³¨å†Œ</span>namespaceHandler<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>handlerMappings<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>namespaceUri<span class="token punctuation">,</span> namespaceHandler<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">return</span> namespaceHandler<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ClassNotFoundException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">FatalBeanException</span><span class="token punctuation">(</span><span class="token string">"Could not find NamespaceHandler class ["</span> <span class="token operator">+</span> className <span class="token operator">+</span><span class="token string">"] for namespace ["</span> <span class="token operator">+</span> namespaceUri <span class="token operator">+</span> <span class="token string">"]"</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">LinkageError</span> err<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">FatalBeanException</span><span class="token punctuation">(</span><span class="token string">"Unresolvable class definition for NamespaceHandler class ["</span> <span class="token operator">+</span>className <span class="token operator">+</span> <span class="token string">"] for namespace ["</span> <span class="token operator">+</span> namespaceUri <span class="token operator">+</span> <span class="token string">"]"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>è¿™ä¸ªæ–¹æ³•å¾ˆé‡è¦ï¼Œæ€»ç»“ä¸‹å®ƒçš„åŠŸèƒ½ï¼š</strong></p><ul><li>è·å–springä¸­æ‰€æœ‰jaråŒ…é‡Œé¢çš„ â€œMETA-INF&#x2F;spring.handlersâ€æ–‡ä»¶ï¼Œå¹¶ä¸”å»ºç«‹æ˜ å°„å…³ç³»è‡³handlerMappings </li><li>æ ¹æ®namespaceUriï¼š<a href="http://www.springframework.org/schema/context%EF%BC%8C%E8%8E%B7%E5%8F%96%E5%88%B0%E8%BF%99%E4%B8%AA%E5%91%BD%E5%90%8D%E7%A9%BA%E9%97%B4%E7%9A%84%E5%A4%84%E7%90%86%E7%B1%BB">http://www.springframework.org/schema/contextï¼Œè·å–åˆ°è¿™ä¸ªå‘½åç©ºé—´çš„å¤„ç†ç±»</a></li><li>åå°„å®ä¾‹åŒ–å®ƒå¯¹åº”çš„NamespaceHandler</li><li>è°ƒç”¨å¤„ç†ç±»NamespaceHandlerçš„initæ–¹æ³•ï¼Œåœ¨initæ–¹æ³•ä¸­å®Œæˆæ ‡ç­¾å…ƒç´ è§£æç±»çš„æ³¨å†Œ</li><li>æ³¨å†Œè¿™ä¸ªNamespaceHandlerè‡³handlerMappings</li></ul><p>è¿›å…¥parseæ–¹æ³•</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/*** NamespaceHandlerSupport* Description: å§”æ‰˜BeanDefinitionParserç±»è§£æå…ƒç´ */</span><span class="token keyword">public</span> <span class="token class-name">BeanDefinition</span> <span class="token function">parse</span><span class="token punctuation">(</span><span class="token class-name">Element</span> element<span class="token punctuation">,</span> <span class="token class-name">ParserContext</span> parserContext<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">// è·å–è‡ªå®šä¹‰ç»„ä»¶å å¯¹åº”çš„è§£ææ–¹æ³•</span><span class="token class-name">BeanDefinitionParser</span> parser <span class="token operator">=</span> <span class="token function">findParserForElement</span><span class="token punctuation">(</span>element<span class="token punctuation">,</span> parserContext<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// è°ƒç”¨ComponentScanBeanDefinitionParserå®ç°ç±»ä¸­çš„ parseæ–¹æ³•</span><span class="token keyword">return</span> <span class="token punctuation">(</span>parser <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> parser<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>element<span class="token punctuation">,</span> parserContext<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è¿›å…¥findParserForElement()æ–¹æ³•</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/*** NamespaceHandlerSupport* Description: ä»mapä¸­æ ¹æ®ç»„ä»¶åç§°è·å–ç»‘å®šçš„è§£ææ–¹æ³•*/</span><span class="token keyword">private</span> <span class="token class-name">BeanDefinitionParser</span> <span class="token function">findParserForElement</span><span class="token punctuation">(</span><span class="token class-name">Element</span> element<span class="token punctuation">,</span> <span class="token class-name">ParserContext</span> parserContext<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">// è·å–ç»„ä»¶åç§°</span><span class="token class-name">String</span> localName <span class="token operator">=</span> parserContext<span class="token punctuation">.</span><span class="token function">getDelegate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getLocalName</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// Map&lt;String, BeanDefinitionParser> parsers = new HashMap&lt;>()</span><span class="token comment">//æ­¤å¤„this.parsers.get()ä¹‹æ‰€ä»¥æœ‰å€¼ï¼Œæ˜¯å› ä¸ºåœ¨/META-INF/spring.handersä¸­URIå¯¹åº”çš„Handerå¤„ç†ç±»åˆå§‹åŒ–çš„æ—¶å€™ï¼Œé€šè¿‡init()æ–¹æ³•ä¸­,æ‰§è¡ŒregisterBeanDefinitionParser()ï¼Œæ¥è°ƒç”¨this.parsers.set('æ ‡ç­¾å…ƒç´ ','è§£æç±»')è®¾ç½®çš„ã€‚</span><span class="token class-name">BeanDefinitionParser</span> parser <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>parsers<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>localName<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>parser <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>parserContext<span class="token punctuation">.</span><span class="token function">getReaderContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">fatal</span><span class="token punctuation">(</span><span class="token string">"Cannot locate BeanDefinitionParser for element ["</span> <span class="token operator">+</span> localName <span class="token operator">+</span> <span class="token string">"]"</span><span class="token punctuation">,</span> element<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">return</span> parser<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è¿™é‡Œæˆ‘ä»¬ä»¥&lt;component-scan&gt;æ ‡ç­¾ä¸ºä¾‹<br>å…ˆçœ‹çœ‹å®ƒæ‰€åœ¨çš„NamespaceHandleré…ç½®åœ¨å“ªå„¿</p><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup">http\://www.springframework.org/schema/context=org.springframework.context.config.ContextNamespaceHandler<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>å¯¹åº”çš„javaæ–‡ä»¶</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ContextNamespaceHandler</span> <span class="token keyword">extends</span> <span class="token class-name">NamespaceHandlerSupport</span> <span class="token punctuation">&#123;</span><span class="token annotation punctuation">@Override</span><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token function">registerBeanDefinitionParser</span><span class="token punctuation">(</span><span class="token string">"property-placeholder"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">PropertyPlaceholderBeanDefinitionParser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">registerBeanDefinitionParser</span><span class="token punctuation">(</span><span class="token string">"property-override"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">PropertyOverrideBeanDefinitionParser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">registerBeanDefinitionParser</span><span class="token punctuation">(</span><span class="token string">"annotation-config"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">AnnotationConfigBeanDefinitionParser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">registerBeanDefinitionParser</span><span class="token punctuation">(</span><span class="token string">"component-scan"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">ComponentScanBeanDefinitionParser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">registerBeanDefinitionParser</span><span class="token punctuation">(</span><span class="token string">"load-time-weaver"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">LoadTimeWeaverBeanDefinitionParser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">registerBeanDefinitionParser</span><span class="token punctuation">(</span><span class="token string">"spring-configured"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">SpringConfiguredBeanDefinitionParser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">registerBeanDefinitionParser</span><span class="token punctuation">(</span><span class="token string">"mbean-export"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">MBeanExportBeanDefinitionParser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">registerBeanDefinitionParser</span><span class="token punctuation">(</span><span class="token string">"mbean-server"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">MBeanServerBeanDefinitionParser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å®Œæˆè¿™äº›æ ‡ç­¾è§£æç±»çš„æ³¨å†Œåï¼Œè¿”å›åˆ°æ–¹æ³•ä¸­</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/*** BeanDefinitionParserDelegate* Description: è‡ªå®šä¹‰æ ‡ç­¾äº¤ç»™BeanDefinitionParserDelegate å§”æ‰˜ç±»æ¥è§£æ*/</span><span class="token keyword">public</span> <span class="token class-name">BeanDefinition</span> <span class="token function">parseCustomElement</span><span class="token punctuation">(</span><span class="token class-name">Element</span> ele<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">BeanDefinition</span> containingBd<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">// è·å–å‘½åç©ºé—´çš„URI</span><span class="token class-name">String</span> namespaceUri <span class="token operator">=</span> <span class="token function">getNamespaceURI</span><span class="token punctuation">(</span>ele<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>namespaceUri <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">// SPIè®¾è®¡ï¼Œè·å–/META-INF/spring.handersä¸­URIå¯¹åº”çš„Handerå¤„ç†ç±»</span><span class="token comment">//å…·ä½“è§£æå†…å®¹å¦‚ä¸‹ï¼š</span><span class="token comment">//è·å–springä¸­æ‰€æœ‰jaråŒ…é‡Œé¢çš„META-INF/spring.handlersæ–‡ä»¶ï¼Œå¹¶ä¸”å»ºç«‹æ˜ å°„å…³ç³»ã€‚</span><span class="token comment">//æ ¹æ®namespaceUriè·å–åˆ°è¿™ä¸ªå‘½åç©ºé—´çš„å¤„ç†ç±»ã€‚</span><span class="token comment">//è°ƒç”¨å¤„ç†ç±»çš„init()æ–¹æ³•ï¼Œåœ¨init()æ–¹æ³•ä¸­å®Œæˆæ ‡ç­¾å…ƒç´ è§£æç±»çš„æ³¨å†Œã€‚</span><span class="token class-name">NamespaceHandler</span> handler <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>readerContext<span class="token punctuation">.</span><span class="token function">getNamespaceHandlerResolver</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>namespaceUri<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>handler <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"Unable to locate Spring NamespaceHandler for XML schema namespace ["</span> <span class="token operator">+</span> namespaceUri <span class="token operator">+</span> <span class="token string">"]"</span><span class="token punctuation">,</span> ele<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">// æ‰§è¡Œ å®ç°ç±»NamespaceHandlerSupport ä¸­çš„parse æ–¹æ³•</span><span class="token keyword">return</span> handler<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>ele<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">ParserContext</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>readerContext<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">,</span> containingBd<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>çœ‹çœ‹ComponentScanBeanDefinitionParser.parseè§£æè¿‡ç¨‹</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/** Description: æ ¸å¿ƒè§£æ * 1ã€æ‰«æè·¯å¾„.classåç¼€çš„æ–‡ä»¶ * 2ã€è¦åˆ¤æ–­ç±»ä¸Šæ˜¯å¦æœ‰æ³¨è§£ * 3ã€GenericBeanDefinition genericBeanDefinition = new GenericBeanDefinition(); *    genericBeanDefinition.setBeanClass(BeanClass.class); * 4ã€å®ŒæˆbeanDefinitionæ³¨å†Œ * */</span><span class="token keyword">public</span> <span class="token class-name">BeanDefinition</span> <span class="token function">parse</span><span class="token punctuation">(</span><span class="token class-name">Element</span> element<span class="token punctuation">,</span> <span class="token class-name">ParserContext</span> parserContext<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">//è·å–basePackageå±æ€§</span><span class="token class-name">String</span> basePackage <span class="token operator">=</span> element<span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span><span class="token constant">BASE_PACKAGE_ATTRIBUTE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>basePackage <span class="token operator">=</span> parserContext<span class="token punctuation">.</span><span class="token function">getReaderContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">resolvePlaceholders</span><span class="token punctuation">(</span>basePackage<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//å¯ä»¥ç”¨é€—å·åˆ†å¼€</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> basePackages <span class="token operator">=</span> <span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">tokenizeToStringArray</span><span class="token punctuation">(</span>basePackage<span class="token punctuation">,</span><span class="token class-name">ConfigurableApplicationContext</span><span class="token punctuation">.</span><span class="token constant">CONFIG_LOCATION_DELIMITERS</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//åˆ›å»ºæ³¨è§£æ‰«æå™¨</span><span class="token comment">// Actually scan for bean definitions and register them.</span><span class="token class-name">ClassPathBeanDefinitionScanner</span> scanner <span class="token operator">=</span> <span class="token function">configureScanner</span><span class="token punctuation">(</span>parserContext<span class="token punctuation">,</span> element<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//æ‰«æå¹¶æŠŠæ‰«æçš„ç±»å°è£…æˆbeanDefinitionå¯¹è±¡  æ ¸å¿ƒæ–¹æ³•ï¼Œé‡è¦ç¨‹åº¦ 5</span><span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">BeanDefinitionHolder</span><span class="token punctuation">></span></span> beanDefinitions <span class="token operator">=</span> scanner<span class="token punctuation">.</span><span class="token function">doScan</span><span class="token punctuation">(</span>basePackages<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">registerComponents</span><span class="token punctuation">(</span>parserContext<span class="token punctuation">.</span><span class="token function">getReaderContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> beanDefinitions<span class="token punctuation">,</span> element<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è·å–basePackageè¿™é‡Œä¸åšè·Ÿè¸ªäº†ï¼Œå…ˆçœ‹çœ‹åˆ›å»ºæ‰«æå™¨çš„è¿‡ç¨‹</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">//åˆ›å»ºæ³¨è§£æ‰«æå™¨</span><span class="token comment">// Actually scan for bean definitions and register them.</span><span class="token class-name">ClassPathBeanDefinitionScanner</span> scanner <span class="token operator">=</span> <span class="token function">configureScanner</span><span class="token punctuation">(</span>parserContext<span class="token punctuation">,</span> element<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>ç‚¹è¿›å»çœ‹çœ‹</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">protected</span> <span class="token class-name">ClassPathBeanDefinitionScanner</span> <span class="token function">configureScanner</span><span class="token punctuation">(</span><span class="token class-name">ParserContext</span> parserContext<span class="token punctuation">,</span> <span class="token class-name">Element</span> element<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">//ä½¿ç”¨é»˜è®¤çš„è¿‡æ»¤å™¨</span><span class="token keyword">boolean</span> useDefaultFilters <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>element<span class="token punctuation">.</span><span class="token function">hasAttribute</span><span class="token punctuation">(</span><span class="token constant">USE_DEFAULT_FILTERS_ATTRIBUTE</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>useDefaultFilters <span class="token operator">=</span> <span class="token class-name">Boolean</span><span class="token punctuation">.</span><span class="token function">parseBoolean</span><span class="token punctuation">(</span>element<span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span><span class="token constant">USE_DEFAULT_FILTERS_ATTRIBUTE</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">//é‡ç‚¹çœ‹çœ‹è¿™é‡Œçš„åˆ›å»º</span><span class="token comment">// Delegate bean definition registration to scanner class.</span><span class="token class-name">ClassPathBeanDefinitionScanner</span> scanner <span class="token operator">=</span> <span class="token function">createScanner</span><span class="token punctuation">(</span>parserContext<span class="token punctuation">.</span><span class="token function">getReaderContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> useDefaultFilters<span class="token punctuation">)</span><span class="token punctuation">;</span>scanner<span class="token punctuation">.</span><span class="token function">setBeanDefinitionDefaults</span><span class="token punctuation">(</span>parserContext<span class="token punctuation">.</span><span class="token function">getDelegate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBeanDefinitionDefaults</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>scanner<span class="token punctuation">.</span><span class="token function">setAutowireCandidatePatterns</span><span class="token punctuation">(</span>parserContext<span class="token punctuation">.</span><span class="token function">getDelegate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAutowireCandidatePatterns</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>element<span class="token punctuation">.</span><span class="token function">hasAttribute</span><span class="token punctuation">(</span><span class="token constant">RESOURCE_PATTERN_ATTRIBUTE</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>scanner<span class="token punctuation">.</span><span class="token function">setResourcePattern</span><span class="token punctuation">(</span>element<span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span><span class="token constant">RESOURCE_PATTERN_ATTRIBUTE</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">try</span> <span class="token punctuation">&#123;</span><span class="token comment">// è§£æå­æ ‡ç­¾ï¼Œä¸ç”¨çœ‹</span><span class="token function">parseBeanNameGenerator</span><span class="token punctuation">(</span>element<span class="token punctuation">,</span> scanner<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> ex<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>parserContext<span class="token punctuation">.</span><span class="token function">getReaderContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>ex<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> parserContext<span class="token punctuation">.</span><span class="token function">extractSource</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">,</span> ex<span class="token punctuation">.</span><span class="token function">getCause</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">try</span> <span class="token punctuation">&#123;</span><span class="token comment">// è§£æå­æ ‡ç­¾ï¼Œä¸ç”¨çœ‹</span><span class="token function">parseScope</span><span class="token punctuation">(</span>element<span class="token punctuation">,</span> scanner<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> ex<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>parserContext<span class="token punctuation">.</span><span class="token function">getReaderContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>ex<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> parserContext<span class="token punctuation">.</span><span class="token function">extractSource</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">,</span> ex<span class="token punctuation">.</span><span class="token function">getCause</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">// ä¼šæ‰«æå«æœ‰"include-filter"å’Œ"exclude-filter"å±æ€§è¿›è¡Œè§£æ</span><span class="token function">parseTypeFilters</span><span class="token punctuation">(</span>element<span class="token punctuation">,</span> scanner<span class="token punctuation">,</span> parserContext<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">return</span> scanner<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å†ç‚¹è¿›å»çœ‹çœ‹createScanner()æ–¹æ³•</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">protected</span> <span class="token class-name">ClassPathBeanDefinitionScanner</span> <span class="token function">createScanner</span><span class="token punctuation">(</span><span class="token class-name">XmlReaderContext</span> readerContext<span class="token punctuation">,</span> <span class="token keyword">boolean</span> useDefaultFilters<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ClassPathBeanDefinitionScanner</span><span class="token punctuation">(</span>readerContext<span class="token punctuation">.</span><span class="token function">getRegistry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> useDefaultFilters<span class="token punctuation">,</span>readerContext<span class="token punctuation">.</span><span class="token function">getEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> readerContext<span class="token punctuation">.</span><span class="token function">getResourceLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">public</span> <span class="token class-name">ClassPathBeanDefinitionScanner</span><span class="token punctuation">(</span><span class="token class-name">BeanDefinitionRegistry</span> registry<span class="token punctuation">,</span> <span class="token keyword">boolean</span> useDefaultFilters<span class="token punctuation">,</span><span class="token class-name">Environment</span> environment<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">ResourceLoader</span> resourceLoader<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">notNull</span><span class="token punctuation">(</span>registry<span class="token punctuation">,</span> <span class="token string">"BeanDefinitionRegistry must not be null"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">this</span><span class="token punctuation">.</span>registry <span class="token operator">=</span> registry<span class="token punctuation">;</span><span class="token comment">//ä½¿ç”¨é»˜è®¤çš„è¿‡æ»¤å™¨ï¼Œæ‰«æå¸¦æœ‰@Componentæ³¨è§£çš„ç±»</span><span class="token keyword">if</span> <span class="token punctuation">(</span>useDefaultFilters<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token function">registerDefaultFilters</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token function">setEnvironment</span><span class="token punctuation">(</span>environment<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">setResourceLoader</span><span class="token punctuation">(</span>resourceLoader<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">/** *  Description: ä½¿ç”¨é»˜è®¤è¿‡æ»¤è§„åˆ™ å¤„ç†æŒ‡å®šçš„æ³¨è§£ç±»ï¼Œç„¶åæ³¨å†Œ * æ‰«æå¯¹è±¡ä¸ºå¸¦æœ‰ä»¥ä¸‹æ³¨è§£çš„ç±»ï¼š * @Component * @Controller * @Service * @Repository * ä»¥åŠJava EE 6çš„javax.annotation.ManagedBean,JSR-330çš„javax.inject.Namedçš„æ³¨è§£ */</span><span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">registerDefaultFilters</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">// è¿‡æ»¤å™¨ä¸­æ·»åŠ éœ€è¦æ‰«æçš„æ³¨è§£ç±»å‹</span><span class="token comment">// å°†æ³¨è§£æ·»åŠ åˆ° AnnotationTypeFilteråŒ…è£…ç±»</span><span class="token keyword">this</span><span class="token punctuation">.</span>includeFilters<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">AnnotationTypeFilter</span><span class="token punctuation">(</span><span class="token class-name">Component</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// ç¡®ä¿ç±»æ³¨è§£æ˜¯ ClassPathScanningCandidateComponentProviderçš„ç±»åŠ è½½å™¨</span><span class="token class-name">ClassLoader</span> cl <span class="token operator">=</span> <span class="token class-name">ClassPathScanningCandidateComponentProvider</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">try</span> <span class="token punctuation">&#123;</span><span class="token keyword">this</span><span class="token punctuation">.</span>includeFilters<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">AnnotationTypeFilter</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">Annotation</span><span class="token punctuation">></span></span><span class="token punctuation">)</span> <span class="token class-name">ClassUtils</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span><span class="token string">"javax.annotation.ManagedBean"</span><span class="token punctuation">,</span> cl<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>logger<span class="token punctuation">.</span><span class="token function">trace</span><span class="token punctuation">(</span><span class="token string">"JSR-250 'javax.annotation.ManagedBean' found and supported for component scanning"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ClassNotFoundException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">// JSR-250 1.1 API (as included in Java EE 6) not available - simply skip.</span><span class="token punctuation">&#125;</span><span class="token keyword">try</span> <span class="token punctuation">&#123;</span><span class="token keyword">this</span><span class="token punctuation">.</span>includeFilters<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">AnnotationTypeFilter</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">Annotation</span><span class="token punctuation">></span></span><span class="token punctuation">)</span> <span class="token class-name">ClassUtils</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span><span class="token string">"javax.inject.Named"</span><span class="token punctuation">,</span> cl<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>logger<span class="token punctuation">.</span><span class="token function">trace</span><span class="token punctuation">(</span><span class="token string">"JSR-330 'javax.inject.Named' annotation found and supported for component scanning"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ClassNotFoundException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">// JSR-330 API not available - simply skip.</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å°†æ‹¦æˆªåˆ°çš„æ³¨è§£æ·»åŠ åˆ°List&lt;TypeFilter&gt; includeFilters &#x3D; new LinkedList&lt;&gt;() å®¹å™¨ä¸­ã€‚<br>åˆ›å»ºæ³¨è§£æ‰«æå™¨å®Œæ¯•ï¼Œè¿”å›åˆ°parse()æ–¹æ³•ä¸­ï¼Œè·Ÿä¸‹doScan()è¿‡ç¨‹ã€‚</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">protected</span> <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">BeanDefinitionHolder</span><span class="token punctuation">></span></span> <span class="token function">doScan</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> basePackages<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">notEmpty</span><span class="token punctuation">(</span>basePackages<span class="token punctuation">,</span> <span class="token string">"At least one base package must be specified"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">BeanDefinitionHolder</span><span class="token punctuation">></span></span> beanDefinitions <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedHashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> basePackage <span class="token operator">:</span> basePackages<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">//æ‰«æåˆ°æœ‰æ³¨è§£çš„ç±»å¹¶å°è£…æˆBeanDefinitionå¯¹è±¡</span><span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">BeanDefinition</span><span class="token punctuation">></span></span> candidates <span class="token operator">=</span> <span class="token function">findCandidateComponents</span><span class="token punctuation">(</span>basePackage<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">BeanDefinition</span> candidate <span class="token operator">:</span> candidates<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token class-name">ScopeMetadata</span> scopeMetadata <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>scopeMetadataResolver<span class="token punctuation">.</span><span class="token function">resolveScopeMetadata</span><span class="token punctuation">(</span>candidate<span class="token punctuation">)</span><span class="token punctuation">;</span>candidate<span class="token punctuation">.</span><span class="token function">setScope</span><span class="token punctuation">(</span>scopeMetadata<span class="token punctuation">.</span><span class="token function">getScopeName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">String</span> beanName <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>beanNameGenerator<span class="token punctuation">.</span><span class="token function">generateBeanName</span><span class="token punctuation">(</span>candidate<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>registry<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>candidate <span class="token keyword">instanceof</span> <span class="token class-name">AbstractBeanDefinition</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">//æ”¯æŒäº†@Lazy @DependOnæ³¨è§£</span><span class="token function">postProcessBeanDefinition</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">AbstractBeanDefinition</span><span class="token punctuation">)</span> candidate<span class="token punctuation">,</span> beanName<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>candidate <span class="token keyword">instanceof</span> <span class="token class-name">AnnotatedBeanDefinition</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token class-name">AnnotationConfigUtils</span><span class="token punctuation">.</span><span class="token function">processCommonDefinitionAnnotations</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">AnnotatedBeanDefinition</span><span class="token punctuation">)</span> candidate<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">checkCandidate</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> candidate<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token class-name">BeanDefinitionHolder</span> definitionHolder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BeanDefinitionHolder</span><span class="token punctuation">(</span>candidate<span class="token punctuation">,</span> beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>definitionHolder <span class="token operator">=</span><span class="token class-name">AnnotationConfigUtils</span><span class="token punctuation">.</span><span class="token function">applyScopedProxyMode</span><span class="token punctuation">(</span>scopeMetadata<span class="token punctuation">,</span> definitionHolder<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>registry<span class="token punctuation">)</span><span class="token punctuation">;</span>beanDefinitions<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>definitionHolder<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//BeanDefinitionæ³¨å†Œ</span><span class="token function">registerBeanDefinition</span><span class="token punctuation">(</span>definitionHolder<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>registry<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">return</span> beanDefinitions<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ç‚¹è¿›å»çœ‹çœ‹registerBeanDefinition()æ–¹æ³•</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">registerBeanDefinition</span><span class="token punctuation">(</span><span class="token class-name">BeanDefinitionHolder</span> definitionHolder<span class="token punctuation">,</span> <span class="token class-name">BeanDefinitionRegistry</span> registry<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token class-name">BeanDefinitionReaderUtils</span><span class="token punctuation">.</span><span class="token function">registerBeanDefinition</span><span class="token punctuation">(</span>definitionHolder<span class="token punctuation">,</span> registry<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">/*** BeanDefinitionReaderUtils* Description : å‘æŒ‡å®šçš„beanå·¥å‚æ³¨å†ŒBeanDefinition*/</span><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">registerBeanDefinition</span><span class="token punctuation">(</span><span class="token class-name">BeanDefinitionHolder</span> definitionHolder<span class="token punctuation">,</span> <span class="token class-name">BeanDefinitionRegistry</span> registry<span class="token punctuation">)</span><span class="token keyword">throws</span> <span class="token class-name">BeanDefinitionStoreException</span> <span class="token punctuation">&#123;</span><span class="token comment">// Register bean definition under primary name.</span><span class="token class-name">String</span> beanName <span class="token operator">=</span> definitionHolder<span class="token punctuation">.</span><span class="token function">getBeanName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//å®ŒæˆBeanDefinitionçš„æ³¨å†Œï¼Œé‡ç‚¹çœ‹ï¼Œé‡è¦ç¨‹åº¦ 5</span>registry<span class="token punctuation">.</span><span class="token function">registerBeanDefinition</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> definitionHolder<span class="token punctuation">.</span><span class="token function">getBeanDefinition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//å»ºç«‹åˆ«åå’Œ idçš„æ˜ å°„ï¼Œè¿™æ ·å°±å¯ä»¥æ ¹æ®åˆ«åè·å–åˆ°id</span><span class="token comment">// Register aliases for bean name, if any.</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> aliases <span class="token operator">=</span> definitionHolder<span class="token punctuation">.</span><span class="token function">getAliases</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>aliases <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> alias <span class="token operator">:</span> aliases<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>registry<span class="token punctuation">.</span><span class="token function">registerAlias</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> alias<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/*** DefaultListableBeanFactory* Description: è‡ªå®šä¹‰æ ‡ç­¾çš„æ³¨å†Œï¼Œå’Œé»˜è®¤æ ‡ç­¾çš„æ³¨å†Œæ–¹å¼ä¸€è‡´ï¼Œä¸¤ä¸ªmap*/</span><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">registerBeanDefinition</span><span class="token punctuation">(</span><span class="token class-name">String</span> beanName<span class="token punctuation">,</span> <span class="token class-name">BeanDefinition</span> beanDefinition<span class="token punctuation">)</span><span class="token keyword">throws</span> <span class="token class-name">BeanDefinitionStoreException</span> <span class="token punctuation">&#123;</span><span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">hasText</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> <span class="token string">"Bean name must not be empty"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">notNull</span><span class="token punctuation">(</span>beanDefinition<span class="token punctuation">,</span> <span class="token string">"BeanDefinition must not be null"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>beanDefinition <span class="token keyword">instanceof</span> <span class="token class-name">AbstractBeanDefinition</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">try</span> <span class="token punctuation">&#123;</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">AbstractBeanDefinition</span><span class="token punctuation">)</span> beanDefinition<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">validate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">BeanDefinitionValidationException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BeanDefinitionStoreException</span><span class="token punctuation">(</span>beanDefinition<span class="token punctuation">.</span><span class="token function">getResourceDescription</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> beanName<span class="token punctuation">,</span><span class="token string">"Validation of bean definition failed"</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token comment">// å…ˆåˆ¤æ–­ BeanDefinitionæ˜¯å¦å·²ç»æ³¨å†Œ</span><span class="token class-name">BeanDefinition</span> existingDefinition <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>beanDefinitionMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>existingDefinition <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isAllowBeanDefinitionOverriding</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BeanDefinitionOverrideException</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> beanDefinition<span class="token punctuation">,</span> existingDefinition<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">// ...... çœç•¥ ......</span><span class="token keyword">else</span> <span class="token punctuation">&#123;</span><span class="token comment">// æŠŠ beanDefinition ç¼“å­˜åˆ°mapä¸­</span><span class="token keyword">this</span><span class="token punctuation">.</span>beanDefinitionMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> beanDefinition<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//æŠŠ beanNameæ”¾åˆ° beanDefinitionNames listä¸­ï¼Œbeanå®ä¾‹åŒ–çš„æ—¶å€™éœ€è¦ç”¨åˆ°</span><span class="token keyword">this</span><span class="token punctuation">.</span>beanDefinitionNames<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">this</span><span class="token punctuation">.</span>manualSingletonNames<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">this</span><span class="token punctuation">.</span>frozenBeanDefinitionNames <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>existingDefinition <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">||</span> <span class="token function">containsSingleton</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token function">resetBeanDefinition</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è‡³æ­¤ï¼Œè‡ªå®šä¹‰æ ‡ç­¾çš„è§£æè¿‡ç¨‹å…¨éƒ¨å®Œæˆï¼Œä¹Ÿæ˜¯refreshæ–¹æ³•ä¸­çš„obtainFreshBeanFactory()æ–¹æ³•æ‰§è¡Œå®Œæˆã€‚ä¸»è¦åŠŸèƒ½æ€»ç»“ä¸‹ï¼š</p><ul><li>åˆ›å»ºBeanFactoryå¯¹è±¡</li><li>è§£æxmlæ ‡ç­¾ï¼Œå°è£…æˆBeanDefinitionå¯¹è±¡å¹¶ç¼“å­˜èµ·æ¥ï¼Œæ–¹ä¾¿åç»­beançš„å®ä¾‹åŒ–è°ƒç”¨</li></ul><p>ä¸‹ä¸€ç« ï¼Œæˆ‘å°†è·Ÿä¸‹Springå®¹å™¨beançš„å®ä¾‹åŒ–è¿‡ç¨‹ï¼Œæ•¬è¯·æœŸå¾….^_^</p>]]></content>
      
      
      <categories>
          
          <category> Springæºç å­¦ä¹  </category>
          
      </categories>
      
      
        <tags>
            
            <tag> æºç  </tag>
            
            <tag> Spring </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ã€LeetCodeã€‘404. å·¦å¶å­ä¹‹å’Œ</title>
      <link href="/posts/37551.html"/>
      <url>/posts/37551.html</url>
      
        <content type="html"><![CDATA[<h1 id="1-é—®é¢˜"><a href="#1-é—®é¢˜" class="headerlink" title="1.é—®é¢˜"></a>1.é—®é¢˜</h1><p>ç»™å®šäºŒå‰æ ‘çš„æ ¹èŠ‚ç‚¹ root ï¼Œè¿”å›æ‰€æœ‰å·¦å¶å­ä¹‹å’Œã€‚</p><h2 id="ç¤ºä¾‹-1"><a href="#ç¤ºä¾‹-1" class="headerlink" title="ç¤ºä¾‹ 1"></a>ç¤ºä¾‹ 1</h2><p><img src="https://cdn.jsdelivr.net/gh/zyxelva/picgo@main/csdn/1c8275a05ba44dd4938411125d5f47dc.png" alt="å›¾1"></p><blockquote><p>è¾“å…¥: root &#x3D; [3,9,20,null,null,15,7]<br>è¾“å‡º: 24</p></blockquote><p>è§£é‡Š: åœ¨è¿™ä¸ªäºŒå‰æ ‘ä¸­ï¼Œæœ‰ä¸¤ä¸ªå·¦å¶å­ï¼Œåˆ†åˆ«æ˜¯ 9 å’Œ 15ï¼Œæ‰€ä»¥è¿”å› 24</p><h2 id="ç¤ºä¾‹-2"><a href="#ç¤ºä¾‹-2" class="headerlink" title="ç¤ºä¾‹ 2"></a>ç¤ºä¾‹ 2</h2><blockquote><p>è¾“å…¥: root &#x3D; [1]<br>è¾“å‡º: 0</p></blockquote><p><strong>æç¤º</strong>:</p><ul><li>èŠ‚ç‚¹æ•°åœ¨ [1, 1000] èŒƒå›´å†…</li><li>-1000 &lt;&#x3D; Node.val &lt;&#x3D; 1000</li></ul><h1 id="2-è§£é¢˜æ€è·¯"><a href="#2-è§£é¢˜æ€è·¯" class="headerlink" title="2.è§£é¢˜æ€è·¯"></a>2.è§£é¢˜æ€è·¯</h1><h2 id="2-1-é€’å½’"><a href="#2-1-é€’å½’" class="headerlink" title="2.1 é€’å½’"></a>2.1 é€’å½’</h2><p>æŒ‰ç…§é¢˜ç›®æè¿°ï¼Œæˆ‘ä»¬éœ€è¦éå†æ¯ä¸ªæ ‘èŠ‚ç‚¹ï¼Œå¯¹äºç›®æ ‡å€¼ï¼Œæˆ‘ä»¬éœ€è¦åˆ¤å®šæŸä¸ªèŠ‚ç‚¹æ˜¯å¦æ˜¯éœ€è¦çš„ï¼Œæ—¢è¦åˆ¤å®šæ˜¯å¶å­èŠ‚ç‚¹ï¼Œåˆè¦åˆ¤å®šæ˜¯å·¦è¾¹çš„å¶å­èŠ‚ç‚¹ï¼Œå› è€Œå¯¹äºå’Œçš„ç»„æˆï¼Œè¿›è¡Œåˆ†ç±»è°ˆè®ºï¼Œå¦‚ä¸‹ï¼š<br>1ï¼‰èŠ‚ç‚¹ä¸ºnullï¼Œè¿”å›ï¼›<br>2ï¼‰è¯¥èŠ‚ç‚¹å·¦å­æ ‘ä¸ä¸ºç©ºï¼Œä¸”ä¸ºå¶å­èŠ‚ç‚¹ï¼Œsum+&#x3D;è¯¥èŠ‚ç‚¹çš„valueï¼›å¦åˆ™é€’å½’å·¦å­æ ‘ï¼›<br>3ï¼‰è¯¥èŠ‚ç‚¹å³å­æ ‘ä¸ä¸ºç©ºï¼Œè¿™é‡Œåˆè¦åˆ†ç±»ï¼š<br>    3.1ï¼‰å³å­æ ‘ä¸ºå¶å­èŠ‚ç‚¹ï¼Œä¸æ˜¯é¢˜ç›®éœ€è¦çš„å€¼çš„ç»„æˆéƒ¨åˆ†ï¼›<br>    3.2ï¼‰å³å­æ ‘çš„å­èŠ‚ç‚¹ï¼Œåªè¦å·¦å³å…¶ä¸­ä¸€ä¸ªä¸ä¸ºç©ºï¼Œç»§ç»­é€’å½’ã€‚</p><p>ä¼ªä»£ç ï¼š</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">//sumOfLeftLeaves(TreeNode root)ä¸ºè®¡ç®—rootæ‰€æœ‰å·¦å¶å­èŠ‚ç‚¹çš„å’Œçš„å‡½æ•°ã€‚</span><span class="token keyword">int</span> <span class="token function">sumOfLeftLeaves</span><span class="token punctuation">(</span><span class="token class-name">TreeNode</span> root<span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token comment">//èŠ‚ç‚¹ä¸ºnull</span><span class="token keyword">if</span> root ä¸º<span class="token keyword">null</span><span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">//å·¦å­æ ‘</span><span class="token keyword">if</span> root<span class="token punctuation">.</span>left ä¸ä¸º<span class="token keyword">null</span><span class="token comment">//root.leftä¸ºå¶å­èŠ‚ç‚¹</span><span class="token keyword">if</span><span class="token punctuation">(</span>root<span class="token punctuation">.</span>leftä¸ºå¶å­èŠ‚ç‚¹<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>sum<span class="token operator">+=</span>root<span class="token punctuation">.</span>left<span class="token punctuation">.</span>val<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">//å¦åˆ™ï¼Œç»§ç»­é€’å½’å·¦å­æ ‘</span><span class="token keyword">else</span> <span class="token punctuation">&#123;</span>sum<span class="token operator">+=</span><span class="token function">sumOfLeftLeaves</span><span class="token punctuation">(</span>root<span class="token punctuation">.</span>left<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">//å³å­æ ‘</span><span class="token keyword">if</span> root<span class="token punctuation">.</span>right ä¸ä¸º<span class="token keyword">null</span><span class="token comment">//åªè¦ä¸æ˜¯å¶å­èŠ‚ç‚¹ï¼Œç»§ç»­é€’å½’</span><span class="token keyword">if</span> root<span class="token punctuation">.</span>right ä¸æ˜¯å¶å­èŠ‚ç‚¹ sum<span class="token operator">+=</span><span class="token function">sumOfLeftLeaves</span><span class="token punctuation">(</span>root<span class="token punctuation">.</span>right<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">return</span> sum<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è€Œåˆ¤å®šæ˜¯å¦æ˜¯å¶å­èŠ‚ç‚¹ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">//åˆ¤å®šæ˜¯å¶å­èŠ‚ç‚¹</span><span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">isLeaf</span><span class="token punctuation">(</span><span class="token class-name">TreeNode</span> node<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token operator">!=</span>node <span class="token operator">&amp;&amp;</span> <span class="token keyword">null</span><span class="token operator">==</span>node<span class="token punctuation">.</span>left <span class="token operator">&amp;&amp;</span> <span class="token keyword">null</span><span class="token operator">==</span>node<span class="token punctuation">.</span>right<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h2 id="2-2-æ”¹è¿›çš„é€’å½’"><a href="#2-2-æ”¹è¿›çš„é€’å½’" class="headerlink" title="2.2 æ”¹è¿›çš„é€’å½’"></a>2.2 æ”¹è¿›çš„é€’å½’</h2><p>ä¸Šè¿°é€’å½’æµç¨‹ï¼Œè¿‡ç¨‹æ˜¯æ¸…æ™°æ˜äº†çš„ï¼Œä½†åˆ¤å®šé€»è¾‘æœ‰ç‚¹å¤æ‚ï¼Œå¯¹äºé¢˜ç›®å·²çŸ¥çš„æ¡ä»¶ï¼Œæˆ‘ä»¬åªéœ€è¦æŠ“é‡ç‚¹ï¼Œ<strong>å·¦å¶å­èŠ‚ç‚¹çš„å’Œ</strong>ï¼Œå…¶ä»–éƒ½æ”¾åœ¨é€’å½’ç®—æ³•é‡Œäº†ã€‚<br>è¯¦ç»†ä»£ç ï¼Œè§ç¬¬3èŠ‚ä»£ç ã€‚</p><h2 id="2-3-BFS"><a href="#2-3-BFS" class="headerlink" title="2.3 BFS"></a>2.3 BFS</h2><p>å‰é¢è®¨è®ºçš„ç®—æ³•ï¼Œéå†è·¯å¾„ç±»ä¼¼å‰åºéå†ï¼Œå…ˆæ ¹èŠ‚ç‚¹ï¼Œå†å·¦å³å­èŠ‚ç‚¹ï¼Œæœ¬è´¨æ€æƒ³è¿˜æ˜¯æ·±åº¦ä¼˜å…ˆï¼ˆDFSï¼‰ã€‚åœ¨äºŒå‰æ ‘éå†ç³»åˆ—æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨å±‚åºéå†ï¼ŒåŒæ ·å¯ä»¥è§£å†³æœ¬ç« é—®é¢˜ï¼Œå…¶æ€æƒ³è¿˜æ˜¯å¹¿åº¦ä¼˜å…ˆç®—æ³•ï¼ˆBFSï¼‰ã€‚</p><h1 id="3-ä»£ç "><a href="#3-ä»£ç " class="headerlink" title="3.ä»£ç "></a>3.ä»£ç </h1><h2 id="3-1-é€’å½’ç®—æ³•"><a href="#3-1-é€’å½’ç®—æ³•" class="headerlink" title="3.1 é€’å½’ç®—æ³•"></a>3.1 é€’å½’ç®—æ³•</h2><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">sumOfLeftLeaves2</span><span class="token punctuation">(</span><span class="token class-name">TreeNode</span> root<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token operator">==</span>root<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>       <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>   <span class="token punctuation">&#125;</span>   <span class="token keyword">int</span> sum<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token operator">!=</span>root<span class="token punctuation">.</span>left<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>       <span class="token comment">//å·¦å­æ ‘ä¸ºå¶å­èŠ‚ç‚¹ï¼Œç›´æ¥åŠ ä¸Šï¼Œå¦åˆ™ç»§ç»­é€’å½’å·¦å­æ ‘</span>       <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">isLeaf</span><span class="token punctuation">(</span>root<span class="token punctuation">.</span>left<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>           sum<span class="token operator">+=</span>root<span class="token punctuation">.</span>left<span class="token punctuation">.</span>val<span class="token punctuation">;</span>       <span class="token punctuation">&#125;</span><span class="token keyword">else</span> <span class="token punctuation">&#123;</span>           sum<span class="token operator">+=</span><span class="token function">sumOfLeftLeaves</span><span class="token punctuation">(</span>root<span class="token punctuation">.</span>left<span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token punctuation">&#125;</span>   <span class="token punctuation">&#125;</span>   <span class="token comment">//å³å­æ ‘åªè¦ä¸ä¸ºç©ºï¼Œä¸”è‡³å°‘å­˜åœ¨ä¸€ä¸ªèŠ‚ç‚¹ï¼ˆä¸ç®¡æ˜¯å·¦è¿˜æ˜¯å³ï¼‰</span>   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token operator">!=</span>root<span class="token punctuation">.</span>right<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>       <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isLeaf</span><span class="token punctuation">(</span>root<span class="token punctuation">.</span>right<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>           sum<span class="token operator">+=</span><span class="token function">sumOfLeftLeaves</span><span class="token punctuation">(</span>root<span class="token punctuation">.</span>right<span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token punctuation">&#125;</span>   <span class="token punctuation">&#125;</span>   <span class="token keyword">return</span> sum<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="3-2-æ”¹è¿›çš„é€’å½’"><a href="#3-2-æ”¹è¿›çš„é€’å½’" class="headerlink" title="3.2 æ”¹è¿›çš„é€’å½’"></a>3.2 æ”¹è¿›çš„é€’å½’</h2><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">int</span> sum<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span><span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">sumOfLeftLeaves</span><span class="token punctuation">(</span><span class="token class-name">TreeNode</span> root<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token function">dfs</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> sum<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">dfs</span><span class="token punctuation">(</span><span class="token class-name">TreeNode</span> root<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token operator">==</span>root<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token keyword">return</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">//æ˜¯å·¦å¶å­èŠ‚ç‚¹</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token operator">!=</span>root<span class="token punctuation">.</span>left <span class="token operator">&amp;&amp;</span> <span class="token function">isLeaf</span><span class="token punctuation">(</span>root<span class="token punctuation">.</span>left<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        sum<span class="token operator">+=</span>root<span class="token punctuation">.</span>left<span class="token punctuation">.</span>val<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">//ç»§ç»­éå†å·¦å³å­æ ‘</span>    <span class="token function">dfs</span><span class="token punctuation">(</span>root<span class="token punctuation">.</span>left<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">dfs</span><span class="token punctuation">(</span>root<span class="token punctuation">.</span>right<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="3-3-å¹¿åº¦ä¼˜å…ˆç®—æ³•"><a href="#3-3-å¹¿åº¦ä¼˜å…ˆç®—æ³•" class="headerlink" title="3.3 å¹¿åº¦ä¼˜å…ˆç®—æ³•"></a>3.3 å¹¿åº¦ä¼˜å…ˆç®—æ³•</h2><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">sumOfLeftLeaves</span><span class="token punctuation">(</span><span class="token class-name">TreeNode</span> root<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token operator">==</span>root<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>       <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>   <span class="token punctuation">&#125;</span>   <span class="token keyword">int</span> sum<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>   <span class="token comment">//é˜Ÿåˆ—</span>   <span class="token class-name">Queue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TreeNode</span><span class="token punctuation">></span></span> q<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">LinkedList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   q<span class="token punctuation">.</span><span class="token function">offer</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token class-name">TreeNode</span> node<span class="token punctuation">;</span>   <span class="token comment">//éå†é˜Ÿåˆ—</span>   <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token operator">!</span>q<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>       node<span class="token operator">=</span>q<span class="token punctuation">.</span><span class="token function">poll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token operator">==</span>node<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>           <span class="token keyword">continue</span><span class="token punctuation">;</span>       <span class="token punctuation">&#125;</span>       <span class="token comment">//å·¦å¶å­èŠ‚ç‚¹</span>       <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token operator">!=</span>node<span class="token punctuation">.</span>left <span class="token operator">&amp;&amp;</span> <span class="token function">isLeaf</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>left<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>           sum<span class="token operator">+=</span>node<span class="token punctuation">.</span>left<span class="token punctuation">.</span>val<span class="token punctuation">;</span>       <span class="token punctuation">&#125;</span>       q<span class="token punctuation">.</span><span class="token function">offer</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>left<span class="token punctuation">)</span><span class="token punctuation">;</span>       q<span class="token punctuation">.</span><span class="token function">offer</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>right<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token punctuation">&#125;</span>   <span class="token keyword">return</span> sum<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> ç®—æ³• </category>
          
      </categories>
      
      
        <tags>
            
            <tag> LeetCode </tag>
            
            <tag> ç®—æ³• </tag>
            
            <tag> äºŒå‰æ ‘ </tag>
            
            <tag> æ•°æ®ç»“æ„ </tag>
            
            <tag> Java </tag>
            
            <tag> DFS </tag>
            
            <tag> BFS </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ã€LeetCodeã€‘199.äºŒå‰æ ‘çš„å³è§†å›¾</title>
      <link href="/posts/26388.html"/>
      <url>/posts/26388.html</url>
      
        <content type="html"><![CDATA[<h1 id="1-é—®é¢˜"><a href="#1-é—®é¢˜" class="headerlink" title="1.é—®é¢˜"></a>1.é—®é¢˜</h1><p>ç»™å®šä¸€ä¸ªäºŒå‰æ ‘çš„ æ ¹èŠ‚ç‚¹ rootï¼Œæƒ³è±¡è‡ªå·±ç«™åœ¨å®ƒçš„å³ä¾§ï¼ŒæŒ‰ç…§ä»é¡¶éƒ¨åˆ°åº•éƒ¨çš„é¡ºåºï¼Œè¿”å›ä»å³ä¾§æ‰€èƒ½çœ‹åˆ°çš„èŠ‚ç‚¹å€¼ã€‚</p><p>##ç¤ºä¾‹ 1</p><p><img src="https://cdn.jsdelivr.net/gh/zyxelva/picgo@main/csdn/6d1b1555754a31a4f682823c3d811e34.jpeg"></p><blockquote><p>è¾“å…¥: [1,2,3,null,5,null,4]<br>è¾“å‡º: [1,3,4]</p></blockquote><p>##ç¤ºä¾‹ 2</p><blockquote><p>è¾“å…¥: [1,null,3]<br>è¾“å‡º: [1,3]</p></blockquote><p>##ç¤ºä¾‹ 3</p><blockquote><p>è¾“å…¥: []<br>è¾“å‡º: []</p></blockquote><p><strong>æç¤º</strong>:</p><ul><li>äºŒå‰æ ‘çš„èŠ‚ç‚¹ä¸ªæ•°çš„èŒƒå›´æ˜¯ [0,100]</li><li>-100 &lt;&#x3D; Node.val &lt;&#x3D; 100</li></ul><h1 id="2-è§£é¢˜æ€è·¯"><a href="#2-è§£é¢˜æ€è·¯" class="headerlink" title="2.è§£é¢˜æ€è·¯"></a>2.è§£é¢˜æ€è·¯</h1><p>ç»å†è¿‡å‰é¢å‡ ç¯‡å…³äºäºŒå‰æ ‘çš„å±‚åºéå†ç®—æ³•ä¹‹åï¼ˆå‚è§<a href="https://zyxelva.github.io/posts/46738.html">102.äºŒå‰æ ‘çš„å±‚åºéå†</a>ï¼Œ<a href="https://zyxelva.github.io/posts/45075.html">107.äºŒå‰æ ‘çš„å±‚åºéå†II</a>ï¼Œéå¸¸å®¹æ˜“çš„å°±å¯ä»¥é€šè¿‡è¿™ç§ç®—æ³•è§£ç­”æ­¤é¢˜ï¼ŒåŸºæœ¬æ€æƒ³å°±æ˜¯å›´ç»•é˜Ÿåˆ—æ€§è´¨ï¼Œå¹¿åº¦ä¼˜å…ˆç®—æ³•è§£å†³ã€‚å½“ç„¶ï¼Œæ·±åº¦ä¼˜å…ˆç®—æ³•ä¹Ÿæ˜¯å¯ä»¥è§£å†³çš„ã€‚</p><h2 id="2-1-å¹¿åº¦ä¼˜å…ˆï¼ˆBFSï¼‰"><a href="#2-1-å¹¿åº¦ä¼˜å…ˆï¼ˆBFSï¼‰" class="headerlink" title="2.1 å¹¿åº¦ä¼˜å…ˆï¼ˆBFSï¼‰"></a>2.1 å¹¿åº¦ä¼˜å…ˆï¼ˆBFSï¼‰</h2><p>åˆ©ç”¨é˜Ÿåˆ—ï¼Œéå†æ¯å±‚èŠ‚ç‚¹ï¼Œå¹¶è®°å½•æ¯å±‚æœ€åä¸€ä¸ªå…ƒç´ ï¼Œç›´åˆ°éå†å®Œæœ€åä¸€å±‚ï¼Œå³å¯å¾—åˆ°ç»“æœã€‚è®¿é—®é¡ºåºå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š<br><img src="https://cdn.jsdelivr.net/gh/zyxelva/picgo@main/csdn/25767cc8f2ce74adb672fd79bf3ddf17.png"><br>çº¢è‰²ç»“ç‚¹è‡ªä¸Šè€Œä¸‹ç»„æˆç­”æ¡ˆï¼Œè¾¹ç¼˜ä»¥<strong>è®¿é—®é¡ºåº</strong>æ ‡å·ã€‚<br><strong>å¤æ‚åº¦</strong>ï¼š</p><ul><li>æ—¶é—´å¤æ‚åº¦ï¼š O(N)ï¼Œæ¯ä¸ªèŠ‚ç‚¹éƒ½å…¥é˜Ÿå‡ºé˜Ÿäº† 1 æ¬¡ã€‚ </li><li>ç©ºé—´å¤æ‚åº¦ï¼š O(N)ï¼Œä½¿ç”¨äº†é¢å¤–çš„é˜Ÿåˆ—ç©ºé—´ã€‚</li></ul><h2 id="2-2-æ·±åº¦ä¼˜å…ˆï¼ˆDFSï¼‰"><a href="#2-2-æ·±åº¦ä¼˜å…ˆï¼ˆDFSï¼‰" class="headerlink" title="2.2 æ·±åº¦ä¼˜å…ˆï¼ˆDFSï¼‰"></a>2.2 æ·±åº¦ä¼˜å…ˆï¼ˆDFSï¼‰</h2><p>1ï¼‰ä¼˜å…ˆè®¿é—®å³å­æ ‘ï¼Œå³è®¿é—®é¡ºåºä¸ºï¼šæ ¹-å³-å·¦ï¼›<br>2ï¼‰å¦‚æœå½“å‰èŠ‚ç‚¹æ‰€åœ¨æ·±åº¦è¿˜æ²¡æœ‰å‡ºç°åœ¨resé‡Œï¼ˆå› ä¸ºä¸€å±‚å°±ä¸€ä¸ªèŠ‚ç‚¹ï¼‰ï¼Œè¯´æ˜åœ¨è¯¥æ·±åº¦ä¸‹å½“å‰èŠ‚ç‚¹æ˜¯ç¬¬ä¸€ä¸ªè¢«è®¿é—®çš„èŠ‚ç‚¹ï¼Œå› æ­¤å°†å½“å‰èŠ‚ç‚¹åŠ å…¥resä¸­ã€‚</p><pre class="line-numbers language-none"><code class="language-none">if len(res) &lt; depth:    res.append(root.val)# éå†å³å­æ ‘if root.right:    dfs(root.right, depth + 1, res)# éå†å·¦å­æ ‘if root.left:    dfs(root.left, depth + 1, res)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>å¤æ‚åº¦</strong>ï¼š</p><ul><li>æ—¶é—´å¤æ‚åº¦ï¼š O(N)ï¼Œæ¯ä¸ªèŠ‚ç‚¹éƒ½è®¿é—®äº† 1 æ¬¡ã€‚ </li><li>ç©ºé—´å¤æ‚åº¦ï¼š O(N)ï¼Œå› ä¸ºè¿™ä¸æ˜¯ä¸€æ£µå¹³è¡¡äºŒå‰æ ‘ï¼ŒäºŒå‰æ ‘çš„æ·±åº¦æœ€å°‘æ˜¯ logN, æœ€åçš„æƒ…å†µä¸‹ä¼šé€€åŒ–æˆä¸€æ¡é“¾è¡¨ï¼Œæ·±åº¦å°±æ˜¯Nï¼Œå› æ­¤é€’å½’æ—¶ä½¿ç”¨çš„æ ˆç©ºé—´æ˜¯ O(N) çš„ã€‚</li></ul><h1 id="3-ä»£ç "><a href="#3-ä»£ç " class="headerlink" title="3.ä»£ç "></a>3.ä»£ç </h1><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/** * Definition for a binary tree node. * public class TreeNode &#123; *     int val; *     TreeNode left; *     TreeNode right; *     TreeNode() &#123;&#125; *     TreeNode(int val) &#123; this.val = val; &#125; *     TreeNode(int val, TreeNode left, TreeNode right) &#123; *         this.val = val; *         this.left = left; *         this.right = right; *     &#125; * &#125; */</span><span class="token keyword">class</span> <span class="token class-name">Solution</span> <span class="token punctuation">&#123;</span>    <span class="token comment">/**    å¹¿åº¦ä¼˜å…ˆ        1.åˆ©ç”¨å±‚åºéå†æ€æƒ³ï¼Œç»Ÿè®¡æ¯å±‚æœ€åä¸€ä¸ªå…ƒç´ ï¼Œå³ä¸ºç­”æ¡ˆ        2.åˆ†å±‚æ ‡è¯†     */</span>    <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">></span></span> <span class="token function">rightSideView2</span><span class="token punctuation">(</span><span class="token class-name">TreeNode</span> root<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token comment">//ç©ºèŠ‚ç‚¹</span>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token operator">==</span>root<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">></span></span> res<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">//æ¯å±‚çš„éå†ç»“æœé›†</span>        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">></span></span> tmp<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">TreeNode</span> node<span class="token punctuation">;</span>        <span class="token comment">//é˜Ÿåˆ—</span>        <span class="token class-name">Queue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TreeNode</span><span class="token punctuation">></span></span> q<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">LinkedList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">//å…¥é˜Ÿ</span>        q<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">//åˆ†å±‚æ ‡è¯†</span>        q<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token operator">!</span>q<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            node<span class="token operator">=</span>q<span class="token punctuation">.</span><span class="token function">poll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token operator">!=</span>node<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>                tmp<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>val<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment">//å·¦å³å­æ ‘å…¥é˜Ÿ</span>                <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token operator">!=</span>node<span class="token punctuation">.</span>left<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>                    q<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>left<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">&#125;</span>                <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token operator">!=</span>node<span class="token punctuation">.</span>right<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>                    q<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>right<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">&#125;</span>            <span class="token punctuation">&#125;</span>            <span class="token comment">//å¦å±‚ï¼Œè¯¥å±‚éå†å®Œæ¯•</span>            <span class="token keyword">else</span><span class="token punctuation">&#123;</span>                <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>tmp<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>                    <span class="token comment">//æ”¶é›†æ¯å±‚æœ€åä¸€ä¸ªå…ƒç´ </span>                    res<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>tmp<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>tmp<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    tmp<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    q<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">&#125;</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">return</span> res<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">//æ·±åº¦ä¼˜å…ˆï¼Œé€’å½’</span>    <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">></span></span> <span class="token function">rightSideView</span><span class="token punctuation">(</span><span class="token class-name">TreeNode</span> root<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token comment">//åˆ¤ç©º</span>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token operator">==</span>root<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">></span></span> res<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">dfs</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> res<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> res<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">dfs</span><span class="token punctuation">(</span><span class="token class-name">TreeNode</span> root<span class="token punctuation">,</span> <span class="token keyword">int</span> depth<span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">></span></span> res<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">==</span>depth<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            res<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>root<span class="token punctuation">.</span>val<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token comment">//å·¦å³å­æ ‘ï¼Œå…ˆéå†å³å­æ ‘ï¼Œç„¶åå·¦å­æ ‘</span>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token operator">!=</span>root<span class="token punctuation">.</span>right<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            <span class="token function">dfs</span><span class="token punctuation">(</span>root<span class="token punctuation">.</span>right<span class="token punctuation">,</span> depth<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span> res<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token operator">!=</span>root<span class="token punctuation">.</span>left<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            <span class="token function">dfs</span><span class="token punctuation">(</span>root<span class="token punctuation">.</span>left<span class="token punctuation">,</span> depth<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span> res<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> ç®—æ³• </category>
          
      </categories>
      
      
        <tags>
            
            <tag> LeetCode </tag>
            
            <tag> ç®—æ³• </tag>
            
            <tag> äºŒå‰æ ‘ </tag>
            
            <tag> æ•°æ®ç»“æ„ </tag>
            
            <tag> Java </tag>
            
            <tag> DFS </tag>
            
            <tag> BFS </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ã€LeetCodeã€‘1768.äº¤æ›¿åˆå¹¶å­—ç¬¦ä¸²</title>
      <link href="/posts/39957.html"/>
      <url>/posts/39957.html</url>
      
        <content type="html"><![CDATA[<h1 id="ä¸€ã€é—®é¢˜"><a href="#ä¸€ã€é—®é¢˜" class="headerlink" title="ä¸€ã€é—®é¢˜"></a>ä¸€ã€é—®é¢˜</h1><p>ç»™ä½ ä¸¤ä¸ªå­—ç¬¦ä¸² <code>word1</code> å’Œ <code>word2</code> ã€‚è¯·ä½ ä» <code>word1</code> å¼€å§‹ï¼Œé€šè¿‡äº¤æ›¿æ·»åŠ å­—æ¯æ¥åˆå¹¶å­—ç¬¦ä¸²ã€‚å¦‚æœä¸€ä¸ªå­—ç¬¦ä¸²æ¯”å¦ä¸€ä¸ªå­—ç¬¦ä¸²é•¿ï¼Œå°±å°†å¤šå‡ºæ¥çš„å­—æ¯è¿½åŠ åˆ°åˆå¹¶åå­—ç¬¦ä¸²çš„æœ«å°¾ã€‚è¿”å›åˆå¹¶åçš„å­—ç¬¦ä¸² ã€‚</p><h1 id="äºŒã€è§£é¢˜æ€è·¯"><a href="#äºŒã€è§£é¢˜æ€è·¯" class="headerlink" title="äºŒã€è§£é¢˜æ€è·¯"></a>äºŒã€è§£é¢˜æ€è·¯</h1><h2 id="1-åŒæŒ‡é’ˆ"><a href="#1-åŒæŒ‡é’ˆ" class="headerlink" title="1.åŒæŒ‡é’ˆ"></a>1.åŒæŒ‡é’ˆ</h2><p>1ï¼‰iï¼Œjåˆ†åˆ«æŒ‡å‘å­—ç¬¦ä¸²word<del>1</del>ï¼Œword<del>2</del>;<br>2ï¼‰å¾ªç¯éå†word<del>1</del>ï¼Œword<del>2</del>ï¼Œåªè¦iï¼Œjå‡éå†å®Œæˆ</p><h2 id="2-å•æŒ‡é’ˆ"><a href="#2-å•æŒ‡é’ˆ" class="headerlink" title="2.å•æŒ‡é’ˆ"></a>2.å•æŒ‡é’ˆ</h2><p>å…¶å®ï¼Œåªè¦ä¸€ä¸ªæŒ‡é’ˆå°±å¯ä»¥æå®šï¼Œè€Œä¸”éå†æ¬¡æ•°æœ€å¤šMath.min(word<del>1</del> çš„é•¿åº¦, word<del>2</del> çš„é•¿åº¦)ï¼Œå‰©ä¸‹çš„æœ€é•¿é‚£ä¸ªå­—ç¬¦ä¸²ï¼Œåˆ©ç”¨String.substring(index)å³å¯å¾—åˆ°éœ€è¦çš„ç­”æ¡ˆã€‚ä¼ªä»£ç å¦‚ä¸‹ï¼š</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">while</span><span class="token punctuation">(</span>i<span class="token operator">&lt;</span>minLength<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>sb<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>word1<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>sb<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>word2<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">if</span><span class="token punctuation">(</span>i<span class="token operator">&lt;</span>word1<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>sb<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>word1<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">if</span><span class="token punctuation">(</span>i<span class="token operator">&lt;</span>word2<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>sb<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>word2<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h1 id="ä¸‰ã€ä»£ç "><a href="#ä¸‰ã€ä»£ç " class="headerlink" title="ä¸‰ã€ä»£ç "></a>ä¸‰ã€ä»£ç </h1><h2 id="1-åŒæŒ‡é’ˆ-1"><a href="#1-åŒæŒ‡é’ˆ-1" class="headerlink" title="1.åŒæŒ‡é’ˆ"></a>1.åŒæŒ‡é’ˆ</h2><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">class</span> <span class="token class-name">Solution</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">mergeAlternately</span><span class="token punctuation">(</span><span class="token class-name">String</span> word1<span class="token punctuation">,</span> <span class="token class-name">String</span> word2<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">int</span> m <span class="token operator">=</span> word1<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">int</span> n <span class="token operator">=</span> word2<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>        <span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>        <span class="token class-name">StringBuilder</span> ans <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">while</span> <span class="token punctuation">(</span>i <span class="token operator">&lt;</span> m <span class="token operator">||</span> j <span class="token operator">&lt;</span> n<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">&lt;</span> m<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                ans<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>word1<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token operator">++</span>i<span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>j <span class="token operator">&lt;</span> n<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                ans<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>word2<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span>j<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token operator">++</span>j<span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">return</span> ans<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token comment">/**ä½œè€…ï¼šåŠ›æ‰£å®˜æ–¹é¢˜è§£é“¾æ¥ï¼šhttps://leetcode.cn/problems/merge-strings-alternately/solutions/1913930/jiao-ti-he-bing-zi-fu-chuan-by-leetcode-ac4ih/æ¥æºï¼šåŠ›æ‰£ï¼ˆLeetCodeï¼‰è‘—ä½œæƒå½’ä½œè€…æ‰€æœ‰ã€‚å•†ä¸šè½¬è½½è¯·è”ç³»ä½œè€…è·å¾—æˆæƒï¼Œéå•†ä¸šè½¬è½½è¯·æ³¨æ˜å‡ºå¤„ã€‚*/</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="2-å•æŒ‡é’ˆ-1"><a href="#2-å•æŒ‡é’ˆ-1" class="headerlink" title="2.å•æŒ‡é’ˆ"></a>2.å•æŒ‡é’ˆ</h2><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">mergeAlternately</span><span class="token punctuation">(</span><span class="token class-name">String</span> word1<span class="token punctuation">,</span> <span class="token class-name">String</span> word2<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>    <span class="token class-name">StringBuilder</span> sb<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">StringBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">int</span> minLength<span class="token operator">=</span><span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>word1<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> word2<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">while</span><span class="token punctuation">(</span>i<span class="token operator">&lt;</span>minLength<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        sb<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>word1<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        sb<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>word2<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        i<span class="token operator">++</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>i<span class="token operator">&lt;</span>word1<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        sb<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>word1<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>i<span class="token operator">&lt;</span>word2<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        sb<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>word2<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">return</span> sb<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span>  <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="å¤æ‚åº¦åˆ†æ"><a href="#å¤æ‚åº¦åˆ†æ" class="headerlink" title="å¤æ‚åº¦åˆ†æ"></a>å¤æ‚åº¦åˆ†æ</h2><ul><li><p>æ—¶é—´å¤æ‚åº¦ï¼šO(m+n)ï¼Œå…¶ä¸­ m å’Œ n åˆ†åˆ«æ˜¯å­—ç¬¦ä¸² word<del>1</del> å’Œ word<del>2</del> çš„é•¿åº¦ã€‚</p></li><li><p>ç©ºé—´å¤æ‚åº¦ï¼šO(1)æˆ– O(m+n)ã€‚å¦‚æœä½¿ç”¨çš„è¯­è¨€æ”¯æŒå¯ä¿®æ”¹çš„å­—ç¬¦ä¸²ï¼Œé‚£ä¹ˆç©ºé—´å¤æ‚åº¦ä¸º O(1)ï¼Œå¦åˆ™ä¸º O(m+n)ï¼Œæ¯”å¦‚javaã€‚æ³¨æ„è¿™é‡Œä¸è®¡å…¥è¿”å›å€¼éœ€è¦çš„ç©ºé—´ã€‚</p></li></ul>]]></content>
      
      
      <categories>
          
          <category> ç®—æ³• </category>
          
      </categories>
      
      
        <tags>
            
            <tag> LeetCode </tag>
            
            <tag> ç®—æ³• </tag>
            
            <tag> æŒ‡é’ˆ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ã€Springæºç å­¦ä¹ ã€‘ç®€ä»‹</title>
      <link href="/posts/13868.html"/>
      <url>/posts/13868.html</url>
      
        <content type="html"><![CDATA[<h1 id="ä¸€ã€ä¸ºä»€ä¹ˆè¦å­¦ä¹ Springæºç "><a href="#ä¸€ã€ä¸ºä»€ä¹ˆè¦å­¦ä¹ Springæºç " class="headerlink" title="ä¸€ã€ä¸ºä»€ä¹ˆè¦å­¦ä¹ Springæºç "></a>ä¸€ã€ä¸ºä»€ä¹ˆè¦å­¦ä¹ Springæºç </h1><ul><li>å­¦ä¹ å¤§ç¥ä¼˜ç§€çš„æ€æƒ³å’Œä»£ç é£æ ¼</li><li>é¢è¯•ä¸“ä¸šå¹ç‰›é€¼çš„æ³•å®</li><li>å†™å‡ºæ›´åŠ ä¼˜ç§€çš„ä»£ç </li></ul><h1 id="äºŒã€æ€æ ·å­¦ä¹ æºç "><a href="#äºŒã€æ€æ ·å­¦ä¹ æºç " class="headerlink" title="äºŒã€æ€æ ·å­¦ä¹ æºç "></a>äºŒã€æ€æ ·å­¦ä¹ æºç </h1><ul><li>javaåŸºç¡€éœ€è¦è¿‡ç¡¬</li><li>è·Ÿç€demoè·Ÿä»£ç </li><li>è®°å½•æ¯ä¸ªçŸ¥è¯†ç‚¹ï¼Œæ–¹ä¾¿ä»¥åæŸ¥é˜…å’Œä¿®æ­£</li><li>æ³¨é‡Šå…³é”®ç‚¹ä»£ç </li><li>æœ‰è§„å¾‹çš„å¤ä¹ </li><li>åå¤Do Exercise(ä¸æ–­ç»ƒä¹ )-&gt;Learning(ç”±æµ…åˆ°æ·±ï¼Œç”±çª„åˆ°å®½)-&gt;Trying(å°è¯•è‡ªå·±å»å®ç°)-&gt;Teaching(æŠŠè‡ªå·±ç†è§£çš„è®²ç»™åˆ«äººå¬ï¼ŒæŸ¥æ¼è¡¥ç¼ºï¼Œäº’ç›¸è¿›æ­¥)</li></ul><h1 id="ä¸‰ã€æ­å»ºSpring-Demoé¡¹ç›®"><a href="#ä¸‰ã€æ­å»ºSpring-Demoé¡¹ç›®" class="headerlink" title="ä¸‰ã€æ­å»ºSpring-Demoé¡¹ç›®"></a>ä¸‰ã€æ­å»ºSpring-Demoé¡¹ç›®</h1><h2 id="1-å‰æœŸå‡†å¤‡"><a href="#1-å‰æœŸå‡†å¤‡" class="headerlink" title="1.å‰æœŸå‡†å¤‡"></a>1.å‰æœŸå‡†å¤‡</h2><ul><li>JDK8</li><li>Spring5.2.8Release</li><li>Idea</li><li>Maven</li></ul><h2 id="2-pomä¾èµ–å¯¼å…¥"><a href="#2-pomä¾èµ–å¯¼å…¥" class="headerlink" title="2.pomä¾èµ–å¯¼å…¥"></a>2.pomä¾èµ–å¯¼å…¥</h2><p>æœ€æœ€æ ¸å¿ƒçš„springä¾èµ–</p><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-context<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>$&#123;spring.version&#125;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å½“ç„¶è¿˜éœ€è¦å…¶ä»–çš„è¾…åŠ©ï¼Œæ¯”å¦‚æµ‹è¯•ã€æ—¥å¿—</p><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-test<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>$&#123;spring.version&#125;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>ch.qos.logback<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>logback-classic<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>1.1.2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="3-spring-xml"><a href="#3-spring-xml" class="headerlink" title="3.spring.xml"></a>3.spring.xml</h2><p>Springæ ¸å¿ƒé…ç½®æ–‡ä»¶</p><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>beans</span> <span class="token attr-name">xmlns</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://www.springframework.org/schema/beans<span class="token punctuation">"</span></span>       <span class="token attr-name"><span class="token namespace">xmlns:</span>xsi</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://www.w3.org/2001/XMLSchema-instance<span class="token punctuation">"</span></span>       <span class="token attr-name"><span class="token namespace">xmlns:</span>context</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://www.springframework.org/schema/context<span class="token punctuation">"</span></span>       <span class="token attr-name"><span class="token namespace">xmlns:</span>aop</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://www.springframework.org/schema/aop<span class="token punctuation">"</span></span>       <span class="token attr-name"><span class="token namespace">xmlns:</span>p</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://www.springframework.org/schema/p<span class="token punctuation">"</span></span>       <span class="token attr-name"><span class="token namespace">xmlns:</span>c</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://www.springframework.org/schema/c<span class="token punctuation">"</span></span>       <span class="token attr-name"><span class="token namespace">xsi:</span>schemaLocation</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://www.springframework.org/schema/beanshttp://www.springframework.org/schema/beans/spring-beans.xsd    http://www.springframework.org/schema/context    http://www.springframework.org/schema/context/spring-context.xsd    http://www.springframework.org/schema/aophttp://www.springframework.org/schema/aop/spring-aop-3.2.xsd<span class="token punctuation">"</span></span>    <span class="token attr-name">default-lazy-init</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>false<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    <span class="token comment">&lt;!--è‡ªå®šä¹‰æ ‡ç­¾--></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">context:</span>component-scan</span> <span class="token attr-name">base-package</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>com.enjoy.jack<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">context:</span>property-placeholder</span> <span class="token attr-name">location</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>classpath:application.properties<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å…¶ä¸­æœ€é‡è¦namespaceä¸º</p><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup">xmlns:context="http://www.springframework.org/schema/context"http://www.springframework.org/schema/contexthttp://www.springframework.org/schema/context/spring-context.xsd<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h1 id="å››ã€Springå®¹å™¨åŠ è½½æ–¹å¼"><a href="#å››ã€Springå®¹å™¨åŠ è½½æ–¹å¼" class="headerlink" title="å››ã€Springå®¹å™¨åŠ è½½æ–¹å¼"></a>å››ã€Springå®¹å™¨åŠ è½½æ–¹å¼</h1><ul><li>ç±»è·¯å¾„è·å–é…ç½®æ–‡ä»¶<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">ApplicationContext</span> applicationContext<span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ClassPathXmlApplicationContext</span><span class="token punctuation">(</span><span class="token string">"spring.xml"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li><li>æ–‡ä»¶ç³»ç»Ÿè·¯å¾„è·å–é…ç½®æ–‡ä»¶ã€ç»å¯¹è·¯å¾„ã€‘<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">ApplicationContext</span> applicationContext <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileSystemXmlApplicationContext</span><span class="token punctuation">(</span><span class="token string">"E:\com\public\springdemo\src\main\resources\spring.xml"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li><li>æ— é…ç½®æ–‡ä»¶åŠ è½½å®¹å™¨<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">ApplicationContext</span> applicationContext <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AnnotationConfigApplicationContext</span><span class="token punctuation">(</span><span class="token string">"com.xx.jack"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li><li>SpringbootåŠ è½½å®¹å™¨<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">ApplicationContext</span> applicationContext <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">EmbeddedWebApplicationContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li></ul><p>åç»­Springæºç è·Ÿè¿›ï¼Œæˆ‘ä¸»è¦ä»¥ClassPathXmlApplicationContextçš„æ–¹å¼ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> Springæºç å­¦ä¹  </category>
          
      </categories>
      
      
        <tags>
            
            <tag> æºç  </tag>
            
            <tag> Spring </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ã€MyBatisæºç å­¦ä¹ ã€‘Springé›†æˆMyBatisçš„åŸç†åˆ†æ</title>
      <link href="/posts/45086.html"/>
      <url>/posts/45086.html</url>
      
        <content type="html"><![CDATA[<h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><p>ä¸Šä¸€ç« ä¸­<a href="https://zyxelva.github.io/posts/53897.html">ã€MyBatisæºç å­¦ä¹ ã€‘MyBatisä¸Springæ•´åˆ</a>ï¼Œæˆ‘ä»¬ä»‹ç»äº†Mybatisä¸Springã€Spring Bootçš„èåˆï¼Œå…¶ä¸­æˆ‘ä»¬æåˆ°äº†mybatis-springä¸­çš„å‡ ä¸ªå…³é”®ç±»ï¼Œæœ¬ç« æˆ‘ä»¬æ¥è·Ÿè¸ªä¸‹è¿™å‡ ä¸ªå…³é”®ç±»çš„æºç ï¼Œçœ‹çœ‹å®ƒä»¬å¹²äº†äº›å•¥.</p><h1 id="ä¸€ã€æºç ä¸‹è½½"><a href="#ä¸€ã€æºç ä¸‹è½½" class="headerlink" title="ä¸€ã€æºç ä¸‹è½½"></a>ä¸€ã€æºç ä¸‹è½½</h1><p>å’Œmybatisæºç ä¸‹è½½ä¸€æ ·ï¼Œä»GitHubä¸‹è½½å¥½åï¼Œæœ¬åœ°æ‰“åŒ…éƒ¨ç½²ä¸€ä¸‹ï¼Œæ–¹ä¾¿æˆ‘ä»¬åé¢è¿›è¡Œæµ‹è¯•æ—¶æ–¹ä¾¿æŸ¥çœ‹ã€‚æºç åœ°å€ï¼š<a href="https://github.com/mybatis/spring">è¿™é‡Œæ˜¯MyBatis-Springæºç åœ°å€</a>.</p><h1 id="äºŒã€æ ¸å¿ƒç±»æºç è§£æ"><a href="#äºŒã€æ ¸å¿ƒç±»æºç è§£æ" class="headerlink" title="äºŒã€æ ¸å¿ƒç±»æºç è§£æ"></a>äºŒã€æ ¸å¿ƒç±»æºç è§£æ</h1><p>å…ˆæ¥å›é¡¾ä¸‹æ ¸å¿ƒç±»çš„åŠŸèƒ½ï¼š</p><ul><li>SqlSessionFactoryBeanï¼šç”¨äºåˆ›å»ºSqlSessionFactoryï¼›</li><li>MapperScannerConfigurerï¼šè‡ªåŠ¨æ‰«ææ‰€æœ‰çš„ Mapper æ¥å£ï¼Œä½¿ç”¨æ—¶å¯ä»¥ç›´æ¥æ³¨å…¥æ¥å£ã€‚</li></ul><h2 id="1-SqlSessionFactoryBean"><a href="#1-SqlSessionFactoryBean" class="headerlink" title="1.SqlSessionFactoryBean"></a>1.SqlSessionFactoryBean</h2><p>(1) UML<br><img src="https://cdn.jsdelivr.net/gh/zyxelva/picgo@main/csdn/20210324100712686.png"><br>(2) é…ç½®å’Œæºç è§£æ<br>é€šå¸¸æˆ‘ä»¬åœ¨é¡¹ç›®ä¸­æ•´åˆSpringå’Œmybatisæ—¶ï¼ŒSpringç›¸å…³çš„é…ç½®æ–‡ä»¶ä¼šåŒ…å«ï¼š</p><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token comment">&lt;!-- springå’ŒMyBatiså®Œç¾æ•´åˆï¼Œä¸éœ€è¦mybatisçš„é…ç½®æ˜ å°„æ–‡ä»¶ --></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>sqlSessionFactory<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>org.mybatis.spring.SqlSessionFactoryBean<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>dataSource<span class="token punctuation">"</span></span> <span class="token attr-name">ref</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>dataSource<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>typeAliasesPackage<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>com.enjoylearning.mybatis.entity<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>mapperLocations<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>classpath:sqlmapper/*.xml<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å¹¶ä¸”dataSourceå¿…é¡»é…ç½®ï¼Œæˆ‘ä»¬å¯ä»¥ä»æ–¹æ³•afterPropertiesSet()çœ‹å‡ºæ¥ï¼š</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/**   * åœ¨springå®¹å™¨ä¸­åˆ›å»ºå…¨å±€å”¯ä¸€çš„sqlSessionFactory   *   * @throws Exception å¼‚å¸¸   */</span>  <span class="token annotation punctuation">@Override</span>  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">afterPropertiesSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>    <span class="token comment">//æ•°æ®æºä¸èƒ½ä¸ºç©º</span>    <span class="token function">notNull</span><span class="token punctuation">(</span>dataSource<span class="token punctuation">,</span> <span class="token string">"Property 'dataSource' is required"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//sqlSessionFactoryBuilderä¸èƒ½ä¸ºç©ºï¼Œä½†åˆå§‹åŒ–SqlSessionFactoryBeanå®Œï¼ŒsqlSessionFactoryBuilderå·²ç»åˆ›å»ºäº†</span>    <span class="token function">notNull</span><span class="token punctuation">(</span>sqlSessionFactoryBuilder<span class="token punctuation">,</span> <span class="token string">"Property 'sqlSessionFactoryBuilder' is required"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">state</span><span class="token punctuation">(</span><span class="token punctuation">(</span>configuration <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> configLocation <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token operator">!</span><span class="token punctuation">(</span>configuration <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> configLocation <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">,</span>              <span class="token string">"Property 'configuration' and 'configLocation' can not specified with together"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>sqlSessionFactory <span class="token operator">=</span> <span class="token function">buildSqlSessionFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æ¥ä¸‹æ¥ï¼Œçœ‹çœ‹æ–¹æ³•ã€‚ä¸»è¦åŠŸèƒ½æ„å»ºå’Œä¸°å¯ŒConfigurationï¼Œå¹¶åˆ›å»ºsqlSessionFactory.</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/**   * Build a &#123;@code SqlSessionFactory&#125; instance.   *   * The default implementation uses the standard MyBatis &#123;@code XMLConfigBuilder&#125; API to build a   * &#123;@code SqlSessionFactory&#125; instance based on an Reader.   * Since 1.3.0, it can be specified a &#123;@link Configuration&#125; instance directly(without config file).   *   * @return SqlSessionFactory   * @throws IOException if loading the config file failed   */</span>  <span class="token keyword">protected</span> <span class="token class-name">SqlSessionFactory</span> <span class="token function">buildSqlSessionFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">&#123;</span>    <span class="token class-name">Configuration</span> configuration<span class="token punctuation">;</span>    <span class="token class-name">XMLConfigBuilder</span> xmlConfigBuilder <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>    <span class="token comment">//å¦‚æœconfigurationä¸ä¸ºç©ºï¼Œåˆ™ä½¿ç”¨è¯¥å¯¹è±¡ï¼Œå¹¶å¯¹å…¶è¿›è¡Œé…ç½®</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>configuration <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      configuration <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>configuration<span class="token punctuation">;</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>configuration<span class="token punctuation">.</span><span class="token function">getVariables</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        configuration<span class="token punctuation">.</span><span class="token function">setVariables</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>configurationProperties<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>configurationProperties <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        configuration<span class="token punctuation">.</span><span class="token function">getVariables</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">putAll</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>configurationProperties<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">&#125;</span>      <span class="token comment">//åˆ›å»ºxmlConfigBuilderï¼Œè¯»å–mybatisçš„æ ¸å¿ƒé…ç½®æ–‡ä»¶</span>    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>configLocation <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      xmlConfigBuilder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">XMLConfigBuilder</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>configLocation<span class="token punctuation">.</span><span class="token function">getInputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>configurationProperties<span class="token punctuation">)</span><span class="token punctuation">;</span>      configuration <span class="token operator">=</span> xmlConfigBuilder<span class="token punctuation">.</span><span class="token function">getConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment">//å¦‚æœconfigurationä¸ºç©ºï¼Œå®ä¾‹åŒ–ä¸€ä¸ªconfigurationå¯¹è±¡</span>    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">LOGGER</span><span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token constant">LOGGER</span><span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"Property 'configuration' or 'configLocation' not specified, using default MyBatis Configuration"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">&#125;</span>      configuration <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Configuration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>configurationProperties <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        configuration<span class="token punctuation">.</span><span class="token function">setVariables</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>configurationProperties<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">//è®¾ç½®objectFactory</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>objectFactory <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      configuration<span class="token punctuation">.</span><span class="token function">setObjectFactory</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>objectFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">//è®¾ç½®objectWrapperFactory</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>objectWrapperFactory <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      configuration<span class="token punctuation">.</span><span class="token function">setObjectWrapperFactory</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>objectWrapperFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">//è®¾ç½®vfs</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>vfs <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      configuration<span class="token punctuation">.</span><span class="token function">setVfsImpl</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>vfs<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">//æ‰«ææŒ‡å®šçš„åŒ…typeAliasesPackageï¼Œæ³¨å†Œåˆ«å</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">hasLength</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>typeAliasesPackage<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> typeAliasPackageArray <span class="token operator">=</span> <span class="token function">tokenizeToStringArray</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>typeAliasesPackage<span class="token punctuation">,</span> <span class="token class-name">ConfigurableApplicationContext</span><span class="token punctuation">.</span><span class="token constant">CONFIG_LOCATION_DELIMITERS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> packageToScan <span class="token operator">:</span> typeAliasPackageArray<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        configuration<span class="token punctuation">.</span><span class="token function">getTypeAliasRegistry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">registerAliases</span><span class="token punctuation">(</span>packageToScan<span class="token punctuation">,</span> typeAliasesSuperType <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token keyword">class</span> <span class="token operator">:</span> typeAliasesSuperType<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">LOGGER</span><span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>          <span class="token constant">LOGGER</span><span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"Scanned package: '"</span> <span class="token operator">+</span> packageToScan <span class="token operator">+</span> <span class="token string">"' for aliases"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>      <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">//ä¸ºtypeAliasesæŒ‡å®šçš„ç±»æ³¨å†Œåˆ«å</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>typeAliases<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span> typeAlias <span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>typeAliases<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        configuration<span class="token punctuation">.</span><span class="token function">getTypeAliasRegistry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">registerAlias</span><span class="token punctuation">(</span>typeAlias<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">LOGGER</span><span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>          <span class="token constant">LOGGER</span><span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"Registered type alias: '"</span> <span class="token operator">+</span> typeAlias <span class="token operator">+</span> <span class="token string">"'"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>      <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">//æ³¨å†Œæ’ä»¶</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>plugins<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Interceptor</span> plugin <span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>plugins<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        configuration<span class="token punctuation">.</span><span class="token function">addInterceptor</span><span class="token punctuation">(</span>plugin<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">LOGGER</span><span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>          <span class="token constant">LOGGER</span><span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"Registered plugin: '"</span> <span class="token operator">+</span> plugin <span class="token operator">+</span> <span class="token string">"'"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>      <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">//æ‰«ææŒ‡å®šçš„åŒ…typeHandlersPackageï¼Œæ³¨å†Œç±»å‹è§£æå™¨</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">hasLength</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>typeHandlersPackage<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> typeHandlersPackageArray <span class="token operator">=</span> <span class="token function">tokenizeToStringArray</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>typeHandlersPackage<span class="token punctuation">,</span> <span class="token class-name">ConfigurableApplicationContext</span><span class="token punctuation">.</span><span class="token constant">CONFIG_LOCATION_DELIMITERS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> packageToScan <span class="token operator">:</span> typeHandlersPackageArray<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        configuration<span class="token punctuation">.</span><span class="token function">getTypeHandlerRegistry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span>packageToScan<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">LOGGER</span><span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>          <span class="token constant">LOGGER</span><span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"Scanned package: '"</span> <span class="token operator">+</span> packageToScan <span class="token operator">+</span> <span class="token string">"' for type handlers"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>      <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">//ä¸ºtypeHandlersæŒ‡å®šçš„ç±»æ³¨å†Œç±»å‹è§£æå™¨</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>typeHandlers<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">TypeHandler</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span> typeHandler <span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>typeHandlers<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        configuration<span class="token punctuation">.</span><span class="token function">getTypeHandlerRegistry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span>typeHandler<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">LOGGER</span><span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>          <span class="token constant">LOGGER</span><span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"Registered type handler: '"</span> <span class="token operator">+</span> typeHandler <span class="token operator">+</span> <span class="token string">"'"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>      <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">//é…ç½®databaseIdProvider</span>    <span class="token comment">//fix #64 set databaseId before parse mapper xmls</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>databaseIdProvider <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>        configuration<span class="token punctuation">.</span><span class="token function">setDatabaseId</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>databaseIdProvider<span class="token punctuation">.</span><span class="token function">getDatabaseId</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>dataSource<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">SQLException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NestedIOException</span><span class="token punctuation">(</span><span class="token string">"Failed getting a databaseId"</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">//é…ç½®ç¼“å­˜</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>cache <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      configuration<span class="token punctuation">.</span><span class="token function">addCache</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>cache<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">//ä½¿ç”¨xmlConfigBuilderè¯»å–mybatisçš„æ ¸å¿ƒé…ç½®æ–‡ä»¶</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>xmlConfigBuilder <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>        xmlConfigBuilder<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">LOGGER</span><span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>          <span class="token constant">LOGGER</span><span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"Parsed configuration file: '"</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>configLocation <span class="token operator">+</span> <span class="token string">"'"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>      <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> ex<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NestedIOException</span><span class="token punctuation">(</span><span class="token string">"Failed to parse config resource: "</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>configLocation<span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">&#125;</span> <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">ErrorContext</span><span class="token punctuation">.</span><span class="token function">instance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">//é»˜è®¤ä½¿ç”¨SpringManagedTransactionFactoryä½œä¸ºäº‹åŠ¡ç®¡ç†å™¨</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>transactionFactory <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      <span class="token keyword">this</span><span class="token punctuation">.</span>transactionFactory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SpringManagedTransactionFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">//è®¾ç½®Environment</span>    configuration<span class="token punctuation">.</span><span class="token function">setEnvironment</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Environment</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>environment<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>transactionFactory<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>dataSource<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//æ ¹æ®mapperLocationsçš„é…ç½®ï¼Œå¤„ç†æ˜ å°„é…ç½®æ–‡ä»¶ä»¥åŠç›¸åº”çš„mapperæ¥å£</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>mapperLocations<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Resource</span> mapperLocation <span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>mapperLocations<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>mapperLocation <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>          <span class="token keyword">continue</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>          <span class="token class-name">XMLMapperBuilder</span> xmlMapperBuilder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">XMLMapperBuilder</span><span class="token punctuation">(</span>mapperLocation<span class="token punctuation">.</span><span class="token function">getInputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> configuration<span class="token punctuation">,</span> mapperLocation<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> configuration<span class="token punctuation">.</span><span class="token function">getSqlFragments</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          xmlMapperBuilder<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>          <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NestedIOException</span><span class="token punctuation">(</span><span class="token string">"Failed to parse mapping resource: '"</span> <span class="token operator">+</span> mapperLocation <span class="token operator">+</span> <span class="token string">"'"</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span> <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span>          <span class="token class-name">ErrorContext</span><span class="token punctuation">.</span><span class="token function">instance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">LOGGER</span><span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>          <span class="token constant">LOGGER</span><span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"Parsed mapper file: '"</span> <span class="token operator">+</span> mapperLocation <span class="token operator">+</span> <span class="token string">"'"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>      <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">LOGGER</span><span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token constant">LOGGER</span><span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"Property 'mapperLocations' was not specified or no matching resources found"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">//æœ€ç»ˆä½¿ç”¨sqlSessionFactoryBuilderåˆ›å»ºsqlSessionFactory</span>    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>sqlSessionFactoryBuilder<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span>configuration<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æœ€åä¸€å¥</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>sqlSessionFactoryBuilder<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span>configuration<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>æ˜¯ä¸æ˜¯åˆå›åˆ°äº†ç†Ÿæ‚‰çš„åœ°æ–¹ã€‚</p><h2 id="2-MapperScannerConfigurer"><a href="#2-MapperScannerConfigurer" class="headerlink" title="2.MapperScannerConfigurer"></a>2.MapperScannerConfigurer</h2><p>(1) UML<br><img src="https://cdn.jsdelivr.net/gh/zyxelva/picgo@main/csdn/20210324140422191.png"><br>(2) é…ç½®å’Œæºç è§£æ<br>è¿™é‡Œæˆ‘ä»¬ä¸»è¦å…³æ³¨è¿™ä¸ªæ¥å£ï¼šBeanDefinitionRegistryPostProcessor<br>MapperScannerConfigurerå®ç°äº†BeanDefinitionRegistryPostProcessoræ¥å£ï¼ŒBeanDefinitionRegistryPostProcessoræ¥å£æ˜¯ä¸€ä¸ªå¯ä»¥ä¿®æ”¹springå·¥å‚ä¸­å·²å®šä¹‰çš„beançš„æ¥å£ï¼Œè¯¥æ¥å£æœ‰ä¸ªpostProcessBeanDefinitionRegistryæ–¹æ³•ã€‚</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Override</span><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">postProcessBeanDefinitionRegistry</span><span class="token punctuation">(</span><span class="token class-name">BeanDefinitionRegistry</span> registry<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token comment">//å ä½ç¬¦å¤„ç†</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>processPropertyPlaceHolders<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token function">processPropertyPlaceHolders</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>  <span class="token comment">//å®ä¾‹åŒ–ClassPathMapperScannerï¼Œå¹¶å¯¹scannerç›¸å…³å±æ€§è¿›è¡Œé…ç½®</span>  <span class="token class-name">ClassPathMapperScanner</span> scanner <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ClassPathMapperScanner</span><span class="token punctuation">(</span>registry<span class="token punctuation">)</span><span class="token punctuation">;</span>  scanner<span class="token punctuation">.</span><span class="token function">setAddToConfig</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>addToConfig<span class="token punctuation">)</span><span class="token punctuation">;</span>  scanner<span class="token punctuation">.</span><span class="token function">setAnnotationClass</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>annotationClass<span class="token punctuation">)</span><span class="token punctuation">;</span>  scanner<span class="token punctuation">.</span><span class="token function">setMarkerInterface</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>markerInterface<span class="token punctuation">)</span><span class="token punctuation">;</span>  scanner<span class="token punctuation">.</span><span class="token function">setSqlSessionFactory</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>sqlSessionFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>  scanner<span class="token punctuation">.</span><span class="token function">setSqlSessionTemplate</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>sqlSessionTemplate<span class="token punctuation">)</span><span class="token punctuation">;</span>  scanner<span class="token punctuation">.</span><span class="token function">setSqlSessionFactoryBeanName</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>sqlSessionFactoryBeanName<span class="token punctuation">)</span><span class="token punctuation">;</span>  scanner<span class="token punctuation">.</span><span class="token function">setSqlSessionTemplateBeanName</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>sqlSessionTemplateBeanName<span class="token punctuation">)</span><span class="token punctuation">;</span>  scanner<span class="token punctuation">.</span><span class="token function">setResourceLoader</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>applicationContext<span class="token punctuation">)</span><span class="token punctuation">;</span>  scanner<span class="token punctuation">.</span><span class="token function">setBeanNameGenerator</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>nameGenerator<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//æ ¹æ®ä¸Šè¿°é…ç½®ï¼Œç”Ÿæˆè¿‡æ»¤å™¨ï¼Œåªæ‰«æåˆæ¡ä»¶çš„class</span>  scanner<span class="token punctuation">.</span><span class="token function">registerFilters</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//æ‰«ææŒ‡å®šçš„åŒ…ä»¥åŠå…¶å­åŒ…</span>  scanner<span class="token punctuation">.</span><span class="token function">scan</span><span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">tokenizeToStringArray</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>basePackage<span class="token punctuation">,</span> <span class="token class-name">ConfigurableApplicationContext</span><span class="token punctuation">.</span><span class="token constant">CONFIG_LOCATION_DELIMITERS</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ç‚¹è¿›å»ï¼Œçœ‹çœ‹ClassPathMapperScanner.scan()æ–¹æ³•ï¼š</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/** * Calls the parent search that will search and register all the candidates. * Then the registered objects are post processed to set them as * MapperFactoryBeans */</span><span class="token annotation punctuation">@Override</span><span class="token keyword">public</span> <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">BeanDefinitionHolder</span><span class="token punctuation">></span></span> <span class="token function">doScan</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> basePackages<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token comment">//é€šè¿‡çˆ¶ç±»ClassPathBeanDefinitionScannerçš„æ‰«æï¼Œè·å–æ‰€æœ‰å¤åˆæ¡ä»¶çš„BeanDefinitionHolderå¯¹è±¡</span>    <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">BeanDefinitionHolder</span><span class="token punctuation">></span></span> beanDefinitions <span class="token operator">=</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">doScan</span><span class="token punctuation">(</span>basePackages<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>beanDefinitions<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        logger<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">"No MyBatis mapper was found in '"</span> <span class="token operator">+</span> <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span>basePackages<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"' package. Please check your configuration."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>        <span class="token comment">//å¤„ç†æ‰«æå¾—åˆ°çš„BeanDefinitionHolderé›†åˆï¼Œå°†é›†åˆä¸­çš„æ¯ä¸€ä¸ªmapperæ¥å£è½¬æ¢æˆMapperFactoryBeanåï¼Œæ³¨å†Œè‡³springå®¹å™¨</span>        <span class="token function">processBeanDefinitions</span><span class="token punctuation">(</span>beanDefinitions<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">return</span> beanDefinitions<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">/** * å¤„ç†æ‰«æå¾—åˆ°çš„BeanDefinitionHolderé›†åˆï¼Œå°†é›†åˆä¸­çš„æ¯ä¸€ä¸ªmapperæ¥å£è½¬æ¢æˆMapperFactoryBeanåï¼Œæ³¨å†Œè‡³springå®¹å™¨ * * @param beanDefinitions */</span><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">processBeanDefinitions</span><span class="token punctuation">(</span><span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">BeanDefinitionHolder</span><span class="token punctuation">></span></span> beanDefinitions<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token class-name">GenericBeanDefinition</span> definition<span class="token punctuation">;</span>    <span class="token comment">//éå†é›†åˆ</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">BeanDefinitionHolder</span> holder <span class="token operator">:</span> beanDefinitions<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        definition <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">GenericBeanDefinition</span><span class="token punctuation">)</span> holder<span class="token punctuation">.</span><span class="token function">getBeanDefinition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"Creating MapperFactoryBean with name '"</span> <span class="token operator">+</span> holder<span class="token punctuation">.</span><span class="token function">getBeanName</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                    <span class="token operator">+</span> <span class="token string">"' and '"</span> <span class="token operator">+</span> definition<span class="token punctuation">.</span><span class="token function">getBeanClassName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"' mapperInterface"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token comment">// the mapper interface is the original class of the bean</span>        <span class="token comment">// but, the actual class of the bean is MapperFactoryBean</span>        <span class="token comment">//å¢åŠ ä¸€ä¸ªæ„é€ æ–¹æ³•ï¼Œæ¥å£ç±»å‹ä½œä¸ºæ„é€ å‡½æ•°çš„å…¥å‚</span>        definition<span class="token punctuation">.</span><span class="token function">getConstructorArgumentValues</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addGenericArgumentValue</span><span class="token punctuation">(</span>definition<span class="token punctuation">.</span><span class="token function">getBeanClassName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">//å°†beançš„ç±»å‹è½¬æ¢æˆmapperFactoryBean</span>        definition<span class="token punctuation">.</span><span class="token function">setBeanClass</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>mapperFactoryBean<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">//å¢åŠ addToConfigå±æ€§</span>        definition<span class="token punctuation">.</span><span class="token function">getPropertyValues</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"addToConfig"</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>addToConfig<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">boolean</span> explicitFactoryUsed <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>        <span class="token comment">//å¢åŠ sqlSessionFactoryå±æ€§</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">hasText</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>sqlSessionFactoryBeanName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            definition<span class="token punctuation">.</span><span class="token function">getPropertyValues</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"sqlSessionFactory"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeBeanReference</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>sqlSessionFactoryBeanName<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            explicitFactoryUsed <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>sqlSessionFactory <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            definition<span class="token punctuation">.</span><span class="token function">getPropertyValues</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"sqlSessionFactory"</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>sqlSessionFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>            explicitFactoryUsed <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token comment">//å¢åŠ sqlSessionTemplateå±æ€§</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">hasText</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>sqlSessionTemplateBeanName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>explicitFactoryUsed<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                logger<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">"Cannot use both: sqlSessionTemplate and sqlSessionFactory together. sqlSessionFactory is ignored."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>            definition<span class="token punctuation">.</span><span class="token function">getPropertyValues</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"sqlSessionTemplate"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeBeanReference</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>sqlSessionTemplateBeanName<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            explicitFactoryUsed <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>sqlSessionTemplate <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>explicitFactoryUsed<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                logger<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">"Cannot use both: sqlSessionTemplate and sqlSessionFactory together. sqlSessionFactory is ignored."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>            definition<span class="token punctuation">.</span><span class="token function">getPropertyValues</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"sqlSessionTemplate"</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>sqlSessionTemplate<span class="token punctuation">)</span><span class="token punctuation">;</span>            explicitFactoryUsed <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token comment">//ä¿®æ”¹è‡ªåŠ¨æ³¨å…¥çš„æ–¹å¼ bytype</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>explicitFactoryUsed<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"Enabling autowire by type for MapperFactoryBean with name '"</span> <span class="token operator">+</span> holder<span class="token punctuation">.</span><span class="token function">getBeanName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"'."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>            definition<span class="token punctuation">.</span><span class="token function">setAutowireMode</span><span class="token punctuation">(</span><span class="token class-name">AbstractBeanDefinition</span><span class="token punctuation">.</span><span class="token constant">AUTOWIRE_BY_TYPE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æ³¨é‡Šå·²ç»å†™å¾—å¾ˆæ¸…æ¥šäº†ï¼Œè¿™é‡Œå†çœ‹çœ‹MapperFactoryBean.<br><img src="https://cdn.jsdelivr.net/gh/zyxelva/picgo@main/csdn/20210324144607379.png"><br>å…¶ç»§æ‰¿äº†SqlSessionDaoSupportç±»ï¼ŒSqlSessionDaoSupportç±»ç»§æ‰¿DaoSupportæŠ½è±¡ç±»ï¼ŒDaoSupportæŠ½è±¡ç±»å®ç°äº†InitializingBeanæ¥å£ï¼Œå› æ­¤å®ä¾‹ä¸€ä¸ªMapperFactoryBeançš„æ—¶å€™ï¼Œéƒ½ä¼šè°ƒç”¨InitializingBeanæ¥å£çš„afterPropertiesSetæ–¹æ³•ã€‚è€ŒMapperFactoryBeanä¹Ÿé‡å†™äº†ï¼š</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/** * MapperFactoryBeanåœ¨å®¹å™¨åˆå§‹åŒ–æ—¶ï¼Œè¦ç¡®ä¿mapperæ¥å£è¢«æ³¨å†Œåˆ°mapperRegistry * &#123;@inheritDoc&#125; */</span><span class="token annotation punctuation">@Override</span><span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">checkDaoConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">checkDaoConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">notNull</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>mapperInterface<span class="token punctuation">,</span> <span class="token string">"Property 'mapperInterface' is required"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//é€šè¿‡SqlSessionä»å®¹å™¨ä¸­æ‹¿åˆ°configuration</span>  <span class="token class-name">Configuration</span> configuration <span class="token operator">=</span> <span class="token function">getSqlSession</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>addToConfig <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>configuration<span class="token punctuation">.</span><span class="token function">hasMapper</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>mapperInterface<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>  <span class="token comment">//å¦‚æœmapperRegistryä¸­ä¸åŒ…å«å½“å‰æ¥å£çš„åŠ¨æ€ä»£ç†å·¥å‚ï¼Œåˆ™æ·»åŠ ä¸€ä¸ª</span>      configuration<span class="token punctuation">.</span><span class="token function">addMapper</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>mapperInterface<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"Error while adding the mapper '"</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>mapperInterface <span class="token operator">+</span> <span class="token string">"' to configuration."</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span> <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span>      <span class="token class-name">ErrorContext</span><span class="token punctuation">.</span><span class="token function">instance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>çœ‹åˆ°configuration.addMapper()æ–¹æ³•ï¼Œæ˜¯ä¸æ˜¯åˆæƒ³èµ·äº†configurationç†Ÿæ‚‰çš„å‘³é“äº†ã€‚</p><p>MapperScannerConfigureråœ¨Springé…ç½®æ–‡ä»¶ä¸­çš„åº”ç”¨å¦‚ä¸‹ï¼š</p><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token comment">&lt;!-- DAOæ¥å£æ‰€åœ¨åŒ…åï¼ŒSpringä¼šè‡ªåŠ¨æŸ¥æ‰¾å…¶ä¸‹çš„ç±» --></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>org.mybatis.spring.mapper.MapperScannerConfigurer<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token comment">&lt;!-- å¯ä»¥ä½¿ç”¨åˆ†å·æˆ–é€—å·ä½œä¸ºåˆ†éš”ç¬¦è®¾ç½®å¤šäºä¸€ä¸ªçš„åŒ…è·¯å¾„ --></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>basePackage<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>com.enjoylearning.mybatis.mapper<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span><span class="token comment">&lt;!-- optional unless there are multiple session factories defined --></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>sqlSessionFactoryBeanName<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>sqlSessionFactory<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ä½œç”¨å¾ˆç®€å•ï¼Œæ‰«æç‰¹å®šç›®å½•ä¸‹çš„æ‰€æœ‰mapper.javaï¼Œç”ŸæˆMapperFactoryBeanï¼Œç„¶ååˆ›å»ºåŠ¨æ€ä»£ç†å·¥å‚ç±»MapperProxyFactoryï¼Œå¹¶æ³¨å†Œè‡³mapperRegistryå½“ä¸­ã€‚ä½¿ç”¨æ—¶ä¾èµ–æ³¨å…¥å³å¯ã€‚<br>å½“ç„¶ï¼Œå¦‚æœåªæœ‰ä¸€ä¸ªmapperï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥è¿™æ ·é…ç½®ï¼š</p><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>tUserMapper<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>org.mybatis.spring.mapper.MapperFactoryBean<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>mapperInterface<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>com.enjoylearning.mybatis.mapper.TUserMapper<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>sqlSessionFactory<span class="token punctuation">"</span></span> <span class="token attr-name">ref</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>sqlSessionFactory<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>ä½†æ˜¯ï¼Œä¸€èˆ¬é¡¹ç›®ä¸­mapperè‚¯å®šä¸æ­¢ä¸€ä¸ªï¼Œä¸€æ—¦æ–°å¢äº†ä¸€ä¸ªæ–°çš„mapperï¼Œæˆ‘ä»¬å°±éœ€è¦é…ç½®å¾ˆå¤šä¸ªè¿™æ ·å­çš„beanï¼ŒMapperScannerConfigurerå¸®æˆ‘ä»¬è§£å†³äº†è¿™æ ·çš„é—®é¢˜ã€‚</p><p>sqlSessionFactoryBeanNameéå¿…å¡«ï¼Œä½†æ˜¯å¦‚æœæ˜¯å¤šæ•°æ®æºçš„ç¯å¢ƒï¼Œå°±å¿…é¡»é…ç½®å¥½ã€‚æ³¨æ„ bean çš„<strong>åç§°name</strong>æ˜¯<strong>å¿…é¡»</strong>çš„,è€Œä¸æ˜¯ bean çš„å¼•ç”¨,å› æ­¤,value å±æ€§åœ¨è¿™é‡Œæ›¿ä»£é€šå¸¸çš„refã€‚</p>]]></content>
      
      
      <categories>
          
          <category> MyBatisæºç å­¦ä¹  </category>
          
      </categories>
      
      
        <tags>
            
            <tag> MyBatis </tag>
            
            <tag> æºç  </tag>
            
            <tag> Spring </tag>
            
            <tag> Spring Boot </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ã€MyBatisæºç å­¦ä¹ ã€‘MyBatisä¸Springæ•´åˆ</title>
      <link href="/posts/53897.html"/>
      <url>/posts/53897.html</url>
      
        <content type="html"><![CDATA[<h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><p>ç›®å‰å¤§éƒ¨åˆ†é¡¹ç›®ä¸­è¿ç”¨MyBatiså‡ä¸Springæœ‰å…³ï¼Œå°¤å…¶æ˜¯Spring Bootå¤§è¡Œå…¶é“ï¼Œæ™®é€šç¨‹åºå‘˜åŸºæœ¬ä¸Šå¯ä»¥æ— ç¼çš„å®Œæˆä¸€ä¸ªç®€å•çš„CRUDé¡¹ç›®ã€‚é€šè¿‡å‰é¢å¯¹äºMyBatis æºç çš„å­¦ä¹ ï¼Œæˆ‘å·²ç»å¯¹å…¶äº†ï¼ˆä¸€ï¼‰å¦‚ï¼ˆè„¸ï¼‰æŒ‡ï¼ˆæ‡µï¼‰æŒï¼ˆé€¼ï¼‰ï¼Œæœ¬ç« æˆ‘ä»¬æ¥ç©ç©MyBatisä¸Springçš„ç»“åˆä»¥åŠå®ƒä»¬çš„èåˆåŸç†ã€‚</p><h1 id="ä¸€ã€ä»€ä¹ˆæ˜¯Mybatis-Spring"><a href="#ä¸€ã€ä»€ä¹ˆæ˜¯Mybatis-Spring" class="headerlink" title="ä¸€ã€ä»€ä¹ˆæ˜¯Mybatis-Spring"></a>ä¸€ã€ä»€ä¹ˆæ˜¯Mybatis-Spring</h1><p>ä¸€å¥è¯ï¼šå°† MyBatis ä»£ç æ— ç¼åœ°æ•´åˆåˆ° Spring ä¸­ã€‚é›†æˆè¿‡ç¨‹ä¸­çš„å¢å¼ºå¤„ç†ä¸»è¦ä½“ç°åœ¨ä»¥ä¸‹å‡ ä¸ªæ–¹é¢ï¼š</p><ul><li>Spring å°†ä¼šåŠ è½½å¿…è¦çš„ MyBatis å·¥å‚ç±»å’Œ session ç±»</li><li>æä¾›ä¸€ä¸ªç®€å•çš„æ–¹å¼æ¥æ³¨å…¥ MyBatis æ•°æ®æ˜ å°„å™¨å’Œ SqlSession åˆ°ä¸šåŠ¡å±‚çš„ bean ä¸­</li><li>æ–¹ä¾¿é›†æˆSpringäº‹åŠ¡</li><li>ç¿»è¯‘ MyBatis çš„å¼‚å¸¸åˆ° Spring çš„ DataAccessException å¼‚å¸¸(æ•°æ®è®¿é—®å¼‚å¸¸)ä¸­</li></ul><h1 id="äºŒã€å…³é”®é…ç½®ç±»"><a href="#äºŒã€å…³é”®é…ç½®ç±»" class="headerlink" title="äºŒã€å…³é”®é…ç½®ç±»"></a>äºŒã€å…³é”®é…ç½®ç±»</h1><h2 id="1-SqlSessionFactoryBean"><a href="#1-SqlSessionFactoryBean" class="headerlink" title="1.SqlSessionFactoryBean"></a>1.SqlSessionFactoryBean</h2><p>SqlSessionFactoryBeanä½œç”¨ï¼šç”¨äºåˆ›å»ºSqlSessionFactoryã€‚å…³é”®å‚æ•°æœ‰ï¼š</p><ul><li>dataSource ï¼š<strong>å¿…å¡«</strong>ã€‚ç”¨äºé…ç½®æ•°æ®æºï¼Œå¿…é¡»é€šè¿‡è¿™ä¸ªå±æ€§é…ç½®æ•°æ®æºã€‚</li><li>mapperLocations ï¼š é…ç½® SqlSessionFactoryBean æ‰«æ*<strong>mapper.xml</strong>æ˜ å°„æ–‡ä»¶çš„è·¯å¾„ã€‚</li><li>configLocation ï¼šç”¨äºé…ç½®<strong>mybatis-config.xml</strong>çš„è·¯å¾„ï¼Œé™¤äº†æ•°æ®æºå¤–ï¼Œå¯¹MyBatisçš„å„ç§é…ç›´ä»ç„¶å¯ä»¥é€šè¿‡è¿™ç§æ–¹å¼è¿›è¡Œï¼Œå¹¶ä¸”é…ç½®MyBatis settings æ—¶åªèƒ½ä½¿ç”¨è¿™ç§æ–¹å¼ã€‚ä½†é…ç½®æ–‡ä»¶ä¸­ä»»æ„ç¯å¢ƒ,æ•°æ®æºå’Œ MyBatis çš„äº‹åŠ¡ç®¡ç†å™¨éƒ½ä¼šè¢«å¿½ç•¥ï¼›</li><li>typeAliasesPackage ï¼š é…ç½®åŒ…ä¸­ç±»çš„åˆ«åï¼Œé…ç½®åï¼ŒåŒ…ä¸­çš„ç±»åœ¨ XML æ˜ å°„æ–‡ä»¶ä¸­ä½¿ç”¨æ—¶å¯ä»¥çœç•¥åŒ…åéƒ¨åˆ†ï¼Œç›´æ¥ä½¿ç”¨ç±»åã€‚è¿™ä¸ªé…ç½®ä¸æ”¯æŒAnté£æ ¼çš„è·¯å¾„ï¼Œå½“éœ€è¦é…ç½®å¤šä¸ªåŒ…è·¯å¾„æ—¶å¯ä»¥ä½¿ç”¨åˆ†å·æˆ–é€—å·è¿›è¡Œåˆ†éš”.</li></ul><h2 id="2-MapperScannerConfigurer"><a href="#2-MapperScannerConfigurer" class="headerlink" title="2.MapperScannerConfigurer"></a>2.MapperScannerConfigurer</h2><p>ä½œç”¨ï¼šè‡ªåŠ¨æ‰«ææ‰€æœ‰çš„ Mapper æ¥å£ï¼Œä½¿ç”¨æ—¶å¯ä»¥ç›´æ¥æ³¨å…¥æ¥å£ã€‚<br>å…³é”®å‚æ•°ï¼š</p><ul><li>basePackage ï¼šç”¨äºé…ç½®åŸºæœ¬çš„åŒ…è·¯å¾„ã€‚å¯ä»¥ä½¿ç”¨åˆ†å·æˆ–é€—å·ä½œä¸ºåˆ†éš”ç¬¦è®¾ç½®å¤šäºä¸€ä¸ªçš„åŒ…è·¯å¾„ï¼Œæ¯ä¸ªæ˜ å°„å™¨å°†ä¼šåœ¨æŒ‡å®šçš„åŒ…è·¯å¾„ä¸­é€’å½’åœ°è¢«æœç´¢åˆ° ã€‚</li><li>annotationClass ï¼šç”¨äºè¿‡æ»¤è¢«æ‰«æçš„æ¥å£ï¼Œå¦‚æœè®¾ç½®äº†è¯¥å±æ€§ï¼Œé‚£ä¹ˆ MyBatis çš„æ¥å£åªæœ‰åŒ…å«è¯¥æ³¨è§£æ‰ä¼šè¢«æ‰«æè¿›å»ã€‚</li></ul><h1 id="ä¸‰ã€MyBatisä¸Springèåˆå®æˆ˜"><a href="#ä¸‰ã€MyBatisä¸Springèåˆå®æˆ˜" class="headerlink" title="ä¸‰ã€MyBatisä¸Springèåˆå®æˆ˜"></a>ä¸‰ã€MyBatisä¸Springèåˆå®æˆ˜</h1><h2 id="1-ä¾èµ–"><a href="#1-ä¾èµ–" class="headerlink" title="1.ä¾èµ–"></a>1.ä¾èµ–</h2><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token comment">&lt;!-- https://mvnrepository.com/artifact/mysql/mysql-connector-java --></span>       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>           <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>mysql<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>           <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>mysql-connector-java<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>           <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>5.1.42<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>           <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.mybatis<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>           <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>mybatis<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>           <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>3.5.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>           <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.mybatis<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>           <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>mybatis-spring<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>           <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>1.3.3<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span><span class="token comment">&lt;!-- æ•°æ®åº“è¿æ¥æ±  --></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>com.alibaba<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>druid<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>1.0.20<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>           <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>           <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-core<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>           <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>$&#123;spring.version&#125;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>           <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>           <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-context<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>           <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>$&#123;spring.version&#125;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>           <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>           <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-beans<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>           <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>$&#123;spring.version&#125;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>           <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>           <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-jdbc<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>           <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>$&#123;spring.version&#125;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>           <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>           <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-test<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>           <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>$&#123;spring.version&#125;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å…¶ä¸­spring.versionä¸º4.3.3.RELEASEã€‚</p><h2 id="2-Springé…ç½®æ–‡ä»¶"><a href="#2-Springé…ç½®æ–‡ä»¶" class="headerlink" title="2.Springé…ç½®æ–‡ä»¶"></a>2.Springé…ç½®æ–‡ä»¶</h2><p>æœ¬é¡¹ç›®ä¸­çš„springé…ç½®æ–‡ä»¶åä¸ºapplicationContext.xmlï¼Œä¸»è¦ç”¨äºé…ç½®ï¼š</p><ul><li>æ•°æ®æº</li><li>sqlSessionFactory</li><li>MapperScannerConfigurer</li></ul><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">context:</span>property-placeholder</span> <span class="token attr-name">location</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>classpath:db.properties<span class="token punctuation">"</span></span> <span class="token attr-name">ignore-unresolvable</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">context:</span>component-scan</span> <span class="token attr-name">base-package</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>com.*<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>dataSource<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>com.alibaba.druid.pool.DruidDataSource<span class="token punctuation">"</span></span> <span class="token attr-name">init-method</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>init<span class="token punctuation">"</span></span> <span class="token attr-name">destroy-method</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>close<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token comment">&lt;!-- åŸºæœ¬å±æ€§ urlã€userã€password --></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>driverClassName<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>$&#123;jdbc_driver&#125;<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>url<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>$&#123;jdbc_url&#125;<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>username<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>$&#123;jdbc_username&#125;<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>password<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>$&#123;jdbc_password&#125;<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span><span class="token comment">&lt;!-- é…ç½®åˆå§‹åŒ–å¤§å°ã€æœ€å°ã€æœ€å¤§ --></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>initialSize<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>1<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>minIdle<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>1<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>maxActive<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>20<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span><span class="token comment">&lt;!-- é…ç½®è·å–è¿æ¥ç­‰å¾…è¶…æ—¶çš„æ—¶é—´ --></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>maxWait<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>60000<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span><span class="token comment">&lt;!-- é…ç½®é—´éš”å¤šä¹…æ‰è¿›è¡Œä¸€æ¬¡æ£€æµ‹ï¼Œæ£€æµ‹éœ€è¦å…³é—­çš„ç©ºé—²è¿æ¥ï¼Œå•ä½æ˜¯æ¯«ç§’ --></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>timeBetweenEvictionRunsMillis<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>60000<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span><span class="token comment">&lt;!-- é…ç½®ä¸€ä¸ªè¿æ¥åœ¨æ± ä¸­æœ€å°ç”Ÿå­˜çš„æ—¶é—´ï¼Œå•ä½æ˜¯æ¯«ç§’ --></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>minEvictableIdleTimeMillis<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>300000<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>validationQuery<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>SELECT 'x'<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>testWhileIdle<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>testOnBorrow<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>false<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>testOnReturn<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>false<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span><span class="token comment">&lt;!-- æ‰“å¼€PSCacheï¼Œå¹¶ä¸”æŒ‡å®šæ¯ä¸ªè¿æ¥ä¸ŠPSCacheçš„å¤§å° --></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>poolPreparedStatements<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>maxPoolPreparedStatementPerConnectionSize<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>20<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span><span class="token comment">&lt;!-- é…ç½®ç›‘æ§ç»Ÿè®¡æ‹¦æˆªçš„filters --></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>filters<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>stat<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">></span></span><span class="token comment">&lt;!-- springå’ŒMyBatiså®Œç¾æ•´åˆï¼Œä¸éœ€è¦mybatisçš„é…ç½®æ˜ å°„æ–‡ä»¶ --></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>sqlSessionFactory<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>org.mybatis.spring.SqlSessionFactoryBean<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>dataSource<span class="token punctuation">"</span></span> <span class="token attr-name">ref</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>dataSource<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>typeAliasesPackage<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>com.enjoylearning.mybatis.entity<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>mapperLocations<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>classpath:sqlmapper/*.xml<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">></span></span><span class="token comment">&lt;!-- DAOæ¥å£æ‰€åœ¨åŒ…åï¼ŒSpringä¼šè‡ªåŠ¨æŸ¥æ‰¾å…¶ä¸‹çš„ç±» --></span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>org.mybatis.spring.mapper.MapperScannerConfigurer<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>basePackage<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>com.enjoylearning.mybatis.mapper<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">></span></span><span class="token comment">&lt;!-- (äº‹åŠ¡ç®¡ç†)transaction manager --></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>transactionManager<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>org.springframework.jdbc.datasource.DataSourceTransactionManager<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>dataSource<span class="token punctuation">"</span></span> <span class="token attr-name">ref</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>dataSource<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>qualifier</span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>transactionManager<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">tx:</span>annotation-driven</span> <span class="token attr-name">transaction-manager</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>transactionManager<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="3-Mybatisé…ç½®æ–‡ä»¶"><a href="#3-Mybatisé…ç½®æ–‡ä»¶" class="headerlink" title="3.Mybatisé…ç½®æ–‡ä»¶"></a>3.Mybatisé…ç½®æ–‡ä»¶</h2><p>æ–‡ä»¶åä¸ºmybatis-config.xmlï¼Œæ³¨æ„è¯¥æ–‡ä»¶é™¤äº†settingså¿…é¡»é…ç½®åœ¨é‡Œé¢å¤–ï¼Œå…¶ä»–éƒ½å¯ä»¥åœ¨springé…ç½®æ–‡ä»¶ä¸­é…ç½®ã€‚</p><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>settings</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>setting</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>mapUnderscoreToCamelCase<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>settings</span><span class="token punctuation">></span></span><span class="token comment">&lt;!-- åˆ«åå®šä¹‰ --></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>typeAliases</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>package</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>com.enjoylearning.mybatis.entity<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>typeAliases</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="4-mapper"><a href="#4-mapper" class="headerlink" title="4.mapper"></a>4.mapper</h2><p>è¿˜æ˜¯ä»¥UserInfoMapper.xmlä¸ºä¾‹ï¼Œæ–‡ä»¶å†…å®¹å¦‚ä¸‹ï¼š</p><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token prolog">&lt;?xml version="1.0" encoding="UTF-8" ?></span><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">mapper</span> <span class="token name">PUBLIC</span> <span class="token string">"-//mybatis.org//DTD Mapper 3.0//EN"</span> <span class="token string">"http://mybatis.org/dtd/mybatis-3-mapper.dtd"</span> <span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>mapper</span> <span class="token attr-name">namespace</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>com.enjoylearning.mybatis.mapper.UserInfoMapper<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>resultMap</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>BaseResultMap<span class="token punctuation">"</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>com.enjoylearning.mybatis.entity.UserInfo<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>id</span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>id<span class="token punctuation">"</span></span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>id<span class="token punctuation">"</span></span> <span class="token attr-name">jdbcType</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>VARCHAR<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>result</span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>username<span class="token punctuation">"</span></span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>username<span class="token punctuation">"</span></span> <span class="token attr-name">jdbcType</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>VARCHAR<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>result</span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>password<span class="token punctuation">"</span></span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>password<span class="token punctuation">"</span></span> <span class="token attr-name">jdbcType</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>VARCHAR<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>result</span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>openid<span class="token punctuation">"</span></span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>openid<span class="token punctuation">"</span></span> <span class="token attr-name">jdbcType</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>VARCHAR<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>result</span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>role<span class="token punctuation">"</span></span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>role<span class="token punctuation">"</span></span> <span class="token attr-name">jdbcType</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>BIT<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>result</span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>create_time<span class="token punctuation">"</span></span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>createTime<span class="token punctuation">"</span></span> <span class="token attr-name">jdbcType</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>TIMESTAMP<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>result</span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>update_time<span class="token punctuation">"</span></span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>updateTime<span class="token punctuation">"</span></span> <span class="token attr-name">jdbcType</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>TIMESTAMP<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>resultMap</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>sql</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Base_Column_List<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>        id, username, password, openid, role, create_time, update_time    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>sql</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>select</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>selectByPrimaryKey<span class="token punctuation">"</span></span> <span class="token attr-name">resultMap</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>BaseResultMap<span class="token punctuation">"</span></span> <span class="token attr-name">parameterType</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>java.lang.String<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>        select        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>include</span> <span class="token attr-name">refid</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Base_Column_List<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>        from user_info        where id = #&#123;id,jdbcType=VARCHAR&#125;    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>select</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>mapper</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å¯¹åº”daoï¼š</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">UserInfoMapper</span> <span class="token punctuation">&#123;</span>    <span class="token class-name">UserInfo</span> <span class="token function">selectByPrimaryKey</span><span class="token punctuation">(</span><span class="token class-name">String</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>po:</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserInfo</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">private</span> <span class="token class-name">String</span> id<span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token class-name">String</span> username<span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token class-name">String</span> password<span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token class-name">String</span> openid<span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token class-name">Boolean</span> role<span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token class-name">Date</span> createTime<span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token class-name">Date</span> updateTime<span class="token punctuation">;</span><span class="token comment">//çœç•¥getterã€setter</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="5-æµ‹è¯•ç±»"><a href="#5-æµ‹è¯•ç±»" class="headerlink" title="5.æµ‹è¯•ç±»"></a>5.æµ‹è¯•ç±»</h2><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@RunWith</span><span class="token punctuation">(</span><span class="token class-name">SpringJUnit4ClassRunner</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token annotation punctuation">@ContextConfiguration</span><span class="token punctuation">(</span><span class="token string">"classpath:applicationContext.xml"</span><span class="token punctuation">)</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MybatisSpringTest</span> <span class="token punctuation">&#123;</span><span class="token annotation punctuation">@Autowired</span>    <span class="token keyword">private</span> <span class="token class-name">UserInfoMapper</span> userInfoMapper<span class="token punctuation">;</span>    <span class="token annotation punctuation">@Test</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">test_selectByPrimaryKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">UserInfo</span> userInfo<span class="token operator">=</span> userInfoMapper<span class="token punctuation">.</span><span class="token function">selectByPrimaryKey</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>userInfo<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h1 id="å››ã€Mybatisä¸SpringBootèåˆå®æˆ˜"><a href="#å››ã€Mybatisä¸SpringBootèåˆå®æˆ˜" class="headerlink" title="å››ã€Mybatisä¸SpringBootèåˆå®æˆ˜"></a>å››ã€Mybatisä¸SpringBootèåˆå®æˆ˜</h1><h2 id="1-ä¾èµ–-1"><a href="#1-ä¾èµ–-1" class="headerlink" title="1.ä¾èµ–"></a>1.ä¾èµ–</h2><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.mybatis.spring.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>mybatis-spring-boot-starter<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>2.0.1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span><span class="token comment">&lt;!-- mysqlé©±åŠ¨ --></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>mysql<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>mysql-connector-java<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>5.1.18<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>      <span class="token comment">&lt;!-- å•å…ƒæµ‹è¯•ç›¸å…³ä¾èµ– --></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>junit<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>junit<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>4.12<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">></span></span>test<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">></span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.projectlombok<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>lombok<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>1.18.18<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>optional</span><span class="token punctuation">></span></span>true<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>optional</span><span class="token punctuation">></span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-boot-starter-test<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">></span></span>test<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="2-application-yml"><a href="#2-application-yml" class="headerlink" title="2.application.yml"></a>2.application.yml</h2><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token comment">#DataSource config é…ç½®æ•°æ®æºä¿¡æ¯</span><span class="token key atrule">spring</span><span class="token punctuation">:</span>  <span class="token key atrule">datasource</span><span class="token punctuation">:</span>    <span class="token key atrule">driver-class-name</span><span class="token punctuation">:</span> com.mysql.jdbc.Driver    <span class="token key atrule">url</span><span class="token punctuation">:</span> jdbc<span class="token punctuation">:</span>mysql<span class="token punctuation">:</span>//localhost<span class="token punctuation">:</span>3306/springcloudsell<span class="token punctuation">?</span>useUnicode=true<span class="token important">&amp;characterEncoding=utf-</span><span class="token number">8</span>    <span class="token key atrule">username</span><span class="token punctuation">:</span> root    <span class="token key atrule">password</span><span class="token punctuation">:</span> root<span class="token comment"># é…ç½®MyBatisçš„é…ç½®æ–‡ä»¶åœ°å€å’ŒMyBatisçš„æ˜ å°„æ–‡ä»¶åœ°å€</span><span class="token key atrule">mybatis</span><span class="token punctuation">:</span>  <span class="token key atrule">mapper-locations</span><span class="token punctuation">:</span> classpath<span class="token important">*:sqlmapper/*.xml</span>  <span class="token key atrule">configuration</span><span class="token punctuation">:</span>    <span class="token comment"># å…³é—­äºŒçº§ç¼“å­˜</span>    <span class="token key atrule">cache-enabled</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>    <span class="token key atrule">map-underscore-to-camel-case</span><span class="token punctuation">:</span> <span class="token boolean important">true</span><span class="token key atrule">logging</span><span class="token punctuation">:</span>  <span class="token key atrule">level</span><span class="token punctuation">:</span>    <span class="token key atrule">root</span><span class="token punctuation">:</span> info    <span class="token key atrule">org.springframework.web</span><span class="token punctuation">:</span> info    <span class="token comment">#    æ‰“å°sql</span>    <span class="token key atrule">com.enjoylearning.mybatis.mapper</span><span class="token punctuation">:</span> DEBUG<span class="token key atrule">server</span><span class="token punctuation">:</span>  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8081</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="3-å¯åŠ¨ç±»"><a href="#3-å¯åŠ¨ç±»" class="headerlink" title="3.å¯åŠ¨ç±»"></a>3.å¯åŠ¨ç±»</h2><p>ä¸ºäº†ä¸ç”¨åœ¨æ¯ä¸ªmapper.javaä¸­æ·»åŠ @Mapperæ³¨è§£ï¼Œå¯ä»¥ç»Ÿä¸€åœ¨å¯åŠ¨ç±»åŠ ä¸Š@MapperScanæ³¨è§£ã€‚</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@SpringBootApplication</span><span class="token annotation punctuation">@MapperScan</span><span class="token punctuation">(</span>basePackages <span class="token operator">=</span> <span class="token string">"com.enjoylearning.mybatis.dao"</span><span class="token punctuation">)</span><span class="token annotation punctuation">@Slf4j</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MybatisSpringbootDemoApplication</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"------------------MybatisSpringbootDemoApplication-----------start "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">MybatisSpringbootDemoApplication</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"------------------MybatisSpringbootDemoApplication------------end "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="4-æµ‹è¯•ç±»"><a href="#4-æµ‹è¯•ç±»" class="headerlink" title="4.æµ‹è¯•ç±»"></a>4.æµ‹è¯•ç±»</h2><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@RunWith</span><span class="token punctuation">(</span><span class="token class-name">SpringRunner</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token annotation punctuation">@SpringBootTest</span><span class="token punctuation">(</span>classes <span class="token operator">=</span> <span class="token class-name">MybatisSpringbootDemoApplication</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">StudentMapperTest</span><span class="token punctuation">&#123;</span><span class="token annotation punctuation">@Autowired</span><span class="token keyword">private</span> <span class="token class-name">UserInfoMapper</span> userInfoMapper<span class="token punctuation">;</span><span class="token annotation punctuation">@Test</span><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">selectStudentById</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>    <span class="token class-name">UserInfo</span> userInfo <span class="token operator">=</span> userInfoMapper<span class="token punctuation">.</span><span class="token function">selectByPrimaryKey</span><span class="token punctuation">(</span><span class="token string">"1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"---->æŸ¥è¯¢ç»“æœä¸º=&#123;&#125;"</span> <span class="token operator">+</span> userInfo<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> MyBatisæºç å­¦ä¹  </category>
          
      </categories>
      
      
        <tags>
            
            <tag> MyBatis </tag>
            
            <tag> æºç  </tag>
            
            <tag> Spring </tag>
            
            <tag> Spring Boot </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ã€MyBatisæºç å­¦ä¹ ã€‘Sqlæ‰§è¡Œ</title>
      <link href="/posts/20551.html"/>
      <url>/posts/20551.html</url>
      
        <content type="html"><![CDATA[<h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><p>ä¸Šä¸€ç¯‡<a href="https://zyxelva.github.io/posts/45790.html">ã€MyBatisæºç å­¦ä¹ ã€‘Sqlè§£æ</a>ä¸­ï¼Œæˆ‘ä¸»è¦æ¢³ç†äº†sqlçš„æºç è§£æè¿‡ç¨‹ï¼Œæœ¬ç« æˆ‘é€šè¿‡åŒæ ·çš„ä¸€ä¸ªä¾‹å­ï¼Œæ¥ä»”ç»†ç§ç§sqlæ˜¯æ€æ ·æ‰§è¡Œä¸‹æ¥çš„ã€‚ä¸»è¦åˆ†ä¸ºä¸‰ä¸ªæ­¥éª¤ï¼š</p><ul><li>åŠ¨æ€ä»£ç†ç”Ÿæˆmapper</li><li>sqlæ‰§è¡Œ</li><li>ç»“æœé›†å¤„ç†</li></ul><p>è¿˜æ˜¯é€šè¿‡åŒæ ·çš„ä¾‹å­æ¥å¼€å§‹æœ¬ç« çš„æºç sqlæ‰§è¡Œè¿‡ç¨‹è·Ÿè¸ªã€‚</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Test</span><span class="token comment">// ç¨‹åºå‘˜å–œæ¬¢çš„é£æ ¼</span><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">quickStart</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">&#123;</span>    <span class="token comment">// 2.è·å–sqlSession</span>    <span class="token class-name">SqlSession</span> sqlSession <span class="token operator">=</span> sqlSessionFactory<span class="token punctuation">.</span><span class="token function">openSession</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 3.è·å–å¯¹åº”mapper</span>    <span class="token class-name">TUserMapper</span> mapper <span class="token operator">=</span> sqlSession<span class="token punctuation">.</span><span class="token function">getMapper</span><span class="token punctuation">(</span><span class="token class-name">TUserMapper</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 4.æ‰§è¡ŒæŸ¥è¯¢è¯­å¥å¹¶è¿”å›å•æ¡æ•°æ®</span>    <span class="token class-name">TUser</span> user <span class="token operator">=</span> mapper<span class="token punctuation">.</span><span class="token function">selectByPrimaryKey</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h1 id="ä¸€ã€åŠ¨æ€ä»£ç†ç”Ÿæˆmapper"><a href="#ä¸€ã€åŠ¨æ€ä»£ç†ç”Ÿæˆmapper" class="headerlink" title="ä¸€ã€åŠ¨æ€ä»£ç†ç”Ÿæˆmapper"></a>ä¸€ã€åŠ¨æ€ä»£ç†ç”Ÿæˆmapper</h1><p>æˆ‘ä»¬ç›´æ¥ä»è¿™å¥å¼€å§‹è·Ÿä¸‹æºç ï¼š</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">TUserMapper</span> mapper <span class="token operator">=</span> sqlSession<span class="token punctuation">.</span><span class="token function">getMapper</span><span class="token punctuation">(</span><span class="token class-name">TUserMapper</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>æ–­ç‚¹è°ƒå¼å¼€å§‹<br><img src="https://cdn.jsdelivr.net/gh/zyxelva/picgo@main/csdn/20210322102317495.png"><br>æˆ‘ä»¬çœ‹åˆ°SqlSessionå®ä¾‹æ˜¯DefaultSqlSessionï¼Œç‚¹è¿›å»çœ‹çœ‹getMapper:<br><img src="https://cdn.jsdelivr.net/gh/zyxelva/picgo@main/csdn/20210322102447860.png"><br>è¿›å…¥çš„æ˜¯â€œå¤§ç®¡å®¶â€Configurationçš„getMapper.<br><img src="https://cdn.jsdelivr.net/gh/zyxelva/picgo@main/csdn/20210322102558173.png"></p><p>è€ŒçœŸæ­£ç»™å‡ºæ¥å£ä»£ç†ç±»çš„æ˜¯MapperRegistry.<img src="https://cdn.jsdelivr.net/gh/zyxelva/picgo@main/csdn/20210322102754132.png"><br>ç‚¹è¿›å»çœ‹çœ‹mapperProxyFactory.newInstance(sqlSession)å…·ä½“ç”Ÿæˆå®ä¾‹çš„ä»£ç ï¼š</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">// MapperProxyFactory</span><span class="token comment">// ç”Ÿæˆä¸€ä¸ª MapperProxyå¯¹è±¡</span>  <span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token string">"unchecked"</span><span class="token punctuation">)</span>  <span class="token keyword">protected</span> <span class="token class-name">T</span> <span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token class-name">MapperProxy</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> mapperProxy<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token class-name">T</span><span class="token punctuation">)</span> <span class="token class-name">Proxy</span><span class="token punctuation">.</span><span class="token function">newProxyInstance</span><span class="token punctuation">(</span>mapperInterface<span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">&#123;</span> mapperInterface <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> mapperProxy<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>  <span class="token keyword">public</span> <span class="token class-name">T</span> <span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token class-name">SqlSession</span> sqlSession<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">final</span> <span class="token class-name">MapperProxy</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> mapperProxy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MapperProxy</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span>sqlSession<span class="token punctuation">,</span> mapperInterface<span class="token punctuation">,</span> methodCache<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token function">newInstance</span><span class="token punctuation">(</span>mapperProxy<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å‘ç°ï¼Œè¿ç”¨çš„æ­£æ˜¯JDKåŠ¨æ€ä»£ç†ã€‚<br>æ¢³ç†ä¸‹è¯¥è¿‡ç¨‹çš„æ—¶åºå›¾ï¼Œå¦‚ä¸‹ï¼š<br><img src="https://cdn.jsdelivr.net/gh/zyxelva/picgo@main/csdn/20210322110043730.png"></p><h1 id="äºŒã€sqlæ‰§è¡Œ"><a href="#äºŒã€sqlæ‰§è¡Œ" class="headerlink" title="äºŒã€sqlæ‰§è¡Œ"></a>äºŒã€sqlæ‰§è¡Œ</h1><p>é€šè¿‡ä¸€ä¸­çš„è¿‡ç¨‹ï¼Œæˆ‘ä»¬å¯ä»¥å¾—åˆ°ä¸€ä¸ªæ¥å£çš„mapperProxyåŠ¨æ€ä»£ç†å¯¹è±¡äº†ã€‚sqlçš„æ‰§è¡Œè¿‡ç¨‹å°±æ˜¯ä»MapperProxyçš„invokeæ–¹æ³•å¼€å§‹çš„ã€‚<br><img src="https://cdn.jsdelivr.net/gh/zyxelva/picgo@main/csdn/20210322110414703.png"><br><img src="https://cdn.jsdelivr.net/gh/zyxelva/picgo@main/csdn/20210322110853190.png"><br>å…ˆå»ç¼“å­˜ä¸­çœ‹çœ‹æ˜¯å¦å·²ç»æœ‰äº†ç°æˆçš„MapperMethodï¼Œæ²¡æœ‰æ‰å›å»newä¸€ä¸ªå‡ºæ¥ã€‚<br>æ¥ä¸‹æ¥ï¼Œè°ƒç”¨ MapperMethod ä¸­çš„executeæ–¹æ³•ã€‚<br><img src="https://cdn.jsdelivr.net/gh/zyxelva/picgo@main/csdn/20210322111101131.png"><br>æœ¬ä¾‹ä¸­ï¼Œæ‰§è¡Œçš„æ˜¯ä¸€ä¸ªæŸ¥è¯¢è¯­å¥ï¼Œè¿›å…¥case SELECTåˆ†æ”¯</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">case</span> <span class="token constant">SELECT</span><span class="token operator">:</span> <span class="token comment">// å¦‚æœæ˜¯æŸ¥è¯¢è¯­å¥</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>method<span class="token punctuation">.</span><span class="token function">returnsVoid</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> method<span class="token punctuation">.</span><span class="token function">hasResultHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// è¿”å›ä¸ºvoidï¼Œä¸”æœ‰ç»“æœå¤„ç†å™¨</span>          <span class="token comment">// ä½¿ç”¨ç»“æœå¤„ç†å™¨æ‰§è¡ŒæŸ¥è¯¢</span>          <span class="token function">executeWithResultHandler</span><span class="token punctuation">(</span>sqlSession<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>          result <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>method<span class="token punctuation">.</span><span class="token function">returnsMany</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// å¤šæ¡ç»“æœæŸ¥è¯¢</span>          result <span class="token operator">=</span> <span class="token function">executeForMany</span><span class="token punctuation">(</span>sqlSession<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>method<span class="token punctuation">.</span><span class="token function">returnsMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// mapç»“æœæŸ¥è¯¢</span>          result <span class="token operator">=</span> <span class="token function">executeForMap</span><span class="token punctuation">(</span>sqlSession<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>method<span class="token punctuation">.</span><span class="token function">returnsCursor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// æ¸¸æ ‡ç±»å‹ç»“æœæŸ¥è¯¢</span>          result <span class="token operator">=</span> <span class="token function">executeForCursor</span><span class="token punctuation">(</span>sqlSession<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span> <span class="token comment">// å•æ¡ç»“æœæŸ¥è¯¢</span>          <span class="token comment">// å°†å‚æ•°é¡ºåºä¸å®å‚å¯¹åº”å¥½</span>          <span class="token class-name">Object</span> param <span class="token operator">=</span> method<span class="token punctuation">.</span><span class="token function">convertArgsToSqlCommandParam</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>          result <span class="token operator">=</span> sqlSession<span class="token punctuation">.</span><span class="token function">selectOne</span><span class="token punctuation">(</span>command<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> param<span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token keyword">if</span> <span class="token punctuation">(</span>method<span class="token punctuation">.</span><span class="token function">returnsOptional</span><span class="token punctuation">(</span><span class="token punctuation">)</span>              <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>result <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> <span class="token operator">!</span>method<span class="token punctuation">.</span><span class="token function">getReturnType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            result <span class="token operator">=</span> <span class="token class-name">Optional</span><span class="token punctuation">.</span><span class="token function">ofNullable</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">break</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œæ ¹æ®è¿”å›çš„ç»“æœç±»å‹ï¼Œè¿›å…¥ä¸åŒçš„å¤„ç†é€»è¾‘ï¼Œä¸»è¦æœ‰</p><ul><li>è¿”å›ä¸ºvoid</li><li>è¿”å›å¤šæ¡ç»“æœ</li><li>è¿”å›mapç»“æœ</li><li>è¿”å›å•æ¡ç»“æœ</li></ul><p>è¿”å›å€¼ä¸ºç©ºçš„æƒ…å†µä¸‹ï¼Œç›´æ¥è¿”å› result &#x3D; nullã€‚å…¶ä½™å‡ ç§æƒ…å†µå†…éƒ¨éƒ½è°ƒç”¨äº†sqlSession ä¸­çš„selectList æ–¹æ³•ã€‚è¿™é‡Œæˆ‘ä»¬ä»¥selectOneä¸ºä¾‹ã€‚<br>convertArgsToSqlCommandParam()å‰é¢æˆ‘ä»¬åœ¨<a href="https://blog.csdn.net/kezade/article/details/114801993">ã€Mybatisæºç å­¦ä¹ ã€‘å‚æ•°è§£æ</a>åšè¿‡è¯´æ˜ï¼Œä¸»è¦è¿›è¡Œå‚æ•°çš„é¡ºåºæ˜ å°„è§£æã€‚è¿™é‡Œä¸åšèµ˜è¿°ã€‚ç›´æ¥çœ‹çœ‹DefaultSqlSession.selectOneæ–¹æ³•ã€‚</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Override</span>  <span class="token keyword">public</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> <span class="token class-name">T</span> <span class="token function">selectOne</span><span class="token punctuation">(</span><span class="token class-name">String</span> statement<span class="token punctuation">,</span> <span class="token class-name">Object</span> parameter<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token comment">// Popular vote was to return null on 0 results and throw exception on too many.</span>    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> list <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">selectList</span><span class="token punctuation">(</span>statement<span class="token punctuation">,</span> parameter<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>list<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      <span class="token keyword">return</span> list<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>list<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">TooManyResultsException</span><span class="token punctuation">(</span><span class="token string">"Expected one result (or null) to be returned by selectOne(), but found: "</span> <span class="token operator">+</span> list<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>      <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>  <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å¦‚æœselectListæŸ¥è¯¢è¿”å›1æ¡ï¼Œåˆ™ç›´æ¥è¿”å›ï¼›å¦‚æœè¿”å›å¤šæ¡åˆ™æŠ›å‡ºå¼‚å¸¸ï¼Œå¦åˆ™ç›´æ¥è¿”å›nullã€‚<br>ç‚¹è¿›å»çœ‹çœ‹selectListæ–¹æ³•ã€‚</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/**   * æŸ¥è¯¢ç»“æœåˆ—è¡¨   * @param &lt;E> è¿”å›çš„åˆ—è¡¨å…ƒç´ çš„ç±»å‹   * @param statement SQLè¯­å¥   * @param parameter å‚æ•°å¯¹è±¡   * @param rowBounds  ç¿»é¡µé™åˆ¶æ¡ä»¶   * @return ç»“æœå¯¹è±¡åˆ—è¡¨   */</span>  <span class="token annotation punctuation">@Override</span>  <span class="token keyword">public</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">></span></span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">></span></span> <span class="token function">selectList</span><span class="token punctuation">(</span><span class="token class-name">String</span> statement<span class="token punctuation">,</span> <span class="token class-name">Object</span> parameter<span class="token punctuation">,</span> <span class="token class-name">RowBounds</span> rowBounds<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>      <span class="token comment">// è·å–æŸ¥è¯¢è¯­å¥</span>      <span class="token class-name">MappedStatement</span> ms <span class="token operator">=</span> configuration<span class="token punctuation">.</span><span class="token function">getMappedStatement</span><span class="token punctuation">(</span>statement<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment">// äº¤ç”±æ‰§è¡Œå™¨è¿›è¡ŒæŸ¥è¯¢</span>      <span class="token keyword">return</span> executor<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>ms<span class="token punctuation">,</span> <span class="token function">wrapCollection</span><span class="token punctuation">(</span>parameter<span class="token punctuation">)</span><span class="token punctuation">,</span> rowBounds<span class="token punctuation">,</span> <span class="token class-name">Executor</span><span class="token punctuation">.</span><span class="token constant">NO_RESULT_HANDLER</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      <span class="token keyword">throw</span> <span class="token class-name">ExceptionFactory</span><span class="token punctuation">.</span><span class="token function">wrapException</span><span class="token punctuation">(</span><span class="token string">"Error querying database.  Cause: "</span> <span class="token operator">+</span> e<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span> <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span>      <span class="token class-name">ErrorContext</span><span class="token punctuation">.</span><span class="token function">instance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>  <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è¿™é‡Œè¯´æ˜ä¸‹ï¼Œmybatisé»˜è®¤æ˜¯å¼€å¯äº†äºŒçº§ç¼“å­˜çš„ï¼Œæ‰€ä»¥è¿™é‡Œexecutorå…¶å®æ˜¯CachingExecutor.æˆ‘ä»¬å¯ä»¥åœ¨åˆ›å»ºsqlSessionä¸­çœ‹çœ‹Configurationä¸­åˆ›å»ºæ‰§è¡Œå™¨æ—¶çš„ä»£ç ï¼š<br><img src="https://cdn.jsdelivr.net/gh/zyxelva/picgo@main/csdn/20210322135551582.png"><br>è¦å…³é—­äºŒçº§ç¼“å­˜ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨mybatis-config.xmlä¸­æ˜¾ç¤ºé…ç½®ï¼Œå¦‚ä¸‹ï¼š</p><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token comment">&lt;!-- äºŒçº§ç¼“å­˜å¼€å…³ï¼Œé»˜è®¤ä¸ºå¼€å¯--></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>setting</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>cacheEnabled<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>false<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>å…³é—­äºŒçº§ç¼“å­˜ï¼Œæˆ‘ä»¬å›åˆ°selectListæ–¹æ³•ä¸­ï¼Œç»§ç»­è·Ÿä¸‹è¿™æ®µä»£ç çš„æ‰§è¡Œè¿‡ç¨‹ï¼š</p><pre class="line-numbers language-java" data-language="java"><code class="language-java">executor<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>ms<span class="token punctuation">,</span> <span class="token function">wrapCollection</span><span class="token punctuation">(</span>parameter<span class="token punctuation">)</span><span class="token punctuation">,</span> rowBounds<span class="token punctuation">,</span> <span class="token class-name">Executor</span><span class="token punctuation">.</span><span class="token constant">NO_RESULT_HANDLER</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>executorè¿™é‡Œä¸ºSimpleExecutorï¼Œå…¶é¦–å…ˆè°ƒç”¨çš„æ˜¯BaseExecutorçš„queryæ–¹æ³•ã€‚<br><img src="https://cdn.jsdelivr.net/gh/zyxelva/picgo@main/csdn/2021032214023869.png"></p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/**   * æŸ¥è¯¢æ•°æ®åº“ä¸­çš„æ•°æ®   * @param ms æ˜ å°„è¯­å¥   * @param parameter å‚æ•°å¯¹è±¡   * @param rowBounds ç¿»é¡µé™åˆ¶æ¡ä»¶   * @param resultHandler ç»“æœå¤„ç†å™¨   * @param key ç¼“å­˜çš„é”®   * @param boundSql æŸ¥è¯¢è¯­å¥   * @param &lt;E> ç»“æœç±»å‹   * @return ç»“æœåˆ—è¡¨   * @throws SQLException   */</span>  <span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token string">"unchecked"</span><span class="token punctuation">)</span>  <span class="token annotation punctuation">@Override</span>  <span class="token keyword">public</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">></span></span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">></span></span> <span class="token function">query</span><span class="token punctuation">(</span><span class="token class-name">MappedStatement</span> ms<span class="token punctuation">,</span> <span class="token class-name">Object</span> parameter<span class="token punctuation">,</span> <span class="token class-name">RowBounds</span> rowBounds<span class="token punctuation">,</span> <span class="token class-name">ResultHandler</span> resultHandler<span class="token punctuation">,</span> <span class="token class-name">CacheKey</span> key<span class="token punctuation">,</span> <span class="token class-name">BoundSql</span> boundSql<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">SQLException</span> <span class="token punctuation">&#123;</span>    <span class="token class-name">ErrorContext</span><span class="token punctuation">.</span><span class="token function">instance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">resource</span><span class="token punctuation">(</span>ms<span class="token punctuation">.</span><span class="token function">getResource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">activity</span><span class="token punctuation">(</span><span class="token string">"executing a query"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">object</span><span class="token punctuation">(</span>ms<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>closed<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      <span class="token comment">// æ‰§è¡Œå™¨å·²ç»å…³é—­</span>      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ExecutorException</span><span class="token punctuation">(</span><span class="token string">"Executor was closed."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>queryStack <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> ms<span class="token punctuation">.</span><span class="token function">isFlushCacheRequired</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// æ–°çš„æŸ¥è¯¢æ ˆä¸”è¦æ±‚æ¸…é™¤ç¼“å­˜</span>      <span class="token comment">// æ–°çš„æŸ¥è¯¢æ ˆï¼Œæ•…æ¸…é™¤æœ¬åœ°ç¼“å­˜ï¼Œå³æ¸…é™¤ä¸€çº§ç¼“å­˜</span>      <span class="token function">clearLocalCache</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">></span></span> list<span class="token punctuation">;</span>    <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>      queryStack<span class="token operator">++</span><span class="token punctuation">;</span>      <span class="token comment">// å°è¯•ä»æœ¬åœ°ç¼“å­˜è·å–ç»“æœ</span>      list <span class="token operator">=</span> resultHandler <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">></span></span><span class="token punctuation">)</span> localCache<span class="token punctuation">.</span><span class="token function">getObject</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">;</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>list <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token comment">// æœ¬åœ°ç¼“å­˜ä¸­æœ‰ç»“æœï¼Œåˆ™å¯¹äºCALLABLEè¯­å¥è¿˜éœ€è¦ç»‘å®šåˆ°IN/INOUTå‚æ•°ä¸Š</span>        <span class="token function">handleLocallyCachedOutputParameters</span><span class="token punctuation">(</span>ms<span class="token punctuation">,</span> key<span class="token punctuation">,</span> parameter<span class="token punctuation">,</span> boundSql<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>        <span class="token comment">// æœ¬åœ°ç¼“å­˜æ²¡æœ‰ç»“æœï¼Œæ•…éœ€è¦æŸ¥è¯¢æ•°æ®åº“</span>        list <span class="token operator">=</span> <span class="token function">queryFromDatabase</span><span class="token punctuation">(</span>ms<span class="token punctuation">,</span> parameter<span class="token punctuation">,</span> rowBounds<span class="token punctuation">,</span> resultHandler<span class="token punctuation">,</span> key<span class="token punctuation">,</span> boundSql<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span> <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span>      queryStack<span class="token operator">--</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>queryStack <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      <span class="token comment">// æ‡’åŠ è½½æ“ä½œçš„å¤„ç†</span>      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">DeferredLoad</span> deferredLoad <span class="token operator">:</span> deferredLoads<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        deferredLoad<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">&#125;</span>      <span class="token comment">// issue #601</span>      deferredLoads<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment">// å¦‚æœæœ¬åœ°ç¼“å­˜çš„ä½œç”¨åŸŸä¸ºSTATEMENTï¼Œåˆ™ç«‹åˆ»æ¸…é™¤æœ¬åœ°ç¼“å­˜</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>configuration<span class="token punctuation">.</span><span class="token function">getLocalCacheScope</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">LocalCacheScope</span><span class="token punctuation">.</span><span class="token constant">STATEMENT</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token comment">// issue #482</span>        <span class="token function">clearLocalCache</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">return</span> list<span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å…ˆä»ä¸€çº§ç¼“å­˜ä¸­æŸ¥è¯¢æ˜¯å¦å·²æœ‰ç»“æœï¼Œæ²¡æœ‰åˆ™æ‰å»æŸ¥è¯¢æ•°æ®åº“ã€‚æˆ‘ä»¬ç›´æ¥çœ‹æŸ¥è¯¢æ•°æ®åº“çš„éƒ¨åˆ†ï¼Œä¹Ÿå°±æ˜¯æ–¹æ³•queryFromDatabase().<br><img src="https://cdn.jsdelivr.net/gh/zyxelva/picgo@main/csdn/20210322141109713.png"><br>è¿›å…¥doQuery()æ–¹æ³•ï¼Œå‘ç°è¿™é‡Œæ˜¯ä¸ªæ¨¡ç‰ˆæ–¹æ³•ï¼Œç”±äºå‰é¢æåˆ°æˆ‘ä»¬æ­¤å¤„çš„æ‰§è¡Œå™¨ä¸ºSimpleExecutorï¼Œæ‰€ä»¥è¿™ä¸ªæ–¹æ³•æ¥åˆ°äº†SimpleExecutorçš„doQuery()æ–¹æ³•.</p><p><img src="https://cdn.jsdelivr.net/gh/zyxelva/picgo@main/csdn/20210322141449815.png"><br>å¦‚ä¸Šï¼Œè¯¥æ–¹æ³•ä¸»è¦æœ‰ä¸‰æ­¥ï¼š</p><ul><li>æ–°å»ºä¸€ä¸ªStatementHandler</li><li>è·å–Statement</li><li>StatementHandler.queryï¼ˆå®é™…è°ƒç”¨çš„æ˜¯PreparedStatementHandlerï¼‰è·å–æŸ¥è¯¢ç»“æœã€‚</li></ul><p>æˆ‘ä»¬çœ‹çœ‹prepareStatementæ–¹æ³•ã€‚</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"> <span class="token comment">//SimpleExecutor</span> <span class="token keyword">private</span> <span class="token class-name">Statement</span> <span class="token function">prepareStatement</span><span class="token punctuation">(</span><span class="token class-name">StatementHandler</span> handler<span class="token punctuation">,</span> <span class="token class-name">Log</span> statementLog<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">SQLException</span> <span class="token punctuation">&#123;</span>   <span class="token class-name">Statement</span> stmt<span class="token punctuation">;</span><span class="token comment">//è·å–æ•°æ®åº“è¿æ¥</span>   <span class="token class-name">Connection</span> connection <span class="token operator">=</span> <span class="token function">getConnection</span><span class="token punctuation">(</span>statementLog<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">//åˆ›å»ºStatement</span>   stmt <span class="token operator">=</span> handler<span class="token punctuation">.</span><span class="token function">prepare</span><span class="token punctuation">(</span>connection<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">//ä¸ºStatementè®¾ç½®INå‚æ•°</span>   handler<span class="token punctuation">.</span><span class="token function">parameterize</span><span class="token punctuation">(</span>stmt<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token keyword">return</span> stmt<span class="token punctuation">;</span> <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ç»å…¸çš„æµç¨‹ï¼šè·å–æ•°æ®åº“è¿æ¥ï¼›åˆ›å»ºStatement; ä¸ºStatementè®¾ç½®INå‚æ•°ã€‚å†çœ‹ç¬¬ä¸‰æ­¥æ‰§è¡Œè¯­å¥ï¼š</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"> <span class="token comment">//PreparedStatementHandler</span> <span class="token keyword">public</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">></span></span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">></span></span> <span class="token function">query</span><span class="token punctuation">(</span><span class="token class-name">Statement</span> statement<span class="token punctuation">,</span> <span class="token class-name">ResultHandler</span> resultHandler<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">SQLException</span> <span class="token punctuation">&#123;</span>   <span class="token class-name">PreparedStatement</span> ps <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">PreparedStatement</span><span class="token punctuation">)</span> statement<span class="token punctuation">;</span><span class="token comment">// æ‰§è¡ŒSQL</span>   ps<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// å¤„ç†æ‰§è¡Œç»“æœ</span>   <span class="token keyword">return</span> resultSetHandler<span class="token punctuation">.</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">></span></span> <span class="token function">handleResultSets</span><span class="token punctuation">(</span>ps<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æŸ¥è¯¢å®Œæ¯•ï¼Œæ€»ç»“ä¸€ä¸‹è¿™ä¸ªè¿‡ç¨‹çš„æ—¶åºå›¾ï¼Œä¸€ç›®äº†ç„¶ï¼š<br><img src="https://cdn.jsdelivr.net/gh/zyxelva/picgo@main/csdn/20210322151224922.png"></p><h1 id="ä¸‰ã€ç»“æœé›†å¤„ç†"><a href="#ä¸‰ã€ç»“æœé›†å¤„ç†" class="headerlink" title="ä¸‰ã€ç»“æœé›†å¤„ç†"></a>ä¸‰ã€ç»“æœé›†å¤„ç†</h1><p>ç»“æœé›†çš„æ˜ å°„ï¼Œè¿™éƒ¨åˆ†æˆ‘ä¼šåœ¨ä¸‹ä¸€ç¯‡è¯¦ç»†çš„è·Ÿè¿›ã€‚Game over.</p>]]></content>
      
      
      <categories>
          
          <category> MyBatisæºç å­¦ä¹  </category>
          
      </categories>
      
      
        <tags>
            
            <tag> MyBatis </tag>
            
            <tag> æºç  </tag>
            
            <tag> SQL </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ã€MyBatisæºç å­¦ä¹ ã€‘Sqlè§£æ</title>
      <link href="/posts/45790.html"/>
      <url>/posts/45790.html</url>
      
        <content type="html"><![CDATA[<h1 id="ä¸€ã€å‰è¨€"><a href="#ä¸€ã€å‰è¨€" class="headerlink" title="ä¸€ã€å‰è¨€"></a>ä¸€ã€å‰è¨€</h1><p>ä¹‹å‰æˆ‘åœ¨<a href="https://zyxelva.github.io/posts/24693.html">ã€Mybatisæºç å­¦ä¹ ã€‘åˆå§‹åŒ–é˜¶æ®µ</a> ä¸­é‡ç‚¹è®²è¿°äº†æ ¸å¿ƒé…ç½®ç±»XMLConfigBuilderã€XMLMapperBuilderã€XMLStatementBuilderå„è‡ªçš„åŠŸèƒ½ã€‚æˆ‘ä»¬å…ˆç†Ÿæ‚‰ä¸‹è¿™â€œä¸‰å‰‘å®¢â€ï¼Œçœ‹ä¸‹å›¾å³å¯ã€‚<br><img src="https://cdn.jsdelivr.net/gh/zyxelva/picgo@main/csdn/20210315205850237.png"><br>æœ¬ç« èŠ‚ä¸­ï¼Œæˆ‘ä»¬é‡ç‚¹è·Ÿä¸€ä¸‹XMLMapperBuilderã€XMLStatementBuilderè§£æsqlçš„æºç è¿‡ç¨‹ã€‚<br>XMLMapperBuilderã€XMLStatementBuilderå‡å®ç°äº†BaseBuilderã€‚<br><img src="https://cdn.jsdelivr.net/gh/zyxelva/picgo@main/csdn/2021031521015322.png"><br>XMLMapperBuilderä¸»è¦åŠŸèƒ½ï¼š<br>    éå†mybatisä¸­mapperLocationså±æ€§ä¸­çš„xmlæ–‡ä»¶ä¸­æ¯ä¸ªèŠ‚ç‚¹çš„Builderï¼Œæ¯”å¦‚user.xmlï¼Œå†…éƒ¨ä¼šä½¿ç”¨XMLStatementBuilderå¤„ç†xmlä¸­çš„æ¯ä¸ªèŠ‚ç‚¹ã€‚<br>XMLStatementBuilderä¸»è¦åŠŸèƒ½ï¼š<br>    è§£æxmlæ–‡ä»¶ä¸­å„ä¸ªèŠ‚ç‚¹ï¼Œæ¯”å¦‚select,insert,update,deleteèŠ‚ç‚¹ï¼Œå†…éƒ¨ä¼šä½¿ç”¨XMLScriptBuilderå¤„ç†èŠ‚ç‚¹çš„sqléƒ¨åˆ†ï¼Œéå†äº§ç”Ÿçš„æ•°æ®ä¼šä¸¢åˆ°Configurationçš„mappedStatementsä¸­ã€‚</p><p>åœ¨<a href="https://zyxelva.github.io/posts/24693.html">ã€Mybatisæºç å­¦ä¹ ã€‘åˆå§‹åŒ–é˜¶æ®µ</a>ä¸­ï¼Œæˆ‘ä»¬åˆ†æäº†XMLConfigBuilderçš„ä¸»è¦å·¥ä½œæµç¨‹ã€‚è¿˜æ˜¯ä»¥ä¸‹é¢çš„ä»£ç ä¸ºä¾‹ï¼Œé‡ç‚¹åˆ†æä¸‹XMLMapperBuilderå’ŒXMLStatementBuilderè§£æsqlçš„æµç¨‹ã€‚</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Before</span><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">&#123;</span>    <span class="token comment">//--------------------ç¬¬ä¸€é˜¶æ®µ---------------------------</span>    <span class="token comment">// 1.è¯»å–mybatisé…ç½®æ–‡ä»¶åˆ›SqlSessionFactory</span>    <span class="token class-name">String</span> resource <span class="token operator">=</span> <span class="token string">"mybatis-config.xml"</span><span class="token punctuation">;</span>    <span class="token class-name">InputStream</span> inputStream <span class="token operator">=</span> <span class="token class-name">Resources</span><span class="token punctuation">.</span><span class="token function">getResourceAsStream</span><span class="token punctuation">(</span>resource<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 1.è¯»å–mybatisé…ç½®æ–‡ä»¶åˆ›SqlSessionFactory</span>    sqlSessionFactory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SqlSessionFactoryBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span>inputStream<span class="token punctuation">)</span><span class="token punctuation">;</span>    inputStream<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è¿›å…¥new SqlSessionFactoryBuilder().build(inputStream)æ–¹æ³•ï¼Œæˆ‘ä»¬çœ‹çœ‹parseçš„æ–¹æ³•ã€‚<br><img src="https://cdn.jsdelivr.net/gh/zyxelva/picgo@main/csdn/20210316135635377.png"><br><img src="https://cdn.jsdelivr.net/gh/zyxelva/picgo@main/csdn/2021031613571219.png"><br>è€Œæˆ‘è¿™é‡Œçš„mybatis-config.xmlæ–‡ä»¶å¦‚ä¸‹ï¼š</p><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token prolog">&lt;?xml version="1.0" encoding="UTF-8" ?></span><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">configuration</span> <span class="token name">PUBLIC</span> <span class="token string">"-//mybatis.org//DTD Config 3.0//EN"</span> <span class="token string">"http://mybatis.org/dtd/mybatis-3-config.dtd"</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>configuration</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>properties</span> <span class="token attr-name">resource</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>db.properties<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>settings</span><span class="token punctuation">></span></span>        <span class="token comment">&lt;!-- è®¾ç½®è‡ªåŠ¨é©¼å³°è½¬æ¢ --></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>setting</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>mapUnderscoreToCamelCase<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>        <span class="token comment">&lt;!-- å¼€å¯æ‡’åŠ è½½ --></span>        <span class="token comment">&lt;!-- å½“å¯ç”¨æ—¶ï¼Œæœ‰å»¶è¿ŸåŠ è½½å±æ€§çš„å¯¹è±¡åœ¨è¢«è°ƒç”¨æ—¶å°†ä¼šå®Œå…¨åŠ è½½ä»»æ„å±æ€§ã€‚å¦åˆ™ï¼Œæ¯ç§å±æ€§å°†ä¼šæŒ‰éœ€è¦åŠ è½½ã€‚é»˜è®¤ï¼štrue --></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>setting</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>aggressiveLazyLoading<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>false<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>settings</span><span class="token punctuation">></span></span>    <span class="token comment">&lt;!-- åˆ«åå®šä¹‰ --></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>typeAliases</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>package</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>com.enjoylearning.mybatis.entity<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>typeAliases</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugins</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugin</span> <span class="token attr-name">interceptor</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>com.enjoylearning.mybatis.Interceptors.ThresholdInterceptor<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>threshold<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>10<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugin</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugin</span> <span class="token attr-name">interceptor</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>com.github.pagehelper.PageInterceptor<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>pageSizeZero<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugin</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugins</span><span class="token punctuation">></span></span>    <span class="token comment">&lt;!--é…ç½®environmentç¯å¢ƒ --></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>environments</span> <span class="token attr-name">default</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>development<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>        <span class="token comment">&lt;!-- ç¯å¢ƒé…ç½®1ï¼Œæ¯ä¸ªSqlSessionFactoryå¯¹åº”ä¸€ä¸ªç¯å¢ƒ --></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>environment</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>development<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>transactionManager</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>JDBC<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dataSource</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>POOLED<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>driver<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>$&#123;jdbc_driver&#125;<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>url<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>$&#123;jdbc_url&#125;<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>username<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>$&#123;jdbc_username&#125;<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>password<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>$&#123;jdbc_password&#125;<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dataSource</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>environment</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>environments</span><span class="token punctuation">></span></span>    <span class="token comment">&lt;!-- æ˜ å°„æ–‡ä»¶ï¼Œmapperçš„é…ç½®æ–‡ä»¶ --></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>mappers</span><span class="token punctuation">></span></span>        <span class="token comment">&lt;!--ç›´æ¥æ˜ å°„åˆ°ç›¸åº”çš„mapperæ–‡ä»¶ --></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>mapper</span> <span class="token attr-name">resource</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>sqlmapper/UserInfoMapper.xml<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>mapper</span> <span class="token attr-name">resource</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>sqlmapper/TUserTestMapper.xml<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>mapper</span> <span class="token attr-name">resource</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>sqlmapper/TRoleMapper.xml<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>mapper</span> <span class="token attr-name">resource</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>sqlmapper/TJobHistoryMapper.xml<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>mapper</span> <span class="token attr-name">resource</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>sqlmapper/TPositionMapper.xml<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>mapper</span> <span class="token attr-name">resource</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>sqlmapper/THealthReportFemaleMapper.xml<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>mapper</span> <span class="token attr-name">resource</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>sqlmapper/THealthReportMaleMapper.xml<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>mappers</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>configuration</span><span class="token punctuation">></span></span>  <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h1 id="äºŒã€XMLMapperBuilder"><a href="#äºŒã€XMLMapperBuilder" class="headerlink" title="äºŒã€XMLMapperBuilder"></a>äºŒã€XMLMapperBuilder</h1><p>å¯¹äºparser.evalNode(â€œ&#x2F;configurationâ€)ï¼Œè¿™é‡Œæˆ‘å°±ä¸èµ˜è¿°äº†ï¼Œé‡ç‚¹å…³æ³¨parseConfigurationé‡Œé¢çš„mapperElement()æ–¹æ³•ã€‚<br><img src="https://cdn.jsdelivr.net/gh/zyxelva/picgo@main/csdn/20210316135924625.png"><br>è¿™ä¸ªmapperElement()ä¸»è¦å°±æ˜¯è§£æ&lt;mappers&gt;æ ‡ç­¾ä¸‹çš„å†…å®¹. è¿™é‡Œè´´å‡ºè¿™ä¸ªæ–¹æ³•çš„æºç ï¼ŒåŒ…å«æ³¨é‡Šã€‚</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/**  * è§£æmappersèŠ‚ç‚¹ï¼Œä¾‹å¦‚ï¼š  * &lt;mappers>  *    &lt;mapper resource="com/github/yeecode/mybatisDemo/UserDao.xml"/>  *    &lt;package name="com.github.yeecode.mybatisDemo" />  * &lt;/mappers>  * @param parent mappersèŠ‚ç‚¹  * @throws Exception  */</span> <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">mapperElement</span><span class="token punctuation">(</span><span class="token class-name">XNode</span> parent<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>   <span class="token keyword">if</span> <span class="token punctuation">(</span>parent <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>     <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">XNode</span> child <span class="token operator">:</span> parent<span class="token punctuation">.</span><span class="token function">getChildren</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>       <span class="token comment">// å¤„ç†mappersçš„å­èŠ‚ç‚¹ï¼Œå³mapperèŠ‚ç‚¹æˆ–è€…packageèŠ‚ç‚¹</span>       <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">"package"</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>child<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// packageèŠ‚ç‚¹</span>         <span class="token comment">// å–å‡ºåŒ…è·¯å¾„</span>         <span class="token class-name">String</span> mapperPackage <span class="token operator">=</span> child<span class="token punctuation">.</span><span class="token function">getStringAttribute</span><span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>         <span class="token comment">// å…¨éƒ¨åŠ å…¥Mappersä¸­</span>         configuration<span class="token punctuation">.</span><span class="token function">addMappers</span><span class="token punctuation">(</span>mapperPackage<span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>         <span class="token comment">// resourceã€urlã€classè¿™ä¸‰ä¸ªå±æ€§åªæœ‰ä¸€ä¸ªç”Ÿæ•ˆ</span>         <span class="token class-name">String</span> resource <span class="token operator">=</span> child<span class="token punctuation">.</span><span class="token function">getStringAttribute</span><span class="token punctuation">(</span><span class="token string">"resource"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>         <span class="token class-name">String</span> url <span class="token operator">=</span> child<span class="token punctuation">.</span><span class="token function">getStringAttribute</span><span class="token punctuation">(</span><span class="token string">"url"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>         <span class="token class-name">String</span> mapperClass <span class="token operator">=</span> child<span class="token punctuation">.</span><span class="token function">getStringAttribute</span><span class="token punctuation">(</span><span class="token string">"class"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>         <span class="token keyword">if</span> <span class="token punctuation">(</span>resource <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> url <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> mapperClass <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>           <span class="token class-name">ErrorContext</span><span class="token punctuation">.</span><span class="token function">instance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">resource</span><span class="token punctuation">(</span>resource<span class="token punctuation">)</span><span class="token punctuation">;</span>           <span class="token comment">// è·å–æ–‡ä»¶çš„è¾“å…¥æµ</span>           <span class="token class-name">InputStream</span> inputStream <span class="token operator">=</span> <span class="token class-name">Resources</span><span class="token punctuation">.</span><span class="token function">getResourceAsStream</span><span class="token punctuation">(</span>resource<span class="token punctuation">)</span><span class="token punctuation">;</span>           <span class="token comment">// ä½¿ç”¨XMLMapperBuilderè§£ææ˜ å°„æ–‡ä»¶</span>           <span class="token class-name">XMLMapperBuilder</span> mapperParser <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">XMLMapperBuilder</span><span class="token punctuation">(</span>inputStream<span class="token punctuation">,</span> configuration<span class="token punctuation">,</span> resource<span class="token punctuation">,</span> configuration<span class="token punctuation">.</span><span class="token function">getSqlFragments</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>           mapperParser<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>         <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>resource <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> url <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> mapperClass <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>           <span class="token class-name">ErrorContext</span><span class="token punctuation">.</span><span class="token function">instance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">resource</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>           <span class="token comment">// ä»ç½‘ç»œè·å¾—è¾“å…¥æµ</span>           <span class="token class-name">InputStream</span> inputStream <span class="token operator">=</span> <span class="token class-name">Resources</span><span class="token punctuation">.</span><span class="token function">getUrlAsStream</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>           <span class="token comment">// ä½¿ç”¨XMLMapperBuilderè§£ææ˜ å°„æ–‡ä»¶</span>           <span class="token class-name">XMLMapperBuilder</span> mapperParser <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">XMLMapperBuilder</span><span class="token punctuation">(</span>inputStream<span class="token punctuation">,</span> configuration<span class="token punctuation">,</span> url<span class="token punctuation">,</span> configuration<span class="token punctuation">.</span><span class="token function">getSqlFragments</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>           mapperParser<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>         <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>resource <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> url <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> mapperClass <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>           <span class="token comment">// é…ç½®çš„ä¸æ˜¯æ˜ å°„æ–‡ä»¶ï¼Œè€Œæ˜¯æ˜ å°„æ¥å£</span>           <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span> mapperInterface <span class="token operator">=</span> <span class="token class-name">Resources</span><span class="token punctuation">.</span><span class="token function">classForName</span><span class="token punctuation">(</span>mapperClass<span class="token punctuation">)</span><span class="token punctuation">;</span>           configuration<span class="token punctuation">.</span><span class="token function">addMapper</span><span class="token punctuation">(</span>mapperInterface<span class="token punctuation">)</span><span class="token punctuation">;</span>         <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>           <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BuilderException</span><span class="token punctuation">(</span><span class="token string">"A mapper element may only specify a url, resource or class, but not more than one."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>         <span class="token punctuation">&#125;</span>       <span class="token punctuation">&#125;</span>     <span class="token punctuation">&#125;</span>   <span class="token punctuation">&#125;</span> <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>forå¾ªç¯é‡Œçš„ifä¸»è¦æ˜¯é’ˆå¯¹&lt;mappers&gt;æ ‡ç­¾ä¸‹è¿˜æœ‰&lt;package&gt;æ ‡ç­¾çš„è§£æã€‚è€Œelseåˆ™æ˜¯é’ˆå¯¹&lt;mappers&gt;æ ‡ç­¾ä¸‹è¿˜æœ‰&lt;mapper&gt;æ ‡ç­¾çš„è§£æã€‚é€šå¸¸ï¼Œæˆ‘ä»¬çš„&lt;mapper&gt;ä¼šæœ‰ä¸‰ç§å½¢å¼ï¼Œä¸”resourceã€urlã€classè¿™ä¸‰ä¸ªå±æ€§åªæœ‰ä¸€ä¸ªç”Ÿæ•ˆã€‚</p><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token comment">&lt;!-- æ˜ å°„å™¨ 1ä½¿ç”¨ç±»è·¯å¾„--></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>mappers</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>mapper</span> <span class="token attr-name">resource</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>org/mybatis/builder/AuthorMapper.xml<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>mapper</span> <span class="token attr-name">resource</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>org/mybatis/builder/BlogMapper.xml<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>mapper</span> <span class="token attr-name">resource</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>org/mybatis/builder/PostMapper.xml<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>mappers</span><span class="token punctuation">></span></span>       <span class="token comment">&lt;!-- 2ä½¿ç”¨ç»å¯¹urlè·¯å¾„--></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>mappers</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>mapper</span> <span class="token attr-name">url</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>file:///var/mappers/AuthorMapper.xml<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>mapper</span> <span class="token attr-name">url</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>file:///var/mappers/BlogMapper.xml<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>mapper</span> <span class="token attr-name">url</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>file:///var/mappers/PostMapper.xml<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>mappers</span><span class="token punctuation">></span></span>      <span class="token comment">&lt;!-- 3ä½¿ç”¨javaç±»å--></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>mappers</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>mapper</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>org.mybatis.builder.AuthorMapper<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>mapper</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>org.mybatis.builder.BlogMapper<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>mapper</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>org.mybatis.builder.PostMapper<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>mappers</span><span class="token punctuation">></span></span><span class="token comment">&lt;!-- 4è‡ªåŠ¨æ‰«æåŒ…ä¸‹æ‰€æœ‰æ˜ å°„å™¨ --></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>mappers</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>package</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>org.mybatis.builder<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>mappers</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è¿™é‡Œå…³æ³¨ä¸¤ä¸ªæ–¹æ³•ï¼š</p><ul><li>mapperParser.parse();</li><li>configuration.addMapper(mapperInterface);</li></ul><p>å®ƒä»¬æœ€ç»ˆçš„ç›®çš„å°±æ˜¯å°†æ˜ å°„å™¨çš„classå¯¹è±¡ï¼Œä»¥åŠå…¶ä»£ç†ç±»è®¾ç½®åˆ°é›†åˆä¸­ï¼Œé‡‡ç”¨çš„æ˜¯JDKä»£ç†ã€‚<br>æˆ‘ä»¬å…ˆçœ‹addMapper()åšäº†äº›å•¥ã€‚</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">//å°†mapperæ¥å£çš„å·¥å‚ç±»æ·»åŠ åˆ°mapperæ³¨å†Œä¸­å¿ƒ</span><span class="token keyword">public</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> <span class="token keyword">void</span> <span class="token function">addMapper</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> type<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>type<span class="token punctuation">.</span><span class="token function">isInterface</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">hasMapper</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BindingException</span><span class="token punctuation">(</span><span class="token string">"Type "</span> <span class="token operator">+</span> type <span class="token operator">+</span> <span class="token string">" is already known to the MapperRegistry."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">&#125;</span>    <span class="token keyword">boolean</span> loadCompleted <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>    <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>  <span class="token comment">//å®ä¾‹åŒ–Mapperæ¥å£çš„ä»£ç†å·¥ç¨‹ç±»ï¼Œå¹¶å°†ä¿¡æ¯æ·»åŠ è‡³knownMappers</span>      knownMappers<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>type<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">MapperProxyFactory</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment">// It's important that the type is added before the parser is run</span>      <span class="token comment">// otherwise the binding may automatically be attempted by the</span>      <span class="token comment">// mapper parser. If the type is already known, it won't try.</span>      <span class="token comment">//è§£ææ¥å£ä¸Šçš„æ³¨è§£ä¿¡æ¯ï¼Œå¹¶æ·»åŠ è‡³configurationå¯¹è±¡</span>      <span class="token class-name">MapperAnnotationBuilder</span> parser <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MapperAnnotationBuilder</span><span class="token punctuation">(</span>config<span class="token punctuation">,</span> type<span class="token punctuation">)</span><span class="token punctuation">;</span>      parser<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      loadCompleted <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span> <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>loadCompleted<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        knownMappers<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è€ŒXMLMapperBuilderçš„parse()æ–¹æ³•ï¼š</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">parse</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token comment">//åˆ¤æ–­æ˜¯å¦å·²ç»åŠ è½½è¯¥é…ç½®æ–‡ä»¶</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>configuration<span class="token punctuation">.</span><span class="token function">isResourceLoaded</span><span class="token punctuation">(</span>resource<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token function">configurationElement</span><span class="token punctuation">(</span>parser<span class="token punctuation">.</span><span class="token function">evalNode</span><span class="token punctuation">(</span><span class="token string">"/mapper"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//å¤„ç†mapperèŠ‚ç‚¹</span>        configuration<span class="token punctuation">.</span><span class="token function">addLoadedResource</span><span class="token punctuation">(</span>resource<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//å°†mapperæ–‡ä»¶æ·»åŠ åˆ°configuration.loadedResourcesä¸­</span>        <span class="token function">bindMapperForNamespace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//æ³¨å†Œmapperæ¥å£</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">//å¤„ç†è§£æå¤±è´¥çš„ResultMapèŠ‚ç‚¹</span>    <span class="token function">parsePendingResultMaps</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//å¤„ç†è§£æå¤±è´¥çš„CacheRefèŠ‚ç‚¹</span>    <span class="token function">parsePendingCacheRefs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//å¤„ç†è§£æå¤±è´¥çš„Sqlè¯­å¥èŠ‚ç‚¹</span>    <span class="token function">parsePendingStatements</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æˆ‘ä»¬åœ¨çœ‹çœ‹MapperAnnotationBuilderçš„parseæ–¹æ³•ï¼Œè¯¥ç±»ä¸»è¦æ˜¯ä»¥æ³¨è§£çš„æ–¹å¼æ„å»ºmapperï¼Œç”¨çš„æ¯”è¾ƒå°‘ã€‚</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/**  * è§£æåŒ…å«æ³¨è§£çš„æ¥å£æ–‡æ¡£  */</span> <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">parse</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>   <span class="token class-name">String</span> resource <span class="token operator">=</span> type<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// é˜²æ­¢é‡å¤åˆ†æ</span>   <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>configuration<span class="token punctuation">.</span><span class="token function">isResourceLoaded</span><span class="token punctuation">(</span>resource<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>     <span class="token comment">// å¯»æ‰¾ç±»åç§°å¯¹åº”çš„ resourceè·¯å¾„ä¸‹æ˜¯å¦æœ‰ xml é…ç½®ï¼Œå¦‚æœæœ‰åˆ™ç›´æ¥è§£ææ‰ï¼Œè¿™æ ·å°±æ”¯æŒæ³¨è§£å’Œxmlä¸€èµ·æ··åˆä½¿ç”¨äº†</span>     <span class="token function">loadXmlResource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">// è®°å½•èµ„æºè·¯å¾„</span>     configuration<span class="token punctuation">.</span><span class="token function">addLoadedResource</span><span class="token punctuation">(</span>resource<span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">// è®¾ç½®å‘½åç©ºé—´</span>     assistant<span class="token punctuation">.</span><span class="token function">setCurrentNamespace</span><span class="token punctuation">(</span>type<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">// å¤„ç†ç¼“å­˜</span>     <span class="token function">parseCache</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token function">parseCacheRef</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token class-name">Method</span><span class="token punctuation">[</span><span class="token punctuation">]</span> methods <span class="token operator">=</span> type<span class="token punctuation">.</span><span class="token function">getMethods</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Method</span> method <span class="token operator">:</span> methods<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>       <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>         <span class="token comment">// æ’é™¤æ¡¥æ¥æ–¹æ³•ï¼Œæ¡¥æ¥æ–¹æ³•æ˜¯ä¸ºäº†åŒ¹é…æ³›å‹çš„ç±»å‹æ“¦é™¤è€Œç”±ç¼–è¯‘å™¨è‡ªåŠ¨å¼•å…¥çš„ï¼Œå¹¶éç”¨æˆ·ç¼–å†™çš„æ–¹æ³•ï¼Œå› æ­¤è¦æ’é™¤æ‰ã€‚</span>         <span class="token comment">// issue #237</span>         <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>method<span class="token punctuation">.</span><span class="token function">isBridge</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>           <span class="token comment">// è§£æè¯¥æ–¹æ³•</span>           <span class="token function">parseStatement</span><span class="token punctuation">(</span>method<span class="token punctuation">)</span><span class="token punctuation">;</span>         <span class="token punctuation">&#125;</span>       <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IncompleteElementException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>         <span class="token comment">// å¼‚å¸¸æ–¹æ³•æš‚å­˜èµ·æ¥</span>         configuration<span class="token punctuation">.</span><span class="token function">addIncompleteMethod</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">MethodResolver</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> method<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token punctuation">&#125;</span>     <span class="token punctuation">&#125;</span>   <span class="token punctuation">&#125;</span>   <span class="token comment">// å¤„ç†å¼‚å¸¸çš„æ–¹æ³•</span>   <span class="token function">parsePendingMethods</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å…³é”®çœ‹çœ‹parseStatement()æ–¹æ³•ï¼Œä¸»è¦å°±æ˜¯è§£ææ³¨è§£ä¸Šçš„ä¿¡æ¯ã€‚å†é€šè¿‡getSqlSourceFromAnnotationsæ–¹æ³•è·å–sqlSource.</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/**  * è§£æè¯¥æ–¹æ³•ï¼Œä¸»è¦æ˜¯è§£ææ–¹æ³•ä¸Šçš„æ³¨è§£ä¿¡æ¯  * @param method  */</span> <span class="token keyword">void</span> <span class="token function">parseStatement</span><span class="token punctuation">(</span><span class="token class-name">Method</span> method<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>   <span class="token comment">// é€šè¿‡å­—æ–¹æ³•è·å–å‚æ•°ç±»å‹</span>   <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span> parameterTypeClass <span class="token operator">=</span> <span class="token function">getParameterType</span><span class="token punctuation">(</span>method<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// è·å–æ–¹æ³•çš„è„šæœ¬è¯­è¨€æ¸ é“</span>   <span class="token class-name">LanguageDriver</span> languageDriver <span class="token operator">=</span> <span class="token function">getLanguageDriver</span><span class="token punctuation">(</span>method<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// é€šè¿‡æ³¨è§£è·å–SqlSource</span>   <span class="token class-name">SqlSource</span> sqlSource <span class="token operator">=</span> <span class="token function">getSqlSourceFromAnnotations</span><span class="token punctuation">(</span>method<span class="token punctuation">,</span> parameterTypeClass<span class="token punctuation">,</span> languageDriver<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token keyword">if</span> <span class="token punctuation">(</span>sqlSource <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>     <span class="token comment">// è·å–æ–¹æ³•ä¸Šå¯èƒ½å­˜åœ¨çš„é…ç½®ä¿¡æ¯ï¼Œé…ç½®ä¿¡æ¯ç”±@Optionsæ³¨è§£æŒ‡å®š</span>     <span class="token class-name">Options</span> options <span class="token operator">=</span> method<span class="token punctuation">.</span><span class="token function">getAnnotation</span><span class="token punctuation">(</span><span class="token class-name">Options</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token keyword">final</span> <span class="token class-name">String</span> mappedStatementId <span class="token operator">=</span> type<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"."</span> <span class="token operator">+</span> method<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token class-name">Integer</span> fetchSize <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>     <span class="token class-name">Integer</span> timeout <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>     <span class="token class-name">StatementType</span> statementType <span class="token operator">=</span> <span class="token class-name">StatementType</span><span class="token punctuation">.</span><span class="token constant">PREPARED</span><span class="token punctuation">;</span>     <span class="token class-name">ResultSetType</span> resultSetType <span class="token operator">=</span> configuration<span class="token punctuation">.</span><span class="token function">getDefaultResultSetType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token class-name">SqlCommandType</span> sqlCommandType <span class="token operator">=</span> <span class="token function">getSqlCommandType</span><span class="token punctuation">(</span>method<span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token keyword">boolean</span> isSelect <span class="token operator">=</span> sqlCommandType <span class="token operator">==</span> <span class="token class-name">SqlCommandType</span><span class="token punctuation">.</span><span class="token constant">SELECT</span><span class="token punctuation">;</span>     <span class="token keyword">boolean</span> flushCache <span class="token operator">=</span> <span class="token operator">!</span>isSelect<span class="token punctuation">;</span>     <span class="token keyword">boolean</span> useCache <span class="token operator">=</span> isSelect<span class="token punctuation">;</span>     <span class="token class-name">KeyGenerator</span> keyGenerator<span class="token punctuation">;</span>     <span class="token class-name">String</span> keyProperty <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>     <span class="token class-name">String</span> keyColumn <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>     <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">SqlCommandType</span><span class="token punctuation">.</span><span class="token constant">INSERT</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>sqlCommandType<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token class-name">SqlCommandType</span><span class="token punctuation">.</span><span class="token constant">UPDATE</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>sqlCommandType<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>       <span class="token comment">// first check for SelectKey annotation - that overrides everything else</span>       <span class="token class-name">SelectKey</span> selectKey <span class="token operator">=</span> method<span class="token punctuation">.</span><span class="token function">getAnnotation</span><span class="token punctuation">(</span><span class="token class-name">SelectKey</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token keyword">if</span> <span class="token punctuation">(</span>selectKey <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>         keyGenerator <span class="token operator">=</span> <span class="token function">handleSelectKeyAnnotation</span><span class="token punctuation">(</span>selectKey<span class="token punctuation">,</span> mappedStatementId<span class="token punctuation">,</span> <span class="token function">getParameterType</span><span class="token punctuation">(</span>method<span class="token punctuation">)</span><span class="token punctuation">,</span> languageDriver<span class="token punctuation">)</span><span class="token punctuation">;</span>         keyProperty <span class="token operator">=</span> selectKey<span class="token punctuation">.</span><span class="token function">keyProperty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>options <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>         keyGenerator <span class="token operator">=</span> configuration<span class="token punctuation">.</span><span class="token function">isUseGeneratedKeys</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token class-name">Jdbc3KeyGenerator</span><span class="token punctuation">.</span><span class="token constant">INSTANCE</span> <span class="token operator">:</span> <span class="token class-name">NoKeyGenerator</span><span class="token punctuation">.</span><span class="token constant">INSTANCE</span><span class="token punctuation">;</span>       <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>         keyGenerator <span class="token operator">=</span> options<span class="token punctuation">.</span><span class="token function">useGeneratedKeys</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token class-name">Jdbc3KeyGenerator</span><span class="token punctuation">.</span><span class="token constant">INSTANCE</span> <span class="token operator">:</span> <span class="token class-name">NoKeyGenerator</span><span class="token punctuation">.</span><span class="token constant">INSTANCE</span><span class="token punctuation">;</span>         keyProperty <span class="token operator">=</span> options<span class="token punctuation">.</span><span class="token function">keyProperty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>         keyColumn <span class="token operator">=</span> options<span class="token punctuation">.</span><span class="token function">keyColumn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token punctuation">&#125;</span>     <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>       keyGenerator <span class="token operator">=</span> <span class="token class-name">NoKeyGenerator</span><span class="token punctuation">.</span><span class="token constant">INSTANCE</span><span class="token punctuation">;</span>     <span class="token punctuation">&#125;</span>     <span class="token keyword">if</span> <span class="token punctuation">(</span>options <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>       <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">FlushCachePolicy</span><span class="token punctuation">.</span><span class="token constant">TRUE</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span><span class="token function">flushCache</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>         flushCache <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>       <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">FlushCachePolicy</span><span class="token punctuation">.</span><span class="token constant">FALSE</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span><span class="token function">flushCache</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>         flushCache <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>       <span class="token punctuation">&#125;</span>       useCache <span class="token operator">=</span> options<span class="token punctuation">.</span><span class="token function">useCache</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>       fetchSize <span class="token operator">=</span> options<span class="token punctuation">.</span><span class="token function">fetchSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">||</span> options<span class="token punctuation">.</span><span class="token function">fetchSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token constant">MIN_VALUE</span> <span class="token operator">?</span> options<span class="token punctuation">.</span><span class="token function">fetchSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">;</span> <span class="token comment">//issue #348</span>       timeout <span class="token operator">=</span> options<span class="token punctuation">.</span><span class="token function">timeout</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">?</span> options<span class="token punctuation">.</span><span class="token function">timeout</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">;</span>       statementType <span class="token operator">=</span> options<span class="token punctuation">.</span><span class="token function">statementType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span><span class="token function">resultSetType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token class-name">ResultSetType</span><span class="token punctuation">.</span><span class="token constant">DEFAULT</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>         resultSetType <span class="token operator">=</span> options<span class="token punctuation">.</span><span class="token function">resultSetType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token punctuation">&#125;</span>     <span class="token punctuation">&#125;</span>     <span class="token class-name">String</span> resultMapId <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>     <span class="token class-name">ResultMap</span> resultMapAnnotation <span class="token operator">=</span> method<span class="token punctuation">.</span><span class="token function">getAnnotation</span><span class="token punctuation">(</span><span class="token class-name">ResultMap</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token keyword">if</span> <span class="token punctuation">(</span>resultMapAnnotation <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>       resultMapId <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">","</span><span class="token punctuation">,</span> resultMapAnnotation<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>isSelect<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>       resultMapId <span class="token operator">=</span> <span class="token function">parseResultMap</span><span class="token punctuation">(</span>method<span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token punctuation">&#125;</span>     <span class="token comment">// å°†è·å–åˆ°çš„ä¿¡æ¯å­˜å…¥ configuration</span>     assistant<span class="token punctuation">.</span><span class="token function">addMappedStatement</span><span class="token punctuation">(</span>         mappedStatementId<span class="token punctuation">,</span>         sqlSource<span class="token punctuation">,</span>         statementType<span class="token punctuation">,</span>         sqlCommandType<span class="token punctuation">,</span>         fetchSize<span class="token punctuation">,</span>         timeout<span class="token punctuation">,</span>         <span class="token comment">// ParameterMapID</span>         <span class="token keyword">null</span><span class="token punctuation">,</span>         parameterTypeClass<span class="token punctuation">,</span>         resultMapId<span class="token punctuation">,</span>         <span class="token function">getReturnType</span><span class="token punctuation">(</span>method<span class="token punctuation">)</span><span class="token punctuation">,</span>         resultSetType<span class="token punctuation">,</span>         flushCache<span class="token punctuation">,</span>         useCache<span class="token punctuation">,</span>         <span class="token comment">// TODO gcode issue #577</span>         <span class="token boolean">false</span><span class="token punctuation">,</span>         keyGenerator<span class="token punctuation">,</span>         keyProperty<span class="token punctuation">,</span>         keyColumn<span class="token punctuation">,</span>         <span class="token comment">// DatabaseID</span>         <span class="token keyword">null</span><span class="token punctuation">,</span>         languageDriver<span class="token punctuation">,</span>         <span class="token comment">// ResultSets</span>         options <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token function">nullOrEmpty</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span><span class="token function">resultSets</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token punctuation">&#125;</span> <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>getSqlSourceFromAnnotations()æ–¹æ³•ã€‚</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/**  * é€šè¿‡æ³¨è§£è·å–SqlSourceå¯¹è±¡  *   * @param method å«æœ‰æ³¨è§£çš„æ–¹æ³•  * @param parameterType å‚æ•°ç±»å‹  * @param languageDriver è¯­è¨€æ¸ é“  * @return SqlSourceå¯¹è±¡  */</span> <span class="token keyword">private</span> <span class="token class-name">SqlSource</span> <span class="token function">getSqlSourceFromAnnotations</span><span class="token punctuation">(</span><span class="token class-name">Method</span> method<span class="token punctuation">,</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span> parameterType<span class="token punctuation">,</span> <span class="token class-name">LanguageDriver</span> languageDriver<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>   <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>     <span class="token comment">// éå†å¯»æ‰¾æ˜¯å¦æœ‰ Selectã€Insertã€Updateã€Deleteå››ä¸ªæ³¨è§£ä¹‹ä¸€</span>     <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">Annotation</span><span class="token punctuation">></span></span> sqlAnnotationType <span class="token operator">=</span> <span class="token function">getSqlAnnotationType</span><span class="token punctuation">(</span>method<span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">// éå†å¯»æ‰¾æ˜¯å¦æœ‰ SelectProviderã€InsertProviderã€UpdateProviderã€DeleteProvider å››ä¸ªæ³¨è§£ä¹‹ä¸€</span>     <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">Annotation</span><span class="token punctuation">></span></span> sqlProviderAnnotationType <span class="token operator">=</span> <span class="token function">getSqlProviderAnnotationType</span><span class="token punctuation">(</span>method<span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token keyword">if</span> <span class="token punctuation">(</span>sqlAnnotationType <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>       <span class="token keyword">if</span> <span class="token punctuation">(</span>sqlProviderAnnotationType <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>         <span class="token comment">// ä¸¤ç±»æ³¨è§£ä¸èƒ½åŒæ—¶ä½¿ç”¨</span>         <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BindingException</span><span class="token punctuation">(</span><span class="token string">"You cannot supply both a static SQL and SqlProvider to method named "</span> <span class="token operator">+</span> method<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token punctuation">&#125;</span>       <span class="token comment">// å–å‡ºSelectã€Insertã€Updateã€Deleteå››ä¸ªæ³¨è§£ä¹‹ä¸€</span>       <span class="token class-name">Annotation</span> sqlAnnotation <span class="token operator">=</span> method<span class="token punctuation">.</span><span class="token function">getAnnotation</span><span class="token punctuation">(</span>sqlAnnotationType<span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token comment">// å–å‡ºvalueå€¼</span>       <span class="token keyword">final</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> strings <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> sqlAnnotation<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token string">"value"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span>sqlAnnotation<span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token comment">// åŸºäºå­—ç¬¦ä¸²æ„å»ºSqlSourceï¼Œç›´æ¥æ³¨è§£è·å–SQL</span>       <span class="token keyword">return</span> <span class="token function">buildSqlSourceFromStrings</span><span class="token punctuation">(</span>strings<span class="token punctuation">,</span> parameterType<span class="token punctuation">,</span> languageDriver<span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>sqlProviderAnnotationType <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>       <span class="token comment">// // å–å‡º SelectProviderã€InsertProviderã€UpdateProviderã€DeleteProvider å››ä¸ªæ³¨è§£ä¹‹ä¸€</span>       <span class="token class-name">Annotation</span> sqlProviderAnnotation <span class="token operator">=</span> method<span class="token punctuation">.</span><span class="token function">getAnnotation</span><span class="token punctuation">(</span>sqlProviderAnnotationType<span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token comment">// æ ¹æ®å¯¹åº”çš„æ–¹æ³•è·å–SqlSourceï¼Œé—´æ¥æ³¨è§£è·å–SQL</span>       <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ProviderSqlSource</span><span class="token punctuation">(</span>assistant<span class="token punctuation">.</span><span class="token function">getConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> sqlProviderAnnotation<span class="token punctuation">,</span> type<span class="token punctuation">,</span> method<span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token punctuation">&#125;</span>     <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>   <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>     <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BuilderException</span><span class="token punctuation">(</span><span class="token string">"Could not find value method on SQL annotation.  Cause: "</span> <span class="token operator">+</span> e<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token punctuation">&#125;</span> <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æ€»ç»“ä¸‹è§£æmapperçš„parse()æ–¹æ³•æœ‰ä¸¤ç§æ–¹å¼ï¼š</p><ul><li>XMLMapperBuilderçš„parseæ–¹æ³•</li><li>MapperAnnotationBuilderçš„parseæ–¹æ³•</li></ul><p>MapperAnnotationBuilderçš„parseæ–¹æ³•ä¸XMLMapperBuilderçš„parseæ–¹æ³•é€»è¾‘ä¸Šç•¥æœ‰ä¸åŒï¼Œä¸»è¦ä½“ç°åœ¨å¯¹èŠ‚ç‚¹çš„è§£æä¸Šã€‚</p><p>ä¸Šé¢åªæ˜¯å¤§è‡´åˆ†æäº†*mapper.javaä¸*mapper.xmlæ˜ å°„æ³¨å†Œçš„è¿‡ç¨‹ï¼Œç”±äºæˆ‘ä»¬çš„*mapper.xmlè¿˜æœ‰å¾ˆå¤šå…¶ä»–çš„xmlæ ‡ç­¾ï¼Œè¿™é‡Œæˆ‘ä»¬éœ€è¦å…·ä½“äº†è§£ä¸‹å…¶ä¸­çš„è§£ææµç¨‹ã€‚è¿˜æ˜¯å›åˆ°XMLMapperBuilderçš„parse()æ–¹æ³•ã€‚<br>æˆ‘ä»¬çœ‹çœ‹configurationElement()æ–¹æ³•å¹²äº†äº›å•¥ã€‚</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/**  * è§£ææ˜ å°„æ–‡ä»¶çš„ä¸‹å±‚èŠ‚ç‚¹  * @param context æ˜ å°„æ–‡ä»¶æ ¹èŠ‚ç‚¹  */</span> <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">configurationElement</span><span class="token punctuation">(</span><span class="token class-name">XNode</span> context<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>   <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>    <span class="token comment">//è·å–mapperèŠ‚ç‚¹çš„namespaceå±æ€§</span>     <span class="token class-name">String</span> namespace <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">getStringAttribute</span><span class="token punctuation">(</span><span class="token string">"namespace"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token keyword">if</span> <span class="token punctuation">(</span>namespace <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> namespace<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>         <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BuilderException</span><span class="token punctuation">(</span><span class="token string">"Mapper's namespace cannot be empty"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token punctuation">&#125;</span>     <span class="token comment">//è®¾ç½®builderAssistantçš„namespaceå±æ€§</span>     builderAssistant<span class="token punctuation">.</span><span class="token function">setCurrentNamespace</span><span class="token punctuation">(</span>namespace<span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">//è§£æcache-refèŠ‚ç‚¹</span>     <span class="token function">cacheRefElement</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">evalNode</span><span class="token punctuation">(</span><span class="token string">"cache-ref"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">//é‡ç‚¹åˆ†æ ï¼šè§£æcacheèŠ‚ç‚¹----------------1-------------------äºŒçº§ç¼“å­˜</span>     <span class="token function">cacheElement</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">evalNode</span><span class="token punctuation">(</span><span class="token string">"cache"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">//è§£æparameterMapèŠ‚ç‚¹ï¼ˆå·²åºŸå¼ƒï¼‰</span>     <span class="token function">parameterMapElement</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">evalNodes</span><span class="token punctuation">(</span><span class="token string">"/mapper/parameterMap"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">//é‡ç‚¹åˆ†æ ï¼šè§£æresultMapèŠ‚ç‚¹ï¼ˆåŸºäºæ•°æ®ç»“æœå»ç†è§£ï¼‰----------------2-------------------</span>     <span class="token function">resultMapElements</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">evalNodes</span><span class="token punctuation">(</span><span class="token string">"/mapper/resultMap"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">//è§£æsqlèŠ‚ç‚¹</span>     <span class="token function">sqlElement</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">evalNodes</span><span class="token punctuation">(</span><span class="token string">"/mapper/sql"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">//é‡ç‚¹åˆ†æ ï¼šè§£æselectã€insertã€updateã€deleteèŠ‚ç‚¹ ----------------3-------------------sqlè§£æ</span>     <span class="token function">buildStatementFromContext</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">evalNodes</span><span class="token punctuation">(</span><span class="token string">"select|insert|update|delete"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>     <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BuilderException</span><span class="token punctuation">(</span><span class="token string">"Error parsing Mapper XML. The XML location is '"</span> <span class="token operator">+</span> resource <span class="token operator">+</span> <span class="token string">"'. Cause: "</span> <span class="token operator">+</span> e<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token punctuation">&#125;</span> <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>é‡ç‚¹å…³æ³¨è¿™å‡ ä¸ªæ–¹æ³•ï¼š</p><ul><li>cacheElementï¼šè§£æ&lt;cache&gt;ï¼Œä¸äºŒçº§ç¼“å­˜æœ‰å…³.</li><li>resultMapElementsï¼šè§£æ&lt;resultMap&gt;ï¼Œç»“æœé›†æ˜ å°„.</li><li>sqlElementï¼šè§£æsqlèŠ‚ç‚¹&lt;sql&gt;.</li><li>buildStatementFromContextï¼šè§£æ&lt;select&gt;ã€&lt;insert&gt;ã€&lt;update&gt;ã€&lt;delete&gt;èŠ‚ç‚¹.</li></ul><p>è€Œå½“å‰æˆ‘ä»¬çš„UserInfoMapperå¦‚ä¸‹ï¼š<br><img src="https://cdn.jsdelivr.net/gh/zyxelva/picgo@main/csdn/20210316160708894.png"><br>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å…³æ³¨buildStatementFromContextè§£æ&lt;select&gt;ã€&lt;insert&gt;ã€&lt;update&gt;ã€&lt;delete&gt;æ ‡ç­¾çš„è¿‡ç¨‹ã€‚ä¸»è¦å°±æ˜¯çœ‹çœ‹XMLStatementBuilderæ˜¯æ€ä¹ˆå¹²æ´»å„¿çš„ã€‚</p><h1 id="ä¸‰ã€XMLStatementBuilder"><a href="#ä¸‰ã€XMLStatementBuilder" class="headerlink" title="ä¸‰ã€XMLStatementBuilder"></a>ä¸‰ã€XMLStatementBuilder</h1><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">//è§£æselectã€insertã€updateã€deleteèŠ‚ç‚¹</span><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">buildStatementFromContext</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">XNode</span><span class="token punctuation">></span></span> list<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>configuration<span class="token punctuation">.</span><span class="token function">getDatabaseId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token function">buildStatementFromContext</span><span class="token punctuation">(</span>list<span class="token punctuation">,</span> configuration<span class="token punctuation">.</span><span class="token function">getDatabaseId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token function">buildStatementFromContext</span><span class="token punctuation">(</span>list<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">//å¤„ç†æ‰€æœ‰çš„sqlè¯­å¥èŠ‚ç‚¹å¹¶æ³¨å†Œè‡³configurationå¯¹è±¡</span><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">buildStatementFromContext</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">XNode</span><span class="token punctuation">></span></span> list<span class="token punctuation">,</span> <span class="token class-name">String</span> requiredDatabaseId<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">XNode</span> context <span class="token operator">:</span> list<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token comment">//åˆ›å»ºXMLStatementBuilder ä¸“é—¨ç”¨äºè§£æsqlè¯­å¥èŠ‚ç‚¹</span>        <span class="token keyword">final</span> <span class="token class-name">XMLStatementBuilder</span> statementParser <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">XMLStatementBuilder</span><span class="token punctuation">(</span>configuration<span class="token punctuation">,</span> builderAssistant<span class="token punctuation">,</span> context<span class="token punctuation">,</span> requiredDatabaseId<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>            <span class="token comment">//è§£æsqlè¯­å¥èŠ‚ç‚¹ï¼Œå¹¶å°†è§£æç»“æœå­˜å‚¨åˆ° configuration çš„ mappedStatements é›†åˆä¸­</span>            statementParser<span class="token punctuation">.</span><span class="token function">parseStatementNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IncompleteElementException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            configuration<span class="token punctuation">.</span><span class="token function">addIncompleteStatement</span><span class="token punctuation">(</span>statementParser<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ç‚¹è¿›å»çœ‹çœ‹parseStatementNode()æ–¹æ³•ã€‚</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">parseStatementNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token comment">//è·å–sqlèŠ‚ç‚¹çš„id</span>    <span class="token class-name">String</span> id <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">getStringAttribute</span><span class="token punctuation">(</span><span class="token string">"id"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">String</span> databaseId <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">getStringAttribute</span><span class="token punctuation">(</span><span class="token string">"databaseId"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">databaseIdMatchesCurrent</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> databaseId<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>requiredDatabaseId<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">return</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">/*è·å–sqlèŠ‚ç‚¹çš„å„ç§å±æ€§*/</span>    <span class="token class-name">Integer</span> fetchSize <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">getIntAttribute</span><span class="token punctuation">(</span><span class="token string">"fetchSize"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">Integer</span> timeout <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">getIntAttribute</span><span class="token punctuation">(</span><span class="token string">"timeout"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">String</span> parameterMap <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">getStringAttribute</span><span class="token punctuation">(</span><span class="token string">"parameterMap"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">String</span> parameterType <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">getStringAttribute</span><span class="token punctuation">(</span><span class="token string">"parameterType"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span> parameterTypeClass <span class="token operator">=</span> <span class="token function">resolveClass</span><span class="token punctuation">(</span>parameterType<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">String</span> resultMap <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">getStringAttribute</span><span class="token punctuation">(</span><span class="token string">"resultMap"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">String</span> resultType <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">getStringAttribute</span><span class="token punctuation">(</span><span class="token string">"resultType"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">String</span> lang <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">getStringAttribute</span><span class="token punctuation">(</span><span class="token string">"lang"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">LanguageDriver</span> langDriver <span class="token operator">=</span> <span class="token function">getLanguageDriver</span><span class="token punctuation">(</span>lang<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span> resultTypeClass <span class="token operator">=</span> <span class="token function">resolveClass</span><span class="token punctuation">(</span>resultType<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">String</span> resultSetType <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">getStringAttribute</span><span class="token punctuation">(</span><span class="token string">"resultSetType"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">StatementType</span> statementType <span class="token operator">=</span> <span class="token class-name">StatementType</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">getStringAttribute</span><span class="token punctuation">(</span><span class="token string">"statementType"</span><span class="token punctuation">,</span> <span class="token class-name">StatementType</span><span class="token punctuation">.</span><span class="token constant">PREPARED</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">ResultSetType</span> resultSetTypeEnum <span class="token operator">=</span> <span class="token function">resolveResultSetType</span><span class="token punctuation">(</span>resultSetType<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//æ ¹æ®sqlèŠ‚ç‚¹çš„åç§°è·å–SqlCommandTypeï¼ˆINSERT, UPDATE, DELETE, SELECTï¼‰</span>    <span class="token class-name">String</span> nodeName <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">getNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getNodeName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">SqlCommandType</span> sqlCommandType <span class="token operator">=</span> <span class="token class-name">SqlCommandType</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>nodeName<span class="token punctuation">.</span><span class="token function">toUpperCase</span><span class="token punctuation">(</span><span class="token class-name">Locale</span><span class="token punctuation">.</span><span class="token constant">ENGLISH</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">boolean</span> isSelect <span class="token operator">=</span> sqlCommandType <span class="token operator">==</span> <span class="token class-name">SqlCommandType</span><span class="token punctuation">.</span><span class="token constant">SELECT</span><span class="token punctuation">;</span>    <span class="token keyword">boolean</span> flushCache <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">getBooleanAttribute</span><span class="token punctuation">(</span><span class="token string">"flushCache"</span><span class="token punctuation">,</span> <span class="token operator">!</span>isSelect<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">boolean</span> useCache <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">getBooleanAttribute</span><span class="token punctuation">(</span><span class="token string">"useCache"</span><span class="token punctuation">,</span> isSelect<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">boolean</span> resultOrdered <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">getBooleanAttribute</span><span class="token punctuation">(</span><span class="token string">"resultOrdered"</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// Include Fragments before parsing</span>    <span class="token comment">//åœ¨è§£æsqlè¯­å¥ä¹‹å‰å…ˆè§£æ&lt;include>èŠ‚ç‚¹(æŸ¥è¯¢çš„ç»“æœæœ‰å“ªäº›å‚æ•°)</span>    <span class="token class-name">XMLIncludeTransformer</span> includeParser <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">XMLIncludeTransformer</span><span class="token punctuation">(</span>configuration<span class="token punctuation">,</span> builderAssistant<span class="token punctuation">)</span><span class="token punctuation">;</span>    includeParser<span class="token punctuation">.</span><span class="token function">applyIncludes</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">getNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// Parse selectKey after includes and remove them.</span>    <span class="token comment">//åœ¨è§£æsqlè¯­å¥ä¹‹å‰ï¼Œå¤„ç†&lt;selectKey>å­èŠ‚ç‚¹ï¼Œå¹¶åœ¨xmlèŠ‚ç‚¹ä¸­åˆ é™¤</span>    <span class="token function">processSelectKeyNodes</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> parameterTypeClass<span class="token punctuation">,</span> langDriver<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// Parse the SQL (pre: &lt;selectKey> and &lt;include> were parsed and removed)</span>    <span class="token comment">//è§£æsqlè¯­å¥æ˜¯è§£æmapper.xmlçš„æ ¸å¿ƒï¼Œå®ä¾‹åŒ–sqlSourceï¼Œä½¿ç”¨sqlSourceå°è£…sqlè¯­å¥</span>    <span class="token class-name">SqlSource</span> sqlSource <span class="token operator">=</span> langDriver<span class="token punctuation">.</span><span class="token function">createSqlSource</span><span class="token punctuation">(</span>configuration<span class="token punctuation">,</span> context<span class="token punctuation">,</span> parameterTypeClass<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//è·å–resultSetså±æ€§</span>    <span class="token class-name">String</span> resultSets <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">getStringAttribute</span><span class="token punctuation">(</span><span class="token string">"resultSets"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//è·å–ä¸»é”®ä¿¡æ¯keyProperty</span>    <span class="token class-name">String</span> keyProperty <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">getStringAttribute</span><span class="token punctuation">(</span><span class="token string">"keyProperty"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//è·å–ä¸»é”®ä¿¡æ¯keyColumn</span>    <span class="token class-name">String</span> keyColumn <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">getStringAttribute</span><span class="token punctuation">(</span><span class="token string">"keyColumn"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//æ ¹æ®&lt;selectKey>è·å–å¯¹åº”çš„SelectKeyGeneratorçš„id</span>    <span class="token class-name">KeyGenerator</span> keyGenerator<span class="token punctuation">;</span>    <span class="token class-name">String</span> keyStatementId <span class="token operator">=</span> id <span class="token operator">+</span> <span class="token class-name">SelectKeyGenerator</span><span class="token punctuation">.</span><span class="token constant">SELECT_KEY_SUFFIX</span><span class="token punctuation">;</span>    keyStatementId <span class="token operator">=</span> builderAssistant<span class="token punctuation">.</span><span class="token function">applyCurrentNamespace</span><span class="token punctuation">(</span>keyStatementId<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//è·å–keyGeneratorå¯¹è±¡ï¼Œå¦‚æœæ˜¯insertç±»å‹çš„sqlè¯­å¥ï¼Œä¼šä½¿ç”¨KeyGeneratoræ¥å£è·å–æ•°æ®åº“ç”Ÿäº§çš„idï¼›</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>configuration<span class="token punctuation">.</span><span class="token function">hasKeyGenerator</span><span class="token punctuation">(</span>keyStatementId<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        keyGenerator <span class="token operator">=</span> configuration<span class="token punctuation">.</span><span class="token function">getKeyGenerator</span><span class="token punctuation">(</span>keyStatementId<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>        keyGenerator <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">getBooleanAttribute</span><span class="token punctuation">(</span><span class="token string">"useGeneratedKeys"</span><span class="token punctuation">,</span>                configuration<span class="token punctuation">.</span><span class="token function">isUseGeneratedKeys</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token class-name">SqlCommandType</span><span class="token punctuation">.</span><span class="token constant">INSERT</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>sqlCommandType<span class="token punctuation">)</span><span class="token punctuation">)</span>                <span class="token operator">?</span> <span class="token class-name">Jdbc3KeyGenerator</span><span class="token punctuation">.</span><span class="token constant">INSTANCE</span> <span class="token operator">:</span> <span class="token class-name">NoKeyGenerator</span><span class="token punctuation">.</span><span class="token constant">INSTANCE</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">//é€šè¿‡builderAssistantå®ä¾‹åŒ–MappedStatementï¼Œå¹¶æ³¨å†Œè‡³configurationå¯¹è±¡</span>    builderAssistant<span class="token punctuation">.</span><span class="token function">addMappedStatement</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> sqlSource<span class="token punctuation">,</span> statementType<span class="token punctuation">,</span> sqlCommandType<span class="token punctuation">,</span>            fetchSize<span class="token punctuation">,</span> timeout<span class="token punctuation">,</span> parameterMap<span class="token punctuation">,</span> parameterTypeClass<span class="token punctuation">,</span> resultMap<span class="token punctuation">,</span> resultTypeClass<span class="token punctuation">,</span>            resultSetTypeEnum<span class="token punctuation">,</span> flushCache<span class="token punctuation">,</span> useCache<span class="token punctuation">,</span> resultOrdered<span class="token punctuation">,</span>            keyGenerator<span class="token punctuation">,</span> keyProperty<span class="token punctuation">,</span> keyColumn<span class="token punctuation">,</span> databaseId<span class="token punctuation">,</span> langDriver<span class="token punctuation">,</span> resultSets<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æ€»ç»“ä¸‹å®ƒå¹²äº†å“ªäº›æ´»å„¿ï¼š</p><ul><li>è§£æ &lt;include&gt; èŠ‚ç‚¹</li><li>è§£æ &lt;selectKey&gt; èŠ‚ç‚¹</li><li>è§£æ SQLï¼Œè·å– SqlSource</li><li>æ„å»º MappedStatement å®ä¾‹</li></ul><p>è§£æ&lt;select&gt;ã€&lt;insert&gt;ã€&lt;update&gt;ã€&lt;delete&gt;è¿™äº›æ ‡ç­¾çš„å…³é”®æ–¹æ³•åœ¨è¿™é‡Œ</p><pre class="line-numbers language-none"><code class="language-none">SqlSource sqlSource &#x3D; langDriver.createSqlSource(configuration, context, parameterTypeClass);<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>çœ‹çœ‹è¿™ä¸ªæ–¹æ³•çš„ä¸€èˆ¬å®ç°ç±»XMLScriptBuilder.</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Override</span><span class="token comment">//è§£æxmlæ–‡ä»¶ä¸­çš„sqlè¯­å¥å¹¶å°è£…æˆSqlSource</span><span class="token keyword">public</span> <span class="token class-name">SqlSource</span> <span class="token function">createSqlSource</span><span class="token punctuation">(</span><span class="token class-name">Configuration</span> configuration<span class="token punctuation">,</span> <span class="token class-name">XNode</span> script<span class="token punctuation">,</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span> parameterType<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token class-name">XMLScriptBuilder</span> builder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">XMLScriptBuilder</span><span class="token punctuation">(</span>configuration<span class="token punctuation">,</span> script<span class="token punctuation">,</span> parameterType<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> builder<span class="token punctuation">.</span><span class="token function">parseScriptNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">//è§£æsqlè„šæœ¬ï¼Œè¿”å›SqlSource</span><span class="token keyword">public</span> <span class="token class-name">SqlSource</span> <span class="token function">parseScriptNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token class-name">MixedSqlNode</span> rootSqlNode <span class="token operator">=</span> <span class="token function">parseDynamicTags</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token class-name">SqlSource</span> sqlSource <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>isDynamic<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    sqlSource <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DynamicSqlSource</span><span class="token punctuation">(</span>configuration<span class="token punctuation">,</span> rootSqlNode<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//åŠ¨æ€sqlçš„è§£æ</span>  <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>    sqlSource <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RawSqlSource</span><span class="token punctuation">(</span>configuration<span class="token punctuation">,</span> rootSqlNode<span class="token punctuation">,</span> parameterType<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//éåŠ¨æ€sqlçš„è§£æ</span>  <span class="token punctuation">&#125;</span>  <span class="token comment">//å®é™…è¿”å›çš„éƒ½æ˜¯StaticSqlSourceï¼Œå¯ä»¥ç›´æ¥è®©æ•°æ®åº“æ‰§è¡Œçš„sqlè¯­å¥ï¼ŒåŒ…å«?å ä½ç¬¦</span>  <span class="token keyword">return</span> sqlSource<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æ–¹æ³•parseDynamicTags()å°±æ˜¯çœŸæ­£å»è§£æsqlè¯­å¥çš„æ·«å„¿äº†ã€‚å½“æ‰§è¡ŒcreateSqlSource()æ–¹æ³•ä¸­çš„new XMLScriptBuilder(configuration, script, parameterType)æ—¶ï¼Œæˆ‘ä»¬çœ‹ä¸‹ï¼Œå®ƒåˆå§‹åŒ–äº†äº›ä»€ä¹ˆä¸œä¸œã€‚<br><img src="https://cdn.jsdelivr.net/gh/zyxelva/picgo@main/csdn/20210316174946741.png"><br>å¯ä»¥çœ‹åˆ°å…³é”®çš„éƒ¨åˆ†ï¼Œå¯¹äºä¸åŒçš„æ ‡ç­¾ï¼Œæ¯”å¦‚&lt;trim&gt;ã€&lt;where&gt;ç­‰ï¼Œéƒ½æœ‰ä¸åŒçš„å¤„ç†ç­–ç•¥ã€‚åœ¨æ‰§è¡ŒparseDynamicTags()æ—¶ï¼Œä¼šåˆ¤æ–­èŠ‚ç‚¹æ˜¯å¦åŒ…å«ä¸€äº›åŠ¨æ€æ ‡è®°ï¼Œæ¯”å¦‚ ${} å ä½ç¬¦ä»¥åŠåŠ¨æ€ SQL èŠ‚ç‚¹ç­‰ã€‚è‹¥åŒ…å«åŠ¨æ€æ ‡è®°ï¼Œåˆ™ä¼šå°† isDynamic è®¾ä¸º trueã€‚åç»­å¯æ ¹æ® isDynamic åˆ›å»ºä¸åŒçš„ SqlSourceã€‚<br><img src="https://cdn.jsdelivr.net/gh/zyxelva/picgo@main/csdn/20210315210703601.png"></p><p>é€šå¸¸ï¼Œæˆ‘ä»¬åœ¨xmlå†…å†™sqléƒ½æ˜¯ç‰‡æ®µçš„å»ç¼–å†™ï¼Œä¸»è¦è¯­å¥å†™å®Œäº†ï¼Œè¿˜ä¼šæœ‰äº›åŠ¨æ€æ ‡ç­¾åŒ…è£¹çš„è¯­å¥ï¼Œå¯¹äºmybatisæ¥è¯´ï¼Œæ¯ä¸ªç‰‡æ®µéƒ½ä¼šè§£ææˆä¸ºä¸€ä¸ªsqlNodeå­˜èµ·æ¥ï¼Œæˆ‘ä»¬å…ˆæ¥å›å¿†ä¸€ä¸‹sqlNodeæœ‰å“ªäº›å®ç°ç±»ã€‚<br><img src="https://cdn.jsdelivr.net/gh/zyxelva/picgo@main/csdn/20210315210642589.png"><br>è¿™äº› SqlNode æ˜¯å¦‚ä½•ç”Ÿæˆçš„å‘¢ï¼Ÿæˆ‘ä»¬çœ‹çœ‹parseDynamicTags()ä¸­çš„è¿™æ®µä»£ç ï¼š</p><pre class="line-numbers language-java" data-language="java"><code class="language-java">handler<span class="token punctuation">.</span><span class="token function">handleNode</span><span class="token punctuation">(</span>child<span class="token punctuation">,</span> contents<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>å®ƒæœ‰å¾ˆå¤šä¸ªå®ç°ã€‚<br><img src="https://cdn.jsdelivr.net/gh/zyxelva/picgo@main/csdn/20210316180045568.png"><br>åˆ°æ­¤ SQL è¯­å¥çš„è§£æè¿‡ç¨‹æå®Œäº†ã€‚ä½†æˆ‘ä»¬åªæ˜¯å®Œæˆäº†xmlè§£æä¸ºsqlSourceçš„æµç¨‹ï¼Œè€Œä¸€èˆ¬sqlè¯­å¥è¿˜ä¼šæœ‰ä¸€äº›é™„åŠ å±æ€§ï¼Œéœ€è¦mybatiså»è§£æå‡ºæ¥ï¼Œå°è£…è‡³MappedStatementå½“ä¸­ï¼Œæœ€ç»ˆè¿˜è¦æŠŠå®ƒæ³¨å†Œåˆ°configurationã€‚å›åˆ°XMLStatementBuilderçš„parseStatementNode()æ–¹æ³•ã€‚<br><img src="https://cdn.jsdelivr.net/gh/zyxelva/picgo@main/csdn/2021031618090324.png"><br>å…·ä½“æ–¹æ³•å®ç°ï¼š</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">//æ·»åŠ MappedStatementå¯¹è±¡</span><span class="token keyword">public</span> <span class="token class-name">MappedStatement</span> <span class="token function">addMappedStatement</span><span class="token punctuation">(</span>    <span class="token class-name">String</span> id<span class="token punctuation">,</span>    <span class="token class-name">SqlSource</span> sqlSource<span class="token punctuation">,</span>    <span class="token class-name">StatementType</span> statementType<span class="token punctuation">,</span>    <span class="token class-name">SqlCommandType</span> sqlCommandType<span class="token punctuation">,</span>    <span class="token class-name">Integer</span> fetchSize<span class="token punctuation">,</span>    <span class="token class-name">Integer</span> timeout<span class="token punctuation">,</span>    <span class="token class-name">String</span> parameterMap<span class="token punctuation">,</span>    <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span> parameterType<span class="token punctuation">,</span>    <span class="token class-name">String</span> resultMap<span class="token punctuation">,</span>    <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span> resultType<span class="token punctuation">,</span>    <span class="token class-name">ResultSetType</span> resultSetType<span class="token punctuation">,</span>    <span class="token keyword">boolean</span> flushCache<span class="token punctuation">,</span>    <span class="token keyword">boolean</span> useCache<span class="token punctuation">,</span>    <span class="token keyword">boolean</span> resultOrdered<span class="token punctuation">,</span>    <span class="token class-name">KeyGenerator</span> keyGenerator<span class="token punctuation">,</span>    <span class="token class-name">String</span> keyProperty<span class="token punctuation">,</span>    <span class="token class-name">String</span> keyColumn<span class="token punctuation">,</span>    <span class="token class-name">String</span> databaseId<span class="token punctuation">,</span>    <span class="token class-name">LanguageDriver</span> lang<span class="token punctuation">,</span>    <span class="token class-name">String</span> resultSets<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>unresolvedCacheRef<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IncompleteElementException</span><span class="token punctuation">(</span><span class="token string">"Cache-ref not yet resolved"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>  id <span class="token operator">=</span> <span class="token function">applyCurrentNamespace</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">boolean</span> isSelect <span class="token operator">=</span> sqlCommandType <span class="token operator">==</span> <span class="token class-name">SqlCommandType</span><span class="token punctuation">.</span><span class="token constant">SELECT</span><span class="token punctuation">;</span>  <span class="token comment">//ä½¿ç”¨å»ºé€ è€…æ¨¡å¼åˆ›å»ºä¸€ä¸ªmappedStatment</span>  <span class="token class-name">MappedStatement<span class="token punctuation">.</span>Builder</span> statementBuilder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MappedStatement<span class="token punctuation">.</span>Builder</span><span class="token punctuation">(</span>configuration<span class="token punctuation">,</span> id<span class="token punctuation">,</span> sqlSource<span class="token punctuation">,</span> sqlCommandType<span class="token punctuation">)</span>      <span class="token punctuation">.</span><span class="token function">resource</span><span class="token punctuation">(</span>resource<span class="token punctuation">)</span>      <span class="token punctuation">.</span><span class="token function">fetchSize</span><span class="token punctuation">(</span>fetchSize<span class="token punctuation">)</span>      <span class="token punctuation">.</span><span class="token function">timeout</span><span class="token punctuation">(</span>timeout<span class="token punctuation">)</span>      <span class="token punctuation">.</span><span class="token function">statementType</span><span class="token punctuation">(</span>statementType<span class="token punctuation">)</span>      <span class="token punctuation">.</span><span class="token function">keyGenerator</span><span class="token punctuation">(</span>keyGenerator<span class="token punctuation">)</span>      <span class="token punctuation">.</span><span class="token function">keyProperty</span><span class="token punctuation">(</span>keyProperty<span class="token punctuation">)</span>      <span class="token punctuation">.</span><span class="token function">keyColumn</span><span class="token punctuation">(</span>keyColumn<span class="token punctuation">)</span>      <span class="token punctuation">.</span><span class="token function">databaseId</span><span class="token punctuation">(</span>databaseId<span class="token punctuation">)</span>      <span class="token punctuation">.</span><span class="token function">lang</span><span class="token punctuation">(</span>lang<span class="token punctuation">)</span>      <span class="token punctuation">.</span><span class="token function">resultOrdered</span><span class="token punctuation">(</span>resultOrdered<span class="token punctuation">)</span>      <span class="token punctuation">.</span><span class="token function">resultSets</span><span class="token punctuation">(</span>resultSets<span class="token punctuation">)</span>      <span class="token punctuation">.</span><span class="token function">resultMaps</span><span class="token punctuation">(</span><span class="token function">getStatementResultMaps</span><span class="token punctuation">(</span>resultMap<span class="token punctuation">,</span> resultType<span class="token punctuation">,</span> id<span class="token punctuation">)</span><span class="token punctuation">)</span>      <span class="token punctuation">.</span><span class="token function">resultSetType</span><span class="token punctuation">(</span>resultSetType<span class="token punctuation">)</span>      <span class="token punctuation">.</span><span class="token function">flushCacheRequired</span><span class="token punctuation">(</span><span class="token function">valueOrDefault</span><span class="token punctuation">(</span>flushCache<span class="token punctuation">,</span> <span class="token operator">!</span>isSelect<span class="token punctuation">)</span><span class="token punctuation">)</span>      <span class="token punctuation">.</span><span class="token function">useCache</span><span class="token punctuation">(</span><span class="token function">valueOrDefault</span><span class="token punctuation">(</span>useCache<span class="token punctuation">,</span> isSelect<span class="token punctuation">)</span><span class="token punctuation">)</span>      <span class="token punctuation">.</span><span class="token function">cache</span><span class="token punctuation">(</span>currentCache<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token class-name">ParameterMap</span> statementParameterMap <span class="token operator">=</span> <span class="token function">getStatementParameterMap</span><span class="token punctuation">(</span>parameterMap<span class="token punctuation">,</span> parameterType<span class="token punctuation">,</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>statementParameterMap <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    statementBuilder<span class="token punctuation">.</span><span class="token function">parameterMap</span><span class="token punctuation">(</span>statementParameterMap<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>  <span class="token comment">//ä½¿ç”¨å»ºé€ è€…æ¨¡å¼åˆ›å»ºä¸€ä¸ªmappedStatment</span>  <span class="token class-name">MappedStatement</span> statement <span class="token operator">=</span> statementBuilder<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//å°†mappedStatmentæ³¨å†Œåˆ°configuration</span>  configuration<span class="token punctuation">.</span><span class="token function">addMappedStatement</span><span class="token punctuation">(</span>statement<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> statement<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ä»¥ä¸Šå°±æ˜¯ç”ŸæˆMappedStatementçš„è¿‡ç¨‹ã€‚ä½†æ˜¯è¿˜æ²¡å®Œï¼Œ*mapper.javaè¿˜æ²¡æœ‰å’Œ*mapper.xmlå¯¹åº”çš„sqlç»‘å®šèµ·æ¥ã€‚æ¥ä¸‹æ¥å°±æ˜¯ç»‘å®šè¿‡ç¨‹äº†ã€‚</p><h1 id="å››ã€Mapper-æ¥å£ç»‘å®š"><a href="#å››ã€Mapper-æ¥å£ç»‘å®š" class="headerlink" title="å››ã€Mapper æ¥å£ç»‘å®š"></a>å››ã€Mapper æ¥å£ç»‘å®š</h1><p>è¿”å›åˆ°XMLMapperBuilderçš„parse()æ–¹æ³•ã€‚</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">parse</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>   <span class="token comment">//åˆ¤æ–­æ˜¯å¦å·²ç»åŠ è½½è¯¥é…ç½®æ–‡ä»¶</span>   <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>configuration<span class="token punctuation">.</span><span class="token function">isResourceLoaded</span><span class="token punctuation">(</span>resource<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>       <span class="token function">configurationElement</span><span class="token punctuation">(</span>parser<span class="token punctuation">.</span><span class="token function">evalNode</span><span class="token punctuation">(</span><span class="token string">"/mapper"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//å¤„ç†mapperèŠ‚ç‚¹</span>       configuration<span class="token punctuation">.</span><span class="token function">addLoadedResource</span><span class="token punctuation">(</span>resource<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//å°†mapperæ–‡ä»¶æ·»åŠ åˆ°configuration.loadedResourcesä¸­</span>       <span class="token function">bindMapperForNamespace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//æ³¨å†Œmapperæ¥å£</span>   <span class="token punctuation">&#125;</span>   <span class="token comment">//å¤„ç†è§£æå¤±è´¥çš„ResultMapèŠ‚ç‚¹</span>   <span class="token function">parsePendingResultMaps</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">//å¤„ç†è§£æå¤±è´¥çš„CacheRefèŠ‚ç‚¹</span>   <span class="token function">parsePendingCacheRefs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">//å¤„ç†è§£æå¤±è´¥çš„Sqlè¯­å¥èŠ‚ç‚¹</span>   <span class="token function">parsePendingStatements</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ä¸»è¦å…³æ³¨è¿™ä¸ªæ–¹æ³•bindMapperForNamespace().</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">//æ³¨å†Œmapperæ¥å£</span><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">bindMapperForNamespace</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token comment">//è·å–å‘½åç©ºé—´</span>    <span class="token class-name">String</span> namespace <span class="token operator">=</span> builderAssistant<span class="token punctuation">.</span><span class="token function">getCurrentNamespace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>namespace <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span> boundType <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>            <span class="token comment">//é€šè¿‡å‘½åç©ºé—´è·å–mapperæ¥å£çš„classå¯¹è±¡</span>            boundType <span class="token operator">=</span> <span class="token class-name">Resources</span><span class="token punctuation">.</span><span class="token function">classForName</span><span class="token punctuation">(</span>namespace<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ClassNotFoundException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token comment">//ignore, bound type is not required</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>boundType <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>configuration<span class="token punctuation">.</span><span class="token function">hasMapper</span><span class="token punctuation">(</span>boundType<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">//æ˜¯å¦å·²ç»æ³¨å†Œè¿‡è¯¥mapperæ¥å£ï¼Ÿ</span>                <span class="token comment">// Spring may not know the real resource name so we set a flag</span>                <span class="token comment">// to prevent loading again this resource from the mapper interface</span>                <span class="token comment">// look at MapperAnnotationBuilder#loadXmlResource</span>                <span class="token comment">//å°†å‘½åç©ºé—´æ·»åŠ è‡³configuration.loadedResourceé›†åˆä¸­</span>                configuration<span class="token punctuation">.</span><span class="token function">addLoadedResource</span><span class="token punctuation">(</span><span class="token string">"namespace:"</span> <span class="token operator">+</span> namespace<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment">//å°†mapperæ¥å£æ·»åŠ åˆ°mapperæ³¨å†Œä¸­å¿ƒ</span>                configuration<span class="token punctuation">.</span><span class="token function">addMapper</span><span class="token punctuation">(</span>boundType<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ç»‘å®šå®Œæ­£å¸¸çš„èŠ‚ç‚¹åï¼Œè¿˜è¦å¤„ç†ä¸€äº›ä¸æ­£å¸¸çš„ã€‚</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">//å¤„ç†è§£æå¤±è´¥çš„ResultMapèŠ‚ç‚¹</span><span class="token function">parsePendingResultMaps</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//å¤„ç†è§£æå¤±è´¥çš„CacheRefèŠ‚ç‚¹</span><span class="token function">parsePendingCacheRefs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//å¤„ç†è§£æå¤±è´¥çš„Sqlè¯­å¥èŠ‚ç‚¹</span><span class="token function">parsePendingStatements</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æ¯”å¦‚è¿™ç§cacheRefæ ‡ç­¾</p><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token comment">&lt;!-- æ˜ å°„æ–‡ä»¶1 --></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>mapper</span> <span class="token attr-name">namespace</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>com.enjoylearning.mybatis.dao.Mapper1<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    <span class="token comment">&lt;!-- å¼•ç”¨æ˜ å°„æ–‡ä»¶2ä¸­é…ç½®çš„ç¼“å­˜ --></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>cache-ref</span> <span class="token attr-name">namespace</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>com.enjoylearning.mybatis.dao.Mapper2<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>mapper</span><span class="token punctuation">></span></span> <span class="token comment">&lt;!-- æ˜ å°„æ–‡ä»¶2 --></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>mapper</span> <span class="token attr-name">namespace</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>com.enjoylearning.mybatis.dao.Mapper2<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>cache</span><span class="token punctuation">/></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>mapper</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>Game over.</p>]]></content>
      
      
      <categories>
          
          <category> MyBatisæºç å­¦ä¹  </category>
          
      </categories>
      
      
        <tags>
            
            <tag> MyBatis </tag>
            
            <tag> æºç  </tag>
            
            <tag> SQL </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ã€MyBatisæºç å­¦ä¹ ã€‘å‚æ•°è§£æ</title>
      <link href="/posts/7419.html"/>
      <url>/posts/7419.html</url>
      
        <content type="html"><![CDATA[<h1 id="ä¸€ã€å‡ ç§å…¥å‚å½¢å¼"><a href="#ä¸€ã€å‡ ç§å…¥å‚å½¢å¼" class="headerlink" title="ä¸€ã€å‡ ç§å…¥å‚å½¢å¼"></a>ä¸€ã€å‡ ç§å…¥å‚å½¢å¼</h1><p>è¿™é‡Œåªåˆ†æå¸¦æœ‰å…¥å‚çš„æ–¹æ³•ã€‚</p><h2 id="1-å•ä¸ªå…¥å‚"><a href="#1-å•ä¸ªå…¥å‚" class="headerlink" title="1.å•ä¸ªå…¥å‚"></a>1.å•ä¸ªå…¥å‚</h2><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">UserInfo</span> <span class="token function">selectByPrimaryKey</span><span class="token punctuation">(</span><span class="token class-name">String</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h2 id="2-å¤šä¸ªå…¥å‚"><a href="#2-å¤šä¸ªå…¥å‚" class="headerlink" title="2.å¤šä¸ªå…¥å‚"></a>2.å¤šä¸ªå…¥å‚</h2><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">UserInfo</span><span class="token punctuation">></span></span> <span class="token function">getByOpenIdAndUsername2</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Param</span><span class="token punctuation">(</span><span class="token string">"openid"</span><span class="token punctuation">)</span> <span class="token class-name">String</span> openId<span class="token punctuation">,</span> <span class="token annotation punctuation">@Param</span><span class="token punctuation">(</span><span class="token string">"username"</span><span class="token punctuation">)</span> <span class="token class-name">String</span> username<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h2 id="3-å…¥å‚ä¸ºå®ä½“å¯¹è±¡"><a href="#3-å…¥å‚ä¸ºå®ä½“å¯¹è±¡" class="headerlink" title="3.å…¥å‚ä¸ºå®ä½“å¯¹è±¡"></a>3.å…¥å‚ä¸ºå®ä½“å¯¹è±¡</h2><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">UserInfo</span><span class="token punctuation">></span></span> <span class="token function">getByOpenIdAndUsername3</span><span class="token punctuation">(</span><span class="token class-name">UserInfo</span> userInfo<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h2 id="4-å…¥å‚ä¸ºMap"><a href="#4-å…¥å‚ä¸ºMap" class="headerlink" title="4.å…¥å‚ä¸ºMap"></a>4.å…¥å‚ä¸ºMap</h2><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">UserInfo</span><span class="token punctuation">></span></span> <span class="token function">getByOpenIdAndUsername</span><span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">></span></span> params<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h1 id="äºŒã€mybatisæ‰§è¡Œå…¥å£"><a href="#äºŒã€mybatisæ‰§è¡Œå…¥å£" class="headerlink" title="äºŒã€mybatisæ‰§è¡Œå…¥å£"></a>äºŒã€mybatisæ‰§è¡Œå…¥å£</h1><p>è¿˜æ˜¯ä»¥ä¹‹å‰çš„ä¸€ä¸ªä¾‹å­æ¥è¿›å…¥æˆ‘ä»¬ä»Šå¤©çš„æ­£é¢˜ã€‚</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Test</span><span class="token comment">// å¿«é€Ÿå…¥é—¨</span><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">quickStart</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">&#123;</span>    <span class="token comment">//--------------------ç¬¬äºŒé˜¶æ®µ---------------------------</span>    <span class="token comment">// 2.è·å–sqlSession</span>    <span class="token class-name">SqlSession</span> sqlSession <span class="token operator">=</span> sqlSessionFactory<span class="token punctuation">.</span><span class="token function">openSession</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 3.è·å–å¯¹åº”mapper</span>    <span class="token class-name">UserInfoMapper</span> mapper <span class="token operator">=</span> sqlSession<span class="token punctuation">.</span><span class="token function">getMapper</span><span class="token punctuation">(</span><span class="token class-name">UserInfoMapper</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//--------------------ç¬¬ä¸‰é˜¶æ®µ---------------------------</span>    <span class="token comment">// 4.æ‰§è¡ŒæŸ¥è¯¢è¯­å¥å¹¶è¿”å›å•æ¡æ•°æ®</span>    <span class="token class-name">UserInfo</span> user <span class="token operator">=</span> mapper<span class="token punctuation">.</span><span class="token function">selectByPrimaryKey</span><span class="token punctuation">(</span><span class="token string">"1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å½“æˆ‘ä»¬æ‰§è¡Œåˆ°è¿™ä¸€è¡Œæ—¶ï¼Œ</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">UserInfoMapper</span> mapper <span class="token operator">=</span> sqlSession<span class="token punctuation">.</span><span class="token function">getMapper</span><span class="token punctuation">(</span><span class="token class-name">UserInfoMapper</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>é€šè¿‡è°ƒè¯•æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œè¿™ä¸ªmapperå…¶å®æ˜¯é€šè¿‡MapperProxyä»£ç†æ‰§è¡Œçš„ã€‚æˆ‘ä»¬æ‹¿åˆ°çš„å…¶å®å°±æ˜¯ä¸ªåŠ¨æ€ä»£ç†å¯¹è±¡ã€‚å¦‚ä¸‹å›¾ï¼š<br><img src="https://cdn.jsdelivr.net/gh/zyxelva/picgo@main/csdn/20210314204651483.png"><br>å½“æˆ‘ä»¬æ‰§è¡ŒæŸ¥è¯¢æ—¶ï¼Œè¿›å…¥MapperProxyåŠ¨æ€ä»£ç†è¿‡ç¨‹ã€‚<br><img src="https://cdn.jsdelivr.net/gh/zyxelva/picgo@main/csdn/2021031420510518.png"><br>æœ€ç»ˆäº¤ç”±MapperMethodç±»çš„execute()æ–¹æ³•æ‰§è¡Œï¼Œæºä»£ç å¦‚ä¸‹ï¼š</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">//ä¸‰æ­¥ç¿»è¯‘åœ¨æ­¤å®Œæˆ</span><span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token class-name">SqlSession</span> sqlSession<span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token class-name">Object</span> result<span class="token punctuation">;</span>  <span class="token comment">//ç¬¬ä¸€æ­¥ æ ¹æ®sqlè¯­å¥ç±»å‹ä»¥åŠæ¥å£è¿”å›çš„å‚æ•°é€‰æ‹©è°ƒç”¨ä¸åŒçš„æ–¹æ³•</span>  <span class="token keyword">switch</span> <span class="token punctuation">(</span>command<span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">case</span> <span class="token constant">INSERT</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>  <span class="token class-name">Object</span> param <span class="token operator">=</span> method<span class="token punctuation">.</span><span class="token function">convertArgsToSqlCommandParam</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>      result <span class="token operator">=</span> <span class="token function">rowCountResult</span><span class="token punctuation">(</span>sqlSession<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>command<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> param<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">break</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">case</span> <span class="token constant">UPDATE</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>      <span class="token class-name">Object</span> param <span class="token operator">=</span> method<span class="token punctuation">.</span><span class="token function">convertArgsToSqlCommandParam</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>      result <span class="token operator">=</span> <span class="token function">rowCountResult</span><span class="token punctuation">(</span>sqlSession<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>command<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> param<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">break</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">case</span> <span class="token constant">DELETE</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>      <span class="token class-name">Object</span> param <span class="token operator">=</span> method<span class="token punctuation">.</span><span class="token function">convertArgsToSqlCommandParam</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>      result <span class="token operator">=</span> <span class="token function">rowCountResult</span><span class="token punctuation">(</span>sqlSession<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>command<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> param<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">break</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">case</span> <span class="token constant">SELECT</span><span class="token operator">:</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>method<span class="token punctuation">.</span><span class="token function">returnsVoid</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> method<span class="token punctuation">.</span><span class="token function">hasResultHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">//è¿”å›å€¼ä¸ºvoid</span>        <span class="token function">executeWithResultHandler</span><span class="token punctuation">(</span>sqlSession<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>        result <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>      <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>method<span class="token punctuation">.</span><span class="token function">returnsMany</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">//è¿”å›å€¼ä¸ºé›†åˆæˆ–è€…æ•°ç»„</span>        result <span class="token operator">=</span> <span class="token function">executeForMany</span><span class="token punctuation">(</span>sqlSession<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>method<span class="token punctuation">.</span><span class="token function">returnsMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">//è¿”å›å€¼ä¸ºmap</span>        result <span class="token operator">=</span> <span class="token function">executeForMap</span><span class="token punctuation">(</span>sqlSession<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>method<span class="token punctuation">.</span><span class="token function">returnsCursor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">//è¿”å›å€¼ä¸ºæ¸¸æ ‡</span>        result <span class="token operator">=</span> <span class="token function">executeForCursor</span><span class="token punctuation">(</span>sqlSession<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span><span class="token comment">//å¤„ç†è¿”å›ä¸ºå•ä¸€å¯¹è±¡çš„æƒ…å†µ</span>        <span class="token comment">//é€šè¿‡å‚æ•°è§£æå™¨è§£æè§£æå‚æ•°</span>        <span class="token class-name">Object</span> param <span class="token operator">=</span> method<span class="token punctuation">.</span><span class="token function">convertArgsToSqlCommandParam</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//ç¬¬ä¸‰æ­¥ç¿»è¯‘ï¼Œå°†å…¥å‚è½¬åŒ–æˆMap</span>        result <span class="token operator">=</span> sqlSession<span class="token punctuation">.</span><span class="token function">selectOne</span><span class="token punctuation">(</span>command<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> param<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>method<span class="token punctuation">.</span><span class="token function">returnsOptional</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>            <span class="token punctuation">(</span>result <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> <span class="token operator">!</span>method<span class="token punctuation">.</span><span class="token function">getReturnType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>          result <span class="token operator">=</span> <span class="token class-name">OptionalUtil</span><span class="token punctuation">.</span><span class="token function">ofNullable</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>      <span class="token punctuation">&#125;</span>      <span class="token keyword">break</span><span class="token punctuation">;</span>    <span class="token keyword">case</span> <span class="token constant">FLUSH</span><span class="token operator">:</span>      result <span class="token operator">=</span> sqlSession<span class="token punctuation">.</span><span class="token function">flushStatements</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">break</span><span class="token punctuation">;</span>    <span class="token keyword">default</span><span class="token operator">:</span>      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BindingException</span><span class="token punctuation">(</span><span class="token string">"Unknown execution method for: "</span> <span class="token operator">+</span> command<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> method<span class="token punctuation">.</span><span class="token function">getReturnType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isPrimitive</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>method<span class="token punctuation">.</span><span class="token function">returnsVoid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BindingException</span><span class="token punctuation">(</span><span class="token string">"Mapper method '"</span> <span class="token operator">+</span> command<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token operator">+</span> <span class="token string">" attempted to return null from a method with a primitive return type ("</span> <span class="token operator">+</span> method<span class="token punctuation">.</span><span class="token function">getReturnType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">")."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>  <span class="token keyword">return</span> result<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æ‰€ä»¥ï¼Œæœ¬ç« å‚æ•°è§£æçš„è¿‡ç¨‹ï¼Œæˆ‘ä»¬é‡ç‚¹å…³æ³¨è¿™ä¸ªæ–¹æ³•å³å¯ï¼Œè¿™ä¸ªæ–¹æ³•å°±æ˜¯convertArgsToSqlCommandParamã€‚å®ƒå…¶å®æ˜¯æ–¹æ³•çš„å‚æ•°è§£æå™¨ParamNameResolverçš„getNamedParams()æ–¹æ³•å®Œæˆçš„ã€‚<br><img src="https://cdn.jsdelivr.net/gh/zyxelva/picgo@main/csdn/20210314205954450.png"><br>è€Œè¿™ä¸ªParamNameResolveråˆ™æ˜¯åœ¨MapperProxyè·å–mapperMethodæ—¶ï¼ˆå…ˆä¸è¯´ä»cacheä¸­å–ï¼‰è¿›è¡Œåˆå§‹åŒ–çš„ï¼Œ<br><img src="https://cdn.jsdelivr.net/gh/zyxelva/picgo@main/csdn/20210314211304810.png"><br><img src="https://cdn.jsdelivr.net/gh/zyxelva/picgo@main/csdn/20210314211424528.png"><br><img src="https://cdn.jsdelivr.net/gh/zyxelva/picgo@main/csdn/20210314211600469.png"><br>è€ŒParamNameResolverå®ä¾‹åŒ–æ—¶ï¼Œä¸»è¦å·¥ä½œå°±æ˜¯è¿›è¡Œåˆæ­¥çš„æ˜ å°„å…³ç³»å­˜å‚¨ï¼Œå…¶å­—æ®µnamesæ˜¯ä¸€ä¸ªSortedMapï¼Œå­˜å‚¨äº†å‚æ•°åçš„é¡ºåºæ˜ å°„ã€‚</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/**   * &lt;p>   * The key is the index and the value is the name of the parameter.&lt;br />   * The name is obtained from &#123;@link Param&#125; if specified. When &#123;@link Param&#125; is not specified,   * the parameter index is used. Note that this index could be different from the actual index   * when the method has special parameters (i.e. &#123;@link RowBounds&#125; or &#123;@link ResultHandler&#125;).   * &lt;/p>   * &lt;ul>   * &lt;li>aMethod(@Param("M") int a, @Param("N") int b) -&amp;gt; &#123;&#123;0, "M"&#125;, &#123;1, "N"&#125;&#125;&lt;/li>   * &lt;li>aMethod(int a, int b) -&amp;gt; &#123;&#123;0, "0"&#125;, &#123;1, "1"&#125;&#125;&lt;/li>   * &lt;li>aMethod(int a, RowBounds rb, int b) -&amp;gt; &#123;&#123;0, "0"&#125;, &#123;2, "1"&#125;&#125;&lt;/li>   * &lt;/ul>   */</span>  <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">SortedMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">></span></span> names<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ç»§ç»­çœ‹getNamedParamsï¼ˆï¼‰æ–¹æ³•ã€‚</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">//å°†å¤šä¸ªå‚æ•°å°è£…æˆMAP</span><span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">getNamedParams</span><span class="token punctuation">(</span><span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">final</span> <span class="token keyword">int</span> paramCount <span class="token operator">=</span> names<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>args <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> paramCount <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>hasParamAnnotation <span class="token operator">&amp;&amp;</span> paramCount <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">return</span> args<span class="token punctuation">[</span>names<span class="token punctuation">.</span><span class="token function">firstKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">final</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">></span></span> param <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ParamMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Map<span class="token punctuation">.</span>Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">></span></span> entry <span class="token operator">:</span> names<span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      param<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>entry<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> args<span class="token punctuation">[</span>entry<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment">// add generic param names (param1, param2, ...)</span>      <span class="token keyword">final</span> <span class="token class-name">String</span> genericParamName <span class="token operator">=</span> <span class="token constant">GENERIC_NAME_PREFIX</span> <span class="token operator">+</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment">// ensure not to overwrite parameter named with @Param</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>names<span class="token punctuation">.</span><span class="token function">containsValue</span><span class="token punctuation">(</span>genericParamName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        param<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>genericParamName<span class="token punctuation">,</span> args<span class="token punctuation">[</span>entry<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">&#125;</span>      i<span class="token operator">++</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">return</span> param<span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æœ¬ä¾‹å­ä¸­ï¼Œç”±äºæ— @Paramæ³¨è§£ï¼Œæ‰€ä»¥åœ¨ç¬¬äºŒä¸ªelse ifé‚£é‡Œå°±è¿”å›äº†ã€‚</p><h1 id="ä¸‰ã€å‚æ•°è§£ææµç¨‹"><a href="#ä¸‰ã€å‚æ•°è§£ææµç¨‹" class="headerlink" title="ä¸‰ã€å‚æ•°è§£ææµç¨‹"></a>ä¸‰ã€å‚æ•°è§£ææµç¨‹</h1><p>ä»¥ä¸‹é¢çš„ä»£ç ä¸ºä¾‹ï¼Œå…¶ä»–å½¢å¼çš„å…¥å‚å¤§åŒå°å¼‚ã€‚</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Test</span><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testManyParamQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token comment">// 2.è·å–sqlSession</span>    <span class="token class-name">SqlSession</span> sqlSession <span class="token operator">=</span> sqlSessionFactory<span class="token punctuation">.</span><span class="token function">openSession</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 3.è·å–å¯¹åº”mapper</span>    <span class="token class-name">UserInfoMapper</span> mapper <span class="token operator">=</span> sqlSession<span class="token punctuation">.</span><span class="token function">getMapper</span><span class="token punctuation">(</span><span class="token class-name">UserInfoMapper</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">String</span> username <span class="token operator">=</span> <span class="token string">"zyx"</span><span class="token punctuation">;</span>    <span class="token class-name">String</span> openId <span class="token operator">=</span> <span class="token string">"zyxelva"</span><span class="token punctuation">;</span>    <span class="token comment">// ç¬¬ä¸€ç§æ–¹å¼ä½¿ç”¨map</span>    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">></span></span> params <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    params<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"username"</span><span class="token punctuation">,</span> username<span class="token punctuation">)</span><span class="token punctuation">;</span>    params<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"openid"</span><span class="token punctuation">,</span> openId<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">UserInfo</span><span class="token punctuation">></span></span> list1 <span class="token operator">=</span> mapper<span class="token punctuation">.</span><span class="token function">getByUsernameAndOpenId</span><span class="token punctuation">(</span>params<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>list1<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å¯¹åº”çš„mapper.xmlæ–¹æ³•</p><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>select</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>getByUsernameAndOpenId<span class="token punctuation">"</span></span> <span class="token attr-name">resultMap</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>BaseResultMap<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>   select    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>include</span> <span class="token attr-name">refid</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Base_Column_List<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>    from user_info     where username=#&#123;username&#125; and openid=#&#123;openid&#125;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>select</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æˆ‘ä»¬ä»æ–¹æ³•</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">UserInfo</span><span class="token punctuation">></span></span> list1 <span class="token operator">=</span> mapper<span class="token punctuation">.</span><span class="token function">getByUsernameAndOpenId</span><span class="token punctuation">(</span>params<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>å¼€å§‹æ–­ç‚¹è°ƒè¯•ã€‚æˆ‘ä»¬çœ‹åˆ°ï¼Œè¿›å…¥åˆ°äº†MapperProxyçš„åŠ¨æ€ä»£ç†è¿‡ç¨‹ã€‚ç›´æ¥è¿›å…¥mapperMethod.execute(sqlSession, args);</p><p><img src="https://cdn.jsdelivr.net/gh/zyxelva/picgo@main/csdn/20210315111605602.png"><br>æ¥åˆ°MapperMethodä¸­çš„executeæ–¹æ³•ä¸­ã€‚ç”±äºæˆ‘ä»¬çš„ä¾‹å­æ˜¯æŸ¥è¯¢æ“ä½œï¼Œæ•…è¿›å…¥Selectã€‚åˆä¾‹å­çš„è¿”å›ç±»å‹æ˜¯List,æ•…è¿›å…¥ç¬¬äºŒä¸ªifè¯­å¥ä¸­ã€‚<br><img src="https://cdn.jsdelivr.net/gh/zyxelva/picgo@main/csdn/20210315111929562.png"><br><img src="https://cdn.jsdelivr.net/gh/zyxelva/picgo@main/csdn/20210315112106406.png"><br>è¿›å…¥æ–¹æ³•executeForMany(). æ²¡æœ‰åˆ†é¡µï¼Œæ‰€ä»¥è¿›å…¥elseè¯­å¥ä¸­ã€‚è€ŒconvertArgsToSqlCommandParamæ–¹æ³•æˆ‘ä»¬åœ¨äºŒä¸­å·²ç»åˆ†æäº†ï¼Œè¿™é‡Œä¸å†å…·ä½“æ¢³ç†ã€‚<br><img src="https://cdn.jsdelivr.net/gh/zyxelva/picgo@main/csdn/20210315112219141.png"><br>è¿›å…¥DefaultSQLSessionçš„selectListæ–¹æ³•ä¸­ã€‚å¯ä»¥çœ‹ä¸‹statementå®é™…å½¢å¼æ˜¯namespace+idï¼Œå°±å¯ä»¥ä»MappedStatementä¸­è·å–ã€‚<br><img src="https://cdn.jsdelivr.net/gh/zyxelva/picgo@main/csdn/20210315112604497.png"><br>è€ŒMappedStatementä¹Ÿæœ‰å¾ˆå¤šä¿¡æ¯ï¼Œä¸»è¦æ˜¯<select>æ ‡ç­¾ä»¥åŠè¯¥èŠ‚ç‚¹å…¶ä»–é‡è¦çš„å±æ€§ã€‚<br><img src="https://cdn.jsdelivr.net/gh/zyxelva/picgo@main/csdn/20210315113216306.png"><br>è€Œsqlçš„å®é™…æ‰§è¡Œè€…ï¼Œåˆ™ä¸ºExecutor. ä»£ç†å¯¹è±¡æ‰§è¡Œæ–¹æ³•è¢«æ‹¦æˆªå™¨æ‹¦æˆªï¼Œæ‰§è¡Œä»¥ä¸‹æ–¹æ³•ã€‚<br><img src="https://cdn.jsdelivr.net/gh/zyxelva/picgo@main/csdn/20210315113629172.png"><br>å…ˆçœ‹çœ‹getBoundSqlå¹²äº†å•¥ï¼š<br><img src="https://cdn.jsdelivr.net/gh/zyxelva/picgo@main/csdn/20210315135210374.png"><br><img src="https://cdn.jsdelivr.net/gh/zyxelva/picgo@main/csdn/20210315135542105.png"><br>è¿›å…¥RawSqlSource,å› ä¾‹å­çš„sqlæ— ${},æ— åŠ¨æ€SQLèŠ‚ç‚¹ã€‚<br><img src="https://cdn.jsdelivr.net/gh/zyxelva/picgo@main/csdn/20210315140041749.png"><br>å…ˆçœ‹çœ‹RawSqlSourceçš„æ„é€ æ–¹æ³•ï¼Œçœ‹çœ‹#{}æ˜¯æ€ä¹ˆæ›¿æ¢æˆ?çš„ï¼Œå‘ç°ä¸»è¦æ˜¯SqlSourceBuilderåœ¨å¹²æ´»å„¿ã€‚<br><img src="https://cdn.jsdelivr.net/gh/zyxelva/picgo@main/csdn/20210315141654652.png"><br><img src="https://cdn.jsdelivr.net/gh/zyxelva/picgo@main/csdn/20210315141735671.png"><br>ä¸»è¦çœ‹GenericTokenParser.parse().è¯¥æ–¹æ³•ä¸»è¦å®Œæˆå ä½ç¬¦çš„å®šä½å·¥ä½œï¼Œç„¶åæŠŠå ä½ç¬¦çš„æ›¿æ¢å·¥ä½œäº¤ç»™ä¸å…¶å…³è”çš„ TokenHandler å¤„ç†.<br><img src="https://cdn.jsdelivr.net/gh/zyxelva/picgo@main/csdn/20210315142304221.png"><br>TokenHandleræœ‰å››ä¸ªå°å¼Ÿï¼Œ<br><img src="https://cdn.jsdelivr.net/gh/zyxelva/picgo@main/csdn/20210315142425559.png"><br>BindingTokenParserï¼šè¯¥å¯¹è±¡çš„handleTokenæ–¹æ³•ä¼šå–å‡ºå ä½ç¬¦ä¸­çš„å˜é‡ï¼Œç„¶åä½¿ç”¨è¯¥å˜é‡ä½œä¸ºé”®å»ä¸Šä¸‹æ–‡ç¯å¢ƒä¸­å¯»æ‰¾å¯¹åº”çš„å€¼ã€‚ä¹‹åï¼Œä¼šç”¨æ‰¾åˆ°çš„å€¼æ›¿æ¢å ä½ç¬¦ã€‚å› æ­¤ï¼Œè¯¥å¯¹è±¡å¯ä»¥å®Œæˆå ä½ç¬¦çš„æ›¿æ¢å·¥ä½œï¼›<br>DynamicCheckerTokenParserï¼šè¯¥å¯¹è±¡çš„ handleToken æ–¹æ³•ä¼šç½®ä½æˆå‘˜å±æ€§isDynamicã€‚å› æ­¤è¯¥å¯¹è±¡å¯ä»¥è®°å½•è‡ªèº«æ˜¯å¦é‡åˆ°è¿‡å ä½ç¬¦ã€‚<br>ParameterMappingTokenHandlerï¼šå°†DynamicSqlSourceå’ŒRawSqlSourceä¸­çš„â€œ#{}â€ç¬¦å·æ›¿æ¢æ‰ï¼Œä»è€Œå°†ä»–ä»¬è½¬åŒ–ä¸ºStaticSqlSourceï¼›<br>VariableTokenHandlerï¼šhandleTokenæ–¹æ³•ä¸­ä¼ å…¥è¾“å…¥å‚æ•°åï¼Œè¯¥æ–¹æ³•ä¼šä»¥è¾“å…¥å‚æ•°ä¸ºé”®å°è¯•ä»variableså±æ€§ä¸­å¯»æ‰¾å¯¹åº”çš„å€¼è¿”å›ã€‚<br><img src="https://cdn.jsdelivr.net/gh/zyxelva/picgo@main/csdn/20210315140144135.png"><br>åˆ°æ­¤BoundSqlçš„è§£æè¿‡ç¨‹åŸºæœ¬ç»“æŸã€‚getBoundSqlæ–¹æ³•æ‰§è¡Œå®Œåï¼Œæˆ‘ä»¬å†çœ‹çœ‹ä¸€çº§ç¼“å­˜çš„keyç”Ÿæˆç­–ç•¥ã€‚<br><img src="https://cdn.jsdelivr.net/gh/zyxelva/picgo@main/csdn/20210315140541909.png"><br><img src="https://cdn.jsdelivr.net/gh/zyxelva/picgo@main/csdn/20210315140853968.png"></select></p><p>å¯ä»¥çœ‹å‡ºï¼ŒcacheKeyç”±namespaceçš„id,åˆ†é¡µå‚æ•°ï¼Œsqlè¯­å¥ï¼Œå…¥å‚ä»¥åŠ<environment>èŠ‚ç‚¹çš„ä¿¡æ¯ç»„æˆã€‚<br>å›åˆ°æŸ¥è¯¢è¿‡ç¨‹ï¼Œå®é™…æ‰§è¡Œçš„æ–¹æ³•ä¸º<br><img src="https://cdn.jsdelivr.net/gh/zyxelva/picgo@main/csdn/20210315113709359.png"><br>è€Œé¦–æ¬¡æŸ¥è¯¢ä¸ä¼šè¿›å…¥ifè¯­å¥ï¼Œè°ƒç”¨BaseExecutorçš„æ–¹æ³•ï¼š<br><img src="https://cdn.jsdelivr.net/gh/zyxelva/picgo@main/csdn/20210315113913105.png"><br>æœ¬åœ°ç¼“å­˜æ²¡æœ‰ç»“æœï¼Œæ•…éœ€è¦æŸ¥è¯¢æ•°æ®åº“ï¼Œè¿›å…¥queryFromDatabase().<br><img src="https://cdn.jsdelivr.net/gh/zyxelva/picgo@main/csdn/20210315114121102.png"><br>doQuery()åˆ™è°ƒç”¨çš„ä¸ºSimpleExecutorçš„æ–¹æ³•ã€‚<br><img src="https://cdn.jsdelivr.net/gh/zyxelva/picgo@main/csdn/20210315114350394.png"><br>çœ‹çœ‹newStatementHandler()ã€‚<br><img src="https://cdn.jsdelivr.net/gh/zyxelva/picgo@main/csdn/20210315114428448.png"><br><img src="https://cdn.jsdelivr.net/gh/zyxelva/picgo@main/csdn/20210315114501949.png"><br>ç”±äºæˆ‘ä»¬çš„ä¾‹å­å½“ä¸­sqlå¸¦æœ‰#{}ï¼Œæ•…è¿›å…¥PREPAREDï¼Œç”ŸæˆPreparedStatementHandlerã€‚<br>æ‰§è¡Œå®Œè¯­å¥åï¼Œæ”¾å…¥ä¸€çº§ç¼“å­˜ã€‚<br><img src="https://cdn.jsdelivr.net/gh/zyxelva/picgo@main/csdn/20210315115037492.png"><br>åç»­å°±æ˜¯ç»“æœæ˜ å°„æ‰§è¡Œè¿‡ç¨‹ï¼Œè¿™é‡Œä¸å†èµ˜è¿°ï¼Œåç»­è·Ÿä¸Šã€‚</environment></p><h1 id="å››ã€æ€»ç»“"><a href="#å››ã€æ€»ç»“" class="headerlink" title="å››ã€æ€»ç»“"></a>å››ã€æ€»ç»“</h1><p>æœ¬ç« ä¸»è¦è®²è¿°äº†mybatiså‚æ•°è§£æçš„è¿‡ç¨‹ï¼Œé‡ç‚¹è·Ÿè¸ªäº†æ‰§è¡Œsqlæ—¶ï¼Œå˜é‡å ä½ç¬¦${}ä»¥åŠå‚æ•°å ä½ç¬¦#{}çš„æ›¿æ¢å’Œè§£æè¿‡ç¨‹ã€‚å®é™…å¼€å‘è¿‡ç¨‹ä¸­ï¼Œè¦æ³¨æ„è¿™ä¸¤è€…çš„åŒºåˆ«ï¼Œèƒ½ç”¨#{}çš„åœ°æ–¹å°½é‡ç”¨#ã€‚è€Œ${}ä¸»è¦ç”¨äºorder byè¯­å¥ã€åŸç”Ÿjdbcã€è¡¨åä½œå‚æ•°ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> MyBatisæºç å­¦ä¹  </category>
          
      </categories>
      
      
        <tags>
            
            <tag> MyBatis </tag>
            
            <tag> æºç  </tag>
            
            <tag> SQL </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ã€MyBatisæºç å­¦ä¹ ã€‘ä»£ç†é˜¶æ®µ</title>
      <link href="/posts/61411.html"/>
      <url>/posts/61411.html</url>
      
        <content type="html"><![CDATA[<h1 id="ä¸€ã€Mybatis-çš„æ¥å£å±‚"><a href="#ä¸€ã€Mybatis-çš„æ¥å£å±‚" class="headerlink" title="ä¸€ã€Mybatis çš„æ¥å£å±‚"></a>ä¸€ã€Mybatis çš„æ¥å£å±‚</h1><h2 id="1-SqlSession"><a href="#1-SqlSession" class="headerlink" title="1.SqlSession"></a>1.SqlSession</h2><p>sqlSessionæ€»ç»“<br><img src="https://cdn.jsdelivr.net/gh/zyxelva/picgo@main/csdn/20210312101600300.png" alt="å›¾1"><br>æ€»ä¹‹ä¸€å¥è¯ï¼š</p><pre class="line-numbers language-none"><code class="language-none">&#x2F;** * The primary Java interface for working with MyBatis. * Through this interface you can execute commands, get mappers and manage transactions. * * @author Clinton Begin *&#x2F;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ç¿»è¯‘è¿‡æ¥ï¼Œå°±æ˜¯ï¼šå¯¹å¤–è®¿é—®ç»Ÿä¸€çš„æ¥å£ï¼Œé€šè¿‡è¿™äº›æ¥å£ï¼Œå®Œæˆè¯»å†™å‘½ä»¤ï¼Œè·å–æ˜ å°„å’Œç®¡ç†äº‹åŠ¡ã€‚</p><p>UMLï¼š<br><img src="https://cdn.jsdelivr.net/gh/zyxelva/picgo@main/csdn/20210312102149880.png" alt="å›¾2"><br>SqlSessionæŸ¥è¯¢æ¥å£åµŒå¥—å…³ç³»<br><img src="https://cdn.jsdelivr.net/gh/zyxelva/picgo@main/csdn/20210312102442855.png" alt="SqlSessionæŸ¥è¯¢æ¥å£åµŒå¥—å…³ç³»"></p><h2 id="2-SqlSessionFactory"><a href="#2-SqlSessionFactory" class="headerlink" title="2.SqlSessionFactory"></a>2.SqlSessionFactory</h2><p>SqlSessionFactoryä¸SqlSessionå…³ç³»UMLå›¾<br><img src="https://cdn.jsdelivr.net/gh/zyxelva/picgo@main/csdn/20210312103052478.png" alt="SqlSessionFactoryä¸SqlSessionå…³ç³»UMLå›¾"><br>SqlSessionFactory ä½¿ç”¨å·¥å‚æ¨¡å¼åˆ›å»ºSqlSessionï¼Œå…¶é»˜è®¤çš„å®ç°ç±»ä¸ºDefaultSqlSessionFactoryï¼Œå…¶ä¸­è·å–SqlSession çš„æ ¸å¿ƒæ–¹æ³•ä¸ºopenSessionFromDataSource(ExecutorType, TransactionIsolationLevel, boolean)ï¼Œåœ¨è¿™ä¸ªæ–¹æ³•ä¸­ä»configuration ä¸­è·å–çš„TransactionFactory æ˜¯å…¸å‹çš„ç­–ç•¥æ¨¡å¼çš„åº”ç”¨ã€‚è¿è¡ŒæœŸï¼ŒTransactionFactory æ¥å£çš„å®ç°ï¼Œæ˜¯ç”±é…ç½®æ–‡ä»¶é…ç½®å†³å®šçš„ï¼Œå¯é…ç½®é€‰é¡¹åŒ…æ‹¬ï¼šJDBCã€Managedï¼Œå¯æ ¹æ®éœ€æ±‚çµæ´»çš„æ›¿æ¢TransactionFactory çš„å®ç°ã€‚</p><h1 id="äºŒã€binding-æ¨¡å—åˆ†æ"><a href="#äºŒã€binding-æ¨¡å—åˆ†æ" class="headerlink" title="äºŒã€binding æ¨¡å—åˆ†æ"></a>äºŒã€binding æ¨¡å—åˆ†æ</h1><h2 id="0-MyBatisä¸¤ç§ç¼–ç¨‹æ¨¡å‹"><a href="#0-MyBatisä¸¤ç§ç¼–ç¨‹æ¨¡å‹" class="headerlink" title="0.MyBatisä¸¤ç§ç¼–ç¨‹æ¨¡å‹"></a>0.MyBatisä¸¤ç§ç¼–ç¨‹æ¨¡å‹</h2><p>(1) ä½¿ç”¨mapperæ¥å£ç¼–ç¨‹ï¼Œå°±å¯ä»¥è®¿é—®æ•°æ®åº“ï¼›</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Test</span><span class="token comment">// ç¨‹åºå‘˜å–œæ¬¢çš„é£æ ¼</span><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">quickStart</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">&#123;</span>    <span class="token comment">// 2.è·å–sqlSession</span>    <span class="token class-name">SqlSession</span> sqlSession <span class="token operator">=</span> sqlSessionFactory<span class="token punctuation">.</span><span class="token function">openSession</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 3.è·å–å¯¹åº”mapper</span>    <span class="token class-name">TUserMapper</span> mapper <span class="token operator">=</span> sqlSession<span class="token punctuation">.</span><span class="token function">getMapper</span><span class="token punctuation">(</span><span class="token class-name">TUserMapper</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 4.æ‰§è¡ŒæŸ¥è¯¢è¯­å¥å¹¶è¿”å›å•æ¡æ•°æ®</span>    <span class="token class-name">TUser</span> user <span class="token operator">=</span> mapper<span class="token punctuation">.</span><span class="token function">selectByPrimaryKey</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>(2) ä½¿ç”¨sqlsessionå¯¹å¤–æä¾›æ•°æ®åº“çš„è®¿é—®ï¼›</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Test</span><span class="token comment">// åŸå§‹é£æ ¼ï¼Œibatisç¼–ç¨‹æ¨¡å‹ æœ¬è´¨åˆ†æ</span><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">originalOperation</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">&#123;</span>    <span class="token comment">// 2.è·å–sqlSession</span>    <span class="token class-name">SqlSession</span> sqlSession <span class="token operator">=</span> sqlSessionFactory<span class="token punctuation">.</span><span class="token function">openSession</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 3.æ‰§è¡ŒæŸ¥è¯¢è¯­å¥å¹¶è¿”å›ç»“æœ</span>    <span class="token class-name">TUser</span> user <span class="token operator">=</span> sqlSession<span class="token punctuation">.</span><span class="token function">selectOne</span><span class="token punctuation">(</span><span class="token string">"com.taeyeon.mybatis.mapper.TUserMapper.selectByPrimaryKey"</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å¯ä»¥æ¯”è¾ƒä»¥ä¸‹ä¸¤ç§ç¼–ç¨‹é£æ ¼ï¼Œå‘ç°ï¼Œç›´æ¥ä½¿ç”¨SqlSession è¿›è¡Œæ•°æ®åº“å¼€å‘å­˜åœ¨ä»£ç å¯è¯»æ€§å·®ã€å¯ç»´æŠ¤æ€§å·®çš„é—®é¢˜ï¼Œæ‰€ä»¥æˆ‘ä»¬å¾ˆå°‘ä½¿ç”¨ï¼Œè€Œæ˜¯ä½¿ç”¨Mapperæ¥å£çš„æ–¹å¼è¿›è¡Œæ•°æ®åº“çš„å¼€å‘ã€‚å®ç°çš„åŸºç¡€æ¶‰åŠé…ç½®æ–‡ä»¶çš„è§£è¯»ä»¥åŠåŠ¨æ€ä»£ç†çš„è¿ç”¨ã€‚</p><h2 id="1-æ ¸å¿ƒç±»"><a href="#1-æ ¸å¿ƒç±»" class="headerlink" title="1.æ ¸å¿ƒç±»"></a>1.æ ¸å¿ƒç±»</h2><p><img src="https://cdn.jsdelivr.net/gh/zyxelva/picgo@main/csdn/20210312105114200.png" alt="å›¾3"></p><h2 id="2-è¿è¡Œæµç¨‹"><a href="#2-è¿è¡Œæµç¨‹" class="headerlink" title="2.è¿è¡Œæµç¨‹"></a>2.è¿è¡Œæµç¨‹</h2><p><img src="https://cdn.jsdelivr.net/gh/zyxelva/picgo@main/csdn/20210312105706612.png" alt="å›¾4"></p><h1 id="ä¸‰ã€ä¸¾ä¸ªæ —å­"><a href="#ä¸‰ã€ä¸¾ä¸ªæ —å­" class="headerlink" title="ä¸‰ã€ä¸¾ä¸ªæ —å­"></a>ä¸‰ã€ä¸¾ä¸ªæ —å­</h1><p>demoå¦‚ä¸‹ï¼š</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Test</span><span class="token comment">// ç¨‹åºå‘˜å–œæ¬¢çš„é£æ ¼</span><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">quickStart</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">&#123;</span>    <span class="token comment">// 2.è·å–sqlSession</span>    <span class="token class-name">SqlSession</span> sqlSession <span class="token operator">=</span> sqlSessionFactory<span class="token punctuation">.</span><span class="token function">openSession</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 3.è·å–å¯¹åº”mapper</span>    <span class="token class-name">TUserMapper</span> mapper <span class="token operator">=</span> sqlSession<span class="token punctuation">.</span><span class="token function">getMapper</span><span class="token punctuation">(</span><span class="token class-name">TUserMapper</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 4.æ‰§è¡ŒæŸ¥è¯¢è¯­å¥å¹¶è¿”å›å•æ¡æ•°æ®</span>    <span class="token class-name">TUser</span> user <span class="token operator">=</span> mapper<span class="token punctuation">.</span><span class="token function">selectByPrimaryKey</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="1-æ‰“å¼€ä¸€ä¸ªä¼šè¯"><a href="#1-æ‰“å¼€ä¸€ä¸ªä¼šè¯" class="headerlink" title="1.æ‰“å¼€ä¸€ä¸ªä¼šè¯"></a>1.æ‰“å¼€ä¸€ä¸ªä¼šè¯</h2><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">SqlSession</span> sqlSession <span class="token operator">=</span> sqlSessionFactory<span class="token punctuation">.</span><span class="token function">openSession</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h2 id="2-DefaultSqlSessionFactory"><a href="#2-DefaultSqlSessionFactory" class="headerlink" title="2.DefaultSqlSessionFactory"></a>2.DefaultSqlSessionFactory</h2><p>æœ‰ä¸¤ä¸ªå®ç°ç±»ï¼Œä¸»è¦çœ‹DefaultSqlSessionFactory.<br><img src="https://cdn.jsdelivr.net/gh/zyxelva/picgo@main/csdn/2021031211034090.png" alt="å›¾5"></p><p>ç‚¹è¿›å»çœ‹çœ‹openSessionçš„æ–¹æ³•å†…å®¹</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Override</span><span class="token keyword">public</span> <span class="token class-name">SqlSession</span> <span class="token function">openSession</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">return</span> <span class="token function">openSessionFromDataSource</span><span class="token punctuation">(</span>configuration<span class="token punctuation">.</span><span class="token function">getDefaultExecutorType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>å…³é”®ç§ç§openSessionFromDataSourceè¿™ä¸ªæ–¹æ³•å¹²äº†ä»€ä¹ˆã€‚</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/**  * ä»æ•°æ®æºè·å–æ•°æ®åº“è¿æ¥  *  * @param execType   æ‰§è¡Œç±»å‹ï¼ŒExecutorTypeä¸»è¦æœ‰ä¸‰ç§ç±»å‹ï¼šSIMPLE, REUSE, BATCHï¼Œé»˜è®¤æ˜¯SIMPLEï¼Œéƒ½åœ¨æšä¸¾ç±»ExecutorTypeé‡Œé¢  * @param level      äº‹åŠ¡éš”ç¦»çº§åˆ«ï¼Œéƒ½åœ¨æšä¸¾ç±»TransactionIsolationLevelä¸­å®šä¹‰  * @param autoCommit æ˜¯å¦è‡ªåŠ¨æäº¤ï¼Œä¸»è¦æ˜¯äº‹åŠ¡æäº¤çš„è®¾ç½®  * @return SqlSession  */</span> <span class="token keyword">private</span> <span class="token class-name">SqlSession</span> <span class="token function">openSessionFromDataSource</span><span class="token punctuation">(</span><span class="token class-name">ExecutorType</span> execType<span class="token punctuation">,</span> <span class="token class-name">TransactionIsolationLevel</span> level<span class="token punctuation">,</span> <span class="token keyword">boolean</span> autoCommit<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>   <span class="token class-name">Transaction</span> tx <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>   <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>   <span class="token comment">//è·å–mybatisé…ç½®æ–‡ä»¶ä¸­çš„environmentå¯¹è±¡</span>     <span class="token keyword">final</span> <span class="token class-name">Environment</span> environment <span class="token operator">=</span> configuration<span class="token punctuation">.</span><span class="token function">getEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">//ä»environmentè·å–transactionFactoryå¯¹è±¡</span>     <span class="token keyword">final</span> <span class="token class-name">TransactionFactory</span> transactionFactory <span class="token operator">=</span> <span class="token function">getTransactionFactoryFromEnvironment</span><span class="token punctuation">(</span>environment<span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">//åˆ›å»ºäº‹åŠ¡å¯¹è±¡</span>     tx <span class="token operator">=</span> transactionFactory<span class="token punctuation">.</span><span class="token function">newTransaction</span><span class="token punctuation">(</span>environment<span class="token punctuation">.</span><span class="token function">getDataSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> level<span class="token punctuation">,</span> autoCommit<span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">//æ ¹æ®é…ç½®åˆ›å»ºexecutor</span>     <span class="token keyword">final</span> <span class="token class-name">Executor</span> executor <span class="token operator">=</span> configuration<span class="token punctuation">.</span><span class="token function">newExecutor</span><span class="token punctuation">(</span>tx<span class="token punctuation">,</span> execType<span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">//åˆ›å»ºDefaultSqlSession</span>     <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">DefaultSqlSession</span><span class="token punctuation">(</span>configuration<span class="token punctuation">,</span> executor<span class="token punctuation">,</span> autoCommit<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>     <span class="token comment">// may have fetched a connection so lets call close()</span>     <span class="token function">closeTransaction</span><span class="token punctuation">(</span>tx<span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token keyword">throw</span> <span class="token class-name">ExceptionFactory</span><span class="token punctuation">.</span><span class="token function">wrapException</span><span class="token punctuation">(</span><span class="token string">"Error opening session.  Cause: "</span> <span class="token operator">+</span> e<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token punctuation">&#125;</span> <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span>     <span class="token class-name">ErrorContext</span><span class="token punctuation">.</span><span class="token function">instance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token punctuation">&#125;</span> <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>é‡ç‚¹çœ‹çœ‹æ–°åˆ›å»ºçš„æ‰§è¡Œå™¨å’ŒDefaultSqlSessionã€‚</p><h2 id="3-newExecutor"><a href="#3-newExecutor" class="headerlink" title="3.newExecutor"></a>3.newExecutor</h2><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token class-name">Executor</span> <span class="token function">newExecutor</span><span class="token punctuation">(</span><span class="token class-name">Transaction</span> transaction<span class="token punctuation">,</span> <span class="token class-name">ExecutorType</span> executorType<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    executorType <span class="token operator">=</span> executorType <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">?</span> defaultExecutorType <span class="token operator">:</span> executorType<span class="token punctuation">;</span>    executorType <span class="token operator">=</span> executorType <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token class-name">ExecutorType</span><span class="token punctuation">.</span><span class="token constant">SIMPLE</span> <span class="token operator">:</span> executorType<span class="token punctuation">;</span>    <span class="token class-name">Executor</span> executor<span class="token punctuation">;</span>    <span class="token comment">//BatchExecutorã€SimpleExecutorå’ŒCachingExecutorä¸‰è€…ä¹‹ä¸€</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">ExecutorType</span><span class="token punctuation">.</span><span class="token constant">BATCH</span> <span class="token operator">==</span> executorType<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      executor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BatchExecutor</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> transaction<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">ExecutorType</span><span class="token punctuation">.</span><span class="token constant">REUSE</span> <span class="token operator">==</span> executorType<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      executor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReuseExecutor</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> transaction<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>      executor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SimpleExecutor</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> transaction<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">//å¦‚æœæœ‰&lt;cache>èŠ‚ç‚¹ï¼Œé€šè¿‡è£…é¥°å™¨ï¼Œæ·»åŠ äºŒçº§ç¼“å­˜çš„èƒ½åŠ›</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>cacheEnabled<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      executor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CachingExecutor</span><span class="token punctuation">(</span>executor<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">//é€šè¿‡interceptorChainéå†æ‰€æœ‰çš„æ’ä»¶ä¸ºexecutorå¢å¼ºï¼Œæ·»åŠ æ’ä»¶çš„åŠŸèƒ½</span>    executor <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Executor</span><span class="token punctuation">)</span> interceptorChain<span class="token punctuation">.</span><span class="token function">pluginAll</span><span class="token punctuation">(</span>executor<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> executor<span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="4-DefaultSqlSession"><a href="#4-DefaultSqlSession" class="headerlink" title="4.DefaultSqlSession"></a>4.DefaultSqlSession</h2><p>å†å»ç„ä¸‹DefaultSqlSessionå¹²äº†å•¥ã€‚</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token class-name">DefaultSqlSession</span><span class="token punctuation">(</span><span class="token class-name">Configuration</span> configuration<span class="token punctuation">,</span> <span class="token class-name">Executor</span> executor<span class="token punctuation">,</span> <span class="token keyword">boolean</span> autoCommit<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">this</span><span class="token punctuation">.</span>configuration <span class="token operator">=</span> configuration<span class="token punctuation">;</span>  <span class="token keyword">this</span><span class="token punctuation">.</span>executor <span class="token operator">=</span> executor<span class="token punctuation">;</span>  <span class="token keyword">this</span><span class="token punctuation">.</span>dirty <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>  <span class="token keyword">this</span><span class="token punctuation">.</span>autoCommit <span class="token operator">=</span> autoCommit<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>DefaultSqlSessionå®ç°äº†SqlSessionçš„æ–¹æ³•ã€‚<br><img src="https://cdn.jsdelivr.net/gh/zyxelva/picgo@main/csdn/20210312111811946.png" alt="å›¾6"><br>å½“æ‰§è¡Œä»¥ä¸‹ä»£ç æ—¶ï¼Œè°ƒç”¨çš„å…¶å®å°±æ˜¯DefaultSqlSessionç±»çš„selectOneæ–¹æ³•ï¼ˆæœ€ç»ˆè°ƒç”¨è¯¥ç±»ä¸‹çš„selectListæ–¹æ³•ï¼‰ï¼š</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Override</span><span class="token keyword">public</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> <span class="token class-name">T</span> <span class="token function">selectOne</span><span class="token punctuation">(</span><span class="token class-name">String</span> statement<span class="token punctuation">,</span> <span class="token class-name">Object</span> parameter<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token comment">// Popular vote was to return null on 0 results and throw exception on too many.</span>  <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> list <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span><span class="token function">selectList</span><span class="token punctuation">(</span>statement<span class="token punctuation">,</span> parameter<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>list<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">return</span> list<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>list<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">TooManyResultsException</span><span class="token punctuation">(</span><span class="token string">"Expected one result (or null) to be returned by selectOne(), but found: "</span> <span class="token operator">+</span> list<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token annotation punctuation">@Override</span><span class="token keyword">public</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">></span></span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">></span></span> <span class="token function">selectList</span><span class="token punctuation">(</span><span class="token class-name">String</span> statement<span class="token punctuation">,</span> <span class="token class-name">Object</span> parameter<span class="token punctuation">,</span> <span class="token class-name">RowBounds</span> rowBounds<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>    <span class="token comment">//ä»configurationä¸­è·å–è¦æ‰§è¡Œçš„sqlè¯­å¥çš„é…ç½®ä¿¡æ¯</span>    <span class="token class-name">MappedStatement</span> ms <span class="token operator">=</span> configuration<span class="token punctuation">.</span><span class="token function">getMappedStatement</span><span class="token punctuation">(</span>statement<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//é€šè¿‡executoræ‰§è¡Œè¯­å¥ï¼Œå¹¶è¿”å›æŒ‡å®šçš„ç»“æœé›†</span>    <span class="token keyword">return</span> executor<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>ms<span class="token punctuation">,</span> <span class="token function">wrapCollection</span><span class="token punctuation">(</span>parameter<span class="token punctuation">)</span><span class="token punctuation">,</span> rowBounds<span class="token punctuation">,</span> <span class="token class-name">Executor</span><span class="token punctuation">.</span><span class="token constant">NO_RESULT_HANDLER</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">throw</span> <span class="token class-name">ExceptionFactory</span><span class="token punctuation">.</span><span class="token function">wrapException</span><span class="token punctuation">(</span><span class="token string">"Error querying database.  Cause: "</span> <span class="token operator">+</span> e<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span> <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span>    <span class="token class-name">ErrorContext</span><span class="token punctuation">.</span><span class="token function">instance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="5-Executor"><a href="#5-Executor" class="headerlink" title="5.Executor"></a>5.Executor</h2><p>å…ˆå¤§è‡´äº†è§£ä¸‹Executorçš„ç±»ç»§æ‰¿å…³ç³»ã€‚<br><img src="https://cdn.jsdelivr.net/gh/zyxelva/picgo@main/csdn/20210312112927579.png" alt="å›¾7"><br>æ‰€ä»¥ï¼Œæˆ‘ä»¬é‡ç‚¹çœ‹çœ‹è¿™æ®µä»£ç çš„å¥¥ç§˜ã€‚</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">return</span> executor<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>ms<span class="token punctuation">,</span> <span class="token function">wrapCollection</span><span class="token punctuation">(</span>parameter<span class="token punctuation">)</span><span class="token punctuation">,</span> rowBounds<span class="token punctuation">,</span> <span class="token class-name">Executor</span><span class="token punctuation">.</span><span class="token constant">NO_RESULT_HANDLER</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>å…ˆçœ‹BaseExecutor.</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Override</span><span class="token keyword">public</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">></span></span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">></span></span> <span class="token function">query</span><span class="token punctuation">(</span><span class="token class-name">MappedStatement</span> ms<span class="token punctuation">,</span> <span class="token class-name">Object</span> parameter<span class="token punctuation">,</span> <span class="token class-name">RowBounds</span> rowBounds<span class="token punctuation">,</span> <span class="token class-name">ResultHandler</span> resultHandler<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">SQLException</span> <span class="token punctuation">&#123;</span><span class="token comment">//è·å–sqlè¯­å¥ä¿¡æ¯ï¼ŒåŒ…æ‹¬å ä½ç¬¦ï¼Œå‚æ•°ç­‰ä¿¡æ¯</span>  <span class="token class-name">BoundSql</span> boundSql <span class="token operator">=</span> ms<span class="token punctuation">.</span><span class="token function">getBoundSql</span><span class="token punctuation">(</span>parameter<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//æ‹¼è£…ç¼“å­˜çš„keyå€¼ï¼Œè¿™é‡Œåç»­è®²è®²keyçš„ç”Ÿæˆè§„åˆ™</span>  <span class="token class-name">CacheKey</span> key <span class="token operator">=</span> <span class="token function">createCacheKey</span><span class="token punctuation">(</span>ms<span class="token punctuation">,</span> parameter<span class="token punctuation">,</span> rowBounds<span class="token punctuation">,</span> boundSql<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token function">query</span><span class="token punctuation">(</span>ms<span class="token punctuation">,</span> parameter<span class="token punctuation">,</span> rowBounds<span class="token punctuation">,</span> resultHandler<span class="token punctuation">,</span> key<span class="token punctuation">,</span> boundSql<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token string">"unchecked"</span><span class="token punctuation">)</span><span class="token annotation punctuation">@Override</span><span class="token keyword">public</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">></span></span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">></span></span> <span class="token function">query</span><span class="token punctuation">(</span><span class="token class-name">MappedStatement</span> ms<span class="token punctuation">,</span> <span class="token class-name">Object</span> parameter<span class="token punctuation">,</span> <span class="token class-name">RowBounds</span> rowBounds<span class="token punctuation">,</span> <span class="token class-name">ResultHandler</span> resultHandler<span class="token punctuation">,</span> <span class="token class-name">CacheKey</span> key<span class="token punctuation">,</span> <span class="token class-name">BoundSql</span> boundSql<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">SQLException</span> <span class="token punctuation">&#123;</span>  <span class="token class-name">ErrorContext</span><span class="token punctuation">.</span><span class="token function">instance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">resource</span><span class="token punctuation">(</span>ms<span class="token punctuation">.</span><span class="token function">getResource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">activity</span><span class="token punctuation">(</span><span class="token string">"executing a query"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">object</span><span class="token punctuation">(</span>ms<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>closed<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">//æ£€æŸ¥å½“å‰executoræ˜¯å¦å…³é—­</span>    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ExecutorException</span><span class="token punctuation">(</span><span class="token string">"Executor was closed."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>queryStack <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> ms<span class="token punctuation">.</span><span class="token function">isFlushCacheRequired</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">//éåµŒå¥—æŸ¥è¯¢ï¼Œå¹¶ä¸”FlushCacheé…ç½®ä¸ºtrueï¼Œåˆ™éœ€è¦æ¸…ç©ºä¸€çº§ç¼“å­˜</span>    <span class="token function">clearLocalCache</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>  <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">></span></span> list<span class="token punctuation">;</span>  <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>    queryStack<span class="token operator">++</span><span class="token punctuation">;</span><span class="token comment">//æŸ¥è¯¢å±‚æ¬¡åŠ ä¸€</span>    list <span class="token operator">=</span> resultHandler <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">></span></span><span class="token punctuation">)</span> localCache<span class="token punctuation">.</span><span class="token function">getObject</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">;</span><span class="token comment">//æŸ¥è¯¢ä»¥åŠç¼“å­˜</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>list <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>   <span class="token comment">//é’ˆå¯¹è°ƒç”¨å­˜å‚¨è¿‡ç¨‹çš„ç»“æœå¤„ç†</span>      <span class="token function">handleLocallyCachedOutputParameters</span><span class="token punctuation">(</span>ms<span class="token punctuation">,</span> key<span class="token punctuation">,</span> parameter<span class="token punctuation">,</span> boundSql<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>   <span class="token comment">//ç¼“å­˜æœªå‘½ä¸­ï¼Œä»æ•°æ®åº“åŠ è½½æ•°æ®</span>      list <span class="token operator">=</span> <span class="token function">queryFromDatabase</span><span class="token punctuation">(</span>ms<span class="token punctuation">,</span> parameter<span class="token punctuation">,</span> rowBounds<span class="token punctuation">,</span> resultHandler<span class="token punctuation">,</span> key<span class="token punctuation">,</span> boundSql<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>  <span class="token punctuation">&#125;</span> <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span>    queryStack<span class="token operator">--</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>queryStack <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">DeferredLoad</span> deferredLoad <span class="token operator">:</span> deferredLoads<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">//å»¶è¿ŸåŠ è½½å¤„ç†</span>      deferredLoad<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">// issue #601</span>    deferredLoads<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>configuration<span class="token punctuation">.</span><span class="token function">getLocalCacheScope</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">LocalCacheScope</span><span class="token punctuation">.</span><span class="token constant">STATEMENT</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">//å¦‚æœå½“å‰sqlçš„ä¸€çº§ç¼“å­˜é…ç½®ä¸ºSTATEMENTï¼ŒæŸ¥è¯¢å®Œæ—¢æ¸…ç©ºä¸€é›†ç¼“å­˜</span>      <span class="token comment">// issue #482</span>      <span class="token function">clearLocalCache</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>  <span class="token punctuation">&#125;</span>  <span class="token keyword">return</span> list<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æˆ‘ä»¬å…ˆçœ‹ç¼“å­˜æœªå‘½ä¸­çš„éƒ¨åˆ†ï¼Œå³queryFromDatabaseæ–¹æ³•ã€‚</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">//çœŸæ­£è®¿é—®æ•°æ®åº“è·å–ç»“æœçš„æ–¹æ³•</span><span class="token keyword">private</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">></span></span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">></span></span> <span class="token function">queryFromDatabase</span><span class="token punctuation">(</span><span class="token class-name">MappedStatement</span> ms<span class="token punctuation">,</span> <span class="token class-name">Object</span> parameter<span class="token punctuation">,</span> <span class="token class-name">RowBounds</span> rowBounds<span class="token punctuation">,</span> <span class="token class-name">ResultHandler</span> resultHandler<span class="token punctuation">,</span> <span class="token class-name">CacheKey</span> key<span class="token punctuation">,</span> <span class="token class-name">BoundSql</span> boundSql<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">SQLException</span> <span class="token punctuation">&#123;</span>  <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">></span></span> list<span class="token punctuation">;</span>  localCache<span class="token punctuation">.</span><span class="token function">putObject</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token constant">EXECUTION_PLACEHOLDER</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//åœ¨ç¼“å­˜ä¸­æ·»åŠ å ä½ç¬¦</span>  <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>    <span class="token comment">//è°ƒç”¨æŠ½è±¡æ–¹æ³•doQueryï¼Œæ–¹æ³•æŸ¥è¯¢æ•°æ®åº“å¹¶è¿”å›ç»“æœï¼Œå¯é€‰çš„å®ç°åŒ…æ‹¬ï¼šsimpleã€reuseã€batch</span>    list <span class="token operator">=</span> <span class="token function">doQuery</span><span class="token punctuation">(</span>ms<span class="token punctuation">,</span> parameter<span class="token punctuation">,</span> rowBounds<span class="token punctuation">,</span> resultHandler<span class="token punctuation">,</span> boundSql<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span> <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span>    localCache<span class="token punctuation">.</span><span class="token function">removeObject</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//åœ¨ç¼“å­˜ä¸­åˆ é™¤å ä½ç¬¦</span>  <span class="token punctuation">&#125;</span>  localCache<span class="token punctuation">.</span><span class="token function">putObject</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> list<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//å°†çœŸæ­£çš„ç»“æœå¯¹è±¡æ·»åŠ åˆ°ä¸€çº§ç¼“å­˜</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>ms<span class="token punctuation">.</span><span class="token function">getStatementType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">StatementType</span><span class="token punctuation">.</span><span class="token constant">CALLABLE</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">//å¦‚æœæ˜¯è°ƒç”¨å­˜å‚¨è¿‡ç¨‹</span>    localOutputParameterCache<span class="token punctuation">.</span><span class="token function">putObject</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> parameter<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//ç¼“å­˜è¾“å‡ºç±»å‹ç»“æœå‚æ•°</span>  <span class="token punctuation">&#125;</span>  <span class="token keyword">return</span> list<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å…¶æœ€ç»ˆè°ƒç”¨SimpleExecutorçš„doQueryæ–¹æ³•ã€‚</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Override</span><span class="token comment">//æŸ¥è¯¢çš„å®ç°</span><span class="token keyword">public</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">></span></span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">></span></span> <span class="token function">doQuery</span><span class="token punctuation">(</span><span class="token class-name">MappedStatement</span> ms<span class="token punctuation">,</span> <span class="token class-name">Object</span> parameter<span class="token punctuation">,</span> <span class="token class-name">RowBounds</span> rowBounds<span class="token punctuation">,</span> <span class="token class-name">ResultHandler</span> resultHandler<span class="token punctuation">,</span> <span class="token class-name">BoundSql</span> boundSql<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">SQLException</span> <span class="token punctuation">&#123;</span>  <span class="token class-name">Statement</span> stmt <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>  <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>    <span class="token comment">//è·å–configurationå¯¹è±¡</span>    <span class="token class-name">Configuration</span> configuration <span class="token operator">=</span> ms<span class="token punctuation">.</span><span class="token function">getConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//åˆ›å»ºStatementHandlerå¯¹è±¡ï¼Œ</span>    <span class="token class-name">StatementHandler</span> handler <span class="token operator">=</span> configuration<span class="token punctuation">.</span><span class="token function">newStatementHandler</span><span class="token punctuation">(</span>wrapper<span class="token punctuation">,</span> ms<span class="token punctuation">,</span> parameter<span class="token punctuation">,</span> rowBounds<span class="token punctuation">,</span> resultHandler<span class="token punctuation">,</span> boundSql<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//StatementHandlerå¯¹è±¡åˆ›å»ºstmt,å¹¶ä½¿ç”¨parameterHandlerå¯¹å ä½ç¬¦è¿›è¡Œå¤„ç†</span>    stmt <span class="token operator">=</span> <span class="token function">prepareStatement</span><span class="token punctuation">(</span>handler<span class="token punctuation">,</span> ms<span class="token punctuation">.</span><span class="token function">getStatementLog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//é€šè¿‡statementHandlerå¯¹è±¡è°ƒç”¨ResultSetHandlerå°†ç»“æœé›†è½¬åŒ–ä¸ºæŒ‡å®šå¯¹è±¡è¿”å›</span>    <span class="token keyword">return</span> handler<span class="token punctuation">.</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">></span></span><span class="token function">query</span><span class="token punctuation">(</span>stmt<span class="token punctuation">,</span> resultHandler<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span> <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span>    <span class="token function">closeStatement</span><span class="token punctuation">(</span>stmt<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>çœ‹çœ‹doQueryæ–¹æ³•çš„å†…éƒ¨æ‰§è¡Œæ­¥éª¤ï¼š<br>ï¼ˆ1ï¼‰è·å–é…ç½®ä¿¡æ¯å¯¹è±¡ã€‚<br>ï¼ˆ2ï¼‰é€šè¿‡é…ç½®å¯¹è±¡è·å–ä¸€ä¸ªæ–°çš„StatementHandlerï¼Œè¯¥ç±»ä¸»è¦ç”¨æ¥å¤„ç†ä¸€æ¬¡SQLæ“ä½œã€‚<br>ï¼ˆ3ï¼‰é¢„å¤„ç†StatementHandlerå¯¹è±¡ï¼Œå¾—åˆ°Statementå¯¹è±¡ã€‚<br>ï¼ˆ4ï¼‰ä¼ å…¥Statementå’Œç»“æœå¤„ç†å¯¹è±¡ï¼Œé€šè¿‡StatementHandlerçš„queryæ–¹æ³•æ¥æ‰§è¡ŒSQLï¼Œå¹¶å¯¹æ‰§è¡Œç»“æœè¿›è¡Œå¤„ç†ã€‚</p><p>å…ˆçœ‹çœ‹newStatementHandlerå¹²äº†å•¥ã€‚</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token class-name">StatementHandler</span> <span class="token function">newStatementHandler</span><span class="token punctuation">(</span><span class="token class-name">Executor</span> executor<span class="token punctuation">,</span> <span class="token class-name">MappedStatement</span> mappedStatement<span class="token punctuation">,</span> <span class="token class-name">Object</span> parameterObject<span class="token punctuation">,</span> <span class="token class-name">RowBounds</span> rowBounds<span class="token punctuation">,</span> <span class="token class-name">ResultHandler</span> resultHandler<span class="token punctuation">,</span> <span class="token class-name">BoundSql</span> boundSql<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">//åˆ›å»ºRoutingStatementHandlerå¯¹è±¡ï¼Œå®é™…ç”±statmentTypeæ¥æŒ‡å®šçœŸå®çš„StatementHandleræ¥å®ç°</span><span class="token class-name">StatementHandler</span> statementHandler <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RoutingStatementHandler</span><span class="token punctuation">(</span>executor<span class="token punctuation">,</span> mappedStatement<span class="token punctuation">,</span> parameterObject<span class="token punctuation">,</span> rowBounds<span class="token punctuation">,</span> resultHandler<span class="token punctuation">,</span> boundSql<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//åŠ å…¥æ’ä»¶</span>  statementHandler <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">StatementHandler</span><span class="token punctuation">)</span> interceptorChain<span class="token punctuation">.</span><span class="token function">pluginAll</span><span class="token punctuation">(</span>statementHandler<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> statementHandler<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ç§ç§StatementHandlerçš„å°å¼Ÿä»¬ã€‚<br><img src="https://cdn.jsdelivr.net/gh/zyxelva/picgo@main/csdn/20210312114334576.png" alt="å›¾8"><br>æ€»ç»“ä¸‹StatementHandleræ˜¯å¹²å•¥çš„ï¼Œä»¥åŠå®ƒçš„å°å¼Ÿä»¬åˆ†åˆ«èƒ½å¹²å•¥ã€‚<br><img src="https://cdn.jsdelivr.net/gh/zyxelva/picgo@main/csdn/20210312114441395.png" alt="å›¾9"></p><p>å†çœ‹çœ‹prepareå¹²äº†å•¥ã€‚</p><pre class="line-numbers language-java" data-language="java"><code class="language-java">stmt <span class="token operator">=</span> handler<span class="token punctuation">.</span><span class="token function">prepare</span><span class="token punctuation">(</span>connection<span class="token punctuation">,</span> transaction<span class="token punctuation">.</span><span class="token function">getTimeout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>ä¸»è¦æ˜¯BaseStatementHandlerå¹²æ´»å„¿.</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Override</span><span class="token comment">//ä½¿ç”¨æ¨¡æ¿æ¨¡å¼ï¼Œå®šä¹‰äº†è·å–Statementçš„æ­¥éª¤ï¼Œå…¶å­ç±»å®ç°å®ä¾‹åŒ–Statementçš„å…·ä½“çš„æ–¹å¼ï¼›</span><span class="token keyword">public</span> <span class="token class-name">Statement</span> <span class="token function">prepare</span><span class="token punctuation">(</span><span class="token class-name">Connection</span> connection<span class="token punctuation">,</span> <span class="token class-name">Integer</span> transactionTimeout<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">SQLException</span> <span class="token punctuation">&#123;</span>  <span class="token class-name">ErrorContext</span><span class="token punctuation">.</span><span class="token function">instance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sql</span><span class="token punctuation">(</span>boundSql<span class="token punctuation">.</span><span class="token function">getSql</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token class-name">Statement</span> statement <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>  <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>    <span class="token comment">//é€šè¿‡ä¸åŒçš„å­ç±»å®ä¾‹åŒ–ä¸åŒçš„Statementï¼Œåˆ†ä¸ºä¸‰ç±»ï¼šsimple(statement)ã€prepare(prepareStatement)ã€callable(CallableStatementHandler)</span>    statement <span class="token operator">=</span> <span class="token function">instantiateStatement</span><span class="token punctuation">(</span>connection<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//è®¾ç½®è¶…æ—¶æ—¶é—´</span>    <span class="token function">setStatementTimeout</span><span class="token punctuation">(</span>statement<span class="token punctuation">,</span> transactionTimeout<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//è®¾ç½®æ•°æ®é›†å¤§å°</span>    <span class="token function">setFetchSize</span><span class="token punctuation">(</span>statement<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> statement<span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">SQLException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token function">closeStatement</span><span class="token punctuation">(</span>statement<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">throw</span> e<span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token function">closeStatement</span><span class="token punctuation">(</span>statement<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ExecutorException</span><span class="token punctuation">(</span><span class="token string">"Error preparing statement.  Cause: "</span> <span class="token operator">+</span> e<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>  æœ€åæ‰§è¡Œqueryæ–¹æ³•<br>  <pre class="line-numbers language-java" data-language="java"><code class="language-java">handler<span class="token punctuation">.</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">></span></span><span class="token function">query</span><span class="token punctuation">(</span>stmt<span class="token punctuation">,</span> resultHandler<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><br>è·å¾—ç»“æœé›†ã€‚ï¼ˆè¿™é‡Œé¢æœ‰ç»“æœé›†çš„å¤„ç†ï¼Œåç»­å†è®²ã€‚ï¼‰</p>]]></content>
      
      
      <categories>
          
          <category> MyBatisæºç å­¦ä¹  </category>
          
      </categories>
      
      
        <tags>
            
            <tag> MyBatis </tag>
            
            <tag> æºç  </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ã€MyBatisæºç å­¦ä¹ ã€‘åˆå§‹åŒ–é˜¶æ®µ</title>
      <link href="/posts/24693.html"/>
      <url>/posts/24693.html</url>
      
        <content type="html"><![CDATA[<h1 id="ä¸€ã€æ ¸å¿ƒé…ç½®ç±»"><a href="#ä¸€ã€æ ¸å¿ƒé…ç½®ç±»" class="headerlink" title="ä¸€ã€æ ¸å¿ƒé…ç½®ç±»"></a>ä¸€ã€æ ¸å¿ƒé…ç½®ç±»</h1><p>XMLConfigBuilderï¼š ä¸»è¦è´Ÿè´£è§£æmybatis-config.xmlï¼›<br>XMLMapperBuilderï¼š ä¸»è¦è´Ÿè´£è§£ææ˜ å°„é…ç½®Mapper.xml æ–‡ä»¶ï¼›<br>XMLStatementBuilderï¼š ä¸»è¦è´Ÿè´£è§£ææ˜ å°„é…ç½®æ–‡ä»¶ä¸­çš„SQL èŠ‚ç‚¹<br>ä¸‰è€…ä¹‹é—´çš„å…³ç³»ï¼Œå¦‚ä¸‹å›¾<br><img src="https://cdn.jsdelivr.net/gh/zyxelva/picgo@main/csdn/20210311160137766.png" alt="æ ¸å¿ƒé…ç½®ç±»ä¸‰å‰‘å®¢å…³ç³»å›¾"></p><h2 id="1-XMLConfigBuilder"><a href="#1-XMLConfigBuilder" class="headerlink" title="1.XMLConfigBuilder"></a>1.XMLConfigBuilder</h2><p>ä¸»è¦è´Ÿè´£è§£æmybatiså…³é”®é…ç½®æ–‡ä»¶mybatis-config.xmlï¼Œé‡ç‚¹å…³æ³¨91è¡Œï¼Œå…¨å±€å”¯ä¸€åˆå§‹åŒ–çš„å¤§é…ç½®ç±»ã€‚<img src="https://cdn.jsdelivr.net/gh/zyxelva/picgo@main/csdn/20210311161114699.png" alt="å›¾1"><br>é¢è¯•é¢˜ç»å¸¸ä¼šé—®ï¼Œä¸ºå•¥mybatisçš„é…ç½®ç±»Configurationæ˜¯å•ä¾‹çš„ï¼Ÿé¦–å…ˆæˆ‘ä»¬åœ¨BaseBuilderä¸­å‘ç°å®ƒæ˜¯finalç±»å‹çš„ï¼Œå…¶æ¬¡91è¡Œæ˜¯å…¨å±€å”¯ä¸€åˆå§‹åŒ–å®ƒçš„åœ°æ–¹ã€‚<br><img src="https://cdn.jsdelivr.net/gh/zyxelva/picgo@main/csdn/20210311161415639.png" alt="å›¾2"></p><h2 id="2-XMLMapperBuilder"><a href="#2-XMLMapperBuilder" class="headerlink" title="2.XMLMapperBuilder"></a>2.XMLMapperBuilder</h2><p>è´Ÿè´£è§£æ<em>mapper.xmlå’Œ</em>mapper.javaæ–‡ä»¶ï¼Œå…³é”®ä»£ç <br><img src="https://cdn.jsdelivr.net/gh/zyxelva/picgo@main/csdn/2021031116211879.png" alt="å›¾3"><br>é‡ç‚¹å…³æ³¨ä¸‹configurationElementæ–¹æ³•<br><img src="https://cdn.jsdelivr.net/gh/zyxelva/picgo@main/csdn/20210311162203404.png" alt="å›¾4"></p><h2 id="3-XMLStatementBuilder"><a href="#3-XMLStatementBuilder" class="headerlink" title="3.XMLStatementBuilder"></a>3.XMLStatementBuilder</h2><p>ä¸»è¦è´Ÿè´£è§£æ*mapper.xmlä¸­çš„selectã€insertã€updateã€deleteæ ‡ç­¾è¯­å¥ã€‚é‡ç‚¹å…³æ³¨ä¸‹è¿™ä¸ªæ–¹æ³•<br><img src="https://cdn.jsdelivr.net/gh/zyxelva/picgo@main/csdn/2021031116252489.png" alt="å›¾5"></p><h2 id="4-Configuration"><a href="#4-Configuration" class="headerlink" title="4.Configuration"></a>4.Configuration</h2><p><img src="https://cdn.jsdelivr.net/gh/zyxelva/picgo@main/csdn/20210311162859567.png" alt="å›¾6"></p><h1 id="äºŒã€æºç è¿½è¸ªåˆå§‹åŒ–æµç¨‹"><a href="#äºŒã€æºç è¿½è¸ªåˆå§‹åŒ–æµç¨‹" class="headerlink" title="äºŒã€æºç è¿½è¸ªåˆå§‹åŒ–æµç¨‹"></a>äºŒã€æºç è¿½è¸ªåˆå§‹åŒ–æµç¨‹</h1><h2 id="1-å‡†å¤‡å·¥ä½œ"><a href="#1-å‡†å¤‡å·¥ä½œ" class="headerlink" title="1.å‡†å¤‡å·¥ä½œ"></a>1.å‡†å¤‡å·¥ä½œ</h2><p>ç¼–å†™æµ‹è¯•ç±»</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MybatisDemo</span> <span class="token punctuation">&#123;</span><span class="token keyword">private</span> <span class="token class-name">SqlSessionFactory</span> sqlSessionFactory<span class="token punctuation">;</span><span class="token annotation punctuation">@Before</span><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">&#123;</span><span class="token comment">//--------------------ç¬¬ä¸€é˜¶æ®µ---------------------------</span>    <span class="token comment">// 1.1 è¯»å–mybatisé…ç½®æ–‡ä»¶åˆ›SqlSessionFactory</span><span class="token class-name">String</span> resource <span class="token operator">=</span> <span class="token string">"mybatis-config.xml"</span><span class="token punctuation">;</span><span class="token class-name">InputStream</span> inputStream <span class="token operator">=</span> <span class="token class-name">Resources</span><span class="token punctuation">.</span><span class="token function">getResourceAsStream</span><span class="token punctuation">(</span>resource<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 1.2 è¯»å–mybatisé…ç½®æ–‡ä»¶åˆ›SqlSessionFactory</span>sqlSessionFactory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SqlSessionFactoryBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span>inputStream<span class="token punctuation">)</span><span class="token punctuation">;</span>inputStream<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="2-æºç åˆ†æ"><a href="#2-æºç åˆ†æ" class="headerlink" title="2.æºç åˆ†æ"></a>2.æºç åˆ†æ</h2><h3 id="2-1-ç¬¬ä¸€é˜¶æ®µ"><a href="#2-1-ç¬¬ä¸€é˜¶æ®µ" class="headerlink" title="2.1.ç¬¬ä¸€é˜¶æ®µ"></a>2.1.ç¬¬ä¸€é˜¶æ®µ</h3><h4 id="2-1-1-ç”ŸæˆSqlSessionFactory"><a href="#2-1-1-ç”ŸæˆSqlSessionFactory" class="headerlink" title="2.1.1.ç”ŸæˆSqlSessionFactory"></a>2.1.1.ç”ŸæˆSqlSessionFactory</h4><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">// 1.1 è¯»å–mybatisé…ç½®æ–‡ä»¶åˆ›SqlSessionFactory</span><span class="token class-name">String</span> resource <span class="token operator">=</span> <span class="token string">"mybatis-config.xml"</span><span class="token punctuation">;</span><span class="token class-name">InputStream</span> inputStream <span class="token operator">=</span> <span class="token class-name">Resources</span><span class="token punctuation">.</span><span class="token function">getResourceAsStream</span><span class="token punctuation">(</span>resource<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>è¯»å–Mybaitsçš„ä¸»é…ç½®é…ç½®æ–‡ä»¶ï¼Œå¹¶è¿”å›è¯¥æ–‡ä»¶çš„è¾“å…¥æµï¼Œæˆ‘ä»¬çŸ¥é“Mybatisæ‰€æœ‰çš„SQLè¯­å¥éƒ½å†™åœ¨XMLé…ç½®æ–‡ä»¶é‡Œé¢,æ‰€ä»¥ç¬¬ä¸€æ­¥å°±éœ€è¦è¯»å–è¿™äº›XMLé…ç½®æ–‡ä»¶ï¼Œè¿™ä¸ªä¸éš¾ç†è§£ï¼Œå…³é”®æ˜¯è¯»å–æ–‡ä»¶åæ€ä¹ˆå­˜ã€‚</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">// 1.2 è¯»å–mybatisé…ç½®æ–‡ä»¶åˆ›SqlSessionFactory</span>sqlSessionFactory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SqlSessionFactoryBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span>inputStream<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>è¯»å–é…ç½®æ–‡ä»¶æµå¹¶å°†è¿™äº›é…ç½®ä¿¡æ¯å­˜æ”¾åˆ°Configurationç±»ä¸­.</p><h4 id="2-1-2-è§£æé…ç½®ï¼Œç”Ÿæˆconfigurationå¯¹è±¡"><a href="#2-1-2-è§£æé…ç½®ï¼Œç”Ÿæˆconfigurationå¯¹è±¡" class="headerlink" title="2.1.2.è§£æé…ç½®ï¼Œç”Ÿæˆconfigurationå¯¹è±¡"></a>2.1.2.è§£æé…ç½®ï¼Œç”Ÿæˆconfigurationå¯¹è±¡</h4><p>é‡ç‚¹å…³æ³¨ä¸‹SqlSessionFactoryBuilderçš„buildæ–¹æ³•ï¼Œä¸»è¦åˆ†ä¸ºä¸¤ç±»ï¼š</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">//å­—ç¬¦æµ</span><span class="token class-name">SqlSessionFactory</span> <span class="token function">build</span><span class="token punctuation">(</span><span class="token class-name">Reader</span> reader<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">SqlSessionFactory</span> <span class="token function">build</span><span class="token punctuation">(</span><span class="token class-name">Reader</span> reader<span class="token punctuation">,</span> <span class="token class-name">String</span> environment<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">SqlSessionFactory</span> <span class="token function">build</span><span class="token punctuation">(</span><span class="token class-name">Reader</span> reader<span class="token punctuation">,</span> <span class="token class-name">Properties</span> properties<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">SqlSessionFactory</span> <span class="token function">build</span><span class="token punctuation">(</span><span class="token class-name">Reader</span> reader<span class="token punctuation">,</span> <span class="token class-name">String</span> environment<span class="token punctuation">,</span> <span class="token class-name">Properties</span> properties<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//å­—èŠ‚æµ</span><span class="token class-name">SqlSessionFactory</span> <span class="token function">build</span><span class="token punctuation">(</span><span class="token class-name">InputStream</span> inputStream<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">SqlSessionFactory</span> <span class="token function">build</span><span class="token punctuation">(</span><span class="token class-name">InputStream</span> inputStream<span class="token punctuation">,</span> <span class="token class-name">String</span> environment<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">SqlSessionFactory</span> <span class="token function">build</span><span class="token punctuation">(</span><span class="token class-name">InputStream</span> inputStream<span class="token punctuation">,</span> <span class="token class-name">Properties</span> properties<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">SqlSessionFactory</span> <span class="token function">build</span><span class="token punctuation">(</span><span class="token class-name">InputStream</span> inputStream<span class="token punctuation">,</span> <span class="token class-name">String</span> environment<span class="token punctuation">,</span> <span class="token class-name">Properties</span> properties<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æˆ‘ä»¬åªçœ‹InputStreamå¯¹åº”çš„buildæ–¹æ³•å³å¯ï¼Œé¡ºå¸¦ä¸€æçš„æ˜¯ï¼Œå…¶å®æˆ‘ä»¬å¯ä»¥é€šè¿‡</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">Reader</span> reader<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">InputStreamReader</span><span class="token punctuation">(</span>inputStream<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>æ¥å°†Inputstreamè½¬æ¢ä¸ºReaderå¯¹è±¡ã€‚</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/**  * é€šè¿‡å­—èŠ‚æµåˆ›å»º SqlSessionFactory  *  * @param inputStream mybatisé…ç½®æ–‡ä»¶å¯¹åº”çš„å­—èŠ‚æµï¼ˆå¯ä»¥é€šè¿‡Reader reader=new InputStreamReader(inputStream);æ¥å°†Inputstreamè½¬æ¢ä¸ºReaderå¯¹è±¡ï¼‰  * @param environment æŒ‡å®šå½“å‰ä½¿ç”¨çš„ç¯å¢ƒæ ‡å¿—  * @param properties  ç”¨æˆ·è‡ªå®šä¹‰çš„å±æ€§å¯¹è±¡  * @return SqlSessionFactory  */</span> <span class="token keyword">public</span> <span class="token class-name">SqlSessionFactory</span> <span class="token function">build</span><span class="token punctuation">(</span><span class="token class-name">InputStream</span> inputStream<span class="token punctuation">,</span> <span class="token class-name">String</span> environment<span class="token punctuation">,</span> <span class="token class-name">Properties</span> properties<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>     <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>         <span class="token class-name">XMLConfigBuilder</span> parser <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">XMLConfigBuilder</span><span class="token punctuation">(</span>inputStream<span class="token punctuation">,</span> environment<span class="token punctuation">,</span> properties<span class="token punctuation">)</span><span class="token punctuation">;</span>         <span class="token keyword">return</span> <span class="token function">build</span><span class="token punctuation">(</span>parser<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>         <span class="token keyword">throw</span> <span class="token class-name">ExceptionFactory</span><span class="token punctuation">.</span><span class="token function">wrapException</span><span class="token punctuation">(</span><span class="token string">"Error building SqlSession."</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token punctuation">&#125;</span> <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span>         <span class="token class-name">ErrorContext</span><span class="token punctuation">.</span><span class="token function">instance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>         <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>             inputStream<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>         <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>             <span class="token comment">// Intentionally ignore. Prefer previous error.</span>         <span class="token punctuation">&#125;</span>     <span class="token punctuation">&#125;</span> <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ç‚¹è¿›å»XMLConfigBuilderçš„æ„é€ æ–¹æ³•</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">private</span> <span class="token class-name">XMLConfigBuilder</span><span class="token punctuation">(</span><span class="token class-name">XPathParser</span> parser<span class="token punctuation">,</span> <span class="token class-name">String</span> environment<span class="token punctuation">,</span> <span class="token class-name">Properties</span> props<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">//é‡ç‚¹åœ°æ–¹ï¼Œå…¨å±€å”¯ä¸€æ„é€ Configurationå¯¹è±¡çš„åœ°æ–¹</span>    <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Configuration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">ErrorContext</span><span class="token punctuation">.</span><span class="token function">instance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">resource</span><span class="token punctuation">(</span><span class="token string">"SQL Mapper Configuration"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>configuration<span class="token punctuation">.</span><span class="token function">setVariables</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>parsed <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>environment <span class="token operator">=</span> environment<span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>parser <span class="token operator">=</span> parser<span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å†å»ç§ç§XMLConfigBuilderçš„parseæ–¹æ³•ï¼Œé‡ç‚¹å…³æ³¨parseConfigurationæ–¹æ³•ã€‚</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token class-name">Configuration</span> <span class="token function">parse</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>parsed<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BuilderException</span><span class="token punctuation">(</span><span class="token string">"Each XMLConfigBuilder can only be used once."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>  parsed <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>  <span class="token function">parseConfiguration</span><span class="token punctuation">(</span>parser<span class="token punctuation">.</span><span class="token function">evalNode</span><span class="token punctuation">(</span><span class="token string">"/configuration"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> configuration<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">parseConfiguration</span><span class="token punctuation">(</span><span class="token class-name">XNode</span> root<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>    <span class="token comment">//issue #117 read properties first</span>   <span class="token comment">//è§£æ&lt;properties>èŠ‚ç‚¹</span>    <span class="token function">propertiesElement</span><span class="token punctuation">(</span>root<span class="token punctuation">.</span><span class="token function">evalNode</span><span class="token punctuation">(</span><span class="token string">"properties"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//è§£æ&lt;settings>èŠ‚ç‚¹</span>    <span class="token class-name">Properties</span> settings <span class="token operator">=</span> <span class="token function">settingsAsProperties</span><span class="token punctuation">(</span>root<span class="token punctuation">.</span><span class="token function">evalNode</span><span class="token punctuation">(</span><span class="token string">"settings"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">loadCustomVfs</span><span class="token punctuation">(</span>settings<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//è§£æ&lt;typeAliases>èŠ‚ç‚¹</span>    <span class="token function">typeAliasesElement</span><span class="token punctuation">(</span>root<span class="token punctuation">.</span><span class="token function">evalNode</span><span class="token punctuation">(</span><span class="token string">"typeAliases"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//è§£æ&lt;plugins>èŠ‚ç‚¹</span>    <span class="token function">pluginElement</span><span class="token punctuation">(</span>root<span class="token punctuation">.</span><span class="token function">evalNode</span><span class="token punctuation">(</span><span class="token string">"plugins"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//è§£æ&lt;objectFactory>èŠ‚ç‚¹</span>    <span class="token function">objectFactoryElement</span><span class="token punctuation">(</span>root<span class="token punctuation">.</span><span class="token function">evalNode</span><span class="token punctuation">(</span><span class="token string">"objectFactory"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//è§£æ&lt;objectWrapperFactory>èŠ‚ç‚¹</span>    <span class="token function">objectWrapperFactoryElement</span><span class="token punctuation">(</span>root<span class="token punctuation">.</span><span class="token function">evalNode</span><span class="token punctuation">(</span><span class="token string">"objectWrapperFactory"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//è§£æ&lt;reflectorFactory>èŠ‚ç‚¹</span>    <span class="token function">reflectorFactoryElement</span><span class="token punctuation">(</span>root<span class="token punctuation">.</span><span class="token function">evalNode</span><span class="token punctuation">(</span><span class="token string">"reflectorFactory"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//å°†settingså¡«å……åˆ°configuration</span>    <span class="token function">settingsElement</span><span class="token punctuation">(</span>settings<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// read it after objectFactory and objectWrapperFactory issue #631</span>    <span class="token comment">//è§£æ&lt;environments>èŠ‚ç‚¹</span>    <span class="token function">environmentsElement</span><span class="token punctuation">(</span>root<span class="token punctuation">.</span><span class="token function">evalNode</span><span class="token punctuation">(</span><span class="token string">"environments"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//è§£æ&lt;databaseIdProvider>èŠ‚ç‚¹</span>    <span class="token function">databaseIdProviderElement</span><span class="token punctuation">(</span>root<span class="token punctuation">.</span><span class="token function">evalNode</span><span class="token punctuation">(</span><span class="token string">"databaseIdProvider"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//è§£æ&lt;typeHandlers>èŠ‚ç‚¹</span>    <span class="token function">typeHandlerElement</span><span class="token punctuation">(</span>root<span class="token punctuation">.</span><span class="token function">evalNode</span><span class="token punctuation">(</span><span class="token string">"typeHandlers"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//è§£æ&lt;mappers>èŠ‚ç‚¹</span>    <span class="token function">mapperElement</span><span class="token punctuation">(</span>root<span class="token punctuation">.</span><span class="token function">evalNode</span><span class="token punctuation">(</span><span class="token string">"mappers"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BuilderException</span><span class="token punctuation">(</span><span class="token string">"Error parsing SQL Mapper Configuration. Cause: "</span> <span class="token operator">+</span> e<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ä»¥ä¸Šæ˜¯åˆ†æ</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">XMLConfigBuilder</span> parser <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">XMLConfigBuilder</span><span class="token punctuation">(</span>inputStream<span class="token punctuation">,</span> environment<span class="token punctuation">,</span> properties<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//è§£æé…ç½®æ–‡ä»¶å¾—åˆ°configurationå¯¹è±¡ï¼Œå¹¶è¿”å›SqlSessionFactory</span><span class="token keyword">return</span> <span class="token function">build</span><span class="token punctuation">(</span>parser<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>parser.parse()çš„éƒ¨åˆ†ï¼Œä¸‹é¢çœ‹çœ‹build()éƒ¨åˆ†ï¼š</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token class-name">SqlSessionFactory</span> <span class="token function">build</span><span class="token punctuation">(</span><span class="token class-name">Configuration</span> config<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">DefaultSqlSessionFactory</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>å¾ˆç®€å•ï¼Œå°±æ˜¯æŠŠè¯»å–é…ç½®æ–‡ä»¶åçš„Configurationå¯¹è±¡èµ‹ç»™DefaultSqlSessionFactoryï¼Œè¿”å›ä¸€ä¸ªæ„å»ºå¥½çš„sqlSessionFactoryï¼Œè€ŒDefaultSqlSessionFactoryæ˜¯SqlSessionFactoryçš„é»˜è®¤å®ç°. </p><h3 id="2-2-ç¬¬äºŒé˜¶æ®µ"><a href="#2-2-ç¬¬äºŒé˜¶æ®µ" class="headerlink" title="2.2.ç¬¬äºŒé˜¶æ®µ"></a>2.2.ç¬¬äºŒé˜¶æ®µ</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">// 2.è·å–sqlSession</span><span class="token class-name">SqlSession</span> sqlSession <span class="token operator">=</span> sqlSessionFactory<span class="token punctuation">.</span><span class="token function">openSession</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>é€šè¿‡è°ƒç”¨DefaultSqlSessionFactoryçš„openSessionæ–¹æ³•è¿”å›ä¸€ä¸ªSqlSessionå®ä¾‹,æˆ‘ä»¬çœ‹ä¸€ä¸‹å…·ä½“æ˜¯æ€ä¹ˆå¾—åˆ°ä¸€ä¸ªSqlSessionå®ä¾‹çš„ã€‚é¦–å…ˆè°ƒç”¨openSessionFromDataSourceæ–¹æ³•ã€‚<br>æ‘¸è¿›å»çœ‹çœ‹openSessionFromDataSource():</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/**  * ä»æ•°æ®æºè·å–æ•°æ®åº“è¿æ¥  *  * @param execType   æ‰§è¡Œç±»å‹ï¼ŒExecutorTypeä¸»è¦æœ‰ä¸‰ç§ç±»å‹ï¼šSIMPLE, REUSE, BATCHï¼Œé»˜è®¤æ˜¯SIMPLEï¼Œéƒ½åœ¨æšä¸¾ç±»ExecutorTypeé‡Œé¢  * @param level      äº‹åŠ¡éš”ç¦»çº§åˆ«ï¼Œéƒ½åœ¨æšä¸¾ç±»TransactionIsolationLevelä¸­å®šä¹‰  * @param autoCommit æ˜¯å¦è‡ªåŠ¨æäº¤ï¼Œä¸»è¦æ˜¯äº‹åŠ¡æäº¤çš„è®¾ç½®  * @return SqlSession DefaultSqlSessionæ˜¯SqlSessionçš„å®ç°ç±»ï¼Œè¯¥ç±»ä¸»è¦æä¾›æ“ä½œæ•°æ®åº“çš„æ–¹æ³•ç»™å¼€å‘äººå‘˜ä½¿ç”¨  */</span> <span class="token keyword">private</span> <span class="token class-name">SqlSession</span> <span class="token function">openSessionFromDataSource</span><span class="token punctuation">(</span><span class="token class-name">ExecutorType</span> execType<span class="token punctuation">,</span> <span class="token class-name">TransactionIsolationLevel</span> level<span class="token punctuation">,</span> <span class="token keyword">boolean</span> autoCommit<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>   <span class="token class-name">Transaction</span> tx <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>   <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>   <span class="token comment">//è·å–mybatisé…ç½®æ–‡ä»¶ä¸­çš„environmentå¯¹è±¡,åŒ…æ‹¬ä½¿ç”¨å“ªç§æ•°æ®åº“ï¼Œè¿æ¥æ•°æ®åº“çš„ä¿¡æ¯ï¼Œäº‹åŠ¡</span>     <span class="token keyword">final</span> <span class="token class-name">Environment</span> environment <span class="token operator">=</span> configuration<span class="token punctuation">.</span><span class="token function">getEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">//ä»environmentè·å–transactionFactoryå¯¹è±¡</span>     <span class="token keyword">final</span> <span class="token class-name">TransactionFactory</span> transactionFactory <span class="token operator">=</span> <span class="token function">getTransactionFactoryFromEnvironment</span><span class="token punctuation">(</span>environment<span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">//åˆ›å»ºäº‹åŠ¡å¯¹è±¡</span>     tx <span class="token operator">=</span> transactionFactory<span class="token punctuation">.</span><span class="token function">newTransaction</span><span class="token punctuation">(</span>environment<span class="token punctuation">.</span><span class="token function">getDataSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> level<span class="token punctuation">,</span> autoCommit<span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">//æ ¹æ®é…ç½®åˆ›å»ºexecutor</span>     <span class="token keyword">final</span> <span class="token class-name">Executor</span> executor <span class="token operator">=</span> configuration<span class="token punctuation">.</span><span class="token function">newExecutor</span><span class="token punctuation">(</span>tx<span class="token punctuation">,</span> execType<span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">//åˆ›å»ºDefaultSqlSession</span>     <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">DefaultSqlSession</span><span class="token punctuation">(</span>configuration<span class="token punctuation">,</span> executor<span class="token punctuation">,</span> autoCommit<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>     <span class="token comment">// may have fetched a connection so lets call close()</span>     <span class="token function">closeTransaction</span><span class="token punctuation">(</span>tx<span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token keyword">throw</span> <span class="token class-name">ExceptionFactory</span><span class="token punctuation">.</span><span class="token function">wrapException</span><span class="token punctuation">(</span><span class="token string">"Error opening session.  Cause: "</span> <span class="token operator">+</span> e<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token punctuation">&#125;</span> <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span>     <span class="token class-name">ErrorContext</span><span class="token punctuation">.</span><span class="token function">instance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token punctuation">&#125;</span> <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h1 id="ä¸‰ã€æ€»ç»“"><a href="#ä¸‰ã€æ€»ç»“" class="headerlink" title="ä¸‰ã€æ€»ç»“"></a>ä¸‰ã€æ€»ç»“</h1><p>æ­¥éª¤ä¸€ï¼šè¯»å–Mybatisçš„ä¸»é…ç½®æ–‡ä»¶ï¼Œå¹¶å°†æ–‡ä»¶è¯»æˆæ–‡ä»¶æµå½¢å¼(InputStream)ã€‚</p><p>æ­¥éª¤äºŒï¼šä»ä¸»é…ç½®æ–‡ä»¶æµä¸­è¯»å–æ–‡ä»¶çš„å„ä¸ªèŠ‚ç‚¹ä¿¡æ¯å¹¶å­˜æ”¾åˆ°Configurationå¯¹è±¡ä¸­ã€‚è¯»å–mappersèŠ‚ç‚¹çš„å¼•ç”¨æ–‡ä»¶ï¼Œå¹¶å°†è¿™äº›æ–‡ä»¶çš„å„ä¸ªèŠ‚ç‚¹ä¿¡æ¯å­˜æ”¾åˆ°Configurationå¯¹è±¡ã€‚</p><p>æ­¥éª¤ä¸‰ï¼šæ ¹æ®Configurationå¯¹è±¡çš„ä¿¡æ¯è·å–æ•°æ®åº“è¿æ¥ï¼Œå¹¶è®¾ç½®è¿æ¥çš„äº‹åŠ¡éš”ç¦»çº§åˆ«ç­‰ä¿¡æ¯ï¼Œå°†ç»è¿‡åŒ…è£…æ•°æ®åº“è¿æ¥å¯¹è±¡SqlSessionæ¥å£è¿”å›ï¼ŒDefaultSqlSessionæ˜¯SqlSessionçš„å®ç°ç±»ï¼Œæ‰€ä»¥è¿™é‡Œè¿”å›çš„æ˜¯DefaultSqlSessionï¼ŒSqlSessionæ¥å£é‡Œé¢å°±æ˜¯å¯¹å¤–æä¾›çš„å„ç§æ•°æ®åº“æ“ä½œã€‚</p>]]></content>
      
      
      <categories>
          
          <category> MyBatisæºç å­¦ä¹  </category>
          
      </categories>
      
      
        <tags>
            
            <tag> MyBatis </tag>
            
            <tag> æºç  </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ã€LeetCodeã€‘987.äºŒå‰æ ‘çš„å‚åºéå†</title>
      <link href="/posts/46588.html"/>
      <url>/posts/46588.html</url>
      
        <content type="html"><![CDATA[<h1 id="1-é—®é¢˜"><a href="#1-é—®é¢˜" class="headerlink" title="1.é—®é¢˜"></a>1.é—®é¢˜</h1><p>ç»™ä½ äºŒå‰æ ‘çš„æ ¹ç»“ç‚¹ root ï¼Œè¯·ä½ è®¾è®¡ç®—æ³•è®¡ç®—äºŒå‰æ ‘çš„ å‚åºéå† åºåˆ—ã€‚</p><p>å¯¹ä½äº (row, col) çš„æ¯ä¸ªç»“ç‚¹è€Œè¨€ï¼Œå…¶å·¦å³å­ç»“ç‚¹åˆ†åˆ«ä½äº (row + 1, col - 1) å’Œ (row + 1, col + 1) ã€‚æ ‘çš„æ ¹ç»“ç‚¹ä½äº (0, 0) ã€‚</p><p>äºŒå‰æ ‘çš„ <strong>å‚åºéå†</strong> ä»æœ€å·¦è¾¹çš„åˆ—å¼€å§‹ç›´åˆ°æœ€å³è¾¹çš„åˆ—ç»“æŸï¼ŒæŒ‰åˆ—ç´¢å¼•æ¯ä¸€åˆ—ä¸Šçš„æ‰€æœ‰ç»“ç‚¹ï¼Œå½¢æˆä¸€ä¸ªæŒ‰å‡ºç°ä½ç½®ä»ä¸Šåˆ°ä¸‹æ’åºçš„æœ‰åºåˆ—è¡¨ã€‚å¦‚æœåŒè¡ŒåŒåˆ—ä¸Šæœ‰å¤šä¸ªç»“ç‚¹ï¼Œåˆ™æŒ‰ç»“ç‚¹çš„å€¼ä»å°åˆ°å¤§è¿›è¡Œæ’åºã€‚</p><p>è¿”å›äºŒå‰æ ‘çš„ <strong>å‚åºéå†</strong> åºåˆ—ã€‚</p><h2 id="ç¤ºä¾‹-1"><a href="#ç¤ºä¾‹-1" class="headerlink" title="ç¤ºä¾‹ 1"></a>ç¤ºä¾‹ 1</h2><p><img src="https://cdn.jsdelivr.net/gh/zyxelva/picgo@main/csdn/e04967e5622978d8f038f3f484c96344.jpeg" alt="å›¾1"></p><blockquote><p>è¾“å…¥ï¼šroot &#x3D; [3,9,20,null,null,15,7]<br>è¾“å‡ºï¼š[[9],[3,15],[20],[7]]</p></blockquote><p><strong>è§£é‡Š</strong>ï¼š<br>åˆ— -1 ï¼šåªæœ‰ç»“ç‚¹ 9 åœ¨æ­¤åˆ—ä¸­ã€‚<br>åˆ—  0 ï¼šåªæœ‰ç»“ç‚¹ 3 å’Œ 15 åœ¨æ­¤åˆ—ä¸­ï¼ŒæŒ‰ä»ä¸Šåˆ°ä¸‹é¡ºåºã€‚<br>åˆ—  1 ï¼šåªæœ‰ç»“ç‚¹ 20 åœ¨æ­¤åˆ—ä¸­ã€‚<br>åˆ—  2 ï¼šåªæœ‰ç»“ç‚¹ 7 åœ¨æ­¤åˆ—ä¸­ã€‚</p><h2 id="ç¤ºä¾‹-2"><a href="#ç¤ºä¾‹-2" class="headerlink" title="ç¤ºä¾‹ 2"></a>ç¤ºä¾‹ 2</h2><p><img src="https://cdn.jsdelivr.net/gh/zyxelva/picgo@main/csdn/928311391554fa02c32df8d2fe82f29f.jpeg" alt="å›¾2"></p><blockquote><p>è¾“å…¥ï¼šroot &#x3D; [1,2,3,4,5,6,7]<br>è¾“å‡ºï¼š[[4],[2],[1,5,6],[3],[7]]</p></blockquote><p><strong>è§£é‡Š</strong>ï¼š<br>åˆ— -2 ï¼šåªæœ‰ç»“ç‚¹ 4 åœ¨æ­¤åˆ—ä¸­ã€‚<br>åˆ— -1 ï¼šåªæœ‰ç»“ç‚¹ 2 åœ¨æ­¤åˆ—ä¸­ã€‚<br>åˆ—  0 ï¼šç»“ç‚¹ 1 ã€5 å’Œ 6 éƒ½åœ¨æ­¤åˆ—ä¸­ã€‚<br>          1 åœ¨ä¸Šé¢ï¼Œæ‰€ä»¥å®ƒå‡ºç°åœ¨å‰é¢ã€‚<br>          5 å’Œ 6 ä½ç½®éƒ½æ˜¯ (2, 0) ï¼Œæ‰€ä»¥æŒ‰å€¼ä»å°åˆ°å¤§æ’åºï¼Œ5 åœ¨ 6 çš„å‰é¢ã€‚<br>åˆ—  1 ï¼šåªæœ‰ç»“ç‚¹ 3 åœ¨æ­¤åˆ—ä¸­ã€‚<br>åˆ—  2 ï¼šåªæœ‰ç»“ç‚¹ 7 åœ¨æ­¤åˆ—ä¸­ã€‚</p><h2 id="ç¤ºä¾‹-3"><a href="#ç¤ºä¾‹-3" class="headerlink" title="ç¤ºä¾‹ 3"></a>ç¤ºä¾‹ 3</h2><p><img src="https://cdn.jsdelivr.net/gh/zyxelva/picgo@main/csdn/21f2fd6f20821d1e1279984777466b85.jpeg" alt="å›¾3"></p><blockquote><p>è¾“å…¥ï¼šroot &#x3D; [1,2,3,4,6,5,7]<br>è¾“å‡ºï¼š[[4],[2],[1,5,6],[3],[7]]</p></blockquote><p><strong>è§£é‡Š</strong>ï¼š<br>è¿™ä¸ªç¤ºä¾‹å®é™…ä¸Šä¸ç¤ºä¾‹ 2 å®Œå…¨ç›¸åŒï¼Œåªæ˜¯ç»“ç‚¹ 5 å’Œ 6 åœ¨æ ‘ä¸­çš„ä½ç½®å‘ç”Ÿäº†äº¤æ¢ã€‚<br>å› ä¸º 5 å’Œ 6 çš„ä½ç½®ä»ç„¶ç›¸åŒï¼Œæ‰€ä»¥ç­”æ¡ˆä¿æŒä¸å˜ï¼Œä»ç„¶æŒ‰å€¼ä»å°åˆ°å¤§æ’åºã€‚</p><p><strong>æç¤º</strong>ï¼š</p><ul><li>æ ‘ä¸­ç»“ç‚¹æ•°ç›®æ€»æ•°åœ¨èŒƒå›´ [1, 1000] å†…</li><li>0 &lt;&#x3D; Node.val &lt;&#x3D; 1000</li></ul><h1 id="2-è§£é¢˜æ€è·¯"><a href="#2-è§£é¢˜æ€è·¯" class="headerlink" title="2.è§£é¢˜æ€è·¯"></a>2.è§£é¢˜æ€è·¯</h1><p>ä»ç¤ºä¾‹å¯ä»¥å¾—å‡ºï¼Œæœ€ç»ˆç­”æ¡ˆæ˜¯å…ˆæŒ‰åˆ—å·ä»å°åˆ°å¤§æ’åˆ—ï¼Œåˆ—å·ç›¸åŒå†æŒ‰è¡Œå·ä»å°åˆ°å¤§ï¼Œè¡Œå·ç›¸åŒå†æŒ‰å€¼ä»å°åˆ°å¤§è¾“å‡ºã€‚å› è€Œæˆ‘ä»¬åœ¨éå†äºŒå‰æ ‘æ—¶éœ€è¦ç»Ÿè®¡å„ä¸ªèŠ‚ç‚¹(åˆ—å·ï¼Œè¡Œå·ï¼Œå€¼)çš„ä¸‰å…ƒç»„ï¼Œç„¶åæŒ‰ç…§åˆ—å·ã€è¡Œå·ã€å€¼çš„å‡åºæ’åˆ—ï¼Œæœ€åè¾“å‡ºç»“æœã€‚</p><ul><li>å®šä¹‰ä¸€ä¸ªmapï¼Œkeyä¸ºèŠ‚ç‚¹ï¼Œvalueå­˜å‚¨è¯¥èŠ‚ç‚¹çš„åˆ—å·ï¼Œè¡Œå·ï¼Œå€¼</li><li>æ·±åº¦ä¼˜å…ˆç®—æ³•ï¼Œéå†å„ä¸ªèŠ‚ç‚¹ï¼Œè®°å½•å„èŠ‚ç‚¹ åˆ—å·ã€è¡Œå·ã€å€¼ï¼Œä¿å­˜è‡³mapä¸­</li><li>å¯¹mapçš„valuesæŒ‰ç…§æ’åºè§„åˆ™è¿›è¡Œæ’åº</li></ul><p><strong>å¤æ‚åº¦</strong>ï¼š</p><ul><li>æ—¶é—´å¤æ‚åº¦ï¼šä»¤æ€»èŠ‚ç‚¹æ•°é‡ä¸º nï¼Œå¡«å……å“ˆå¸Œè¡¨æ—¶è¿›è¡Œæ ‘çš„éå†ï¼Œå¤æ‚åº¦ä¸º O(n)ï¼›æ„é€ ç­”æ¡ˆæ—¶éœ€è¦è¿›è¡Œæ’åºï¼Œå¤æ‚åº¦ä¸º O(nlogâ¡n)ã€‚æ•´ä½“å¤æ‚åº¦ä¸º O(nlogâ¡n)</li><li>ç©ºé—´å¤æ‚åº¦ï¼šO(n)</li></ul><h1 id="3-ä»£ç "><a href="#3-ä»£ç " class="headerlink" title="3.ä»£ç "></a>3.ä»£ç </h1><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/** * Definition for a binary tree node. * public class TreeNode &#123; *     int val; *     TreeNode left; *     TreeNode right; *     TreeNode() &#123;&#125; *     TreeNode(int val) &#123; this.val = val; &#125; *     TreeNode(int val, TreeNode left, TreeNode right) &#123; *         this.val = val; *         this.left = left; *         this.right = right; *     &#125; * &#125; */</span><span class="token keyword">class</span> <span class="token class-name">Solution</span> <span class="token punctuation">&#123;</span>    <span class="token comment">//è®°å½•èŠ‚ç‚¹ åˆ—å·ã€è¡Œå·ã€å€¼</span>    <span class="token class-name">Map</span><span class="token operator">&lt;</span><span class="token class-name">TreeNode</span><span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">></span> map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">></span><span class="token punctuation">></span></span> <span class="token function">verticalTraversal</span><span class="token punctuation">(</span><span class="token class-name">TreeNode</span> root<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token comment">//ç¤ºä¾‹è§„åˆ™ï¼Œå…ˆæŒ‰åˆ—å·ä»å°åˆ°å¤§æ’åˆ—ï¼Œåˆ—å·ç›¸åŒå†æŒ‰è¡Œå·ä»å°åˆ°å¤§ï¼Œè¡Œå·ç›¸åŒå†æŒ‰å€¼ä»å°åˆ°å¤§è¾“å‡º</span>        <span class="token comment">//å®šä¹‰ä¸€ä¸ªmap,keyä¸ºèŠ‚ç‚¹ï¼Œvalueå­˜å‚¨è¯¥èŠ‚ç‚¹çš„ åˆ—å·ï¼Œè¡Œå·ï¼Œå€¼</span>        <span class="token comment">//æ·±åº¦ä¼˜å…ˆç®—æ³•ï¼Œéå†å„ä¸ªèŠ‚ç‚¹ï¼Œè®°å½•å„èŠ‚ç‚¹ åˆ—å·ã€è¡Œå·ã€å€¼ï¼Œä¿å­˜è‡³mapä¸­</span>        <span class="token comment">//å¯¹mapçš„valuesæŒ‰ç…§æ’åºè§„åˆ™è¿›è¡Œæ’åº</span>                <span class="token comment">//root - map</span>        map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span><span class="token keyword">new</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>root<span class="token punctuation">.</span>val<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">dfs</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">//å„èŠ‚ç‚¹ éå†çš„ä¿¡æ¯åˆ—è¡¨</span>        <span class="token class-name">List</span><span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">></span> list<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span>map<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">//æ’åº</span>        <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span>list<span class="token punctuation">,</span> <span class="token punctuation">(</span>a<span class="token punctuation">,</span>b<span class="token punctuation">)</span><span class="token operator">-></span><span class="token punctuation">&#123;</span>            <span class="token comment">//ä¼˜å…ˆæŒ‰åˆ—æ¯”è¾ƒ</span>            <span class="token keyword">if</span><span class="token punctuation">(</span>a<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">!=</span>b<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>                <span class="token keyword">return</span> a<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">-</span>b<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>            <span class="token comment">//å…¶æ¬¡ æŒ‰è¡Œå·æ¯”è¾ƒ</span>            <span class="token keyword">if</span><span class="token punctuation">(</span>a<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">!=</span>b<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>                <span class="token keyword">return</span> a<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">-</span>b<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>            <span class="token comment">//æœ€åï¼ŒæŒ‰å€¼æ¯”è¾ƒ</span>            <span class="token keyword">return</span> a<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token operator">-</span>b<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">//éå†listï¼Œè¾“å‡ºç»“æœé›†</span>        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">></span><span class="token punctuation">></span></span> res<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">></span></span> tmp<span class="token punctuation">;</span>        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>list<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            <span class="token keyword">int</span> j<span class="token operator">=</span>i<span class="token punctuation">;</span>            tmp<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment">//åˆ—å·ç›¸åŒçš„</span>            <span class="token keyword">while</span><span class="token punctuation">(</span>j<span class="token operator">&lt;</span>list<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> list<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>j<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">==</span>list<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>                tmp<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>list<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>j<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                j<span class="token operator">++</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>            res<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>tmp<span class="token punctuation">)</span><span class="token punctuation">;</span>            i<span class="token operator">=</span>j<span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">return</span> res<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">dfs</span><span class="token punctuation">(</span><span class="token class-name">TreeNode</span> node<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token operator">==</span>node<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            <span class="token keyword">return</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> nodeColRowVal<span class="token operator">=</span>map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">int</span> nodeCol<span class="token operator">=</span>nodeColRowVal<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token keyword">int</span> nodeRow<span class="token operator">=</span>nodeColRowVal<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token keyword">int</span> value<span class="token operator">=</span>nodeColRowVal<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token comment">//å·¦å­æ ‘</span>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token operator">!=</span>node<span class="token punctuation">.</span>left<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>left<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span>nodeCol<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> nodeRow<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span> node<span class="token punctuation">.</span>left<span class="token punctuation">.</span>val<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">dfs</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>left<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token comment">//å³å­æ ‘</span>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token operator">!=</span>node<span class="token punctuation">.</span>right<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>right<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span>nodeCol<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span> nodeRow<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span> node<span class="token punctuation">.</span>right<span class="token punctuation">.</span>val<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">dfs</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>right<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> ç®—æ³• </category>
          
      </categories>
      
      
        <tags>
            
            <tag> LeetCode </tag>
            
            <tag> ç®—æ³• </tag>
            
            <tag> äºŒå‰æ ‘ </tag>
            
            <tag> æ•°æ®ç»“æ„ </tag>
            
            <tag> Java </tag>
            
            <tag> DFS </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ã€LeetCodeã€‘103.äºŒå‰æ ‘çš„é”¯é½¿å½¢å±‚åºéå†(ä¹‹å­—å½¢éå†)</title>
      <link href="/posts/637.html"/>
      <url>/posts/637.html</url>
      
        <content type="html"><![CDATA[<h1 id="1-é—®é¢˜"><a href="#1-é—®é¢˜" class="headerlink" title="1.é—®é¢˜"></a>1.é—®é¢˜</h1><p>ç»™ä½ äºŒå‰æ ‘çš„æ ¹èŠ‚ç‚¹ root ï¼Œè¿”å›å…¶èŠ‚ç‚¹å€¼çš„ é”¯é½¿å½¢å±‚åºéå† ã€‚ï¼ˆå³å…ˆä»å·¦å¾€å³ï¼Œå†ä»å³å¾€å·¦è¿›è¡Œä¸‹ä¸€å±‚éå†ï¼Œä»¥æ­¤ç±»æ¨ï¼Œå±‚ä¸å±‚ä¹‹é—´äº¤æ›¿è¿›è¡Œï¼‰ã€‚</p><p>ç¤ºä¾‹ 1ï¼š</p><p><img src="https://cdn.jsdelivr.net/gh/zyxelva/picgo@main/csdn/1e841d2f824fe1aeb776c1755d367ca1.jpeg" alt="å›¾1"></p><blockquote><p>è¾“å…¥ï¼šroot &#x3D; [3,9,20,null,null,15,7]<br>è¾“å‡ºï¼š[[3],[20,9],[15,7]]</p></blockquote><p>ç¤ºä¾‹ 2ï¼š</p><blockquote><p>è¾“å…¥ï¼šroot &#x3D; [1]<br>è¾“å‡ºï¼š[[1]]</p></blockquote><p>ç¤ºä¾‹ 3ï¼š</p><blockquote><p>è¾“å…¥ï¼šroot &#x3D; []<br>è¾“å‡ºï¼š[]</p></blockquote><p><strong>æç¤º</strong>ï¼š</p><ul><li>æ ‘ä¸­èŠ‚ç‚¹æ•°ç›®åœ¨èŒƒå›´ [0, 2000] å†…</li><li>-100 &lt;&#x3D; Node.val &lt;&#x3D; 100</li></ul><h1 id="2-è§£é¢˜æ€è·¯"><a href="#2-è§£é¢˜æ€è·¯" class="headerlink" title="2.è§£é¢˜æ€è·¯"></a>2.è§£é¢˜æ€è·¯</h1><p>ä»ç»“æœé›†æ¥çœ‹ï¼Œè¯¥é¢˜æ˜¯<a href="https://zyxelva.github.io/posts/46738.html">102.äºŒå‰æ ‘çš„å±‚åºéå†</a>ï¼Œ<a href="https://zyxelva.github.io/posts/45075.html">107.äºŒå‰æ ‘çš„å±‚åºéå†II</a>çš„ç»“åˆï¼Œæ¯å±‚æ—¢æœ‰æ­£åºè¾“å‡ºï¼Œåˆæœ‰é€†åºè¾“å‡ºã€‚åªè¦ç»™å®šä¸€ä¸ªæ ‡è¯†ï¼Œå¥‡æ•°å±‚æ­£åºè¾“å‡ºï¼Œè€Œå¶æ•°å±‚é€†åºè¾“å‡ºå³å¯è§£å†³ã€‚</p><h1 id="3-ä»£ç "><a href="#3-ä»£ç " class="headerlink" title="3.ä»£ç "></a>3.ä»£ç </h1><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/** * Definition for a binary tree node. * public class TreeNode &#123; *     int val; *     TreeNode left; *     TreeNode right; *     TreeNode() &#123;&#125; *     TreeNode(int val) &#123; this.val = val; &#125; *     TreeNode(int val, TreeNode left, TreeNode right) &#123; *         this.val = val; *         this.left = left; *         this.right = right; *     &#125; * &#125; */</span><span class="token keyword">class</span> <span class="token class-name">Solution</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">></span><span class="token punctuation">></span></span> <span class="token function">zigzagLevelOrder</span><span class="token punctuation">(</span><span class="token class-name">TreeNode</span> root<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token comment">//åˆ©ç”¨å±‚åºéå†ï¼Œå¥‡æ•°å±‚ä»å·¦å¾€å³ï¼Œå¶æ•°å±‚ä»å³å¾€å·¦</span>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">==</span> root<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">></span><span class="token punctuation">></span></span> res<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">></span></span> tempList<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TreeNode</span><span class="token punctuation">></span></span> temp<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TreeNode</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        temp<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span><span class="token punctuation">;</span>        temp<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">TreeNode</span> node<span class="token punctuation">;</span>        <span class="token keyword">int</span> layer<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>        <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token operator">!</span>temp<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            node<span class="token operator">=</span>temp<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">!=</span> node<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>                <span class="token comment">//å¥‡æ•°å±‚ä»å·¦å¾€å³ï¼Œå¶æ•°å±‚ä»å³å¾€å·¦</span>                <span class="token keyword">if</span><span class="token punctuation">(</span>layer<span class="token operator">%</span><span class="token number">2</span><span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>                    tempList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> node<span class="token punctuation">.</span>val<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>                    tempList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>val<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">&#125;</span>                <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token operator">!=</span>node<span class="token punctuation">.</span>left<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>                    temp<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>left<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">&#125;</span>                <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token operator">!=</span>node<span class="token punctuation">.</span>right<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>                    temp<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>right<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">&#125;</span>            <span class="token punctuation">&#125;</span>             <span class="token comment">//æœ¬å±‚å·²éå†å®Œæ¯•</span>            <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>tempList<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>                res<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>tempList<span class="token punctuation">)</span><span class="token punctuation">;</span>                tempList<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                temp<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                layer<span class="token operator">++</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">return</span> res<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> ç®—æ³• </category>
          
      </categories>
      
      
        <tags>
            
            <tag> LeetCode </tag>
            
            <tag> ç®—æ³• </tag>
            
            <tag> äºŒå‰æ ‘ </tag>
            
            <tag> æ•°æ®ç»“æ„ </tag>
            
            <tag> Java </tag>
            
            <tag> BFS </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ã€LeetCodeã€‘107.äºŒå‰æ ‘çš„å±‚åºéå†II</title>
      <link href="/posts/45075.html"/>
      <url>/posts/45075.html</url>
      
        <content type="html"><![CDATA[<h1 id="1-é—®é¢˜"><a href="#1-é—®é¢˜" class="headerlink" title="1.é—®é¢˜"></a>1.é—®é¢˜</h1><p>ç»™ä½ äºŒå‰æ ‘çš„æ ¹èŠ‚ç‚¹ root ï¼Œè¿”å›å…¶èŠ‚ç‚¹å€¼ è‡ªåº•å‘ä¸Šçš„å±‚åºéå† ã€‚ ï¼ˆå³æŒ‰ä»å¶å­èŠ‚ç‚¹æ‰€åœ¨å±‚åˆ°æ ¹èŠ‚ç‚¹æ‰€åœ¨çš„å±‚ï¼Œé€å±‚ä»å·¦å‘å³éå†ï¼‰<br>ç¤ºä¾‹ 1ï¼š</p><p><img src="https://cdn.jsdelivr.net/gh/zyxelva/picgo@main/csdn/956745c1eb8e7500919a008256ec9311.jpeg" alt="å›¾1"></p><blockquote><p>è¾“å…¥ï¼šroot &#x3D; [3,9,20,null,null,15,7]<br>è¾“å‡ºï¼š[[15,7],[9,20],[3]]</p></blockquote><p>ç¤ºä¾‹ 2ï¼š</p><blockquote><p>è¾“å…¥ï¼šroot &#x3D; [1]<br>è¾“å‡ºï¼š[[1]]</p></blockquote><p>ç¤ºä¾‹ 3ï¼š</p><blockquote><p>è¾“å…¥ï¼šroot &#x3D; []<br>è¾“å‡ºï¼š[]</p></blockquote><p><strong>æç¤º</strong>ï¼š</p><ul><li>æ ‘ä¸­èŠ‚ç‚¹æ•°ç›®åœ¨èŒƒå›´ [0, 2000] å†…</li><li>-1000 &lt;&#x3D; Node.val &lt;&#x3D; 1000</li></ul><h1 id="2-è§£é¢˜æ€è·¯"><a href="#2-è§£é¢˜æ€è·¯" class="headerlink" title="2.è§£é¢˜æ€è·¯"></a>2.è§£é¢˜æ€è·¯</h1><p>å…¶å®ä¸<a href="https://zyxelva.github.io/posts/46738.html">ã€LeetCodeã€‘102.äºŒå‰æ ‘çš„å±‚åºéå†</a>å¹¿åº¦ä¼˜å…ˆçš„æ€è·¯æ²¡å•¥å¤§çš„åŒºåˆ«ï¼Œä»ç»“æœæ¥çœ‹ï¼Œå°±æ˜¯ç»“æœé›†é€†åºè¾“å‡ºï¼Œåªè¦æˆ‘ä»¬åœ¨éå†æ¯å±‚å®Œæˆåï¼Œå°†ä¸´æ—¶ç»“æœé›†æŒ‰ç…§å¤´æ’æ³•æ’å…¥ç»“æœé›†å³å¯ã€‚å¯ä»¥åˆ©ç”¨List.add(index,value)çš„æ–¹æ³•å®Œæˆå¤´æ’æ³•ã€‚</p><h1 id="3-ä»£ç "><a href="#3-ä»£ç " class="headerlink" title="3.ä»£ç "></a>3.ä»£ç </h1><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/** * Definition for a binary tree node. * public class TreeNode &#123; *     int val; *     TreeNode left; *     TreeNode right; *     TreeNode() &#123;&#125; *     TreeNode(int val) &#123; this.val = val; &#125; *     TreeNode(int val, TreeNode left, TreeNode right) &#123; *         this.val = val; *         this.left = left; *         this.right = right; *     &#125; * &#125; */</span><span class="token keyword">class</span> <span class="token class-name">Solution</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">></span><span class="token punctuation">></span></span> <span class="token function">levelOrderBottom</span><span class="token punctuation">(</span><span class="token class-name">TreeNode</span> root<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token comment">//åˆ†å±‚éå†ï¼Œåˆ©ç”¨é˜Ÿåˆ—æ€æƒ³ï¼Œå¤´æ’æ³•</span>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">==</span> root<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token comment">//ç»“æœé›†</span>        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">></span><span class="token punctuation">></span></span> res<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">//æ¯å±‚çš„ç»“æœé›†</span>        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">></span></span> tempList<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TreeNode</span><span class="token punctuation">></span></span> temp<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TreeNode</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">//æ ¹èŠ‚ç‚¹å…¥é˜Ÿ</span>        temp<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span><span class="token punctuation">;</span>        temp<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">TreeNode</span> node<span class="token punctuation">;</span>        <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token operator">!</span>temp<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            node<span class="token operator">=</span>temp<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">!=</span> node<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>                tempList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>val<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token operator">!=</span>node<span class="token punctuation">.</span>left<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>                    temp<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>left<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">&#125;</span>                <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token operator">!=</span>node<span class="token punctuation">.</span>right<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>                    temp<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>right<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">&#125;</span>            <span class="token punctuation">&#125;</span>             <span class="token comment">//æœ¬å±‚å·²éå†å®Œæ¯•</span>            <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>tempList<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>                <span class="token comment">//å¤´æ’æ³•ï¼ˆä¸102ä¸åŒçš„åœ°æ–¹ï¼‰</span>                res<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> tempList<span class="token punctuation">)</span><span class="token punctuation">;</span>                tempList<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                temp<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">return</span> res<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> ç®—æ³• </category>
          
      </categories>
      
      
        <tags>
            
            <tag> LeetCode </tag>
            
            <tag> ç®—æ³• </tag>
            
            <tag> äºŒå‰æ ‘ </tag>
            
            <tag> æ•°æ®ç»“æ„ </tag>
            
            <tag> Java </tag>
            
            <tag> BFS </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ã€LeetCodeã€‘145.äºŒå‰æ ‘çš„åç»­éå†</title>
      <link href="/posts/61239.html"/>
      <url>/posts/61239.html</url>
      
        <content type="html"><![CDATA[<h1 id="1-é—®é¢˜"><a href="#1-é—®é¢˜" class="headerlink" title="1.é—®é¢˜"></a>1.é—®é¢˜</h1><p>ç»™ä½ ä¸€æ£µäºŒå‰æ ‘çš„æ ¹èŠ‚ç‚¹ root ï¼Œè¿”å›å…¶èŠ‚ç‚¹å€¼çš„ <strong>ååº</strong> éå† ã€‚</p><h2 id="ç¤ºä¾‹-1"><a href="#ç¤ºä¾‹-1" class="headerlink" title="ç¤ºä¾‹ 1"></a>ç¤ºä¾‹ 1</h2><p><img src="https://cdn.jsdelivr.net/gh/zyxelva/picgo@main/csdn/b17249866b98973447035d4bf6648b45.jpeg" alt="å›¾1"></p><blockquote><p>è¾“å…¥ï¼šroot &#x3D; [1,null,2,3]<br>è¾“å‡ºï¼š[3,2,1]</p></blockquote><h2 id="ç¤ºä¾‹-2"><a href="#ç¤ºä¾‹-2" class="headerlink" title="ç¤ºä¾‹ 2"></a>ç¤ºä¾‹ 2</h2><blockquote><p>è¾“å…¥ï¼šroot &#x3D; []<br>è¾“å‡ºï¼š[]</p></blockquote><h2 id="ç¤ºä¾‹-3"><a href="#ç¤ºä¾‹-3" class="headerlink" title="ç¤ºä¾‹ 3"></a>ç¤ºä¾‹ 3</h2><blockquote><p>è¾“å…¥ï¼šroot &#x3D; [1]<br>è¾“å‡ºï¼š[1]</p></blockquote><p><strong>æç¤º</strong>ï¼š</p><ul><li>æ ‘ä¸­èŠ‚ç‚¹çš„æ•°ç›®åœ¨èŒƒå›´ [0, 100] å†…</li><li>-100 &lt;&#x3D; Node.val &lt;&#x3D; 100</li></ul><h1 id="2-è§£é¢˜æ€è·¯"><a href="#2-è§£é¢˜æ€è·¯" class="headerlink" title="2.è§£é¢˜æ€è·¯"></a>2.è§£é¢˜æ€è·¯</h1><p>äºŒå‰æ ‘çš„ååºéå†è§„åˆ™ï¼šå·¦-å³-æ ¹ï¼Œè§£é¢˜æ€è·¯å…¶å®å’Œå‰é¢ä¸¤ç¯‡<a href="https://zyxelva.github.io/posts/60831.html">äºŒå‰æ ‘çš„å‰åºéå†</a>ã€<a href="https://zyxelva.github.io/posts/41115.html">äºŒå‰æ ‘çš„ä¸­åºéå†</a>å·®ä¸å¤ªå¤š.</p><h2 id="2-1-é€’å½’"><a href="#2-1-é€’å½’" class="headerlink" title="2.1 é€’å½’"></a>2.1 é€’å½’</h2><p>å®šä¹‰å‡½æ•° postOrderTraversal(root)ä¸ºéå†rootèŠ‚ç‚¹ã€‚åˆ™è°ƒç”¨é¡ºåºä¸ºï¼š</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token function">postOrderTraversal</span><span class="token punctuation">(</span>root<span class="token punctuation">.</span>left<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">postOrderTraversal</span><span class="token punctuation">(</span>root<span class="token punctuation">.</span>right<span class="token punctuation">)</span><span class="token punctuation">;</span>root<span class="token punctuation">.</span>val<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p><strong>å¤æ‚åº¦åˆ†æ</strong></p><ul><li><p>æ—¶é—´å¤æ‚åº¦ï¼šO(n)ï¼Œå…¶ä¸­ n æ˜¯äºŒå‰æœç´¢æ ‘çš„èŠ‚ç‚¹æ•°ã€‚æ¯ä¸€ä¸ªèŠ‚ç‚¹æ°å¥½è¢«éå†ä¸€æ¬¡ã€‚</p></li><li><p>ç©ºé—´å¤æ‚åº¦ï¼šO(n)ï¼Œä¸ºé€’å½’è¿‡ç¨‹ä¸­æ ˆçš„å¼€é”€ï¼Œå¹³å‡æƒ…å†µä¸‹ä¸º O(logâ¡n)ï¼Œæœ€åæƒ…å†µä¸‹æ ‘å‘ˆç°é“¾çŠ¶ï¼Œä¸º O(n)ã€‚</p></li></ul><h2 id="2-2-è¿­ä»£"><a href="#2-2-è¿­ä»£" class="headerlink" title="2.2 è¿­ä»£"></a>2.2 è¿­ä»£</h2><ol><li>éå†root<br><img src="https://cdn.jsdelivr.net/gh/zyxelva/picgo@main/csdn/7af3c2bb2c4365ed4c37aefa8a4a3c6e.png" alt="å›¾2"></li><li>rootå…¥æ ˆ<br><img src="https://cdn.jsdelivr.net/gh/zyxelva/picgo@main/csdn/9070a7206c86a1ea612fc04ec2f71a00.png" alt="å›¾3"><br>3ï¼‰root.leftå…¥æ ˆ<br><img src="https://cdn.jsdelivr.net/gh/zyxelva/picgo@main/csdn/857102064a004707e583721556231ba5.png" alt="å›¾4"><br>4ï¼‰root.leftå†æ— å·¦å­æ ‘äº†ï¼Œå·¦å­æ ‘æ ¹èŠ‚ç‚¹å‡ºæ ˆï¼Œéå†ï¼Œå¹¶æ ‡è®°å½“å‰å‡ºæ ˆçš„èŠ‚ç‚¹ä¸ºå·²è®¿é—®è¿‡ï¼Œå¦åˆ™éå†ã€å…¥æ ˆroot.right<br><img src="https://cdn.jsdelivr.net/gh/zyxelva/picgo@main/csdn/f002bede3c25ca19cb98e36727b302aa.png" alt="å›¾5"><br><img src="https://cdn.jsdelivr.net/gh/zyxelva/picgo@main/csdn/1372fe88616786229ad090b22fbd30cf.png" alt="å›¾6"><br><img src="https://cdn.jsdelivr.net/gh/zyxelva/picgo@main/csdn/b033abfd3c38a61cf2febbc3cabb69ec.png" alt="å›¾7"><br><img src="https://cdn.jsdelivr.net/gh/zyxelva/picgo@main/csdn/765e04b0d1cda730a3ba05243a079ef7.png" alt="å›¾8"></li></ol><p>5ï¼‰åŒç†ï¼Œå…ˆæŠŠ4æ‰€æœ‰å·¦èŠ‚ç‚¹å…¥æ ˆï¼Œåˆ°è¾¾æœ€å·¦èŠ‚ç‚¹åï¼Œå‡ºæ ˆï¼Œéå†valï¼Œæ ‡è®°å½“å‰å‡ºæ ˆçš„èŠ‚ç‚¹ä¸ºå·²è®¿é—®è¿‡ï¼Œéå†root.rightï¼Œå‡ºæ ˆroot.rightï¼Œroot.<br><img src="https://cdn.jsdelivr.net/gh/zyxelva/picgo@main/csdn/37c2e0b67765c6b6a219cf3e21864db2.png" alt="å›¾9"><br>5å‡ºæ ˆ<br><img src="https://cdn.jsdelivr.net/gh/zyxelva/picgo@main/csdn/349c04a123e6d5fe20da5a184eb3cb9b.png" alt="å›¾10"><br><img src="https://cdn.jsdelivr.net/gh/zyxelva/picgo@main/csdn/611d2d7e7ffe0f43fe396655e31a4fff.png" alt="å›¾11"><br>4å‡ºæ ˆï¼Œä½†4çš„å³èŠ‚ç‚¹å­˜åœ¨ï¼Œå…¥æ ˆ4.right<br><img src="https://cdn.jsdelivr.net/gh/zyxelva/picgo@main/csdn/733a9e18379af93d68e5173774b2d1f2.png" alt="å›¾12"><br><img src="https://cdn.jsdelivr.net/gh/zyxelva/picgo@main/csdn/022d50585c4aaafd920d3a590c48ea3f.png" alt="å›¾13"><br><img src="https://cdn.jsdelivr.net/gh/zyxelva/picgo@main/csdn/701a24fb73d25b6e2fed1a31317d31ca.png" alt="å›¾14"><br>7å‡ºæ ˆï¼Œéå†ï¼Œä¾æ¬¡å‡ºæ ˆ4ï¼Œ3ï¼Œéå†å®Œæ¯•<br><img src="https://cdn.jsdelivr.net/gh/zyxelva/picgo@main/csdn/ddee700bc6ee3175f2c8007270d340ec.png" alt="å›¾15"><br><img src="https://cdn.jsdelivr.net/gh/zyxelva/picgo@main/csdn/ffb6ce833111af31275a768dc5888df1.png" alt="å›¾16"><br><img src="https://cdn.jsdelivr.net/gh/zyxelva/picgo@main/csdn/f89ee6166faf12b4f89d048abfc08569.png" alt="å›¾17"><br><img src="https://cdn.jsdelivr.net/gh/zyxelva/picgo@main/csdn/885f14118fa6d9c7801c914926e1c5b3.png" alt="å›¾18"><br><img src="https://cdn.jsdelivr.net/gh/zyxelva/picgo@main/csdn/9deb56a376dec731acd2e6cf3cb4c3d0.png" alt="å›¾19"><br><img src="https://cdn.jsdelivr.net/gh/zyxelva/picgo@main/csdn/bd7589948385a47db4365d8182abd12d.png" alt="å›¾20"><br><strong>å¤æ‚åº¦åˆ†æ</strong></p><ul><li><p>æ—¶é—´å¤æ‚åº¦ï¼šO(n)ï¼Œå…¶ä¸­ n æ˜¯äºŒå‰æœç´¢æ ‘çš„èŠ‚ç‚¹æ•°ã€‚æ¯ä¸€ä¸ªèŠ‚ç‚¹æ°å¥½è¢«éå†ä¸€æ¬¡ã€‚</p></li><li><p>ç©ºé—´å¤æ‚åº¦ï¼šO(n)ï¼Œä¸ºè¿­ä»£è¿‡ç¨‹ä¸­æ˜¾å¼æ ˆçš„å¼€é”€ï¼Œå¹³å‡æƒ…å†µä¸‹ä¸º O(logâ¡n)ï¼Œæœ€åæƒ…å†µä¸‹æ ‘å‘ˆç°é“¾çŠ¶ï¼Œä¸º O(n)ã€‚</p></li></ul><h1 id="3-ä»£ç "><a href="#3-ä»£ç " class="headerlink" title="3.ä»£ç "></a>3.ä»£ç </h1><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/** * Definition for a binary tree node. * public class TreeNode &#123; *     int val; *     TreeNode left; *     TreeNode right; *     TreeNode() &#123;&#125; *     TreeNode(int val) &#123; this.val = val; &#125; *     TreeNode(int val, TreeNode left, TreeNode right) &#123; *         this.val = val; *         this.left = left; *         this.right = right; *     &#125; * &#125; */</span><span class="token keyword">class</span> <span class="token class-name">Solution</span> <span class="token punctuation">&#123;</span><span class="token comment">//è¿­ä»£</span>    <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">></span></span> <span class="token function">postorderTraversal</span><span class="token punctuation">(</span><span class="token class-name">TreeNode</span> root<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">></span></span> res <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">==</span> root<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">return</span> res<span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token class-name">Stack</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TreeNode</span><span class="token punctuation">></span></span> stack <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Stack</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">TreeNode</span> prev <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>        <span class="token class-name">TreeNode</span> current <span class="token operator">=</span> root<span class="token punctuation">;</span>        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">!=</span> current <span class="token operator">||</span> <span class="token operator">!</span>stack<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">!=</span> current<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                stack<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>current<span class="token punctuation">)</span><span class="token punctuation">;</span>                current <span class="token operator">=</span> current<span class="token punctuation">.</span>left<span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>            <span class="token comment">//è·å–å½“å‰æ ˆé¡¶èŠ‚ç‚¹</span>            current <span class="token operator">=</span> stack<span class="token punctuation">.</span><span class="token function">peek</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment">//å³èŠ‚ç‚¹ä¸ºç©ºï¼Œæˆ–è€…å·²ç»è®¿é—®è¿‡ï¼Œåˆ™æ‰“å°ï¼Œå¹¶æ ‡è®°å½“å‰å‡ºæ ˆçš„èŠ‚ç‚¹ä¸ºå·²è®¿é—®è¿‡</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">==</span> current<span class="token punctuation">.</span>right <span class="token operator">||</span> prev <span class="token operator">==</span> current<span class="token punctuation">.</span>right<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                res<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>current<span class="token punctuation">.</span>val<span class="token punctuation">)</span><span class="token punctuation">;</span>                prev <span class="token operator">=</span> current<span class="token punctuation">;</span>                stack<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                current <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>                current <span class="token operator">=</span> current<span class="token punctuation">.</span>right<span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">return</span> res<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token comment">//é€’å½’</span><span class="token keyword">public</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> postorderTraversal2 <span class="token punctuation">(</span><span class="token class-name">TreeNode</span> root<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">==</span> root<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">></span></span> list <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">postorderTraversal2</span><span class="token punctuation">(</span>list<span class="token punctuation">,</span> root<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> list<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">mapToInt</span><span class="token punctuation">(</span><span class="token class-name">Integer</span><span class="token operator">::</span><span class="token function">valueOf</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>     <span class="token keyword">public</span> <span class="token keyword">void</span> postorderTraversal2 <span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">></span></span> list<span class="token punctuation">,</span> <span class="token class-name">TreeNode</span> root<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">==</span> root<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">return</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token function">postorderTraversal2</span><span class="token punctuation">(</span>list<span class="token punctuation">,</span> root<span class="token punctuation">.</span>left<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">postorderTraversal2</span><span class="token punctuation">(</span>list<span class="token punctuation">,</span> root<span class="token punctuation">.</span>right<span class="token punctuation">)</span><span class="token punctuation">;</span>        list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>root<span class="token punctuation">.</span>val<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> ç®—æ³• </category>
          
      </categories>
      
      
        <tags>
            
            <tag> LeetCode </tag>
            
            <tag> ç®—æ³• </tag>
            
            <tag> äºŒå‰æ ‘ </tag>
            
            <tag> æ•°æ®ç»“æ„ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ã€LeetCodeã€‘94.äºŒå‰æ ‘çš„ä¸­åºéå†</title>
      <link href="/posts/41115.html"/>
      <url>/posts/41115.html</url>
      
        <content type="html"><![CDATA[<h1 id="1-é—®é¢˜"><a href="#1-é—®é¢˜" class="headerlink" title="1.é—®é¢˜"></a>1.é—®é¢˜</h1><p>ç»™å®šä¸€ä¸ªäºŒå‰æ ‘çš„æ ¹èŠ‚ç‚¹ root ï¼Œè¿”å› å®ƒçš„ <strong>ä¸­åº</strong> éå† ã€‚</p><h2 id="ç¤ºä¾‹-1"><a href="#ç¤ºä¾‹-1" class="headerlink" title="ç¤ºä¾‹ 1"></a>ç¤ºä¾‹ 1</h2><p><img src="https://cdn.jsdelivr.net/gh/zyxelva/picgo@main/csdn/7c55ac8a6fe7df8e5a4939e503566cb5.jpeg" alt="å›¾1"></p><blockquote><p>è¾“å…¥ï¼šroot &#x3D; [1,null,2,3]<br>è¾“å‡ºï¼š[1,3,2]</p></blockquote><h2 id="ç¤ºä¾‹-2"><a href="#ç¤ºä¾‹-2" class="headerlink" title="ç¤ºä¾‹ 2"></a>ç¤ºä¾‹ 2</h2><blockquote><p>è¾“å…¥ï¼šroot &#x3D; []<br>è¾“å‡ºï¼š[]</p></blockquote><h2 id="ç¤ºä¾‹-3"><a href="#ç¤ºä¾‹-3" class="headerlink" title="ç¤ºä¾‹ 3"></a>ç¤ºä¾‹ 3</h2><blockquote><p>è¾“å…¥ï¼šroot &#x3D; [1]<br>è¾“å‡ºï¼š[1]</p></blockquote><p><strong>æç¤º</strong>ï¼š</p><ul><li>æ ‘ä¸­èŠ‚ç‚¹æ•°ç›®åœ¨èŒƒå›´ [0, 100] å†…</li><li>-100 &lt;&#x3D; Node.val &lt;&#x3D; 100</li></ul><h1 id="2-è§£é¢˜æ€è·¯"><a href="#2-è§£é¢˜æ€è·¯" class="headerlink" title="2.è§£é¢˜æ€è·¯"></a>2.è§£é¢˜æ€è·¯</h1><h2 id="2-1-é€’å½’"><a href="#2-1-é€’å½’" class="headerlink" title="2.1 é€’å½’"></a>2.1 é€’å½’</h2><p>ç±»ä¼¼<a href="https://zyxelva.github.io/posts/60831.html">äºŒå‰æ ‘çš„å‰åºéå†</a>ï¼Œä¸­åºéå†è§„åˆ™ä¸º å·¦-æ ¹-å³ï¼Œåªè¦å¯¹å‰åºéå†-é€’å½’ç¨ä½œè°ƒæ•´ï¼Œå³å¯å®ç°ï¼›</p><p><strong>å¤æ‚åº¦åˆ†æ</strong></p><ul><li><p>æ—¶é—´å¤æ‚åº¦ï¼šO(n)ï¼Œå…¶ä¸­ n ä¸ºäºŒå‰æ ‘èŠ‚ç‚¹çš„ä¸ªæ•°ã€‚äºŒå‰æ ‘çš„éå†ä¸­æ¯ä¸ªèŠ‚ç‚¹ä¼šè¢«è®¿é—®ä¸€æ¬¡ä¸”åªä¼šè¢«è®¿é—®ä¸€æ¬¡ã€‚</p></li><li><p>ç©ºé—´å¤æ‚åº¦ï¼šO(n)ã€‚ç©ºé—´å¤æ‚åº¦å–å†³äºé€’å½’çš„æ ˆæ·±åº¦ï¼Œè€Œæ ˆæ·±åº¦åœ¨äºŒå‰æ ‘ä¸ºä¸€æ¡é“¾çš„æƒ…å†µä¸‹ä¼šè¾¾åˆ° O(n) çš„çº§åˆ«ã€‚</p></li></ul><h2 id="2-2-è¿­ä»£ï¼ˆæ ˆï¼‰"><a href="#2-2-è¿­ä»£ï¼ˆæ ˆï¼‰" class="headerlink" title="2.2 è¿­ä»£ï¼ˆæ ˆï¼‰"></a>2.2 è¿­ä»£ï¼ˆæ ˆï¼‰</h2><p>è‹¥åˆ©ç”¨æ ˆï¼ˆè¿­ä»£æ€æƒ³ï¼‰ï¼Œåˆ™éœ€è¦è°ƒæ•´ä¸‹å…¥æ ˆé¡ºåºï¼Œéå†é¡ºåº<br>1ï¼‰å…ˆéå†æ ¹èŠ‚ç‚¹ï¼Œå…¥æ ˆ<br><img src="https://cdn.jsdelivr.net/gh/zyxelva/picgo@main/csdn/346ead11b93d1e268442d3268d22c544.png" alt="å›¾2"><br>2ï¼‰å¾ªç¯éå†å·¦å­æ ‘<br><img src="https://cdn.jsdelivr.net/gh/zyxelva/picgo@main/csdn/c423efbaa00943b29c58b1a55e20e802.png" alt="å›¾3"><br><img src="https://cdn.jsdelivr.net/gh/zyxelva/picgo@main/csdn/795f1e51a84546e874987a7ac8425e7f.png" alt="å›¾4"><br>3ï¼‰åˆ°è¾¾æœ€å·¦è¾¹ï¼Œå‡ºæ ˆï¼Œéå†è¯¥èŠ‚ç‚¹å³å­æ ‘ï¼Œå…¥æ ˆï¼Œæ²¡æœ‰çš„è¯ï¼Œå†å‡ºæ ˆè¯¥èŠ‚ç‚¹çš„æ ¹èŠ‚ç‚¹ï¼Œæ¯”å¦‚ç›®å‰èŠ‚ç‚¹æ˜¯4ï¼Œå³å­æ ‘æ²¡æœ‰äº†ï¼Œå‡ºæ ˆæ ¹èŠ‚ç‚¹2<br><img src="https://cdn.jsdelivr.net/gh/zyxelva/picgo@main/csdn/37ff491c7c271fb4f326cc57a74f4122.png" alt="å›¾5"><br><img src="https://cdn.jsdelivr.net/gh/zyxelva/picgo@main/csdn/7aa96355593a980611f6c2298e71009b.png" alt="å›¾6"><br><img src="https://cdn.jsdelivr.net/gh/zyxelva/picgo@main/csdn/431308dd45151de979645577be90e040.png" alt="å›¾7"><br><img src="https://cdn.jsdelivr.net/gh/zyxelva/picgo@main/csdn/f62bc4615e0da03a3e45d9a64acd158b.png" alt="å›¾8"></p><p>4ï¼‰æ ¹èŠ‚ç‚¹çš„å·¦å­æ ‘éå†å®Œæ¯•ï¼Œå¼€å§‹éå†1çš„å³å­æ ‘ï¼Œå…ˆå‡ºæ ˆæ ¹èŠ‚ç‚¹1ï¼ŒåŒç†éå†å³å­æ ‘<br><img src="https://cdn.jsdelivr.net/gh/zyxelva/picgo@main/csdn/75966ba0cf835e89054d0fd5c4824a56.png" alt="å›¾9"></p><p><img src="https://cdn.jsdelivr.net/gh/zyxelva/picgo@main/csdn/b28df401f758e0b0c558c52f5ef1b08c.png" alt="å›¾10"><br><img src="https://cdn.jsdelivr.net/gh/zyxelva/picgo@main/csdn/ad63fdcac27c54c96ad5c202f804e81f.png" alt="å›¾11"><br><img src="https://cdn.jsdelivr.net/gh/zyxelva/picgo@main/csdn/6dfe1efa71dc1da0ff6b115bbeb46f2f.png" alt="å›¾12"><br><img src="https://cdn.jsdelivr.net/gh/zyxelva/picgo@main/csdn/db58b8ed3cdde4808ecc14551cd02fd5.png" alt="å›¾13"><br><img src="https://cdn.jsdelivr.net/gh/zyxelva/picgo@main/csdn/ac29b2347b8098dc63cd4be6e7496bc2.png" alt="å›¾14"><br><strong>å¤æ‚åº¦åˆ†æ</strong></p><ul><li><p>æ—¶é—´å¤æ‚åº¦ï¼šO(n)ï¼Œå…¶ä¸­ n ä¸ºäºŒå‰æ ‘èŠ‚ç‚¹çš„ä¸ªæ•°ã€‚äºŒå‰æ ‘çš„éå†ä¸­æ¯ä¸ªèŠ‚ç‚¹ä¼šè¢«è®¿é—®ä¸€æ¬¡ä¸”åªä¼šè¢«è®¿é—®ä¸€æ¬¡ã€‚</p></li><li><p>ç©ºé—´å¤æ‚åº¦ï¼šO(n)ã€‚ç©ºé—´å¤æ‚åº¦å–å†³äºæ ˆæ·±åº¦ï¼Œè€Œæ ˆæ·±åº¦åœ¨äºŒå‰æ ‘ä¸ºä¸€æ¡é“¾çš„æƒ…å†µä¸‹ä¼šè¾¾åˆ° O(n) çš„çº§åˆ«ã€‚</p></li></ul><h1 id="3-ä»£ç "><a href="#3-ä»£ç " class="headerlink" title="3.ä»£ç "></a>3.ä»£ç </h1><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/* * public class TreeNode &#123; *   int val = 0; *   TreeNode left = null; *   TreeNode right = null; *   public TreeNode(int val) &#123; *     this.val = val; *   &#125; * &#125; */</span> <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Solution</span> <span class="token punctuation">&#123;</span>    <span class="token comment">/**     * é€’å½’     *     * é€’å½’ç®—æ³•     * @param root TreeNodeç±»     * @return intæ•´å‹ä¸€ç»´æ•°ç»„     */</span>    <span class="token keyword">public</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> inorderTraversal2 <span class="token punctuation">(</span><span class="token class-name">TreeNode</span> root<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">==</span> root<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">></span></span> list <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">inorderTraversal2</span><span class="token punctuation">(</span>list<span class="token punctuation">,</span> root<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> list<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">mapToInt</span><span class="token punctuation">(</span><span class="token class-name">Integer</span><span class="token operator">::</span><span class="token function">valueOf</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>     <span class="token keyword">public</span> <span class="token keyword">void</span> inorderTraversal2 <span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">></span></span> list<span class="token punctuation">,</span> <span class="token class-name">TreeNode</span> root<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">==</span> root<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">return</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token function">inorderTraversal2</span><span class="token punctuation">(</span>list<span class="token punctuation">,</span> root<span class="token punctuation">.</span>left<span class="token punctuation">)</span><span class="token punctuation">;</span>        list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>root<span class="token punctuation">.</span>val<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">inorderTraversal2</span><span class="token punctuation">(</span>list<span class="token punctuation">,</span> root<span class="token punctuation">.</span>right<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>     <span class="token comment">/**    éé€’å½’ç®—æ³•     */</span>    <span class="token keyword">public</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> inorderTraversal <span class="token punctuation">(</span><span class="token class-name">TreeNode</span> root<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>root <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">></span></span> list <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">TreeNode</span> cur <span class="token operator">=</span> root<span class="token punctuation">;</span>        <span class="token class-name">Stack</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TreeNode</span><span class="token punctuation">></span></span> stack <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Stack</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">TreeNode</span> top <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>        <span class="token keyword">while</span> <span class="token punctuation">(</span>cur <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">||</span> <span class="token operator">!</span>stack<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token comment">//æŠŠå·¦èŠ‚ç‚¹æ‰€æœ‰å·¦èŠ‚ç‚¹å…¥æ ˆ</span>            <span class="token keyword">while</span> <span class="token punctuation">(</span>cur <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                stack<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>cur<span class="token punctuation">)</span><span class="token punctuation">;</span>                cur <span class="token operator">=</span> cur<span class="token punctuation">.</span>left<span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>            <span class="token comment">//å‡ºæ ˆ</span>            top <span class="token operator">=</span> stack<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>top<span class="token punctuation">.</span>val<span class="token punctuation">)</span><span class="token punctuation">;</span>            cur <span class="token operator">=</span> top<span class="token punctuation">.</span>right<span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">int</span> size <span class="token operator">=</span> list<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> arr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">int</span><span class="token punctuation">[</span>size<span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> size<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            arr<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> list<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">return</span> arr<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> ç®—æ³• </category>
          
      </categories>
      
      
        <tags>
            
            <tag> LeetCode </tag>
            
            <tag> ç®—æ³• </tag>
            
            <tag> äºŒå‰æ ‘ </tag>
            
            <tag> æ•°æ®ç»“æ„ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ã€LeetCodeã€‘102.äºŒå‰æ ‘çš„å±‚åºéå†</title>
      <link href="/posts/46738.html"/>
      <url>/posts/46738.html</url>
      
        <content type="html"><![CDATA[<h1 id="1-é—®é¢˜"><a href="#1-é—®é¢˜" class="headerlink" title="1.é—®é¢˜"></a>1.é—®é¢˜</h1><p>ç»™ä½ äºŒå‰æ ‘çš„æ ¹èŠ‚ç‚¹ root ï¼Œè¿”å›å…¶èŠ‚ç‚¹å€¼çš„ å±‚åºéå† ã€‚ ï¼ˆå³é€å±‚åœ°ï¼Œä»å·¦åˆ°å³è®¿é—®æ‰€æœ‰èŠ‚ç‚¹ï¼‰ã€‚</p><p> <img src="https://cdn.jsdelivr.net/gh/zyxelva/picgo@main/csdn/2e1724d19c6520ecce7f331873f7bee9.jpeg" alt="å›¾1"></p><h2 id="ç¤ºä¾‹-1"><a href="#ç¤ºä¾‹-1" class="headerlink" title="ç¤ºä¾‹ 1"></a>ç¤ºä¾‹ 1</h2><blockquote><p>è¾“å…¥ï¼šroot &#x3D; [3,9,20,null,null,15,7]<br>è¾“å‡ºï¼š[[3],[9,20],[15,7]]</p></blockquote><h2 id="ç¤ºä¾‹-2"><a href="#ç¤ºä¾‹-2" class="headerlink" title="ç¤ºä¾‹ 2"></a>ç¤ºä¾‹ 2</h2><blockquote><p>è¾“å…¥ï¼šroot &#x3D; [1]<br>è¾“å‡ºï¼š[[1]]</p></blockquote><h2 id="ç¤ºä¾‹-3"><a href="#ç¤ºä¾‹-3" class="headerlink" title="ç¤ºä¾‹ 3"></a>ç¤ºä¾‹ 3</h2><blockquote><p>è¾“å…¥ï¼šroot &#x3D; []<br>è¾“å‡ºï¼š[]</p></blockquote><p><strong>æç¤º</strong>ï¼š</p><ul><li>æ ‘ä¸­èŠ‚ç‚¹æ•°ç›®åœ¨èŒƒå›´ [0, 2000] å†…</li><li>-1000 &lt;&#x3D; Node.val &lt;&#x3D; 1000</li></ul><h1 id="2-è§£é¢˜æ€è·¯"><a href="#2-è§£é¢˜æ€è·¯" class="headerlink" title="2.è§£é¢˜æ€è·¯"></a>2.è§£é¢˜æ€è·¯</h1><h2 id="2-1-é˜Ÿåˆ—"><a href="#2-1-é˜Ÿåˆ—" class="headerlink" title="2.1 é˜Ÿåˆ—"></a>2.1 é˜Ÿåˆ—</h2><p>äºŒå‰æ ‘æ¯å±‚çš„éå†ç¬¦åˆé˜Ÿåˆ—çš„ç‰¹æ€§ï¼Œå¿…é¡»FIFO(first in first out)ï¼Œå†éå†æ¯å±‚å®Œæˆåï¼Œå¯ä»¥ç»™å®šä¸€ä¸ªæ ‡è®°æˆ–è€…å±‚æ•°ï¼Œè¡¨ç¤ºè¯¥å±‚å·²ç»éå†å®Œæ¯•ï¼Œå¯ä»¥å°†æ­¤æ—¶çš„è¯¥å±‚éå†ç»“æœè¾“å‡ºã€‚ä¼ªä»£ç ï¼š</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">//å®šä¹‰é˜Ÿåˆ—</span><span class="token class-name">Queue</span> q<span class="token punctuation">;</span><span class="token comment">//ç»“æœé›†</span><span class="token class-name">List</span> res<span class="token punctuation">;</span><span class="token comment">//root å…¥é˜Ÿ</span>q<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//ç»™å®šä¸€ä¸ªæ ‡è¯†ï¼Œæ ‡è®°ç¬¬ä¸€å±‚éå†çš„ç»“å°¾</span>q<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">while</span><span class="token punctuation">(</span>qä¸ä¸ºç©º<span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token comment">//å‡ºé˜Ÿ</span>temp<span class="token operator">=</span>q<span class="token punctuation">.</span><span class="token function">peek</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//ä¸æ˜¯æ ‡è¯†çš„è¯ï¼Œå…¥é˜Ÿroot.leftã€root.right</span><span class="token keyword">if</span><span class="token punctuation">(</span>tempä¸ä¸º<span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>res<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>temp<span class="token punctuation">.</span>val<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span><span class="token punctuation">(</span>temp<span class="token punctuation">.</span>leftä¸ä¸º<span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>q<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>temp<span class="token punctuation">.</span>left<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">if</span><span class="token punctuation">(</span>temp<span class="token punctuation">.</span>rightä¸ä¸º<span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>q<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>temp<span class="token punctuation">.</span>right<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token comment">//å¦åˆ™ï¼Œè¯¥å±‚éå†å®Œæ¯•</span><span class="token keyword">else</span> <span class="token punctuation">&#123;</span>q<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="https://cdn.jsdelivr.net/gh/zyxelva/picgo@main/csdn/774fe28d36b44dfdda1b8167197e72e6.gif" alt="å›¾2"><br><strong>å¤æ‚åº¦åˆ†æ</strong>ï¼š</p><ul><li>æ—¶é—´å¤æ‚åº¦ï¼šO(n)ï¼Œå…¶ä¸­nä¸ºäºŒå‰æ ‘çš„èŠ‚ç‚¹æ•°ï¼Œæ¯ä¸ªèŠ‚ç‚¹è®¿é—®ä¸€æ¬¡</li><li>ç©ºé—´å¤æ‚åº¦ï¼šO(n)ï¼Œé˜Ÿåˆ—çš„ç©ºé—´ä¸ºäºŒå‰æ ‘çš„ä¸€å±‚çš„èŠ‚ç‚¹æ•°ï¼Œæœ€åæƒ…å†µäºŒå‰æ ‘çš„ä¸€å±‚ä¸ºO(n)çº§</li></ul><h2 id="2-2-é€’å½’"><a href="#2-2-é€’å½’" class="headerlink" title="2.2 é€’å½’"></a>2.2 é€’å½’</h2><p>æ ¹æ®äºŒå‰æ ‘çš„å®šä¹‰ï¼Œä¸éš¾çœ‹å‡ºï¼Œæ¯ä¸ªèŠ‚ç‚¹éƒ½æœ‰ç±»ä¼¼çš„æ€§è´¨ã€‚å½“éå†å‘ç”Ÿæ—¶ï¼Œå¯¹äºå…¶å·¦å³å­æ ‘åŒæ ·é€‚ç”¨ç›¸åŒçš„è§„åˆ™ï¼Œéå¸¸é€‚åˆé€’å½’ã€‚å¯ä»¥å€Ÿé‰´ä¹‹å‰å¯¹äºäºŒå‰æ ‘çš„å‰ä¸­ååºéå†ï¼Œæ—¢ç„¶å¯ä»¥ç”¨é€’å½’è§£å†³ï¼Œé‚£å±‚æ¬¡éå†ä¹Ÿæœªå°ä¸å¯ã€‚åŒæ ·å¯ä»¥è¿ç”¨æ ‡è®°çš„æ€æƒ³ï¼Œå¯¹äºåŒä¸€å±‚ï¼Œå¯ä»¥æ ‡è®°ä¸ºç›¸åŒçš„æ·±åº¦æ¥è¿›è¡Œéå†ã€‚ä¼ªä»£ç ï¼š</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">void</span> <span class="token function">traverse</span><span class="token punctuation">(</span><span class="token class-name">TreeNode</span> root<span class="token punctuation">,</span> <span class="token keyword">int</span> depth<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//è®¡å…¥å­èŠ‚ç‚¹ï¼Œåˆ™æ·±åº¦depth+1</span><span class="token comment">//é€’å½’å·¦å³æ—¶æ·±åº¦è®°å¾—åŠ 1</span><span class="token function">traverse</span><span class="token punctuation">(</span>root<span class="token punctuation">.</span>left<span class="token punctuation">,</span> depth <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token function">traverse</span><span class="token punctuation">(</span>root<span class="token punctuation">.</span>right<span class="token punctuation">,</span> depth <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//æ¯ä¸ªèŠ‚ç‚¹å€¼æ”¾å…¥å¯¹åº”çš„äºŒç»´æ•°ç»„ç›¸åº”è¡Œ</span>res<span class="token punctuation">[</span>depth <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>root<span class="token operator">-></span>val<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>å¤æ‚åº¦åˆ†æ</strong></p><ul><li>æ—¶é—´å¤æ‚åº¦ï¼šO(n)ï¼Œnä¸ºèŠ‚ç‚¹æ•°é‡ï¼ŒDFSå¯¹æ¯ä¸ªèŠ‚ç‚¹è®¿é—®ä¸€æ¬¡ï¼Œå› æ­¤é€’å½’è°ƒç”¨næ¬¡ï¼Œæ¯æ¬¡è°ƒç”¨æ‰§è¡Œå¸¸æ•°æ¬¡æ“ä½œï¼Œæ—¶é—´å¤æ‚åº¦O(n)ã€‚</li><li>ç©ºé—´å¤æ‚åº¦ï¼šO(n)ï¼Œç©ºé—´å¤æ‚åº¦åœ¨äºé€’å½’è°ƒç”¨æ·±åº¦å’Œæ¯æ¬¡é€’å½’è°ƒç”¨è¾…åŠ©ç©ºé—´ï¼Œè¾…åŠ©ç©ºé—´ä¸ºå¸¸æ•°çº§ï¼Œä¸èŠ‚ç‚¹æ·±åº¦ç›¸å…³ï¼Œå½“èŠ‚ç‚¹æ·±åº¦ä¸ºnæ—¶æœ€å¤§ï¼Œä¸ºO(n)ã€‚</li></ul><h1 id="3-ä»£ç "><a href="#3-ä»£ç " class="headerlink" title="3.ä»£ç "></a>3.ä»£ç </h1><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token operator">*</span></span><span class="token punctuation">;</span><span class="token comment">/* * public class TreeNode &#123; *   int val = 0; *   TreeNode left = null; *   TreeNode right = null; * &#125; */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Solution</span> <span class="token punctuation">&#123;</span>    <span class="token comment">/**     * åˆ©ç”¨é˜Ÿåˆ—çš„æ€§è´¨     * @param root TreeNodeç±»     * @return intæ•´å‹ArrayList&lt;ArrayList&lt;>>     */</span>    <span class="token keyword">public</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ArrayList</span><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">></span><span class="token punctuation">></span></span> levelOrder <span class="token punctuation">(</span><span class="token class-name">TreeNode</span> root<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">==</span> root<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token comment">//ç»“æœ</span>        <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ArrayList</span><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">></span><span class="token punctuation">></span></span> res <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">//æ¯å±‚ä¸´æ—¶ç»“æœ</span>        <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">></span></span> temp <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">TreeNode</span> node<span class="token punctuation">;</span>        <span class="token comment">//é˜Ÿåˆ—</span>        <span class="token class-name">LinkedList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TreeNode</span><span class="token punctuation">></span></span> list <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TreeNode</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">//ç»™å®šä¸ª å±‚æ ‡è¯†</span>        list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">//éå†é˜Ÿåˆ—</span>        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>list<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            node <span class="token operator">=</span> list<span class="token punctuation">.</span><span class="token function">removeFirst</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">!=</span> node<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                temp<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>val<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">!=</span> node<span class="token punctuation">.</span>left<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                    list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>left<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">&#125;</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">!=</span> node<span class="token punctuation">.</span>right<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                    list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>right<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">&#125;</span>            <span class="token punctuation">&#125;</span>            <span class="token comment">//ä¸ºnullèŠ‚ç‚¹ï¼Œè¯´æ˜è¿™ä¸€å±‚å·²ç»éå†å®Œæˆ</span>            <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>                <span class="token comment">//è¿™é‡Œä¸€å®šè¦åˆ¤æ–­ä¸‹ï¼Œå¦‚æœä¸ºç©ºï¼Œè¡¨æ˜äºŒå‰æ ‘å·²ç»éå†å®Œæˆäº†</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>temp<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                    res<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>temp<span class="token punctuation">)</span><span class="token punctuation">;</span>                    temp <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">&#125;</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">return</span> res<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token comment">//è®°å½•è¾“å‡º</span>    <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ArrayList</span><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">></span> <span class="token punctuation">></span></span> res <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//é€’å½’</span><span class="token keyword">public</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ArrayList</span><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">></span><span class="token punctuation">></span></span> levelOrder <span class="token punctuation">(</span><span class="token class-name">TreeNode</span> root<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>root <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>            <span class="token comment">//å¦‚æœæ˜¯ç©ºï¼Œåˆ™ç›´æ¥è¿”å›</span>            <span class="token keyword">return</span> res<span class="token punctuation">;</span>        <span class="token comment">//é€’å½’å±‚æ¬¡éå†</span>        <span class="token function">traverse</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> res<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>        <span class="token comment">//ä¸´æ—¶ç»“æœé›†</span>    <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">></span></span> row<span class="token punctuation">;</span>    <span class="token keyword">void</span> <span class="token function">traverse</span><span class="token punctuation">(</span><span class="token class-name">TreeNode</span> root<span class="token punctuation">,</span> <span class="token keyword">int</span> depth<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>root <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            <span class="token comment">//æ–°çš„ä¸€å±‚: å¯¹äºäºŒç»´resæ¥è¯´ï¼Œå°†æ ¹è§†ä¸ºç¬¬0å±‚ï¼Œæ ‘çš„æ·±åº¦æ­£å¥½ç­‰äºä¸€ç»´resçš„ä¸ªæ•°</span>            <span class="token keyword">if</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> depth<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>                 row <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                res<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>row<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment">//è¯»å–è¯¥å±‚çš„ä¸€ç»´æ•°ç»„ï¼Œå°†å…ƒç´ åŠ å…¥æœ«å°¾</span>            <span class="token punctuation">&#125;</span><span class="token keyword">else</span><span class="token punctuation">&#123;</span>                row <span class="token operator">=</span> res<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>depth<span class="token punctuation">)</span><span class="token punctuation">;</span>             <span class="token punctuation">&#125;</span>            row<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>root<span class="token punctuation">.</span>val<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">else</span>            <span class="token keyword">return</span><span class="token punctuation">;</span>        <span class="token comment">//é€’å½’å·¦å³æ—¶æ·±åº¦è®°å¾—åŠ 1</span>        <span class="token function">traverse</span><span class="token punctuation">(</span>root<span class="token punctuation">.</span>left<span class="token punctuation">,</span> depth <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">traverse</span><span class="token punctuation">(</span>root<span class="token punctuation">.</span>right<span class="token punctuation">,</span> depth <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> ç®—æ³• </category>
          
      </categories>
      
      
        <tags>
            
            <tag> LeetCode </tag>
            
            <tag> ç®—æ³• </tag>
            
            <tag> äºŒå‰æ ‘ </tag>
            
            <tag> æ•°æ®ç»“æ„ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Hello World</title>
      <link href="/posts/16107.html"/>
      <url>/posts/16107.html</url>
      
        <content type="html"><![CDATA[<p>Welcome to <a href="https://hexo.io/">Hexo</a>! This is your very first post. Check <a href="https://hexo.io/docs/">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="https://hexo.io/docs/troubleshooting.html">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues">GitHub</a>.</p><h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ hexo new <span class="token string">"My New Post"</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>More info: <a href="https://hexo.io/docs/writing.html">Writing</a></p><h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ hexo server<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>More info: <a href="https://hexo.io/docs/server.html">Server</a></p><h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ hexo generate<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>More info: <a href="https://hexo.io/docs/generating.html">Generating</a></p><h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ hexo deploy<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>More info: <a href="https://hexo.io/docs/one-command-deployment.html">Deployment</a></p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>ã€LeetCodeã€‘144.äºŒå‰æ ‘çš„å‰åºéå†</title>
      <link href="/posts/60831.html"/>
      <url>/posts/60831.html</url>
      
        <content type="html"><![CDATA[<h1 id="1-é—®é¢˜"><a href="#1-é—®é¢˜" class="headerlink" title="1.é—®é¢˜"></a>1.é—®é¢˜</h1><p>ç»™ä½ äºŒå‰æ ‘çš„æ ¹èŠ‚ç‚¹ root ï¼Œè¿”å›å®ƒèŠ‚ç‚¹å€¼çš„ å‰åº éå†ã€‚</p><h2 id="ç¤ºä¾‹-1"><a href="#ç¤ºä¾‹-1" class="headerlink" title="ç¤ºä¾‹ 1"></a>ç¤ºä¾‹ 1</h2><p><img src="https://cdn.jsdelivr.net/gh/zyxelva/picgo@main/csdn/bfcfd742f58b7f629df27b4bf8a169a9.jpeg" alt="å›¾1"></p><blockquote><p>è¾“å…¥ï¼šroot &#x3D; [1,null,2,3]<br>è¾“å‡ºï¼š[1,2,3]</p></blockquote><h2 id="ç¤ºä¾‹-2"><a href="#ç¤ºä¾‹-2" class="headerlink" title="ç¤ºä¾‹ 2"></a>ç¤ºä¾‹ 2</h2><blockquote><p>è¾“å…¥ï¼šroot &#x3D; []<br>è¾“å‡ºï¼š[]</p></blockquote><h2 id="ç¤ºä¾‹-3"><a href="#ç¤ºä¾‹-3" class="headerlink" title="ç¤ºä¾‹ 3"></a>ç¤ºä¾‹ 3</h2><blockquote><p>è¾“å…¥ï¼šroot &#x3D; [1]<br>è¾“å‡ºï¼š[1]</p></blockquote><h2 id="ç¤ºä¾‹-4"><a href="#ç¤ºä¾‹-4" class="headerlink" title="ç¤ºä¾‹ 4"></a>ç¤ºä¾‹ 4</h2><p><img src="https://cdn.jsdelivr.net/gh/zyxelva/picgo@main/csdn/055d4e3cd757f49afe71b8e1467d480a.jpeg" alt="å›¾2"></p><blockquote><p>è¾“å…¥ï¼šroot &#x3D; [1,2]<br>è¾“å‡ºï¼š[1,2]</p></blockquote><h2 id="ç¤ºä¾‹-5"><a href="#ç¤ºä¾‹-5" class="headerlink" title="ç¤ºä¾‹ 5"></a>ç¤ºä¾‹ 5</h2><p><img src="https://cdn.jsdelivr.net/gh/zyxelva/picgo@main/csdn/1e3a847f0b72e64b899dbeb0dcbca616.jpeg" alt="å›¾3"></p><blockquote><p>è¾“å…¥ï¼šroot &#x3D; [1,null,2]<br>è¾“å‡ºï¼š[1,2]</p></blockquote><p><strong>æç¤º</strong>ï¼š</p><ul><li>æ ‘ä¸­èŠ‚ç‚¹æ•°ç›®åœ¨èŒƒå›´ [0, 100] å†…</li><li>-100 &lt;&#x3D; Node.val &lt;&#x3D; 100</li></ul><h1 id="2-è§£é¢˜æ€è·¯"><a href="#2-è§£é¢˜æ€è·¯" class="headerlink" title="2.è§£é¢˜æ€è·¯"></a>2.è§£é¢˜æ€è·¯</h1><h2 id="2-1-é€’å½’"><a href="#2-1-é€’å½’" class="headerlink" title="2.1 é€’å½’"></a>2.1 é€’å½’</h2><p>ä¸­åºéå†çš„è§„åˆ™æ˜¯ æ ¹-å·¦-å³ï¼Œç„¶åè®¿é—®å·¦å­æ ‘ã€å³å­æ ‘æ—¶åŒæ ·æŒ‰ç…§æ­¤è§„åˆ™éå†ï¼Œéå¸¸å®¹æ˜“é€šè¿‡é€’å½’å®ç°ï¼ŒæŒ‰ç…§è§„åˆ™ï¼Œä»£ç éå¸¸å®¹æ˜“å†™å‡ºæ¥ã€‚å®šä¹‰ <strong>preorderTraversal(root)</strong> ä¸ºé€’å½’éå†å‡½æ•°æ–¹æ³•ï¼Œroot ä¸ºæ ¹èŠ‚ç‚¹ã€‚ä¼ªä»£ç ï¼š</p><pre class="line-numbers language-java" data-language="java"><code class="language-java">root<span class="token punctuation">.</span>val<span class="token punctuation">;</span><span class="token function">preorderTraversal</span><span class="token punctuation">(</span>root<span class="token punctuation">.</span>left<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">preorderTraversal</span><span class="token punctuation">(</span>root<span class="token punctuation">.</span>right<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p><strong>å¤æ‚åº¦åˆ†æ</strong></p><ul><li><p>æ—¶é—´å¤æ‚åº¦ï¼šO(n)ï¼Œå…¶ä¸­ n æ˜¯äºŒå‰æ ‘çš„èŠ‚ç‚¹æ•°ã€‚æ¯ä¸€ä¸ªèŠ‚ç‚¹æ°å¥½è¢«éå†ä¸€æ¬¡ã€‚</p></li><li><p>ç©ºé—´å¤æ‚åº¦ï¼šO(n)ï¼Œä¸ºé€’å½’è¿‡ç¨‹ä¸­æ ˆçš„å¼€é”€ï¼Œå¹³å‡æƒ…å†µä¸‹ä¸º O(logâ¡n)ï¼Œæœ€åæƒ…å†µä¸‹æ ‘å‘ˆç°é“¾çŠ¶ï¼Œä¸º O(n)ã€‚</p></li></ul><h2 id="2-2-è¿­ä»£"><a href="#2-2-è¿­ä»£" class="headerlink" title="2.2 è¿­ä»£"></a>2.2 è¿­ä»£</h2><p>æ˜¾ç¤ºåˆ©ç”¨æ ˆç»“æ„ï¼Œéå†äºŒå‰æ ‘ã€‚<br>å¼•ç”¨LeetCodeåŠ¨æ€å›¾è§£è¿­ä»£è¿‡ç¨‹ï¼š<br>1ï¼‰è®¿é—®æ ¹èŠ‚ç‚¹<br><img src="https://cdn.jsdelivr.net/gh/zyxelva/picgo@main/csdn/9d2a4485420c7a95799a09999b81d662.png" alt="å›¾4"><br>2ï¼‰æ ¹èŠ‚ç‚¹å…¥æ ˆ<br><img src="https://cdn.jsdelivr.net/gh/zyxelva/picgo@main/csdn/64301bc1906294b4853a32161890f3ec.png" alt="å›¾5"><br>3ï¼‰å·¦å­æ ‘æ ¹èŠ‚ç‚¹éå†ã€å…¥æ ˆ<br><img src="https://cdn.jsdelivr.net/gh/zyxelva/picgo@main/csdn/625bc2dd91f7e489d64311098b60599c.png" alt="å›¾6"><br>4ï¼‰å·¦å­æ ‘æ ¹èŠ‚ç‚¹å‡ºæ ˆï¼Œéå†å…¶å·¦å³å­èŠ‚ç‚¹<br><img src="https://cdn.jsdelivr.net/gh/zyxelva/picgo@main/csdn/1795695bfe91736dd9daba150dc75b02.png" alt="å›¾7"><br>5ï¼‰å·¦æ ¹èŠ‚ç‚¹å·¦å­æ ‘ä¸å­˜åœ¨ï¼Œéå†å…¶å³å­æ ‘4<br><img src="https://cdn.jsdelivr.net/gh/zyxelva/picgo@main/csdn/053fb2ab6e498be02df4e0b7c1e8bd78.png" alt="å›¾8"><br>6ï¼‰å·¦å­æ ‘éå†å®Œæ¯•ï¼Œéå†æ ¹èŠ‚ç‚¹å³å­æ ‘<br><img src="https://cdn.jsdelivr.net/gh/zyxelva/picgo@main/csdn/92ba07a2ab80979a6adcbb932f43c0ad.png" alt="å›¾9"><br>7ï¼‰éå†å³å­æ ‘æ ¹èŠ‚ç‚¹ï¼Œæ ¹èŠ‚ç‚¹å‡ºæ ˆ<br><img src="https://cdn.jsdelivr.net/gh/zyxelva/picgo@main/csdn/d19f60849640fb1625a0424b3cbde631.png" alt="å›¾10"><br>8ï¼‰å³å­æ ‘æ ¹èŠ‚ç‚¹å…¥æ ˆ<br><img src="https://cdn.jsdelivr.net/gh/zyxelva/picgo@main/csdn/2db7363f3e0366a1b2242fb703c95751.png" alt="å›¾11"></p><p>9ï¼‰å³å­æ ‘å·¦èŠ‚ç‚¹éå†ï¼Œå…¥æ ˆ<br><img src="https://cdn.jsdelivr.net/gh/zyxelva/picgo@main/csdn/0df77d13242bf0d1028476a613d15084.png" alt="å›¾12"></p><p>10ï¼‰å³å­æ ‘å·¦èŠ‚ç‚¹éå†å®Œæ¯•ï¼Œè¯¥èŠ‚ç‚¹å‡ºæ ˆ<br><img src="https://cdn.jsdelivr.net/gh/zyxelva/picgo@main/csdn/3a874f3193e082298063797fc8fba000.png" alt="å›¾13"><br>11ï¼‰éå†å³å­æ ‘å³èŠ‚ç‚¹ï¼Œå³å­æ ‘æ ¹èŠ‚ç‚¹å‡ºæ ˆ<br><img src="https://cdn.jsdelivr.net/gh/zyxelva/picgo@main/csdn/62cd727620a3733c5b93de45ef8c8d83.png" alt="å›¾14"><br>12ï¼‰å³å­æ ‘å³èŠ‚ç‚¹éå†ï¼Œå…¥æ ˆ<br><img src="https://cdn.jsdelivr.net/gh/zyxelva/picgo@main/csdn/44473bed64019699f1a718508dbf4a24.png" alt="å›¾15"><br>13ï¼‰å³å­æ ‘éå†å®Œæ¯•ï¼Œå‡ºæ ˆ<br><img src="https://cdn.jsdelivr.net/gh/zyxelva/picgo@main/csdn/87b30e5ca23edf3bee8fe942d99b7e4b.png" alt="å›¾16"><br>14ï¼‰éå†å®Œæ¯•<br><img src="https://cdn.jsdelivr.net/gh/zyxelva/picgo@main/csdn/c2cee3c4c3edf74912ccc14b9dbba9af.png" alt="å›¾17"><br><strong>å¤æ‚åº¦åˆ†æ</strong></p><ul><li><p>æ—¶é—´å¤æ‚åº¦ï¼šO(n)ï¼Œå…¶ä¸­ n æ˜¯äºŒå‰æ ‘çš„èŠ‚ç‚¹æ•°ã€‚æ¯ä¸€ä¸ªèŠ‚ç‚¹æ°å¥½è¢«éå†ä¸€æ¬¡ã€‚</p></li><li><p>ç©ºé—´å¤æ‚åº¦ï¼šO(n)ï¼Œä¸ºè¿­ä»£è¿‡ç¨‹ä¸­æ˜¾å¼æ ˆçš„å¼€é”€ï¼Œå¹³å‡æƒ…å†µä¸‹ä¸º O(logâ¡n)ï¼Œæœ€åæƒ…å†µä¸‹æ ‘å‘ˆç°é“¾çŠ¶ï¼Œä¸º O(n)ã€‚</p></li></ul><h1 id="3-ä»£ç "><a href="#3-ä»£ç " class="headerlink" title="3.ä»£ç "></a>3.ä»£ç </h1><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Solution</span> <span class="token punctuation">&#123;</span>    <span class="token comment">/**     * é€’å½’     *     *     * @param root TreeNodeç±»     * @return intæ•´å‹ä¸€ç»´æ•°ç»„     */</span>    <span class="token keyword">public</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> preorderTraversal <span class="token punctuation">(</span><span class="token class-name">TreeNode</span> root<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token comment">// write code here</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">==</span> root<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">></span></span> list <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">preorderTraversal2</span><span class="token punctuation">(</span>list<span class="token punctuation">,</span> root<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> list<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">mapToInt</span><span class="token punctuation">(</span><span class="token class-name">Integer</span><span class="token operator">::</span><span class="token function">valueOf</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>  <span class="token comment">//é€’å½’æ–¹æ³•</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> preorderTraversal2 <span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">></span></span> list<span class="token punctuation">,</span> <span class="token class-name">TreeNode</span> root<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">==</span> root<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">return</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>root<span class="token punctuation">.</span>val<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">preorderTraversal2</span><span class="token punctuation">(</span>list<span class="token punctuation">,</span> root<span class="token punctuation">.</span>left<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">preorderTraversal2</span><span class="token punctuation">(</span>list<span class="token punctuation">,</span> root<span class="token punctuation">.</span>right<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token comment">//è¿­ä»£ï¼Œæ ˆæ€æƒ³</span><span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">></span></span> <span class="token function">preorderTraversal</span><span class="token punctuation">(</span><span class="token class-name">TreeNode</span> root<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">></span></span> res <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">==</span> root<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">return</span> res<span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token class-name">Stack</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TreeNode</span><span class="token punctuation">></span></span> stack <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Stack</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        stack<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">TreeNode</span> p<span class="token punctuation">;</span>        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>stack<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            p <span class="token operator">=</span> stack<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            res<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>val<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment">//å…ˆæŠŠå³èŠ‚ç‚¹å…¥æ ˆ</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">!=</span> p<span class="token punctuation">.</span>right<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                stack<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>right<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">!=</span> p<span class="token punctuation">.</span>left<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                stack<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>left<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">return</span> res<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> ç®—æ³• </category>
          
      </categories>
      
      
        <tags>
            
            <tag> LeetCode </tag>
            
            <tag> ç®—æ³• </tag>
            
            <tag> äºŒå‰æ ‘ </tag>
            
            <tag> æ•°æ®ç»“æ„ </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
